"use strict";angular.module("bandcampApp",["ngRoute","routeStyles","ngCookies","bandcampApp.config","bandcampApp.compile","bandcampApp.coFillHeight","bandcampApp.angular-ellipsis","bandcampApp.services","bandcampApp.controllers","bandcampApp.fixedTableHeader","bandcampApp.fileSelect","bandcampApp.bcTemplate","bandcampApp.templates","bandcampApp.dragSelect","bandcampApp.scrollToMe","ui.bootstrap","ngTagsInput","angularMoment","cgBusy","bandcampApp.draggable","bandcampApp.infiniteScroll","LocalStorageModule","btford.markdown","monospaced.mousewheel","bandcampApp.passwordStrength","angulartics","angulartics.google.analytics","angulartics.google.tagmanager","ui.bootstrap.showErrors","ngIdle","ui.calendar","angular-sortable-view","angularFileUpload","videosharing-embed","bandcampApp.imageOnLoad","bandcampApp.errSrc","noCAPTCHA","timer","nsPopover","ngImgCrop","smoothScroll","ngClipboard","afkl.lazyImage","wysiwyg.module","w11k.flash","intercom","ngAutocomplete","bandcampApp.intercom","highcharts-ng","googlechart","bandcampApp.customAutoComplete","toggle-switch","ngCsv","anguFixedHeaderTable","as.sortable","jkuri.slimscroll","angulartics.facebook.pixel","bandcampApp.multitracker","ui.select2","ui.select","bandcampApp.jobSelector","bandcampApp.showFocus","bandcampApp.fixedOnScroll","bandcampApp.jobLabelSelect","ui.tree","bandcampApp.elResize","colorpicker.module","angular.filter","ui.grid","ui.grid.pinning","ui.grid.pagination","bandcampApp.jobNotes","ngIntlTelInput","bandcampApp.ngInline","newrelic-timing","bandcampApp.tableToCsv","bandcampApp.imgFadein","bandcampApp.autoFocus","ngImago"]);var bandcampApp=angular.module("bandcampApp"),ctrls=angular.module("bandcampApp.controllers",["ngSanitize","bandcampApp.config"]),services=angular.module("bandcampApp.services",["ngResource"]);bandcampApp.config(["$routeProvider","$httpProvider","routePrefix","KeepaliveProvider","IdleProvider","w11kFlashConfig","intercomKey","IntercomProvider","externalUrl","$locationProvider",function($routeProvider,$httpProvider,routePrefix,KeepaliveProvider,IdleProvider,w11kFlashConfig,intercomKey,IntercomProvider,externalUrl,$locationProvider){w11kFlashConfig.templateUrl="template/w11k-flash.tpl.html",IdleProvider.idle(72e4),IdleProvider.timeout(5),KeepaliveProvider.interval(20);var momentConfiguration=function(){var startingWeekAsMonday={week:{dow:1}};moment.locale("en",startingWeekAsMonday),moment.DAY_OF_WEEK={MONDAY:0,TUE:1,WEDNESDAY:2,THURSDAY:3,FRIDAY:4,SATURDAY:5,SUNDAY:6},moment.DateFormat={ISO_8601:"YYYY-MM-DD"}};momentConfiguration(),Highcharts.setOptions({global:{useUTC:!1},lang:{thousandsSep:","}}),$locationProvider.html5Mode({enabled:!0});var getFullUrl=function(url){return routePrefix?routePrefix+url:url},routeTo=function(path,conf){conf.redirectTo&&delete conf.templateUrl,conf.reloadOnSearch||(conf.reloadOnSearch=!1),$routeProvider.when(path,conf)},loginRequired=function($location,CurrentUser,$q){var deferred=$q.defer();return CurrentUser.get(function(){deferred.resolve()},function(){deferred.reject(),$location.path("/login")}),deferred.promise},PAGE_NOT_AVAILABLE="not-available";routeTo("/applicants/tracking",{templateUrl:getFullUrl("recruiter/applicant-tracker.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/pipelines/tracking",{templateUrl:getFullUrl("recruiter/pipeline-tracker.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/pipelines/sourcing",{templateUrl:getFullUrl("recruiter/sourcing/pipeline-sourcing.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/campaign/sourcing",{templateUrl:getFullUrl("recruiter/sourcing/campaign-sourcing.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/admin/assignments",{templateUrl:getFullUrl("admin/assignments/list.tpl.html"),resolve:{loginRequired:loginRequired},reloadOnSearch:!1}),routeTo("/admin/assignments/:id/edit",{templateUrl:getFullUrl("admin/assignments/edit.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/admin/users",{templateUrl:getFullUrl("admin/users/list.tpl.html"),resolve:{loginRequired:loginRequired},reloadOnSearch:!1}),routeTo("/admin/users/:id/edit",{templateUrl:getFullUrl("admin/users/edit.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/admin/onboard",{templateUrl:getFullUrl("admin/onboard/onboard.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/admin/features",{templateUrl:getFullUrl("admin/features/features.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/admin/integrations",{templateUrl:getFullUrl("admin/integrations/integrations.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/grading",{templateUrl:getFullUrl("grading/grading.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/enforcer",{templateUrl:getFullUrl("enforcer/logbook-view.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/enforcer/report",{templateUrl:getFullUrl("enforcer/report/report-view.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/recruiter/pending-approvals",{templateUrl:getFullUrl("recruiter/pending-approval-applications.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/companies",{templateUrl:getFullUrl("admin/company/companies.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/company/:id/edit",{templateUrl:getFullUrl("admin/company/edit.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/company/add",{templateUrl:getFullUrl("admin/company/edit.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/trainings",{templateUrl:getFullUrl("admin/trainings/trainings.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/audits",{templateUrl:getFullUrl("admin/audits/audits.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/jobs",{templateUrl:getFullUrl("admin/jobs/list.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/job/:id/edit",{templateUrl:getFullUrl("admin/jobs/edit.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/job/create",{templateUrl:getFullUrl("admin/jobs/edit.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/home",{templateUrl:getFullUrl("home/home.tpl.html")}),routeTo("/profile/user-profile/:id?",{templateUrl:getFullUrl("profile/user-profile.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/profile/change-email/token/:token",{templateUrl:getFullUrl("settings/user/verify-new-email.tpl.html")}),routeTo("/signup/intro",{templateUrl:getFullUrl("signup/intro.tpl.html")}),routeTo("/signup/please-verify",{templateUrl:getFullUrl("signup/user-verify.tpl.html")}),routeTo("/signup/verify-email/token/:token",{templateUrl:getFullUrl("signup/verify-email.tpl.html")}),routeTo("/signup/location",{templateUrl:getFullUrl("signup/location.tpl.html")}),routeTo("/signup/security-question",{templateUrl:getFullUrl("signup/security-question.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/login",{templateUrl:getFullUrl("login/login.tpl.html")}),routeTo("/logout/inactivity",{templateUrl:getFullUrl("static/inactivity.tpl.html")}),routeTo("/reset/password",{templateUrl:getFullUrl("passwordreset/reset-password.tpl.html")}),routeTo("/reset/confirm-password",{templateUrl:getFullUrl("passwordreset/confirm-password.tpl.html")}),routeTo("/reset/update-password/:passwordResetToken",{templateUrl:getFullUrl("passwordreset/update-password.tpl.html")}),routeTo("/job/summary",{templateUrl:getFullUrl("job/summary.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/job/:id/details",{templateUrl:getFullUrl("job/details.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/job/:id/applications/:tabId?",{templateUrl:getFullUrl("job/applications/company.tpl.html")}),routeTo("/job/:id?/marketplace-members",{templateUrl:getFullUrl("job/marketplace-members.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/hire/direct/:marketplaceMemberId",{templateUrl:getFullUrl("contract/makeoffer.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/hire/:selectionId",{templateUrl:getFullUrl("contract/makeoffer.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contract/:contractId/change",{templateUrl:getFullUrl("contract/makeoffer.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contract/:assignmentId/view",{templateUrl:getFullUrl("contract/view.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contract/:assignmentId/tracker",{templateUrl:getFullUrl("contract/tracker.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contract/:assignmentId/agree",{templateUrl:getFullUrl("contract/teamagreement.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/dashboard",{templateUrl:getFullUrl("job/posting.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/job/posting/:jobId?",{templateUrl:getFullUrl("job/posting.tpl.html")}),routeTo("/job/:id/apply",{templateUrl:getFullUrl("redirect/job.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/job/:id/applied",{templateUrl:getFullUrl("job/applied.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/profile",{templateUrl:getFullUrl("profile/profile.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings",{templateUrl:getFullUrl("settings/home.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/company/staff/view/:id",{templateUrl:getFullUrl("settings/company/staff.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/company/agreementterms/:type",{templateUrl:getFullUrl("settings/company/agreements/company-agreement-terms.tpl.html")}),routeTo("/settings/account-info",{templateUrl:getFullUrl("settings/user/account-info.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/location",{templateUrl:getFullUrl("settings/user/location.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/calendar",{templateUrl:getFullUrl("settings/user/calendar.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/password",{templateUrl:getFullUrl("settings/user/password.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/security-question",{templateUrl:getFullUrl("settings/user/security-question.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/user/password",{templateUrl:getFullUrl("settings/user/password.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/settings/user/security-question",{templateUrl:getFullUrl("settings/user/security-question.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/team/contracts",{templateUrl:getFullUrl("team/contracts.tpl.html")}),routeTo("/my-contractors/offers",{templateUrl:getFullUrl("contractor/offers.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/marketplace/my-jobs",{templateUrl:getFullUrl("marketplace-member/my-jobs.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/marketplace/find-work",{templateUrl:getFullUrl("marketplace-member/find-work.tpl.html")}),routeTo("/marketplace/available-jobs",{templateUrl:getFullUrl("marketplace-member/available-jobs.tpl.html")}),routeTo("/info/terms",{templateUrl:getFullUrl("terms/terms.tpl.html")}),routeTo("/candidate/terms",{templateUrl:getFullUrl("terms/agreement.tpl.html")}),routeTo("/info/terms/privacy",{templateUrl:getFullUrl("terms/privacy.tpl.html")}),routeTo("/manager-registration/:token",{templateUrl:getFullUrl("registration/hiring-manager.tpl.html")}),routeTo("/onboard/payoneer",{templateUrl:getFullUrl("onboard/payoneer.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/onboard/agreement",{templateUrl:getFullUrl("onboard/agreement.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/onboard/finish",{templateUrl:getFullUrl("onboard/finish.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/onboard/training",{templateUrl:getFullUrl("onboard/training.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/documents/:name",{templateUrl:getFullUrl("documents/legal-document.tpl.html")}),routeTo("/worksmart",{templateUrl:getFullUrl("documents/productivity-tool.tpl.html")}),routeTo("/contact-us",{templateUrl:getFullUrl("contact_us/contact-us.tpl.html")}),routeTo("/redirect/job",{templateUrl:getFullUrl("redirect/job.tpl.html")}),routeTo("/redirect/job/:id",{templateUrl:getFullUrl("redirect/job.tpl.html")}),routeTo("/jobs-health",{templateUrl:getFullUrl("company/jobs-health.tpl.html")}),routeTo("/jobs/:id",{templateUrl:getFullUrl("redirect/job.tpl.html")}),routeTo("/redirect/verify",{templateUrl:getFullUrl("redirect/verify.tpl.html")}),routeTo("/candidate/application/audio/:applicationId",{templateUrl:getFullUrl("candidate/application/audio.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/application/contact-data/:applicationId",{templateUrl:getFullUrl("candidate/application/collect-contact-data.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/application/first-test/:applicationId",{templateUrl:getFullUrl("candidate/application/first-test.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/application/first-test/:applicationId/:verification",{templateUrl:getFullUrl("candidate/application/first-test.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/application/complete-profile/:applicationId",{templateUrl:getFullUrl("candidate/application/complete-profile.tpl.html")}),routeTo("/candidate/application/second-test/:applicationId",{templateUrl:getFullUrl("candidate/application/second-test.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/application/questionnaire/:applicationId",{templateUrl:getFullUrl("candidate/application/questionnaire.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/application/pending-test/:applicationId",{templateUrl:getFullUrl("candidate/application/pending-test.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/application/rejected",{templateUrl:getFullUrl("candidate/application/rejected.tpl.html")}),routeTo("/candidate/application/accepted",{templateUrl:getFullUrl("candidate/application/accepted.tpl.html")}),routeTo("/candidate/application/second-chance/:applicationId",{templateUrl:getFullUrl("candidate/application/second-chance.tpl.html")}),routeTo("/candidate/application/phone/:applicationId",{templateUrl:getFullUrl("candidate/application/phone.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/redirect/payoneer",{templateUrl:getFullUrl("redirect/payoneer.tpl.html")}),routeTo("/candidate/signup/:jobId",{templateUrl:getFullUrl("candidate/signup.tpl.html")}),routeTo("/candidate/set-credentials/:jobId",{templateUrl:getFullUrl("candidate/set-credentials.tpl.html")}),routeTo("/candidate/dashboard",{templateUrl:getFullUrl("candidate/dashboard/dashboard.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractor/home",{templateUrl:getFullUrl("contractor/home/home.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractor/earnings",{templateUrl:getFullUrl("contractor/earnings/earnings.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractor/my-team",{templateUrl:getFullUrl("contractor/my-team/my-team.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractor/assignments",{templateUrl:getFullUrl("contractor/assignments/assignments.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractor/search",{templateUrl:getFullUrl("contractor/search/search.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractor/search/:id",{templateUrl:getFullUrl("contractor/search/search.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/profile/contractor-profile/:id",{templateUrl:getFullUrl("profile/contractor-profile.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractor/new-dashboard",{templateUrl:getFullUrl("contractor/widgets/home.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/candidate/dashboard/home",{templateUrl:getFullUrl("candidate/dashboard/home.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/contractors/onboard/:token",{templateUrl:getFullUrl("contractors/on-board.tpl.html")}),routeTo("/candidate/dashboard/hiring",{templateUrl:getFullUrl("candidate/dashboard/hiring.tpl.html")}),routeTo("/candidate/dashboard/:landingPage",{templateUrl:getFullUrl("candidate/dashboard/dashboard.tpl.html")}),routeTo("/candidate/interview/schedule",{templateUrl:getFullUrl("interview/candidate-schedule.tpl.html")}),routeTo("/manager/goals",{templateUrl:getFullUrl("manager/goals/goals.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/gemba-walk",{templateUrl:getFullUrl("manager/gemba-walk/home.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/training/:assignmentId?",{templateUrl:getFullUrl("manager/training.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/candidates",{templateUrl:getFullUrl("manager/candidates.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/hire/:assignmentId",{templateUrl:getFullUrl("manager/hire.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/teams",{templateUrl:getFullUrl("manager/teams/teams.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/dashboard/home",{templateUrl:getFullUrl("manager/dashboard/home.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/dashboard/team",{templateUrl:getFullUrl("manager/dashboard/team.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/dashboard/team-member/:id",{templateUrl:getFullUrl("contractors/team-member.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/team-dashboard",{templateUrl:getFullUrl("manager/team-dashboard/home.tpl.html"),resolve:{loginRequired:loginRequired},reloadOnSearch:!1}),routeTo("/manager/hire-team/categories",{templateUrl:getFullUrl("manager/hire-team/categories.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/hire-team/category/:id?",{templateUrl:getFullUrl("manager/hire-team/category.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/hire-team/category/:id/team/:teamId",{templateUrl:getFullUrl("manager/hire-team/team-preview/team-preview.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/manager/checkin",{templateUrl:getFullUrl("manager/checkin/checkin.html"),resolve:{loginRequired:loginRequired}}),routeTo("/migrated/job",{templateUrl:getFullUrl("migrated/job.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/migrated/outline",{templateUrl:getFullUrl("migrated/outline.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/migrated/password",{templateUrl:getFullUrl("migrated/password.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/migrated/payoneer",{templateUrl:getFullUrl("migrated/payoneer.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/migrated/worksmart",{templateUrl:getFullUrl("migrated/productivity-tool.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/migrated/success",{templateUrl:getFullUrl("migrated/success.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/migrated/terms",{templateUrl:getFullUrl("migrated/terms.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/notifications",{templateUrl:getFullUrl("notifications/list.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/interview/schedule/:marketplaceMemberId",{templateUrl:getFullUrl("interview/schedule.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/interview/schedule/category/:categoryId/team/:teamId",{templateUrl:getFullUrl("interview/schedule.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/interview/postpone/:interviewId",{templateUrl:getFullUrl("interview/schedule.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/reinterview/:interviewId",{templateUrl:getFullUrl("interview/schedule.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/interview/:interviewId/response",{templateUrl:getFullUrl("interview/accept-decline.tpl.html")}),routeTo("/teaminterview/:teamInterviewId/response",{templateUrl:getFullUrl("interview/accept-decline.tpl.html")}),routeTo("/interview/:interviewId/accept",{templateUrl:getFullUrl("interview/accept.tpl.html")}),routeTo("/teaminterview/:teamInterviewId/accept",{templateUrl:getFullUrl("interview/accept.tpl.html")}),routeTo("/interview/:interviewId/view",{templateUrl:getFullUrl("interview/view.tpl.html")}),routeTo("/teaminterview/:teamInterviewId/view",{templateUrl:getFullUrl("interview/view.tpl.html")}),routeTo("/interview/:interviewId/video-conference",{templateUrl:getFullUrl("interview/video-conference.tpl.html")}),routeTo("/teaminterview/:teamInterviewId/video-conference",{templateUrl:getFullUrl("interview/video-conference.tpl.html")}),routeTo("/edit-profile/:jobId",{templateUrl:getFullUrl("job/edit-profile.tpl.html")}),routeTo("/company/setup-team",{templateUrl:getFullUrl("team/setup-team.tpl.html")}),routeTo("/company/invoices",{templateUrl:getFullUrl("reports/invoices.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/invoices",{templateUrl:getFullUrl("reports/invoices.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/reports/",{templateUrl:getFullUrl("reports/management-reports.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/login/linkedin",{templateUrl:getFullUrl("login/linkedin.tpl.html")}),routeTo("/resources/",{templateUrl:getFullUrl("resources/resources.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/resources/guidelines",{templateUrl:getFullUrl("resources/guidelines.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/resources/:name/faq",{templateUrl:getFullUrl("resources/faq.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/custom-pipelines",{templateUrl:getFullUrl("account-manager/custom-pipelines.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/applicants-endorsement",{templateUrl:getFullUrl("account-manager/applicants-endorsement.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/application",{templateUrl:getFullUrl("account-manager/application.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/users",{templateUrl:getFullUrl("account-manager/users.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/demand",{templateUrl:getFullUrl("account-manager/job-demand.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/application/:id/notes",{templateUrl:getFullUrl("account-manager/application-notes.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/account-manager/job/:id/notes/:type",{templateUrl:getFullUrl("account-manager/job-notes.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/calibrations",{templateUrl:getFullUrl("account-manager/calibrations.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/command-center",{templateUrl:getFullUrl("account-manager/command-center.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/fiveq-rubric/:jobId",{templateUrl:getFullUrl("grading/fiveq-rubric.tpl.html"),resolve:{loginRequired:loginRequired}}),routeTo("/"+PAGE_NOT_AVAILABLE,{templateUrl:"static/not-available.html",css:["styles/route/global.css"]}),$routeProvider.otherwise({redirectTo:routePrefix+"/home"}),$httpProvider.interceptors.push(function($q,$rootScope,$location){return{responseError:function(rejection){var status=rejection.status,config=rejection.config,method=config.method,url=config.url;return 401===status?($rootScope.clearAuthToken(),$rootScope.error="Invalid credentials!","/login"!==$location.path()&&($rootScope.redirectPath=$location.path()),$location.path("login")):$rootScope.error=method+" on "+url+" failed with status "+status,$q.reject(rejection)}}}),$httpProvider.interceptors.push(function($q,$rootScope){return{request:function(config){var isRestCall=config.url.indexOf("/api/")>=0;if(isRestCall&&$rootScope.isUserLoggedIn()){var authToken=$rootScope.getAuthToken();authToken||exampleAppConfig&&exampleAppConfig.useAuthTokenHeader?config.headers["X-Auth-Token"]=authToken:config.url=config.url+"?token="+authToken,angular.isDefined($rootScope.runAsId)&&(config.url+=(config.url.split("?")[1]?"&":"?")+"runAs="+$rootScope.runAsId)}return config||$q.when(config)}}}),$httpProvider.defaults.useXDomain=!0,delete $httpProvider.defaults.headers.common["X-Requested-With"];var externalConf;externalConf=externalUrl?{controller:function(){window.location.href=externalUrl},template:"<div></div>"}:{redirectTo:"/home"},$routeProvider.otherwise(externalConf)}]),bandcampApp.config(["localStorageServiceProvider",function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("bandcamp")}]),bandcampApp.config(["ngClipProvider",function(ngClipProvider){ngClipProvider.setPath("ZeroClipboard.swf")}]),bandcampApp.config(["$compileProvider",function($compileProvider){$compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|ftp|mailto|chrome-extension|skype):/)}]),bandcampApp.config(["$sceDelegateProvider",function($sceDelegateProvider){$sceDelegateProvider.resourceUrlWhitelist(["self","https://bandcamp-uploads-dev.s3.amazonaws.com/resumes/**","https://bandcamp-uploads-dev.s3.amazonaws.com/documents/**","https://bandcamp-uploads-dev.s3.amazonaws.com/custom-agreements/**","https://bandcamp-uploads-stage.s3.amazonaws.com/resumes/**","https://bandcamp-uploads-stage.s3.amazonaws.com/documents/**","https://bandcamp-uploads-stage.s3.amazonaws.com/custom-agreements/**","https://crossover-uploads-production.s3.amazonaws.com/resumes/**","https://crossover-uploads-production.s3.amazonaws.com/documents/**","https://crossover-uploads-production.s3.amazonaws.com/custom-agreements/**","https://xo-pre-prod-uploads.s3.amazonaws.com/resumes/**","https://xo-pre-prod-uploads.s3.amazonaws.com/documents/**","https://xo-pre-prod-uploads.s3.amazonaws.com/custom-agreements/**"])}]),ctrls.run(function($rootScope,$templateCache,$location,$cookies,$route,routePrefix,cgBusyDefaults,CurrentUser,$timeout,$cacheFactory,$uibModalStack){$rootScope.$on("$viewContentLoaded",function(){delete $rootScope.error,$rootScope.showFooter=!0}),cgBusyDefaults.templateUrl="template/angular-busy.tpl.html";var originalPath=$location.path;$location.path=function(path,reload){if(reload===!1)var lastRoute=$route.current,un=$rootScope.$on("$locationChangeSuccess",function(){$route.current=lastRoute,un()});return originalPath.apply($location,[path])},$rootScope.logoutButDoNotRedirect=function(){delete $rootScope.runAsId,delete $rootScope.user,$rootScope.clearAuthToken(),CurrentUser.clearCache()},$rootScope.menuRefresh=0,$rootScope.logout=function(){$rootScope.logoutButDoNotRedirect(),$cacheFactory.get("$http").removeAll(),window.location.href="/"},$rootScope.clearAuthToken=function(){delete $rootScope.authToken,$cookies.remove("authToken",{path:"/"})},$rootScope.isUserLoggedIn=function(){return angular.isDefined($rootScope.getAuthToken())},$rootScope.getAuthToken=function(){return angular.isDefined($rootScope.authToken)||($rootScope.authToken=$cookies.get("authToken")),$rootScope.authToken?$rootScope.authToken.replace(/"/g,""):void 0},$rootScope.setAuthToken=function(authToken){$rootScope.authToken=authToken,$cookies.put("authToken",authToken,{path:"/"})},$rootScope.updateNotifications=function(){$rootScope.$broadcast("update:notifications")},$rootScope.$on("$locationChangeStart",function(){$rootScope.isHome="/home"===$location.path(),$rootScope.isAvailableJobs="/marketplace/available-jobs"===$location.path();var openedModal=$uibModalStack.getTop();openedModal&&!CurrentUser.feedbackModal()&&$uibModalStack.dismiss(openedModal.key)});var startUpdates=function(){$timeout(function(){$rootScope.updateNotifications(),startUpdates()},6e5)};startUpdates(),$rootScope.initialized=!0}),function(){var KEYS={backspace:8,tab:9,enter:13,escape:27,space:32,up:38,down:40,left:37,right:39,"delete":46,comma:188},MAX_SAFE_INTEGER=9007199254740991,SUPPORTED_INPUT_TYPES=["text","email","url"],tagsInput=angular.module("ngTagsInput",[]);tagsInput.directive("tagsInput",["$timeout","$document","$window","$q","tagsInputConfig","tiUtil",function($timeout,$document,$window,$q,tagsInputConfig,tiUtil){function TagList(options,events,onTagAdding,onTagRemoving){var getTagText,setTagText,canAddTag,canRemoveTag,self={};return getTagText=function(tag){return tiUtil.safeToString(tag[options.displayProperty])},setTagText=function(tag,text){tag[options.displayProperty]=text},canAddTag=function(tag){var tagText=getTagText(tag),valid=tagText&&tagText.length>=options.minLength&&tagText.length<=options.maxLength&&options.allowedTagsPattern.test(tagText)&&!tiUtil.findInObjectArray(self.items,tag,options.keyProperty||options.displayProperty);return $q.when(valid&&onTagAdding({$tag:tag})).then(tiUtil.promisifyValue)},canRemoveTag=function(tag){return $q.when(onTagRemoving({$tag:tag})).then(tiUtil.promisifyValue)},self.items=[],self.addText=function(text){var tag={};return setTagText(tag,text),self.add(tag)},self.add=function(tag){var tagText=getTagText(tag);return options.replaceSpacesWithDashes&&(tagText=tiUtil.replaceSpacesWithDashes(tagText)),setTagText(tag,tagText),canAddTag(tag).then(function(){self.items.push(tag),events.trigger("tag-added",{$tag:tag})})["catch"](function(){tagText&&events.trigger("invalid-tag",{$tag:tag})})},self.remove=function(index){var tag=self.items[index];return canRemoveTag(tag).then(function(){return self.items.splice(index,1),self.clearSelection(),events.trigger("tag-removed",{$tag:tag}),tag})},self.select=function(index){index<0?index=self.items.length-1:index>=self.items.length&&(index=0),self.index=index,self.selected=self.items[index]},self.selectPrior=function(){self.select(--self.index)},self.selectNext=function(){self.select(++self.index)},self.removeSelected=function(){return self.remove(self.index)},self.clearSelection=function(){self.selected=null,self.index=-1},self.clearSelection(),self}function validateType(type){return SUPPORTED_INPUT_TYPES.indexOf(type)!==-1}return{restrict:"E",require:"ngModel",scope:{tags:"=ngModel",text:"=?",templateScope:"=?",tagClass:"&",onTagAdding:"&",onTagAdded:"&",onInvalidTag:"&",onTagRemoving:"&",onTagRemoved:"&",onTagClicked:"&"},replace:!1,transclude:!0,templateUrl:"ngTagsInput/tags-input.html",controller:["$scope","$attrs","$element",function($scope,$attrs,$element){$scope.events=tiUtil.simplePubSub(),tagsInputConfig.load("tagsInput",$scope,$attrs,{template:[String,"ngTagsInput/tag-item.html"],type:[String,"text",validateType],placeholder:[String,"Add a tag"],tabindex:[Number,null],removeTagSymbol:[String,String.fromCharCode(215)],replaceSpacesWithDashes:[Boolean,!0],minLength:[Number,3],maxLength:[Number,MAX_SAFE_INTEGER],addOnEnter:[Boolean,!0],addOnSpace:[Boolean,!1],addOnComma:[Boolean,!0],addOnBlur:[Boolean,!0],addOnPaste:[Boolean,!1],pasteSplitPattern:[RegExp,/,/],allowedTagsPattern:[RegExp,/.+/],enableEditingLastTag:[Boolean,!1],minTags:[Number,0],maxTags:[Number,MAX_SAFE_INTEGER],displayProperty:[String,"text"],keyProperty:[String,""],allowLeftoverText:[Boolean,!1],addFromAutocompleteOnly:[Boolean,!1],spellcheck:[Boolean,!0]}),$scope.tagList=new TagList($scope.options,$scope.events,tiUtil.handleUndefinedResult($scope.onTagAdding,!0),tiUtil.handleUndefinedResult($scope.onTagRemoving,!0)),this.registerAutocomplete=function(){$element.find("input");return{addTag:function(tag){return $scope.tagList.add(tag)},getTags:function(){return $scope.tagList.items},getCurrentTagText:function(){return $scope.newTag.text()},getOptions:function(){return $scope.options},getTemplateScope:function(){return $scope.templateScope},on:function(name,handler){return $scope.events.on(name,handler,!0),this}}},this.registerTagItem=function(){return{getOptions:function(){return $scope.options},removeTag:function(index){$scope.disabled||$scope.tagList.remove(index)}}}}],link:function(scope,element,attrs,ngModelCtrl){var setElementValidity,focusInput,hotkeys=[KEYS.enter,KEYS.comma,KEYS.space,KEYS.backspace,KEYS["delete"],KEYS.left,KEYS.right],tagList=scope.tagList,events=scope.events,options=scope.options,input=element.find("input"),validationOptions=["minTags","maxTags","allowLeftoverText"];
setElementValidity=function(){ngModelCtrl.$setValidity("maxTags",tagList.items.length<=options.maxTags),ngModelCtrl.$setValidity("minTags",tagList.items.length>=options.minTags),ngModelCtrl.$setValidity("leftoverText",!(!scope.hasFocus&&!options.allowLeftoverText)||!scope.newTag.text())},focusInput=function(){$timeout(function(){input[0].focus()})},ngModelCtrl.$isEmpty=function(value){return!value||!value.length},scope.newTag={text:function(value){return angular.isDefined(value)?(scope.text=value,void events.trigger("input-change",value)):scope.text||""},invalid:null},scope.track=function(tag){return tag[options.keyProperty||options.displayProperty]},scope.getTagClass=function(tag,index){var selected=tag===tagList.selected;return[scope.tagClass({$tag:tag,$index:index,$selected:selected}),{selected:selected}]},scope.$watch("tags",function(value){value?(tagList.items=tiUtil.makeObjectArray(value,options.displayProperty),scope.tags=tagList.items):tagList.items=[]}),scope.$watch("tags.length",function(){setElementValidity(),ngModelCtrl.$validate()}),attrs.$observe("disabled",function(value){scope.disabled=value}),scope.eventHandlers={input:{keydown:function($event){events.trigger("input-keydown",$event)},focus:function(){scope.hasFocus||(scope.hasFocus=!0,events.trigger("input-focus"))},blur:function(){$timeout(function(){var activeElement=$document.prop("activeElement"),lostFocusToBrowserWindow=activeElement===input[0],lostFocusToChildElement=element[0].contains(activeElement);!lostFocusToBrowserWindow&&lostFocusToChildElement||(scope.hasFocus=!1,events.trigger("input-blur"))})},paste:function($event){$event.getTextData=function(){var clipboardData=$event.clipboardData||$event.originalEvent&&$event.originalEvent.clipboardData;return clipboardData?clipboardData.getData("text/plain"):$window.clipboardData.getData("Text")},events.trigger("input-paste",$event)}},host:{click:function(){scope.disabled||focusInput()}},tag:{click:function(tag){events.trigger("tag-clicked",{$tag:tag})}}},events.on("tag-added",scope.onTagAdded).on("invalid-tag",scope.onInvalidTag).on("tag-removed",scope.onTagRemoved).on("tag-clicked",scope.onTagClicked).on("tag-added",function(){scope.newTag.text("")}).on("tag-added tag-removed",function(){scope.tags=tagList.items,ngModelCtrl.$setDirty(),focusInput()}).on("invalid-tag",function(){scope.newTag.invalid=!0}).on("option-change",function(e){validationOptions.indexOf(e.name)!==-1&&setElementValidity()}).on("input-change",function(){tagList.clearSelection(),scope.newTag.invalid=null}).on("input-focus",function(){element.triggerHandler("focus"),ngModelCtrl.$setValidity("leftoverText",!0)}).on("input-blur",function(){options.addOnBlur&&!options.addFromAutocompleteOnly&&tagList.addText(scope.newTag.text()),element.triggerHandler("blur"),setElementValidity()}).on("input-keydown",function(event){var shouldAdd,shouldRemove,shouldSelect,shouldEditLastTag,key=event.keyCode,addKeys={};tiUtil.isModifierOn(event)||hotkeys.indexOf(key)===-1||(addKeys[KEYS.enter]=options.addOnEnter,addKeys[KEYS.comma]=options.addOnComma,addKeys[KEYS.space]=options.addOnSpace,shouldAdd=!options.addFromAutocompleteOnly&&addKeys[key],shouldRemove=(key===KEYS.backspace||key===KEYS["delete"])&&tagList.selected,shouldEditLastTag=key===KEYS.backspace&&0===scope.newTag.text().length&&options.enableEditingLastTag,shouldSelect=(key===KEYS.backspace||key===KEYS.left||key===KEYS.right)&&0===scope.newTag.text().length&&!options.enableEditingLastTag,shouldAdd?tagList.addText(scope.newTag.text()):shouldEditLastTag?(tagList.selectPrior(),tagList.removeSelected().then(function(tag){tag&&scope.newTag.text(tag[options.displayProperty])})):shouldRemove?tagList.removeSelected():shouldSelect&&(key===KEYS.left||key===KEYS.backspace?tagList.selectPrior():key===KEYS.right&&tagList.selectNext()),(shouldAdd||shouldSelect||shouldRemove||shouldEditLastTag)&&event.preventDefault())}).on("input-paste",function(event){if(options.addOnPaste){var data=event.getTextData(),tags=data.split(options.pasteSplitPattern);tags.length>1&&(tags.forEach(function(tag){tagList.addText(tag)}),event.preventDefault())}})}}}]),tagsInput.directive("tiTagItem",["tiUtil",function(tiUtil){return{restrict:"E",require:"^tagsInput",template:'<ng-include src="$$template"></ng-include>',scope:{$scope:"=scope",data:"="},link:function(scope,element,attrs,tagsInputCtrl){var tagsInput=tagsInputCtrl.registerTagItem(),options=tagsInput.getOptions();scope.$$template=options.template,scope.$$removeTagSymbol=options.removeTagSymbol,scope.$getDisplayText=function(){return tiUtil.safeToString(scope.data[options.displayProperty])},scope.$removeTag=function(){tagsInput.removeTag(scope.$index)},scope.$watch("$parent.$index",function(value){scope.$index=value})}}}]),tagsInput.directive("autoComplete",["$document","$timeout","$sce","$q","tagsInputConfig","tiUtil",function($document,$timeout,$sce,$q,tagsInputConfig,tiUtil){function SuggestionList(loadFn,options,events){var getDifference,lastPromise,getTagId,self={};return getTagId=function(){return options.tagsInput.keyProperty||options.tagsInput.displayProperty},getDifference=function(array1,array2){return array1.filter(function(item){return!tiUtil.findInObjectArray(array2,item,getTagId(),function(a,b){return options.tagsInput.replaceSpacesWithDashes&&(a=tiUtil.replaceSpacesWithDashes(a),b=tiUtil.replaceSpacesWithDashes(b)),tiUtil.defaultComparer(a,b)})})},self.reset=function(){lastPromise=null,self.items=[],self.visible=!1,self.index=-1,self.selected=null,self.query=null},self.show=function(){options.selectFirstMatch?self.select(0):self.selected=null,self.visible=!0},self.load=tiUtil.debounce(function(query,tags){self.query=query;var promise=$q.when(loadFn({$query:query}));lastPromise=promise,promise.then(function(items){promise===lastPromise&&(items=tiUtil.makeObjectArray(items.data||items,getTagId()),items=getDifference(items,tags),self.items=items.slice(0,options.maxResultsToShow),self.items.length>0?self.show():self.reset())})},options.debounceDelay),self.selectNext=function(){self.select(++self.index)},self.selectPrior=function(){self.select(--self.index)},self.select=function(index){index<0?index=self.items.length-1:index>=self.items.length&&(index=0),self.index=index,self.selected=self.items[index],events.trigger("suggestion-selected",index)},self.reset(),self}function scrollToElement(root,index){var element=root.find("li").eq(index),parent=element.parent(),elementTop=element.prop("offsetTop"),elementHeight=element.prop("offsetHeight"),parentHeight=parent.prop("clientHeight"),parentScrollTop=parent.prop("scrollTop");elementTop<parentScrollTop?parent.prop("scrollTop",elementTop):elementTop+elementHeight>parentHeight+parentScrollTop&&parent.prop("scrollTop",elementTop+elementHeight-parentHeight)}return{restrict:"E",require:"^tagsInput",scope:{source:"&",matchClass:"&"},templateUrl:"ngTagsInput/auto-complete.html",controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$scope.events=tiUtil.simplePubSub(),tagsInputConfig.load("autoComplete",$scope,$attrs,{template:[String,"ngTagsInput/auto-complete-match.html"],debounceDelay:[Number,100],minLength:[Number,3],highlightMatchedText:[Boolean,!0],maxResultsToShow:[Number,10],loadOnDownArrow:[Boolean,!1],loadOnEmpty:[Boolean,!1],loadOnFocus:[Boolean,!1],selectFirstMatch:[Boolean,!0],displayProperty:[String,""]}),$scope.suggestionList=new SuggestionList($scope.source,$scope.options,$scope.events),this.registerAutocompleteMatch=function(){return{getOptions:function(){return $scope.options},getQuery:function(){return $scope.suggestionList.query}}}}],link:function(scope,element,attrs,tagsInputCtrl){var shouldLoadSuggestions,hotkeys=[KEYS.enter,KEYS.tab,KEYS.escape,KEYS.up,KEYS.down],suggestionList=scope.suggestionList,tagsInput=tagsInputCtrl.registerAutocomplete(),options=scope.options,events=scope.events;options.tagsInput=tagsInput.getOptions(),shouldLoadSuggestions=function(value){return value&&value.length>=options.minLength||!value&&options.loadOnEmpty},scope.templateScope=tagsInput.getTemplateScope(),scope.addSuggestionByIndex=function(index){suggestionList.select(index),scope.addSuggestion()},scope.addSuggestion=function(){var added=!1;return suggestionList.selected&&(tagsInput.addTag(angular.copy(suggestionList.selected)),suggestionList.reset(),added=!0),added},scope.track=function(item){return item[options.tagsInput.keyProperty||options.tagsInput.displayProperty]},scope.getSuggestionClass=function(item,index){var selected=item===suggestionList.selected;return[scope.matchClass({$match:item,$index:index,$selected:selected}),{selected:selected}]},tagsInput.on("tag-added tag-removed invalid-tag input-blur",function(){suggestionList.reset()}).on("input-change",function(value){shouldLoadSuggestions(value)?suggestionList.load(value,tagsInput.getTags()):suggestionList.reset()}).on("input-focus",function(){var value=tagsInput.getCurrentTagText();options.loadOnFocus&&shouldLoadSuggestions(value)&&suggestionList.load(value,tagsInput.getTags())}).on("input-keydown",function(event){var key=event.keyCode,handled=!1;if(!tiUtil.isModifierOn(event)&&hotkeys.indexOf(key)!==-1)return suggestionList.visible?key===KEYS.down?(suggestionList.selectNext(),handled=!0):key===KEYS.up?(suggestionList.selectPrior(),handled=!0):key===KEYS.escape?(suggestionList.reset(),handled=!0):key!==KEYS.enter&&key!==KEYS.tab||(handled=scope.addSuggestion()):key===KEYS.down&&scope.options.loadOnDownArrow&&(suggestionList.load(tagsInput.getCurrentTagText(),tagsInput.getTags()),handled=!0),handled?(event.preventDefault(),event.stopImmediatePropagation(),!1):void 0}),events.on("suggestion-selected",function(index){scrollToElement(element,index)})}}}]),tagsInput.directive("tiAutocompleteMatch",["$sce","tiUtil",function($sce,tiUtil){return{restrict:"E",require:"^autoComplete",template:'<ng-include src="$$template"></ng-include>',scope:{$scope:"=scope",data:"="},link:function(scope,element,attrs,autoCompleteCtrl){var autoComplete=autoCompleteCtrl.registerAutocompleteMatch(),options=autoComplete.getOptions();scope.$$template=options.template,scope.$index=scope.$parent.$index,scope.$highlight=function(text){return options.highlightMatchedText&&(text=tiUtil.safeHighlight(text,autoComplete.getQuery())),$sce.trustAsHtml(text)},scope.$getDisplayText=function(){return tiUtil.safeToString(scope.data[options.displayProperty||options.tagsInput.displayProperty])}}}}]),tagsInput.directive("tiTranscludeAppend",function(){return function(scope,element,attrs,ctrl,transcludeFn){transcludeFn(function(clone){element.append(clone)})}}),tagsInput.directive("tiAutosize",["tagsInputConfig",function(tagsInputConfig){return{restrict:"A",require:"ngModel",link:function(scope,element,attrs,ctrl){var span,resize,threshold=tagsInputConfig.getTextAutosizeThreshold();span=angular.element('<span class="input"></span>'),span.css("display","none").css("visibility","hidden").css("width","auto").css("white-space","pre"),element.parent().append(span),resize=function(originalValue){var width,value=originalValue;return angular.isString(value)&&0===value.length&&(value=attrs.placeholder),value&&(span.text(value),span.css("display",""),width=span.prop("offsetWidth"),span.css("display","none")),element.css("width",width?width+threshold+"px":""),originalValue},ctrl.$parsers.unshift(resize),ctrl.$formatters.unshift(resize),attrs.$observe("placeholder",function(value){ctrl.$modelValue||resize(value)})}}}]),tagsInput.directive("tiBindAttrs",function(){return function(scope,element,attrs){scope.$watch(attrs.tiBindAttrs,function(value){angular.forEach(value,function(value,key){attrs.$set(key,value)})},!0)}}),tagsInput.provider("tagsInputConfig",function(){var globalDefaults={},interpolationStatus={},autosizeThreshold=3;this.setDefaults=function(directive,defaults){return globalDefaults[directive]=defaults,this},this.setActiveInterpolation=function(directive,options){return interpolationStatus[directive]=options,this},this.setTextAutosizeThreshold=function(threshold){return autosizeThreshold=threshold,this},this.$get=["$interpolate",function($interpolate){var converters={};return converters[String]=function(value){return value},converters[Number]=function(value){return parseInt(value,10)},converters[Boolean]=function(value){return"true"===value.toLowerCase()},converters[RegExp]=function(value){return new RegExp(value)},{load:function(directive,scope,attrs,options){var defaultValidator=function(){return!0};scope.options={},angular.forEach(options,function(value,key){var type,localDefault,validator,converter,getDefault,updateValue;type=value[0],localDefault=value[1],validator=value[2]||defaultValidator,converter=converters[type],getDefault=function(){var globalValue=globalDefaults[directive]&&globalDefaults[directive][key];return angular.isDefined(globalValue)?globalValue:localDefault},updateValue=function(value){scope.options[key]=value&&validator(value)?converter(value):getDefault()},interpolationStatus[directive]&&interpolationStatus[directive][key]?attrs.$observe(key,function(value){updateValue(value),scope.events.trigger("option-change",{name:key,newValue:value})}):updateValue(attrs[key]&&$interpolate(attrs[key])(scope.$parent))})},getTextAutosizeThreshold:function(){return autosizeThreshold}}}]}),tagsInput.factory("tiUtil",["$timeout","$q",function($timeout,$q){var self={};return self.debounce=function(fn,delay){var timeoutId;return function(){var args=arguments;$timeout.cancel(timeoutId),timeoutId=$timeout(function(){fn.apply(null,args)},delay)}},self.makeObjectArray=function(array,key){if(!angular.isArray(array)||0===array.length||angular.isObject(array[0]))return array;var newArray=[];return array.forEach(function(item){var obj={};obj[key]=item,newArray.push(obj)}),newArray},self.findInObjectArray=function(array,obj,key,comparer){var item=null;return comparer=comparer||self.defaultComparer,array.some(function(element){if(comparer(element[key],obj[key]))return item=element,!0}),item},self.defaultComparer=function(a,b){return self.safeToString(a).toLowerCase()===self.safeToString(b).toLowerCase()},self.safeHighlight=function(str,value){function escapeRegexChars(str){return str.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}if(!value)return str;str=self.encodeHTML(str),value=self.encodeHTML(value);var expression=new RegExp("&[^;]+;|"+escapeRegexChars(value),"gi");return str.replace(expression,function(match){return match.toLowerCase()===value.toLowerCase()?"<em>"+match+"</em>":match})},self.safeToString=function(value){return angular.isUndefined(value)||null==value?"":value.toString().trim()},self.encodeHTML=function(value){return self.safeToString(value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},self.handleUndefinedResult=function(fn,valueIfUndefined){return function(){var result=fn.apply(null,arguments);return angular.isUndefined(result)?valueIfUndefined:result}},self.replaceSpacesWithDashes=function(str){return self.safeToString(str).replace(/\s/g,"-")},self.isModifierOn=function(event){return event.shiftKey||event.ctrlKey||event.altKey||event.metaKey},self.promisifyValue=function(value){return value=!!angular.isUndefined(value)||value,$q[value?"when":"reject"]()},self.simplePubSub=function(){var events={};return{on:function(names,handler,first){return names.split(" ").forEach(function(name){events[name]||(events[name]=[]);var method=first?[].unshift:[].push;method.call(events[name],handler)}),this},trigger:function(name,args){var handlers=events[name]||[];return handlers.every(function(handler){return self.handleUndefinedResult(handler,!0)(args)}),this}}},self}]),tagsInput.run(["$templateCache",function($templateCache){$templateCache.put("ngTagsInput/tags-input.html",'<div class="host" tabindex="-1" ng-click="eventHandlers.host.click()" ti-transclude-append><div class="tags" ng-class="{focused: hasFocus}"><ul class="tag-list"><li class="tag-item" ng-repeat="tag in tagList.items track by track(tag)" ng-class="getTagClass(tag, $index)" ng-click="eventHandlers.tag.click(tag)"><ti-tag-item scope="templateScope" data="::tag"></ti-tag-item></li></ul><input class="input" autocomplete="off" ng-model="newTag.text" ng-model-options="{getterSetter: true}" ng-keydown="eventHandlers.input.keydown($event)" ng-focus="eventHandlers.input.focus($event)" ng-blur="eventHandlers.input.blur($event)" ng-paste="eventHandlers.input.paste($event)" ng-trim="false" ng-class="{\'invalid-tag\': newTag.invalid}" ng-disabled="disabled" ti-bind-attrs="{type: options.type, placeholder: options.placeholder, tabindex: options.tabindex, spellcheck: options.spellcheck}" ti-autosize></div></div>'),$templateCache.put("ngTagsInput/tag-item.html",'<span ng-bind="$getDisplayText()"></span> <a class="remove-button" ng-click="$removeTag()" ng-bind="::$$removeTagSymbol"></a>'),$templateCache.put("ngTagsInput/auto-complete.html",'<div class="autocomplete" ng-if="suggestionList.visible"><ul class="suggestion-list"><li class="suggestion-item" ng-repeat="item in suggestionList.items track by track(item)" ng-class="getSuggestionClass(item, $index)" ng-click="addSuggestionByIndex($index)" ng-mouseenter="suggestionList.select($index)"><ti-autocomplete-match scope="templateScope" data="::item"></ti-autocomplete-match></li></ul></div>'),$templateCache.put("ngTagsInput/auto-complete-match.html",'<span ng-bind-html="$highlight($getDisplayText())"></span>')}])}();var Showdown={extensions:{}},forEach=Showdown.forEach=function(obj,callback){if("function"==typeof obj.forEach)obj.forEach(callback);else{var i,len=obj.length;for(i=0;i<len;i++)callback(obj[i],i,obj)}},stdExtName=function(s){return s.replace(/[_-]||\s/g,"").toLowerCase()};Showdown.converter=function(converter_options){var g_urls,g_titles,g_html_blocks,g_list_level=0,g_lang_extensions=[],g_output_modifiers=[];if("undefined"!=typeof module&&"undefined"!=typeof exports&&"undefined"!=typeof require){var fs=require("fs");if(fs){var extensions=fs.readdirSync((__dirname||".")+"/extensions").filter(function(file){return~file.indexOf(".js")}).map(function(file){return file.replace(/\.js$/,"")});Showdown.forEach(extensions,function(ext){var name=stdExtName(ext);Showdown.extensions[name]=require("./extensions/"+ext)})}}if(this.makeHtml=function(text){return g_urls={},g_titles={},g_html_blocks=[],text=text.replace(/~/g,"~T"),text=text.replace(/\$/g,"~D"),text=text.replace(/\r\n/g,"\n"),text=text.replace(/\r/g,"\n"),text="\n\n"+text+"\n\n",text=_Detab(text),text=text.replace(/^[ \t]+$/gm,""),Showdown.forEach(g_lang_extensions,function(x){text=_ExecuteExtension(x,text)}),text=_DoGithubCodeBlocks(text),text=_HashHTMLBlocks(text),text=_StripLinkDefinitions(text),text=_RunBlockGamut(text),text=_UnescapeSpecialChars(text),text=text.replace(/~D/g,"$$"),text=text.replace(/~T/g,"~"),Showdown.forEach(g_output_modifiers,function(x){text=_ExecuteExtension(x,text)}),text},converter_options&&converter_options.extensions){var self=this;Showdown.forEach(converter_options.extensions,function(plugin){if("string"==typeof plugin&&(plugin=Showdown.extensions[stdExtName(plugin)]),"function"!=typeof plugin)throw"Extension '"+plugin+"' could not be loaded.  It was either not found or is not a valid extension.";Showdown.forEach(plugin(self),function(ext){ext.type?"language"===ext.type||"lang"===ext.type?g_lang_extensions.push(ext):"output"!==ext.type&&"html"!==ext.type||g_output_modifiers.push(ext):g_output_modifiers.push(ext)})})}var _ProcessListItems,_ExecuteExtension=function(ext,text){if(ext.regex){var re=new RegExp(ext.regex,"g");return text.replace(re,ext.replace)}if(ext.filter)return ext.filter(text)},_StripLinkDefinitions=function(text){return text+="~0",text=text.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|(?=~0))/gm,function(wholeMatch,m1,m2,m3,m4){return m1=m1.toLowerCase(),g_urls[m1]=_EncodeAmpsAndAngles(m2),m3?m3+m4:(m4&&(g_titles[m1]=m4.replace(/"/g,"&quot;")),"")}),text=text.replace(/~0/,"")},_HashHTMLBlocks=function(text){text=text.replace(/\n/g,"\n\n");return text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,hashElement),text=text.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|style|section|header|footer|nav|article|aside)\b[^\r]*?<\/\2>[ \t]*(?=\n+)\n)/gm,hashElement),text=text.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,hashElement),text=text.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,hashElement),text=text.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,hashElement),text=text.replace(/\n\n/g,"\n")},hashElement=function(wholeMatch,m1){var blockText=m1;return blockText=blockText.replace(/\n\n/g,"\n"),blockText=blockText.replace(/^\n/,""),blockText=blockText.replace(/\n+$/g,""),blockText="\n\n~K"+(g_html_blocks.push(blockText)-1)+"K\n\n"},_RunBlockGamut=function(text){text=_DoHeaders(text);var key=hashBlock("<hr />");return text=text.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,key),text=text.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,key),text=text.replace(/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm,key),text=_DoLists(text),text=_DoCodeBlocks(text),text=_DoBlockQuotes(text),text=_HashHTMLBlocks(text),text=_FormParagraphs(text)},_RunSpanGamut=function(text){return text=_DoCodeSpans(text),text=_EscapeSpecialCharsWithinTagAttributes(text),text=_EncodeBackslashEscapes(text),text=_DoImages(text),text=_DoAnchors(text),text=_DoAutoLinks(text),text=_EncodeAmpsAndAngles(text),text=_DoItalicsAndBold(text),text=text.replace(/  +\n/g," <br />\n")},_EscapeSpecialCharsWithinTagAttributes=function(text){var regex=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;return text=text.replace(regex,function(wholeMatch){var tag=wholeMatch.replace(/(.)<\/?code>(?=.)/g,"$1`");return tag=escapeCharacters(tag,"\\`*_")})},_DoAnchors=function(text){return text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeAnchorTag),text=text.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?(?:\(.*?\).*?)?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeAnchorTag),text=text.replace(/(\[([^\[\]]+)\])()()()()()/g,writeAnchorTag)},writeAnchorTag=function(wholeMatch,m1,m2,m3,m4,m5,m6,m7){void 0==m7&&(m7="");var whole_match=m1,link_text=m2,link_id=m3.toLowerCase(),url=m4,title=m7;if(""==url)if(""==link_id&&(link_id=link_text.toLowerCase().replace(/ ?\n/g," ")),url="#"+link_id,void 0!=g_urls[link_id])url=g_urls[link_id],void 0!=g_titles[link_id]&&(title=g_titles[link_id]);else{if(!(whole_match.search(/\(\s*\)$/m)>-1))return whole_match;url=""}url=escapeCharacters(url,"*_");var result='<a href="'+url+'"';return""!=title&&(title=title.replace(/"/g,"&quot;"),title=escapeCharacters(title,"*_"),result+=' title="'+title+'"'),result+=">"+link_text+"</a>"},_DoImages=function(text){return text=text.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,writeImageTag),text=text.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,writeImageTag)},writeImageTag=function(wholeMatch,m1,m2,m3,m4,m5,m6,m7){var whole_match=m1,alt_text=m2,link_id=m3.toLowerCase(),url=m4,title=m7;if(title||(title=""),""==url){if(""==link_id&&(link_id=alt_text.toLowerCase().replace(/ ?\n/g," ")),url="#"+link_id,void 0==g_urls[link_id])return whole_match;url=g_urls[link_id],void 0!=g_titles[link_id]&&(title=g_titles[link_id])}alt_text=alt_text.replace(/"/g,"&quot;"),url=escapeCharacters(url,"*_");var result='<img src="'+url+'" alt="'+alt_text+'"';return title=title.replace(/"/g,"&quot;"),title=escapeCharacters(title,"*_"),result+=' title="'+title+'"',result+=" />"},_DoHeaders=function(text){function headerId(m){return m.replace(/[^\w]/g,"").toLowerCase()}return text=text.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(wholeMatch,m1){return hashBlock('<h1 id="'+headerId(m1)+'">'+_RunSpanGamut(m1)+"</h1>")}),text=text.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(matchFound,m1){return hashBlock('<h2 id="'+headerId(m1)+'">'+_RunSpanGamut(m1)+"</h2>")}),text=text.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(wholeMatch,m1,m2){var h_level=m1.length;return hashBlock("<h"+h_level+' id="'+headerId(m2)+'">'+_RunSpanGamut(m2)+"</h"+h_level+">")})},_DoLists=function(text){text+="~0";var whole_list=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return g_list_level?text=text.replace(whole_list,function(wholeMatch,m1,m2){var list=m1,list_type=m2.search(/[*+-]/g)>-1?"ul":"ol";list=list.replace(/\n{2,}/g,"\n\n\n");var result=_ProcessListItems(list);return result=result.replace(/\s+$/,""),result="<"+list_type+">"+result+"</"+list_type+">\n"}):(whole_list=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,text=text.replace(whole_list,function(wholeMatch,m1,m2,m3){var runup=m1,list=m2,list_type=m3.search(/[*+-]/g)>-1?"ul":"ol",list=list.replace(/\n{2,}/g,"\n\n\n"),result=_ProcessListItems(list);return result=runup+"<"+list_type+">\n"+result+"</"+list_type+">\n"})),text=text.replace(/~0/,"")};_ProcessListItems=function(list_str){return g_list_level++,list_str=list_str.replace(/\n{2,}$/,"\n"),list_str+="~0",list_str=list_str.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(wholeMatch,m1,m2,m3,m4){var item=m4,leading_line=m1;return leading_line||item.search(/\n{2,}/)>-1?item=_RunBlockGamut(_Outdent(item)):(item=_DoLists(_Outdent(item)),item=item.replace(/\n$/,""),item=_RunSpanGamut(item)),"<li>"+item+"</li>\n"}),list_str=list_str.replace(/~0/g,""),g_list_level--,list_str};var _DoCodeBlocks=function(text){return text+="~0",text=text.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(wholeMatch,m1,m2){var codeblock=m1,nextChar=m2;return codeblock=_EncodeCode(_Outdent(codeblock)),codeblock=_Detab(codeblock),codeblock=codeblock.replace(/^\n+/g,""),codeblock=codeblock.replace(/\n+$/g,""),codeblock="<pre><code>"+codeblock+"\n</code></pre>",hashBlock(codeblock)+nextChar}),text=text.replace(/~0/,"")},_DoGithubCodeBlocks=function(text){return text+="~0",text=text.replace(/(?:^|\n)```(.*)\n([\s\S]*?)\n```/g,function(wholeMatch,m1,m2){var language=m1,codeblock=m2;return codeblock=_EncodeCode(codeblock),codeblock=_Detab(codeblock),codeblock=codeblock.replace(/^\n+/g,""),codeblock=codeblock.replace(/\n+$/g,""),codeblock="<pre><code"+(language?' class="'+language+'"':"")+">"+codeblock+"\n</code></pre>",hashBlock(codeblock)}),text=text.replace(/~0/,"")},hashBlock=function(text){return text=text.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(g_html_blocks.push(text)-1)+"K\n\n"},_DoCodeSpans=function(text){return text=text.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(wholeMatch,m1,m2,m3,m4){var c=m3;return c=c.replace(/^([ \t]*)/g,""),c=c.replace(/[ \t]*$/g,""),c=_EncodeCode(c),m1+"<code>"+c+"</code>"})},_EncodeCode=function(text){return text=text.replace(/&/g,"&amp;"),text=text.replace(/</g,"&lt;"),text=text.replace(/>/g,"&gt;"),text=escapeCharacters(text,"*_{}[]\\",!1)},_DoItalicsAndBold=function(text){return text=text.replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>"),text=text.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")},_DoBlockQuotes=function(text){return text=text.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(wholeMatch,m1){var bq=m1;return bq=bq.replace(/^[ \t]*>[ \t]?/gm,"~0"),bq=bq.replace(/~0/g,""),bq=bq.replace(/^[ \t]+$/gm,""),bq=_RunBlockGamut(bq),bq=bq.replace(/(^|\n)/g,"$1  "),bq=bq.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(wholeMatch,m1){var pre=m1;return pre=pre.replace(/^  /gm,"~0"),pre=pre.replace(/~0/g,"")}),hashBlock("<blockquote>\n"+bq+"\n</blockquote>")})},_FormParagraphs=function(text){text=text.replace(/^\n+/g,""),text=text.replace(/\n+$/g,"");for(var grafs=text.split(/\n{2,}/g),grafsOut=[],end=grafs.length,i=0;i<end;i++){var str=grafs[i];str.search(/~K(\d+)K/g)>=0?grafsOut.push(str):str.search(/\S/)>=0&&(str=_RunSpanGamut(str),str=str.replace(/^([ \t]*)/g,"<p>"),str+="</p>",grafsOut.push(str))}end=grafsOut.length;for(var i=0;i<end;i++)for(;grafsOut[i].search(/~K(\d+)K/)>=0;){var blockText=g_html_blocks[RegExp.$1];blockText=blockText.replace(/\$/g,"$$$$"),grafsOut[i]=grafsOut[i].replace(/~K\d+K/,blockText)}return grafsOut.join("\n\n")},_EncodeAmpsAndAngles=function(text){return text=text.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),text=text.replace(/<(?![a-z\/?\$!])/gi,"&lt;")},_EncodeBackslashEscapes=function(text){return text=text.replace(/\\(\\)/g,escapeCharacters_callback),text=text.replace(/\\([`*_{}\[\]()>#+-.!])/g,escapeCharacters_callback)},_DoAutoLinks=function(text){return text=text.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>'),text=text.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(wholeMatch,m1){return _EncodeEmailAddress(_UnescapeSpecialChars(m1))})},_EncodeEmailAddress=function(addr){var encode=[function(ch){return"&#"+ch.charCodeAt(0)+";"},function(ch){return"&#x"+ch.charCodeAt(0).toString(16)+";"},function(ch){return ch}];return addr="mailto:"+addr,addr=addr.replace(/./g,function(ch){if("@"==ch)ch=encode[Math.floor(2*Math.random())](ch);else if(":"!=ch){var r=Math.random();ch=r>.9?encode[2](ch):r>.45?encode[1](ch):encode[0](ch)}return ch}),addr='<a href="'+addr+'">'+addr+"</a>",addr=addr.replace(/">.+:/g,'">')},_UnescapeSpecialChars=function(text){return text=text.replace(/~E(\d+)E/g,function(wholeMatch,m1){var charCodeToReplace=parseInt(m1);return String.fromCharCode(charCodeToReplace)})},_Outdent=function(text){return text=text.replace(/^(\t|[ ]{1,4})/gm,"~0"),text=text.replace(/~0/g,"")},_Detab=function(text){return text=text.replace(/\t(?=\t)/g,"    "),text=text.replace(/\t/g,"~A~B"),text=text.replace(/~B(.+?)~A/g,function(wholeMatch,m1,m2){for(var leadingText=m1,numSpaces=4-leadingText.length%4,i=0;i<numSpaces;i++)leadingText+=" ";return leadingText}),text=text.replace(/~A/g,"    "),text=text.replace(/~B/g,"")},escapeCharacters=function(text,charsToEscape,afterBackslash){var regexString="(["+charsToEscape.replace(/([\[\]\\])/g,"\\$1")+"])";afterBackslash&&(regexString="\\\\"+regexString);var regex=new RegExp(regexString,"g");return text=text.replace(regex,escapeCharacters_callback)},escapeCharacters_callback=function(wholeMatch,m1){var charCodeToEscape=m1.charCodeAt(0);return"~E"+charCodeToEscape+"E"}},"undefined"!=typeof module&&(module.exports=Showdown),"function"==typeof define&&define.amd&&define("showdown",function(){return Showdown}),"undefined"!=typeof angular&&"undefined"!=typeof Showdown&&!function(module,Showdown){function provider(){function SDObject(){var converter=new Showdown.converter(config);this.makeHtml=function(markdown){return converter.makeHtml(markdown)},this.stripHtml=function(text){return String(text).replace(/<[^>]+>/gm,"")}}var config={extensions:[],stripHtml:!0};this.setOption=function(key,value){return config.key=value,this},this.getOption=function(key){return config.hasOwnProperty(key)?config.key:null},this.loadExtension=function(extensionName){return config.extensions.push(extensionName),this},this.$get=function(){return new SDObject}}function markdownToHtmlDirective($Showdown){var link=function(scope,element){scope.$watch("model",function(newValue){var val;val="string"==typeof newValue?$Showdown.makeHtml(newValue):typeof newValue,element.html(val)})};return{restrict:"A",link:link,scope:{model:"=sdModelToHtml"}}}function stripHtmlFilter(){return function(text){return String(text).replace(/<[^>]+>/gm,"")}}module.provider("$Showdown",provider).directive("sdModelToHtml",["$Showdown",markdownToHtmlDirective]).filter("sdStripHtml",stripHtmlFilter)}(angular.module("Showdown",[]),Showdown),angular.module("btford.markdown",["ngSanitize"]).provider("markdownConverter",function(){var opts={};return{config:function(newOpts){opts=newOpts},$get:function(){return new Showdown.converter(opts);
}}}).directive("btfMarkdown",["$sanitize","markdownConverter",function($sanitize,markdownConverter){return{restrict:"AE",link:function(scope,element,attrs){if(attrs.btfMarkdown)scope.$watch(attrs.btfMarkdown,function(newVal){var html=newVal?$sanitize(markdownConverter.makeHtml(newVal)):"";element.html(html)});else{var html=$sanitize(markdownConverter.makeHtml(element.text()));element.html(html)}}}}]),!function(a,b){var c,d,e,f=a,g=f.document,h=f.navigator,i=f.setTimeout,j=f.clearTimeout,k=f.setInterval,l=f.clearInterval,m=f.getComputedStyle,n=f.encodeURIComponent,o=f.ActiveXObject,p=f.Error,q=f.Number.parseInt||f.parseInt,r=f.Number.parseFloat||f.parseFloat,s=f.Number.isNaN||f.isNaN,t=f.Date.now,u=f.Object.keys,v=f.Object.defineProperty,w=f.Object.prototype.hasOwnProperty,x=f.Array.prototype.slice,y=function(){var a=function(a){return a};if("function"==typeof f.wrap&&"function"==typeof f.unwrap)try{var b=g.createElement("div"),c=f.unwrap(b);1===b.nodeType&&c&&1===c.nodeType&&(a=f.unwrap)}catch(d){}return a}(),z=function(a){return x.call(a,0)},A=function(){var a,c,d,e,f,g,h=z(arguments),i=h[0]||{};for(a=1,c=h.length;c>a;a++)if(null!=(d=h[a]))for(e in d)w.call(d,e)&&(f=i[e],g=d[e],i!==g&&g!==b&&(i[e]=g));return i},B=function(a){var b,c,d,e;if("object"!=typeof a||null==a||"number"==typeof a.nodeType)b=a;else if("number"==typeof a.length)for(b=[],c=0,d=a.length;d>c;c++)w.call(a,c)&&(b[c]=B(a[c]));else{b={};for(e in a)w.call(a,e)&&(b[e]=B(a[e]))}return b},C=function(a,b){for(var c={},d=0,e=b.length;e>d;d++)b[d]in a&&(c[b[d]]=a[b[d]]);return c},D=function(a,b){var c={};for(var d in a)-1===b.indexOf(d)&&(c[d]=a[d]);return c},E=function(a){if(a)for(var b in a)w.call(a,b)&&delete a[b];return a},F=function(a,b){if(a&&1===a.nodeType&&a.ownerDocument&&b&&(1===b.nodeType&&b.ownerDocument&&b.ownerDocument===a.ownerDocument||9===b.nodeType&&!b.ownerDocument&&b===a.ownerDocument))do{if(a===b)return!0;a=a.parentNode}while(a);return!1},G=function(a){var b;return"string"==typeof a&&a&&(b=a.split("#")[0].split("?")[0],b=a.slice(0,a.lastIndexOf("/")+1)),b},H=function(a){var b,c;return"string"==typeof a&&a&&(c=a.match(/^(?:|[^:@]*@|.+\)@(?=http[s]?|file)|.+?\s+(?: at |@)(?:[^:\(]+ )*[\(]?)((?:http[s]?|file):\/\/[\/]?.+?\/[^:\)]*?)(?::\d+)(?::\d+)?/),c&&c[1]?b=c[1]:(c=a.match(/\)@((?:http[s]?|file):\/\/[\/]?.+?\/[^:\)]*?)(?::\d+)(?::\d+)?/),c&&c[1]&&(b=c[1]))),b},I=function(){var a,b;try{throw new p}catch(c){b=c}return b&&(a=b.sourceURL||b.fileName||H(b.stack)),a},J=function(){var a,c,d;if(g.currentScript&&(a=g.currentScript.src))return a;if(c=g.getElementsByTagName("script"),1===c.length)return c[0].src||b;if("readyState"in c[0])for(d=c.length;d--;)if("interactive"===c[d].readyState&&(a=c[d].src))return a;return"loading"===g.readyState&&(a=c[c.length-1].src)?a:(a=I())?a:b},K=function(){var a,c,d,e=g.getElementsByTagName("script");for(a=e.length;a--;){if(!(d=e[a].src)){c=null;break}if(d=G(d),null==c)c=d;else if(c!==d){c=null;break}}return c||b},L=function(){var a=G(J())||K()||"";return a+"ZeroClipboard.swf"},M=function(){return null==a.opener&&(!!a.top&&a!=a.top||!!a.parent&&a!=a.parent)}(),N={bridge:null,version:"0.0.0",pluginType:"unknown",disabled:null,outdated:null,sandboxed:null,unavailable:null,degraded:null,deactivated:null,overdue:null,ready:null},O="11.0.0",P={},Q={},R=null,S=0,T=0,U={ready:"Flash communication is established",error:{"flash-disabled":"Flash is disabled or not installed. May also be attempting to run Flash in a sandboxed iframe, which is impossible.","flash-outdated":"Flash is too outdated to support ZeroClipboard","flash-sandboxed":"Attempting to run Flash in a sandboxed iframe, which is impossible","flash-unavailable":"Flash is unable to communicate bidirectionally with JavaScript","flash-degraded":"Flash is unable to preserve data fidelity when communicating with JavaScript","flash-deactivated":"Flash is too outdated for your browser and/or is configured as click-to-activate.\nThis may also mean that the ZeroClipboard SWF object could not be loaded, so please check your `swfPath` configuration and/or network connectivity.\nMay also be attempting to run Flash in a sandboxed iframe, which is impossible.","flash-overdue":"Flash communication was established but NOT within the acceptable time limit","version-mismatch":"ZeroClipboard JS version number does not match ZeroClipboard SWF version number","clipboard-error":"At least one error was thrown while ZeroClipboard was attempting to inject your data into the clipboard","config-mismatch":"ZeroClipboard configuration does not match Flash's reality","swf-not-found":"The ZeroClipboard SWF object could not be loaded, so please check your `swfPath` configuration and/or network connectivity"}},V=["flash-unavailable","flash-degraded","flash-overdue","version-mismatch","config-mismatch","clipboard-error"],W=["flash-disabled","flash-outdated","flash-sandboxed","flash-unavailable","flash-degraded","flash-deactivated","flash-overdue"],X=new RegExp("^flash-("+W.map(function(a){return a.replace(/^flash-/,"")}).join("|")+")$"),Y=new RegExp("^flash-("+W.slice(1).map(function(a){return a.replace(/^flash-/,"")}).join("|")+")$"),Z={swfPath:L(),trustedDomains:a.location.host?[a.location.host]:[],cacheBust:!0,forceEnhancedClipboard:!1,flashLoadTimeout:3e4,autoActivate:!0,bubbleEvents:!0,containerId:"global-zeroclipboard-html-bridge",containerClass:"global-zeroclipboard-container",swfObjectId:"global-zeroclipboard-flash-bridge",hoverClass:"zeroclipboard-is-hover",activeClass:"zeroclipboard-is-active",forceHandCursor:!1,title:null,zIndex:999999999},$=function(a){if("object"==typeof a&&null!==a)for(var b in a)if(w.call(a,b))if(/^(?:forceHandCursor|title|zIndex|bubbleEvents)$/.test(b))Z[b]=a[b];else if(null==N.bridge)if("containerId"===b||"swfObjectId"===b){if(!nb(a[b]))throw new Error("The specified `"+b+"` value is not valid as an HTML4 Element ID");Z[b]=a[b]}else Z[b]=a[b];return"string"==typeof a&&a?w.call(Z,a)?Z[a]:void 0:B(Z)},_=function(){return Tb(),{browser:C(h,["userAgent","platform","appName"]),flash:D(N,["bridge"]),zeroclipboard:{version:Vb.version,config:Vb.config()}}},ab=function(){return!!(N.disabled||N.outdated||N.sandboxed||N.unavailable||N.degraded||N.deactivated)},bb=function(a,d){var e,f,g,h={};if("string"==typeof a&&a)g=a.toLowerCase().split(/\s+/);else if("object"==typeof a&&a&&"undefined"==typeof d)for(e in a)w.call(a,e)&&"string"==typeof e&&e&&"function"==typeof a[e]&&Vb.on(e,a[e]);if(g&&g.length){for(e=0,f=g.length;f>e;e++)a=g[e].replace(/^on/,""),h[a]=!0,P[a]||(P[a]=[]),P[a].push(d);if(h.ready&&N.ready&&Vb.emit({type:"ready"}),h.error){for(e=0,f=W.length;f>e;e++)if(N[W[e].replace(/^flash-/,"")]===!0){Vb.emit({type:"error",name:W[e]});break}c!==b&&Vb.version!==c&&Vb.emit({type:"error",name:"version-mismatch",jsVersion:Vb.version,swfVersion:c})}}return Vb},cb=function(a,b){var c,d,e,f,g;if(0===arguments.length)f=u(P);else if("string"==typeof a&&a)f=a.split(/\s+/);else if("object"==typeof a&&a&&"undefined"==typeof b)for(c in a)w.call(a,c)&&"string"==typeof c&&c&&"function"==typeof a[c]&&Vb.off(c,a[c]);if(f&&f.length)for(c=0,d=f.length;d>c;c++)if(a=f[c].toLowerCase().replace(/^on/,""),g=P[a],g&&g.length)if(b)for(e=g.indexOf(b);-1!==e;)g.splice(e,1),e=g.indexOf(b,e);else g.length=0;return Vb},db=function(a){var b;return b="string"==typeof a&&a?B(P[a])||null:B(P)},eb=function(a){var b,c,d;return a=ob(a),a&&!vb(a)?"ready"===a.type&&N.overdue===!0?Vb.emit({type:"error",name:"flash-overdue"}):(b=A({},a),tb.call(this,b),"copy"===a.type&&(d=Db(Q),c=d.data,R=d.formatMap),c):void 0},fb=function(){var a=N.sandboxed;if(Tb(),"boolean"!=typeof N.ready&&(N.ready=!1),N.sandboxed!==a&&N.sandboxed===!0)N.ready=!1,Vb.emit({type:"error",name:"flash-sandboxed"});else if(!Vb.isFlashUnusable()&&null===N.bridge){var b=Z.flashLoadTimeout;"number"==typeof b&&b>=0&&(S=i(function(){"boolean"!=typeof N.deactivated&&(N.deactivated=!0),N.deactivated===!0&&Vb.emit({type:"error",name:"flash-deactivated"})},b)),N.overdue=!1,Bb()}},gb=function(){Vb.clearData(),Vb.blur(),Vb.emit("destroy"),Cb(),Vb.off()},hb=function(a,b){var c;if("object"==typeof a&&a&&"undefined"==typeof b)c=a,Vb.clearData();else{if("string"!=typeof a||!a)return;c={},c[a]=b}for(var d in c)"string"==typeof d&&d&&w.call(c,d)&&"string"==typeof c[d]&&c[d]&&(Q[d]=c[d])},ib=function(a){"undefined"==typeof a?(E(Q),R=null):"string"==typeof a&&w.call(Q,a)&&delete Q[a]},jb=function(a){return"undefined"==typeof a?B(Q):"string"==typeof a&&w.call(Q,a)?Q[a]:void 0},kb=function(a){if(a&&1===a.nodeType){d&&(Lb(d,Z.activeClass),d!==a&&Lb(d,Z.hoverClass)),d=a,Kb(a,Z.hoverClass);var b=a.getAttribute("title")||Z.title;if("string"==typeof b&&b){var c=Ab(N.bridge);c&&c.setAttribute("title",b)}var e=Z.forceHandCursor===!0||"pointer"===Mb(a,"cursor");Rb(e),Qb()}},lb=function(){var a=Ab(N.bridge);a&&(a.removeAttribute("title"),a.style.left="0px",a.style.top="-9999px",a.style.width="1px",a.style.height="1px"),d&&(Lb(d,Z.hoverClass),Lb(d,Z.activeClass),d=null)},mb=function(){return d||null},nb=function(a){return"string"==typeof a&&a&&/^[A-Za-z][A-Za-z0-9_:\-\.]*$/.test(a)},ob=function(a){var b;if("string"==typeof a&&a?(b=a,a={}):"object"==typeof a&&a&&"string"==typeof a.type&&a.type&&(b=a.type),b){b=b.toLowerCase(),!a.target&&(/^(copy|aftercopy|_click)$/.test(b)||"error"===b&&"clipboard-error"===a.name)&&(a.target=e),A(a,{type:b,target:a.target||d||null,relatedTarget:a.relatedTarget||null,currentTarget:N&&N.bridge||null,timeStamp:a.timeStamp||t()||null});var c=U[a.type];return"error"===a.type&&a.name&&c&&(c=c[a.name]),c&&(a.message=c),"ready"===a.type&&A(a,{target:null,version:N.version}),"error"===a.type&&(X.test(a.name)&&A(a,{target:null,minimumVersion:O}),Y.test(a.name)&&A(a,{version:N.version})),"copy"===a.type&&(a.clipboardData={setData:Vb.setData,clearData:Vb.clearData}),"aftercopy"===a.type&&(a=Eb(a,R)),a.target&&!a.relatedTarget&&(a.relatedTarget=pb(a.target)),qb(a)}},pb=function(a){var b=a&&a.getAttribute&&a.getAttribute("data-clipboard-target");return b?g.getElementById(b):null},qb=function(a){if(a&&/^_(?:click|mouse(?:over|out|down|up|move))$/.test(a.type)){var c=a.target,d="_mouseover"===a.type&&a.relatedTarget?a.relatedTarget:b,e="_mouseout"===a.type&&a.relatedTarget?a.relatedTarget:b,h=Nb(c),i=f.screenLeft||f.screenX||0,j=f.screenTop||f.screenY||0,k=g.body.scrollLeft+g.documentElement.scrollLeft,l=g.body.scrollTop+g.documentElement.scrollTop,m=h.left+("number"==typeof a._stageX?a._stageX:0),n=h.top+("number"==typeof a._stageY?a._stageY:0),o=m-k,p=n-l,q=i+o,r=j+p,s="number"==typeof a.movementX?a.movementX:0,t="number"==typeof a.movementY?a.movementY:0;delete a._stageX,delete a._stageY,A(a,{srcElement:c,fromElement:d,toElement:e,screenX:q,screenY:r,pageX:m,pageY:n,clientX:o,clientY:p,x:o,y:p,movementX:s,movementY:t,offsetX:0,offsetY:0,layerX:0,layerY:0})}return a},rb=function(a){var b=a&&"string"==typeof a.type&&a.type||"";return!/^(?:(?:before)?copy|destroy)$/.test(b)},sb=function(a,b,c,d){d?i(function(){a.apply(b,c)},0):a.apply(b,c)},tb=function(a){if("object"==typeof a&&a&&a.type){var b=rb(a),c=P["*"]||[],d=P[a.type]||[],e=c.concat(d);if(e&&e.length){var g,h,i,j,k,l=this;for(g=0,h=e.length;h>g;g++)i=e[g],j=l,"string"==typeof i&&"function"==typeof f[i]&&(i=f[i]),"object"==typeof i&&i&&"function"==typeof i.handleEvent&&(j=i,i=i.handleEvent),"function"==typeof i&&(k=A({},a),sb(i,j,[k],b))}return this}},ub=function(a){var b=null;return(M===!1||a&&"error"===a.type&&a.name&&-1!==V.indexOf(a.name))&&(b=!1),b},vb=function(a){var b=a.target||d||null,f="swf"===a._source;switch(delete a._source,a.type){case"error":var g="flash-sandboxed"===a.name||ub(a);"boolean"==typeof g&&(N.sandboxed=g),-1!==W.indexOf(a.name)?A(N,{disabled:"flash-disabled"===a.name,outdated:"flash-outdated"===a.name,unavailable:"flash-unavailable"===a.name,degraded:"flash-degraded"===a.name,deactivated:"flash-deactivated"===a.name,overdue:"flash-overdue"===a.name,ready:!1}):"version-mismatch"===a.name&&(c=a.swfVersion,A(N,{disabled:!1,outdated:!1,unavailable:!1,degraded:!1,deactivated:!1,overdue:!1,ready:!1})),Pb();break;case"ready":c=a.swfVersion;var h=N.deactivated===!0;A(N,{disabled:!1,outdated:!1,sandboxed:!1,unavailable:!1,degraded:!1,deactivated:!1,overdue:h,ready:!h}),Pb();break;case"beforecopy":e=b;break;case"copy":var i,j,k=a.relatedTarget;!Q["text/html"]&&!Q["text/plain"]&&k&&(j=k.value||k.outerHTML||k.innerHTML)&&(i=k.value||k.textContent||k.innerText)?(a.clipboardData.clearData(),a.clipboardData.setData("text/plain",i),j!==i&&a.clipboardData.setData("text/html",j)):!Q["text/plain"]&&a.target&&(i=a.target.getAttribute("data-clipboard-text"))&&(a.clipboardData.clearData(),a.clipboardData.setData("text/plain",i));break;case"aftercopy":wb(a),Vb.clearData(),b&&b!==Jb()&&b.focus&&b.focus();break;case"_mouseover":Vb.focus(b),Z.bubbleEvents===!0&&f&&(b&&b!==a.relatedTarget&&!F(a.relatedTarget,b)&&xb(A({},a,{type:"mouseenter",bubbles:!1,cancelable:!1})),xb(A({},a,{type:"mouseover"})));break;case"_mouseout":Vb.blur(),Z.bubbleEvents===!0&&f&&(b&&b!==a.relatedTarget&&!F(a.relatedTarget,b)&&xb(A({},a,{type:"mouseleave",bubbles:!1,cancelable:!1})),xb(A({},a,{type:"mouseout"})));break;case"_mousedown":Kb(b,Z.activeClass),Z.bubbleEvents===!0&&f&&xb(A({},a,{type:a.type.slice(1)}));break;case"_mouseup":Lb(b,Z.activeClass),Z.bubbleEvents===!0&&f&&xb(A({},a,{type:a.type.slice(1)}));break;case"_click":e=null,Z.bubbleEvents===!0&&f&&xb(A({},a,{type:a.type.slice(1)}));break;case"_mousemove":Z.bubbleEvents===!0&&f&&xb(A({},a,{type:a.type.slice(1)}))}return!!/^_(?:click|mouse(?:over|out|down|up|move))$/.test(a.type)||void 0},wb=function(a){if(a.errors&&a.errors.length>0){var b=B(a);A(b,{type:"error",name:"clipboard-error"}),delete b.success,i(function(){Vb.emit(b)},0)}},xb=function(a){if(a&&"string"==typeof a.type&&a){var b,c=a.target||null,d=c&&c.ownerDocument||g,e={view:d.defaultView||f,canBubble:!0,cancelable:!0,detail:"click"===a.type?1:0,button:"number"==typeof a.which?a.which-1:"number"==typeof a.button?a.button:d.createEvent?0:1},h=A(e,a);c&&d.createEvent&&c.dispatchEvent&&(h=[h.type,h.canBubble,h.cancelable,h.view,h.detail,h.screenX,h.screenY,h.clientX,h.clientY,h.ctrlKey,h.altKey,h.shiftKey,h.metaKey,h.button,h.relatedTarget],b=d.createEvent("MouseEvents"),b.initMouseEvent&&(b.initMouseEvent.apply(b,h),b._source="js",c.dispatchEvent(b)))}},yb=function(){var a=Z.flashLoadTimeout;if("number"==typeof a&&a>=0){var b=Math.min(1e3,a/10),c=Z.swfObjectId+"_fallbackContent";T=k(function(){var a=g.getElementById(c);Ob(a)&&(Pb(),N.deactivated=null,Vb.emit({type:"error",name:"swf-not-found"}))},b)}},zb=function(){var a=g.createElement("div");return a.id=Z.containerId,a.className=Z.containerClass,a.style.position="absolute",a.style.left="0px",a.style.top="-9999px",a.style.width="1px",a.style.height="1px",a.style.zIndex=""+Sb(Z.zIndex),a},Ab=function(a){for(var b=a&&a.parentNode;b&&"OBJECT"===b.nodeName&&b.parentNode;)b=b.parentNode;return b||null},Bb=function(){var a,b=N.bridge,c=Ab(b);if(!b){var d=Ib(f.location.host,Z),e="never"===d?"none":"all",h=Gb(A({jsVersion:Vb.version},Z)),i=Z.swfPath+Fb(Z.swfPath,Z);c=zb();var j=g.createElement("div");c.appendChild(j),g.body.appendChild(c);var k=g.createElement("div"),l="activex"===N.pluginType;k.innerHTML='<object id="'+Z.swfObjectId+'" name="'+Z.swfObjectId+'" width="100%" height="100%" '+(l?'classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"':'type="application/x-shockwave-flash" data="'+i+'"')+">"+(l?'<param name="movie" value="'+i+'"/>':"")+'<param name="allowScriptAccess" value="'+d+'"/><param name="allowNetworking" value="'+e+'"/><param name="menu" value="false"/><param name="wmode" value="transparent"/><param name="flashvars" value="'+h+'"/><div id="'+Z.swfObjectId+'_fallbackContent">&nbsp;</div></object>',b=k.firstChild,k=null,y(b).ZeroClipboard=Vb,c.replaceChild(b,j),yb()}return b||(b=g[Z.swfObjectId],b&&(a=b.length)&&(b=b[a-1]),!b&&c&&(b=c.firstChild)),N.bridge=b||null,b},Cb=function(){var a=N.bridge;if(a){var d=Ab(a);d&&("activex"===N.pluginType&&"readyState"in a?(a.style.display="none",function e(){if(4===a.readyState){for(var b in a)"function"==typeof a[b]&&(a[b]=null);a.parentNode&&a.parentNode.removeChild(a),d.parentNode&&d.parentNode.removeChild(d)}else i(e,10)}()):(a.parentNode&&a.parentNode.removeChild(a),d.parentNode&&d.parentNode.removeChild(d))),Pb(),N.ready=null,N.bridge=null,N.deactivated=null,c=b}},Db=function(a){var b={},c={};if("object"==typeof a&&a){for(var d in a)if(d&&w.call(a,d)&&"string"==typeof a[d]&&a[d])switch(d.toLowerCase()){case"text/plain":case"text":case"air:text":case"flash:text":b.text=a[d],c.text=d;break;case"text/html":case"html":case"air:html":case"flash:html":b.html=a[d],c.html=d;break;case"application/rtf":case"text/rtf":case"rtf":case"richtext":case"air:rtf":case"flash:rtf":b.rtf=a[d],c.rtf=d}return{data:b,formatMap:c}}},Eb=function(a,b){if("object"!=typeof a||!a||"object"!=typeof b||!b)return a;var c={};for(var d in a)if(w.call(a,d))if("errors"===d){c[d]=a[d]?a[d].slice():[];for(var e=0,f=c[d].length;f>e;e++)c[d][e].format=b[c[d][e].format]}else if("success"!==d&&"data"!==d)c[d]=a[d];else{c[d]={};var g=a[d];for(var h in g)h&&w.call(g,h)&&w.call(b,h)&&(c[d][b[h]]=g[h])}return c},Fb=function(a,b){var c=null==b||b&&b.cacheBust===!0;return c?(-1===a.indexOf("?")?"?":"&")+"noCache="+t():""},Gb=function(a){var b,c,d,e,g="",h=[];if(a.trustedDomains&&("string"==typeof a.trustedDomains?e=[a.trustedDomains]:"object"==typeof a.trustedDomains&&"length"in a.trustedDomains&&(e=a.trustedDomains)),e&&e.length)for(b=0,c=e.length;c>b;b++)if(w.call(e,b)&&e[b]&&"string"==typeof e[b]){if(d=Hb(e[b]),!d)continue;if("*"===d){h.length=0,h.push(d);break}h.push.apply(h,[d,"//"+d,f.location.protocol+"//"+d])}return h.length&&(g+="trustedOrigins="+n(h.join(","))),a.forceEnhancedClipboard===!0&&(g+=(g?"&":"")+"forceEnhancedClipboard=true"),"string"==typeof a.swfObjectId&&a.swfObjectId&&(g+=(g?"&":"")+"swfObjectId="+n(a.swfObjectId)),"string"==typeof a.jsVersion&&a.jsVersion&&(g+=(g?"&":"")+"jsVersion="+n(a.jsVersion)),g},Hb=function(a){if(null==a||""===a)return null;if(a=a.replace(/^\s+|\s+$/g,""),""===a)return null;var b=a.indexOf("//");a=-1===b?a:a.slice(b+2);var c=a.indexOf("/");return a=-1===c?a:-1===b||0===c?null:a.slice(0,c),a&&".swf"===a.slice(-4).toLowerCase()?null:a||null},Ib=function(){var a=function(a){var b,c,d,e=[];if("string"==typeof a&&(a=[a]),"object"!=typeof a||!a||"number"!=typeof a.length)return e;for(b=0,c=a.length;c>b;b++)if(w.call(a,b)&&(d=Hb(a[b]))){if("*"===d){e.length=0,e.push("*");break}-1===e.indexOf(d)&&e.push(d)}return e};return function(b,c){var d=Hb(c.swfPath);null===d&&(d=b);var e=a(c.trustedDomains),f=e.length;if(f>0){if(1===f&&"*"===e[0])return"always";if(-1!==e.indexOf(b))return 1===f&&b===d?"sameDomain":"always"}return"never"}}(),Jb=function(){try{return g.activeElement}catch(a){return null}},Kb=function(a,b){var c,d,e,f=[];if("string"==typeof b&&b&&(f=b.split(/\s+/)),a&&1===a.nodeType&&f.length>0)if(a.classList)for(c=0,d=f.length;d>c;c++)a.classList.add(f[c]);else if(a.hasOwnProperty("className")){for(e=" "+a.className+" ",c=0,d=f.length;d>c;c++)-1===e.indexOf(" "+f[c]+" ")&&(e+=f[c]+" ");a.className=e.replace(/^\s+|\s+$/g,"")}return a},Lb=function(a,b){var c,d,e,f=[];if("string"==typeof b&&b&&(f=b.split(/\s+/)),a&&1===a.nodeType&&f.length>0)if(a.classList&&a.classList.length>0)for(c=0,d=f.length;d>c;c++)a.classList.remove(f[c]);else if(a.className){for(e=(" "+a.className+" ").replace(/[\r\n\t]/g," "),c=0,d=f.length;d>c;c++)e=e.replace(" "+f[c]+" "," ");a.className=e.replace(/^\s+|\s+$/g,"")}return a},Mb=function(a,b){var c=m(a,null).getPropertyValue(b);return"cursor"!==b||c&&"auto"!==c||"A"!==a.nodeName?c:"pointer"},Nb=function(a){var b={left:0,top:0,width:0,height:0};if(a.getBoundingClientRect){var c=a.getBoundingClientRect(),d=f.pageXOffset,e=f.pageYOffset,h=g.documentElement.clientLeft||0,i=g.documentElement.clientTop||0,j=0,k=0;if("relative"===Mb(g.body,"position")){var l=g.body.getBoundingClientRect(),m=g.documentElement.getBoundingClientRect();j=l.left-m.left||0,k=l.top-m.top||0}b.left=c.left+d-h-j,b.top=c.top+e-i-k,b.width="width"in c?c.width:c.right-c.left,b.height="height"in c?c.height:c.bottom-c.top}return b},Ob=function(a){if(!a)return!1;var b=m(a,null),c=r(b.height)>0,d=r(b.width)>0,e=r(b.top)>=0,f=r(b.left)>=0,g=c&&d&&e&&f,h=g?null:Nb(a),i="none"!==b.display&&"collapse"!==b.visibility&&(g||!!h&&(c||h.height>0)&&(d||h.width>0)&&(e||h.top>=0)&&(f||h.left>=0));return i},Pb=function(){j(S),S=0,l(T),T=0},Qb=function(){var a;if(d&&(a=Ab(N.bridge))){var b=Nb(d);A(a.style,{width:b.width+"px",height:b.height+"px",top:b.top+"px",left:b.left+"px",zIndex:""+Sb(Z.zIndex)})}},Rb=function(a){N.ready===!0&&(N.bridge&&"function"==typeof N.bridge.setHandCursor?N.bridge.setHandCursor(a):N.ready=!1)},Sb=function(a){if(/^(?:auto|inherit)$/.test(a))return a;var b;return"number"!=typeof a||s(a)?"string"==typeof a&&(b=Sb(q(a,10))):b=a,"number"==typeof b?b:"auto"},Tb=function(b){var c,d,e,f=N.sandboxed,g=null;if(b=b===!0,M===!1)g=!1;else{try{d=a.frameElement||null}catch(h){e={name:h.name,message:h.message}}if(d&&1===d.nodeType&&"IFRAME"===d.nodeName)try{g=d.hasAttribute("sandbox")}catch(h){g=null}else{try{c=document.domain||null}catch(h){c=null}(null===c||e&&"SecurityError"===e.name&&/(^|[\s\(\[@])sandbox(es|ed|ing|[\s\.,!\)\]@]|$)/.test(e.message.toLowerCase()))&&(g=!0)}}return N.sandboxed=g,f===g||b||Ub(o),g},Ub=function(a){function b(a){var b=a.match(/[\d]+/g);return b.length=3,b.join(".")}function c(a){return!!a&&(a=a.toLowerCase())&&(/^(pepflashplayer\.dll|libpepflashplayer\.so|pepperflashplayer\.plugin)$/.test(a)||"chrome.plugin"===a.slice(-13))}function d(a){a&&(i=!0,a.version&&(l=b(a.version)),!l&&a.description&&(l=b(a.description)),a.filename&&(k=c(a.filename)))}var e,f,g,i=!1,j=!1,k=!1,l="";if(h.plugins&&h.plugins.length)e=h.plugins["Shockwave Flash"],d(e),h.plugins["Shockwave Flash 2.0"]&&(i=!0,l="2.0.0.11");else if(h.mimeTypes&&h.mimeTypes.length)g=h.mimeTypes["application/x-shockwave-flash"],e=g&&g.enabledPlugin,d(e);else if("undefined"!=typeof a){j=!0;try{f=new a("ShockwaveFlash.ShockwaveFlash.7"),i=!0,l=b(f.GetVariable("$version"))}catch(m){try{f=new a("ShockwaveFlash.ShockwaveFlash.6"),i=!0,l="6.0.21"}catch(n){try{f=new a("ShockwaveFlash.ShockwaveFlash"),i=!0,l=b(f.GetVariable("$version"))}catch(o){j=!1}}}}N.disabled=i!==!0,N.outdated=l&&r(l)<r(O),N.version=l||"0.0.0",N.pluginType=k?"pepper":j?"activex":i?"netscape":"unknown"};Ub(o),Tb(!0);var Vb=function(){return this instanceof Vb?void("function"==typeof Vb._createClient&&Vb._createClient.apply(this,z(arguments))):new Vb};v(Vb,"version",{value:"2.2.0",writable:!1,configurable:!0,enumerable:!0}),Vb.config=function(){return $.apply(this,z(arguments))},Vb.state=function(){return _.apply(this,z(arguments))},Vb.isFlashUnusable=function(){return ab.apply(this,z(arguments))},Vb.on=function(){return bb.apply(this,z(arguments))},Vb.off=function(){return cb.apply(this,z(arguments))},Vb.handlers=function(){return db.apply(this,z(arguments))},Vb.emit=function(){return eb.apply(this,z(arguments))},Vb.create=function(){return fb.apply(this,z(arguments))},Vb.destroy=function(){return gb.apply(this,z(arguments))},Vb.setData=function(){return hb.apply(this,z(arguments))},Vb.clearData=function(){return ib.apply(this,z(arguments))},Vb.getData=function(){return jb.apply(this,z(arguments))},Vb.focus=Vb.activate=function(){return kb.apply(this,z(arguments))},Vb.blur=Vb.deactivate=function(){return lb.apply(this,z(arguments))},Vb.activeElement=function(){return mb.apply(this,z(arguments))};var Wb=0,Xb={},Yb=0,Zb={},$b={};A(Z,{autoActivate:!0});var _b=function(a){var b=this;b.id=""+Wb++,Xb[b.id]={instance:b,elements:[],handlers:{}},a&&b.clip(a),Vb.on("*",function(a){return b.emit(a)}),Vb.on("destroy",function(){b.destroy()}),Vb.create()},ac=function(a,d){var e,f,g,h={},i=Xb[this.id],j=i&&i.handlers;if(!i)throw new Error("Attempted to add new listener(s) to a destroyed ZeroClipboard client instance");if("string"==typeof a&&a)g=a.toLowerCase().split(/\s+/);else if("object"==typeof a&&a&&"undefined"==typeof d)for(e in a)w.call(a,e)&&"string"==typeof e&&e&&"function"==typeof a[e]&&this.on(e,a[e]);if(g&&g.length){for(e=0,f=g.length;f>e;e++)a=g[e].replace(/^on/,""),h[a]=!0,j[a]||(j[a]=[]),j[a].push(d);if(h.ready&&N.ready&&this.emit({type:"ready",client:this}),h.error){for(e=0,f=W.length;f>e;e++)if(N[W[e].replace(/^flash-/,"")]){this.emit({type:"error",name:W[e],client:this});break}c!==b&&Vb.version!==c&&this.emit({type:"error",name:"version-mismatch",jsVersion:Vb.version,swfVersion:c})}}return this},bc=function(a,b){var c,d,e,f,g,h=Xb[this.id],i=h&&h.handlers;if(!i)return this;if(0===arguments.length)f=u(i);else if("string"==typeof a&&a)f=a.split(/\s+/);else if("object"==typeof a&&a&&"undefined"==typeof b)for(c in a)w.call(a,c)&&"string"==typeof c&&c&&"function"==typeof a[c]&&this.off(c,a[c]);if(f&&f.length)for(c=0,d=f.length;d>c;c++)if(a=f[c].toLowerCase().replace(/^on/,""),g=i[a],g&&g.length)if(b)for(e=g.indexOf(b);-1!==e;)g.splice(e,1),e=g.indexOf(b,e);else g.length=0;return this},cc=function(a){var b=null,c=Xb[this.id]&&Xb[this.id].handlers;return c&&(b="string"==typeof a&&a?c[a]?c[a].slice(0):[]:B(c)),b},dc=function(a){if(ic.call(this,a)){"object"==typeof a&&a&&"string"==typeof a.type&&a.type&&(a=A({},a));var b=A({},ob(a),{client:this});jc.call(this,b)}return this},ec=function(a){if(!Xb[this.id])throw new Error("Attempted to clip element(s) to a destroyed ZeroClipboard client instance");a=kc(a);for(var b=0;b<a.length;b++)if(w.call(a,b)&&a[b]&&1===a[b].nodeType){a[b].zcClippingId?-1===Zb[a[b].zcClippingId].indexOf(this.id)&&Zb[a[b].zcClippingId].push(this.id):(a[b].zcClippingId="zcClippingId_"+Yb++,Zb[a[b].zcClippingId]=[this.id],Z.autoActivate===!0&&lc(a[b]));var c=Xb[this.id]&&Xb[this.id].elements;-1===c.indexOf(a[b])&&c.push(a[b])}return this},fc=function(a){var b=Xb[this.id];if(!b)return this;var c,d=b.elements;a="undefined"==typeof a?d.slice(0):kc(a);for(var e=a.length;e--;)if(w.call(a,e)&&a[e]&&1===a[e].nodeType){for(c=0;-1!==(c=d.indexOf(a[e],c));)d.splice(c,1);var f=Zb[a[e].zcClippingId];if(f){for(c=0;-1!==(c=f.indexOf(this.id,c));)f.splice(c,1);0===f.length&&(Z.autoActivate===!0&&mc(a[e]),delete a[e].zcClippingId)}}return this},gc=function(){var a=Xb[this.id];return a&&a.elements?a.elements.slice(0):[]},hc=function(){Xb[this.id]&&(this.unclip(),this.off(),delete Xb[this.id])},ic=function(a){if(!a||!a.type)return!1;if(a.client&&a.client!==this)return!1;var b=Xb[this.id],c=b&&b.elements,d=!!c&&c.length>0,e=!a.target||d&&-1!==c.indexOf(a.target),f=a.relatedTarget&&d&&-1!==c.indexOf(a.relatedTarget),g=a.client&&a.client===this;return!(!b||!(e||f||g))},jc=function(a){var b=Xb[this.id];if("object"==typeof a&&a&&a.type&&b){var c=rb(a),d=b&&b.handlers["*"]||[],e=b&&b.handlers[a.type]||[],g=d.concat(e);if(g&&g.length){var h,i,j,k,l,m=this;for(h=0,i=g.length;i>h;h++)j=g[h],k=m,"string"==typeof j&&"function"==typeof f[j]&&(j=f[j]),"object"==typeof j&&j&&"function"==typeof j.handleEvent&&(k=j,j=j.handleEvent),"function"==typeof j&&(l=A({},a),sb(j,k,[l],c))}}},kc=function(a){return"string"==typeof a&&(a=[]),"number"!=typeof a.length?[a]:a},lc=function(a){if(a&&1===a.nodeType){var b=function(a){(a||(a=f.event))&&("js"!==a._source&&(a.stopImmediatePropagation(),a.preventDefault()),delete a._source)},c=function(c){(c||(c=f.event))&&(b(c),Vb.focus(a))};a.addEventListener("mouseover",c,!1),a.addEventListener("mouseout",b,!1),a.addEventListener("mouseenter",b,!1),a.addEventListener("mouseleave",b,!1),a.addEventListener("mousemove",b,!1),$b[a.zcClippingId]={mouseover:c,mouseout:b,mouseenter:b,mouseleave:b,mousemove:b}}},mc=function(a){if(a&&1===a.nodeType){var b=$b[a.zcClippingId];if("object"==typeof b&&b){for(var c,d,e=["move","leave","enter","out","over"],f=0,g=e.length;g>f;f++)c="mouse"+e[f],d=b[c],"function"==typeof d&&a.removeEventListener(c,d,!1);delete $b[a.zcClippingId]}}};Vb._createClient=function(){_b.apply(this,z(arguments))},Vb.prototype.on=function(){return ac.apply(this,z(arguments))},Vb.prototype.off=function(){return bc.apply(this,z(arguments))},Vb.prototype.handlers=function(){return cc.apply(this,z(arguments))},Vb.prototype.emit=function(){return dc.apply(this,z(arguments))},Vb.prototype.clip=function(){return ec.apply(this,z(arguments))},Vb.prototype.unclip=function(){return fc.apply(this,z(arguments))},Vb.prototype.elements=function(){return gc.apply(this,z(arguments))},Vb.prototype.destroy=function(){return hc.apply(this,z(arguments))},Vb.prototype.setText=function(a){if(!Xb[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Vb.setData("text/plain",a),this},Vb.prototype.setHtml=function(a){if(!Xb[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Vb.setData("text/html",a),this},Vb.prototype.setRichText=function(a){if(!Xb[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Vb.setData("application/rtf",a),this},Vb.prototype.setData=function(){if(!Xb[this.id])throw new Error("Attempted to set pending clipboard data from a destroyed ZeroClipboard client instance");return Vb.setData.apply(this,z(arguments)),this},Vb.prototype.clearData=function(){if(!Xb[this.id])throw new Error("Attempted to clear pending clipboard data from a destroyed ZeroClipboard client instance");return Vb.clearData.apply(this,z(arguments)),this},Vb.prototype.getData=function(){if(!Xb[this.id])throw new Error("Attempted to get pending clipboard data from a destroyed ZeroClipboard client instance");return Vb.getData.apply(this,z(arguments))},"function"==typeof define&&define.amd?define(function(){return Vb}):"object"==typeof module&&module&&"object"==typeof module.exports&&module.exports?module.exports=Vb:a.ZeroClipboard=Vb}(function(){return this||window}()),function(window,angular,undefined){angular.module("ngClipboard",[]).provider("ngClip",function(){var self=this;return this.path="//cdnjs.cloudflare.com/ajax/libs/zeroclipboard/2.1.6/ZeroClipboard.swf",{setPath:function(newPath){self.path=newPath},setConfig:function(config){self.config=config},$get:function(){return{path:self.path,config:self.config}}}}).run(["ngClip",function(ngClip){var config={swfPath:ngClip.path,trustedDomains:["*"],allowScriptAccess:"always",forceHandCursor:!0};ZeroClipboard.config(angular.extend(config,ngClip.config||{}))}]).directive("clipCopy",["ngClip",function(ngClip){return{scope:{clipCopy:"&",clipClick:"&",clipClickFallback:"&"},restrict:"A",link:function(scope,element,attrs){if(ZeroClipboard.isFlashUnusable())return void element.bind("click",function($event){scope.$apply(scope.clipClickFallback({$event:$event,copy:scope.$eval(scope.clipCopy)}))});var client=new ZeroClipboard(element);""===attrs.clipCopy&&(scope.clipCopy=function(scope){return element[0].previousElementSibling.innerText}),client.on("ready",function(readyEvent){client.on("copy",function(event){var clipboard=event.clipboardData;clipboard.setData(attrs.clipCopyMimeType||"text/plain",scope.$eval(scope.clipCopy))}),client.on("aftercopy",function(event){angular.isDefined(attrs.clipClick)&&scope.$apply(scope.clipClick)}),scope.$on("$destroy",function(){client.destroy()})})}}}])}(window,window.angular),function(){function fixedHeader($timeout){function link($scope,$elem,$attrs,$ctrl){function tableDataLoaded(){var firstCell=elem.querySelector("tbody tr:first-child td:first-child");return firstCell&&!firstCell.style.width}function transformTable(){angular.element(elem.querySelectorAll("thead, tbody, tfoot")).css("display",""),$timeout(function(){angular.forEach(elem.querySelectorAll("tr:first-child th"),function(thElem,i){var tdElems=elem.querySelector("tbody tr:first-child td:nth-child("+(i+1)+")"),tfElems=elem.querySelector("tfoot tr:first-child td:nth-child("+(i+1)+")"),columnWidth=tdElems?tdElems.offsetWidth:thElem.offsetWidth;
tdElems&&(tdElems.style.width=columnWidth+"px"),thElem&&(thElem.style.width=columnWidth+"px"),tfElems&&(tfElems.style.width=columnWidth+"px")}),angular.element(elem.querySelectorAll("thead, tfoot")).css("display","block"),angular.element(elem.querySelectorAll("tbody")).css({display:"block",height:$attrs.tableHeight||"inherit",overflow:"auto"});var tbody=elem.querySelector("tbody"),scrollBarWidth=tbody.offsetWidth-tbody.clientWidth;if(scrollBarWidth>0){scrollBarWidth-=2;var lastColumn=elem.querySelector("tbody tr:first-child td:last-child");lastColumn.style.width=lastColumn.offsetWidth-scrollBarWidth+"px"}})}var elem=$elem[0];$scope.$watch(tableDataLoaded,function(isTableDataLoaded){isTableDataLoaded&&transformTable()})}return{restrict:"A",link:link}}angular.module("anguFixedHeaderTable",[]).directive("fixedHeader",fixedHeader),fixedHeader.$inject=["$timeout"]}(),angular.module("infinite-scroll",[]).value("THROTTLE_MILLISECONDS",null).directive("infiniteScroll",["$rootScope","$window","$interval","THROTTLE_MILLISECONDS",function(a,b,c,d){return{scope:{infiniteScroll:"&",infiniteScrollContainer:"=",infiniteScrollDistance:"=",infiniteScrollDisabled:"=",infiniteScrollUseDocumentBottom:"=",infiniteScrollListenForEvent:"@"},link:function(e,f,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;return z=angular.element(b),u=null,v=null,j=null,k=null,r=!0,y=!1,x=null,i=!1,q=function(a){return a=a[0]||a,isNaN(a.offsetHeight)?a.document.documentElement.clientHeight:a.offsetHeight},s=function(a){if(a[0].getBoundingClientRect&&!a.css("none"))return a[0].getBoundingClientRect().top+t(a)},t=function(a){return a=a[0]||a,isNaN(window.pageYOffset)?a.document.documentElement.scrollTop:a.ownerDocument.defaultView.pageYOffset},p=function(){var b,d,g,h,l;return k===z?(b=q(k)+t(k[0].document.documentElement),g=s(f)+q(f)):(b=q(k),d=0,void 0!==s(k)&&(d=s(k)),g=s(f)-d+q(f)),y&&(g=q((f[0].ownerDocument||f[0].document).documentElement)),h=g-b,l=h<=q(k)*u+1,l?(j=!0,v?e.$$phase||a.$$phase?e.infiniteScroll():e.$apply(e.infiniteScroll):void 0):(i&&c.cancel(i),j=!1)},w=function(a,b){var d,e,f;return f=null,e=0,d=function(){return e=(new Date).getTime(),c.cancel(f),f=null,a.call()},function(){var g,h;return g=(new Date).getTime(),h=b-(g-e),h<=0?(c.cancel(f),f=null,e=g,a.call()):f?void 0:f=c(d,h,1)}},null!=d&&(p=w(p,d)),e.$on("$destroy",function(){if(k.unbind("scroll",p),null!=x&&(x(),x=null),i)return c.cancel(i)}),n=function(a){return u=parseFloat(a)||0},e.$watch("infiniteScrollDistance",n),n(e.infiniteScrollDistance),m=function(a){if(v=!a,v&&j)return j=!1,p()},e.$watch("infiniteScrollDisabled",m),m(e.infiniteScrollDisabled),o=function(a){return y=a},e.$watch("infiniteScrollUseDocumentBottom",o),o(e.infiniteScrollUseDocumentBottom),h=function(a){if(null!=k&&k.unbind("scroll",p),k=a,null!=a)return k.bind("scroll",p)},h(z),e.infiniteScrollListenForEvent&&(x=a.$on(e.infiniteScrollListenForEvent,p)),l=function(a){if(null!=a&&0!==a.length){if(a.nodeType&&1===a.nodeType?a=angular.element(a):"function"==typeof a.append?a=angular.element(a[a.length-1]):"string"==typeof a&&(a=angular.element(document.querySelector(a))),null!=a)return h(a);throw new Error("invalid infinite-scroll-container attribute.")}},e.$watch("infiniteScrollContainer",l),l(e.infiniteScrollContainer||[]),null!=g.infiniteScrollParent&&h(angular.element(f.parent())),null!=g.infiniteScrollImmediateCheck&&(r=e.$eval(g.infiniteScrollImmediateCheck)),i=c(function(){return r&&p(),c.cancel(i)})}}}]),"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="infinite-scroll"),function($){"undefined"==typeof $.fn.each2&&$.extend($.fn,{each2:function(c){for(var j=$([0]),i=-1,l=this.length;++i<l&&(j.context=j[0]=this[i])&&c.call(j[0],i,j)!==!1;);return this}})}(jQuery),function($,undefined){function reinsertElement(element){var placeholder=$(document.createTextNode(""));element.before(placeholder),placeholder.before(element),placeholder.remove()}function stripDiacritics(str){function match(a){return DIACRITICS[a]||a}return str.replace(/[^\u0000-\u007E]/g,match)}function indexOf(value,array){for(var i=0,l=array.length;i<l;i+=1)if(equal(value,array[i]))return i;return-1}function measureScrollbar(){var $template=$(MEASURE_SCROLLBAR_TEMPLATE);$template.appendTo("body");var dim={width:$template.width()-$template[0].clientWidth,height:$template.height()-$template[0].clientHeight};return $template.remove(),dim}function equal(a,b){return a===b||a!==undefined&&b!==undefined&&(null!==a&&null!==b&&(a.constructor===String?a+""==b+"":b.constructor===String&&b+""==a+""))}function splitVal(string,separator){var val,i,l;if(null===string||string.length<1)return[];for(val=string.split(separator),i=0,l=val.length;i<l;i+=1)val[i]=$.trim(val[i]);return val}function getSideBorderPadding(element){return element.outerWidth(!1)-element.width()}function installKeyUpChangeEvent(element){var key="keyup-change-value";element.on("keydown",function(){$.data(element,key)===undefined&&$.data(element,key,element.val())}),element.on("keyup",function(){var val=$.data(element,key);val!==undefined&&element.val()!==val&&($.removeData(element,key),element.trigger("keyup-change"))})}function installFilteredMouseMove(element){element.on("mousemove",function(e){var lastpos=lastMousePosition;lastpos!==undefined&&lastpos.x===e.pageX&&lastpos.y===e.pageY||$(e.target).trigger("mousemove-filtered",e)})}function debounce(quietMillis,fn,ctx){ctx=ctx||undefined;var timeout;return function(){var args=arguments;window.clearTimeout(timeout),timeout=window.setTimeout(function(){fn.apply(ctx,args)},quietMillis)}}function installDebouncedScroll(threshold,element){var notify=debounce(threshold,function(e){element.trigger("scroll-debounced",e)});element.on("scroll",function(e){indexOf(e.target,element.get())>=0&&notify(e)})}function focus($el){$el[0]!==document.activeElement&&window.setTimeout(function(){var range,el=$el[0],pos=$el.val().length;$el.focus();var isVisible=el.offsetWidth>0||el.offsetHeight>0;isVisible&&el===document.activeElement&&(el.setSelectionRange?el.setSelectionRange(pos,pos):el.createTextRange&&(range=el.createTextRange(),range.collapse(!1),range.select()))},0)}function getCursorInfo(el){el=$(el)[0];var offset=0,length=0;if("selectionStart"in el)offset=el.selectionStart,length=el.selectionEnd-offset;else if("selection"in document){el.focus();var sel=document.selection.createRange();length=document.selection.createRange().text.length,sel.moveStart("character",-el.value.length),offset=sel.text.length-length}return{offset:offset,length:length}}function killEvent(event){event.preventDefault(),event.stopPropagation()}function killEventImmediately(event){event.preventDefault(),event.stopImmediatePropagation()}function measureTextWidth(e){if(!sizer){var style=e[0].currentStyle||window.getComputedStyle(e[0],null);sizer=$(document.createElement("div")).css({position:"absolute",left:"-10000px",top:"-10000px",display:"none",fontSize:style.fontSize,fontFamily:style.fontFamily,fontStyle:style.fontStyle,fontWeight:style.fontWeight,letterSpacing:style.letterSpacing,textTransform:style.textTransform,whiteSpace:"nowrap"}),sizer.attr("class","select2-sizer"),$("body").append(sizer)}return sizer.text(e.val()),sizer.width()}function syncCssClasses(dest,src,adapter){var classes,adapted,replacements=[];classes=dest.attr("class"),classes&&(classes=""+classes,$(classes.split(" ")).each2(function(){0===this.indexOf("select2-")&&replacements.push(this)})),classes=src.attr("class"),classes&&(classes=""+classes,$(classes.split(" ")).each2(function(){0!==this.indexOf("select2-")&&(adapted=adapter(this),adapted&&replacements.push(adapted))})),dest.attr("class",replacements.join(" "))}function markMatch(text,term,markup,escapeMarkup){var match=stripDiacritics(text.toUpperCase()).indexOf(stripDiacritics(term.toUpperCase())),tl=term.length;return match<0?void markup.push(escapeMarkup(text)):(markup.push(escapeMarkup(text.substring(0,match))),markup.push("<span class='select2-match'>"),markup.push(escapeMarkup(text.substring(match,match+tl))),markup.push("</span>"),void markup.push(escapeMarkup(text.substring(match+tl,text.length))))}function defaultEscapeMarkup(markup){var replace_map={"\\":"&#92;","&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#47;"};return String(markup).replace(/[&<>"'\/\\]/g,function(match){return replace_map[match]})}function ajax(options){var timeout,handler=null,quietMillis=options.quietMillis||100,ajaxUrl=options.url,self=this;return function(query){window.clearTimeout(timeout),timeout=window.setTimeout(function(){var data=options.data,url=ajaxUrl,transport=options.transport||$.fn.select2.ajaxDefaults.transport,deprecated={type:options.type||"GET",cache:options.cache||!1,jsonpCallback:options.jsonpCallback||undefined,dataType:options.dataType||"json"},params=$.extend({},$.fn.select2.ajaxDefaults.params,deprecated);data=data?data.call(self,query.term,query.page,query.context):null,url="function"==typeof url?url.call(self,query.term,query.page,query.context):url,handler&&"function"==typeof handler.abort&&handler.abort(),options.params&&($.isFunction(options.params)?$.extend(params,options.params.call(self)):$.extend(params,options.params)),$.extend(params,{url:url,dataType:options.dataType,data:data,success:function(data){var results=options.results(data,query.page);query.callback(results)}}),handler=transport.call(self,params)},quietMillis)}}function local(options){var dataText,tmp,data=options,text=function(item){return""+item.text};$.isArray(data)&&(tmp=data,data={results:tmp}),$.isFunction(data)===!1&&(tmp=data,data=function(){return tmp});var dataItem=data();return dataItem.text&&(text=dataItem.text,$.isFunction(text)||(dataText=dataItem.text,text=function(item){return item[dataText]})),function(query){var process,t=query.term,filtered={results:[]};return""===t?void query.callback(data()):(process=function(datum,collection){var group,attr;if(datum=datum[0],datum.children){group={};for(attr in datum)datum.hasOwnProperty(attr)&&(group[attr]=datum[attr]);group.children=[],$(datum.children).each2(function(i,childDatum){process(childDatum,group.children)}),(group.children.length||query.matcher(t,text(group),datum))&&collection.push(group)}else query.matcher(t,text(datum),datum)&&collection.push(datum)},$(data().results).each2(function(i,datum){process(datum,filtered.results)}),void query.callback(filtered))}}function tags(data){var isFunc=$.isFunction(data);return function(query){var t=query.term,filtered={results:[]},result=isFunc?data(query):data;$.isArray(result)&&($(result).each(function(){var isObject=this.text!==undefined,text=isObject?this.text:this;(""===t||query.matcher(t,text))&&filtered.results.push(isObject?this:{id:this,text:this})}),query.callback(filtered))}}function checkFormatter(formatter,formatterName){if($.isFunction(formatter))return!0;if(!formatter)return!1;if("string"==typeof formatter)return!0;throw new Error(formatterName+" must be a string, function, or falsy value")}function evaluate(val){if($.isFunction(val)){var args=Array.prototype.slice.call(arguments,1);return val.apply(null,args)}return val}function countResults(results){var count=0;return $.each(results,function(i,item){item.children?count+=countResults(item.children):count++}),count}function defaultTokenizer(input,selection,selectCallback,opts){var token,index,i,l,separator,original=input,dupe=!1;if(!opts.createSearchChoice||!opts.tokenSeparators||opts.tokenSeparators.length<1)return undefined;for(;;){for(index=-1,i=0,l=opts.tokenSeparators.length;i<l&&(separator=opts.tokenSeparators[i],index=input.indexOf(separator),!(index>=0));i++);if(index<0)break;if(token=input.substring(0,index),input=input.substring(index+separator.length),token.length>0&&(token=opts.createSearchChoice.call(this,token,selection),token!==undefined&&null!==token&&opts.id(token)!==undefined&&null!==opts.id(token))){for(dupe=!1,i=0,l=selection.length;i<l;i++)if(equal(opts.id(token),opts.id(selection[i]))){dupe=!0;break}dupe||selectCallback(token)}}return original!==input?input:void 0}function cleanupJQueryElements(){var self=this;Array.prototype.forEach.call(arguments,function(element){self[element].remove(),self[element]=null})}function clazz(SuperClass,methods){var constructor=function(){};return constructor.prototype=new SuperClass,constructor.prototype.constructor=constructor,constructor.prototype.parent=SuperClass.prototype,constructor.prototype=$.extend(constructor.prototype,methods),constructor}if(window.Select2===undefined){var KEY,AbstractSelect2,SingleSelect2,MultiSelect2,nextUid,sizer,$document,scrollBarDimensions,lastMousePosition={x:0,y:0},KEY={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,isArrow:function(k){switch(k=k.which?k.which:k){case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:return!0}return!1},isControl:function(e){var k=e.which;switch(k){case KEY.SHIFT:case KEY.CTRL:case KEY.ALT:return!0}return!!e.metaKey},isFunctionKey:function(k){return k=k.which?k.which:k,k>=112&&k<=123}},MEASURE_SCROLLBAR_TEMPLATE="<div class='select2-measure-scrollbar'></div>",DIACRITICS={"":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"AA","":"AE","":"AE","":"AE","":"AO","":"AU","":"AV","":"AV","":"AY","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"DZ","":"DZ","":"Dz","":"Dz","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"F","":"F","":"F","":"F","":"F","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"I","":"J","":"J","":"J","":"J","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"LJ","":"Lj","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"NJ","":"Nj","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"OI","":"OO","":"OU","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"Q","":"Q","":"Q","":"Q","":"Q","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"TZ","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"VY","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"X","":"X","":"X","":"X","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"aa","":"ae","":"ae","":"ae","":"ao","":"au","":"av","":"av","":"ay","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"dz","":"dz","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"f","":"f","":"f","":"f","":"f","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"hv","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"j","":"j","":"j","":"j","":"j","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"lj","":"m","":"m","":"m","":"m","":"m","":"m","":"m","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"nj","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oi","":"ou","":"oo","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"q","":"q","":"q","":"q","":"q","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"tz","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"vy","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"x","":"x","":"x","":"x","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z"};$document=$(document),nextUid=function(){var counter=1;return function(){return counter++}}(),$document.on("mousemove",function(e){lastMousePosition.x=e.pageX,lastMousePosition.y=e.pageY}),AbstractSelect2=clazz(Object,{bind:function(func){var self=this;return function(){func.apply(self,arguments)}},init:function(opts){var results,search,resultsSelector=".select2-results";this.opts=opts=this.prepareOpts(opts),this.id=opts.id,opts.element.data("select2")!==undefined&&null!==opts.element.data("select2")&&opts.element.data("select2").destroy(),this.container=this.createContainer(),this.liveRegion=$("<span>",{role:"status","aria-live":"polite"}).addClass("select2-hidden-accessible").appendTo(document.body),this.containerId="s2id_"+(opts.element.attr("id")||"autogen"+nextUid()),this.containerEventName=this.containerId.replace(/([.])/g,"_").replace(/([;&,\-\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1"),this.container.attr("id",this.containerId),this.container.attr("title",opts.element.attr("title")),this.body=$("body"),syncCssClasses(this.container,this.opts.element,this.opts.adaptContainerCssClass),this.container.attr("style",opts.element.attr("style")),this.container.css(evaluate(opts.containerCss)),this.container.addClass(evaluate(opts.containerCssClass)),this.elementTabIndex=this.opts.element.attr("tabindex"),this.opts.element.data("select2",this).attr("tabindex","-1").before(this.container).on("click.select2",killEvent),this.container.data("select2",this),this.dropdown=this.container.find(".select2-drop"),syncCssClasses(this.dropdown,this.opts.element,this.opts.adaptDropdownCssClass),this.dropdown.addClass(evaluate(opts.dropdownCssClass)),this.dropdown.data("select2",this),this.dropdown.on("click",killEvent),this.results=results=this.container.find(resultsSelector),this.search=search=this.container.find("input.select2-input"),this.queryCount=0,this.resultsPage=0,this.context=null,this.initContainer(),this.container.on("click",killEvent),installFilteredMouseMove(this.results),this.dropdown.on("mousemove-filtered",resultsSelector,this.bind(this.highlightUnderEvent)),this.dropdown.on("touchstart touchmove touchend",resultsSelector,this.bind(function(event){this._touchEvent=!0,this.highlightUnderEvent(event)})),this.dropdown.on("touchmove",resultsSelector,this.bind(this.touchMoved)),this.dropdown.on("touchstart touchend",resultsSelector,this.bind(this.clearTouchMoved)),this.dropdown.on("click",this.bind(function(event){this._touchEvent&&(this._touchEvent=!1,this.selectHighlighted())})),installDebouncedScroll(80,this.results),this.dropdown.on("scroll-debounced",resultsSelector,this.bind(this.loadMoreIfNeeded)),$(this.container).on("change",".select2-input",function(e){e.stopPropagation()}),$(this.dropdown).on("change",".select2-input",function(e){e.stopPropagation()}),$.fn.mousewheel&&results.mousewheel(function(e,delta,deltaX,deltaY){var top=results.scrollTop();deltaY>0&&top-deltaY<=0?(results.scrollTop(0),killEvent(e)):deltaY<0&&results.get(0).scrollHeight-results.scrollTop()+deltaY<=results.height()&&(results.scrollTop(results.get(0).scrollHeight-results.height()),killEvent(e))}),installKeyUpChangeEvent(search),search.on("keyup-change input paste",this.bind(this.updateResults)),search.on("focus",function(){search.addClass("select2-focused")}),search.on("blur",function(){search.removeClass("select2-focused")}),this.dropdown.on("mouseup",resultsSelector,this.bind(function(e){$(e.target).closest(".select2-result-selectable").length>0&&(this.highlightUnderEvent(e),this.selectHighlighted(e))})),this.dropdown.on("click mouseup mousedown touchstart touchend focusin",function(e){e.stopPropagation()}),this.nextSearchTerm=undefined,$.isFunction(this.opts.initSelection)&&(this.initSelection(),this.monitorSource()),null!==opts.maximumInputLength&&this.search.attr("maxlength",opts.maximumInputLength);var disabled=opts.element.prop("disabled");disabled===undefined&&(disabled=!1),this.enable(!disabled);var readonly=opts.element.prop("readonly");readonly===undefined&&(readonly=!1),this.readonly(readonly),scrollBarDimensions=scrollBarDimensions||measureScrollbar(),this.autofocus=opts.element.prop("autofocus"),opts.element.prop("autofocus",!1),this.autofocus&&this.focus(),this.search.attr("placeholder",opts.searchInputPlaceholder)},destroy:function(){var element=this.opts.element,select2=element.data("select2");this.close(),this.propertyObserver&&(this.propertyObserver.disconnect(),this.propertyObserver=null),select2!==undefined&&(select2.container.remove(),select2.liveRegion.remove(),select2.dropdown.remove(),element.removeClass("select2-offscreen").removeData("select2").off(".select2").prop("autofocus",this.autofocus||!1),this.elementTabIndex?element.attr({tabindex:this.elementTabIndex}):element.removeAttr("tabindex"),element.show()),cleanupJQueryElements.call(this,"container","liveRegion","dropdown","results","search")},optionToData:function(element){return element.is("option")?{id:element.prop("value"),text:element.text(),element:element.get(),css:element.attr("class"),disabled:element.prop("disabled"),locked:equal(element.attr("locked"),"locked")||equal(element.data("locked"),!0)}:element.is("optgroup")?{text:element.attr("label"),children:[],element:element.get(),css:element.attr("class")}:void 0},prepareOpts:function(opts){var element,select,idKey,ajaxUrl,self=this;if(element=opts.element,"select"===element.get(0).tagName.toLowerCase()&&(this.select=select=opts.element),select&&$.each(["id","multiple","ajax","query","createSearchChoice","initSelection","data","tags"],function(){if(this in opts)throw new Error("Option '"+this+"' is not allowed for Select2 when attached to a <select> element.")}),opts=$.extend({},{populateResults:function(container,results,query){var populate,id=this.opts.id,liveRegion=this.liveRegion;(populate=function(results,container,depth){var i,l,result,selectable,disabled,compound,node,label,innerContainer,formatted;for(results=opts.sortResults(results,container,query),i=0,l=results.length;i<l;i+=1)result=results[i],disabled=result.disabled===!0,selectable=!disabled&&id(result)!==undefined,compound=result.children&&result.children.length>0,node=$("<li></li>"),node.addClass("select2-results-dept-"+depth),node.addClass("select2-result"),node.addClass(selectable?"select2-result-selectable":"select2-result-unselectable"),disabled&&node.addClass("select2-disabled"),compound&&node.addClass("select2-result-with-children"),node.addClass(self.opts.formatResultCssClass(result)),node.attr("role","presentation"),label=$(document.createElement("div")),label.addClass("select2-result-label"),label.attr("id","select2-result-label-"+nextUid()),label.attr("role","option"),formatted=opts.formatResult(result,label,query,self.opts.escapeMarkup),formatted!==undefined&&(label.html(formatted),node.append(label)),compound&&(innerContainer=$("<ul></ul>"),innerContainer.addClass("select2-result-sub"),populate(result.children,innerContainer,depth+1),node.append(innerContainer)),node.data("select2-data",result),container.append(node);liveRegion.text(opts.formatMatches(results.length))})(results,container,0)}},$.fn.select2.defaults,opts),"function"!=typeof opts.id&&(idKey=opts.id,opts.id=function(e){return e[idKey]}),$.isArray(opts.element.data("select2Tags"))){if("tags"in opts)throw"tags specified as both an attribute 'data-select2-tags' and in options of Select2 "+opts.element.attr("id");opts.tags=opts.element.data("select2Tags")}if(select?(opts.query=this.bind(function(query){var children,placeholderOption,process,data={results:[],more:!1},term=query.term;process=function(element,collection){var group;element.is("option")?query.matcher(term,element.text(),element)&&collection.push(self.optionToData(element)):element.is("optgroup")&&(group=self.optionToData(element),element.children().each2(function(i,elm){process(elm,group.children)}),group.children.length>0&&collection.push(group))},children=element.children(),this.getPlaceholder()!==undefined&&children.length>0&&(placeholderOption=this.getPlaceholderOption(),placeholderOption&&(children=children.not(placeholderOption))),children.each2(function(i,elm){process(elm,data.results)}),query.callback(data)}),opts.id=function(e){return e.id}):"query"in opts||("ajax"in opts?(ajaxUrl=opts.element.data("ajax-url"),ajaxUrl&&ajaxUrl.length>0&&(opts.ajax.url=ajaxUrl),opts.query=ajax.call(opts.element,opts.ajax)):"data"in opts?opts.query=local(opts.data):"tags"in opts&&(opts.query=tags(opts.tags),opts.createSearchChoice===undefined&&(opts.createSearchChoice=function(term){return{id:$.trim(term),text:$.trim(term)}}),opts.initSelection===undefined&&(opts.initSelection=function(element,callback){var data=[];$(splitVal(element.val(),opts.separator)).each(function(){var obj={id:this,text:this},tags=opts.tags;$.isFunction(tags)&&(tags=tags()),$(tags).each(function(){if(equal(this.id,obj.id))return obj=this,!1}),data.push(obj)}),callback(data)}))),"function"!=typeof opts.query)throw"query function not defined for Select2 "+opts.element.attr("id");if("top"===opts.createSearchChoicePosition)opts.createSearchChoicePosition=function(list,item){list.unshift(item)};else if("bottom"===opts.createSearchChoicePosition)opts.createSearchChoicePosition=function(list,item){list.push(item)};else if("function"!=typeof opts.createSearchChoicePosition)throw"invalid createSearchChoicePosition option must be 'top', 'bottom' or a custom function";return opts},monitorSource:function(){var sync,observer,el=this.opts.element;el.on("change.select2",this.bind(function(e){this.opts.element.data("select2-change-triggered")!==!0&&this.initSelection()})),sync=this.bind(function(){var disabled=el.prop("disabled");disabled===undefined&&(disabled=!1),this.enable(!disabled);var readonly=el.prop("readonly");readonly===undefined&&(readonly=!1),this.readonly(readonly),syncCssClasses(this.container,this.opts.element,this.opts.adaptContainerCssClass),this.container.addClass(evaluate(this.opts.containerCssClass)),syncCssClasses(this.dropdown,this.opts.element,this.opts.adaptDropdownCssClass),this.dropdown.addClass(evaluate(this.opts.dropdownCssClass))}),el.length&&el[0].attachEvent&&el.each(function(){this.attachEvent("onpropertychange",sync)}),observer=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver,observer!==undefined&&(this.propertyObserver&&(delete this.propertyObserver,this.propertyObserver=null),this.propertyObserver=new observer(function(mutations){mutations.forEach(sync)}),this.propertyObserver.observe(el.get(0),{attributes:!0,subtree:!1}))},triggerSelect:function(data){var evt=$.Event("select2-selecting",{val:this.id(data),object:data});return this.opts.element.trigger(evt),!evt.isDefaultPrevented()},triggerChange:function(details){details=details||{},details=$.extend({},details,{type:"change",val:this.val()}),this.opts.element.data("select2-change-triggered",!0),this.opts.element.trigger(details),this.opts.element.data("select2-change-triggered",!1),this.opts.element.click(),this.opts.blurOnChange&&this.opts.element.blur()},isInterfaceEnabled:function(){return this.enabledInterface===!0},enableInterface:function(){var enabled=this._enabled&&!this._readonly,disabled=!enabled;return enabled!==this.enabledInterface&&(this.container.toggleClass("select2-container-disabled",disabled),this.close(),this.enabledInterface=enabled,!0)},enable:function(enabled){enabled===undefined&&(enabled=!0),this._enabled!==enabled&&(this._enabled=enabled,this.opts.element.prop("disabled",!enabled),this.enableInterface())},disable:function(){this.enable(!1)},readonly:function(enabled){enabled===undefined&&(enabled=!1),this._readonly!==enabled&&(this._readonly=enabled,this.opts.element.prop("readonly",enabled),this.enableInterface())},opened:function(){return this.container.hasClass("select2-dropdown-open")},positionDropdown:function(){var bodyOffset,above,changeDirection,css,resultsListNode,$dropdown=this.dropdown,offset=this.container.offset(),height=this.container.outerHeight(!1),width=this.container.outerWidth(!1),dropHeight=$dropdown.outerHeight(!1),$window=$(window),windowWidth=$window.width(),windowHeight=$window.height(),viewPortRight=$window.scrollLeft()+windowWidth,viewportBottom=$window.scrollTop()+windowHeight,dropTop=offset.top+height,dropLeft=offset.left,enoughRoomBelow=dropTop+dropHeight<=viewportBottom,enoughRoomAbove=offset.top-dropHeight>=$window.scrollTop(),dropWidth=$dropdown.outerWidth(!1),enoughRoomOnRight=dropLeft+dropWidth<=viewPortRight,aboveNow=$dropdown.hasClass("select2-drop-above");
aboveNow?(above=!0,!enoughRoomAbove&&enoughRoomBelow&&(changeDirection=!0,above=!1)):(above=!1,!enoughRoomBelow&&enoughRoomAbove&&(changeDirection=!0,above=!0)),changeDirection&&($dropdown.hide(),offset=this.container.offset(),height=this.container.outerHeight(!1),width=this.container.outerWidth(!1),dropHeight=$dropdown.outerHeight(!1),viewPortRight=$window.scrollLeft()+windowWidth,viewportBottom=$window.scrollTop()+windowHeight,dropTop=offset.top+height,dropLeft=offset.left,dropWidth=$dropdown.outerWidth(!1),enoughRoomOnRight=dropLeft+dropWidth<=viewPortRight,$dropdown.show(),this.focusSearch()),this.opts.dropdownAutoWidth?(resultsListNode=$(".select2-results",$dropdown)[0],$dropdown.addClass("select2-drop-auto-width"),$dropdown.css("width",""),dropWidth=$dropdown.outerWidth(!1)+(resultsListNode.scrollHeight===resultsListNode.clientHeight?0:scrollBarDimensions.width),dropWidth>width?width=dropWidth:dropWidth=width,dropHeight=$dropdown.outerHeight(!1),enoughRoomOnRight=dropLeft+dropWidth<=viewPortRight):this.container.removeClass("select2-drop-auto-width"),"static"!==this.body.css("position")&&(bodyOffset=this.body.offset(),dropTop-=bodyOffset.top,dropLeft-=bodyOffset.left),enoughRoomOnRight||(dropLeft=offset.left+this.container.outerWidth(!1)-dropWidth),css={left:dropLeft,width:width},above?(css.top=offset.top-dropHeight,css.bottom="auto",this.container.addClass("select2-drop-above"),$dropdown.addClass("select2-drop-above")):(css.top=dropTop,css.bottom="auto",this.container.removeClass("select2-drop-above"),$dropdown.removeClass("select2-drop-above")),css=$.extend(css,evaluate(this.opts.dropdownCss)),$dropdown.css(css)},shouldOpen:function(){var event;return!this.opened()&&(this._enabled!==!1&&this._readonly!==!0&&(event=$.Event("select2-opening"),this.opts.element.trigger(event),!event.isDefaultPrevented()))},clearDropdownAlignmentPreference:function(){this.container.removeClass("select2-drop-above"),this.dropdown.removeClass("select2-drop-above")},open:function(){return!!this.shouldOpen()&&(this.opening(),!0)},opening:function(){var mask,cid=this.containerEventName,scroll="scroll."+cid,resize="resize."+cid,orient="orientationchange."+cid;this.container.addClass("select2-dropdown-open").addClass("select2-container-active"),this.clearDropdownAlignmentPreference(),this.dropdown[0]!==this.body.children().last()[0]&&this.dropdown.detach().appendTo(this.body),mask=$("#select2-drop-mask"),0==mask.length&&(mask=$(document.createElement("div")),mask.attr("id","select2-drop-mask").attr("class","select2-drop-mask"),mask.hide(),mask.appendTo(this.body),mask.on("mousedown touchstart click",function(e){reinsertElement(mask);var self,dropdown=$("#select2-drop");dropdown.length>0&&(self=dropdown.data("select2"),self.opts.selectOnBlur&&self.selectHighlighted({noFocus:!0}),self.close(),e.preventDefault(),e.stopPropagation())})),this.dropdown.prev()[0]!==mask[0]&&this.dropdown.before(mask),$("#select2-drop").removeAttr("id"),this.dropdown.attr("id","select2-drop"),mask.show(),this.positionDropdown(),this.dropdown.show(),this.positionDropdown(),this.dropdown.addClass("select2-drop-active");var that=this;this.container.parents().add(window).each(function(){$(this).on(resize+" "+scroll+" "+orient,function(e){that.opened()&&that.positionDropdown()})})},close:function(){if(this.opened()){var cid=this.containerEventName,scroll="scroll."+cid,resize="resize."+cid,orient="orientationchange."+cid;this.container.parents().add(window).each(function(){$(this).off(scroll).off(resize).off(orient)}),this.clearDropdownAlignmentPreference(),$("#select2-drop-mask").hide(),this.dropdown.removeAttr("id"),this.dropdown.hide(),this.container.removeClass("select2-dropdown-open").removeClass("select2-container-active"),this.results.empty(),this.clearSearch(),this.search.removeClass("select2-active"),this.opts.element.trigger($.Event("select2-close"))}},externalSearch:function(term){this.open(),this.search.val(term),this.updateResults(!1)},clearSearch:function(){},getMaximumSelectionSize:function(){return evaluate(this.opts.maximumSelectionSize)},ensureHighlightVisible:function(){var children,index,child,hb,rb,y,more,results=this.results;if(index=this.highlight(),!(index<0)){if(0==index)return void results.scrollTop(0);children=this.findHighlightableChoices().find(".select2-result-label"),child=$(children[index]),hb=child.offset().top+child.outerHeight(!0),index===children.length-1&&(more=results.find("li.select2-more-results"),more.length>0&&(hb=more.offset().top+more.outerHeight(!0))),rb=results.offset().top+results.outerHeight(!0),hb>rb&&results.scrollTop(results.scrollTop()+(hb-rb)),y=child.offset().top-results.offset().top,y<0&&"none"!=child.css("display")&&results.scrollTop(results.scrollTop()+y)}},findHighlightableChoices:function(){return this.results.find(".select2-result-selectable:not(.select2-disabled):not(.select2-selected)")},moveHighlight:function(delta){for(var choices=this.findHighlightableChoices(),index=this.highlight();index>-1&&index<choices.length;){index+=delta;var choice=$(choices[index]);if(choice.hasClass("select2-result-selectable")&&!choice.hasClass("select2-disabled")&&!choice.hasClass("select2-selected")){this.highlight(index);break}}},highlight:function(index){var choice,data,choices=this.findHighlightableChoices();return 0===arguments.length?indexOf(choices.filter(".select2-highlighted")[0],choices.get()):(index>=choices.length&&(index=choices.length-1),index<0&&(index=0),this.removeHighlight(),choice=$(choices[index]),choice.addClass("select2-highlighted"),this.search.attr("aria-activedescendant",choice.find(".select2-result-label").attr("id")),this.ensureHighlightVisible(),this.liveRegion.text(choice.text()),data=choice.data("select2-data"),void(data&&this.opts.element.trigger({type:"select2-highlight",val:this.id(data),choice:data})))},removeHighlight:function(){this.results.find(".select2-highlighted").removeClass("select2-highlighted")},touchMoved:function(){this._touchMoved=!0},clearTouchMoved:function(){this._touchMoved=!1},countSelectableResults:function(){return this.findHighlightableChoices().length},highlightUnderEvent:function(event){var el=$(event.target).closest(".select2-result-selectable");if(el.length>0&&!el.is(".select2-highlighted")){var choices=this.findHighlightableChoices();this.highlight(choices.index(el))}else 0==el.length&&this.removeHighlight()},loadMoreIfNeeded:function(){var below,results=this.results,more=results.find("li.select2-more-results"),page=this.resultsPage+1,self=this,term=this.search.val(),context=this.context;0!==more.length&&(below=more.offset().top-results.offset().top-results.height(),below<=this.opts.loadMorePadding&&(more.addClass("select2-active"),this.opts.query({element:this.opts.element,term:term,page:page,context:context,matcher:this.opts.matcher,callback:this.bind(function(data){self.opened()&&(self.opts.populateResults.call(this,results,data.results,{term:term,page:page,context:context}),self.postprocessResults(data,!1,!1),data.more===!0?(more.detach().appendTo(results).text(evaluate(self.opts.formatLoadMore,page+1)),window.setTimeout(function(){self.loadMoreIfNeeded()},10)):more.remove(),self.positionDropdown(),self.resultsPage=page,self.context=data.context,this.opts.element.trigger({type:"select2-loaded",items:data}))})})))},tokenize:function(){},updateResults:function(initial){function postRender(){search.removeClass("select2-active"),self.positionDropdown(),results.find(".select2-no-results,.select2-selection-limit,.select2-searching").length?self.liveRegion.text(results.text()):self.liveRegion.text(self.opts.formatMatches(results.find(".select2-result-selectable").length))}function render(html){results.html(html),postRender()}var data,input,queryNumber,search=this.search,results=this.results,opts=this.opts,self=this,term=search.val(),lastTerm=$.data(this.container,"select2-last-term");if((initial===!0||!lastTerm||!equal(term,lastTerm))&&($.data(this.container,"select2-last-term",term),initial===!0||this.showSearchInput!==!1&&this.opened())){queryNumber=++this.queryCount;var maxSelSize=this.getMaximumSelectionSize();if(maxSelSize>=1&&(data=this.data(),$.isArray(data)&&data.length>=maxSelSize&&checkFormatter(opts.formatSelectionTooBig,"formatSelectionTooBig")))return void render("<li class='select2-selection-limit'>"+evaluate(opts.formatSelectionTooBig,maxSelSize)+"</li>");if(search.val().length<opts.minimumInputLength)return render(checkFormatter(opts.formatInputTooShort,"formatInputTooShort")?"<li class='select2-no-results'>"+evaluate(opts.formatInputTooShort,search.val(),opts.minimumInputLength)+"</li>":""),void(initial&&this.showSearch&&this.showSearch(!0));if(opts.maximumInputLength&&search.val().length>opts.maximumInputLength)return void render(checkFormatter(opts.formatInputTooLong,"formatInputTooLong")?"<li class='select2-no-results'>"+evaluate(opts.formatInputTooLong,search.val(),opts.maximumInputLength)+"</li>":"");opts.formatSearching&&0===this.findHighlightableChoices().length&&render("<li class='select2-searching'>"+evaluate(opts.formatSearching)+"</li>"),search.addClass("select2-active"),this.removeHighlight(),input=this.tokenize(),input!=undefined&&null!=input&&search.val(input),this.resultsPage=1,opts.query({element:opts.element,term:search.val(),page:this.resultsPage,context:null,matcher:opts.matcher,callback:this.bind(function(data){var def;if(queryNumber==this.queryCount){if(!this.opened())return void this.search.removeClass("select2-active");if(this.context=data.context===undefined?null:data.context,this.opts.createSearchChoice&&""!==search.val()&&(def=this.opts.createSearchChoice.call(self,search.val(),data.results),def!==undefined&&null!==def&&self.id(def)!==undefined&&null!==self.id(def)&&0===$(data.results).filter(function(){return equal(self.id(this),self.id(def))}).length&&this.opts.createSearchChoicePosition(data.results,def)),0===data.results.length&&checkFormatter(opts.formatNoMatches,"formatNoMatches"))return void render("<li class='select2-no-results'>"+evaluate(opts.formatNoMatches,search.val())+"</li>");results.empty(),self.opts.populateResults.call(this,results,data.results,{term:search.val(),page:this.resultsPage,context:null}),data.more===!0&&checkFormatter(opts.formatLoadMore,"formatLoadMore")&&(results.append("<li class='select2-more-results'>"+self.opts.escapeMarkup(evaluate(opts.formatLoadMore,this.resultsPage))+"</li>"),window.setTimeout(function(){self.loadMoreIfNeeded()},10)),this.postprocessResults(data,initial),postRender(),this.opts.element.trigger({type:"select2-loaded",items:data})}})})}},cancel:function(){this.close()},blur:function(){this.opts.selectOnBlur&&this.selectHighlighted({noFocus:!0}),this.close(),this.container.removeClass("select2-container-active"),this.search[0]===document.activeElement&&this.search.blur(),this.clearSearch(),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus")},focusSearch:function(){focus(this.search)},selectHighlighted:function(options){if(this._touchMoved)return void this.clearTouchMoved();var index=this.highlight(),highlighted=this.results.find(".select2-highlighted"),data=highlighted.closest(".select2-result").data("select2-data");data?(this.highlight(index),this.onSelect(data,options)):options&&options.noFocus&&this.close()},getPlaceholder:function(){var placeholderOption;return this.opts.element.attr("placeholder")||this.opts.element.attr("data-placeholder")||this.opts.element.data("placeholder")||this.opts.placeholder||((placeholderOption=this.getPlaceholderOption())!==undefined?placeholderOption.text():undefined)},getPlaceholderOption:function(){if(this.select){var firstOption=this.select.children("option").first();if(this.opts.placeholderOption!==undefined)return"first"===this.opts.placeholderOption&&firstOption||"function"==typeof this.opts.placeholderOption&&this.opts.placeholderOption(this.select);if(""===$.trim(firstOption.text())&&""===firstOption.val())return firstOption}},initContainerWidth:function(){function resolveContainerWidth(){var style,attrs,matches,i,l,attr;if("off"===this.opts.width)return null;if("element"===this.opts.width)return 0===this.opts.element.outerWidth(!1)?"auto":this.opts.element.outerWidth(!1)+"px";if("copy"===this.opts.width||"resolve"===this.opts.width){if(style=this.opts.element.attr("style"),style!==undefined)for(attrs=style.split(";"),i=0,l=attrs.length;i<l;i+=1)if(attr=attrs[i].replace(/\s/g,""),matches=attr.match(/^width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/i),null!==matches&&matches.length>=1)return matches[1];return"resolve"===this.opts.width?(style=this.opts.element.css("width"),style.indexOf("%")>0?style:0===this.opts.element.outerWidth(!1)?"auto":this.opts.element.outerWidth(!1)+"px"):null}return $.isFunction(this.opts.width)?this.opts.width():this.opts.width}var width=resolveContainerWidth.call(this);null!==width&&this.container.css("width",width)}}),SingleSelect2=clazz(AbstractSelect2,{createContainer:function(){var container=$(document.createElement("div")).attr({"class":"select2-container"}).html(["<a href='javascript:void(0)' class='select2-choice' tabindex='-1'>","   <span class='select2-chosen'>&#160;</span><abbr class='select2-search-choice-close'></abbr>","   <span class='select2-arrow' role='presentation'><b role='presentation'></b></span>","</a>","<label for='' class='select2-offscreen'></label>","<input class='select2-focusser select2-offscreen' type='text' aria-haspopup='true' role='button' />","<div class='select2-drop select2-display-none'>","   <div class='select2-search'>","       <label for='' class='select2-offscreen'></label>","       <input type='text' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' class='select2-input' role='combobox' aria-expanded='true'","       aria-autocomplete='list' />","   </div>","   <ul class='select2-results' role='listbox'>","   </ul>","</div>"].join(""));return container},enableInterface:function(){this.parent.enableInterface.apply(this,arguments)&&this.focusser.prop("disabled",!this.isInterfaceEnabled())},opening:function(){var el,range,len;this.opts.minimumResultsForSearch>=0&&this.showSearch(!0),this.parent.opening.apply(this,arguments),this.showSearchInput!==!1&&this.search.val(this.focusser.val()),this.opts.shouldFocusInput(this)&&(this.search.focus(),el=this.search.get(0),el.createTextRange?(range=el.createTextRange(),range.collapse(!1),range.select()):el.setSelectionRange&&(len=this.search.val().length,el.setSelectionRange(len,len))),""===this.search.val()&&this.nextSearchTerm!=undefined&&(this.search.val(this.nextSearchTerm),this.search.select()),this.focusser.prop("disabled",!0).val(""),this.updateResults(!0),this.opts.element.trigger($.Event("select2-open"))},close:function(){this.opened()&&(this.parent.close.apply(this,arguments),this.focusser.prop("disabled",!1),this.opts.shouldFocusInput(this)&&this.focusser.focus())},focus:function(){this.opened()?this.close():(this.focusser.prop("disabled",!1),this.opts.shouldFocusInput(this)&&this.focusser.focus())},isFocused:function(){return this.container.hasClass("select2-container-active")},cancel:function(){this.parent.cancel.apply(this,arguments),this.focusser.prop("disabled",!1),this.opts.shouldFocusInput(this)&&this.focusser.focus()},destroy:function(){$("label[for='"+this.focusser.attr("id")+"']").attr("for",this.opts.element.attr("id")),this.parent.destroy.apply(this,arguments),cleanupJQueryElements.call(this,"selection","focusser")},initContainer:function(){var selection,elementLabel,container=this.container,dropdown=this.dropdown,idSuffix=nextUid();this.opts.minimumResultsForSearch<0?this.showSearch(!1):this.showSearch(!0),this.selection=selection=container.find(".select2-choice"),this.focusser=container.find(".select2-focusser"),selection.find(".select2-chosen").attr("id","select2-chosen-"+idSuffix),this.focusser.attr("aria-labelledby","select2-chosen-"+idSuffix),this.results.attr("id","select2-results-"+idSuffix),this.search.attr("aria-owns","select2-results-"+idSuffix),this.focusser.attr("id","s2id_autogen"+idSuffix),elementLabel=$("label[for='"+this.opts.element.attr("id")+"']"),this.focusser.prev().text(elementLabel.text()).attr("for",this.focusser.attr("id"));var originalTitle=this.opts.element.attr("title");this.opts.element.attr("title",originalTitle||elementLabel.text()),this.focusser.attr("tabindex",this.elementTabIndex),this.search.attr("id",this.focusser.attr("id")+"_search"),this.search.prev().text($("label[for='"+this.focusser.attr("id")+"']").text()).attr("for",this.search.attr("id")),this.search.on("keydown",this.bind(function(e){if(this.isInterfaceEnabled()){if(e.which===KEY.PAGE_UP||e.which===KEY.PAGE_DOWN)return void killEvent(e);switch(e.which){case KEY.UP:case KEY.DOWN:return this.moveHighlight(e.which===KEY.UP?-1:1),void killEvent(e);case KEY.ENTER:return this.selectHighlighted(),void killEvent(e);case KEY.TAB:return void this.selectHighlighted({noFocus:!0});case KEY.ESC:return this.cancel(e),void killEvent(e)}}})),this.search.on("blur",this.bind(function(e){document.activeElement===this.body.get(0)&&window.setTimeout(this.bind(function(){this.opened()&&this.search.focus()}),0)})),this.focusser.on("keydown",this.bind(function(e){if(this.isInterfaceEnabled()&&e.which!==KEY.TAB&&!KEY.isControl(e)&&!KEY.isFunctionKey(e)&&e.which!==KEY.ESC){if(this.opts.openOnEnter===!1&&e.which===KEY.ENTER)return void killEvent(e);if(e.which==KEY.DOWN||e.which==KEY.UP||e.which==KEY.ENTER&&this.opts.openOnEnter){if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey)return;return this.open(),void killEvent(e)}return e.which==KEY.DELETE||e.which==KEY.BACKSPACE?(this.opts.allowClear&&this.clear(),void killEvent(e)):void 0}})),installKeyUpChangeEvent(this.focusser),this.focusser.on("keyup-change input",this.bind(function(e){if(this.opts.minimumResultsForSearch>=0){if(e.stopPropagation(),this.opened())return;this.open()}})),selection.on("mousedown touchstart","abbr",this.bind(function(e){this.isInterfaceEnabled()&&(this.clear(),killEventImmediately(e),this.close(),this.selection.focus())})),selection.on("mousedown touchstart",this.bind(function(e){reinsertElement(selection),this.container.hasClass("select2-container-active")||this.opts.element.trigger($.Event("select2-focus")),this.opened()?this.close():this.isInterfaceEnabled()&&this.open(),killEvent(e)})),dropdown.on("mousedown touchstart",this.bind(function(){this.opts.shouldFocusInput(this)&&this.search.focus()})),selection.on("focus",this.bind(function(e){killEvent(e)})),this.focusser.on("focus",this.bind(function(){this.container.hasClass("select2-container-active")||this.opts.element.trigger($.Event("select2-focus")),this.container.addClass("select2-container-active")})).on("blur",this.bind(function(){this.opened()||(this.container.removeClass("select2-container-active"),this.opts.element.trigger($.Event("select2-blur")))})),this.search.on("focus",this.bind(function(){this.container.hasClass("select2-container-active")||this.opts.element.trigger($.Event("select2-focus")),this.container.addClass("select2-container-active")})),this.initContainerWidth(),this.opts.element.addClass("select2-offscreen"),this.setPlaceholder()},clear:function(triggerChange){var data=this.selection.data("select2-data");if(data){var evt=$.Event("select2-clearing");if(this.opts.element.trigger(evt),evt.isDefaultPrevented())return;var placeholderOption=this.getPlaceholderOption();this.opts.element.val(placeholderOption?placeholderOption.val():""),this.selection.find(".select2-chosen").empty(),this.selection.removeData("select2-data"),this.setPlaceholder(),triggerChange!==!1&&(this.opts.element.trigger({type:"select2-removed",val:this.id(data),choice:data}),this.triggerChange({removed:data}))}},initSelection:function(){if(this.isPlaceholderOptionSelected())this.updateSelection(null),this.close(),this.setPlaceholder();else{var self=this;this.opts.initSelection.call(null,this.opts.element,function(selected){selected!==undefined&&null!==selected&&(self.updateSelection(selected),self.close(),self.setPlaceholder(),self.nextSearchTerm=self.opts.nextSearchTerm(selected,self.search.val()))})}},isPlaceholderOptionSelected:function(){var placeholderOption;return this.getPlaceholder()!==undefined&&((placeholderOption=this.getPlaceholderOption())!==undefined&&placeholderOption.prop("selected")||""===this.opts.element.val()||this.opts.element.val()===undefined||null===this.opts.element.val())},prepareOpts:function(){var opts=this.parent.prepareOpts.apply(this,arguments),self=this;return"select"===opts.element.get(0).tagName.toLowerCase()?opts.initSelection=function(element,callback){var selected=element.find("option").filter(function(){return this.selected&&!this.disabled});callback(self.optionToData(selected))}:"data"in opts&&(opts.initSelection=opts.initSelection||function(element,callback){var id=element.val(),match=null;opts.query({matcher:function(term,text,el){var is_match=equal(id,opts.id(el));return is_match&&(match=el),is_match},callback:$.isFunction(callback)?function(){callback(match)}:$.noop})}),opts},getPlaceholder:function(){return this.select&&this.getPlaceholderOption()===undefined?undefined:this.parent.getPlaceholder.apply(this,arguments)},setPlaceholder:function(){var placeholder=this.getPlaceholder();if(this.isPlaceholderOptionSelected()&&placeholder!==undefined){if(this.select&&this.getPlaceholderOption()===undefined)return;this.selection.find(".select2-chosen").html(this.opts.escapeMarkup(placeholder)),this.selection.addClass("select2-default"),this.container.removeClass("select2-allowclear")}},postprocessResults:function(data,initial,noHighlightUpdate){var selected=0,self=this;if(this.findHighlightableChoices().each2(function(i,elm){if(equal(self.id(elm.data("select2-data")),self.opts.element.val()))return selected=i,!1}),noHighlightUpdate!==!1&&(initial===!0&&selected>=0?this.highlight(selected):this.highlight(0)),initial===!0){var min=this.opts.minimumResultsForSearch;min>=0&&this.showSearch(countResults(data.results)>=min)}},showSearch:function(showSearchInput){this.showSearchInput!==showSearchInput&&(this.showSearchInput=showSearchInput,this.dropdown.find(".select2-search").toggleClass("select2-search-hidden",!showSearchInput),this.dropdown.find(".select2-search").toggleClass("select2-offscreen",!showSearchInput),$(this.dropdown,this.container).toggleClass("select2-with-searchbox",showSearchInput))},onSelect:function(data,options){if(this.triggerSelect(data)){var old=this.opts.element.val(),oldData=this.data();this.opts.element.val(this.id(data)),this.updateSelection(data),this.opts.element.trigger({type:"select2-selected",val:this.id(data),choice:data}),this.nextSearchTerm=this.opts.nextSearchTerm(data,this.search.val()),this.close(),options&&options.noFocus||!this.opts.shouldFocusInput(this)||this.focusser.focus(),equal(old,this.id(data))||this.triggerChange({added:data,removed:oldData})}},updateSelection:function(data){var formatted,cssClass,container=this.selection.find(".select2-chosen");this.selection.data("select2-data",data),container.empty(),null!==data&&(formatted=this.opts.formatSelection(data,container,this.opts.escapeMarkup)),formatted!==undefined&&container.append(formatted),cssClass=this.opts.formatSelectionCssClass(data,container),cssClass!==undefined&&container.addClass(cssClass),this.selection.removeClass("select2-default"),this.opts.allowClear&&this.getPlaceholder()!==undefined&&this.container.addClass("select2-allowclear")},val:function(){var val,triggerChange=!1,data=null,self=this,oldData=this.data();if(0===arguments.length)return this.opts.element.val();if(val=arguments[0],arguments.length>1&&(triggerChange=arguments[1]),this.select)this.select.val(val).find("option").filter(function(){return this.selected}).each2(function(i,elm){return data=self.optionToData(elm),!1}),this.updateSelection(data),this.setPlaceholder(),triggerChange&&this.triggerChange({added:data,removed:oldData});else{if(!val&&0!==val)return void this.clear(triggerChange);if(this.opts.initSelection===undefined)throw new Error("cannot call val() if initSelection() is not defined");this.opts.element.val(val),this.opts.initSelection(this.opts.element,function(data){self.opts.element.val(data?self.id(data):""),self.updateSelection(data),self.setPlaceholder(),triggerChange&&self.triggerChange({added:data,removed:oldData})})}},clearSearch:function(){this.search.val(""),this.focusser.val("")},data:function(value){var data,triggerChange=!1;return 0===arguments.length?(data=this.selection.data("select2-data"),data==undefined&&(data=null),data):(arguments.length>1&&(triggerChange=arguments[1]),void(value?(data=this.data(),this.opts.element.val(value?this.id(value):""),this.updateSelection(value),triggerChange&&this.triggerChange({added:value,removed:data})):this.clear(triggerChange)))}}),MultiSelect2=clazz(AbstractSelect2,{createContainer:function(){var container=$(document.createElement("div")).attr({"class":"select2-container select2-container-multi"}).html(["<ul class='select2-choices'>","  <li class='select2-search-field'>","    <label for='' class='select2-offscreen'></label>","    <input type='text' autocomplete='off' autocorrect='off' autocapitalize='off' spellcheck='false' class='select2-input'>","  </li>","</ul>","<div class='select2-drop select2-drop-multi select2-display-none'>","   <ul class='select2-results'>","   </ul>","</div>"].join(""));return container},prepareOpts:function(){var opts=this.parent.prepareOpts.apply(this,arguments),self=this;return"select"===opts.element.get(0).tagName.toLowerCase()?opts.initSelection=function(element,callback){var data=[];element.find("option").filter(function(){return this.selected&&!this.disabled}).each2(function(i,elm){data.push(self.optionToData(elm))}),callback(data)}:"data"in opts&&(opts.initSelection=opts.initSelection||function(element,callback){var ids=splitVal(element.val(),opts.separator),matches=[];opts.query({matcher:function(term,text,el){var is_match=$.grep(ids,function(id){return equal(id,opts.id(el))}).length;return is_match&&matches.push(el),is_match},callback:$.isFunction(callback)?function(){for(var ordered=[],i=0;i<ids.length;i++)for(var id=ids[i],j=0;j<matches.length;j++){var match=matches[j];if(equal(id,opts.id(match))){ordered.push(match),matches.splice(j,1);break}}callback(ordered)}:$.noop})}),opts},selectChoice:function(choice){var selected=this.container.find(".select2-search-choice-focus");selected.length&&choice&&choice[0]==selected[0]||(selected.length&&this.opts.element.trigger("choice-deselected",selected),selected.removeClass("select2-search-choice-focus"),choice&&choice.length&&(this.close(),choice.addClass("select2-search-choice-focus"),this.opts.element.trigger("choice-selected",choice)))},destroy:function(){$("label[for='"+this.search.attr("id")+"']").attr("for",this.opts.element.attr("id")),this.parent.destroy.apply(this,arguments),cleanupJQueryElements.call(this,"searchContainer","selection")},initContainer:function(){var selection,selector=".select2-choices";this.searchContainer=this.container.find(".select2-search-field"),this.selection=selection=this.container.find(selector);var _this=this;this.selection.on("click",".select2-search-choice:not(.select2-locked)",function(e){_this.search[0].focus(),_this.selectChoice($(this))}),this.search.attr("id","s2id_autogen"+nextUid()),this.search.prev().text($("label[for='"+this.opts.element.attr("id")+"']").text()).attr("for",this.search.attr("id")),this.search.on("input paste",this.bind(function(){this.isInterfaceEnabled()&&(this.opened()||this.open())})),this.search.attr("tabindex",this.elementTabIndex),this.keydowns=0,this.search.on("keydown",this.bind(function(e){if(this.isInterfaceEnabled()){++this.keydowns;var selected=selection.find(".select2-search-choice-focus"),prev=selected.prev(".select2-search-choice:not(.select2-locked)"),next=selected.next(".select2-search-choice:not(.select2-locked)"),pos=getCursorInfo(this.search);if(selected.length&&(e.which==KEY.LEFT||e.which==KEY.RIGHT||e.which==KEY.BACKSPACE||e.which==KEY.DELETE||e.which==KEY.ENTER)){var selectedChoice=selected;return e.which==KEY.LEFT&&prev.length?selectedChoice=prev:e.which==KEY.RIGHT?selectedChoice=next.length?next:null:e.which===KEY.BACKSPACE?this.unselect(selected.first())&&(this.search.width(10),selectedChoice=prev.length?prev:next):e.which==KEY.DELETE?this.unselect(selected.first())&&(this.search.width(10),selectedChoice=next.length?next:null):e.which==KEY.ENTER&&(selectedChoice=null),this.selectChoice(selectedChoice),killEvent(e),void(selectedChoice&&selectedChoice.length||this.open())}if((e.which===KEY.BACKSPACE&&1==this.keydowns||e.which==KEY.LEFT)&&0==pos.offset&&!pos.length)return this.selectChoice(selection.find(".select2-search-choice:not(.select2-locked)").last()),void killEvent(e);if(this.selectChoice(null),this.opened())switch(e.which){case KEY.UP:case KEY.DOWN:return this.moveHighlight(e.which===KEY.UP?-1:1),void killEvent(e);case KEY.ENTER:return this.selectHighlighted(),void killEvent(e);case KEY.TAB:return this.selectHighlighted({noFocus:!0}),void this.close();case KEY.ESC:return this.cancel(e),void killEvent(e)}if(e.which!==KEY.TAB&&!KEY.isControl(e)&&!KEY.isFunctionKey(e)&&e.which!==KEY.BACKSPACE&&e.which!==KEY.ESC){if(e.which===KEY.ENTER){if(this.opts.openOnEnter===!1)return;if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey)return}this.open(),e.which!==KEY.PAGE_UP&&e.which!==KEY.PAGE_DOWN||killEvent(e),e.which===KEY.ENTER&&killEvent(e)}}})),this.search.on("keyup",this.bind(function(e){this.keydowns=0,this.resizeSearch()})),this.search.on("blur",this.bind(function(e){this.container.removeClass("select2-container-active"),this.search.removeClass("select2-focused"),this.selectChoice(null),this.opened()||this.clearSearch(),e.stopImmediatePropagation(),this.opts.element.trigger($.Event("select2-blur"))})),this.container.on("click",selector,this.bind(function(e){this.isInterfaceEnabled()&&($(e.target).closest(".select2-search-choice").length>0||(this.selectChoice(null),this.clearPlaceholder(),this.container.hasClass("select2-container-active")||this.opts.element.trigger($.Event("select2-focus")),this.open(),this.focusSearch(),e.preventDefault()))})),this.container.on("focus",selector,this.bind(function(){this.isInterfaceEnabled()&&(this.container.hasClass("select2-container-active")||this.opts.element.trigger($.Event("select2-focus")),this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active"),this.clearPlaceholder())})),this.initContainerWidth(),this.opts.element.addClass("select2-offscreen"),this.clearSearch()},enableInterface:function(){this.parent.enableInterface.apply(this,arguments)&&this.search.prop("disabled",!this.isInterfaceEnabled())},initSelection:function(){if(""===this.opts.element.val()&&""===this.opts.element.text()&&(this.updateSelection([]),this.close(),this.clearSearch()),this.select||""!==this.opts.element.val()){var self=this;this.opts.initSelection.call(null,this.opts.element,function(data){data!==undefined&&null!==data&&(self.updateSelection(data),self.close(),self.clearSearch())})}},clearSearch:function(){var placeholder=this.getPlaceholder(),maxWidth=this.getMaxSearchWidth();placeholder!==undefined&&0===this.getVal().length&&this.search.hasClass("select2-focused")===!1?(this.search.val(placeholder).addClass("select2-default"),this.search.width(maxWidth>0?maxWidth:this.container.css("width"))):this.search.val("").width(10)},clearPlaceholder:function(){this.search.hasClass("select2-default")&&this.search.val("").removeClass("select2-default")},opening:function(){this.clearPlaceholder(),this.resizeSearch(),this.parent.opening.apply(this,arguments),this.focusSearch(),""===this.search.val()&&this.nextSearchTerm!=undefined&&(this.search.val(this.nextSearchTerm),this.search.select()),this.updateResults(!0),this.opts.shouldFocusInput(this)&&this.search.focus(),this.opts.element.trigger($.Event("select2-open"))},close:function(){
this.opened()&&this.parent.close.apply(this,arguments)},focus:function(){this.close(),this.search.focus()},isFocused:function(){return this.search.hasClass("select2-focused")},updateSelection:function(data){var ids=[],filtered=[],self=this;$(data).each(function(){indexOf(self.id(this),ids)<0&&(ids.push(self.id(this)),filtered.push(this))}),data=filtered,this.selection.find(".select2-search-choice").remove(),$(data).each(function(){self.addSelectedChoice(this)}),self.postprocessResults()},tokenize:function(){var input=this.search.val();input=this.opts.tokenizer.call(this,input,this.data(),this.bind(this.onSelect),this.opts),null!=input&&input!=undefined&&(this.search.val(input),input.length>0&&this.open())},onSelect:function(data,options){this.triggerSelect(data)&&(this.addSelectedChoice(data),this.opts.element.trigger({type:"selected",val:this.id(data),choice:data}),this.nextSearchTerm=this.opts.nextSearchTerm(data,this.search.val()),this.clearSearch(),this.updateResults(),!this.select&&this.opts.closeOnSelect||this.postprocessResults(data,!1,this.opts.closeOnSelect===!0),this.opts.closeOnSelect?(this.close(),this.search.width(10)):this.countSelectableResults()>0?(this.search.width(10),this.resizeSearch(),this.getMaximumSelectionSize()>0&&this.val().length>=this.getMaximumSelectionSize()?this.updateResults(!0):this.nextSearchTerm!=undefined&&(this.search.val(this.nextSearchTerm),this.updateResults(),this.search.select()),this.positionDropdown()):(this.close(),this.search.width(10)),this.triggerChange({added:data}),options&&options.noFocus||this.focusSearch())},cancel:function(){this.close(),this.focusSearch()},addSelectedChoice:function(data){var formatted,cssClass,enableChoice=!data.locked,enabledItem=$("<li class='select2-search-choice'>    <div></div>    <a href='#' class='select2-search-choice-close' tabindex='-1'></a></li>"),disabledItem=$("<li class='select2-search-choice select2-locked'><div></div></li>"),choice=enableChoice?enabledItem:disabledItem,id=this.id(data),val=this.getVal();formatted=this.opts.formatSelection(data,choice.find("div"),this.opts.escapeMarkup),formatted!=undefined&&choice.find("div").replaceWith("<div>"+formatted+"</div>"),cssClass=this.opts.formatSelectionCssClass(data,choice.find("div")),cssClass!=undefined&&choice.addClass(cssClass),enableChoice&&choice.find(".select2-search-choice-close").on("mousedown",killEvent).on("click dblclick",this.bind(function(e){this.isInterfaceEnabled()&&(this.unselect($(e.target)),this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus"),killEvent(e),this.close(),this.focusSearch())})).on("focus",this.bind(function(){this.isInterfaceEnabled()&&(this.container.addClass("select2-container-active"),this.dropdown.addClass("select2-drop-active"))})),choice.data("select2-data",data),choice.insertBefore(this.searchContainer),val.push(id),this.setVal(val)},unselect:function(selected){var data,index,val=this.getVal();if(selected=selected.closest(".select2-search-choice"),0===selected.length)throw"Invalid argument: "+selected+". Must be .select2-search-choice";if(data=selected.data("select2-data")){var evt=$.Event("select2-removing");if(evt.val=this.id(data),evt.choice=data,this.opts.element.trigger(evt),evt.isDefaultPrevented())return!1;for(;(index=indexOf(this.id(data),val))>=0;)val.splice(index,1),this.setVal(val),this.select&&this.postprocessResults();return selected.remove(),this.opts.element.trigger({type:"select2-removed",val:this.id(data),choice:data}),this.triggerChange({removed:data}),!0}},postprocessResults:function(data,initial,noHighlightUpdate){var val=this.getVal(),choices=this.results.find(".select2-result"),compound=this.results.find(".select2-result-with-children"),self=this;choices.each2(function(i,choice){var id=self.id(choice.data("select2-data"));indexOf(id,val)>=0&&(choice.addClass("select2-selected"),choice.find(".select2-result-selectable").addClass("select2-selected"))}),compound.each2(function(i,choice){choice.is(".select2-result-selectable")||0!==choice.find(".select2-result-selectable:not(.select2-selected)").length||choice.addClass("select2-selected")}),this.highlight()==-1&&noHighlightUpdate!==!1&&self.highlight(0),!this.opts.createSearchChoice&&!choices.filter(".select2-result:not(.select2-selected)").length>0&&(!data||data&&!data.more&&0===this.results.find(".select2-no-results").length)&&checkFormatter(self.opts.formatNoMatches,"formatNoMatches")&&this.results.append("<li class='select2-no-results'>"+evaluate(self.opts.formatNoMatches,self.search.val())+"</li>")},getMaxSearchWidth:function(){return this.selection.width()-getSideBorderPadding(this.search)},resizeSearch:function(){var minimumWidth,left,maxWidth,containerLeft,searchWidth,sideBorderPadding=getSideBorderPadding(this.search);minimumWidth=measureTextWidth(this.search)+10,left=this.search.offset().left,maxWidth=this.selection.width(),containerLeft=this.selection.offset().left,searchWidth=maxWidth-(left-containerLeft)-sideBorderPadding,searchWidth<minimumWidth&&(searchWidth=maxWidth-sideBorderPadding),searchWidth<40&&(searchWidth=maxWidth-sideBorderPadding),searchWidth<=0&&(searchWidth=minimumWidth),this.search.width(Math.floor(searchWidth))},getVal:function(){var val;return this.select?(val=this.select.val(),null===val?[]:val):(val=this.opts.element.val(),splitVal(val,this.opts.separator))},setVal:function(val){var unique;this.select?this.select.val(val):(unique=[],$(val).each(function(){indexOf(this,unique)<0&&unique.push(this)}),this.opts.element.val(0===unique.length?"":unique.join(this.opts.separator)))},buildChangeDetails:function(old,current){for(var current=current.slice(0),old=old.slice(0),i=0;i<current.length;i++)for(var j=0;j<old.length;j++)equal(this.opts.id(current[i]),this.opts.id(old[j]))&&(current.splice(i,1),i>0&&i--,old.splice(j,1),j--);return{added:current,removed:old}},val:function(val,triggerChange){var oldData,self=this;if(0===arguments.length)return this.getVal();if(oldData=this.data(),oldData.length||(oldData=[]),!val&&0!==val)return this.opts.element.val(""),this.updateSelection([]),this.clearSearch(),void(triggerChange&&this.triggerChange({added:this.data(),removed:oldData}));if(this.setVal(val),this.select)this.opts.initSelection(this.select,this.bind(this.updateSelection)),triggerChange&&this.triggerChange(this.buildChangeDetails(oldData,this.data()));else{if(this.opts.initSelection===undefined)throw new Error("val() cannot be called if initSelection() is not defined");this.opts.initSelection(this.opts.element,function(data){var ids=$.map(data,self.id);self.setVal(ids),self.updateSelection(data),self.clearSearch(),triggerChange&&self.triggerChange(self.buildChangeDetails(oldData,self.data()))})}this.clearSearch()},onSortStart:function(){if(this.select)throw new Error("Sorting of elements is not supported when attached to <select>. Attach to <input type='hidden'/> instead.");this.search.width(0),this.searchContainer.hide()},onSortEnd:function(){var val=[],self=this;this.searchContainer.show(),this.searchContainer.appendTo(this.searchContainer.parent()),this.resizeSearch(),this.selection.find(".select2-search-choice").each(function(){val.push(self.opts.id($(this).data("select2-data")))}),this.setVal(val),this.triggerChange()},data:function(values,triggerChange){var ids,old,self=this;return 0===arguments.length?this.selection.children(".select2-search-choice").map(function(){return $(this).data("select2-data")}).get():(old=this.data(),values||(values=[]),ids=$.map(values,function(e){return self.opts.id(e)}),this.setVal(ids),this.updateSelection(values),this.clearSearch(),triggerChange&&this.triggerChange(this.buildChangeDetails(old,this.data())),void 0)}}),$.fn.select2=function(){var opts,select2,method,value,multiple,args=Array.prototype.slice.call(arguments,0),allowedMethods=["val","destroy","opened","open","close","focus","isFocused","container","dropdown","onSortStart","onSortEnd","enable","disable","readonly","positionDropdown","data","search"],valueMethods=["opened","isFocused","container","dropdown"],propertyMethods=["val","data"],methodsMap={search:"externalSearch"};return this.each(function(){if(0===args.length||"object"==typeof args[0])opts=0===args.length?{}:$.extend({},args[0]),opts.element=$(this),"select"===opts.element.get(0).tagName.toLowerCase()?multiple=opts.element.prop("multiple"):(multiple=opts.multiple||!1,"tags"in opts&&(opts.multiple=multiple=!0)),select2=multiple?new window.Select2["class"].multi:new window.Select2["class"].single,select2.init(opts);else{if("string"!=typeof args[0])throw"Invalid arguments to select2 plugin: "+args;if(indexOf(args[0],allowedMethods)<0)throw"Unknown method: "+args[0];if(value=undefined,select2=$(this).data("select2"),select2===undefined)return;if(method=args[0],"container"===method?value=select2.container:"dropdown"===method?value=select2.dropdown:(methodsMap[method]&&(method=methodsMap[method]),value=select2[method].apply(select2,args.slice(1))),indexOf(args[0],valueMethods)>=0||indexOf(args[0],propertyMethods)>=0&&1==args.length)return!1}}),value===undefined?this:value},$.fn.select2.defaults={width:"copy",loadMorePadding:0,closeOnSelect:!0,openOnEnter:!0,containerCss:{},dropdownCss:{},containerCssClass:"",dropdownCssClass:"",formatResult:function(result,container,query,escapeMarkup){var markup=[];return markMatch(result.text,query.term,markup,escapeMarkup),markup.join("")},formatSelection:function(data,container,escapeMarkup){return data?escapeMarkup(data.text):undefined},sortResults:function(results,container,query){return results},formatResultCssClass:function(data){return data.css},formatSelectionCssClass:function(data,container){return undefined},formatMatches:function(matches){return matches+" results are available, use up and down arrow keys to navigate."},formatNoMatches:function(){return"No matches found"},formatInputTooShort:function(input,min){var n=min-input.length;return"Please enter "+n+" or more character"+(1==n?"":"s")},formatInputTooLong:function(input,max){var n=input.length-max;return"Please delete "+n+" character"+(1==n?"":"s")},formatSelectionTooBig:function(limit){return"You can only select "+limit+" item"+(1==limit?"":"s")},formatLoadMore:function(pageNumber){return"Loading more results"},formatSearching:function(){return"Searching"},minimumResultsForSearch:0,minimumInputLength:0,maximumInputLength:null,maximumSelectionSize:0,id:function(e){return e==undefined?null:e.id},matcher:function(term,text){return stripDiacritics(""+text).toUpperCase().indexOf(stripDiacritics(""+term).toUpperCase())>=0},separator:",",tokenSeparators:[],tokenizer:defaultTokenizer,escapeMarkup:defaultEscapeMarkup,blurOnChange:!1,selectOnBlur:!1,adaptContainerCssClass:function(c){return c},adaptDropdownCssClass:function(c){return null},nextSearchTerm:function(selectedObject,currentSearchTerm){return undefined},searchInputPlaceholder:"",createSearchChoicePosition:"top",shouldFocusInput:function(instance){var supportsTouchEvents="ontouchstart"in window||navigator.msMaxTouchPoints>0;return!supportsTouchEvents||!(instance.opts.minimumResultsForSearch<0)}},$.fn.select2.ajaxDefaults={transport:$.ajax,params:{type:"GET",cache:!1,dataType:"json"}},window.Select2={query:{ajax:ajax,local:local,tags:tags},util:{debounce:debounce,markMatch:markMatch,escapeMarkup:defaultEscapeMarkup,stripDiacritics:stripDiacritics},"class":{"abstract":AbstractSelect2,single:SingleSelect2,multi:MultiSelect2}}}}(jQuery),angular.module("ui.select2",[]).value("uiSelect2Config",{}).directive("uiSelect2",["uiSelect2Config","$timeout",function(uiSelect2Config,$timeout){var options={};return uiSelect2Config&&angular.extend(options,uiSelect2Config),{require:"ngModel",priority:1,compile:function(tElm,tAttrs){var watch,repeatOption,repeatAttr,isSelect=tElm.is("select"),isMultiple=angular.isDefined(tAttrs.multiple);return tElm.is("select")&&(repeatOption=tElm.find("option[ng-repeat], option[data-ng-repeat]"),repeatOption.length&&(repeatAttr=repeatOption.attr("ng-repeat")||repeatOption.attr("data-ng-repeat"),watch=jQuery.trim(repeatAttr.split("|")[0]).split(" ").pop())),function(scope,elm,attrs,controller){var opts=angular.extend({},options,scope.$eval(attrs.uiSelect2)),convertToAngularModel=function(select2_data){var model;return opts.simple_tags?(model=[],angular.forEach(select2_data,function(value,index){model.push(value.id)})):model=select2_data,model},convertToSelect2Model=function(angular_data){var model=[];return angular_data?(opts.simple_tags?(model=[],angular.forEach(angular_data,function(value,index){model.push({id:value,text:value})})):model=angular_data,model):model};if(isSelect?(delete opts.multiple,delete opts.initSelection):isMultiple&&(opts.multiple=!0),controller&&(scope.$watch(tAttrs.ngModel,function(current,old){current&&current!==old&&controller.$render()},!0),controller.$render=function(){if(isSelect)elm.select2("val",controller.$viewValue);else if(opts.multiple){var viewValue=controller.$viewValue;angular.isString(viewValue)&&(viewValue=viewValue.split(",")),elm.select2("data",convertToSelect2Model(viewValue))}else angular.isObject(controller.$viewValue)?elm.select2("data",controller.$viewValue):controller.$viewValue?elm.select2("val",controller.$viewValue):elm.select2("data",null)},watch&&scope.$watch(watch,function(newVal,oldVal,scope){angular.equals(newVal,oldVal)||$timeout(function(){elm.select2("val",controller.$viewValue),elm.trigger("change"),newVal&&!oldVal&&controller.$setPristine&&controller.$setPristine(!0)})}),controller.$parsers.push(function(value){var div=elm.prev();return div.toggleClass("ng-invalid",!controller.$valid).toggleClass("ng-valid",controller.$valid).toggleClass("ng-invalid-required",!controller.$valid).toggleClass("ng-valid-required",controller.$valid).toggleClass("ng-dirty",controller.$dirty).toggleClass("ng-pristine",controller.$pristine),value}),!isSelect&&(elm.bind("change",function(e){e.stopImmediatePropagation(),scope.$$phase||scope.$root.$$phase||scope.$apply(function(){controller.$setViewValue(convertToAngularModel(elm.select2("data")))})}),opts.initSelection))){var initSelection=opts.initSelection;opts.initSelection=function(element,callback){initSelection(element,function(value){controller.$setViewValue(convertToAngularModel(value)),callback(value)})}}elm.bind("$destroy",function(){elm.select2("destroy")}),attrs.$observe("disabled",function(value){elm.select2("enable",!value)}),attrs.$observe("readonly",function(value){elm.select2("readonly",!!value)}),attrs.ngMultiple&&scope.$watch(attrs.ngMultiple,function(newVal){attrs.$set("multiple",!!newVal),elm.select2(opts)}),$timeout(function(){elm.select2(opts),elm.val(controller.$viewValue),controller.$render(),opts.initSelection||isSelect||controller.$setViewValue(convertToAngularModel(elm.select2("data")))})}}}}]),function(){var KEY={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,COMMAND:91,MAP:{91:"COMMAND",8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",18:"ALT",19:"PAUSEBREAK",20:"CAPSLOCK",27:"ESC",32:"SPACE",33:"PAGE_UP",34:"PAGE_DOWN",35:"END",36:"HOME",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN",43:"+",44:"PRINTSCREEN",45:"INSERT",46:"DELETE",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NUMLOCK",145:"SCROLLLOCK",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},isControl:function(e){var k=e.which;switch(k){case KEY.COMMAND:case KEY.SHIFT:case KEY.CTRL:case KEY.ALT:return!0}return!!(e.metaKey||e.ctrlKey||e.altKey)},isFunctionKey:function(k){return k=k.which?k.which:k,k>=112&&k<=123},isVerticalMovement:function(k){return~[KEY.UP,KEY.DOWN].indexOf(k)},isHorizontalMovement:function(k){return~[KEY.LEFT,KEY.RIGHT,KEY.BACKSPACE,KEY.DELETE].indexOf(k)},toSeparator:function(k){var sep={ENTER:"\n",TAB:"\t",SPACE:" "}[k];return sep?sep:KEY[k]?void 0:k}};void 0===angular.element.prototype.querySelectorAll&&(angular.element.prototype.querySelectorAll=function(selector){return angular.element(this[0].querySelectorAll(selector))}),void 0===angular.element.prototype.closest&&(angular.element.prototype.closest=function(selector){for(var elem=this[0],matchesSelector=elem.matches||elem.webkitMatchesSelector||elem.mozMatchesSelector||elem.msMatchesSelector;elem;){if(matchesSelector.bind(elem)(selector))return elem;elem=elem.parentElement}return!1});var latestId=0,uis=angular.module("ui.select",[]).constant("uiSelectConfig",{theme:"bootstrap",searchEnabled:!0,sortable:!1,placeholder:"",refreshDelay:1e3,closeOnSelect:!0,skipFocusser:!1,dropdownPosition:"auto",removeSelected:!0,resetSearchInput:!0,generateId:function(){return latestId++},appendToBody:!1}).service("uiSelectMinErr",function(){var minErr=angular.$$minErr("ui.select");return function(){var error=minErr.apply(this,arguments),message=error.message.replace(new RegExp("\nhttp://errors.angularjs.org/.*"),"");return new Error(message)}}).directive("uisTranscludeAppend",function(){return{link:function(scope,element,attrs,ctrl,transclude){transclude(scope,function(clone){element.append(clone)})}}}).filter("highlight",function(){function escapeRegexp(queryToEscape){return(""+queryToEscape).replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}return function(matchItem,query){return query&&matchItem?(""+matchItem).replace(new RegExp(escapeRegexp(query),"gi"),'<span class="ui-select-highlight">$&</span>'):matchItem}}).factory("uisOffset",["$document","$window",function($document,$window){return function(element){var boundingClientRect=element[0].getBoundingClientRect();return{width:boundingClientRect.width||element.prop("offsetWidth"),height:boundingClientRect.height||element.prop("offsetHeight"),top:boundingClientRect.top+($window.pageYOffset||$document[0].documentElement.scrollTop),left:boundingClientRect.left+($window.pageXOffset||$document[0].documentElement.scrollLeft)}}}]);uis.directive("uiSelectChoices",["uiSelectConfig","uisRepeatParser","uiSelectMinErr","$compile","$window",function(uiSelectConfig,RepeatParser,uiSelectMinErr,$compile,$window){return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(tElement){tElement.addClass("ui-select-choices");var theme=tElement.parent().attr("theme")||uiSelectConfig.theme;return theme+"/choices.tpl.html"},compile:function(tElement,tAttrs){if(!tAttrs.repeat)throw uiSelectMinErr("repeat","Expected 'repeat' expression.");var groupByExp=tAttrs.groupBy,groupFilterExp=tAttrs.groupFilter;if(groupByExp){var groups=tElement.querySelectorAll(".ui-select-choices-group");if(1!==groups.length)throw uiSelectMinErr("rows","Expected 1 .ui-select-choices-group but got '{0}'.",groups.length);groups.attr("ng-repeat",RepeatParser.getGroupNgRepeatExpression())}var parserResult=RepeatParser.parse(tAttrs.repeat),choices=tElement.querySelectorAll(".ui-select-choices-row");if(1!==choices.length)throw uiSelectMinErr("rows","Expected 1 .ui-select-choices-row but got '{0}'.",choices.length);choices.attr("ng-repeat",parserResult.repeatExpression(groupByExp)).attr("ng-if","$select.open");var rowsInner=tElement.querySelectorAll(".ui-select-choices-row-inner");if(1!==rowsInner.length)throw uiSelectMinErr("rows","Expected 1 .ui-select-choices-row-inner but got '{0}'.",rowsInner.length);rowsInner.attr("uis-transclude-append","");var clickTarget=$window.document.addEventListener?choices:rowsInner;return clickTarget.attr("ng-click","$select.select("+parserResult.itemName+",$select.skipFocusser,$event)"),function(scope,element,attrs,$select){$select.parseRepeatAttr(attrs.repeat,groupByExp,groupFilterExp),$select.disableChoiceExpression=attrs.uiDisableChoice,$select.onHighlightCallback=attrs.onHighlight,$select.dropdownPosition=attrs.position?attrs.position.toLowerCase():uiSelectConfig.dropdownPosition,scope.$on("$destroy",function(){choices.remove()}),scope.$watch("$select.search",function(newValue){newValue&&!$select.open&&$select.multiple&&$select.activate(!1,!0),$select.activeIndex=$select.tagging.isActivated?-1:0,!attrs.minimumInputLength||$select.search.length>=attrs.minimumInputLength?$select.refresh(attrs.refresh):$select.items=[]}),attrs.$observe("refreshDelay",function(){var refreshDelay=scope.$eval(attrs.refreshDelay);$select.refreshDelay=void 0!==refreshDelay?refreshDelay:uiSelectConfig.refreshDelay})}}}}]),uis.controller("uiSelectCtrl",["$scope","$element","$timeout","$filter","$$uisDebounce","uisRepeatParser","uiSelectMinErr","uiSelectConfig","$parse","$injector","$window",function($scope,$element,$timeout,$filter,$$uisDebounce,RepeatParser,uiSelectMinErr,uiSelectConfig,$parse,$injector,$window){function _findIndex(collection,predicate,thisArg){if(collection.findIndex)return collection.findIndex(predicate,thisArg);for(var value,list=Object(collection),length=list.length>>>0,i=0;i<length;i++)if(value=list[i],predicate.call(thisArg,value,i,list))return i;return-1}function _resetSearchInput(){ctrl.resetSearchInput&&(ctrl.search=EMPTY_SEARCH,ctrl.selected&&ctrl.items.length&&!ctrl.multiple&&(ctrl.activeIndex=_findIndex(ctrl.items,function(item){return angular.equals(this,item)},ctrl.selected)))}function _groupsFilter(groups,groupNames){var i,j,result=[];for(i=0;i<groupNames.length;i++)for(j=0;j<groups.length;j++)groups[j].name==[groupNames[i]]&&result.push(groups[j]);return result}function _updateItemDisabled(item,isDisabled){var disabledItemIndex=disabledItems.indexOf(item);isDisabled&&disabledItemIndex===-1&&disabledItems.push(item),!isDisabled&&disabledItemIndex>-1&&disabledItems.splice(disabledItemIndex,1)}function _isItemDisabled(item){return disabledItems.indexOf(item)>-1}function _initaliseLockedChoices(doInitalise){function _updateItemLocked(item,isLocked){var lockedItemIndex=lockedItems.indexOf(item);isLocked&&lockedItemIndex===-1&&lockedItems.push(item),!isLocked&&lockedItemIndex>-1&&lockedItems.splice(lockedItemIndex,0)}function _isItemlocked(item){return lockedItems.indexOf(item)>-1}if(doInitalise){var lockedItems=[];ctrl.isLocked=function(itemScope,itemIndex){var isLocked=!1,item=ctrl.selected[itemIndex];return item&&(itemScope?(isLocked=!!itemScope.$eval(ctrl.lockChoiceExpression),_updateItemLocked(item,isLocked)):isLocked=_isItemlocked(item)),isLocked}}}function _handleDropDownSelection(key){var processed=!0;switch(key){case KEY.DOWN:!ctrl.open&&ctrl.multiple?ctrl.activate(!1,!0):ctrl.activeIndex<ctrl.items.length-1&&ctrl.activeIndex++;break;case KEY.UP:!ctrl.open&&ctrl.multiple?ctrl.activate(!1,!0):(ctrl.activeIndex>0||0===ctrl.search.length&&ctrl.tagging.isActivated&&ctrl.activeIndex>-1)&&ctrl.activeIndex--;break;case KEY.TAB:ctrl.multiple&&!ctrl.open||ctrl.select(ctrl.items[ctrl.activeIndex],!0);break;case KEY.ENTER:ctrl.open&&(ctrl.tagging.isActivated||ctrl.activeIndex>=0)?ctrl.select(ctrl.items[ctrl.activeIndex],ctrl.skipFocusser):ctrl.activate(!1,!0);break;case KEY.ESC:ctrl.close();break;default:processed=!1}return processed}function _ensureHighlightVisible(){var container=$element.querySelectorAll(".ui-select-choices-content"),choices=container.querySelectorAll(".ui-select-choices-row");if(choices.length<1)throw uiSelectMinErr("choices","Expected multiple .ui-select-choices-row but got '{0}'.",choices.length);if(!(ctrl.activeIndex<0)){var highlighted=choices[ctrl.activeIndex],posY=highlighted.offsetTop+highlighted.clientHeight-container[0].scrollTop,height=container[0].offsetHeight;posY>height?container[0].scrollTop+=posY-height:posY<highlighted.clientHeight&&(ctrl.isGrouped&&0===ctrl.activeIndex?container[0].scrollTop=0:container[0].scrollTop-=highlighted.clientHeight-posY)}}var ctrl=this,EMPTY_SEARCH="";if(ctrl.placeholder=uiSelectConfig.placeholder,ctrl.searchEnabled=uiSelectConfig.searchEnabled,ctrl.sortable=uiSelectConfig.sortable,ctrl.refreshDelay=uiSelectConfig.refreshDelay,ctrl.paste=uiSelectConfig.paste,ctrl.resetSearchInput=uiSelectConfig.resetSearchInput,ctrl.removeSelected=uiSelectConfig.removeSelected,ctrl.closeOnSelect=!0,ctrl.skipFocusser=!1,ctrl.search=EMPTY_SEARCH,ctrl.activeIndex=0,ctrl.items=[],ctrl.open=!1,ctrl.focus=!1,ctrl.disabled=!1,ctrl.selected=void 0,ctrl.dropdownPosition="auto",ctrl.focusser=void 0,ctrl.multiple=void 0,ctrl.disableChoiceExpression=void 0,ctrl.tagging={isActivated:!1,fct:void 0},ctrl.taggingTokens={isActivated:!1,tokens:void 0},ctrl.lockChoiceExpression=void 0,ctrl.clickTriggeredSelect=!1,ctrl.$filter=$filter,ctrl.$element=$element,ctrl.$animate=function(){try{return $injector.get("$animate")}catch(err){return null}}(),ctrl.searchInput=$element.querySelectorAll("input.ui-select-search"),1!==ctrl.searchInput.length)throw uiSelectMinErr("searchInput","Expected 1 input.ui-select-search but got '{0}'.",ctrl.searchInput.length);ctrl.isEmpty=function(){return angular.isUndefined(ctrl.selected)||null===ctrl.selected||""===ctrl.selected||ctrl.multiple&&0===ctrl.selected.length},ctrl.activate=function(initSearchValue,avoidReset){if(ctrl.disabled||ctrl.open)ctrl.open&&!ctrl.searchEnabled&&ctrl.close();else{avoidReset||_resetSearchInput(),$scope.$broadcast("uis:activate"),ctrl.open=!0,ctrl.activeIndex=ctrl.activeIndex>=ctrl.items.length?0:ctrl.activeIndex,ctrl.activeIndex===-1&&ctrl.taggingLabel!==!1&&(ctrl.activeIndex=0);var container=$element.querySelectorAll(".ui-select-choices-content"),searchInput=$element.querySelectorAll(".ui-select-search");if(ctrl.$animate&&ctrl.$animate.on&&ctrl.$animate.enabled(container[0])){var animateHandler=function(elem,phase){"start"===phase&&0===ctrl.items.length?(ctrl.$animate.off("removeClass",searchInput[0],animateHandler),$timeout(function(){ctrl.focusSearchInput(initSearchValue)})):"close"===phase&&(ctrl.$animate.off("enter",container[0],animateHandler),$timeout(function(){ctrl.focusSearchInput(initSearchValue)}))};ctrl.items.length>0?ctrl.$animate.on("enter",container[0],animateHandler):ctrl.$animate.on("removeClass",searchInput[0],animateHandler)}else $timeout(function(){ctrl.focusSearchInput(initSearchValue),!ctrl.tagging.isActivated&&ctrl.items.length>1&&_ensureHighlightVisible()})}},ctrl.focusSearchInput=function(initSearchValue){ctrl.search=initSearchValue||ctrl.search,ctrl.searchInput[0].focus()},ctrl.findGroupByName=function(name){return ctrl.groups&&ctrl.groups.filter(function(group){return group.name===name})[0]},ctrl.parseRepeatAttr=function(repeatAttr,groupByExp,groupFilterExp){function updateGroups(items){var groupFn=$scope.$eval(groupByExp);if(ctrl.groups=[],angular.forEach(items,function(item){var groupName=angular.isFunction(groupFn)?groupFn(item):item[groupFn],group=ctrl.findGroupByName(groupName);group?group.items.push(item):ctrl.groups.push({name:groupName,items:[item]})}),groupFilterExp){var groupFilterFn=$scope.$eval(groupFilterExp);angular.isFunction(groupFilterFn)?ctrl.groups=groupFilterFn(ctrl.groups):angular.isArray(groupFilterFn)&&(ctrl.groups=_groupsFilter(ctrl.groups,groupFilterFn))}ctrl.items=[],ctrl.groups.forEach(function(group){ctrl.items=ctrl.items.concat(group.items)})}function setPlainItems(items){ctrl.items=items}ctrl.setItemsFn=groupByExp?updateGroups:setPlainItems,ctrl.parserResult=RepeatParser.parse(repeatAttr),ctrl.isGrouped=!!groupByExp,ctrl.itemProperty=ctrl.parserResult.itemName;var originalSource=ctrl.parserResult.source,createArrayFromObject=function(){var origSrc=originalSource($scope);$scope.$uisSource=Object.keys(origSrc).map(function(v){var result={};return result[ctrl.parserResult.keyName]=v,result.value=origSrc[v],result})};ctrl.parserResult.keyName&&(createArrayFromObject(),ctrl.parserResult.source=$parse("$uisSource"+ctrl.parserResult.filters),$scope.$watch(originalSource,function(newVal,oldVal){newVal!==oldVal&&createArrayFromObject()},!0)),ctrl.refreshItems=function(data){data=data||ctrl.parserResult.source($scope);var selectedItems=ctrl.selected;if(ctrl.isEmpty()||angular.isArray(selectedItems)&&!selectedItems.length||!ctrl.multiple||!ctrl.removeSelected)ctrl.setItemsFn(data);else if(void 0!==data&&null!==data){var filteredItems=data.filter(function(i){return angular.isArray(selectedItems)?selectedItems.every(function(selectedItem){return!angular.equals(i,selectedItem)}):!angular.equals(i,selectedItems)});ctrl.setItemsFn(filteredItems)}"auto"!==ctrl.dropdownPosition&&"up"!==ctrl.dropdownPosition||$scope.calculateDropdownPos(),$scope.$broadcast("uis:refresh")},$scope.$watchCollection(ctrl.parserResult.source,function(items){if(void 0===items||null===items)ctrl.items=[];else{if(!angular.isArray(items))throw uiSelectMinErr("items","Expected an array but got '{0}'.",items);ctrl.refreshItems(items),angular.isDefined(ctrl.ngModel.$modelValue)&&(ctrl.ngModel.$modelValue=null)}})};var _refreshDelayPromise;ctrl.refresh=function(refreshAttr){void 0!==refreshAttr&&(_refreshDelayPromise&&$timeout.cancel(_refreshDelayPromise),_refreshDelayPromise=$timeout(function(){$scope.$eval(refreshAttr)},ctrl.refreshDelay))},ctrl.isActive=function(itemScope){if(!ctrl.open)return!1;var itemIndex=ctrl.items.indexOf(itemScope[ctrl.itemProperty]),isActive=itemIndex==ctrl.activeIndex;return!(!isActive||itemIndex<0)&&(isActive&&!angular.isUndefined(ctrl.onHighlightCallback)&&itemScope.$eval(ctrl.onHighlightCallback),isActive)};var _isItemSelected=function(item){return ctrl.selected&&angular.isArray(ctrl.selected)&&ctrl.selected.filter(function(selection){return angular.equals(selection,item)}).length>0},disabledItems=[];ctrl.isDisabled=function(itemScope){if(ctrl.open){var item=itemScope[ctrl.itemProperty],itemIndex=ctrl.items.indexOf(item),isDisabled=!1;if(itemIndex>=0&&(angular.isDefined(ctrl.disableChoiceExpression)||ctrl.multiple)){if(item.isTag)return!1;ctrl.multiple&&(isDisabled=_isItemSelected(item)),!isDisabled&&angular.isDefined(ctrl.disableChoiceExpression)&&(isDisabled=!!itemScope.$eval(ctrl.disableChoiceExpression)),_updateItemDisabled(item,isDisabled)}return isDisabled}},ctrl.select=function(item,skipFocusser,$event){if(void 0===item||!_isItemDisabled(item)){if(!ctrl.items&&!ctrl.search&&!ctrl.tagging.isActivated)return;if(!item||!_isItemDisabled(item)){if(ctrl.clickTriggeredSelect=!1,$event&&"click"===$event.type&&item&&(ctrl.clickTriggeredSelect=!0),ctrl.tagging.isActivated&&ctrl.clickTriggeredSelect===!1){if(ctrl.taggingLabel===!1)if(ctrl.activeIndex<0){if(void 0===item&&(item=void 0!==ctrl.tagging.fct?ctrl.tagging.fct(ctrl.search):ctrl.search),!item||angular.equals(ctrl.items[0],item))return}else item=ctrl.items[ctrl.activeIndex];else if(0===ctrl.activeIndex){if(void 0===item)return;if(void 0!==ctrl.tagging.fct&&"string"==typeof item){if(item=ctrl.tagging.fct(item),!item)return}else"string"==typeof item&&(item=item.replace(ctrl.taggingLabel,"").trim())}if(_isItemSelected(item))return void ctrl.close(skipFocusser)}_resetSearchInput(),$scope.$broadcast("uis:select",item);var locals={};locals[ctrl.parserResult.itemName]=item,$timeout(function(){ctrl.onSelectCallback($scope,{$item:item,$model:ctrl.parserResult.modelMapper($scope,locals)})}),ctrl.closeOnSelect&&ctrl.close(skipFocusser)}}},ctrl.close=function(skipFocusser){ctrl.open&&(ctrl.ngModel&&ctrl.ngModel.$setTouched&&ctrl.ngModel.$setTouched(),ctrl.open=!1,_resetSearchInput(),$scope.$broadcast("uis:close",skipFocusser))},ctrl.setFocus=function(){ctrl.focus||ctrl.focusInput[0].focus()},ctrl.clear=function($event){ctrl.select(void 0),$event.stopPropagation(),$timeout(function(){ctrl.focusser[0].focus()},0,!1)},ctrl.toggle=function(e){ctrl.open?(ctrl.close(),e.preventDefault(),e.stopPropagation()):ctrl.activate()},ctrl.isLocked=function(){return!1},$scope.$watch(function(){return angular.isDefined(ctrl.lockChoiceExpression)&&""!==ctrl.lockChoiceExpression;
},_initaliseLockedChoices);var sizeWatch=null,updaterScheduled=!1;ctrl.sizeSearchInput=function(){var input=ctrl.searchInput[0],container=ctrl.searchInput.parent().parent()[0],calculateContainerWidth=function(){return container.clientWidth*!!input.offsetParent},updateIfVisible=function(containerWidth){if(0===containerWidth)return!1;var inputWidth=containerWidth-input.offsetLeft-10;return inputWidth<50&&(inputWidth=containerWidth),ctrl.searchInput.css("width",inputWidth+"px"),!0};ctrl.searchInput.css("width","10px"),$timeout(function(){null!==sizeWatch||updateIfVisible(calculateContainerWidth())||(sizeWatch=$scope.$watch(function(){updaterScheduled||(updaterScheduled=!0,$scope.$$postDigest(function(){updaterScheduled=!1,updateIfVisible(calculateContainerWidth())&&(sizeWatch(),sizeWatch=null)}))},angular.noop))})},ctrl.searchInput.on("keydown",function(e){var key=e.which;~[KEY.ENTER,KEY.ESC].indexOf(key)&&(e.preventDefault(),e.stopPropagation()),$scope.$apply(function(){var tagged=!1;if((ctrl.items.length>0||ctrl.tagging.isActivated)&&(_handleDropDownSelection(key)||ctrl.searchEnabled||(e.preventDefault(),e.stopPropagation()),ctrl.taggingTokens.isActivated)){for(var i=0;i<ctrl.taggingTokens.tokens.length;i++)ctrl.taggingTokens.tokens[i]===KEY.MAP[e.keyCode]&&ctrl.search.length>0&&(tagged=!0);tagged&&$timeout(function(){ctrl.searchInput.triggerHandler("tagged");var newItem=ctrl.search.replace(KEY.MAP[e.keyCode],"").trim();ctrl.tagging.fct&&(newItem=ctrl.tagging.fct(newItem)),newItem&&ctrl.select(newItem,!0)})}}),KEY.isVerticalMovement(key)&&ctrl.items.length>0&&_ensureHighlightVisible(),key!==KEY.ENTER&&key!==KEY.ESC||(e.preventDefault(),e.stopPropagation())}),ctrl.searchInput.on("paste",function(e){var data;if(data=window.clipboardData&&window.clipboardData.getData?window.clipboardData.getData("Text"):(e.originalEvent||e).clipboardData.getData("text/plain"),data=ctrl.search+data,data&&data.length>0)if(ctrl.taggingTokens.isActivated){for(var items=[],i=0;i<ctrl.taggingTokens.tokens.length;i++){var separator=KEY.toSeparator(ctrl.taggingTokens.tokens[i])||ctrl.taggingTokens.tokens[i];if(data.indexOf(separator)>-1){items=data.split(separator);break}}0===items.length&&(items=[data]);var oldsearch=ctrl.search;angular.forEach(items,function(item){var newItem=ctrl.tagging.fct?ctrl.tagging.fct(item):item;newItem&&ctrl.select(newItem,!0)}),ctrl.search=oldsearch||EMPTY_SEARCH,e.preventDefault(),e.stopPropagation()}else ctrl.paste&&(ctrl.paste(data),ctrl.search=EMPTY_SEARCH,e.preventDefault(),e.stopPropagation())}),ctrl.searchInput.on("tagged",function(){$timeout(function(){_resetSearchInput()})});var onResize=$$uisDebounce(function(){ctrl.sizeSearchInput()},50);angular.element($window).bind("resize",onResize),$scope.$on("$destroy",function(){ctrl.searchInput.off("keyup keydown tagged blur paste"),angular.element($window).off("resize",onResize)})}]),uis.directive("uiSelect",["$document","uiSelectConfig","uiSelectMinErr","uisOffset","$compile","$parse","$timeout",function($document,uiSelectConfig,uiSelectMinErr,uisOffset,$compile,$parse,$timeout){return{restrict:"EA",templateUrl:function(tElement,tAttrs){var theme=tAttrs.theme||uiSelectConfig.theme;return theme+(angular.isDefined(tAttrs.multiple)?"/select-multiple.tpl.html":"/select.tpl.html")},replace:!0,transclude:!0,require:["uiSelect","^ngModel"],scope:!0,controller:"uiSelectCtrl",controllerAs:"$select",compile:function(tElement,tAttrs){var match=/{(.*)}\s*{(.*)}/.exec(tAttrs.ngClass);if(match){var combined="{"+match[1]+", "+match[2]+"}";tAttrs.ngClass=combined,tElement.attr("ng-class",combined)}return angular.isDefined(tAttrs.multiple)?tElement.append("<ui-select-multiple/>").removeAttr("multiple"):tElement.append("<ui-select-single/>"),tAttrs.inputId&&(tElement.querySelectorAll("input.ui-select-search")[0].id=tAttrs.inputId),function(scope,element,attrs,ctrls,transcludeFn){function onDocumentClick(e){if($select.open){var contains=!1;if(contains=window.jQuery?window.jQuery.contains(element[0],e.target):element[0].contains(e.target),!contains&&!$select.clickTriggeredSelect){var skipFocusser;if($select.skipFocusser)skipFocusser=!0;else{var focusableControls=["input","button","textarea","select"],targetController=angular.element(e.target).controller("uiSelect");skipFocusser=targetController&&targetController!==$select,skipFocusser||(skipFocusser=~focusableControls.indexOf(e.target.tagName.toLowerCase()))}$select.close(skipFocusser),scope.$digest()}$select.clickTriggeredSelect=!1}}function positionDropdown(){var offset=uisOffset(element);placeholder=angular.element('<div class="ui-select-placeholder"></div>'),placeholder[0].style.width=offset.width+"px",placeholder[0].style.height=offset.height+"px",element.after(placeholder),originalWidth=element[0].style.width,$document.find("body").append(element),element[0].style.position="absolute",element[0].style.left=offset.left+"px",element[0].style.top=offset.top+"px",element[0].style.width=offset.width+"px"}function resetDropdown(){null!==placeholder&&(placeholder.replaceWith(element),placeholder=null,element[0].style.position="",element[0].style.left="",element[0].style.top="",element[0].style.width=originalWidth,$select.setFocus())}var $select=ctrls[0],ngModel=ctrls[1];$select.generatedId=uiSelectConfig.generateId(),$select.baseTitle=attrs.title||"Select box",$select.focusserTitle=$select.baseTitle+" focus",$select.focusserId="focusser-"+$select.generatedId,$select.closeOnSelect=function(){return angular.isDefined(attrs.closeOnSelect)?$parse(attrs.closeOnSelect)():uiSelectConfig.closeOnSelect}(),scope.$watch("skipFocusser",function(){var skipFocusser=scope.$eval(attrs.skipFocusser);$select.skipFocusser=void 0!==skipFocusser?skipFocusser:uiSelectConfig.skipFocusser}),$select.onSelectCallback=$parse(attrs.onSelect),$select.onRemoveCallback=$parse(attrs.onRemove),$select.ngModel=ngModel,$select.choiceGrouped=function(group){return $select.isGrouped&&group&&group.name},attrs.tabindex&&attrs.$observe("tabindex",function(value){$select.focusInput.attr("tabindex",value),element.removeAttr("tabindex")}),scope.$watch(function(){return scope.$eval(attrs.searchEnabled)},function(newVal){$select.searchEnabled=void 0!==newVal?newVal:uiSelectConfig.searchEnabled}),scope.$watch("sortable",function(){var sortable=scope.$eval(attrs.sortable);$select.sortable=void 0!==sortable?sortable:uiSelectConfig.sortable}),attrs.$observe("limit",function(){$select.limit=angular.isDefined(attrs.limit)?parseInt(attrs.limit,10):void 0}),scope.$watch("removeSelected",function(){var removeSelected=scope.$eval(attrs.removeSelected);$select.removeSelected=void 0!==removeSelected?removeSelected:uiSelectConfig.removeSelected}),attrs.$observe("disabled",function(){$select.disabled=void 0!==attrs.disabled&&attrs.disabled}),attrs.$observe("resetSearchInput",function(){var resetSearchInput=scope.$eval(attrs.resetSearchInput);$select.resetSearchInput=void 0===resetSearchInput||resetSearchInput}),attrs.$observe("paste",function(){$select.paste=scope.$eval(attrs.paste)}),attrs.$observe("tagging",function(){if(void 0!==attrs.tagging){var taggingEval=scope.$eval(attrs.tagging);$select.tagging={isActivated:!0,fct:taggingEval!==!0?taggingEval:void 0}}else $select.tagging={isActivated:!1,fct:void 0}}),attrs.$observe("taggingLabel",function(){void 0!==attrs.tagging&&("false"===attrs.taggingLabel?$select.taggingLabel=!1:$select.taggingLabel=void 0!==attrs.taggingLabel?attrs.taggingLabel:"(new)")}),attrs.$observe("taggingTokens",function(){if(void 0!==attrs.tagging){var tokens=void 0!==attrs.taggingTokens?attrs.taggingTokens.split("|"):[",","ENTER"];$select.taggingTokens={isActivated:!0,tokens:tokens}}}),angular.isDefined(attrs.autofocus)&&$timeout(function(){$select.setFocus()}),angular.isDefined(attrs.focusOn)&&scope.$on(attrs.focusOn,function(){$timeout(function(){$select.setFocus()})}),$document.on("click",onDocumentClick),scope.$on("$destroy",function(){$document.off("click",onDocumentClick)}),transcludeFn(scope,function(clone){var transcluded=angular.element("<div>").append(clone),transcludedMatch=transcluded.querySelectorAll(".ui-select-match");if(transcludedMatch.removeAttr("ui-select-match"),transcludedMatch.removeAttr("data-ui-select-match"),1!==transcludedMatch.length)throw uiSelectMinErr("transcluded","Expected 1 .ui-select-match but got '{0}'.",transcludedMatch.length);element.querySelectorAll(".ui-select-match").replaceWith(transcludedMatch);var transcludedChoices=transcluded.querySelectorAll(".ui-select-choices");if(transcludedChoices.removeAttr("ui-select-choices"),transcludedChoices.removeAttr("data-ui-select-choices"),1!==transcludedChoices.length)throw uiSelectMinErr("transcluded","Expected 1 .ui-select-choices but got '{0}'.",transcludedChoices.length);element.querySelectorAll(".ui-select-choices").replaceWith(transcludedChoices);var transcludedNoChoice=transcluded.querySelectorAll(".ui-select-no-choice");transcludedNoChoice.removeAttr("ui-select-no-choice"),transcludedNoChoice.removeAttr("data-ui-select-no-choice"),1==transcludedNoChoice.length&&element.querySelectorAll(".ui-select-no-choice").replaceWith(transcludedNoChoice)});var appendToBody=scope.$eval(attrs.appendToBody);(void 0!==appendToBody?appendToBody:uiSelectConfig.appendToBody)&&(scope.$watch("$select.open",function(isOpen){isOpen?positionDropdown():resetDropdown()}),scope.$on("$destroy",function(){resetDropdown()}));var placeholder=null,originalWidth="",dropdown=null,directionUpClassName="direction-up";scope.$watch("$select.open",function(){"auto"!==$select.dropdownPosition&&"up"!==$select.dropdownPosition||scope.calculateDropdownPos()});var setDropdownPosUp=function(offset,offsetDropdown){offset=offset||uisOffset(element),offsetDropdown=offsetDropdown||uisOffset(dropdown),dropdown[0].style.position="absolute",dropdown[0].style.top=offsetDropdown.height*-1+"px",element.addClass(directionUpClassName)},setDropdownPosDown=function(offset,offsetDropdown){element.removeClass(directionUpClassName),offset=offset||uisOffset(element),offsetDropdown=offsetDropdown||uisOffset(dropdown),dropdown[0].style.position="",dropdown[0].style.top=""},calculateDropdownPosAfterAnimation=function(){$timeout(function(){if("up"===$select.dropdownPosition)setDropdownPosUp();else{element.removeClass(directionUpClassName);var offset=uisOffset(element),offsetDropdown=uisOffset(dropdown),scrollTop=$document[0].documentElement.scrollTop||$document[0].body.scrollTop;offset.top+offset.height+offsetDropdown.height>scrollTop+$document[0].documentElement.clientHeight?setDropdownPosUp(offset,offsetDropdown):setDropdownPosDown(offset,offsetDropdown)}dropdown[0].style.opacity=1})},opened=!1;scope.calculateDropdownPos=function(){if($select.open){if(dropdown=angular.element(element).querySelectorAll(".ui-select-dropdown"),0===dropdown.length)return;if(""!==$select.search||opened||(dropdown[0].style.opacity=0,opened=!0),!uisOffset(dropdown).height&&$select.$animate&&$select.$animate.on&&$select.$animate.enabled(dropdown)){var needsCalculated=!0;$select.$animate.on("enter",dropdown,function(elem,phase){"close"===phase&&needsCalculated&&(calculateDropdownPosAfterAnimation(),needsCalculated=!1)})}else calculateDropdownPosAfterAnimation()}else{if(null===dropdown||0===dropdown.length)return;dropdown[0].style.opacity=0,dropdown[0].style.position="",dropdown[0].style.top="",element.removeClass(directionUpClassName)}}}}}}]),uis.directive("uiSelectMatch",["uiSelectConfig",function(uiSelectConfig){function getAttribute(elem,attribute){return elem[0].hasAttribute(attribute)?elem.attr(attribute):elem[0].hasAttribute("data-"+attribute)?elem.attr("data-"+attribute):elem[0].hasAttribute("x-"+attribute)?elem.attr("x-"+attribute):void 0}return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(tElement){tElement.addClass("ui-select-match");var parent=tElement.parent(),theme=getAttribute(parent,"theme")||uiSelectConfig.theme,multi=angular.isDefined(getAttribute(parent,"multiple"));return theme+(multi?"/match-multiple.tpl.html":"/match.tpl.html")},link:function(scope,element,attrs,$select){function setAllowClear(allow){$select.allowClear=!!angular.isDefined(allow)&&(""===allow||"true"===allow.toLowerCase())}$select.lockChoiceExpression=attrs.uiLockChoice,attrs.$observe("placeholder",function(placeholder){$select.placeholder=void 0!==placeholder?placeholder:uiSelectConfig.placeholder}),attrs.$observe("allowClear",setAllowClear),setAllowClear(attrs.allowClear),$select.multiple&&$select.sizeSearchInput()}}}]),uis.directive("uiSelectMultiple",["uiSelectMinErr","$timeout",function(uiSelectMinErr,$timeout){return{restrict:"EA",require:["^uiSelect","^ngModel"],controller:["$scope","$timeout",function($scope,$timeout){var ngModel,ctrl=this,$select=$scope.$select;angular.isUndefined($select.selected)&&($select.selected=[]),$scope.$evalAsync(function(){ngModel=$scope.ngModel}),ctrl.activeMatchIndex=-1,ctrl.updateModel=function(){ngModel.$setViewValue(Date.now()),ctrl.refreshComponent()},ctrl.refreshComponent=function(){$select.refreshItems&&$select.refreshItems(),$select.sizeSearchInput&&$select.sizeSearchInput()},ctrl.removeChoice=function(index){if($select.isLocked(null,index))return!1;var removedChoice=$select.selected[index],locals={};return locals[$select.parserResult.itemName]=removedChoice,$select.selected.splice(index,1),ctrl.activeMatchIndex=-1,$select.sizeSearchInput(),$timeout(function(){$select.onRemoveCallback($scope,{$item:removedChoice,$model:$select.parserResult.modelMapper($scope,locals)})}),ctrl.updateModel(),!0},ctrl.getPlaceholder=function(){if(!$select.selected||!$select.selected.length)return $select.placeholder}}],controllerAs:"$selectMultiple",link:function(scope,element,attrs,ctrls){function _getCaretPosition(el){return angular.isNumber(el.selectionStart)?el.selectionStart:el.value.length}function _handleMatchSelection(key){function getNewActiveMatchIndex(){switch(key){case KEY.LEFT:return~$selectMultiple.activeMatchIndex?prev:last;case KEY.RIGHT:return~$selectMultiple.activeMatchIndex&&curr!==last?next:($select.activate(),!1);case KEY.BACKSPACE:return~$selectMultiple.activeMatchIndex?$selectMultiple.removeChoice(curr)?prev:curr:last;case KEY.DELETE:return!!~$selectMultiple.activeMatchIndex&&($selectMultiple.removeChoice($selectMultiple.activeMatchIndex),curr)}}var caretPosition=_getCaretPosition($select.searchInput[0]),length=$select.selected.length,first=0,last=length-1,curr=$selectMultiple.activeMatchIndex,next=$selectMultiple.activeMatchIndex+1,prev=$selectMultiple.activeMatchIndex-1,newIndex=curr;return!(caretPosition>0||$select.search.length&&key==KEY.RIGHT)&&($select.close(),newIndex=getNewActiveMatchIndex(),$select.selected.length&&newIndex!==!1?$selectMultiple.activeMatchIndex=Math.min(last,Math.max(first,newIndex)):$selectMultiple.activeMatchIndex=-1,!0)}function _findCaseInsensitiveDupe(arr){if(void 0===arr||void 0===$select.search)return!1;var hasDupe=arr.filter(function(origItem){return void 0!==$select.search.toUpperCase()&&void 0!==origItem&&origItem.toUpperCase()===$select.search.toUpperCase()}).length>0;return hasDupe}function _findApproxDupe(haystack,needle){var dupeIndex=-1;if(angular.isArray(haystack))for(var tempArr=angular.copy(haystack),i=0;i<tempArr.length;i++)if(void 0===$select.tagging.fct)tempArr[i]+" "+$select.taggingLabel===needle&&(dupeIndex=i);else{var mockObj=tempArr[i];angular.isObject(mockObj)&&(mockObj.isTag=!0),angular.equals(mockObj,needle)&&(dupeIndex=i)}return dupeIndex}var $select=ctrls[0],ngModel=scope.ngModel=ctrls[1],$selectMultiple=scope.$selectMultiple;$select.multiple=!0,$select.focusInput=$select.searchInput,ngModel.$isEmpty=function(value){return!value||0===value.length},ngModel.$parsers.unshift(function(){for(var result,locals={},resultMultiple=[],j=$select.selected.length-1;j>=0;j--)locals={},locals[$select.parserResult.itemName]=$select.selected[j],result=$select.parserResult.modelMapper(scope,locals),resultMultiple.unshift(result);return resultMultiple}),ngModel.$formatters.unshift(function(inputValue){var result,data=$select.parserResult&&$select.parserResult.source(scope,{$select:{search:""}}),locals={};if(!data)return inputValue;var resultMultiple=[],checkFnMultiple=function(list,value){if(list&&list.length){for(var p=list.length-1;p>=0;p--){if(locals[$select.parserResult.itemName]=list[p],result=$select.parserResult.modelMapper(scope,locals),$select.parserResult.trackByExp){var propsItemNameMatches=/(\w*)\./.exec($select.parserResult.trackByExp),matches=/\.([^\s]+)/.exec($select.parserResult.trackByExp);if(propsItemNameMatches&&propsItemNameMatches.length>0&&propsItemNameMatches[1]==$select.parserResult.itemName&&matches&&matches.length>0&&result[matches[1]]==value[matches[1]])return resultMultiple.unshift(list[p]),!0}if(angular.equals(result,value))return resultMultiple.unshift(list[p]),!0}return!1}};if(!inputValue)return resultMultiple;for(var k=inputValue.length-1;k>=0;k--)checkFnMultiple($select.selected,inputValue[k])||checkFnMultiple(data,inputValue[k])||resultMultiple.unshift(inputValue[k]);return resultMultiple}),scope.$watchCollection(function(){return ngModel.$modelValue},function(newValue,oldValue){oldValue!=newValue&&(angular.isDefined(ngModel.$modelValue)&&(ngModel.$modelValue=null),$selectMultiple.refreshComponent())}),ngModel.$render=function(){if(!angular.isArray(ngModel.$viewValue)){if(!angular.isUndefined(ngModel.$viewValue)&&null!==ngModel.$viewValue)throw uiSelectMinErr("multiarr","Expected model value to be array but got '{0}'",ngModel.$viewValue);ngModel.$viewValue=[]}$select.selected=ngModel.$viewValue,$selectMultiple.refreshComponent(),scope.$evalAsync()},scope.$on("uis:select",function(event,item){$select.selected.length>=$select.limit||($select.selected.push(item),$selectMultiple.updateModel())}),scope.$on("uis:activate",function(){$selectMultiple.activeMatchIndex=-1}),scope.$watch("$select.disabled",function(newValue,oldValue){oldValue&&!newValue&&$select.sizeSearchInput()}),$select.searchInput.on("keydown",function(e){var key=e.which;scope.$apply(function(){var processed=!1;KEY.isHorizontalMovement(key)&&(processed=_handleMatchSelection(key)),processed&&key!=KEY.TAB&&(e.preventDefault(),e.stopPropagation())})}),$select.searchInput.on("keyup",function(e){if(KEY.isVerticalMovement(e.which)||scope.$evalAsync(function(){$select.activeIndex=$select.taggingLabel===!1?-1:0}),$select.tagging.isActivated&&$select.search.length>0){if(e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.ESC||KEY.isVerticalMovement(e.which))return;if($select.activeIndex=$select.taggingLabel===!1?-1:0,$select.taggingLabel===!1)return;var newItem,item,tagItems,tagItem,items=angular.copy($select.items),stashArr=angular.copy($select.items),hasTag=!1,dupeIndex=-1;if(void 0!==$select.tagging.fct){if(tagItems=$select.$filter("filter")(items,{isTag:!0}),tagItems.length>0&&(tagItem=tagItems[0]),items.length>0&&tagItem&&(hasTag=!0,items=items.slice(1,items.length),stashArr=stashArr.slice(1,stashArr.length)),newItem=$select.tagging.fct($select.search),stashArr.some(function(origItem){return angular.equals(origItem,newItem)})||$select.selected.some(function(origItem){return angular.equals(origItem,newItem)}))return void scope.$evalAsync(function(){$select.activeIndex=0,$select.items=items});newItem&&(newItem.isTag=!0)}else{if(tagItems=$select.$filter("filter")(items,function(item){return item.match($select.taggingLabel)}),tagItems.length>0&&(tagItem=tagItems[0]),item=items[0],void 0!==item&&items.length>0&&tagItem&&(hasTag=!0,items=items.slice(1,items.length),stashArr=stashArr.slice(1,stashArr.length)),newItem=$select.search+" "+$select.taggingLabel,_findApproxDupe($select.selected,$select.search)>-1)return;if(_findCaseInsensitiveDupe(stashArr.concat($select.selected)))return void(hasTag&&(items=stashArr,scope.$evalAsync(function(){$select.activeIndex=0,$select.items=items})));if(_findCaseInsensitiveDupe(stashArr))return void(hasTag&&($select.items=stashArr.slice(1,stashArr.length)))}hasTag&&(dupeIndex=_findApproxDupe($select.selected,newItem)),dupeIndex>-1?items=items.slice(dupeIndex+1,items.length-1):(items=[],newItem&&items.push(newItem),items=items.concat(stashArr)),scope.$evalAsync(function(){if($select.activeIndex=0,$select.items=items,$select.isGrouped){var itemsWithoutTag=newItem?items.slice(1):items;$select.setItemsFn(itemsWithoutTag),newItem&&($select.items.unshift(newItem),$select.groups.unshift({name:"",items:[newItem],tagging:!0}))}})}}),$select.searchInput.on("blur",function(){$timeout(function(){$selectMultiple.activeMatchIndex=-1})})}}}]),uis.directive("uiSelectNoChoice",["uiSelectConfig",function(uiSelectConfig){return{restrict:"EA",require:"^uiSelect",replace:!0,transclude:!0,templateUrl:function(tElement){tElement.addClass("ui-select-no-choice");var theme=tElement.parent().attr("theme")||uiSelectConfig.theme;return theme+"/no-choice.tpl.html"}}}]),uis.directive("uiSelectSingle",["$timeout","$compile",function($timeout,$compile){return{restrict:"EA",require:["^uiSelect","^ngModel"],link:function(scope,element,attrs,ctrls){var $select=ctrls[0],ngModel=ctrls[1];ngModel.$parsers.unshift(function(inputValue){var result,locals={};return locals[$select.parserResult.itemName]=inputValue,result=$select.parserResult.modelMapper(scope,locals)}),ngModel.$formatters.unshift(function(inputValue){var result,data=$select.parserResult&&$select.parserResult.source(scope,{$select:{search:""}}),locals={};if(data){var checkFnSingle=function(d){return locals[$select.parserResult.itemName]=d,result=$select.parserResult.modelMapper(scope,locals),result===inputValue};if($select.selected&&checkFnSingle($select.selected))return $select.selected;for(var i=data.length-1;i>=0;i--)if(checkFnSingle(data[i]))return data[i]}return inputValue}),scope.$watch("$select.selected",function(newValue){ngModel.$viewValue!==newValue&&ngModel.$setViewValue(newValue)}),ngModel.$render=function(){$select.selected=ngModel.$viewValue},scope.$on("uis:select",function(event,item){$select.selected=item}),scope.$on("uis:close",function(event,skipFocusser){$timeout(function(){$select.focusser.prop("disabled",!1),skipFocusser||$select.focusser[0].focus()},0,!1)}),scope.$on("uis:activate",function(){focusser.prop("disabled",!0)});var focusser=angular.element("<input ng-disabled='$select.disabled' class='ui-select-focusser ui-select-offscreen' type='text' id='{{ $select.focusserId }}' aria-label='{{ $select.focusserTitle }}' aria-haspopup='true' role='button' />");$compile(focusser)(scope),$select.focusser=focusser,$select.focusInput=focusser,element.parent().append(focusser),focusser.bind("focus",function(){scope.$evalAsync(function(){$select.focus=!0})}),focusser.bind("blur",function(){scope.$evalAsync(function(){$select.focus=!1})}),focusser.bind("keydown",function(e){return e.which===KEY.BACKSPACE?(e.preventDefault(),e.stopPropagation(),$select.select(void 0),void scope.$apply()):void(e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.ESC||(e.which!=KEY.DOWN&&e.which!=KEY.UP&&e.which!=KEY.ENTER&&e.which!=KEY.SPACE||(e.preventDefault(),e.stopPropagation(),$select.activate()),scope.$digest()))}),focusser.bind("keyup input",function(e){e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.ESC||e.which==KEY.ENTER||e.which===KEY.BACKSPACE||($select.activate(focusser.val()),focusser.val(""),scope.$digest())})}}}]),uis.directive("uiSelectSort",["$timeout","uiSelectConfig","uiSelectMinErr",function($timeout,uiSelectConfig,uiSelectMinErr){return{require:["^^uiSelect","^ngModel"],link:function(scope,element,attrs,ctrls){if(null===scope[attrs.uiSelectSort])throw uiSelectMinErr("sort","Expected a list to sort");var $select=ctrls[0],$ngModel=ctrls[1],options=angular.extend({axis:"horizontal"},scope.$eval(attrs.uiSelectSortOptions)),axis=options.axis,draggingClassName="dragging",droppingClassName="dropping",droppingBeforeClassName="dropping-before",droppingAfterClassName="dropping-after";scope.$watch(function(){return $select.sortable},function(newValue){newValue?element.attr("draggable",!0):element.removeAttr("draggable")}),element.on("dragstart",function(event){element.addClass(draggingClassName),(event.dataTransfer||event.originalEvent.dataTransfer).setData("text",scope.$index.toString())}),element.on("dragend",function(){removeClass(draggingClassName)});var dropTimeout,move=function(from,to){this.splice(to,0,this.splice(from,1)[0])},removeClass=function(className){angular.forEach($select.$element.querySelectorAll("."+className),function(el){angular.element(el).removeClass(className)})},dragOverHandler=function(event){event.preventDefault();var offset="vertical"===axis?event.offsetY||event.layerY||(event.originalEvent?event.originalEvent.offsetY:0):event.offsetX||event.layerX||(event.originalEvent?event.originalEvent.offsetX:0);offset<this["vertical"===axis?"offsetHeight":"offsetWidth"]/2?(removeClass(droppingAfterClassName),element.addClass(droppingBeforeClassName)):(removeClass(droppingBeforeClassName),element.addClass(droppingAfterClassName))},dropHandler=function(event){event.preventDefault();var droppedItemIndex=parseInt((event.dataTransfer||event.originalEvent.dataTransfer).getData("text"),10);$timeout.cancel(dropTimeout),dropTimeout=$timeout(function(){_dropHandler(droppedItemIndex)},20)},_dropHandler=function(droppedItemIndex){var theList=scope.$eval(attrs.uiSelectSort),itemToMove=theList[droppedItemIndex],newIndex=null;newIndex=element.hasClass(droppingBeforeClassName)?droppedItemIndex<scope.$index?scope.$index-1:scope.$index:droppedItemIndex<scope.$index?scope.$index:scope.$index+1,move.apply(theList,[droppedItemIndex,newIndex]),$ngModel.$setViewValue(Date.now()),scope.$apply(function(){scope.$emit("uiSelectSort:change",{array:theList,item:itemToMove,from:droppedItemIndex,to:newIndex})}),removeClass(droppingClassName),removeClass(droppingBeforeClassName),removeClass(droppingAfterClassName),element.off("drop",dropHandler)};element.on("dragenter",function(){element.hasClass(draggingClassName)||(element.addClass(droppingClassName),element.on("dragover",dragOverHandler),element.on("drop",dropHandler))}),element.on("dragleave",function(event){event.target==element&&(removeClass(droppingClassName),removeClass(droppingBeforeClassName),removeClass(droppingAfterClassName),element.off("dragover",dragOverHandler),element.off("drop",dropHandler))})}}}]),uis.factory("$$uisDebounce",["$timeout",function($timeout){return function(callback,debounceTime){var timeoutPromise;return function(){var self=this,args=Array.prototype.slice.call(arguments);timeoutPromise&&$timeout.cancel(timeoutPromise),timeoutPromise=$timeout(function(){callback.apply(self,args)},debounceTime)}}}]),uis.directive("uisOpenClose",["$parse","$timeout",function($parse,$timeout){return{restrict:"A",require:"uiSelect",link:function(scope,element,attrs,$select){$select.onOpenCloseCallback=$parse(attrs.uisOpenClose),scope.$watch("$select.open",function(isOpen,previousState){isOpen!==previousState&&$timeout(function(){$select.onOpenCloseCallback(scope,{isOpen:isOpen})})})}}}]),uis.service("uisRepeatParser",["uiSelectMinErr","$parse",function(uiSelectMinErr,$parse){var self=this;self.parse=function(expression){var match;if(match=expression.match(/^\s*(?:([\s\S]+?)\s+as\s+)?(?:([\$\w][\$\w]*)|(?:\(\s*([\$\w][\$\w]*)\s*,\s*([\$\w][\$\w]*)\s*\)))\s+in\s+(\s*[\s\S]+?)?(?:\s+track\s+by\s+([\s\S]+?))?\s*$/),!match)throw uiSelectMinErr("iexp","Expected expression in form of '_item_ in _collection_[ track by _id_]' but got '{0}'.",expression);var source=match[5],filters="";if(match[3]){source=match[5].replace(/(^\()|(\)$)/g,"");var filterMatch=match[5].match(/^\s*(?:[\s\S]+?)(?:[^\|]|\|\|)+([\s\S]*)\s*$/);filterMatch&&filterMatch[1].trim()&&(filters=filterMatch[1],source=source.replace(filters,""))}return{itemName:match[4]||match[2],keyName:match[3],source:$parse(source),filters:filters,trackByExp:match[6],modelMapper:$parse(match[1]||match[4]||match[2]),repeatExpression:function(grouped){var expression=this.itemName+" in "+(grouped?"$group.items":"$select.items");return this.trackByExp&&(expression+=" track by "+this.trackByExp),expression}}},self.getGroupNgRepeatExpression=function(){return"$group in $select.groups track by $group.name"}}])}(),angular.module("ui.select").run(["$templateCache",function($templateCache){$templateCache.put("bootstrap/choices.tpl.html",'<ul class="ui-select-choices ui-select-choices-content ui-select-dropdown dropdown-menu" role="listbox" ng-show="$select.open && $select.items.length > 0"><li class="ui-select-choices-group" id="ui-select-choices-{{ $select.generatedId }}"><div class="divider" ng-show="$select.isGrouped && $index > 0"></div><div ng-show="$select.isGrouped" class="ui-select-choices-group-label dropdown-header" ng-bind="$group.name"></div><div ng-attr-id="ui-select-choices-row-{{ $select.generatedId }}-{{$index}}" class="ui-select-choices-row" ng-class="{active: $select.isActive(this), disabled: $select.isDisabled(this)}" role="option"><span class="ui-select-choices-row-inner"></span></div></li></ul>'),$templateCache.put("bootstrap/match-multiple.tpl.html",'<span class="ui-select-match"><span ng-repeat="$item in $select.selected track by $index"><span class="ui-select-match-item btn btn-default btn-xs" tabindex="-1" type="button" ng-disabled="$select.disabled" ng-click="$selectMultiple.activeMatchIndex = $index;" ng-class="{\'btn-primary\':$selectMultiple.activeMatchIndex === $index, \'select-locked\':$select.isLocked(this, $index)}" ui-select-sort="$select.selected"><span class="close ui-select-match-close" ng-hide="$select.disabled" ng-click="$selectMultiple.removeChoice($index)">&nbsp;&times;</span> <span uis-transclude-append=""></span></span></span></span>'),$templateCache.put("bootstrap/match.tpl.html",'<div class="ui-select-match" ng-hide="$select.open && $select.searchEnabled" ng-disabled="$select.disabled" ng-class="{\'btn-default-focus\':$select.focus}"><span tabindex="-1" class="btn btn-default form-control ui-select-toggle" aria-label="{{ $select.baseTitle }} activate" ng-disabled="$select.disabled" ng-click="$select.activate()" style="outline: 0;"><span ng-show="$select.isEmpty()" class="ui-select-placeholder text-muted">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty()" class="ui-select-match-text pull-left" ng-class="{\'ui-select-allow-clear\': $select.allowClear && !$select.isEmpty()}" ng-transclude=""></span> <i class="caret pull-right" ng-click="$select.toggle($event)"></i> <a ng-show="$select.allowClear && !$select.isEmpty() && ($select.disabled !== true)" aria-label="{{ $select.baseTitle }} clear" style="margin-right: 10px" ng-click="$select.clear($event)" class="btn btn-xs btn-link pull-right"><i class="glyphicon glyphicon-remove" aria-hidden="true"></i></a></span></div>'),$templateCache.put("bootstrap/no-choice.tpl.html",'<ul class="ui-select-no-choice dropdown-menu" ng-show="$select.items.length == 0"><li ng-transclude=""></li></ul>'),$templateCache.put("bootstrap/select-multiple.tpl.html",'<div class="ui-select-container ui-select-multiple ui-select-bootstrap dropdown form-control" ng-class="{open: $select.open}"><div><div class="ui-select-match"></div><input type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="ui-select-search input-xs" placeholder="{{$selectMultiple.getPlaceholder()}}" ng-disabled="$select.disabled" ng-click="$select.activate()" ng-model="$select.search" role="combobox" aria-label="{{ $select.baseTitle }}" ondrop="return false;"></div><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div>'),$templateCache.put("bootstrap/select.tpl.html",'<div class="ui-select-container ui-select-bootstrap dropdown" ng-class="{open: $select.open}"><div class="ui-select-match"></div><input type="search" autocomplete="off" tabindex="-1" aria-expanded="true" aria-label="{{ $select.baseTitle }}" aria-owns="ui-select-choices-{{ $select.generatedId }}" aria-activedescendant="ui-select-choices-row-{{ $select.generatedId }}-{{ $select.activeIndex }}" class="form-control ui-select-search" ng-class="{ \'ui-select-search-hidden\' : !$select.searchEnabled }" placeholder="{{$select.placeholder}}" ng-model="$select.search" ng-show="$select.open"><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div>'),
$templateCache.put("select2/choices.tpl.html",'<ul tabindex="-1" class="ui-select-choices ui-select-choices-content select2-results"><li class="ui-select-choices-group" ng-class="{\'select2-result-with-children\': $select.choiceGrouped($group) }"><div ng-show="$select.choiceGrouped($group)" class="ui-select-choices-group-label select2-result-label" ng-bind="$group.name"></div><ul role="listbox" id="ui-select-choices-{{ $select.generatedId }}" ng-class="{\'select2-result-sub\': $select.choiceGrouped($group), \'select2-result-single\': !$select.choiceGrouped($group) }"><li role="option" ng-attr-id="ui-select-choices-row-{{ $select.generatedId }}-{{$index}}" class="ui-select-choices-row" ng-class="{\'select2-highlighted\': $select.isActive(this), \'select2-disabled\': $select.isDisabled(this)}"><div class="select2-result-label ui-select-choices-row-inner"></div></li></ul></li></ul>'),$templateCache.put("select2/match-multiple.tpl.html",'<span class="ui-select-match"><li class="ui-select-match-item select2-search-choice" ng-repeat="$item in $select.selected track by $index" ng-class="{\'select2-search-choice-focus\':$selectMultiple.activeMatchIndex === $index, \'select2-locked\':$select.isLocked(this, $index)}" ui-select-sort="$select.selected"><span uis-transclude-append=""></span> <a href="javascript:;" class="ui-select-match-close select2-search-choice-close" ng-click="$selectMultiple.removeChoice($index)" tabindex="-1"></a></li></span>'),$templateCache.put("select2/match.tpl.html",'<a class="select2-choice ui-select-match" ng-class="{\'select2-default\': $select.isEmpty()}" ng-click="$select.toggle($event)" aria-label="{{ $select.baseTitle }} select"><span ng-show="$select.isEmpty()" class="select2-chosen">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty()" class="select2-chosen" ng-transclude=""></span> <abbr ng-if="$select.allowClear && !$select.isEmpty()" class="select2-search-choice-close" ng-click="$select.clear($event)"></abbr> <span class="select2-arrow ui-select-toggle"><b></b></span></a>'),$templateCache.put("select2/no-choice.tpl.html",'<div class="ui-select-no-choice dropdown" ng-show="$select.items.length == 0"><div class="dropdown-content"><div data-selectable="" ng-transclude=""></div></div></div>'),$templateCache.put("select2/select-multiple.tpl.html",'<div class="ui-select-container ui-select-multiple select2 select2-container select2-container-multi" ng-class="{\'select2-container-active select2-dropdown-open open\': $select.open, \'select2-container-disabled\': $select.disabled}"><ul class="select2-choices"><span class="ui-select-match"></span><li class="select2-search-field"><input type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="combobox" aria-expanded="true" aria-owns="ui-select-choices-{{ $select.generatedId }}" aria-label="{{ $select.baseTitle }}" aria-activedescendant="ui-select-choices-row-{{ $select.generatedId }}-{{ $select.activeIndex }}" class="select2-input ui-select-search" placeholder="{{$selectMultiple.getPlaceholder()}}" ng-disabled="$select.disabled" ng-hide="$select.disabled" ng-model="$select.search" ng-click="$select.activate()" style="width: 34px;" ondrop="return false;"></li></ul><div class="ui-select-dropdown select2-drop select2-with-searchbox select2-drop-active" ng-class="{\'select2-display-none\': !$select.open || $select.items.length === 0}"><div class="ui-select-choices"></div></div></div>'),$templateCache.put("select2/select.tpl.html",'<div class="ui-select-container select2 select2-container" ng-class="{\'select2-container-active select2-dropdown-open open\': $select.open, \'select2-container-disabled\': $select.disabled, \'select2-container-active\': $select.focus, \'select2-allowclear\': $select.allowClear && !$select.isEmpty()}"><div class="ui-select-match"></div><div class="ui-select-dropdown select2-drop select2-with-searchbox select2-drop-active" ng-class="{\'select2-display-none\': !$select.open}"><div class="search-container" ng-class="{\'ui-select-search-hidden\':!$select.searchEnabled, \'select2-search\':$select.searchEnabled}"><input type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="combobox" aria-expanded="true" aria-owns="ui-select-choices-{{ $select.generatedId }}" aria-label="{{ $select.baseTitle }}" aria-activedescendant="ui-select-choices-row-{{ $select.generatedId }}-{{ $select.activeIndex }}" class="ui-select-search select2-input" ng-model="$select.search"></div><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div></div>'),$templateCache.put("selectize/choices.tpl.html",'<div ng-show="$select.open" class="ui-select-choices ui-select-dropdown selectize-dropdown single"><div class="ui-select-choices-content selectize-dropdown-content"><div class="ui-select-choices-group optgroup" role="listbox"><div ng-show="$select.isGrouped" class="ui-select-choices-group-label optgroup-header" ng-bind="$group.name"></div><div role="option" class="ui-select-choices-row" ng-class="{active: $select.isActive(this), disabled: $select.isDisabled(this)}"><div class="option ui-select-choices-row-inner" data-selectable=""></div></div></div></div></div>'),$templateCache.put("selectize/match.tpl.html",'<div ng-hide="$select.searchEnabled && ($select.open || $select.isEmpty())" class="ui-select-match"><span ng-show="!$select.searchEnabled && ($select.isEmpty() || $select.open)" class="ui-select-placeholder text-muted">{{$select.placeholder}}</span> <span ng-hide="$select.isEmpty() || $select.open" ng-transclude=""></span></div>'),$templateCache.put("selectize/no-choice.tpl.html",'<div class="ui-select-no-choice selectize-dropdown" ng-show="$select.items.length == 0"><div class="selectize-dropdown-content"><div data-selectable="" ng-transclude=""></div></div></div>'),$templateCache.put("selectize/select.tpl.html",'<div class="ui-select-container selectize-control single" ng-class="{\'open\': $select.open}"><div class="selectize-input" ng-class="{\'focus\': $select.open, \'disabled\': $select.disabled, \'selectize-focus\' : $select.focus}" ng-click="$select.open && !$select.searchEnabled ? $select.toggle($event) : $select.activate()"><div class="ui-select-match"></div><input type="search" autocomplete="off" tabindex="-1" class="ui-select-search ui-select-toggle" ng-class="{\'ui-select-search-hidden\':!$select.searchEnabled}" ng-click="$select.toggle($event)" placeholder="{{$select.placeholder}}" ng-model="$select.search" ng-hide="!$select.isEmpty() && !$select.open" ng-disabled="$select.disabled" aria-label="{{ $select.baseTitle }}"></div><div class="ui-select-choices"></div><div class="ui-select-no-choice"></div></div>')}]),!function(){angular.module("as.sortable",[]).constant("sortableConfig",{itemClass:"as-sortable-item",handleClass:"as-sortable-item-handle",placeHolderClass:"as-sortable-placeholder",dragClass:"as-sortable-drag",hiddenClass:"as-sortable-hidden",dragging:"as-sortable-dragging"})}(),function(){var mainModule=angular.module("as.sortable");mainModule.factory("$helper",["$document","$window",function($document,$window){return{height:function(element){return element[0].getBoundingClientRect().height},width:function(element){return element[0].getBoundingClientRect().width},offset:function(element,scrollableContainer){var boundingClientRect=element[0].getBoundingClientRect();return scrollableContainer||(scrollableContainer=$document[0].documentElement),{width:boundingClientRect.width||element.prop("offsetWidth"),height:boundingClientRect.height||element.prop("offsetHeight"),top:boundingClientRect.top+($window.pageYOffset||scrollableContainer.scrollTop-scrollableContainer.offsetTop),left:boundingClientRect.left+($window.pageXOffset||scrollableContainer.scrollLeft-scrollableContainer.offsetLeft)}},eventObj:function(event){var obj=event;return void 0!==event.targetTouches?obj=event.targetTouches.item(0):void 0!==event.originalEvent&&void 0!==event.originalEvent.targetTouches&&(obj=event.originalEvent.targetTouches.item(0)),obj},isTouchInvalid:function(event){var touchInvalid=!1;return void 0!==event.touches&&event.touches.length>1?touchInvalid=!0:void 0!==event.originalEvent&&void 0!==event.originalEvent.touches&&event.originalEvent.touches.length>1&&(touchInvalid=!0),touchInvalid},positionStarted:function(event,target,scrollableContainer){var pos={};return pos.offsetX=event.pageX-this.offset(target,scrollableContainer).left,pos.offsetY=event.pageY-this.offset(target,scrollableContainer).top,pos.startX=pos.lastX=event.pageX,pos.startY=pos.lastY=event.pageY,pos.nowX=pos.nowY=pos.distX=pos.distY=pos.dirAx=0,pos.dirX=pos.dirY=pos.lastDirX=pos.lastDirY=pos.distAxX=pos.distAxY=0,pos},calculatePosition:function(pos,event){pos.lastX=pos.nowX,pos.lastY=pos.nowY,pos.nowX=event.pageX,pos.nowY=event.pageY,pos.distX=pos.nowX-pos.lastX,pos.distY=pos.nowY-pos.lastY,pos.lastDirX=pos.dirX,pos.lastDirY=pos.dirY,pos.dirX=0===pos.distX?0:pos.distX>0?1:-1,pos.dirY=0===pos.distY?0:pos.distY>0?1:-1;var newAx=Math.abs(pos.distX)>Math.abs(pos.distY)?1:0;pos.dirAx!==newAx?(pos.distAxX=0,pos.distAxY=0):(pos.distAxX+=Math.abs(pos.distX),0!==pos.dirX&&pos.dirX!==pos.lastDirX&&(pos.distAxX=0),pos.distAxY+=Math.abs(pos.distY),0!==pos.dirY&&pos.dirY!==pos.lastDirY&&(pos.distAxY=0)),pos.dirAx=newAx},movePosition:function(event,element,pos,container,containerPositioning,scrollableContainer){var bounds,useRelative="relative"===containerPositioning;element.x=event.pageX-pos.offsetX,element.y=event.pageY-pos.offsetY,container&&(bounds=this.offset(container,scrollableContainer),useRelative&&(element.x-=bounds.left,element.y-=bounds.top,bounds.left=0,bounds.top=0),element.x<bounds.left?element.x=bounds.left:element.x>=bounds.width+bounds.left-this.offset(element).width&&(element.x=bounds.width+bounds.left-this.offset(element).width),element.y<bounds.top?element.y=bounds.top:element.y>=bounds.height+bounds.top-this.offset(element).height&&(element.y=bounds.height+bounds.top-this.offset(element).height)),element.css({left:element.x+"px",top:element.y+"px"}),this.calculatePosition(pos,event)},dragItem:function(item){return{index:item.index(),parent:item.sortableScope,source:item,targetElement:null,targetElementOffset:null,sourceInfo:{index:item.index(),itemScope:item.itemScope,sortableScope:item.sortableScope},canMove:function(itemPosition,targetElement,targetElementOffset){return this.targetElement!==targetElement?(this.targetElement=targetElement,this.targetElementOffset=targetElementOffset,!0):(itemPosition.dirX*(targetElementOffset.left-this.targetElementOffset.left)>0||itemPosition.dirY*(targetElementOffset.top-this.targetElementOffset.top)>0)&&(this.targetElementOffset=targetElementOffset,!0)},moveTo:function(parent,index){this.parent=parent,this.isSameParent()&&this.source.index()<index&&!this.sourceInfo.sortableScope.cloning&&(index-=1),this.index=index},isSameParent:function(){return this.parent.element===this.sourceInfo.sortableScope.element},isOrderChanged:function(){return this.index!==this.sourceInfo.index},eventArgs:function(){return{source:this.sourceInfo,dest:{index:this.index,sortableScope:this.parent}}},apply:function(){this.sourceInfo.sortableScope.cloning?this.parent.options.clone||this.parent.insertItem(this.index,angular.copy(this.source.modelValue)):(this.sourceInfo.sortableScope.removeItem(this.sourceInfo.index),(this.parent.options.allowDuplicates||this.parent.modelValue.indexOf(this.source.modelValue)<0)&&this.parent.insertItem(this.index,this.source.modelValue))}}},noDrag:function(element){return void 0!==element.attr("no-drag")||void 0!==element.attr("data-no-drag")},findAncestor:function(el,selector){el=el[0];for(var matches=Element.matches||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector;(el=el.parentElement)&&!matches.call(el,selector););return el?angular.element(el):angular.element(document.body)}}}])}(),function(){var mainModule=angular.module("as.sortable");mainModule.controller("as.sortable.sortableController",["$scope",function($scope){this.scope=$scope,$scope.modelValue=null,$scope.callbacks=null,$scope.type="sortable",$scope.options={longTouch:!1},$scope.isDisabled=!1,$scope.insertItem=function(index,itemData){$scope.options.allowDuplicates?$scope.modelValue.splice(index,0,angular.copy(itemData)):$scope.modelValue.splice(index,0,itemData)},$scope.removeItem=function(index){var removedItem=null;return index>-1&&(removedItem=$scope.modelValue.splice(index,1)[0]),removedItem},$scope.isEmpty=function(){return $scope.modelValue&&0===$scope.modelValue.length},$scope.accept=function(sourceItemHandleScope,destScope,destItemScope){return $scope.callbacks.accept(sourceItemHandleScope,destScope,destItemScope)}}]),mainModule.directive("asSortable",function(){return{require:"ngModel",restrict:"A",scope:!0,controller:"as.sortable.sortableController",link:function(scope,element,attrs,ngModelController){var ngModel,callbacks;ngModel=ngModelController,ngModel&&(ngModel.$render=function(){scope.modelValue=ngModel.$modelValue},scope.element=element,element.data("_scope",scope),callbacks={accept:null,orderChanged:null,itemMoved:null,dragStart:null,dragMove:null,dragCancel:null,dragEnd:null},callbacks.accept=function(sourceItemHandleScope,destSortableScope,destItemScope){return!0},callbacks.orderChanged=function(event){},callbacks.itemMoved=function(event){},callbacks.dragStart=function(event){},callbacks.dragMove=angular.noop,callbacks.dragCancel=function(event){},callbacks.dragEnd=function(event){},scope.$watch(attrs.asSortable,function(newVal,oldVal){angular.forEach(newVal,function(value,key){callbacks[key]?"function"==typeof value&&(callbacks[key]=value):scope.options[key]=value}),scope.callbacks=callbacks},!0),angular.isDefined(attrs.isDisabled)&&scope.$watch(attrs.isDisabled,function(newVal,oldVal){angular.isUndefined(newVal)||(scope.isDisabled=newVal)},!0))}}})}(),function(){function isParent(possibleParent,elem){return!(!elem||"HTML"===elem.nodeName)&&(elem.parentNode===possibleParent||isParent(possibleParent,elem.parentNode))}var mainModule=angular.module("as.sortable");mainModule.controller("as.sortable.sortableItemHandleController",["$scope",function($scope){this.scope=$scope,$scope.itemScope=null,$scope.type="handle"}]),mainModule.directive("asSortableItemHandle",["sortableConfig","$helper","$window","$document","$timeout",function(sortableConfig,$helper,$window,$document,$timeout){return{require:"^asSortableItem",scope:!0,restrict:"A",controller:"as.sortable.sortableItemHandleController",link:function(scope,element,attrs,itemController){function insertBefore(targetElement,targetScope){"table-row"!==placeHolder.css("display")&&placeHolder.css("display","block"),targetScope.sortableScope.options.clone||(targetElement[0].parentNode.insertBefore(placeHolder[0],targetElement[0]),dragItemInfo.moveTo(targetScope.sortableScope,targetScope.index()))}function insertAfter(targetElement,targetScope){"table-row"!==placeHolder.css("display")&&placeHolder.css("display","block"),targetScope.sortableScope.options.clone||(targetElement.after(placeHolder),dragItemInfo.moveTo(targetScope.sortableScope,targetScope.index()+1))}function fetchScope(element){for(var scope;!scope&&element.length;)scope=element.data("_scope"),scope||(element=element.parent());return scope}function rollbackDragChanges(){scope.itemScope.sortableScope.cloning||placeElement.replaceWith(scope.itemScope.element),placeHolder.remove(),dragElement.remove(),dragElement=null,dragHandled=!1,containment.css("cursor",""),containment.removeClass("as-sortable-un-selectable")}var dragElement,placeHolder,placeElement,itemPosition,dragItemInfo,containment,containerPositioning,dragListen,scrollableContainer,dragStart,dragMove,dragEnd,dragCancel,isDraggable,placeHolderIndex,bindDrag,unbindDrag,bindEvents,unBindEvents,hasTouch,isIOS,longTouchStart,longTouchCancel,longTouchTimer,dragHandled,createPlaceholder,isPlaceHolderPresent,escapeListen,isDisabled=!1,isLongTouch=!1;hasTouch="ontouchstart"in $window,isIOS=/iPad|iPhone|iPod/.test($window.navigator.userAgent)&&!$window.MSStream,sortableConfig.handleClass&&element.addClass(sortableConfig.handleClass),scope.itemScope=itemController.scope,element.data("_scope",scope),scope.$watchGroup(["sortableScope.isDisabled","sortableScope.options.longTouch"],function(newValues){isDisabled!==newValues[0]?(isDisabled=newValues[0],isDisabled?unbindDrag():bindDrag()):isLongTouch!==newValues[1]?(isLongTouch=newValues[1],unbindDrag(),bindDrag()):bindDrag()}),scope.$on("$destroy",function(){angular.element($document[0].body).unbind("keydown",escapeListen)}),createPlaceholder=function(itemScope){return"function"==typeof scope.sortableScope.options.placeholder?angular.element(scope.sortableScope.options.placeholder(itemScope)):"string"==typeof scope.sortableScope.options.placeholder?angular.element(scope.sortableScope.options.placeholder):angular.element($document[0].createElement(itemScope.element.prop("tagName")))},dragListen=function(event){var startPosition,unbindMoveListen=function(){angular.element($document).unbind("mousemove",moveListen),angular.element($document).unbind("touchmove",moveListen),element.unbind("mouseup",unbindMoveListen),element.unbind("touchend",unbindMoveListen),element.unbind("touchcancel",unbindMoveListen)},moveListen=function(e){e.preventDefault();var eventObj=$helper.eventObj(e);startPosition||(startPosition={clientX:eventObj.clientX,clientY:eventObj.clientY}),Math.abs(eventObj.clientX-startPosition.clientX)+Math.abs(eventObj.clientY-startPosition.clientY)>10&&(unbindMoveListen(),dragStart(event))};angular.element($document).bind("mousemove",moveListen),angular.element($document).bind("touchmove",moveListen),element.bind("mouseup",unbindMoveListen),element.bind("touchend",unbindMoveListen),element.bind("touchcancel",unbindMoveListen),event.stopPropagation()},dragStart=function(event){var eventObj,tagName;(hasTouch||2!==event.button&&3!==event.which)&&(hasTouch&&$helper.isTouchInvalid(event)||!dragHandled&&isDraggable(event)&&(dragHandled=!0,event.preventDefault(),eventObj=$helper.eventObj(event),scope.sortableScope=scope.sortableScope||scope.itemScope.sortableScope,scope.callbacks=scope.callbacks||scope.itemScope.callbacks,scope.itemScope.sortableScope.options.clone||scope.itemScope.sortableScope.options.ctrlClone&&event.ctrlKey?scope.itemScope.sortableScope.cloning=!0:scope.itemScope.sortableScope.cloning=!1,scrollableContainer=angular.element($document[0].querySelector(scope.sortableScope.options.scrollableContainer)).length>0?$document[0].querySelector(scope.sortableScope.options.scrollableContainer):$document[0].documentElement,containment=scope.sortableScope.options.containment?$helper.findAncestor(element,scope.sortableScope.options.containment):angular.element($document[0].body),containment.css("cursor","move"),containment.css("cursor","-webkit-grabbing"),containment.css("cursor","-moz-grabbing"),containment.addClass("as-sortable-un-selectable"),containerPositioning=scope.sortableScope.options.containerPositioning||"absolute",dragItemInfo=$helper.dragItem(scope),tagName=scope.itemScope.element.prop("tagName"),dragElement=angular.element($document[0].createElement(scope.sortableScope.element.prop("tagName"))).addClass(scope.sortableScope.element.attr("class")).addClass(sortableConfig.dragClass),dragElement.css("width",$helper.width(scope.itemScope.element)+"px"),dragElement.css("height",$helper.height(scope.itemScope.element)+"px"),placeHolder=createPlaceholder(scope.itemScope).addClass(sortableConfig.placeHolderClass).addClass(scope.sortableScope.options.additionalPlaceholderClass),placeHolder.css("width",$helper.width(scope.itemScope.element)+"px"),placeHolder.css("height",$helper.height(scope.itemScope.element)+"px"),placeElement=angular.element($document[0].createElement(tagName)),sortableConfig.hiddenClass&&placeElement.addClass(sortableConfig.hiddenClass),itemPosition=$helper.positionStarted(eventObj,scope.itemScope.element,scrollableContainer),scope.itemScope.sortableScope.options.clone||scope.itemScope.element.after(placeHolder),scope.itemScope.sortableScope.cloning?dragElement.append(scope.itemScope.element.clone()):(scope.itemScope.element.after(placeElement),dragElement.append(scope.itemScope.element)),containment.append(dragElement),$helper.movePosition(eventObj,dragElement,itemPosition,containment,containerPositioning,scrollableContainer),scope.sortableScope.$apply(function(){scope.callbacks.dragStart(dragItemInfo.eventArgs())}),bindEvents()))},isDraggable=function(event){var elementClicked,sourceScope,isDraggable;for(elementClicked=angular.element(event.target),sourceScope=fetchScope(elementClicked),isDraggable=sourceScope&&"handle"===sourceScope.type;isDraggable&&elementClicked[0]!==element[0];)$helper.noDrag(elementClicked)&&(isDraggable=!1),elementClicked=elementClicked.parent();return isDraggable},dragMove=function(event){var eventObj,targetX,targetY,targetScope,targetElement;if((!hasTouch||!$helper.isTouchInvalid(event))&&dragHandled&&dragElement){if(event.preventDefault(),eventObj=$helper.eventObj(event),scope.callbacks.dragMove!==angular.noop&&scope.sortableScope.$apply(function(){scope.callbacks.dragMove(itemPosition,containment,eventObj)}),targetX=eventObj.pageX-$document[0].documentElement.scrollLeft,targetY=eventObj.pageY-($window.pageYOffset||$document[0].documentElement.scrollTop),dragElement.addClass(sortableConfig.hiddenClass),targetElement=angular.element($document[0].elementFromPoint(targetX,targetY)),dragElement.removeClass(sortableConfig.hiddenClass),$helper.movePosition(eventObj,dragElement,itemPosition,containment,containerPositioning,scrollableContainer),dragElement.addClass(sortableConfig.dragging),targetScope=fetchScope(targetElement),!targetScope||!targetScope.type)return;if("handle"===targetScope.type&&(targetScope=targetScope.itemScope),"item"!==targetScope.type&&"sortable"!==targetScope.type)return;if("item"===targetScope.type&&targetScope.accept(scope,targetScope.sortableScope,targetScope)){targetElement=targetScope.element;var targetElementOffset=$helper.offset(targetElement,scrollableContainer);if(!dragItemInfo.canMove(itemPosition,targetElement,targetElementOffset))return;var placeholderIndex=placeHolderIndex(targetScope.sortableScope.element);0>placeholderIndex?insertBefore(targetElement,targetScope):placeholderIndex<=targetScope.index()?insertAfter(targetElement,targetScope):insertBefore(targetElement,targetScope)}"sortable"===targetScope.type&&targetScope.accept(scope,targetScope)&&!isParent(targetScope.element[0],targetElement[0])&&(isPlaceHolderPresent(targetElement)||targetScope.options.clone||(targetElement[0].appendChild(placeHolder[0]),dragItemInfo.moveTo(targetScope,targetScope.modelValue.length)))}},placeHolderIndex=function(targetElement){var itemElements,i;if(targetElement.hasClass(sortableConfig.placeHolderClass))return 0;for(itemElements=targetElement.children(),i=0;i<itemElements.length;i+=1)if(angular.element(itemElements[i]).hasClass(sortableConfig.placeHolderClass))return i;return-1},isPlaceHolderPresent=function(targetElement){return placeHolderIndex(targetElement)>=0},dragEnd=function(event){dragHandled&&(event.preventDefault(),dragElement&&(rollbackDragChanges(),dragItemInfo.apply(),scope.sortableScope.$apply(function(){dragItemInfo.isSameParent()?dragItemInfo.isOrderChanged()&&scope.callbacks.orderChanged(dragItemInfo.eventArgs()):scope.callbacks.itemMoved(dragItemInfo.eventArgs())}),scope.sortableScope.$apply(function(){scope.callbacks.dragEnd(dragItemInfo.eventArgs())}),dragItemInfo=null),unBindEvents())},dragCancel=function(event){dragHandled&&(event.preventDefault(),dragElement&&(rollbackDragChanges(),scope.sortableScope.$apply(function(){scope.callbacks.dragCancel(dragItemInfo.eventArgs())}),dragItemInfo=null),unBindEvents())},bindDrag=function(){hasTouch&&(isLongTouch?isIOS?(element.bind("touchstart",longTouchStart),element.bind("touchend",longTouchCancel),element.bind("touchmove",longTouchCancel)):element.bind("contextmenu",dragListen):element.bind("touchstart",dragListen)),element.bind("mousedown",dragListen)},unbindDrag=function(){element.unbind("touchstart",longTouchStart),element.unbind("touchend",longTouchCancel),element.unbind("touchmove",longTouchCancel),element.unbind("contextmenu",dragListen),element.unbind("touchstart",dragListen),element.unbind("mousedown",dragListen)},longTouchStart=function(event){longTouchTimer=$timeout(function(){dragListen(event)},500)},longTouchCancel=function(){$timeout.cancel(longTouchTimer)},escapeListen=function(event){27===event.keyCode&&dragCancel(event)},angular.element($document[0].body).bind("keydown",escapeListen),bindEvents=function(){angular.element($document).bind("touchmove",dragMove),angular.element($document).bind("touchend",dragEnd),angular.element($document).bind("touchcancel",dragCancel),angular.element($document).bind("mousemove",dragMove),angular.element($document).bind("mouseup",dragEnd)},unBindEvents=function(){angular.element($document).unbind("touchend",dragEnd),angular.element($document).unbind("touchcancel",dragCancel),angular.element($document).unbind("touchmove",dragMove),angular.element($document).unbind("mouseup",dragEnd),angular.element($document).unbind("mousemove",dragMove)}}}}])}(),function(){var mainModule=angular.module("as.sortable");mainModule.controller("as.sortable.sortableItemController",["$scope",function($scope){this.scope=$scope,$scope.sortableScope=null,$scope.modelValue=null,$scope.type="item",$scope.index=function(){return $scope.$index},$scope.itemData=function(){return $scope.sortableScope.modelValue[$scope.$index]}}]),mainModule.directive("asSortableItem",["sortableConfig",function(sortableConfig){return{require:["^asSortable","?ngModel"],restrict:"A",controller:"as.sortable.sortableItemController",link:function(scope,element,attrs,ctrl){var sortableController=ctrl[0],ngModelController=ctrl[1];sortableConfig.itemClass&&element.addClass(sortableConfig.itemClass),scope.sortableScope=sortableController.scope,ngModelController?ngModelController.$render=function(){scope.modelValue=ngModelController.$modelValue}:scope.modelValue=sortableController.scope.modelValue[scope.$index],scope.element=element,element.data("_scope",scope)}}}])}(),function(){angular.module("ui.tree",[]).constant("treeConfig",{treeClass:"angular-ui-tree",emptyTreeClass:"angular-ui-tree-empty",hiddenClass:"angular-ui-tree-hidden",nodesClass:"angular-ui-tree-nodes",nodeClass:"angular-ui-tree-node",handleClass:"angular-ui-tree-handle",placeholderClass:"angular-ui-tree-placeholder",dragClass:"angular-ui-tree-drag",dragThreshold:3,levelThreshold:30,defaultCollapsed:!1})}(),function(){angular.module("ui.tree").controller("TreeHandleController",["$scope","$element",function($scope,$element){this.scope=$scope,$scope.$element=$element,$scope.$nodeScope=null,$scope.$type="uiTreeHandle"}])}(),function(){angular.module("ui.tree").controller("TreeNodeController",["$scope","$element",function($scope,$element){function countSubTreeDepth(scope){var childNode,childDepth,i,thisLevelDepth=0,childNodes=scope.childNodes();if(!childNodes||0===childNodes.length)return 0;for(i=childNodes.length-1;i>=0;i--)childNode=childNodes[i],childDepth=1+countSubTreeDepth(childNode),thisLevelDepth=Math.max(thisLevelDepth,childDepth);return thisLevelDepth}this.scope=$scope,$scope.$element=$element,$scope.$modelValue=null,$scope.$parentNodeScope=null,$scope.$childNodesScope=null,$scope.$parentNodesScope=null,$scope.$treeScope=null,$scope.$handleScope=null,$scope.$type="uiTreeNode",$scope.$$allowNodeDrop=!1,$scope.collapsed=!1,$scope.init=function(controllersArr){var treeNodesCtrl=controllersArr[0];$scope.$treeScope=controllersArr[1]?controllersArr[1].scope:null,$scope.$parentNodeScope=treeNodesCtrl.scope.$nodeScope,$scope.$modelValue=treeNodesCtrl.scope.$modelValue[$scope.$index],$scope.$parentNodesScope=treeNodesCtrl.scope,treeNodesCtrl.scope.initSubNode($scope),$element.on("$destroy",function(){treeNodesCtrl.scope.destroySubNode($scope)})},$scope.index=function(){return $scope.$parentNodesScope.$modelValue.indexOf($scope.$modelValue)},$scope.dragEnabled=function(){return!($scope.$treeScope&&!$scope.$treeScope.dragEnabled)},$scope.isSibling=function(targetNode){return $scope.$parentNodesScope==targetNode.$parentNodesScope},$scope.isChild=function(targetNode){var nodes=$scope.childNodes();return nodes&&nodes.indexOf(targetNode)>-1},$scope.prev=function(){var index=$scope.index();return index>0?$scope.siblings()[index-1]:null},$scope.siblings=function(){return $scope.$parentNodesScope.childNodes()},$scope.childNodesCount=function(){return $scope.childNodes()?$scope.childNodes().length:0},$scope.hasChild=function(){return $scope.childNodesCount()>0},$scope.childNodes=function(){return $scope.$childNodesScope&&$scope.$childNodesScope.$modelValue?$scope.$childNodesScope.childNodes():null},$scope.accept=function(sourceNode,destIndex){return $scope.$childNodesScope&&$scope.$childNodesScope.$modelValue&&$scope.$childNodesScope.accept(sourceNode,destIndex)},$scope.removeNode=function(){var node=$scope.remove();return $scope.$callbacks.removed(node),node},$scope.remove=function(){return $scope.$parentNodesScope.removeNode($scope)},$scope.toggle=function(){$scope.collapsed=!$scope.collapsed},$scope.collapse=function(){$scope.collapsed=!0},$scope.expand=function(){$scope.collapsed=!1},$scope.depth=function(){var parentNode=$scope.$parentNodeScope;return parentNode?parentNode.depth()+1:1},$scope.maxSubDepth=function(){return $scope.$childNodesScope?countSubTreeDepth($scope.$childNodesScope):0}}])}(),function(){angular.module("ui.tree").controller("TreeNodesController",["$scope","$element",function($scope,$element){this.scope=$scope,$scope.$element=$element,$scope.$modelValue=null,$scope.$nodeScope=null,$scope.$treeScope=null,$scope.$type="uiTreeNodes",$scope.$nodesMap={},$scope.nodropEnabled=!1,$scope.maxDepth=0,$scope.cloneEnabled=!1,$scope.initSubNode=function(subNode){return subNode.$modelValue?void($scope.$nodesMap[subNode.$modelValue.$$hashKey]=subNode):null},$scope.destroySubNode=function(subNode){return subNode.$modelValue?void($scope.$nodesMap[subNode.$modelValue.$$hashKey]=null):null},$scope.accept=function(sourceNode,destIndex){return $scope.$treeScope.$callbacks.accept(sourceNode,$scope,destIndex)},$scope.beforeDrag=function(sourceNode){return $scope.$treeScope.$callbacks.beforeDrag(sourceNode)},$scope.isParent=function(node){return node.$parentNodesScope==$scope},$scope.hasChild=function(){return $scope.$modelValue.length>0},$scope.safeApply=function(fn){var phase=this.$root.$$phase;"$apply"==phase||"$digest"==phase?fn&&"function"==typeof fn&&fn():this.$apply(fn)},$scope.removeNode=function(node){var index=$scope.$modelValue.indexOf(node.$modelValue);return index>-1?($scope.safeApply(function(){$scope.$modelValue.splice(index,1)[0]}),node):null},$scope.insertNode=function(index,nodeData){$scope.safeApply(function(){$scope.$modelValue.splice(index,0,nodeData)})},$scope.childNodes=function(){var i,nodes=[];if($scope.$modelValue)for(i=0;i<$scope.$modelValue.length;i++)nodes.push($scope.$nodesMap[$scope.$modelValue[i].$$hashKey]);return nodes},$scope.depth=function(){return $scope.$nodeScope?$scope.$nodeScope.depth():0},$scope.outOfDepth=function(sourceNode){var maxDepth=$scope.maxDepth||$scope.$treeScope.maxDepth;return maxDepth>0&&$scope.depth()+sourceNode.maxSubDepth()+1>maxDepth}}])}(),function(){angular.module("ui.tree").controller("TreeController",["$scope","$element",function($scope,$element){this.scope=$scope,$scope.$element=$element,$scope.$nodesScope=null,$scope.$type="uiTree",$scope.$emptyElm=null,$scope.$callbacks=null,$scope.dragEnabled=!0,$scope.emptyPlaceholderEnabled=!0,$scope.maxDepth=0,$scope.dragDelay=0,$scope.cloneEnabled=!1,$scope.nodropEnabled=!1,$scope.isEmpty=function(){return $scope.$nodesScope&&$scope.$nodesScope.$modelValue&&0===$scope.$nodesScope.$modelValue.length;
},$scope.place=function(placeElm){$scope.$nodesScope.$element.append(placeElm),$scope.$emptyElm.remove()},this.resetEmptyElement=function(){$scope.$nodesScope.$modelValue&&0!==$scope.$nodesScope.$modelValue.length||!$scope.emptyPlaceholderEnabled?$scope.$emptyElm.remove():$element.append($scope.$emptyElm)},$scope.resetEmptyElement=this.resetEmptyElement;var collapseOrExpand=function(scope,collapsed){var i,subScope,nodes=scope.childNodes();for(i=0;i<nodes.length;i++)collapsed?nodes[i].collapse():nodes[i].expand(),subScope=nodes[i].$childNodesScope,subScope&&collapseOrExpand(subScope,collapsed)};$scope.collapseAll=function(){collapseOrExpand($scope.$nodesScope,!0)},$scope.expandAll=function(){collapseOrExpand($scope.$nodesScope,!1)}}])}(),function(){angular.module("ui.tree").directive("uiTree",["treeConfig","$window",function(treeConfig,$window){return{restrict:"A",scope:!0,controller:"TreeController",link:function(scope,element,attrs,ctrl){var tdElm,$trElm,emptyElmColspan,callbacks={accept:null,beforeDrag:null},config={};angular.extend(config,treeConfig),config.treeClass&&element.addClass(config.treeClass),"table"===element.prop("tagName").toLowerCase()?(scope.$emptyElm=angular.element($window.document.createElement("tr")),$trElm=element.find("tr"),emptyElmColspan=$trElm.length>0?angular.element($trElm).children().length:1e6,tdElm=angular.element($window.document.createElement("td")).attr("colspan",emptyElmColspan),scope.$emptyElm.append(tdElm)):scope.$emptyElm=angular.element($window.document.createElement("div")),config.emptyTreeClass&&scope.$emptyElm.addClass(config.emptyTreeClass),scope.$watch("$nodesScope.$modelValue.length",function(val){angular.isNumber(val)&&ctrl.resetEmptyElement()},!0),scope.$watch(attrs.dragEnabled,function(val){"boolean"==typeof val&&(scope.dragEnabled=val)}),scope.$watch(attrs.emptyPlaceholderEnabled,function(val){"boolean"==typeof val&&(scope.emptyPlaceholderEnabled=val,ctrl.resetEmptyElement())}),scope.$watch(attrs.nodropEnabled,function(val){"boolean"==typeof val&&(scope.nodropEnabled=val)}),scope.$watch(attrs.cloneEnabled,function(val){"boolean"==typeof val&&(scope.cloneEnabled=val)}),scope.$watch(attrs.maxDepth,function(val){"number"==typeof val&&(scope.maxDepth=val)}),scope.$watch(attrs.dragDelay,function(val){"number"==typeof val&&(scope.dragDelay=val)}),callbacks.accept=function(sourceNodeScope,destNodesScope,destIndex){return!(destNodesScope.nodropEnabled||destNodesScope.$treeScope.nodropEnabled||destNodesScope.outOfDepth(sourceNodeScope))},callbacks.beforeDrag=function(sourceNodeScope){return!0},callbacks.removed=function(node){},callbacks.dropped=function(event){},callbacks.dragStart=function(event){},callbacks.dragMove=function(event){},callbacks.dragStop=function(event){},callbacks.beforeDrop=function(event){},scope.$watch(attrs.uiTree,function(newVal,oldVal){angular.forEach(newVal,function(value,key){callbacks[key]&&"function"==typeof value&&(callbacks[key]=value)}),scope.$callbacks=callbacks},!0)}}}])}(),function(){angular.module("ui.tree").directive("uiTreeHandle",["treeConfig",function(treeConfig){return{require:"^uiTreeNode",restrict:"A",scope:!0,controller:"TreeHandleController",link:function(scope,element,attrs,treeNodeCtrl){var config={};angular.extend(config,treeConfig),config.handleClass&&element.addClass(config.handleClass),scope!=treeNodeCtrl.scope&&(scope.$nodeScope=treeNodeCtrl.scope,treeNodeCtrl.scope.$handleScope=scope)}}}])}(),function(){angular.module("ui.tree").directive("uiTreeNode",["treeConfig","UiTreeHelper","$window","$document","$timeout","$q","$rootElement",function(treeConfig,UiTreeHelper,$window,$document,$timeout,$q,$rootElement){return{require:["^uiTreeNodes","^uiTree"],restrict:"A",controller:"TreeNodeController",link:function(scope,element,attrs,controllersArr){var firstMoving,dragInfo,pos,placeElm,hiddenPlaceElm,dragElm,elements,document_height,document_width,dragStart,dragMove,dragEnd,dragStartEvent,dragMoveEvent,dragEndEvent,dragCancelEvent,dragDelay,bindDragStartEvents,bindDragMoveEvents,unbindDragMoveEvents,keydownHandler,outOfBounds,config={},hasTouch="ontouchstart"in window,treeScope=null,body=document.body,html=document.documentElement;angular.extend(config,treeConfig),config.nodeClass&&element.addClass(config.nodeClass),scope.init(controllersArr),scope.collapsed=!!UiTreeHelper.getNodeAttribute(scope,"collapsed")||treeConfig.defaultCollapsed,scope.sourceOnly=scope.nodropEnabled||scope.$treeScope.nodropEnabled,scope.$watch(attrs.collapsed,function(val){"boolean"==typeof val&&(scope.collapsed=val)}),scope.$watch("collapsed",function(val){UiTreeHelper.setNodeAttribute(scope,"collapsed",val),attrs.$set("collapsed",val)}),dragStart=function(e){if((hasTouch||2!=e.button&&3!=e.which)&&!(e.uiTreeDragging||e.originalEvent&&e.originalEvent.uiTreeDragging)){var eventElmTagName,tagName,eventObj,tdElm,hStyle,eventElm=angular.element(e.target),eventScope=eventElm.scope(),cloneElm=element.clone();if(eventScope&&eventScope.$type&&!("uiTreeNode"!=eventScope.$type&&"uiTreeHandle"!=eventScope.$type||"uiTreeNode"==eventScope.$type&&eventScope.$handleScope||(eventElmTagName=eventElm.prop("tagName").toLowerCase(),"input"==eventElmTagName||"textarea"==eventElmTagName||"button"==eventElmTagName||"select"==eventElmTagName))){for(;eventElm&&eventElm[0]&&eventElm[0]!=element;){if(UiTreeHelper.nodrag(eventElm))return;eventElm=eventElm.parent()}scope.beforeDrag(scope)&&(e.uiTreeDragging=!0,e.originalEvent&&(e.originalEvent.uiTreeDragging=!0),e.preventDefault(),eventObj=UiTreeHelper.eventObj(e),firstMoving=!0,dragInfo=UiTreeHelper.dragInfo(scope),tagName=element.prop("tagName"),"tr"===tagName.toLowerCase()?(placeElm=angular.element($window.document.createElement(tagName)),tdElm=angular.element($window.document.createElement("td")).addClass(config.placeholderClass).attr("colspan",element[0].children.length),placeElm.append(tdElm)):placeElm=angular.element($window.document.createElement(tagName)).addClass(config.placeholderClass),hiddenPlaceElm=angular.element($window.document.createElement(tagName)),config.hiddenClass&&hiddenPlaceElm.addClass(config.hiddenClass),pos=UiTreeHelper.positionStarted(eventObj,element),placeElm.css("height",UiTreeHelper.height(element)+"px"),dragElm=angular.element($window.document.createElement(scope.$parentNodesScope.$element.prop("tagName"))).addClass(scope.$parentNodesScope.$element.attr("class")).addClass(config.dragClass),dragElm.css("width",UiTreeHelper.width(element)+"px"),dragElm.css("z-index",9999),hStyle=(element[0].querySelector(".angular-ui-tree-handle")||element[0]).currentStyle,hStyle&&(document.body.setAttribute("ui-tree-cursor",$document.find("body").css("cursor")||""),$document.find("body").css({cursor:hStyle.cursor+"!important"})),scope.sourceOnly&&placeElm.css("display","none"),element.after(placeElm),element.after(hiddenPlaceElm),dragInfo.isClone()&&scope.sourceOnly?dragElm.append(cloneElm):dragElm.append(element),$rootElement.append(dragElm),dragElm.css({left:eventObj.pageX-pos.offsetX+"px",top:eventObj.pageY-pos.offsetY+"px"}),elements={placeholder:placeElm,dragging:dragElm},bindDragMoveEvents(),scope.$apply(function(){scope.$treeScope.$callbacks.dragStart(dragInfo.eventArgs(elements,pos))}),document_height=Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight,html.scrollHeight,html.offsetHeight),document_width=Math.max(body.scrollWidth,body.offsetWidth,html.clientWidth,html.scrollWidth,html.offsetWidth))}}},dragMove=function(e){var prev,next,leftElmPos,topElmPos,top_scroll,bottom_scroll,target,decrease,targetX,targetY,displayElm,targetNode,targetElm,isEmpty,targetOffset,targetBefore,eventObj=UiTreeHelper.eventObj(e);if(dragElm){if(e.preventDefault(),$window.getSelection?$window.getSelection().removeAllRanges():$window.document.selection&&$window.document.selection.empty(),leftElmPos=eventObj.pageX-pos.offsetX,topElmPos=eventObj.pageY-pos.offsetY,leftElmPos<0&&(leftElmPos=0),topElmPos<0&&(topElmPos=0),topElmPos+10>document_height&&(topElmPos=document_height-10),leftElmPos+10>document_width&&(leftElmPos=document_width-10),dragElm.css({left:leftElmPos+"px",top:topElmPos+"px"}),top_scroll=window.pageYOffset||$window.document.documentElement.scrollTop,bottom_scroll=top_scroll+(window.innerHeight||$window.document.clientHeight||$window.document.clientHeight),bottom_scroll<eventObj.pageY&&bottom_scroll<=document_height&&window.scrollBy(0,10),top_scroll>eventObj.pageY&&window.scrollBy(0,-10),UiTreeHelper.positionMoved(e,pos,firstMoving),firstMoving)return void(firstMoving=!1);if(decrease=UiTreeHelper.offset(dragElm).left-UiTreeHelper.offset(placeElm).left>=config.threshold,targetX=eventObj.pageX-($window.pageXOffset||$window.document.body.scrollLeft||$window.document.documentElement.scrollLeft)-($window.document.documentElement.clientLeft||0),targetY=eventObj.pageY-($window.pageYOffset||$window.document.body.scrollTop||$window.document.documentElement.scrollTop)-($window.document.documentElement.clientTop||0),angular.isFunction(dragElm.hide)?dragElm.hide():(displayElm=dragElm[0].style.display,dragElm[0].style.display="none"),$window.document.elementFromPoint(targetX,targetY),targetElm=angular.element($window.document.elementFromPoint(targetX,targetY)),angular.isFunction(dragElm.show)?dragElm.show():dragElm[0].style.display=displayElm,outOfBounds=!targetElm.scope()||!targetElm.scope().$type,outOfBounds&&(placeElm.remove(),treeScope&&(treeScope.resetEmptyElement(),treeScope=null)),pos.dirAx&&pos.distAxX>=config.levelThreshold&&(pos.distAxX=0,pos.distX>0&&(prev=dragInfo.prev(),prev&&!prev.collapsed&&prev.accept(scope,prev.childNodesCount())&&(prev.$childNodesScope.$element.append(placeElm),dragInfo.moveTo(prev.$childNodesScope,prev.childNodes(),prev.childNodesCount()))),pos.distX<0&&(next=dragInfo.next(),next||(target=dragInfo.parentNode(),target&&target.$parentNodesScope.accept(scope,target.index()+1)&&(target.$element.after(placeElm),dragInfo.moveTo(target.$parentNodesScope,target.siblings(),target.index()+1))))),!pos.dirAx){if(targetNode=targetElm.scope(),isEmpty=!1,!targetNode)return;if(!targetNode.$treeScope||targetNode.$parent.nodropEnabled||targetNode.$treeScope.nodropEnabled||placeElm.css("display",""),"uiTree"==targetNode.$type&&targetNode.dragEnabled&&(isEmpty=targetNode.isEmpty()),"uiTreeHandle"==targetNode.$type&&(targetNode=targetNode.$nodeScope),"uiTreeNode"!=targetNode.$type&&!isEmpty)return;treeScope&&placeElm.parent()[0]!=treeScope.$element[0]&&(treeScope.resetEmptyElement(),treeScope=null),isEmpty?(treeScope=targetNode,targetNode.$nodesScope.accept(scope,0)&&(targetNode.place(placeElm),dragInfo.moveTo(targetNode.$nodesScope,targetNode.$nodesScope.childNodes(),0))):targetNode.dragEnabled()&&(targetElm=targetNode.$element,targetOffset=UiTreeHelper.offset(targetElm),targetBefore=targetNode.horizontal?eventObj.pageX<targetOffset.left+UiTreeHelper.width(targetElm)/2:eventObj.pageY<targetOffset.top+UiTreeHelper.height(targetElm)/2,targetNode.$parentNodesScope.accept(scope,targetNode.index())?targetBefore?(targetElm[0].parentNode.insertBefore(placeElm[0],targetElm[0]),dragInfo.moveTo(targetNode.$parentNodesScope,targetNode.siblings(),targetNode.index())):(targetElm.after(placeElm),dragInfo.moveTo(targetNode.$parentNodesScope,targetNode.siblings(),targetNode.index()+1)):!targetBefore&&targetNode.accept(scope,targetNode.childNodesCount())?(targetNode.$childNodesScope.$element.append(placeElm),dragInfo.moveTo(targetNode.$childNodesScope,targetNode.childNodes(),targetNode.childNodesCount())):outOfBounds=!0)}scope.$apply(function(){scope.$treeScope.$callbacks.dragMove(dragInfo.eventArgs(elements,pos))})}},dragEnd=function(e){var dragEventArgs=dragInfo.eventArgs(elements,pos);e.preventDefault(),unbindDragMoveEvents(),scope.$treeScope.$apply(function(){$q.when(scope.$treeScope.$callbacks.beforeDrop(dragEventArgs)).then(function(allowDrop){allowDrop!==!1&&scope.$$allowNodeDrop&&!outOfBounds?(dragInfo.apply(),scope.$treeScope.$callbacks.dropped(dragEventArgs)):bindDragStartEvents()})["catch"](function(){bindDragStartEvents()})["finally"](function(){hiddenPlaceElm.replaceWith(scope.$element),placeElm.remove(),dragElm&&(dragElm.remove(),dragElm=null),scope.$treeScope.$callbacks.dragStop(dragEventArgs),scope.$$allowNodeDrop=!1,dragInfo=null;var oldCur=document.body.getAttribute("ui-tree-cursor");null!==oldCur&&($document.find("body").css({cursor:oldCur}),document.body.removeAttribute("ui-tree-cursor"))})})},dragStartEvent=function(e){scope.dragEnabled()&&dragStart(e)},dragMoveEvent=function(e){dragMove(e)},dragEndEvent=function(e){scope.$$allowNodeDrop=!0,dragEnd(e)},dragCancelEvent=function(e){dragEnd(e)},dragDelay=function(){var to;return{exec:function(fn,ms){ms||(ms=0),this.cancel(),to=$timeout(fn,ms)},cancel:function(){$timeout.cancel(to)}}}(),bindDragStartEvents=function(){element.bind("touchstart mousedown",function(e){dragDelay.exec(function(){dragStartEvent(e)},scope.dragDelay||0)}),element.bind("touchend touchcancel mouseup",function(){dragDelay.cancel()})},bindDragStartEvents(),bindDragMoveEvents=function(){angular.element($document).bind("touchend",dragEndEvent),angular.element($document).bind("touchcancel",dragEndEvent),angular.element($document).bind("touchmove",dragMoveEvent),angular.element($document).bind("mouseup",dragEndEvent),angular.element($document).bind("mousemove",dragMoveEvent),angular.element($document).bind("mouseleave",dragCancelEvent)},unbindDragMoveEvents=function(){angular.element($document).unbind("touchend",dragEndEvent),angular.element($document).unbind("touchcancel",dragEndEvent),angular.element($document).unbind("touchmove",dragMoveEvent),angular.element($document).unbind("mouseup",dragEndEvent),angular.element($document).unbind("mousemove",dragMoveEvent),angular.element($document).unbind("mouseleave",dragCancelEvent)},keydownHandler=function(e){27==e.keyCode&&(scope.$$allowNodeDrop=!1,dragEnd(e))},angular.element($window.document).bind("keydown",keydownHandler),scope.$on("$destroy",function(){angular.element($window.document).unbind("keydown",keydownHandler)})}}}])}(),function(){angular.module("ui.tree").directive("uiTreeNodes",["treeConfig","$window",function(treeConfig){return{require:["ngModel","?^uiTreeNode","^uiTree"],restrict:"A",scope:!0,controller:"TreeNodesController",link:function(scope,element,attrs,controllersArr){var config={},ngModel=controllersArr[0],treeNodeCtrl=controllersArr[1],treeCtrl=controllersArr[2];angular.extend(config,treeConfig),config.nodesClass&&element.addClass(config.nodesClass),treeNodeCtrl?(treeNodeCtrl.scope.$childNodesScope=scope,scope.$nodeScope=treeNodeCtrl.scope):treeCtrl.scope.$nodesScope=scope,scope.$treeScope=treeCtrl.scope,ngModel&&(ngModel.$render=function(){scope.$modelValue=ngModel.$modelValue}),scope.$watch(function(){return attrs.maxDepth},function(val){"number"==typeof val&&(scope.maxDepth=val)}),scope.$watch(function(){return attrs.nodropEnabled},function(newVal){"undefined"!=typeof newVal&&(scope.nodropEnabled=!0)},!0),attrs.$observe("horizontal",function(val){scope.horizontal="undefined"!=typeof val})}}}])}(),function(){angular.module("ui.tree").factory("UiTreeHelper",["$document","$window",function($document,$window){return{nodesData:{},setNodeAttribute:function(scope,attrName,val){if(!scope.$modelValue)return null;var data=this.nodesData[scope.$modelValue.$$hashKey];data||(data={},this.nodesData[scope.$modelValue.$$hashKey]=data),data[attrName]=val},getNodeAttribute:function(scope,attrName){if(!scope.$modelValue)return null;var data=this.nodesData[scope.$modelValue.$$hashKey];return data?data[attrName]:null},nodrag:function(targetElm){return"undefined"!=typeof targetElm.attr("data-nodrag")&&"false"!==targetElm.attr("data-nodrag")},eventObj:function(e){var obj=e;return void 0!==e.targetTouches?obj=e.targetTouches.item(0):void 0!==e.originalEvent&&void 0!==e.originalEvent.targetTouches&&(obj=e.originalEvent.targetTouches.item(0)),obj},dragInfo:function(node){return{source:node,sourceInfo:{cloneModel:node.$treeScope.cloneEnabled===!0?angular.copy(node.$modelValue):void 0,nodeScope:node,index:node.index(),nodesScope:node.$parentNodesScope},index:node.index(),siblings:node.siblings().slice(0),parent:node.$parentNodesScope,moveTo:function(parent,siblings,index){this.parent=parent,this.siblings=siblings.slice(0);var i=this.siblings.indexOf(this.source);i>-1&&(this.siblings.splice(i,1),this.source.index()<index&&index--),this.siblings.splice(index,0,this.source),this.index=index},parentNode:function(){return this.parent.$nodeScope},prev:function(){return this.index>0?this.siblings[this.index-1]:null},next:function(){return this.index<this.siblings.length-1?this.siblings[this.index+1]:null},isClone:function(){return this.source.$treeScope.cloneEnabled===!0},clonedNode:function(node){return angular.copy(node)},isDirty:function(){return this.source.$parentNodesScope!=this.parent||this.source.index()!=this.index},isForeign:function(){return this.source.$treeScope!==this.parent.$treeScope},eventArgs:function(elements,pos){return{source:this.sourceInfo,dest:{index:this.index,nodesScope:this.parent},elements:elements,pos:pos}},apply:function(){var nodeData=this.source.$modelValue;this.parent.nodropEnabled||this.parent.$treeScope.nodropEnabled||this.isDirty()&&(this.isClone()&&this.isForeign()?this.parent.insertNode(this.index,this.sourceInfo.cloneModel):(this.source.remove(),this.parent.insertNode(this.index,nodeData)))}}},height:function(element){return element.prop("scrollHeight")},width:function(element){return element.prop("scrollWidth")},offset:function(element){var boundingClientRect=element[0].getBoundingClientRect();return{width:element.prop("offsetWidth"),height:element.prop("offsetHeight"),top:boundingClientRect.top+($window.pageYOffset||$document[0].body.scrollTop||$document[0].documentElement.scrollTop),left:boundingClientRect.left+($window.pageXOffset||$document[0].body.scrollLeft||$document[0].documentElement.scrollLeft)}},positionStarted:function(e,target){var pos={},pageX=e.pageX,pageY=e.pageY;return e.originalEvent&&e.originalEvent.touches&&e.originalEvent.touches.length>0&&(pageX=e.originalEvent.touches[0].pageX,pageY=e.originalEvent.touches[0].pageY),pos.offsetX=pageX-this.offset(target).left,pos.offsetY=pageY-this.offset(target).top,pos.startX=pos.lastX=pageX,pos.startY=pos.lastY=pageY,pos.nowX=pos.nowY=pos.distX=pos.distY=pos.dirAx=0,pos.dirX=pos.dirY=pos.lastDirX=pos.lastDirY=pos.distAxX=pos.distAxY=0,pos},positionMoved:function(e,pos,firstMoving){var newAx,pageX=e.pageX,pageY=e.pageY;return e.originalEvent&&e.originalEvent.touches&&e.originalEvent.touches.length>0&&(pageX=e.originalEvent.touches[0].pageX,pageY=e.originalEvent.touches[0].pageY),pos.lastX=pos.nowX,pos.lastY=pos.nowY,pos.nowX=pageX,pos.nowY=pageY,pos.distX=pos.nowX-pos.lastX,pos.distY=pos.nowY-pos.lastY,pos.lastDirX=pos.dirX,pos.lastDirY=pos.dirY,pos.dirX=0===pos.distX?0:pos.distX>0?1:-1,pos.dirY=0===pos.distY?0:pos.distY>0?1:-1,newAx=Math.abs(pos.distX)>Math.abs(pos.distY)?1:0,firstMoving?(pos.dirAx=newAx,void(pos.moving=!0)):(pos.dirAx!==newAx?(pos.distAxX=0,pos.distAxY=0):(pos.distAxX+=Math.abs(pos.distX),0!==pos.dirX&&pos.dirX!==pos.lastDirX&&(pos.distAxX=0),pos.distAxY+=Math.abs(pos.distY),0!==pos.dirY&&pos.dirY!==pos.lastDirY&&(pos.distAxY=0)),void(pos.dirAx=newAx))}}}])}(),function(window,angular,undefined){function toArray(object){return isArray(object)?object:Object.keys(object).map(function(key){return object[key]})}function isNull(value){return null===value}function objectContains(partial,object){var keys=Object.keys(partial);return keys.map(function(el){return object[el]!==undefined&&object[el]==partial[el]}).indexOf(!1)==-1}function hasApproxPattern(word,pattern){function indexOf(word,p,c){for(var j=0;p+j<=word.length;){if(word.charAt(p+j)==c)return j;j++}return-1}for(var p=0,i=0;i<=pattern.length;i++){var index=indexOf(word,p,pattern.charAt(i));if(index==-1)return!1;p+=index+1}return!0}function getFirstMatches(array,n,expression){var count=0;return array.filter(function(elm){var rest=isDefined(expression)?count<n&&expression(elm):count<n;return count=rest?count+1:count,rest})}function convertToDecimal(num,decimal,$math){return $math.round(num*$math.pow(10,decimal))/$math.pow(10,decimal)}function deepKeys(obj,stack,parent){stack=stack||[];var keys=Object.keys(obj);return keys.forEach(function(el){if(isObject(obj[el])&&!isArray(obj[el])){var p=parent?parent+"."+el:parent;deepKeys(obj[el],stack,p||el)}else{var key=parent?parent+"."+el:el;stack.push(key)}}),stack}function isScope(obj){return obj&&obj.$evalAsync&&obj.$watch}function isGreaterThanFilter(){return function(input,check){return input>check}}function isGreaterThanOrEqualToFilter(){return function(input,check){return input>=check}}function isLessThanFilter(){return function(input,check){return input<check}}function isLessThanOrEqualToFilter(){return function(input,check){return input<=check}}function isEqualToFilter(){return function(input,check){return input==check}}function isNotEqualToFilter(){return function(input,check){return input!=check}}function isIdenticalToFilter(){return function(input,check){return input===check}}function isNotIdenticalToFilter(){return function(input,check){return input!==check}}function containsFilter($parse){return function(collection,expression){return collection=isObject(collection)?toArray(collection):collection,!(!isArray(collection)||isUndefined(expression))&&collection.some(function(elm){return isString(expression)&&isObject(elm)||isFunction(expression)?$parse(expression)(elm):elm===expression})}}function flatten(array,i){return i=i||0,i>=array.length?array:isArray(array[i])?flatten(array.slice(0,i).concat(array[i],array.slice(i+1)),i):flatten(array,i+1)}function uniqFilter($parse){return function(collection,property){function some(array,member){return!isUndefined(member)&&array.some(function(el){return equals(el,member)})}if(collection=isObject(collection)?toArray(collection):collection,!isArray(collection))return collection;var uniqueItems=[],get=$parse(property);return isUndefined(property)?collection.filter(function(elm,pos,self){return self.indexOf(elm)===pos}):collection.filter(function(elm){var prop=get(elm);return!some(uniqueItems,prop)&&(uniqueItems.push(prop),!0)})}}function strRepeat(str,n,sep){return n?str+sep+strRepeat(str,--n,sep):str}var isDefined=angular.isDefined,isUndefined=angular.isUndefined,isFunction=angular.isFunction,isString=angular.isString,isNumber=angular.isNumber,isObject=angular.isObject,isArray=angular.isArray,forEach=angular.forEach,extend=angular.extend,copy=angular.copy,equals=angular.equals;String.prototype.contains||(String.prototype.contains=function(){return String.prototype.indexOf.apply(this,arguments)!==-1}),angular.module("a8m.angular",[]).filter("isUndefined",function(){return function(input){return angular.isUndefined(input)}}).filter("isDefined",function(){return function(input){return angular.isDefined(input)}}).filter("isFunction",function(){return function(input){return angular.isFunction(input)}}).filter("isString",function(){return function(input){return angular.isString(input)}}).filter("isNumber",function(){return function(input){return angular.isNumber(input)}}).filter("isArray",function(){return function(input){return angular.isArray(input)}}).filter("isObject",function(){return function(input){return angular.isObject(input)}}).filter("isEqual",function(){return function(o1,o2){return angular.equals(o1,o2)}}),angular.module("a8m.conditions",[]).filter({isGreaterThan:isGreaterThanFilter,">":isGreaterThanFilter,isGreaterThanOrEqualTo:isGreaterThanOrEqualToFilter,">=":isGreaterThanOrEqualToFilter,isLessThan:isLessThanFilter,"<":isLessThanFilter,isLessThanOrEqualTo:isLessThanOrEqualToFilter,"<=":isLessThanOrEqualToFilter,isEqualTo:isEqualToFilter,"==":isEqualToFilter,isNotEqualTo:isNotEqualToFilter,"!=":isNotEqualToFilter,isIdenticalTo:isIdenticalToFilter,"===":isIdenticalToFilter,isNotIdenticalTo:isNotIdenticalToFilter,"!==":isNotIdenticalToFilter}),angular.module("a8m.is-null",[]).filter("isNull",function(){return function(input){return isNull(input)}}),angular.module("a8m.after-where",[]).filter("afterWhere",function(){return function(collection,object){if(collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(object))return collection;var index=collection.map(function(elm){return objectContains(object,elm)}).indexOf(!0);return collection.slice(index===-1?0:index)}}),angular.module("a8m.after",[]).filter("after",function(){return function(collection,count){return collection=isObject(collection)?toArray(collection):collection,isArray(collection)?collection.slice(count):collection}}),angular.module("a8m.before-where",[]).filter("beforeWhere",function(){return function(collection,object){if(collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(object))return collection;var index=collection.map(function(elm){return objectContains(object,elm)}).indexOf(!0);return collection.slice(0,index===-1?collection.length:++index)}}),angular.module("a8m.before",[]).filter("before",function(){return function(collection,count){return collection=isObject(collection)?toArray(collection):collection,isArray(collection)?collection.slice(0,count?--count:count):collection}}),angular.module("a8m.chunk-by",["a8m.filter-watcher"]).filter("chunkBy",["filterWatcher",function(filterWatcher){return function(array,n,fillVal){function fill(n,val){for(var ret=[];n--;)ret[n]=val;return ret}function _chunkBy(array,n,fillVal){return isArray(array)?array.map(function(el,i,self){return i*=n,el=self.slice(i,i+n),!isUndefined(fillVal)&&el.length<n?el.concat(fill(n-el.length,fillVal)):el}).slice(0,Math.ceil(array.length/n)):array}return filterWatcher.isMemoized("chunkBy",arguments)||filterWatcher.memoize("chunkBy",arguments,this,_chunkBy(array,n,fillVal))}}]),angular.module("a8m.concat",[]).filter("concat",[function(){return function(collection,joined){if(isUndefined(joined))return collection;if(isArray(collection))return isObject(joined)?collection.concat(toArray(joined)):collection.concat(joined);if(isObject(collection)){var array=toArray(collection);return isObject(joined)?array.concat(toArray(joined)):array.concat(joined)}return collection}}]),angular.module("a8m.contains",[]).filter({contains:["$parse",containsFilter],some:["$parse",containsFilter]}),angular.module("a8m.count-by",[]).filter("countBy",["$parse",function($parse){return function(collection,property){var prop,result={},get=$parse(property);return collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(property)?collection:(collection.forEach(function(elm){prop=get(elm),result[prop]||(result[prop]=0),result[prop]++}),result)}}]),angular.module("a8m.defaults",[]).filter("defaults",["$parse",function($parse){return function(collection,defaults){if(collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||!isObject(defaults))return collection;var keys=deepKeys(defaults);return collection.forEach(function(elm){keys.forEach(function(key){var getter=$parse(key),setter=getter.assign;isUndefined(getter(elm))&&setter(elm,getter(defaults))})}),collection}}]),angular.module("a8m.every",[]).filter("every",["$parse",function($parse){return function(collection,expression){return collection=isObject(collection)?toArray(collection):collection,!(isArray(collection)&&!isUndefined(expression))||collection.every(function(elm){return isObject(elm)||isFunction(expression)?$parse(expression)(elm):elm===expression})}}]),angular.module("a8m.filter-by",[]).filter("filterBy",["$parse",function($parse){return function(collection,properties,search,strict){var comparator;return search=isString(search)||isNumber(search)?String(search).toLowerCase():undefined,collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(search)?collection:collection.filter(function(elm){return properties.some(function(prop){if(~prop.indexOf("+")){var propList=prop.replace(/\s+/g,"").split("+");comparator=propList.map(function(prop){return $parse(prop)(elm)}).join(" ")}else comparator=$parse(prop)(elm);return!(!isString(comparator)&&!isNumber(comparator))&&(comparator=String(comparator).toLowerCase(),strict?comparator===search:comparator.contains(search))})})}}]),angular.module("a8m.first",[]).filter("first",["$parse",function($parse){return function(collection){var n,getter,args;return collection=isObject(collection)?toArray(collection):collection,isArray(collection)?(args=Array.prototype.slice.call(arguments,1),n=isNumber(args[0])?args[0]:1,getter=isNumber(args[0])?isNumber(args[1])?undefined:args[1]:args[0],args.length?getFirstMatches(collection,n,getter?$parse(getter):getter):collection[0]):collection}}]),angular.module("a8m.flatten",[]).filter("flatten",function(){return function(collection,shallow){return shallow=shallow||!1,collection=isObject(collection)?toArray(collection):collection,isArray(collection)?shallow?[].concat.apply([],collection):flatten(collection,0):collection}}),angular.module("a8m.fuzzy-by",[]).filter("fuzzyBy",["$parse",function($parse){return function(collection,property,search,csensitive){var prop,getter,sensitive=csensitive||!1;return collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(property)||isUndefined(search)?collection:(getter=$parse(property),collection.filter(function(elm){return prop=getter(elm),!!isString(prop)&&(prop=sensitive?prop:prop.toLowerCase(),search=sensitive?search:search.toLowerCase(),hasApproxPattern(prop,search)!==!1)}))}}]),angular.module("a8m.fuzzy",[]).filter("fuzzy",function(){return function(collection,search,csensitive){function _hasApproximateKey(object,search){var prop,flag,properties=Object.keys(object);return 0<properties.filter(function(elm){return prop=object[elm],!!flag||!!isString(prop)&&(prop=sensitive?prop:prop.toLowerCase(),flag=hasApproxPattern(prop,search)!==!1)}).length}var sensitive=csensitive||!1;return collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(search)?collection:(search=sensitive?search:search.toLowerCase(),collection.filter(function(elm){return isString(elm)?(elm=sensitive?elm:elm.toLowerCase(),hasApproxPattern(elm,search)!==!1):!!isObject(elm)&&_hasApproximateKey(elm,search)}))}}),angular.module("a8m.group-by",["a8m.filter-watcher"]).filter("groupBy",["$parse","filterWatcher",function($parse,filterWatcher){return function(collection,property){function _groupBy(collection,getter){var prop,result={};return forEach(collection,function(elm){prop=getter(elm),result[prop]||(result[prop]=[]),result[prop].push(elm)}),result}return!isObject(collection)||isUndefined(property)?collection:filterWatcher.isMemoized("groupBy",arguments)||filterWatcher.memoize("groupBy",arguments,this,_groupBy(collection,$parse(property)))}}]),angular.module("a8m.is-empty",[]).filter("isEmpty",function(){return function(collection){return isObject(collection)?!toArray(collection).length:!collection.length}}),angular.module("a8m.join",[]).filter("join",function(){return function(input,delimiter){return isUndefined(input)||!isArray(input)?input:(isUndefined(delimiter)&&(delimiter=" "),input.join(delimiter))}}),angular.module("a8m.last",[]).filter("last",["$parse",function($parse){return function(collection){var n,getter,args,reversed=copy(collection);return reversed=isObject(reversed)?toArray(reversed):reversed,isArray(reversed)?(args=Array.prototype.slice.call(arguments,1),n=isNumber(args[0])?args[0]:1,getter=isNumber(args[0])?isNumber(args[1])?undefined:args[1]:args[0],args.length?getFirstMatches(reversed.reverse(),n,getter?$parse(getter):getter).reverse():reversed[reversed.length-1]):reversed}}]),angular.module("a8m.map",[]).filter("map",["$parse",function($parse){return function(collection,expression){return collection=isObject(collection)?toArray(collection):collection,
!isArray(collection)||isUndefined(expression)?collection:collection.map(function(elm){return $parse(expression)(elm)})}}]),angular.module("a8m.omit",[]).filter("omit",["$parse",function($parse){return function(collection,expression){return collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(expression)?collection:collection.filter(function(elm){return!$parse(expression)(elm)})}}]),angular.module("a8m.pick",[]).filter("pick",["$parse",function($parse){return function(collection,expression){return collection=isObject(collection)?toArray(collection):collection,!isArray(collection)||isUndefined(expression)?collection:collection.filter(function(elm){return $parse(expression)(elm)})}}]),angular.module("a8m.range",[]).filter("range",function(){return function(input,total,start,increment,cb){start=start||0,increment=increment||1;for(var i=0;i<parseInt(total);i++){var j=start+i*increment;input.push(isFunction(cb)?cb(j):j)}return input}}),angular.module("a8m.remove-with",[]).filter("removeWith",function(){return function(collection,object){return isUndefined(object)?collection:(collection=isObject(collection)?toArray(collection):collection,collection.filter(function(elm){return!objectContains(object,elm)}))}}),angular.module("a8m.remove",[]).filter("remove",function(){return function(collection){collection=isObject(collection)?toArray(collection):collection;var args=Array.prototype.slice.call(arguments,1);return isArray(collection)?collection.filter(function(member){return!args.some(function(nest){return equals(nest,member)})}):collection}}),angular.module("a8m.reverse",[]).filter("reverse",[function(){return function(input){return input=isObject(input)?toArray(input):input,isString(input)?input.split("").reverse().join(""):isArray(input)?input.slice().reverse():input}}]),angular.module("a8m.search-field",[]).filter("searchField",["$parse",function($parse){return function(collection){var get,field;collection=isObject(collection)?toArray(collection):collection;var args=Array.prototype.slice.call(arguments,1);return isArray(collection)&&args.length?collection.map(function(member){return field=args.map(function(field){return(get=$parse(field))(member)}).join(" "),extend(member,{searchField:field})}):collection}}]),angular.module("a8m.to-array",[]).filter("toArray",function(){return function(collection,addKey){return isObject(collection)?addKey?Object.keys(collection).map(function(key){return extend(collection[key],{$key:key})}):toArray(collection):collection}}),angular.module("a8m.unique",[]).filter({unique:["$parse",uniqFilter],uniq:["$parse",uniqFilter]}),angular.module("a8m.where",[]).filter("where",function(){return function(collection,object){return isUndefined(object)?collection:(collection=isObject(collection)?toArray(collection):collection,collection.filter(function(elm){return objectContains(object,elm)}))}}),angular.module("a8m.xor",[]).filter("xor",["$parse",function($parse){return function(col1,col2,expression){function some(el,col){var getter=$parse(expression);return col.some(function(dElm){return expression?equals(getter(dElm),getter(el)):equals(dElm,el)})}return expression=expression||!1,col1=isObject(col1)?toArray(col1):col1,col2=isObject(col2)?toArray(col2):col2,isArray(col1)&&isArray(col2)?col1.concat(col2).filter(function(elm){return!(some(elm,col1)&&some(elm,col2))}):col1}}]),angular.module("a8m.math.byteFmt",["a8m.math"]).filter("byteFmt",["$math",function($math){return function(bytes,decimal){return isNumber(decimal)&&isFinite(decimal)&&decimal%1===0&&decimal>=0&&isNumber(bytes)&&isFinite(bytes)?bytes<1024?convertToDecimal(bytes,decimal,$math)+" B":bytes<1048576?convertToDecimal(bytes/1024,decimal,$math)+" KB":bytes<1073741824?convertToDecimal(bytes/1048576,decimal,$math)+" MB":convertToDecimal(bytes/1073741824,decimal,$math)+" GB":"NaN"}}]),angular.module("a8m.math.degrees",["a8m.math"]).filter("degrees",["$math",function($math){return function(radians,decimal){if(isNumber(decimal)&&isFinite(decimal)&&decimal%1===0&&decimal>=0&&isNumber(radians)&&isFinite(radians)){var degrees=180*radians/$math.PI;return $math.round(degrees*$math.pow(10,decimal))/$math.pow(10,decimal)}return"NaN"}}]),angular.module("a8m.math.kbFmt",["a8m.math"]).filter("kbFmt",["$math",function($math){return function(bytes,decimal){return isNumber(decimal)&&isFinite(decimal)&&decimal%1===0&&decimal>=0&&isNumber(bytes)&&isFinite(bytes)?bytes<1024?convertToDecimal(bytes,decimal,$math)+" KB":bytes<1048576?convertToDecimal(bytes/1024,decimal,$math)+" MB":convertToDecimal(bytes/1048576,decimal,$math)+" GB":"NaN"}}]),angular.module("a8m.math",[]).factory("$math",["$window",function($window){return $window.Math}]),angular.module("a8m.math.max",["a8m.math"]).filter("max",["$math","$parse",function($math,$parse){function indexByMax(array,exp){var mappedArray=array.map(function(elm){return $parse(exp)(elm)});return mappedArray.indexOf($math.max.apply($math,mappedArray))}return function(input,expression){return isArray(input)?isUndefined(expression)?$math.max.apply($math,input):input[indexByMax(input,expression)]:input}}]),angular.module("a8m.math.min",["a8m.math"]).filter("min",["$math","$parse",function($math,$parse){function indexByMin(array,exp){var mappedArray=array.map(function(elm){return $parse(exp)(elm)});return mappedArray.indexOf($math.min.apply($math,mappedArray))}return function(input,expression){return isArray(input)?isUndefined(expression)?$math.min.apply($math,input):input[indexByMin(input,expression)]:input}}]),angular.module("a8m.math.percent",["a8m.math"]).filter("percent",["$math","$window",function($math,$window){return function(input,divided,round){var divider=isString(input)?$window.Number(input):input;return divided=divided||100,round=round||!1,!isNumber(divider)||$window.isNaN(divider)?input:round?$math.round(divider/divided*100):divider/divided*100}}]),angular.module("a8m.math.radians",["a8m.math"]).filter("radians",["$math",function($math){return function(degrees,decimal){if(isNumber(decimal)&&isFinite(decimal)&&decimal%1===0&&decimal>=0&&isNumber(degrees)&&isFinite(degrees)){var radians=3.14159265359*degrees/180;return $math.round(radians*$math.pow(10,decimal))/$math.pow(10,decimal)}return"NaN"}}]),angular.module("a8m.math.radix",[]).filter("radix",function(){return function(input,radix){var RANGE=/^[2-9]$|^[1-2]\d$|^3[0-6]$/;return isNumber(input)&&RANGE.test(radix)?input.toString(radix).toUpperCase():input}}),angular.module("a8m.math.shortFmt",["a8m.math"]).filter("shortFmt",["$math",function($math){return function(number,decimal){return isNumber(decimal)&&isFinite(decimal)&&decimal%1===0&&decimal>=0&&isNumber(number)&&isFinite(number)?number<1e3?number:number<1e6?convertToDecimal(number/1e3,decimal,$math)+" K":number<1e9?convertToDecimal(number/1e6,decimal,$math)+" M":convertToDecimal(number/1e9,decimal,$math)+" B":"NaN"}}]),angular.module("a8m.math.sum",[]).filter("sum",function(){return function(input,initial){return isArray(input)?input.reduce(function(prev,curr){return prev+curr},initial||0):input}}),angular.module("a8m.ends-with",[]).filter("endsWith",function(){return function(input,ends,csensitive){var position,sensitive=csensitive||!1;return!isString(input)||isUndefined(ends)?input:(input=sensitive?input:input.toLowerCase(),position=input.length-ends.length,input.indexOf(sensitive?ends:ends.toLowerCase(),position)!==-1)}}),angular.module("a8m.latinize",[]).filter("latinize",[function(){function removeDiacritics(str){return str.replace(/[^\u0000-\u007E]/g,function(a){return diacriticsMap[a]||a})}for(var defaultDiacriticsRemovalap=[{base:"A",letters:"A"},{base:"AA",letters:""},{base:"AE",letters:""},{base:"AO",letters:""},{base:"AU",letters:""},{base:"AV",letters:""},{base:"AY",letters:""},{base:"B",letters:"B"},{base:"C",letters:"C"},{base:"D",letters:"D"},{base:"DZ",letters:""},{base:"Dz",letters:""},{base:"E",letters:"E"},{base:"F",letters:"F"},{base:"G",letters:"G"},{base:"H",letters:"H"},{base:"I",letters:"I"},{base:"J",letters:"J"},{base:"K",letters:"K"},{base:"L",letters:"L"},{base:"LJ",letters:""},{base:"Lj",letters:""},{base:"M",letters:"M"},{base:"N",letters:"N"},{base:"NJ",letters:""},{base:"Nj",letters:""},{base:"O",letters:"O"},{base:"OI",letters:""},{base:"OO",letters:""},{base:"OU",letters:""},{base:"OE",letters:""},{base:"oe",letters:""},{base:"P",letters:"P"},{base:"Q",letters:"Q"},{base:"R",letters:"R"},{base:"S",letters:"S"},{base:"T",letters:"T"},{base:"TZ",letters:""},{base:"U",letters:"U"},{base:"V",letters:"V"},{base:"VY",letters:""},{base:"W",letters:"W"},{base:"X",letters:"X"},{base:"Y",letters:"Y"},{base:"Z",letters:"Z"},{base:"a",letters:"a"},{base:"aa",letters:""},{base:"ae",letters:""},{base:"ao",letters:""},{base:"au",letters:""},{base:"av",letters:""},{base:"ay",letters:""},{base:"b",letters:"b"},{base:"c",letters:"c"},{base:"d",letters:"d"},{base:"dz",letters:""},{base:"e",letters:"e"},{base:"f",letters:"f"},{base:"g",letters:"g"},{base:"h",letters:"h"},{base:"hv",letters:""},{base:"i",letters:"i"},{base:"j",letters:"j"},{base:"k",letters:"k"},{base:"l",letters:"l"},{base:"lj",letters:""},{base:"m",letters:"m"},{base:"n",letters:"n"},{base:"nj",letters:""},{base:"o",letters:"o"},{base:"oi",letters:""},{base:"ou",letters:""},{base:"oo",letters:""},{base:"p",letters:"p"},{base:"q",letters:"q"},{base:"r",letters:"r"},{base:"s",letters:"s"},{base:"t",letters:"t"},{base:"tz",letters:""},{base:"u",letters:"u"},{base:"v",letters:"v"},{base:"vy",letters:""},{base:"w",letters:"w"},{base:"x",letters:"x"},{base:"y",letters:"y"},{base:"z",letters:"z"}],diacriticsMap={},i=0;i<defaultDiacriticsRemovalap.length;i++)for(var letters=defaultDiacriticsRemovalap[i].letters.split(""),j=0;j<letters.length;j++)diacriticsMap[letters[j]]=defaultDiacriticsRemovalap[i].base;return function(input){return isString(input)?removeDiacritics(input):input}}]),angular.module("a8m.ltrim",[]).filter("ltrim",function(){return function(input,chars){var trim=chars||"\\s";return isString(input)?input.replace(new RegExp("^"+trim+"+"),""):input}}),angular.module("a8m.match",[]).filter("match",function(){return function(input,pattern,flag){var reg=new RegExp(pattern,flag);return isString(input)?input.match(reg):null}}),angular.module("a8m.repeat",[]).filter("repeat",[function(){return function(input,n,separator){var times=~~n;return isString(input)&&times?strRepeat(input,--n,separator||""):input}}]),angular.module("a8m.rtrim",[]).filter("rtrim",function(){return function(input,chars){var trim=chars||"\\s";return isString(input)?input.replace(new RegExp(trim+"+$"),""):input}}),angular.module("a8m.slugify",[]).filter("slugify",[function(){return function(input,sub){var replace=isUndefined(sub)?"-":sub;return isString(input)?input.toLowerCase().replace(/\s+/g,replace):input}}]),angular.module("a8m.starts-with",[]).filter("startsWith",function(){return function(input,start,csensitive){var sensitive=csensitive||!1;return!isString(input)||isUndefined(start)?input:(input=sensitive?input:input.toLowerCase(),!input.indexOf(sensitive?start:start.toLowerCase()))}}),angular.module("a8m.stringular",[]).filter("stringular",function(){return function(input){var args=Array.prototype.slice.call(arguments,1);return input.replace(/{(\d+)}/g,function(match,number){return isUndefined(args[number])?match:args[number]})}}),angular.module("a8m.strip-tags",[]).filter("stripTags",function(){return function(input){return isString(input)?input.replace(/<\S[^><]*>/g,""):input}}),angular.module("a8m.test",[]).filter("test",function(){return function(input,pattern,flag){var reg=new RegExp(pattern,flag);return isString(input)?reg.test(input):input}}),angular.module("a8m.trim",[]).filter("trim",function(){return function(input,chars){var trim=chars||"\\s";return isString(input)?input.replace(new RegExp("^"+trim+"+|"+trim+"+$","g"),""):input}}),angular.module("a8m.truncate",[]).filter("truncate",function(){return function(input,length,suffix,preserve){return length=isUndefined(length)?input.length:length,preserve=preserve||!1,suffix=suffix||"",!isString(input)||input.length<=length?input:input.substring(0,preserve?input.indexOf(" ",length)===-1?input.length:input.indexOf(" ",length):length)+suffix}}),angular.module("a8m.ucfirst",[]).filter("ucfirst",[function(){return function(input){return isString(input)?input.split(" ").map(function(ch){return ch.charAt(0).toUpperCase()+ch.substring(1)}).join(" "):input}}]),angular.module("a8m.uri-component-encode",[]).filter("uriComponentEncode",["$window",function($window){return function(input){return isString(input)?$window.encodeURIComponent(input):input}}]),angular.module("a8m.uri-encode",[]).filter("uriEncode",["$window",function($window){return function(input){return isString(input)?$window.encodeURI(input):input}}]),angular.module("a8m.wrap",[]).filter("wrap",function(){return function(input,wrap,ends){return isString(input)&&isDefined(wrap)?[wrap,input,ends||wrap].join(""):input}}),angular.module("a8m.filter-watcher",[]).provider("filterWatcher",function(){this.$get=["$window","$rootScope",function($window,$rootScope){function getHashKey(fName,args){function replacerFactory(){var cache=[];return function(key,val){if(isObject(val)&&!isNull(val)){if(~cache.indexOf(val))return"[Circular]";cache.push(val)}return $window==val?"$WINDOW":$window.document==val?"$DOCUMENT":isScope(val)?"$SCOPE":val}}return[fName,JSON.stringify(args,replacerFactory())].join("#").replace(/"/g,"")}function removeCache(event){var id=event.targetScope.$id;forEach($$listeners[id],function(key){delete $$cache[key]}),delete $$listeners[id]}function cleanStateless(){$$timeout(function(){$rootScope.$$phase||($$cache={})},2e3)}function addListener(scope,hashKey){var id=scope.$id;return isUndefined($$listeners[id])&&(scope.$on("$destroy",removeCache),$$listeners[id]=[]),$$listeners[id].push(hashKey)}function $$isMemoized(filterName,args){var hashKey=getHashKey(filterName,args);return $$cache[hashKey]}function $$memoize(filterName,args,scope,result){var hashKey=getHashKey(filterName,args);return $$cache[hashKey]=result,isScope(scope)?addListener(scope,hashKey):cleanStateless(),result}var $$cache={},$$listeners={},$$timeout=$window.setTimeout;return{isMemoized:$$isMemoized,memoize:$$memoize}}]}),angular.module("angular.filter",["a8m.ucfirst","a8m.uri-encode","a8m.uri-component-encode","a8m.slugify","a8m.latinize","a8m.strip-tags","a8m.stringular","a8m.truncate","a8m.starts-with","a8m.ends-with","a8m.wrap","a8m.trim","a8m.ltrim","a8m.rtrim","a8m.repeat","a8m.test","a8m.match","a8m.to-array","a8m.concat","a8m.contains","a8m.unique","a8m.is-empty","a8m.after","a8m.after-where","a8m.before","a8m.before-where","a8m.defaults","a8m.where","a8m.reverse","a8m.remove","a8m.remove-with","a8m.group-by","a8m.count-by","a8m.chunk-by","a8m.search-field","a8m.fuzzy-by","a8m.fuzzy","a8m.omit","a8m.pick","a8m.every","a8m.filter-by","a8m.xor","a8m.map","a8m.first","a8m.last","a8m.flatten","a8m.join","a8m.range","a8m.math","a8m.math.max","a8m.math.min","a8m.math.percent","a8m.math.radix","a8m.math.sum","a8m.math.degrees","a8m.math.radians","a8m.math.byteFmt","a8m.math.kbFmt","a8m.math.shortFmt","a8m.angular","a8m.conditions","a8m.is-null","a8m.filter-watcher"])}(window,window.angular),function(){angular.module("ui.grid.i18n",[]),angular.module("ui.grid",["ui.grid.i18n"])}(),function(){angular.module("ui.grid").constant("uiGridConstants",{LOG_DEBUG_MESSAGES:!0,LOG_WARN_MESSAGES:!0,LOG_ERROR_MESSAGES:!0,CUSTOM_FILTERS:/CUSTOM_FILTERS/g,COL_FIELD:/COL_FIELD/g,MODEL_COL_FIELD:/MODEL_COL_FIELD/g,TOOLTIP:/title=\"TOOLTIP\"/g,DISPLAY_CELL_TEMPLATE:/DISPLAY_CELL_TEMPLATE/g,TEMPLATE_REGEXP:/<.+>/,FUNC_REGEXP:/(\([^)]*\))?$/,DOT_REGEXP:/\./g,APOS_REGEXP:/'/g,BRACKET_REGEXP:/^(.*)((?:\s*\[\s*\d+\s*\]\s*)|(?:\s*\[\s*"(?:[^"\\]|\\.)*"\s*\]\s*)|(?:\s*\[\s*'(?:[^'\\]|\\.)*'\s*\]\s*))(.*)$/,COL_CLASS_PREFIX:"ui-grid-col",ENTITY_BINDING:"$$this",events:{GRID_SCROLL:"uiGridScroll",COLUMN_MENU_SHOWN:"uiGridColMenuShown",ITEM_DRAGGING:"uiGridItemDragStart",COLUMN_HEADER_CLICK:"uiGridColumnHeaderClick"},keymap:{TAB:9,STRG:17,CAPSLOCK:20,CTRL:17,CTRLRIGHT:18,CTRLR:18,SHIFT:16,RETURN:13,ENTER:13,BACKSPACE:8,BCKSP:8,ALT:18,ALTR:17,ALTRIGHT:17,SPACE:32,WIN:91,MAC:91,FN:null,PG_UP:33,PG_DOWN:34,UP:38,DOWN:40,LEFT:37,RIGHT:39,ESC:27,DEL:46,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123},ASC:"asc",DESC:"desc",filter:{STARTS_WITH:2,ENDS_WITH:4,EXACT:8,CONTAINS:16,GREATER_THAN:32,GREATER_THAN_OR_EQUAL:64,LESS_THAN:128,LESS_THAN_OR_EQUAL:256,NOT_EQUAL:512,SELECT:"select",INPUT:"input"},aggregationTypes:{sum:2,count:4,avg:8,min:16,max:32},CURRENCY_SYMBOLS:["","$","","$","","","","","","",""],scrollDirection:{UP:"up",DOWN:"down",LEFT:"left",RIGHT:"right",NONE:"none"},dataChange:{ALL:"all",EDIT:"edit",ROW:"row",COLUMN:"column",OPTIONS:"options"},scrollbars:{NEVER:0,ALWAYS:1}})}(),angular.module("ui.grid").directive("uiGridCell",["$compile","$parse","gridUtil","uiGridConstants",function($compile,$parse,gridUtil,uiGridConstants){var uiGridCell={priority:0,scope:!1,require:"?^uiGrid",compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){function compileTemplate(){var compiledElementFn=$scope.col.compiledElementFn;compiledElementFn($scope,function(clonedElement,scope){$elm.append(clonedElement)})}if(uiGridCtrl&&$scope.col.compiledElementFn)compileTemplate();else if(uiGridCtrl&&!$scope.col.compiledElementFn)$scope.col.getCompiledElementFn().then(function(compiledElementFn){compiledElementFn($scope,function(clonedElement,scope){$elm.append(clonedElement)})});else{var html=$scope.col.cellTemplate.replace(uiGridConstants.MODEL_COL_FIELD,"row.entity."+gridUtil.preEval($scope.col.field)).replace(uiGridConstants.COL_FIELD,"grid.getCellValue(row, col)"),cellElement=$compile(html)($scope);$elm.append(cellElement)}},post:function($scope,$elm,$attrs,uiGridCtrl){var initColClass=$scope.col.getColClass(!1);$elm.addClass(initColClass);var classAdded,updateClass=function(grid){var contents=$elm;classAdded&&(contents.removeClass(classAdded),classAdded=null),classAdded=angular.isFunction($scope.col.cellClass)?$scope.col.cellClass($scope.grid,$scope.row,$scope.col,$scope.rowRenderIndex,$scope.colRenderIndex):$scope.col.cellClass,contents.addClass(classAdded)};$scope.col.cellClass&&updateClass();var dataChangeDereg=$scope.grid.registerDataChangeCallback(updateClass,[uiGridConstants.dataChange.COLUMN,uiGridConstants.dataChange.EDIT]),cellChangeFunction=function(n,o){if(n!==o){(classAdded||$scope.col.cellClass)&&updateClass();var newColClass=$scope.col.getColClass(!1);newColClass!==initColClass&&($elm.removeClass(initColClass),$elm.addClass(newColClass),initColClass=newColClass)}},rowWatchDereg=$scope.$watch("row",cellChangeFunction),deregisterFunction=function(){dataChangeDereg(),rowWatchDereg()};$scope.$on("$destroy",deregisterFunction),$elm.on("$destroy",deregisterFunction)}}}};return uiGridCell}]),function(){angular.module("ui.grid").service("uiGridColumnMenuService",["i18nService","uiGridConstants","gridUtil",function(i18nService,uiGridConstants,gridUtil){var service={initialize:function($scope,uiGridCtrl){$scope.grid=uiGridCtrl.grid,uiGridCtrl.columnMenuScope=$scope,$scope.menuShown=!1},setColMenuItemWatch:function($scope){var deregFunction=$scope.$watch("col.menuItems",function(n){"undefined"!=typeof n&&n&&angular.isArray(n)?(n.forEach(function(item){"undefined"!=typeof item.context&&item.context||(item.context={}),item.context.col=$scope.col}),$scope.menuItems=$scope.defaultMenuItems.concat(n)):$scope.menuItems=$scope.defaultMenuItems});$scope.$on("$destroy",deregFunction)},sortable:function($scope){return!!($scope.grid.options.enableSorting&&"undefined"!=typeof $scope.col&&$scope.col&&$scope.col.enableSorting)},isActiveSort:function($scope,direction){return"undefined"!=typeof $scope.col&&"undefined"!=typeof $scope.col.sort&&"undefined"!=typeof $scope.col.sort.direction&&$scope.col.sort.direction===direction},suppressRemoveSort:function($scope){return!(!$scope.col||!$scope.col.suppressRemoveSort)},hideable:function($scope){return"undefined"==typeof $scope.col||!$scope.col||!$scope.col.colDef||$scope.col.colDef.enableHiding!==!1},getDefaultMenuItems:function($scope){return[{title:i18nService.getSafeText("sort.ascending"),icon:"ui-grid-icon-sort-alt-up",action:function($event){$event.stopPropagation(),$scope.sortColumn($event,uiGridConstants.ASC)},shown:function(){return service.sortable($scope)},active:function(){return service.isActiveSort($scope,uiGridConstants.ASC)}},{title:i18nService.getSafeText("sort.descending"),icon:"ui-grid-icon-sort-alt-down",action:function($event){$event.stopPropagation(),$scope.sortColumn($event,uiGridConstants.DESC)},shown:function(){return service.sortable($scope)},active:function(){return service.isActiveSort($scope,uiGridConstants.DESC)}},{title:i18nService.getSafeText("sort.remove"),icon:"ui-grid-icon-cancel",action:function($event){$event.stopPropagation(),$scope.unsortColumn()},shown:function(){return service.sortable($scope)&&"undefined"!=typeof $scope.col&&"undefined"!=typeof $scope.col.sort&&"undefined"!=typeof $scope.col.sort.direction&&null!==$scope.col.sort.direction&&!service.suppressRemoveSort($scope)}},{title:i18nService.getSafeText("column.hide"),icon:"ui-grid-icon-cancel",shown:function(){return service.hideable($scope)},action:function($event){$event.stopPropagation(),$scope.hideColumn()}}]},getColumnElementPosition:function($scope,column,$columnElement){var positionData={};return positionData.left=$columnElement[0].offsetLeft,positionData.top=$columnElement[0].offsetTop,positionData.parentLeft=$columnElement[0].offsetParent.offsetLeft,positionData.offset=0,column.grid.options.offsetLeft&&(positionData.offset=column.grid.options.offsetLeft),positionData.height=gridUtil.elementHeight($columnElement,!0),positionData.width=gridUtil.elementWidth($columnElement,!0),positionData},repositionMenu:function($scope,column,positionData,$elm,$columnElement){var menu=$elm[0].querySelectorAll(".ui-grid-menu"),renderContainerElm=gridUtil.closestElm($columnElement,".ui-grid-render-container"),renderContainerOffset=renderContainerElm.getBoundingClientRect().left-$scope.grid.element[0].getBoundingClientRect().left,containerScrollLeft=renderContainerElm.querySelectorAll(".ui-grid-viewport")[0].scrollLeft,myWidth=column.lastMenuWidth?column.lastMenuWidth:$scope.lastMenuWidth?$scope.lastMenuWidth:170,paddingRight=column.lastMenuPaddingRight?column.lastMenuPaddingRight:$scope.lastMenuPaddingRight?$scope.lastMenuPaddingRight:10;if(0!==menu.length){var mid=menu[0].querySelectorAll(".ui-grid-menu-mid");0===mid.length||angular.element(mid).hasClass("ng-hide")||(myWidth=gridUtil.elementWidth(menu,!0),$scope.lastMenuWidth=myWidth,column.lastMenuWidth=myWidth,paddingRight=parseInt(gridUtil.getStyles(angular.element(menu)[0]).paddingRight,10),$scope.lastMenuPaddingRight=paddingRight,column.lastMenuPaddingRight=paddingRight)}var left=positionData.left+renderContainerOffset-containerScrollLeft+positionData.parentLeft+positionData.width-myWidth+paddingRight;left<positionData.offset&&(left=positionData.offset),$elm.css("left",left+"px"),$elm.css("top",positionData.top+positionData.height+"px")}};return service}]).directive("uiGridColumnMenu",["$timeout","gridUtil","uiGridConstants","uiGridColumnMenuService","$document",function($timeout,gridUtil,uiGridConstants,uiGridColumnMenuService,$document){var uiGridColumnMenu={priority:0,scope:!0,require:"^uiGrid",templateUrl:"ui-grid/uiGridColumnMenu",replace:!0,link:function($scope,$elm,$attrs,uiGridCtrl){uiGridColumnMenuService.initialize($scope,uiGridCtrl),$scope.defaultMenuItems=uiGridColumnMenuService.getDefaultMenuItems($scope),$scope.menuItems=$scope.defaultMenuItems,uiGridColumnMenuService.setColMenuItemWatch($scope),$scope.showMenu=function(column,$columnElement,event){$scope.col=column;var colElementPosition=uiGridColumnMenuService.getColumnElementPosition($scope,column,$columnElement);$scope.menuShown?($scope.colElement=$columnElement,$scope.colElementPosition=colElementPosition,$scope.hideThenShow=!0,$scope.$broadcast("hide-menu",{originalEvent:event})):($scope.menuShown=!0,uiGridColumnMenuService.repositionMenu($scope,column,colElementPosition,$elm,$columnElement),$scope.colElement=$columnElement,$scope.colElementPosition=colElementPosition,$scope.$broadcast("show-menu",{originalEvent:event}))},$scope.hideMenu=function(broadcastTrigger){$scope.menuShown=!1,broadcastTrigger||$scope.$broadcast("hide-menu")},$scope.$on("menu-hidden",function(){$scope.hideThenShow?(delete $scope.hideThenShow,uiGridColumnMenuService.repositionMenu($scope,$scope.col,$scope.colElementPosition,$elm,$scope.colElement),$scope.$broadcast("show-menu"),$scope.menuShown=!0):($scope.hideMenu(!0),$scope.col&&gridUtil.focus.bySelector($document,".ui-grid-header-cell."+$scope.col.getColClass()+" .ui-grid-column-menu-button",$scope.col.grid,!1))}),$scope.$on("menu-shown",function(){$timeout(function(){uiGridColumnMenuService.repositionMenu($scope,$scope.col,$scope.colElementPosition,$elm,$scope.colElement),gridUtil.focus.bySelector($document,".ui-grid-menu-items .ui-grid-menu-item",!0),delete $scope.colElementPosition,delete $scope.columnElement},200)}),$scope.sortColumn=function(event,dir){event.stopPropagation(),$scope.grid.sortColumn($scope.col,dir,!0).then(function(){$scope.grid.refresh(),$scope.hideMenu()})},$scope.unsortColumn=function(){$scope.col.unsort(),$scope.grid.refresh(),$scope.hideMenu()};var setFocusOnHideColumn=function(){$timeout(function(){var thisIndex,focusToGridMenu=function(){return gridUtil.focus.byId("grid-menu",$scope.grid)};$scope.grid.columns.some(function(element,index){if(angular.equals(element,$scope.col))return thisIndex=index,!0});var previousVisibleCol;if($scope.grid.columns.some(function(element,index){if(!element.visible)return!1;if(index<thisIndex)previousVisibleCol=element;else{if(index>thisIndex&&!previousVisibleCol)return previousVisibleCol=element,!0;if(index>thisIndex&&previousVisibleCol)return!0}}),previousVisibleCol){var colClass=previousVisibleCol.getColClass();gridUtil.focus.bySelector($document,".ui-grid-header-cell."+colClass+" .ui-grid-header-cell-primary-focus",!0).then(angular.noop,function(reason){if("canceled"!==reason)return focusToGridMenu()})}else focusToGridMenu()})};$scope.hideColumn=function(){$scope.col.colDef.visible=!1,$scope.col.visible=!1,$scope.grid.queueGridRefresh(),$scope.hideMenu(),$scope.grid.api.core.notifyDataChange(uiGridConstants.dataChange.COLUMN),$scope.grid.api.core.raise.columnVisibilityChanged($scope.col),setFocusOnHideColumn()}},controller:["$scope",function($scope){var self=this;$scope.$watch("menuItems",function(n){self.menuItems=n})}]};return uiGridColumnMenu}])}(),function(){angular.module("ui.grid").directive("uiGridFilter",["$compile","$templateCache","i18nService","gridUtil",function($compile,$templateCache,i18nService,gridUtil){return{compile:function(){return{pre:function($scope,$elm,$attrs,controllers){$scope.col.updateFilters=function(filterable){if($elm.children().remove(),filterable){var template=$scope.col.filterHeaderTemplate;$elm.append($compile(template)($scope))}},$scope.$on("$destroy",function(){delete $scope.col.updateFilters})},post:function($scope,$elm,$attrs,controllers){$scope.aria=i18nService.getSafeText("headerCell.aria"),$scope.removeFilter=function(colFilter,index){colFilter.term=null,gridUtil.focus.bySelector($elm,".ui-grid-filter-input-"+index)}}}}}}])}(),function(){angular.module("ui.grid").directive("uiGridFooterCell",["$timeout","gridUtil","uiGridConstants","$compile",function($timeout,gridUtil,uiGridConstants,$compile){var uiGridFooterCell={priority:0,scope:{col:"=",row:"=",renderIndex:"="},replace:!0,require:"^uiGrid",compile:function(tElement,tAttrs,transclude){return{pre:function($scope,$elm,$attrs,uiGridCtrl){var cellFooter=$compile($scope.col.footerCellTemplate)($scope);$elm.append(cellFooter)},post:function($scope,$elm,$attrs,uiGridCtrl){$scope.grid=uiGridCtrl.grid;var initColClass=$scope.col.getColClass(!1);$elm.addClass(initColClass);var classAdded,updateClass=function(grid){var contents=$elm;classAdded&&(contents.removeClass(classAdded),classAdded=null),classAdded=angular.isFunction($scope.col.footerCellClass)?$scope.col.footerCellClass($scope.grid,$scope.row,$scope.col,$scope.rowRenderIndex,$scope.colRenderIndex):$scope.col.footerCellClass,contents.addClass(classAdded)};$scope.col.footerCellClass&&updateClass(),$scope.col.updateAggregationValue();var dataChangeDereg=$scope.grid.registerDataChangeCallback(updateClass,[uiGridConstants.dataChange.COLUMN]);$scope.grid.api.core.on.rowsRendered($scope,$scope.col.updateAggregationValue),$scope.grid.api.core.on.rowsRendered($scope,updateClass),$scope.$on("$destroy",dataChangeDereg)}}}};return uiGridFooterCell}])}(),function(){angular.module("ui.grid").directive("uiGridFooter",["$templateCache","$compile","uiGridConstants","gridUtil","$timeout",function($templateCache,$compile,uiGridConstants,gridUtil,$timeout){return{restrict:"EA",replace:!0,require:["^uiGrid","^uiGridRenderContainer"],scope:!0,compile:function($elm,$attrs){return{pre:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0],containerCtrl=controllers[1];$scope.grid=uiGridCtrl.grid,$scope.colContainer=containerCtrl.colContainer,containerCtrl.footer=$elm;var footerTemplate=$scope.grid.options.footerTemplate;gridUtil.getTemplate(footerTemplate).then(function(contents){var template=angular.element(contents),newElm=$compile(template)($scope);if($elm.append(newElm),containerCtrl){var footerViewport=$elm[0].getElementsByClassName("ui-grid-footer-viewport")[0];footerViewport&&(containerCtrl.footerViewport=footerViewport)}})},post:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0],containerCtrl=controllers[1];uiGridCtrl.grid;gridUtil.disableAnimations($elm),containerCtrl.footer=$elm;var footerViewport=$elm[0].getElementsByClassName("ui-grid-footer-viewport")[0];footerViewport&&(containerCtrl.footerViewport=footerViewport)}}}}}])}(),function(){angular.module("ui.grid").directive("uiGridGridFooter",["$templateCache","$compile","uiGridConstants","gridUtil","$timeout",function($templateCache,$compile,uiGridConstants,gridUtil,$timeout){return{restrict:"EA",replace:!0,require:"^uiGrid",scope:!0,compile:function($elm,$attrs){return{pre:function($scope,$elm,$attrs,uiGridCtrl){$scope.grid=uiGridCtrl.grid;var footerTemplate=$scope.grid.options.gridFooterTemplate;gridUtil.getTemplate(footerTemplate).then(function(contents){var template=angular.element(contents),newElm=$compile(template)($scope);$elm.append(newElm)})},post:function($scope,$elm,$attrs,controllers){}}}}}])}(),function(){angular.module("ui.grid").directive("uiGridGroupPanel",["$compile","uiGridConstants","gridUtil",function($compile,uiGridConstants,gridUtil){var defaultTemplate="ui-grid/ui-grid-group-panel";return{restrict:"EA",replace:!0,require:"?^uiGrid",scope:!1,compile:function($elm,$attrs){return{pre:function($scope,$elm,$attrs,uiGridCtrl){var groupPanelTemplate=$scope.grid.options.groupPanelTemplate||defaultTemplate;gridUtil.getTemplate(groupPanelTemplate).then(function(contents){
var template=angular.element(contents),newElm=$compile(template)($scope);$elm.append(newElm)})},post:function($scope,$elm,$attrs,uiGridCtrl){$elm.bind("$destroy",function(){})}}}}}])}(),function(){angular.module("ui.grid").directive("uiGridHeaderCell",["$compile","$timeout","$window","$document","gridUtil","uiGridConstants","ScrollEvent","i18nService",function($compile,$timeout,$window,$document,gridUtil,uiGridConstants,ScrollEvent,i18nService){var mousedownTimeout=500,changeModeTimeout=500,uiGridHeaderCell={priority:0,scope:{col:"=",row:"=",renderIndex:"="},require:["^uiGrid","^uiGridRenderContainer"],replace:!0,compile:function(){return{pre:function($scope,$elm,$attrs){var cellHeader=$compile($scope.col.headerCellTemplate)($scope);$elm.append(cellHeader)},post:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0],renderContainerCtrl=controllers[1];$scope.i18n={headerCell:i18nService.getSafeText("headerCell"),sort:i18nService.getSafeText("sort")},$scope.isSortPriorityVisible=function(){return angular.isNumber($scope.col.sort.priority)&&$scope.grid.columns.some(function(element,index){return angular.isNumber(element.sort.priority)&&element!==$scope.col})},$scope.getSortDirectionAriaLabel=function(){var col=$scope.col,sortDirectionText=col.sort.direction===uiGridConstants.ASC?$scope.i18n.sort.ascending:col.sort.direction===uiGridConstants.DESC?$scope.i18n.sort.descending:$scope.i18n.sort.none,label=sortDirectionText;return $scope.isSortPriorityVisible()&&(label=label+". "+$scope.i18n.headerCell.priority+" "+col.sort.priority),label},$scope.grid=uiGridCtrl.grid,$scope.renderContainer=uiGridCtrl.grid.renderContainers[renderContainerCtrl.containerId];var initColClass=$scope.col.getColClass(!1);$elm.addClass(initColClass),$scope.menuShown=!1,$scope.asc=uiGridConstants.ASC,$scope.desc=uiGridConstants.DESC;var classAdded,previousMouseX,$contentsElm=(angular.element($elm[0].querySelectorAll(".ui-grid-header-cell-menu")),angular.element($elm[0].querySelectorAll(".ui-grid-cell-contents"))),filterDeregisters=[];$scope.downFn=function(event){event.stopPropagation(),"undefined"!=typeof event.originalEvent&&void 0!==event.originalEvent&&(event=event.originalEvent),event.button&&0!==event.button||(previousMouseX=event.pageX,$scope.mousedownStartTime=(new Date).getTime(),$scope.mousedownTimeout=$timeout(function(){},mousedownTimeout),$scope.mousedownTimeout.then(function(){$scope.colMenu&&uiGridCtrl.columnMenuScope.showMenu($scope.col,$elm,event)}),uiGridCtrl.fireEvent(uiGridConstants.events.COLUMN_HEADER_CLICK,{event:event,columnName:$scope.col.colDef.name}),$scope.offAllEvents(),"touchstart"===event.type?($document.on("touchend",$scope.upFn),$document.on("touchmove",$scope.moveFn)):"mousedown"===event.type&&($document.on("mouseup",$scope.upFn),$document.on("mousemove",$scope.moveFn)))},$scope.upFn=function(event){event.stopPropagation(),$timeout.cancel($scope.mousedownTimeout),$scope.offAllEvents(),$scope.onDownEvents(event.type);var mousedownEndTime=(new Date).getTime(),mousedownTime=mousedownEndTime-$scope.mousedownStartTime;mousedownTime>mousedownTimeout||$scope.sortable&&$scope.handleClick(event)},$scope.moveFn=function(event){var changeValue=event.pageX-previousMouseX;0!==changeValue&&($timeout.cancel($scope.mousedownTimeout),$scope.offAllEvents(),$scope.onDownEvents(event.type))},$scope.clickFn=function(event){event.stopPropagation(),$contentsElm.off("click",$scope.clickFn)},$scope.offAllEvents=function(){$contentsElm.off("touchstart",$scope.downFn),$contentsElm.off("mousedown",$scope.downFn),$document.off("touchend",$scope.upFn),$document.off("mouseup",$scope.upFn),$document.off("touchmove",$scope.moveFn),$document.off("mousemove",$scope.moveFn),$contentsElm.off("click",$scope.clickFn)},$scope.onDownEvents=function(type){switch(type){case"touchmove":case"touchend":$contentsElm.on("click",$scope.clickFn),$contentsElm.on("touchstart",$scope.downFn),$timeout(function(){$contentsElm.on("mousedown",$scope.downFn)},changeModeTimeout);break;case"mousemove":case"mouseup":$contentsElm.on("click",$scope.clickFn),$contentsElm.on("mousedown",$scope.downFn),$timeout(function(){$contentsElm.on("touchstart",$scope.downFn)},changeModeTimeout);break;default:$contentsElm.on("click",$scope.clickFn),$contentsElm.on("touchstart",$scope.downFn),$contentsElm.on("mousedown",$scope.downFn)}};var updateHeaderOptions=function(grid){var contents=$elm;classAdded&&(contents.removeClass(classAdded),classAdded=null),classAdded=angular.isFunction($scope.col.headerCellClass)?$scope.col.headerCellClass($scope.grid,$scope.row,$scope.col,$scope.rowRenderIndex,$scope.colRenderIndex):$scope.col.headerCellClass,contents.addClass(classAdded),$timeout(function(){var rightMostContainer=$scope.grid.renderContainers.right?$scope.grid.renderContainers.right:$scope.grid.renderContainers.body;$scope.isLastCol=$scope.col===rightMostContainer.visibleColumnCache[rightMostContainer.visibleColumnCache.length-1]}),uiGridCtrl.grid.options.enableSorting&&$scope.col.enableSorting?$scope.sortable=!0:$scope.sortable=!1;var oldFilterable=$scope.filterable;uiGridCtrl.grid.options.enableFiltering&&$scope.col.enableFiltering?$scope.filterable=!0:$scope.filterable=!1,oldFilterable!==$scope.filterable&&("undefined"!=typeof $scope.col.updateFilters&&$scope.col.updateFilters($scope.filterable),$scope.filterable?($scope.col.filters.forEach(function(filter,i){filterDeregisters.push($scope.$watch("col.filters["+i+"].term",function(n,o){n!==o&&(uiGridCtrl.grid.api.core.raise.filterChanged(),uiGridCtrl.grid.api.core.notifyDataChange(uiGridConstants.dataChange.COLUMN),uiGridCtrl.grid.queueGridRefresh())}))}),$scope.$on("$destroy",function(){filterDeregisters.forEach(function(filterDeregister){filterDeregister()})})):filterDeregisters.forEach(function(filterDeregister){filterDeregister()})),$scope.col.grid.options&&$scope.col.grid.options.enableColumnMenus!==!1&&$scope.col.colDef&&$scope.col.colDef.enableColumnMenu!==!1?$scope.colMenu=!0:$scope.colMenu=!1,$scope.offAllEvents(),($scope.sortable||$scope.colMenu)&&($scope.onDownEvents(),$scope.$on("$destroy",function(){$scope.offAllEvents()}))};updateHeaderOptions();var dataChangeDereg=$scope.grid.registerDataChangeCallback(updateHeaderOptions,[uiGridConstants.dataChange.COLUMN]);$scope.$on("$destroy",dataChangeDereg),$scope.handleClick=function(event){var add=!1;event.shiftKey&&(add=!0),uiGridCtrl.grid.sortColumn($scope.col,add).then(function(){uiGridCtrl.columnMenuScope&&uiGridCtrl.columnMenuScope.hideMenu(),uiGridCtrl.grid.refresh()})},$scope.toggleMenu=function(event){event.stopPropagation(),uiGridCtrl.columnMenuScope.menuShown&&uiGridCtrl.columnMenuScope.col===$scope.col?uiGridCtrl.columnMenuScope.hideMenu():uiGridCtrl.columnMenuScope.showMenu($scope.col,$elm)}}}}};return uiGridHeaderCell}])}(),function(){angular.module("ui.grid").directive("uiGridHeader",["$templateCache","$compile","uiGridConstants","gridUtil","$timeout","ScrollEvent",function($templateCache,$compile,uiGridConstants,gridUtil,$timeout,ScrollEvent){var defaultTemplate="ui-grid/ui-grid-header",emptyTemplate="ui-grid/ui-grid-no-header";return{restrict:"EA",replace:!0,require:["^uiGrid","^uiGridRenderContainer"],scope:!0,compile:function($elm,$attrs){return{pre:function($scope,$elm,$attrs,controllers){function updateHeaderReferences(){containerCtrl.header=containerCtrl.colContainer.header=$elm;var headerCanvases=$elm[0].getElementsByClassName("ui-grid-header-canvas");headerCanvases.length>0?containerCtrl.headerCanvas=containerCtrl.colContainer.headerCanvas=headerCanvases[0]:containerCtrl.headerCanvas=null}function scrollHandler(evt){if(!uiGridCtrl.grid.isScrollingHorizontally){var newScrollLeft=gridUtil.normalizeScrollLeft(containerCtrl.headerViewport,uiGridCtrl.grid),horizScrollPercentage=containerCtrl.colContainer.scrollHorizontal(newScrollLeft),scrollEvent=new ScrollEvent(uiGridCtrl.grid,null,containerCtrl.colContainer,ScrollEvent.Sources.ViewPortScroll);scrollEvent.newScrollLeft=newScrollLeft,horizScrollPercentage>-1&&(scrollEvent.x={percentage:horizScrollPercentage}),uiGridCtrl.grid.scrollContainers(null,scrollEvent)}}var uiGridCtrl=controllers[0],containerCtrl=controllers[1];$scope.grid=uiGridCtrl.grid,$scope.colContainer=containerCtrl.colContainer,updateHeaderReferences();var headerTemplate;headerTemplate=$scope.grid.options.showHeader?$scope.grid.options.headerTemplate?$scope.grid.options.headerTemplate:defaultTemplate:emptyTemplate,gridUtil.getTemplate(headerTemplate).then(function(contents){var template=angular.element(contents),newElm=$compile(template)($scope);if($elm.replaceWith(newElm),$elm=newElm,updateHeaderReferences(),containerCtrl){var headerViewport=$elm[0].getElementsByClassName("ui-grid-header-viewport")[0];headerViewport&&(containerCtrl.headerViewport=headerViewport,angular.element(headerViewport).on("scroll",scrollHandler),$scope.$on("$destroy",function(){angular.element(headerViewport).off("scroll",scrollHandler)}))}$scope.grid.queueRefresh()})},post:function($scope,$elm,$attrs,controllers){function updateColumnWidths(){var columnCache=containerCtrl.colContainer.visibleColumnCache,ret="",canvasWidth=0;return columnCache.forEach(function(column){ret+=column.getColClassDefinition(),canvasWidth+=column.drawnWidth}),containerCtrl.colContainer.canvasWidth=canvasWidth,ret}var uiGridCtrl=controllers[0],containerCtrl=controllers[1];uiGridCtrl.grid;gridUtil.disableAnimations($elm),containerCtrl.header=$elm;var headerViewport=$elm[0].getElementsByClassName("ui-grid-header-viewport")[0];headerViewport&&(containerCtrl.headerViewport=headerViewport),uiGridCtrl&&uiGridCtrl.grid.registerStyleComputation({priority:15,func:updateColumnWidths})}}}}}])}(),function(){angular.module("ui.grid").service("uiGridGridMenuService",["gridUtil","i18nService","uiGridConstants",function(gridUtil,i18nService,uiGridConstants){var service={initialize:function($scope,grid){grid.gridMenuScope=$scope,$scope.grid=grid,$scope.registeredMenuItems=[],$scope.$on("$destroy",function(){$scope.grid&&$scope.grid.gridMenuScope&&($scope.grid.gridMenuScope=null),$scope.grid&&($scope.grid=null),$scope.registeredMenuItems&&($scope.registeredMenuItems=null)}),$scope.registeredMenuItems=[],grid.api.registerMethod("core","addToGridMenu",service.addToGridMenu),grid.api.registerMethod("core","removeFromGridMenu",service.removeFromGridMenu)},addToGridMenu:function(grid,menuItems){angular.isArray(menuItems)?grid.gridMenuScope?(grid.gridMenuScope.registeredMenuItems=grid.gridMenuScope.registeredMenuItems?grid.gridMenuScope.registeredMenuItems:[],grid.gridMenuScope.registeredMenuItems=grid.gridMenuScope.registeredMenuItems.concat(menuItems)):gridUtil.logError("Asked to addToGridMenu, but gridMenuScope not present.  Timing issue?  Please log issue with ui-grid"):gridUtil.logError("addToGridMenu: menuItems must be an array, and is not, not adding any items")},removeFromGridMenu:function(grid,id){var foundIndex=-1;grid&&grid.gridMenuScope&&grid.gridMenuScope.registeredMenuItems.forEach(function(value,index){value.id===id&&(foundIndex>-1?gridUtil.logError("removeFromGridMenu: found multiple items with the same id, removing only the last"):foundIndex=index)}),foundIndex>-1&&grid.gridMenuScope.registeredMenuItems.splice(foundIndex,1)},getMenuItems:function($scope){var menuItems=[];$scope.grid.options.gridMenuCustomItems&&(angular.isArray($scope.grid.options.gridMenuCustomItems)?menuItems=menuItems.concat($scope.grid.options.gridMenuCustomItems):gridUtil.logError("gridOptions.gridMenuCustomItems must be an array, and is not"));var clearFilters=[{title:i18nService.getSafeText("gridMenu.clearAllFilters"),action:function($event){$scope.grid.clearAllFilters(void 0,!0,void 0)},shown:function(){return $scope.grid.options.enableFiltering},order:100}];return menuItems=menuItems.concat(clearFilters),menuItems=menuItems.concat($scope.registeredMenuItems),$scope.grid.options.gridMenuShowHideColumns!==!1&&(menuItems=menuItems.concat(service.showHideColumns($scope))),menuItems.sort(function(a,b){return a.order-b.order}),menuItems},showHideColumns:function($scope){var showHideColumns=[];return $scope.grid.options.columnDefs&&0!==$scope.grid.options.columnDefs.length&&0!==$scope.grid.columns.length?(showHideColumns.push({title:i18nService.getSafeText("gridMenu.columns"),order:300}),$scope.grid.options.gridMenuTitleFilter=$scope.grid.options.gridMenuTitleFilter?$scope.grid.options.gridMenuTitleFilter:function(title){return title},$scope.grid.options.columnDefs.forEach(function(colDef,index){if(colDef.enableHiding!==!1){var menuItem={icon:"ui-grid-icon-ok",action:function($event){$event.stopPropagation(),service.toggleColumnVisibility(this.context.gridCol)},shown:function(){return this.context.gridCol.colDef.visible===!0||void 0===this.context.gridCol.colDef.visible},context:{gridCol:$scope.grid.getColumn(colDef.name||colDef.field)},leaveOpen:!0,order:301+2*index};service.setMenuItemTitle(menuItem,colDef,$scope.grid),showHideColumns.push(menuItem),menuItem={icon:"ui-grid-icon-cancel",action:function($event){$event.stopPropagation(),service.toggleColumnVisibility(this.context.gridCol)},shown:function(){return!(this.context.gridCol.colDef.visible===!0||void 0===this.context.gridCol.colDef.visible)},context:{gridCol:$scope.grid.getColumn(colDef.name||colDef.field)},leaveOpen:!0,order:301+2*index+1},service.setMenuItemTitle(menuItem,colDef,$scope.grid),showHideColumns.push(menuItem)}}),showHideColumns):showHideColumns},setMenuItemTitle:function(menuItem,colDef,grid){var title=grid.options.gridMenuTitleFilter(colDef.displayName||gridUtil.readableColumnName(colDef.name)||colDef.field);"string"==typeof title?menuItem.title=title:title.then?(menuItem.title="",title.then(function(successValue){menuItem.title=successValue},function(errorValue){menuItem.title=errorValue})):(gridUtil.logError("Expected gridMenuTitleFilter to return a string or a promise, it has returned neither, bad config"),menuItem.title="badconfig")},toggleColumnVisibility:function(gridCol){gridCol.colDef.visible=!(gridCol.colDef.visible===!0||void 0===gridCol.colDef.visible),gridCol.grid.refresh(),gridCol.grid.api.core.notifyDataChange(uiGridConstants.dataChange.COLUMN),gridCol.grid.api.core.raise.columnVisibilityChanged(gridCol)}};return service}]).directive("uiGridMenuButton",["gridUtil","uiGridConstants","uiGridGridMenuService","i18nService",function(gridUtil,uiGridConstants,uiGridGridMenuService,i18nService){return{priority:0,scope:!0,require:["^uiGrid"],templateUrl:"ui-grid/ui-grid-menu-button",replace:!0,link:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0];$scope.i18n={aria:i18nService.getSafeText("gridMenu.aria")},uiGridGridMenuService.initialize($scope,uiGridCtrl.grid),$scope.shown=!1,$scope.toggleMenu=function(){$scope.shown?($scope.$broadcast("hide-menu"),$scope.shown=!1):($scope.menuItems=uiGridGridMenuService.getMenuItems($scope),$scope.$broadcast("show-menu"),$scope.shown=!0)},$scope.$on("menu-hidden",function(){$scope.shown=!1,gridUtil.focus.bySelector($elm,".ui-grid-icon-container")})}}}])}(),function(){angular.module("ui.grid").directive("uiGridMenu",["$compile","$timeout","$window","$document","gridUtil","uiGridConstants","i18nService",function($compile,$timeout,$window,$document,gridUtil,uiGridConstants,i18nService){var uiGridMenu={priority:0,scope:{menuItems:"=",autoHide:"=?"},require:"?^uiGrid",templateUrl:"ui-grid/uiGridMenu",replace:!1,link:function($scope,$elm,$attrs,uiGridCtrl){$scope.dynamicStyles="";var setupHeightStyle=function(gridHeight){var gridMenuMaxHeight=gridHeight-uiGridCtrl.grid.headerHeight-20;$scope.dynamicStyles=[".grid"+uiGridCtrl.grid.id+" .ui-grid-menu-mid {","max-height: "+gridMenuMaxHeight+"px;","}"].join(" ")};uiGridCtrl&&(setupHeightStyle(uiGridCtrl.grid.gridHeight),uiGridCtrl.grid.api.core.on.gridDimensionChanged($scope,function(oldGridHeight,oldGridWidth,newGridHeight,newGridWidth){setupHeightStyle(newGridHeight)})),$scope.i18n={close:i18nService.getSafeText("columnMenu.close")},$scope.showMenu=function(event,args){$scope.shown?$scope.shownMid||($scope.shownMid=!0,$scope.$emit("menu-shown")):($scope.shown=!0,$timeout(function(){$scope.shownMid=!0,$scope.$emit("menu-shown")}));var docEventType="click";args&&args.originalEvent&&args.originalEvent.type&&"touchstart"===args.originalEvent.type&&(docEventType=args.originalEvent.type),angular.element(document).off("click touchstart",applyHideMenu),$elm.off("keyup",checkKeyUp),$elm.off("keydown",checkKeyDown),$timeout(function(){angular.element(document).on(docEventType,applyHideMenu),$elm.on("keyup",checkKeyUp),$elm.on("keydown",checkKeyDown)}),gridUtil.focus.bySelector($elm,"button[type=button]",!0)},$scope.hideMenu=function(event){$scope.shown&&($scope.shownMid=!1,$timeout(function(){$scope.shownMid||($scope.shown=!1,$scope.$emit("menu-hidden"))},200)),angular.element(document).off("click touchstart",applyHideMenu),$elm.off("keyup",checkKeyUp),$elm.off("keydown",checkKeyDown)},$scope.$on("hide-menu",function(event,args){$scope.hideMenu(event,args)}),$scope.$on("show-menu",function(event,args){$scope.showMenu(event,args)});var applyHideMenu=function(){$scope.shown&&$scope.$apply(function(){$scope.hideMenu()})},checkKeyUp=function(event){27===event.keyCode&&$scope.hideMenu()},checkKeyDown=function(event){var setFocus=function(elm){return elm.focus(),event.preventDefault(),!1};if(9===event.keyCode){var firstMenuItem,lastMenuItem,menuItemButtons=$elm[0].querySelectorAll("button:not(.ng-hide)");menuItemButtons.length>0&&(firstMenuItem=menuItemButtons[0],lastMenuItem=menuItemButtons[menuItemButtons.length-1],event.target!==lastMenuItem||event.shiftKey?event.target===firstMenuItem&&event.shiftKey&&setFocus(lastMenuItem):setFocus(firstMenuItem))}};"undefined"!=typeof $scope.autoHide&&void 0!==$scope.autoHide||($scope.autoHide=!0),$scope.autoHide&&angular.element($window).on("resize",applyHideMenu),$scope.$on("$destroy",function(){angular.element(document).off("click touchstart",applyHideMenu)}),$scope.$on("$destroy",function(){angular.element($window).off("resize",applyHideMenu)}),uiGridCtrl&&$scope.$on("$destroy",uiGridCtrl.grid.api.core.on.scrollBegin($scope,applyHideMenu)),$scope.$on("$destroy",$scope.$on(uiGridConstants.events.ITEM_DRAGGING,applyHideMenu))}};return uiGridMenu}]).directive("uiGridMenuItem",["gridUtil","$compile","i18nService",function(gridUtil,$compile,i18nService){var uiGridMenuItem={priority:0,scope:{name:"=",active:"=",action:"=",icon:"=",shown:"=",context:"=",templateUrl:"=",leaveOpen:"=",screenReaderOnly:"="},require:["?^uiGrid"],templateUrl:"ui-grid/uiGridMenuItem",replace:!1,compile:function(){return{pre:function($scope,$elm){$scope.templateUrl&&gridUtil.getTemplate($scope.templateUrl).then(function(contents){var template=angular.element(contents),newElm=$compile(template)($scope);$elm.replaceWith(newElm)})},post:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0];"undefined"!=typeof $scope.shown&&null!==$scope.shown||($scope.shown=function(){return!0}),$scope.itemShown=function(){var context={};return $scope.context&&(context.context=$scope.context),"undefined"!=typeof uiGridCtrl&&uiGridCtrl&&(context.grid=uiGridCtrl.grid),$scope.shown.call(context)},$scope.itemAction=function($event,title){if($event.stopPropagation(),"function"==typeof $scope.action){var context={};$scope.context&&(context.context=$scope.context),"undefined"!=typeof uiGridCtrl&&uiGridCtrl&&(context.grid=uiGridCtrl.grid),$scope.action.call(context,$event,title),$scope.leaveOpen?gridUtil.focus.bySelector(angular.element(gridUtil.closestElm($elm,".ui-grid-menu-items")),"button[type=button]",!0):$scope.$emit("hide-menu")}},$scope.i18n=i18nService.get()}}}};return uiGridMenuItem}])}(),function(){var oneBinders=angular.module("ui.grid");angular.forEach([{tag:"Src",method:"attr"},{tag:"Text",method:"text"},{tag:"Href",method:"attr"},{tag:"Class",method:"addClass"},{tag:"Html",method:"html"},{tag:"Alt",method:"attr"},{tag:"Style",method:"css"},{tag:"Value",method:"attr"},{tag:"Id",method:"attr"},{tag:"Id",directiveName:"IdGrid",method:"attr",appendGridId:!0},{tag:"Title",method:"attr"},{tag:"Label",method:"attr",aria:!0},{tag:"Labelledby",method:"attr",aria:!0},{tag:"Labelledby",directiveName:"LabelledbyGrid",appendGridId:!0,method:"attr",aria:!0},{tag:"Describedby",method:"attr",aria:!0},{tag:"Describedby",directiveName:"DescribedbyGrid",appendGridId:!0,method:"attr",aria:!0}],function(v){var baseDirectiveName="uiGridOneBind",directiveName=(v.aria?baseDirectiveName+"Aria":baseDirectiveName)+(v.directiveName?v.directiveName:v.tag);oneBinders.directive(directiveName,["gridUtil",function(gridUtil){return{restrict:"A",require:["?uiGrid","?^uiGrid"],link:function(scope,iElement,iAttrs,controllers){var appendGridId=function(val){var grid;if(scope.grid)grid=scope.grid;else if(scope.col&&scope.col.grid)grid=scope.col.grid;else if(!controllers.some(function(controller){if(controller&&controller.grid)return grid=controller.grid,!0}))throw gridUtil.logError("["+directiveName+"] A valid grid could not be found to bind id. Are you using this directive within the correct scope? Trying to generate id: [gridID]-"+val),new Error("No valid grid could be found");if(grid){var idRegex=new RegExp(grid.id.toString());idRegex.test(val)||(val=grid.id.toString()+"-"+val)}return val},rmWatcher=scope.$watch(iAttrs[directiveName],function(newV){if(newV){if(v.appendGridId){var newIdString=null;angular.forEach(newV.split(" "),function(s){newIdString=(newIdString?newIdString+" ":"")+appendGridId(s)}),newV=newIdString}switch(v.method){case"attr":v.aria?iElement[v.method]("aria-"+v.tag.toLowerCase(),newV):iElement[v.method](v.tag.toLowerCase(),newV);break;case"addClass":if(angular.isObject(newV)&&!angular.isArray(newV)){var results=[],nonNullFound=!1;if(angular.forEach(newV,function(value,index){null!==value&&"undefined"!=typeof value&&(nonNullFound=!0,value&&results.push(index))}),!nonNullFound)return;newV=results}if(!newV)return;iElement.addClass(angular.isArray(newV)?newV.join(" "):newV);break;default:iElement[v.method](newV)}rmWatcher()}},!0)}}}])})}(),function(){var module=angular.module("ui.grid");module.directive("uiGridRenderContainer",["$timeout","$document","uiGridConstants","gridUtil","ScrollEvent",function($timeout,$document,uiGridConstants,gridUtil,ScrollEvent){return{replace:!0,transclude:!0,templateUrl:"ui-grid/uiGridRenderContainer",require:["^uiGrid","uiGridRenderContainer"],scope:{containerId:"=",rowContainerName:"=",colContainerName:"=",bindScrollHorizontal:"=",bindScrollVertical:"=",enableVerticalScrollbar:"=",enableHorizontalScrollbar:"="},controller:"uiGridRenderContainer as RenderContainer",compile:function(){return{pre:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0],containerCtrl=controllers[1],grid=$scope.grid=uiGridCtrl.grid;if(!$scope.rowContainerName)throw"No row render container name specified";if(!$scope.colContainerName)throw"No column render container name specified";if(!grid.renderContainers[$scope.rowContainerName])throw"Row render container '"+$scope.rowContainerName+"' is not registered.";if(!grid.renderContainers[$scope.colContainerName])throw"Column render container '"+$scope.colContainerName+"' is not registered.";var rowContainer=$scope.rowContainer=grid.renderContainers[$scope.rowContainerName],colContainer=$scope.colContainer=grid.renderContainers[$scope.colContainerName];containerCtrl.containerId=$scope.containerId,containerCtrl.rowContainer=rowContainer,containerCtrl.colContainer=colContainer},post:function($scope,$elm,$attrs,controllers){function update(){var ret="",canvasWidth=colContainer.canvasWidth,viewportWidth=colContainer.getViewportWidth(),canvasHeight=rowContainer.getCanvasHeight(),viewportHeight=rowContainer.getViewportHeight();colContainer.needsHScrollbarPlaceholder()&&(viewportHeight-=grid.scrollbarHeight);var headerViewportWidth,footerViewportWidth;return headerViewportWidth=footerViewportWidth=colContainer.getHeaderViewportWidth(),ret+="\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-canvas { width: "+canvasWidth+"px; height: "+canvasHeight+"px; }",ret+="\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-header-canvas { width: "+(canvasWidth+grid.scrollbarWidth)+"px; }",ret+=renderContainer.explicitHeaderCanvasHeight?"\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-header-canvas { height: "+renderContainer.explicitHeaderCanvasHeight+"px; }":"\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-header-canvas { height: inherit; }",ret+="\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-viewport { width: "+viewportWidth+"px; height: "+viewportHeight+"px; }",ret+="\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-header-viewport { width: "+headerViewportWidth+"px; }",ret+="\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-footer-canvas { width: "+(canvasWidth+grid.scrollbarWidth)+"px; }",ret+="\n .grid"+uiGridCtrl.grid.id+" .ui-grid-render-container-"+$scope.containerId+" .ui-grid-footer-viewport { width: "+footerViewportWidth+"px; }"}var uiGridCtrl=controllers[0],containerCtrl=controllers[1],grid=uiGridCtrl.grid,rowContainer=containerCtrl.rowContainer,colContainer=containerCtrl.colContainer,scrollTop=null,scrollLeft=null,renderContainer=grid.renderContainers[$scope.containerId];$elm.addClass("ui-grid-render-container-"+$scope.containerId),gridUtil.on.mousewheel($elm,function(event){var scrollEvent=new ScrollEvent(grid,rowContainer,colContainer,ScrollEvent.Sources.RenderContainerMouseWheel);if(0!==event.deltaY){var scrollYAmount=event.deltaY*-1*event.deltaFactor;scrollTop=containerCtrl.viewport[0].scrollTop,scrollEvent.verticalScrollLength=rowContainer.getVerticalScrollLength();var scrollYPercentage=(scrollTop+scrollYAmount)/scrollEvent.verticalScrollLength;scrollYPercentage>=1&&scrollTop<scrollEvent.verticalScrollLength&&(containerCtrl.viewport[0].scrollTop=scrollEvent.verticalScrollLength),scrollYPercentage<0?scrollYPercentage=0:scrollYPercentage>1&&(scrollYPercentage=1),scrollEvent.y={percentage:scrollYPercentage,pixels:scrollYAmount}}if(0!==event.deltaX){var scrollXAmount=event.deltaX*event.deltaFactor;scrollLeft=gridUtil.normalizeScrollLeft(containerCtrl.viewport,grid),scrollEvent.horizontalScrollLength=colContainer.getCanvasWidth()-colContainer.getViewportWidth();var scrollXPercentage=(scrollLeft+scrollXAmount)/scrollEvent.horizontalScrollLength;scrollXPercentage<0?scrollXPercentage=0:scrollXPercentage>1&&(scrollXPercentage=1),scrollEvent.x={percentage:scrollXPercentage,pixels:scrollXAmount}}0!==event.deltaY&&(scrollEvent.atTop(scrollTop)||scrollEvent.atBottom(scrollTop))||0!==event.deltaX&&(scrollEvent.atLeft(scrollLeft)||scrollEvent.atRight(scrollLeft))||(event.preventDefault(),event.stopPropagation(),scrollEvent.fireThrottledScrollingEvent("",scrollEvent))}),$elm.bind("$destroy",function(){$elm.unbind("keydown"),["touchstart","touchmove","touchend","keydown","wheel","mousewheel","DomMouseScroll","MozMousePixelScroll"].forEach(function(eventName){$elm.unbind(eventName)})}),uiGridCtrl.grid.registerStyleComputation({priority:6,func:update})}}}}}]),module.controller("uiGridRenderContainer",["$scope","gridUtil",function($scope,gridUtil){}])}(),function(){angular.module("ui.grid").directive("uiGridRow",["gridUtil",function(gridUtil){return{replace:!0,require:["^uiGrid","^uiGridRenderContainer"],scope:{row:"=uiGridRow",rowRenderIndex:"="},compile:function(){return{pre:function($scope,$elm,$attrs,controllers){function compileTemplate(){$scope.row.getRowTemplateFn.then(function(compiledElementFn){var newScope=$scope.$new();compiledElementFn(newScope,function(newElm,scope){clonedElement&&(clonedElement.remove(),cloneScope.$destroy()),$elm.empty().append(newElm),clonedElement=newElm,cloneScope=newScope})})}var uiGridCtrl=controllers[0],containerCtrl=controllers[1];uiGridCtrl.grid;$scope.grid=uiGridCtrl.grid,$scope.colContainer=containerCtrl.colContainer;var clonedElement,cloneScope;compileTemplate(),$scope.$watch("row.getRowTemplateFn",function(newFunc,oldFunc){newFunc!==oldFunc&&compileTemplate()})},post:function($scope,$elm,$attrs,controllers){}}}}}])}(),function(){angular.module("ui.grid").directive("uiGridStyle",["gridUtil","$interpolate",function(gridUtil,$interpolate){return{link:function($scope,$elm,$attrs,uiGridCtrl){var interpolateFn=$interpolate($elm.text(),!0);interpolateFn&&$scope.$watch(interpolateFn,function(value){$elm.text(value)})}}}])}(),function(){angular.module("ui.grid").directive("uiGridViewport",["gridUtil","ScrollEvent","uiGridConstants","$log",function(gridUtil,ScrollEvent,uiGridConstants,$log){return{replace:!0,scope:{},controllerAs:"Viewport",templateUrl:"ui-grid/uiGridViewport",require:["^uiGrid","^uiGridRenderContainer"],link:function($scope,$elm,$attrs,controllers){function scrollHandler(evt){var newScrollTop=$elm[0].scrollTop,newScrollLeft=gridUtil.normalizeScrollLeft($elm,grid),vertScrollPercentage=rowContainer.scrollVertical(newScrollTop),horizScrollPercentage=colContainer.scrollHorizontal(newScrollLeft),scrollEvent=new ScrollEvent(grid,rowContainer,colContainer,ScrollEvent.Sources.ViewPortScroll);scrollEvent.newScrollLeft=newScrollLeft,scrollEvent.newScrollTop=newScrollTop,horizScrollPercentage>-1&&(scrollEvent.x={percentage:horizScrollPercentage}),vertScrollPercentage>-1&&(scrollEvent.y={percentage:vertScrollPercentage}),grid.scrollContainers($scope.$parent.containerId,scrollEvent)}function syncVerticalScroll(scrollEvent){containerCtrl.prevScrollArgs=scrollEvent;var newScrollTop=scrollEvent.getNewScrollTop(rowContainer,containerCtrl.viewport);$elm[0].scrollTop=newScrollTop}function syncHorizontalScroll(scrollEvent){containerCtrl.prevScrollArgs=scrollEvent;var newScrollLeft=scrollEvent.getNewScrollLeft(colContainer,containerCtrl.viewport);$elm[0].scrollLeft=gridUtil.denormalizeScrollLeft(containerCtrl.viewport,newScrollLeft,grid)}function syncHorizontalHeader(scrollEvent){var newScrollLeft=scrollEvent.getNewScrollLeft(colContainer,containerCtrl.viewport);containerCtrl.headerViewport&&(containerCtrl.headerViewport.scrollLeft=gridUtil.denormalizeScrollLeft(containerCtrl.viewport,newScrollLeft,grid))}function syncHorizontalFooter(scrollEvent){var newScrollLeft=scrollEvent.getNewScrollLeft(colContainer,containerCtrl.viewport);containerCtrl.footerViewport&&(containerCtrl.footerViewport.scrollLeft=gridUtil.denormalizeScrollLeft(containerCtrl.viewport,newScrollLeft,grid))}var uiGridCtrl=controllers[0],containerCtrl=controllers[1];$scope.containerCtrl=containerCtrl;var rowContainer=containerCtrl.rowContainer,colContainer=containerCtrl.colContainer,grid=uiGridCtrl.grid;$scope.grid=uiGridCtrl.grid,$scope.rowContainer=containerCtrl.rowContainer,$scope.colContainer=containerCtrl.colContainer,containerCtrl.viewport=$elm,$elm.on("scroll",scrollHandler);$scope.$parent.bindScrollVertical&&grid.addVerticalScrollSync($scope.$parent.containerId,syncVerticalScroll),$scope.$parent.bindScrollHorizontal&&(grid.addHorizontalScrollSync($scope.$parent.containerId,syncHorizontalScroll),grid.addHorizontalScrollSync($scope.$parent.containerId+"header",syncHorizontalHeader),grid.addHorizontalScrollSync($scope.$parent.containerId+"footer",syncHorizontalFooter))},controller:["$scope",function($scope){this.rowStyle=function(index){var rowContainer=$scope.rowContainer,colContainer=$scope.colContainer,styles={};if(0===index&&0!==rowContainer.currentTopRow){var hiddenRowWidth=rowContainer.currentTopRow*rowContainer.grid.options.rowHeight;styles["margin-top"]=hiddenRowWidth+"px"}return 0!==colContainer.currentFirstColumn&&(colContainer.grid.isRTL()?styles["margin-right"]=colContainer.columnOffset+"px":styles["margin-left"]=colContainer.columnOffset+"px"),styles}}]}}])}(),function(){angular.module("ui.grid").directive("uiGridVisible",function(){
return function($scope,$elm,$attr){$scope.$watch($attr.uiGridVisible,function(visible){$elm[visible?"removeClass":"addClass"]("ui-grid-invisible")})}})}(),function(){function uiGridDirective($compile,$templateCache,$timeout,$window,gridUtil,uiGridConstants){return{templateUrl:"ui-grid/ui-grid",scope:{uiGrid:"="},replace:!0,transclude:!0,controller:"uiGridController",compile:function(){return{post:function($scope,$elm,$attrs,uiGridCtrl){function checkSize(){$elm[0].offsetWidth<=0&&sizeChecks<maxSizeChecks?(setTimeout(checkSize,sizeCheckInterval),sizeChecks++):$timeout(init)}function setup(){angular.element($window).on("resize",gridResize),$elm.on("$destroy",function(){angular.element($window).off("resize",gridResize)}),$scope.$watch(function(){return grid.hasLeftContainer()},function(newValue,oldValue){newValue!==oldValue&&grid.refreshCanvas(!0)}),$scope.$watch(function(){return grid.hasRightContainer()},function(newValue,oldValue){newValue!==oldValue&&grid.refreshCanvas(!0)})}function init(){grid.gridWidth=$scope.gridWidth=gridUtil.elementWidth($elm),grid.canvasWidth=uiGridCtrl.grid.gridWidth,grid.gridHeight=$scope.gridHeight=gridUtil.elementHeight($elm),grid.gridHeight<=grid.options.rowHeight&&grid.options.enableMinHeightCheck&&autoAdjustHeight(),grid.refreshCanvas(!0)}function autoAdjustHeight(){var contentHeight=grid.options.minRowsToShow*grid.options.rowHeight,headerHeight=grid.options.showHeader?grid.options.headerRowHeight:0,footerHeight=grid.calcFooterHeight(),scrollbarHeight=0;grid.options.enableHorizontalScrollbar===uiGridConstants.scrollbars.ALWAYS&&(scrollbarHeight=gridUtil.getScrollbarWidth());var maxNumberOfFilters=0;if(angular.forEach(grid.options.columnDefs,function(col){col.hasOwnProperty("filter")?maxNumberOfFilters<1&&(maxNumberOfFilters=1):col.hasOwnProperty("filters")&&maxNumberOfFilters<col.filters.length&&(maxNumberOfFilters=col.filters.length)}),grid.options.enableFiltering&&!maxNumberOfFilters){var allColumnsHaveFilteringTurnedOff=grid.options.columnDefs.length&&grid.options.columnDefs.every(function(col){return col.enableFiltering===!1});allColumnsHaveFilteringTurnedOff||(maxNumberOfFilters=1)}var filterHeight=maxNumberOfFilters*headerHeight,newHeight=headerHeight+contentHeight+footerHeight+scrollbarHeight+filterHeight;$elm.css("height",newHeight+"px"),grid.gridHeight=$scope.gridHeight=gridUtil.elementHeight($elm)}function gridResize($event){grid.gridWidth=$scope.gridWidth=gridUtil.elementWidth($elm),grid.gridHeight=$scope.gridHeight=gridUtil.elementHeight($elm),grid.refreshCanvas(!0)}var grid=uiGridCtrl.grid;uiGridCtrl.scrollbars=[],grid.element=$elm;var sizeCheckInterval=100,maxSizeChecks=20,sizeChecks=0;setup(),init(),grid.renderingComplete(),checkSize()}}}}}angular.module("ui.grid").controller("uiGridController",["$scope","$element","$attrs","gridUtil","$q","uiGridConstants","$templateCache","gridClassFactory","$timeout","$parse","$compile",function($scope,$elm,$attrs,gridUtil,$q,uiGridConstants,$templateCache,gridClassFactory,$timeout,$parse,$compile){function columnDefsWatchFunction(n,o){n&&n!==o&&(self.grid.options.columnDefs=$scope.uiGrid.columnDefs,self.grid.buildColumns({orderByColumnDefs:!0}).then(function(){self.grid.preCompileCellTemplates(),self.grid.callDataChangeCallbacks(uiGridConstants.dataChange.COLUMN)}))}function dataWatchFunction(newData){var promises=[];if(self.grid.options.fastWatch&&(newData=angular.isString($scope.uiGrid.data)?self.grid.appScope[$scope.uiGrid.data]:$scope.uiGrid.data),mostRecentData=newData,newData){var hasColumns=self.grid.columns.length>(self.grid.rowHeaderColumns?self.grid.rowHeaderColumns.length:0);!hasColumns&&!$attrs.uiGridColumns&&0===self.grid.options.columnDefs.length&&newData.length>0&&self.grid.buildColumnDefsFromData(newData),!hasColumns&&(self.grid.options.columnDefs.length>0||newData.length>0)&&promises.push(self.grid.buildColumns().then(function(){self.grid.preCompileCellTemplates()})),$q.all(promises).then(function(){self.grid.modifyRows(mostRecentData).then(function(){self.grid.redrawInPlace(!0),$scope.$evalAsync(function(){self.grid.refreshCanvas(!0),self.grid.callDataChangeCallbacks(uiGridConstants.dataChange.ROW)})})})}}var self=this;self.grid=gridClassFactory.createGrid($scope.uiGrid),self.grid.appScope=self.grid.appScope||$scope.$parent,$elm.addClass("grid"+self.grid.id),self.grid.rtl="rtl"===gridUtil.getStyles($elm[0]).direction,$scope.grid=self.grid,$attrs.uiGridColumns&&$attrs.$observe("uiGridColumns",function(value){self.grid.options.columnDefs=value,self.grid.buildColumns().then(function(){self.grid.preCompileCellTemplates(),self.grid.refreshCanvas(!0)})});var deregFunctions=[];self.grid.options.fastWatch?(self.uiGrid=$scope.uiGrid,angular.isString($scope.uiGrid.data)?(deregFunctions.push($scope.$parent.$watch($scope.uiGrid.data,dataWatchFunction)),deregFunctions.push($scope.$parent.$watch(function(){return self.grid.appScope[$scope.uiGrid.data]?self.grid.appScope[$scope.uiGrid.data].length:void 0},dataWatchFunction))):(deregFunctions.push($scope.$parent.$watch(function(){return $scope.uiGrid.data},dataWatchFunction)),deregFunctions.push($scope.$parent.$watch(function(){return $scope.uiGrid.data.length},function(){dataWatchFunction($scope.uiGrid.data)}))),deregFunctions.push($scope.$parent.$watch(function(){return $scope.uiGrid.columnDefs},columnDefsWatchFunction)),deregFunctions.push($scope.$parent.$watch(function(){return $scope.uiGrid.columnDefs.length},function(){columnDefsWatchFunction($scope.uiGrid.columnDefs)}))):(angular.isString($scope.uiGrid.data)?deregFunctions.push($scope.$parent.$watchCollection($scope.uiGrid.data,dataWatchFunction)):deregFunctions.push($scope.$parent.$watchCollection(function(){return $scope.uiGrid.data},dataWatchFunction)),deregFunctions.push($scope.$parent.$watchCollection(function(){return $scope.uiGrid.columnDefs},columnDefsWatchFunction)));var mostRecentData,styleWatchDereg=$scope.$watch(function(){return self.grid.styleComputations},function(){self.grid.refreshCanvas(!0)});$scope.$on("$destroy",function(){deregFunctions.forEach(function(deregFn){deregFn()}),styleWatchDereg()}),self.fireEvent=function(eventName,args){"undefined"!=typeof args&&void 0!==args||(args={}),"undefined"!=typeof args.grid&&void 0!==args.grid||(args.grid=self.grid),$scope.$broadcast(eventName,args)},self.innerCompile=function(elm){$compile(elm)($scope)}}]),angular.module("ui.grid").directive("uiGrid",uiGridDirective),uiGridDirective.$inject=["$compile","$templateCache","$timeout","$window","gridUtil","uiGridConstants"]}(),function(){angular.module("ui.grid").directive("uiGridPinnedContainer",["gridUtil",function(gridUtil){return{restrict:"EA",replace:!0,template:'<div class="ui-grid-pinned-container"><div ui-grid-render-container container-id="side" row-container-name="\'body\'" col-container-name="side" bind-scroll-vertical="true" class="{{ side }} ui-grid-render-container-{{ side }}"></div></div>',scope:{side:"=uiGridPinnedContainer"},require:"^uiGrid",compile:function(){return{post:function($scope,$elm,$attrs,uiGridCtrl){function monkeyPatchedGetViewportWidth(){var self=this,viewportWidth=0;self.visibleColumnCache.forEach(function(column){viewportWidth+=column.drawnWidth});var adjustment=self.getViewportAdjustment();return viewportWidth+=adjustment.width}function updateContainerWidth(){if("left"===$scope.side||"right"===$scope.side){for(var cols=grid.renderContainers[$scope.side].visibleColumnCache,width=0,i=0;i<cols.length;i++){var col=cols[i];width+=col.drawnWidth||col.width||0}return width}}function updateContainerDimensions(){var ret="";return"left"!==$scope.side&&"right"!==$scope.side||(myWidth=updateContainerWidth(),$elm.attr("style",null),ret+=".grid"+grid.id+" .ui-grid-pinned-container-"+$scope.side+", .grid"+grid.id+" .ui-grid-pinned-container-"+$scope.side+" .ui-grid-render-container-"+$scope.side+" .ui-grid-viewport { width: "+myWidth+"px; } "),ret}var grid=uiGridCtrl.grid,myWidth=0;$elm.addClass("ui-grid-pinned-container-"+$scope.side),"left"!==$scope.side&&"right"!==$scope.side||(grid.renderContainers[$scope.side].getViewportWidth=monkeyPatchedGetViewportWidth),grid.renderContainers.body.registerViewportAdjuster(function(adjustment){return myWidth=updateContainerWidth(),adjustment.width-=myWidth,adjustment.side=$scope.side,adjustment}),grid.registerStyleComputation({priority:15,func:updateContainerDimensions})}}}}}])}(),function(){angular.module("ui.grid").factory("Grid",["$q","$compile","$parse","gridUtil","uiGridConstants","GridOptions","GridColumn","GridRow","GridApi","rowSorter","rowSearcher","GridRenderContainer","$timeout","ScrollEvent",function($q,$compile,$parse,gridUtil,uiGridConstants,GridOptions,GridColumn,GridRow,GridApi,rowSorter,rowSearcher,GridRenderContainer,$timeout,ScrollEvent){function RowHashMap(){}var Grid=function(options){function vertical(scrollEvent){self.isScrollingVertically=!1,self.api.core.raise.scrollEnd(scrollEvent),self.scrollDirection=uiGridConstants.scrollDirection.NONE}function horizontal(scrollEvent){self.isScrollingHorizontally=!1,self.api.core.raise.scrollEnd(scrollEvent),self.scrollDirection=uiGridConstants.scrollDirection.NONE}var self=this;if(void 0===options||"undefined"==typeof options.id||!options.id)throw new Error("No ID provided. An ID must be given when creating a grid.");if(!/^[_a-zA-Z0-9-]+$/.test(options.id))throw new Error("Grid id '"+options.id+'" is invalid. It must follow CSS selector syntax rules.');self.id=options.id,delete options.id,self.options=GridOptions.initialize(options),self.appScope=self.options.appScopeProvider,self.headerHeight=self.options.headerRowHeight,self.footerHeight=self.calcFooterHeight(),self.columnFooterHeight=self.calcColumnFooterHeight(),self.rtl=!1,self.gridHeight=0,self.gridWidth=0,self.columnBuilders=[],self.rowBuilders=[],self.rowsProcessors=[],self.columnsProcessors=[],self.styleComputations=[],self.viewportAdjusters=[],self.rowHeaderColumns=[],self.dataChangeCallbacks={},self.verticalScrollSyncCallBackFns={},self.horizontalScrollSyncCallBackFns={},self.renderContainers={},self.renderContainers.body=new GridRenderContainer("body",self),self.cellValueGetterCache={},self.getRowTemplateFn=null,self.rows=[],self.columns=[],self.isScrollingVertically=!1,self.isScrollingHorizontally=!1,self.scrollDirection=uiGridConstants.scrollDirection.NONE,self.disableScrolling=!1;var debouncedVertical=gridUtil.debounce(vertical,self.options.scrollDebounce),debouncedVerticalMinDelay=gridUtil.debounce(vertical,0),debouncedHorizontal=gridUtil.debounce(horizontal,self.options.scrollDebounce),debouncedHorizontalMinDelay=gridUtil.debounce(horizontal,0);self.flagScrollingVertically=function(scrollEvent){self.isScrollingVertically||self.isScrollingHorizontally||self.api.core.raise.scrollBegin(scrollEvent),self.isScrollingVertically=!0,0!==self.options.scrollDebounce&&scrollEvent.withDelay?debouncedVertical(scrollEvent):debouncedVerticalMinDelay(scrollEvent)},self.flagScrollingHorizontally=function(scrollEvent){self.isScrollingVertically||self.isScrollingHorizontally||self.api.core.raise.scrollBegin(scrollEvent),self.isScrollingHorizontally=!0,0!==self.options.scrollDebounce&&scrollEvent.withDelay?debouncedHorizontal(scrollEvent):debouncedHorizontalMinDelay(scrollEvent)},self.scrollbarHeight=0,self.scrollbarWidth=0,self.options.enableHorizontalScrollbar===uiGridConstants.scrollbars.ALWAYS&&(self.scrollbarHeight=gridUtil.getScrollbarWidth()),self.options.enableVerticalScrollbar===uiGridConstants.scrollbars.ALWAYS&&(self.scrollbarWidth=gridUtil.getScrollbarWidth()),self.api=new GridApi(self),self.api.registerMethod("core","refresh",this.refresh),self.api.registerMethod("core","queueGridRefresh",this.queueGridRefresh),self.api.registerMethod("core","refreshRows",this.refreshRows),self.api.registerMethod("core","queueRefresh",this.queueRefresh),self.api.registerMethod("core","handleWindowResize",this.handleWindowResize),self.api.registerMethod("core","addRowHeaderColumn",this.addRowHeaderColumn),self.api.registerMethod("core","scrollToIfNecessary",function(gridRow,gridCol){return self.scrollToIfNecessary(gridRow,gridCol)}),self.api.registerMethod("core","scrollTo",function(rowEntity,colDef){return self.scrollTo(rowEntity,colDef)}),self.api.registerMethod("core","registerRowsProcessor",this.registerRowsProcessor),self.api.registerMethod("core","registerColumnsProcessor",this.registerColumnsProcessor),self.api.registerMethod("core","sortHandleNulls",rowSorter.handleNulls),self.api.registerEvent("core","sortChanged"),self.api.registerEvent("core","columnVisibilityChanged"),self.api.registerMethod("core","notifyDataChange",this.notifyDataChange),self.api.registerMethod("core","clearAllFilters",this.clearAllFilters),self.registerDataChangeCallback(self.columnRefreshCallback,[uiGridConstants.dataChange.COLUMN]),self.registerDataChangeCallback(self.processRowsCallback,[uiGridConstants.dataChange.EDIT]),self.registerDataChangeCallback(self.updateFooterHeightCallback,[uiGridConstants.dataChange.OPTIONS]),self.registerStyleComputation({priority:10,func:self.getFooterStyles})};Grid.prototype.calcFooterHeight=function(){if(!this.hasFooter())return 0;var height=0;return this.options.showGridFooter&&(height+=this.options.gridFooterHeight),height+=this.calcColumnFooterHeight()},Grid.prototype.calcColumnFooterHeight=function(){var height=0;return this.options.showColumnFooter&&(height+=this.options.columnFooterHeight),height},Grid.prototype.getFooterStyles=function(){var style=".grid"+this.id+" .ui-grid-footer-aggregates-row { height: "+this.options.columnFooterHeight+"px; }";return style+=" .grid"+this.id+" .ui-grid-footer-info { height: "+this.options.gridFooterHeight+"px; }"},Grid.prototype.hasFooter=function(){return this.options.showGridFooter||this.options.showColumnFooter},Grid.prototype.isRTL=function(){return this.rtl},Grid.prototype.registerColumnBuilder=function(columnBuilder){this.columnBuilders.push(columnBuilder)},Grid.prototype.buildColumnDefsFromData=function(dataRows){this.options.columnDefs=gridUtil.getColumnsFromData(dataRows,this.options.excludeProperties)},Grid.prototype.registerRowBuilder=function(rowBuilder){this.rowBuilders.push(rowBuilder)},Grid.prototype.registerDataChangeCallback=function(callback,types,_this){var uid=gridUtil.nextUid();types||(types=[uiGridConstants.dataChange.ALL]),Array.isArray(types)||gridUtil.logError("Expected types to be an array or null in registerDataChangeCallback, value passed was: "+types),this.dataChangeCallbacks[uid]={callback:callback,types:types,_this:_this};var self=this,deregisterFunction=function(){delete self.dataChangeCallbacks[uid]};return deregisterFunction},Grid.prototype.callDataChangeCallbacks=function(type,options){angular.forEach(this.dataChangeCallbacks,function(callback,uid){callback.types.indexOf(uiGridConstants.dataChange.ALL)===-1&&callback.types.indexOf(type)===-1&&type!==uiGridConstants.dataChange.ALL||(callback._this?callback.callback.apply(callback._this,this):callback.callback(this))},this)},Grid.prototype.notifyDataChange=function(type){var constants=uiGridConstants.dataChange;type===constants.ALL||type===constants.COLUMN||type===constants.EDIT||type===constants.ROW||type===constants.OPTIONS?this.callDataChangeCallbacks(type):gridUtil.logError("Notified of a data change, but the type was not recognised, so no action taken, type was: "+type)},Grid.prototype.columnRefreshCallback=function(grid){grid.buildColumns(),grid.queueGridRefresh()},Grid.prototype.processRowsCallback=function(grid){grid.queueGridRefresh()},Grid.prototype.updateFooterHeightCallback=function(grid){grid.footerHeight=grid.calcFooterHeight(),grid.columnFooterHeight=grid.calcColumnFooterHeight()},Grid.prototype.getColumn=function(name){var columns=this.columns.filter(function(column){return column.colDef.name===name});return columns.length>0?columns[0]:null},Grid.prototype.getColDef=function(name){var colDefs=this.options.columnDefs.filter(function(colDef){return colDef.name===name});return colDefs.length>0?colDefs[0]:null},Grid.prototype.assignTypes=function(){var self=this;self.options.columnDefs.forEach(function(colDef,index){if(!colDef.type){var col=new GridColumn(colDef,index,self),firstRow=self.rows.length>0?self.rows[0]:null;firstRow?colDef.type=gridUtil.guessType(self.getCellValue(firstRow,col)):colDef.type="string"}})},Grid.prototype.isRowHeaderColumn=function(column){return this.rowHeaderColumns.indexOf(column)!==-1},Grid.prototype.addRowHeaderColumn=function(colDef,order){var self=this;void 0===order&&(order=0);var rowHeaderCol=new GridColumn(colDef,gridUtil.nextUid(),self);rowHeaderCol.isRowHeader=!0,self.isRTL()?(self.createRightContainer(),rowHeaderCol.renderContainer="right"):(self.createLeftContainer(),rowHeaderCol.renderContainer="left"),self.columnBuilders[0](colDef,rowHeaderCol,self.options).then(function(){rowHeaderCol.enableFiltering=!1,rowHeaderCol.enableSorting=!1,rowHeaderCol.enableHiding=!1,rowHeaderCol.headerPriority=order,self.rowHeaderColumns.push(rowHeaderCol),self.rowHeaderColumns=self.rowHeaderColumns.sort(function(a,b){return a.headerPriority-b.headerPriority}),self.buildColumns().then(function(){self.preCompileCellTemplates(),self.queueGridRefresh()})})},Grid.prototype.getOnlyDataColumns=function(){var self=this,cols=[];return self.columns.forEach(function(col){self.rowHeaderColumns.indexOf(col)===-1&&cols.push(col)}),cols},Grid.prototype.buildColumns=function(opts){var options={orderByColumnDefs:!1};angular.extend(options,opts);var i,self=this,builderPromises=[],headerOffset=self.rowHeaderColumns.length;for(i=0;i<self.columns.length;i++)self.getColDef(self.columns[i].name)||(self.columns.splice(i,1),i--);for(var j=self.rowHeaderColumns.length-1;j>=0;j--)self.columns.unshift(self.rowHeaderColumns[j]);if(self.options.columnDefs.forEach(function(colDef,index){self.preprocessColDef(colDef);var col=self.getColumn(colDef.name);col?col.updateColumnDef(colDef,!1):(col=new GridColumn(colDef,gridUtil.nextUid(),self),self.columns.splice(index+headerOffset,0,col)),self.columnBuilders.forEach(function(builder){builderPromises.push(builder.call(self,colDef,col,self.options))})}),options.orderByColumnDefs){var columnCache=self.columns.slice(0),len=Math.min(self.options.columnDefs.length,self.columns.length);for(i=0;i<len;i++)self.columns[i+headerOffset].name!==self.options.columnDefs[i].name?columnCache[i+headerOffset]=self.getColumn(self.options.columnDefs[i].name):columnCache[i+headerOffset]=self.columns[i+headerOffset];self.columns.length=0,Array.prototype.splice.apply(self.columns,[0,0].concat(columnCache))}return $q.all(builderPromises).then(function(){self.rows.length>0&&self.assignTypes()})},Grid.prototype.preCompileCellTemplate=function(col){var self=this,html=col.cellTemplate.replace(uiGridConstants.MODEL_COL_FIELD,self.getQualifiedColField(col));html=html.replace(uiGridConstants.COL_FIELD,"grid.getCellValue(row, col)");var compiledElementFn=$compile(html);col.compiledElementFn=compiledElementFn,col.compiledElementFnDefer&&col.compiledElementFnDefer.resolve(col.compiledElementFn)},Grid.prototype.preCompileCellTemplates=function(){var self=this;self.columns.forEach(function(col){col.cellTemplate?self.preCompileCellTemplate(col):col.cellTemplatePromise&&col.cellTemplatePromise.then(function(){self.preCompileCellTemplate(col)})})},Grid.prototype.getQualifiedColField=function(col){var base="row.entity";return col.field===uiGridConstants.ENTITY_BINDING?base:gridUtil.preEval(base+"."+col.field)},Grid.prototype.createLeftContainer=function(){this.hasLeftContainer()||(this.renderContainers.left=new GridRenderContainer("left",this,{disableColumnOffset:!0}))},Grid.prototype.createRightContainer=function(){this.hasRightContainer()||(this.renderContainers.right=new GridRenderContainer("right",this,{disableColumnOffset:!0}))},Grid.prototype.hasLeftContainer=function(){return void 0!==this.renderContainers.left},Grid.prototype.hasRightContainer=function(){return void 0!==this.renderContainers.right},Grid.prototype.preprocessColDef=function(colDef){var self=this;if(!colDef.field&&!colDef.name)throw new Error("colDef.name or colDef.field property is required");if(void 0===colDef.name&&void 0!==colDef.field){for(var newName=colDef.field,counter=2;self.getColumn(newName);)newName=colDef.field+counter.toString(),counter++;colDef.name=newName}},Grid.prototype.newInN=function(o,n,oAccessor,nAccessor){for(var self=this,t=[],i=0;i<n.length;i++){for(var nV=nAccessor?n[i][nAccessor]:n[i],found=!1,j=0;j<o.length;j++){var oV=oAccessor?o[j][oAccessor]:o[j];if(self.options.rowEquality(nV,oV)){found=!0;break}}found||t.push(nV)}return t},Grid.prototype.getRow=function(rowEntity,lookInRows){var self=this;lookInRows="undefined"==typeof lookInRows?self.rows:lookInRows;var rows=lookInRows.filter(function(row){return self.options.rowEquality(row.entity,rowEntity)});return rows.length>0?rows[0]:null},Grid.prototype.modifyRows=function(newRawData){var self=this,oldRows=self.rows.slice(0),oldRowHash=self.rowHashMap||self.createRowHashMap();self.rowHashMap=self.createRowHashMap(),self.rows.length=0,newRawData.forEach(function(newEntity,i){var newRow;newRow=self.options.enableRowHashing?oldRowHash.get(newEntity):self.getRow(newEntity,oldRows),newRow||(newRow=self.processRowBuilders(new GridRow(newEntity,i,self))),self.rows.push(newRow),self.rowHashMap.put(newEntity,newRow)}),self.assignTypes();var p1=$q.when(self.processRowsProcessors(self.rows)).then(function(renderableRows){return self.setVisibleRows(renderableRows)}),p2=$q.when(self.processColumnsProcessors(self.columns)).then(function(renderableColumns){return self.setVisibleColumns(renderableColumns)});return $q.all([p1,p2])},Grid.prototype.addRows=function(newRawData){for(var self=this,existingRowCount=self.rows.length,i=0;i<newRawData.length;i++){var newRow=self.processRowBuilders(new GridRow(newRawData[i],i+existingRowCount,self));if(self.options.enableRowHashing){var found=self.rowHashMap.get(newRow.entity);found&&(found.row=newRow)}self.rows.push(newRow)}},Grid.prototype.processRowBuilders=function(gridRow){var self=this;return self.rowBuilders.forEach(function(builder){builder.call(self,gridRow,self.options)}),gridRow},Grid.prototype.registerStyleComputation=function(styleComputationInfo){this.styleComputations.push(styleComputationInfo)},Grid.prototype.registerRowsProcessor=function(processor,priority){if(!angular.isFunction(processor))throw"Attempt to register non-function rows processor: "+processor;this.rowsProcessors.push({processor:processor,priority:priority}),this.rowsProcessors.sort(function(a,b){return a.priority-b.priority})},Grid.prototype.removeRowsProcessor=function(processor){var idx=-1;this.rowsProcessors.forEach(function(rowsProcessor,index){rowsProcessor.processor===processor&&(idx=index)}),idx!==-1&&this.rowsProcessors.splice(idx,1)},Grid.prototype.processRowsProcessors=function(renderableRows){function startProcessor(i,renderedRowsToProcess){var processor=self.rowsProcessors[i].processor;return $q.when(processor.call(self,renderedRowsToProcess,self.columns)).then(function(processedRows){if(!processedRows)throw"Processor at index "+i+" did not return a set of renderable rows";if(!angular.isArray(processedRows))throw"Processor at index "+i+" did not return an array";return i++,i<=self.rowsProcessors.length-1?startProcessor(i,processedRows):void finished.resolve(processedRows)})}var self=this,myRenderableRows=renderableRows.slice(0);if(0===self.rowsProcessors.length)return $q.when(myRenderableRows);var finished=$q.defer();return startProcessor(0,myRenderableRows),finished.promise},Grid.prototype.setVisibleRows=function(rows){var self=this;for(var i in self.renderContainers){var container=self.renderContainers[i];container.canvasHeightShouldUpdate=!0,"undefined"==typeof container.visibleRowCache?container.visibleRowCache=[]:container.visibleRowCache.length=0}for(var ri=0;ri<rows.length;ri++){var row=rows[ri],targetContainer="undefined"!=typeof row.renderContainer&&row.renderContainer?row.renderContainer:"body";row.visible&&self.renderContainers[targetContainer].visibleRowCache.push(row)}self.api.core.raise.rowsVisibleChanged(this.api),self.api.core.raise.rowsRendered(this.api)},Grid.prototype.registerColumnsProcessor=function(processor,priority){if(!angular.isFunction(processor))throw"Attempt to register non-function rows processor: "+processor;this.columnsProcessors.push({processor:processor,priority:priority}),this.columnsProcessors.sort(function(a,b){return a.priority-b.priority})},Grid.prototype.removeColumnsProcessor=function(processor){var idx=this.columnsProcessors.indexOf(processor);"undefined"!=typeof idx&&void 0!==idx&&this.columnsProcessors.splice(idx,1)},Grid.prototype.processColumnsProcessors=function(renderableColumns){function startProcessor(i,renderedColumnsToProcess){var processor=self.columnsProcessors[i].processor;return $q.when(processor.call(self,renderedColumnsToProcess,self.rows)).then(function(processedColumns){if(!processedColumns)throw"Processor at index "+i+" did not return a set of renderable rows";if(!angular.isArray(processedColumns))throw"Processor at index "+i+" did not return an array";return i++,i<=self.columnsProcessors.length-1?startProcessor(i,myRenderableColumns):void finished.resolve(myRenderableColumns)})}var self=this,myRenderableColumns=renderableColumns.slice(0);if(0===self.columnsProcessors.length)return $q.when(myRenderableColumns);var finished=$q.defer();return startProcessor(0,myRenderableColumns),finished.promise},Grid.prototype.setVisibleColumns=function(columns){var self=this;for(var i in self.renderContainers){var container=self.renderContainers[i];container.visibleColumnCache.length=0}for(var ci=0;ci<columns.length;ci++){var column=columns[ci];column.visible&&("undefined"!=typeof column.renderContainer&&column.renderContainer?self.renderContainers[column.renderContainer].visibleColumnCache.push(column):self.renderContainers.body.visibleColumnCache.push(column))}},Grid.prototype.handleWindowResize=function($event){var self=this;return self.gridWidth=gridUtil.elementWidth(self.element),self.gridHeight=gridUtil.elementHeight(self.element),self.queueRefresh()},Grid.prototype.queueRefresh=function(){var self=this;return self.refreshCanceller&&$timeout.cancel(self.refreshCanceller),self.refreshCanceller=$timeout(function(){self.refreshCanvas(!0)}),self.refreshCanceller.then(function(){self.refreshCanceller=null}),self.refreshCanceller},Grid.prototype.queueGridRefresh=function(){var self=this;return self.gridRefreshCanceller&&$timeout.cancel(self.gridRefreshCanceller),self.gridRefreshCanceller=$timeout(function(){self.refresh(!0)}),self.gridRefreshCanceller.then(function(){self.gridRefreshCanceller=null}),self.gridRefreshCanceller},Grid.prototype.updateCanvasHeight=function(){var self=this;for(var containerId in self.renderContainers)if(self.renderContainers.hasOwnProperty(containerId)){var container=self.renderContainers[containerId];container.canvasHeightShouldUpdate=!0}},Grid.prototype.buildStyles=function(){var self=this;self.customStyles="",self.styleComputations.sort(function(a,b){return null===a.priority?1:null===b.priority?-1:null===a.priority&&null===b.priority?0:a.priority-b.priority}).forEach(function(compInfo){var ret=compInfo.func.call(self);angular.isString(ret)&&(self.customStyles+="\n"+ret)})},Grid.prototype.minColumnsToRender=function(){var self=this,viewport=this.getViewportWidth(),min=0,totalWidth=0;return self.columns.forEach(function(col,i){if(totalWidth<viewport)totalWidth+=col.drawnWidth,min++;else{for(var currWidth=0,j=i;j>=i-min;j--)currWidth+=self.columns[j].drawnWidth;currWidth<viewport&&min++}}),min},Grid.prototype.getBodyHeight=function(){var bodyHeight=this.getViewportHeight();return bodyHeight},Grid.prototype.getViewportHeight=function(){var self=this,viewPortHeight=this.gridHeight-this.headerHeight-this.footerHeight,adjustment=self.getViewportAdjustment();return viewPortHeight+=adjustment.height},Grid.prototype.getViewportWidth=function(){var self=this,viewPortWidth=this.gridWidth,adjustment=self.getViewportAdjustment();return viewPortWidth+=adjustment.width},Grid.prototype.getHeaderViewportWidth=function(){var viewPortWidth=this.getViewportWidth();return viewPortWidth},Grid.prototype.addVerticalScrollSync=function(containerId,callBackFn){this.verticalScrollSyncCallBackFns[containerId]=callBackFn},Grid.prototype.addHorizontalScrollSync=function(containerId,callBackFn){this.horizontalScrollSyncCallBackFns[containerId]=callBackFn},Grid.prototype.scrollContainers=function(sourceContainerId,scrollEvent){if(scrollEvent.y){var verts=["body","left","right"];this.flagScrollingVertically(scrollEvent),"body"===sourceContainerId?verts=["left","right"]:"left"===sourceContainerId?verts=["body","right"]:"right"===sourceContainerId&&(verts=["body","left"]);for(var i=0;i<verts.length;i++){var id=verts[i];this.verticalScrollSyncCallBackFns[id]&&this.verticalScrollSyncCallBackFns[id](scrollEvent)}}if(scrollEvent.x){var horizs=["body","bodyheader","bodyfooter"];this.flagScrollingHorizontally(scrollEvent),"body"===sourceContainerId&&(horizs=["bodyheader","bodyfooter"]);for(var j=0;j<horizs.length;j++){var idh=horizs[j];this.horizontalScrollSyncCallBackFns[idh]&&this.horizontalScrollSyncCallBackFns[idh](scrollEvent)}}},Grid.prototype.registerViewportAdjuster=function(func){this.viewportAdjusters.push(func)},Grid.prototype.removeViewportAdjuster=function(func){var idx=this.viewportAdjusters.indexOf(func);"undefined"!=typeof idx&&void 0!==idx&&this.viewportAdjusters.splice(idx,1)},Grid.prototype.getViewportAdjustment=function(){var self=this,adjustment={height:0,width:0};return self.viewportAdjusters.forEach(function(func){adjustment=func.call(this,adjustment)}),adjustment},Grid.prototype.getVisibleRowCount=function(){return this.renderContainers.body.visibleRowCache.length},Grid.prototype.getVisibleRows=function(){return this.renderContainers.body.visibleRowCache},Grid.prototype.getVisibleColumnCount=function(){return this.renderContainers.body.visibleColumnCache.length},Grid.prototype.searchRows=function(renderableRows){return rowSearcher.search(this,renderableRows,this.columns)},Grid.prototype.sortByColumn=function(renderableRows){return rowSorter.sort(this,renderableRows,this.columns)},Grid.prototype.getCellValue=function(row,col){return"undefined"!=typeof row.entity["$$"+col.uid]?row.entity["$$"+col.uid].rendered:this.options.flatEntityAccess&&"undefined"!=typeof col.field?row.entity[col.field]:(col.cellValueGetterCache||(col.cellValueGetterCache=$parse(row.getEntityQualifiedColField(col))),col.cellValueGetterCache(row))},Grid.prototype.getCellDisplayValue=function(row,col){if(!col.cellDisplayGetterCache){var custom_filter=col.cellFilter?" | "+col.cellFilter:"";"undefined"!=typeof row.entity["$$"+col.uid]?col.cellDisplayGetterCache=$parse(row.entity["$$"+col.uid].rendered+custom_filter):this.options.flatEntityAccess&&"undefined"!=typeof col.field?col.cellDisplayGetterCache=$parse(row.entity[col.field]+custom_filter):col.cellDisplayGetterCache=$parse(row.getEntityQualifiedColField(col)+custom_filter)}return col.cellDisplayGetterCache(row)},Grid.prototype.getNextColumnSortPriority=function(){var self=this,p=0;return self.columns.forEach(function(col){col.sort&&void 0!==col.sort.priority&&col.sort.priority>=p&&(p=col.sort.priority+1)}),p},Grid.prototype.resetColumnSorting=function(excludeCol){var self=this;self.columns.forEach(function(col){col===excludeCol||col.suppressRemoveSort||(col.sort={})})},Grid.prototype.getColumnSorting=function(){var myCols,self=this,sortedCols=[];return myCols=self.columns.slice(0),myCols.sort(rowSorter.prioritySort).forEach(function(col){col.sort&&"undefined"!=typeof col.sort.direction&&col.sort.direction&&(col.sort.direction===uiGridConstants.ASC||col.sort.direction===uiGridConstants.DESC)&&sortedCols.push(col)}),sortedCols},Grid.prototype.sortColumn=function(column,directionOrAdd,add){var self=this,direction=null;if("undefined"==typeof column||!column)throw new Error("No column parameter provided");
if("boolean"==typeof directionOrAdd?add=directionOrAdd:direction=directionOrAdd,add?void 0===column.sort.priority&&(column.sort.priority=self.getNextColumnSortPriority()):(self.resetColumnSorting(column),column.sort.priority=void 0,column.sort.priority=self.getNextColumnSortPriority()),direction)column.sort.direction=direction;else{var i=column.sortDirectionCycle.indexOf(column.sort.direction?column.sort.direction:null);i=(i+1)%column.sortDirectionCycle.length,column.colDef&&column.suppressRemoveSort&&!column.sortDirectionCycle[i]&&(i=(i+1)%column.sortDirectionCycle.length),column.sortDirectionCycle[i]?column.sort.direction=column.sortDirectionCycle[i]:removeSortOfColumn(column,self)}return self.api.core.raise.sortChanged(self,self.getColumnSorting()),$q.when(column)};var removeSortOfColumn=function(column,grid){grid.columns.forEach(function(col){col.sort&&void 0!==col.sort.priority&&col.sort.priority>column.sort.priority&&(col.sort.priority-=1)}),column.sort={}};return Grid.prototype.renderingComplete=function(){angular.isFunction(this.options.onRegisterApi)&&this.options.onRegisterApi(this.api),this.api.core.raise.renderingComplete(this.api)},Grid.prototype.createRowHashMap=function(){var self=this,hashMap=new RowHashMap;return hashMap.grid=self,hashMap},Grid.prototype.refresh=function(rowsAltered){var self=this,p1=self.processRowsProcessors(self.rows).then(function(renderableRows){self.setVisibleRows(renderableRows)}),p2=self.processColumnsProcessors(self.columns).then(function(renderableColumns){self.setVisibleColumns(renderableColumns)});return $q.all([p1,p2]).then(function(){self.redrawInPlace(rowsAltered),self.refreshCanvas(!0)})},Grid.prototype.refreshRows=function(){var self=this;return self.processRowsProcessors(self.rows).then(function(renderableRows){self.setVisibleRows(renderableRows),self.redrawInPlace(),self.refreshCanvas(!0)})},Grid.prototype.refreshCanvas=function(buildStyles){var self=this;buildStyles&&self.buildStyles();var p=$q.defer(),containerHeadersToRecalc=[];for(var containerId in self.renderContainers)if(self.renderContainers.hasOwnProperty(containerId)){var container=self.renderContainers[containerId];if(null===container.canvasWidth||isNaN(container.canvasWidth))continue;(container.header||container.headerCanvas)&&(container.explicitHeaderHeight=container.explicitHeaderHeight||null,container.explicitHeaderCanvasHeight=container.explicitHeaderCanvasHeight||null,containerHeadersToRecalc.push(container))}return containerHeadersToRecalc.length>0?(buildStyles&&self.buildStyles(),$timeout(function(){var i,container,rebuildStyles=!1,maxHeaderHeight=0,maxHeaderCanvasHeight=0,getHeight=function(oldVal,newVal){return oldVal!==newVal&&(rebuildStyles=!0),newVal};for(i=0;i<containerHeadersToRecalc.length;i++)if(container=containerHeadersToRecalc[i],null!==container.canvasWidth&&!isNaN(container.canvasWidth)){if(container.header){var headerHeight=container.headerHeight=getHeight(container.headerHeight,parseInt(gridUtil.outerElementHeight(container.header),10)),topBorder=gridUtil.getBorderSize(container.header,"top"),bottomBorder=gridUtil.getBorderSize(container.header,"bottom"),innerHeaderHeight=parseInt(headerHeight-topBorder-bottomBorder,10);innerHeaderHeight=innerHeaderHeight<0?0:innerHeaderHeight,container.innerHeaderHeight=innerHeaderHeight,!container.explicitHeaderHeight&&innerHeaderHeight>maxHeaderHeight&&(maxHeaderHeight=innerHeaderHeight)}if(container.headerCanvas){var headerCanvasHeight=container.headerCanvasHeight=getHeight(container.headerCanvasHeight,parseInt(gridUtil.outerElementHeight(container.headerCanvas),10));!container.explicitHeaderCanvasHeight&&headerCanvasHeight>maxHeaderCanvasHeight&&(maxHeaderCanvasHeight=headerCanvasHeight)}}for(i=0;i<containerHeadersToRecalc.length;i++)container=containerHeadersToRecalc[i],maxHeaderHeight>0&&"undefined"!=typeof container.headerHeight&&null!==container.headerHeight&&(container.explicitHeaderHeight||container.headerHeight<maxHeaderHeight)&&(container.explicitHeaderHeight=getHeight(container.explicitHeaderHeight,maxHeaderHeight)),maxHeaderCanvasHeight>0&&"undefined"!=typeof container.headerCanvasHeight&&null!==container.headerCanvasHeight&&(container.explicitHeaderCanvasHeight||container.headerCanvasHeight<maxHeaderCanvasHeight)&&(container.explicitHeaderCanvasHeight=getHeight(container.explicitHeaderCanvasHeight,maxHeaderCanvasHeight));buildStyles&&rebuildStyles&&self.buildStyles(),p.resolve()})):$timeout(function(){p.resolve()}),p.promise},Grid.prototype.redrawInPlace=function(rowsAdded){var self=this;for(var i in self.renderContainers){var container=self.renderContainers[i];rowsAdded?(container.adjustRows(container.prevScrollTop,null),container.adjustColumns(container.prevScrollLeft,null)):(container.adjustRows(null,container.prevScrolltopPercentage),container.adjustColumns(null,container.prevScrollleftPercentage))}},Grid.prototype.hasLeftContainerColumns=function(){return this.hasLeftContainer()&&this.renderContainers.left.renderedColumns.length>0},Grid.prototype.hasRightContainerColumns=function(){return this.hasRightContainer()&&this.renderContainers.right.renderedColumns.length>0},Grid.prototype.scrollToIfNecessary=function(gridRow,gridCol){var self=this,scrollEvent=new ScrollEvent(self,"uiGrid.scrollToIfNecessary"),visRowCache=self.renderContainers.body.visibleRowCache,visColCache=self.renderContainers.body.visibleColumnCache,topBound=self.renderContainers.body.prevScrollTop+self.headerHeight;topBound=topBound<0?0:topBound;var leftBound=self.renderContainers.body.prevScrollLeft,bottomBound=self.renderContainers.body.prevScrollTop+self.gridHeight-self.renderContainers.body.headerHeight-self.footerHeight-self.scrollbarWidth,rightBound=self.renderContainers.body.prevScrollLeft+Math.ceil(self.renderContainers.body.getViewportWidth());if(null!==gridRow){var seekRowIndex=visRowCache.indexOf(gridRow),scrollLength=self.renderContainers.body.getCanvasHeight()-self.renderContainers.body.getViewportHeight(),pixelsToSeeRow=seekRowIndex*self.options.rowHeight+self.headerHeight;pixelsToSeeRow=pixelsToSeeRow<0?0:pixelsToSeeRow;var scrollPixels,percentage;pixelsToSeeRow<topBound?(scrollPixels=self.renderContainers.body.prevScrollTop-(topBound-pixelsToSeeRow),percentage=scrollPixels/scrollLength,scrollEvent.y={percentage:percentage}):pixelsToSeeRow>bottomBound&&(scrollPixels=pixelsToSeeRow-bottomBound+self.renderContainers.body.prevScrollTop,percentage=scrollPixels/scrollLength,scrollEvent.y={percentage:percentage})}if(null!==gridCol){for(var seekColumnIndex=visColCache.indexOf(gridCol),horizScrollLength=self.renderContainers.body.getCanvasWidth()-self.renderContainers.body.getViewportWidth(),columnLeftEdge=0,i=0;i<seekColumnIndex;i++){var col=visColCache[i];columnLeftEdge+=col.drawnWidth}columnLeftEdge=columnLeftEdge<0?0:columnLeftEdge;var columnRightEdge=columnLeftEdge+gridCol.drawnWidth;columnRightEdge=columnRightEdge<0?0:columnRightEdge;var horizScrollPixels,horizPercentage;columnLeftEdge<leftBound?(horizScrollPixels=self.renderContainers.body.prevScrollLeft-(leftBound-columnLeftEdge),horizPercentage=horizScrollPixels/horizScrollLength,horizPercentage=horizPercentage>1?1:horizPercentage,scrollEvent.x={percentage:horizPercentage}):columnRightEdge>rightBound&&(horizScrollPixels=columnRightEdge-rightBound+self.renderContainers.body.prevScrollLeft,horizPercentage=horizScrollPixels/horizScrollLength,horizPercentage=horizPercentage>1?1:horizPercentage,scrollEvent.x={percentage:horizPercentage})}var deferred=$q.defer();if(scrollEvent.y||scrollEvent.x){scrollEvent.withDelay=!1,self.scrollContainers("",scrollEvent);var dereg=self.api.core.on.scrollEnd(null,function(){deferred.resolve(scrollEvent),dereg()})}else deferred.resolve();return deferred.promise},Grid.prototype.scrollTo=function(rowEntity,colDef){var gridRow=null,gridCol=null;return null!==rowEntity&&"undefined"!=typeof rowEntity&&(gridRow=this.getRow(rowEntity)),null!==colDef&&"undefined"!=typeof colDef&&(gridCol=this.getColumn(colDef.name?colDef.name:colDef.field)),this.scrollToIfNecessary(gridRow,gridCol)},Grid.prototype.clearAllFilters=function(refreshRows,clearConditions,clearFlags){if(void 0===refreshRows&&(refreshRows=!0),void 0===clearConditions&&(clearConditions=!1),void 0===clearFlags&&(clearFlags=!1),this.columns.forEach(function(column){column.filters.forEach(function(filter){filter.term=void 0,clearConditions&&(filter.condition=void 0),clearFlags&&(filter.flags=void 0)})}),refreshRows)return this.refreshRows()},RowHashMap.prototype={put:function(key,value){this[this.grid.options.rowIdentity(key)]=value},get:function(key){return this[this.grid.options.rowIdentity(key)]},remove:function(key){var value=this[key=this.grid.options.rowIdentity(key)];return delete this[key],value}},Grid}])}(),function(){angular.module("ui.grid").factory("GridApi",["$q","$rootScope","gridUtil","uiGridConstants","GridRow","uiGridGridMenuService",function($q,$rootScope,gridUtil,uiGridConstants,GridRow,uiGridGridMenuService){function registerEventWithAngular(eventId,handler,grid,_this){return $rootScope.$on(eventId,function(event){var args=Array.prototype.slice.call(arguments);args.splice(0,1),handler.apply(_this?_this:grid.api,args)})}var GridApi=function(grid){this.grid=grid,this.listeners=[],this.registerEvent("core","renderingComplete"),this.registerEvent("core","filterChanged"),this.registerMethod("core","setRowInvisible",GridRow.prototype.setRowInvisible),this.registerMethod("core","clearRowInvisible",GridRow.prototype.clearRowInvisible),this.registerMethod("core","getVisibleRows",this.grid.getVisibleRows),this.registerEvent("core","rowsVisibleChanged"),this.registerEvent("core","rowsRendered"),this.registerEvent("core","scrollBegin"),this.registerEvent("core","scrollEnd"),this.registerEvent("core","canvasHeightChanged"),this.registerEvent("core","gridDimensionChanged")};return GridApi.prototype.suppressEvents=function(listenerFuncs,callBackFn){var self=this,listeners=angular.isArray(listenerFuncs)?listenerFuncs:[listenerFuncs],foundListeners=self.listeners.filter(function(listener){return listeners.some(function(l){return listener.handler===l})});foundListeners.forEach(function(l){l.dereg()}),callBackFn(),foundListeners.forEach(function(l){l.dereg=registerEventWithAngular(l.eventId,l.handler,self.grid,l._this)})},GridApi.prototype.registerEvent=function(featureName,eventName){var self=this;self[featureName]||(self[featureName]={});var feature=self[featureName];feature.on||(feature.on={},feature.raise={});var eventId=self.grid.id+featureName+eventName;feature.raise[eventName]=function(){$rootScope.$emit.apply($rootScope,[eventId].concat(Array.prototype.slice.call(arguments)))},feature.on[eventName]=function(scope,handler,_this){if(null!==scope&&"undefined"==typeof scope.$on)return void gridUtil.logError("asked to listen on "+featureName+".on."+eventName+" but scope wasn't passed in the input parameters.  It is legitimate to pass null, but you've passed something else, so you probably forgot to provide scope rather than did it deliberately, not registering");var deregAngularOn=registerEventWithAngular(eventId,handler,self.grid,_this),listener={handler:handler,dereg:deregAngularOn,eventId:eventId,scope:scope,_this:_this};self.listeners.push(listener);var removeListener=function(){listener.dereg();var index=self.listeners.indexOf(listener);self.listeners.splice(index,1)};return scope&&scope.$on("$destroy",function(){removeListener()}),removeListener}},GridApi.prototype.registerEventsFromObject=function(eventObjectMap){var self=this,features=[];angular.forEach(eventObjectMap,function(featProp,featPropName){var feature={name:featPropName,events:[]};angular.forEach(featProp,function(prop,propName){feature.events.push(propName)}),features.push(feature)}),features.forEach(function(feature){feature.events.forEach(function(event){self.registerEvent(feature.name,event)})})},GridApi.prototype.registerMethod=function(featureName,methodName,callBackFn,_this){this[featureName]||(this[featureName]={});var feature=this[featureName];feature[methodName]=gridUtil.createBoundedWrapper(_this||this.grid,callBackFn)},GridApi.prototype.registerMethodsFromObject=function(methodMap,_this){var self=this,features=[];angular.forEach(methodMap,function(featProp,featPropName){var feature={name:featPropName,methods:[]};angular.forEach(featProp,function(prop,propName){feature.methods.push({name:propName,fn:prop})}),features.push(feature)}),features.forEach(function(feature){feature.methods.forEach(function(method){self.registerMethod(feature.name,method.name,method.fn,_this)})})},GridApi}])}(),function(){angular.module("ui.grid").factory("GridColumn",["gridUtil","uiGridConstants","i18nService",function(gridUtil,uiGridConstants,i18nService){function GridColumn(colDef,uid,grid){var self=this;self.grid=grid,self.uid=uid,self.updateColumnDef(colDef,!0),self.aggregationValue=void 0,self.updateAggregationValue=function(){if(!self.aggregationType)return void(self.aggregationValue=void 0);var result=0,visibleRows=self.grid.getVisibleRows(),cellValues=function(){var values=[];return visibleRows.forEach(function(row){var cellValue=self.grid.getCellValue(row,self),cellNumber=Number(cellValue);isNaN(cellNumber)||values.push(cellNumber)}),values};angular.isFunction(self.aggregationType)?self.aggregationValue=self.aggregationType(visibleRows,self):self.aggregationType===uiGridConstants.aggregationTypes.count?self.aggregationValue=self.grid.getVisibleRowCount():self.aggregationType===uiGridConstants.aggregationTypes.sum?(cellValues().forEach(function(value){result+=value}),self.aggregationValue=result):self.aggregationType===uiGridConstants.aggregationTypes.avg?(cellValues().forEach(function(value){result+=value}),result/=cellValues().length,self.aggregationValue=result):self.aggregationType===uiGridConstants.aggregationTypes.min?self.aggregationValue=Math.min.apply(null,cellValues()):self.aggregationType===uiGridConstants.aggregationTypes.max?self.aggregationValue=Math.max.apply(null,cellValues()):self.aggregationValue=""},this.getAggregationValue=function(){return self.aggregationValue}}return GridColumn.prototype.hideColumn=function(){this.colDef.visible=!1},GridColumn.prototype.setPropertyOrDefault=function(colDef,propName,defaultValue){var self=this;"undefined"!=typeof colDef[propName]&&colDef[propName]?self[propName]=colDef[propName]:"undefined"!=typeof self[propName]?self[propName]=self[propName]:self[propName]=defaultValue?defaultValue:{}},GridColumn.prototype.updateColumnDef=function(colDef,isNew){var self=this;if(self.colDef=colDef,void 0===colDef.name)throw new Error("colDef.name is required for column at index "+self.grid.options.columnDefs.indexOf(colDef));if(self.displayName=void 0===colDef.displayName?gridUtil.readableColumnName(colDef.name):colDef.displayName,!angular.isNumber(self.width)||!self.hasCustomWidth||colDef.allowCustomWidthOverride){var colDefWidth=colDef.width,parseErrorMsg="Cannot parse column width '"+colDefWidth+"' for column named '"+colDef.name+"'";if(self.hasCustomWidth=!1,angular.isString(colDefWidth)||angular.isNumber(colDefWidth))if(angular.isString(colDefWidth))if(gridUtil.endsWith(colDefWidth,"%")){var percentStr=colDefWidth.replace(/%/g,""),percent=parseInt(percentStr,10);if(isNaN(percent))throw new Error(parseErrorMsg);self.width=colDefWidth}else if(colDefWidth.match(/^(\d+)$/))self.width=parseInt(colDefWidth.match(/^(\d+)$/)[1],10);else{if(!colDefWidth.match(/^\*+$/))throw new Error(parseErrorMsg);self.width=colDefWidth}else self.width=colDefWidth;else self.width="*"}["minWidth","maxWidth"].forEach(function(name){var minOrMaxWidth=colDef[name],parseErrorMsg="Cannot parse column "+name+" '"+minOrMaxWidth+"' for column named '"+colDef.name+"'";if(angular.isString(minOrMaxWidth)||angular.isNumber(minOrMaxWidth))if(angular.isString(minOrMaxWidth)){if(!minOrMaxWidth.match(/^(\d+)$/))throw new Error(parseErrorMsg);self[name]=parseInt(minOrMaxWidth.match(/^(\d+)$/)[1],10)}else self[name]=minOrMaxWidth;else self[name]="minWidth"===name?30:9e3}),self.field=void 0===colDef.field?colDef.name:colDef.field,"string"!=typeof self.field&&gridUtil.logError("Field is not a string, this is likely to break the code, Field is: "+self.field),self.name=colDef.name,self.displayName=void 0===colDef.displayName?gridUtil.readableColumnName(colDef.name):colDef.displayName,self.aggregationType=angular.isDefined(colDef.aggregationType)?colDef.aggregationType:null,self.footerCellTemplate=angular.isDefined(colDef.footerCellTemplate)?colDef.footerCellTemplate:null,"undefined"==typeof colDef.cellTooltip||colDef.cellTooltip===!1?self.cellTooltip=!1:colDef.cellTooltip===!0?self.cellTooltip=function(row,col){return self.grid.getCellValue(row,col)}:"function"==typeof colDef.cellTooltip?self.cellTooltip=colDef.cellTooltip:self.cellTooltip=function(row,col){return col.colDef.cellTooltip},"undefined"==typeof colDef.headerTooltip||colDef.headerTooltip===!1?self.headerTooltip=!1:colDef.headerTooltip===!0?self.headerTooltip=function(col){return col.displayName}:"function"==typeof colDef.headerTooltip?self.headerTooltip=colDef.headerTooltip:self.headerTooltip=function(col){return col.colDef.headerTooltip},self.footerCellClass=colDef.footerCellClass,self.cellClass=colDef.cellClass,self.headerCellClass=colDef.headerCellClass,self.cellFilter=colDef.cellFilter?colDef.cellFilter:"",self.sortCellFiltered=!!colDef.sortCellFiltered,self.filterCellFiltered=!!colDef.filterCellFiltered,self.headerCellFilter=colDef.headerCellFilter?colDef.headerCellFilter:"",self.footerCellFilter=colDef.footerCellFilter?colDef.footerCellFilter:"",self.visible=gridUtil.isNullOrUndefined(colDef.visible)||colDef.visible,self.headerClass=colDef.headerClass,self.enableSorting="undefined"==typeof colDef.enableSorting||colDef.enableSorting,self.sortingAlgorithm=colDef.sortingAlgorithm,self.sortDirectionCycle="undefined"!=typeof colDef.sortDirectionCycle?colDef.sortDirectionCycle:[null,uiGridConstants.ASC,uiGridConstants.DESC],"undefined"==typeof self.suppressRemoveSort&&(self.suppressRemoveSort="undefined"!=typeof colDef.suppressRemoveSort&&colDef.suppressRemoveSort),self.enableFiltering="undefined"==typeof colDef.enableFiltering||colDef.enableFiltering,self.setPropertyOrDefault(colDef,"menuItems",[]),isNew&&self.setPropertyOrDefault(colDef,"sort");var defaultFilters=[];colDef.filter?defaultFilters.push(colDef.filter):colDef.filters?defaultFilters=colDef.filters:defaultFilters.push({}),isNew?(self.setPropertyOrDefault(colDef,"filter"),self.setPropertyOrDefault(colDef,"filters",defaultFilters)):self.filters.length===defaultFilters.length&&self.filters.forEach(function(filter,index){"undefined"!=typeof defaultFilters[index].placeholder&&(filter.placeholder=defaultFilters[index].placeholder),"undefined"!=typeof defaultFilters[index].ariaLabel&&(filter.ariaLabel=defaultFilters[index].ariaLabel),"undefined"!=typeof defaultFilters[index].flags&&(filter.flags=defaultFilters[index].flags),"undefined"!=typeof defaultFilters[index].type&&(filter.type=defaultFilters[index].type),"undefined"!=typeof defaultFilters[index].selectOptions&&(filter.selectOptions=defaultFilters[index].selectOptions)})},GridColumn.prototype.unsort=function(){this.sort={},this.grid.api.core.raise.sortChanged(this.grid,this.grid.getColumnSorting())},GridColumn.prototype.getColClass=function(prefixDot){var cls=uiGridConstants.COL_CLASS_PREFIX+this.uid;return prefixDot?"."+cls:cls},GridColumn.prototype.isPinnedLeft=function(){return"left"===this.renderContainer},GridColumn.prototype.isPinnedRight=function(){return"right"===this.renderContainer},GridColumn.prototype.getColClassDefinition=function(){return" .grid"+this.grid.id+" "+this.getColClass(!0)+" { min-width: "+this.drawnWidth+"px; max-width: "+this.drawnWidth+"px; }"},GridColumn.prototype.getRenderContainer=function(){var self=this,containerId=self.renderContainer;return null!==containerId&&""!==containerId&&void 0!==containerId||(containerId="body"),self.grid.renderContainers[containerId]},GridColumn.prototype.showColumn=function(){this.colDef.visible=!0},GridColumn.prototype.getAggregationText=function(){var self=this;if(self.colDef.aggregationHideLabel)return"";if(self.colDef.aggregationLabel)return self.colDef.aggregationLabel;switch(self.colDef.aggregationType){case uiGridConstants.aggregationTypes.count:return i18nService.getSafeText("aggregation.count");case uiGridConstants.aggregationTypes.sum:return i18nService.getSafeText("aggregation.sum");case uiGridConstants.aggregationTypes.avg:return i18nService.getSafeText("aggregation.avg");case uiGridConstants.aggregationTypes.min:return i18nService.getSafeText("aggregation.min");case uiGridConstants.aggregationTypes.max:return i18nService.getSafeText("aggregation.max");default:return""}},GridColumn.prototype.getCellTemplate=function(){var self=this;return self.cellTemplatePromise},GridColumn.prototype.getCompiledElementFn=function(){var self=this;return self.compiledElementFnDefer.promise},GridColumn}])}(),function(){angular.module("ui.grid").factory("GridOptions",["gridUtil","uiGridConstants",function(gridUtil,uiGridConstants){return{initialize:function(baseOptions){return baseOptions.onRegisterApi=baseOptions.onRegisterApi||angular.noop(),baseOptions.data=baseOptions.data||[],baseOptions.columnDefs=baseOptions.columnDefs||[],baseOptions.excludeProperties=baseOptions.excludeProperties||["$$hashKey"],baseOptions.enableRowHashing=baseOptions.enableRowHashing!==!1,baseOptions.rowIdentity=baseOptions.rowIdentity||function(row){return gridUtil.hashKey(row)},baseOptions.getRowIdentity=baseOptions.getRowIdentity||function(row){return row.$$hashKey},baseOptions.flatEntityAccess=baseOptions.flatEntityAccess===!0,baseOptions.showHeader="undefined"==typeof baseOptions.showHeader||baseOptions.showHeader,baseOptions.showHeader?baseOptions.headerRowHeight="undefined"!=typeof baseOptions.headerRowHeight?baseOptions.headerRowHeight:30:baseOptions.headerRowHeight=0,baseOptions.rowHeight=baseOptions.rowHeight||30,baseOptions.minRowsToShow="undefined"!=typeof baseOptions.minRowsToShow?baseOptions.minRowsToShow:10,baseOptions.showGridFooter=baseOptions.showGridFooter===!0,baseOptions.showColumnFooter=baseOptions.showColumnFooter===!0,baseOptions.columnFooterHeight="undefined"!=typeof baseOptions.columnFooterHeight?baseOptions.columnFooterHeight:30,baseOptions.gridFooterHeight="undefined"!=typeof baseOptions.gridFooterHeight?baseOptions.gridFooterHeight:30,baseOptions.columnWidth="undefined"!=typeof baseOptions.columnWidth?baseOptions.columnWidth:50,baseOptions.maxVisibleColumnCount="undefined"!=typeof baseOptions.maxVisibleColumnCount?baseOptions.maxVisibleColumnCount:200,baseOptions.virtualizationThreshold="undefined"!=typeof baseOptions.virtualizationThreshold?baseOptions.virtualizationThreshold:20,baseOptions.columnVirtualizationThreshold="undefined"!=typeof baseOptions.columnVirtualizationThreshold?baseOptions.columnVirtualizationThreshold:10,baseOptions.excessRows="undefined"!=typeof baseOptions.excessRows?baseOptions.excessRows:4,baseOptions.scrollThreshold="undefined"!=typeof baseOptions.scrollThreshold?baseOptions.scrollThreshold:4,baseOptions.excessColumns="undefined"!=typeof baseOptions.excessColumns?baseOptions.excessColumns:4,baseOptions.horizontalScrollThreshold="undefined"!=typeof baseOptions.horizontalScrollThreshold?baseOptions.horizontalScrollThreshold:2,baseOptions.aggregationCalcThrottle="undefined"!=typeof baseOptions.aggregationCalcThrottle?baseOptions.aggregationCalcThrottle:500,baseOptions.wheelScrollThrottle="undefined"!=typeof baseOptions.wheelScrollThrottle?baseOptions.wheelScrollThrottle:70,baseOptions.scrollDebounce="undefined"!=typeof baseOptions.scrollDebounce?baseOptions.scrollDebounce:300,baseOptions.enableSorting=baseOptions.enableSorting!==!1,baseOptions.enableFiltering=baseOptions.enableFiltering===!0,baseOptions.enableColumnMenus=baseOptions.enableColumnMenus!==!1,baseOptions.enableVerticalScrollbar="undefined"!=typeof baseOptions.enableVerticalScrollbar?baseOptions.enableVerticalScrollbar:uiGridConstants.scrollbars.ALWAYS,baseOptions.enableHorizontalScrollbar="undefined"!=typeof baseOptions.enableHorizontalScrollbar?baseOptions.enableHorizontalScrollbar:uiGridConstants.scrollbars.ALWAYS,baseOptions.enableMinHeightCheck=baseOptions.enableMinHeightCheck!==!1,baseOptions.minimumColumnSize="undefined"!=typeof baseOptions.minimumColumnSize?baseOptions.minimumColumnSize:10,baseOptions.rowEquality=baseOptions.rowEquality||function(entityA,entityB){return entityA===entityB},baseOptions.headerTemplate=baseOptions.headerTemplate||null,baseOptions.footerTemplate=baseOptions.footerTemplate||"ui-grid/ui-grid-footer",baseOptions.gridFooterTemplate=baseOptions.gridFooterTemplate||"ui-grid/ui-grid-grid-footer",baseOptions.rowTemplate=baseOptions.rowTemplate||"ui-grid/ui-grid-row",baseOptions.appScopeProvider=baseOptions.appScopeProvider||null,baseOptions}}}])}(),function(){angular.module("ui.grid").factory("GridRenderContainer",["gridUtil","uiGridConstants",function(gridUtil,uiGridConstants){function GridRenderContainer(name,grid,options){var self=this;self.name=name,self.grid=grid,self.visibleRowCache=[],self.visibleColumnCache=[],self.renderedRows=[],self.renderedColumns=[],self.prevScrollTop=0,self.prevScrolltopPercentage=0,self.prevRowScrollIndex=0,self.prevScrollLeft=0,self.prevScrollleftPercentage=0,self.prevColumnScrollIndex=0,self.columnStyles="",self.viewportAdjusters=[],self.hasHScrollbar=!1,self.hasVScrollbar=!1,self.canvasHeightShouldUpdate=!0,self.$$canvasHeight=0,options&&angular.isObject(options)&&angular.extend(self,options),grid.registerStyleComputation({priority:5,func:function(){return self.updateColumnWidths(),self.columnStyles}})}return GridRenderContainer.prototype.reset=function(){this.visibleColumnCache.length=0,this.visibleRowCache.length=0,this.renderedRows.length=0,this.renderedColumns.length=0},GridRenderContainer.prototype.containsColumn=function(col){return this.visibleColumnCache.indexOf(col)!==-1},GridRenderContainer.prototype.minRowsToRender=function(){for(var self=this,minRows=0,rowAddedHeight=0,viewPortHeight=self.getViewportHeight(),i=self.visibleRowCache.length-1;rowAddedHeight<viewPortHeight&&i>=0;i--)rowAddedHeight+=self.visibleRowCache[i].height,minRows++;return minRows},GridRenderContainer.prototype.minColumnsToRender=function(){for(var self=this,viewportWidth=this.getViewportWidth(),min=0,totalWidth=0,i=0;i<self.visibleColumnCache.length;i++){var col=self.visibleColumnCache[i];if(totalWidth<viewportWidth)totalWidth+=col.drawnWidth?col.drawnWidth:0,min++;else{for(var currWidth=0,j=i;j>=i-min;j--)currWidth+=self.visibleColumnCache[j].drawnWidth?self.visibleColumnCache[j].drawnWidth:0;currWidth<viewportWidth&&min++}}return min},GridRenderContainer.prototype.getVisibleRowCount=function(){return this.visibleRowCache.length},GridRenderContainer.prototype.registerViewportAdjuster=function(func){this.viewportAdjusters.push(func)},GridRenderContainer.prototype.removeViewportAdjuster=function(func){var idx=this.viewportAdjusters.indexOf(func);idx>-1&&this.viewportAdjusters.splice(idx,1)},GridRenderContainer.prototype.getViewportAdjustment=function(){var self=this,adjustment={height:0,width:0};return self.viewportAdjusters.forEach(function(func){adjustment=func.call(this,adjustment)}),adjustment},GridRenderContainer.prototype.getMargin=function(side){var self=this,amount=0;return self.viewportAdjusters.forEach(function(func){var adjustment=func.call(this,{height:0,width:0});adjustment.side&&adjustment.side===side&&(amount+=adjustment.width*-1)}),amount},GridRenderContainer.prototype.getViewportHeight=function(){var self=this,headerHeight=self.headerHeight?self.headerHeight:self.grid.headerHeight,viewPortHeight=self.grid.gridHeight-headerHeight-self.grid.footerHeight,adjustment=self.getViewportAdjustment();return viewPortHeight+=adjustment.height},GridRenderContainer.prototype.getViewportWidth=function(){var self=this,viewportWidth=self.grid.gridWidth,adjustment=self.getViewportAdjustment();return viewportWidth+=adjustment.width},GridRenderContainer.prototype.getHeaderViewportWidth=function(){var viewportWidth=this.getViewportWidth();return viewportWidth},GridRenderContainer.prototype.getCanvasHeight=function(){var self=this;if(!self.canvasHeightShouldUpdate)return self.$$canvasHeight;var oldCanvasHeight=self.$$canvasHeight;return self.$$canvasHeight=0,self.visibleRowCache.forEach(function(row){self.$$canvasHeight+=row.height}),self.canvasHeightShouldUpdate=!1,self.grid.api.core.raise.canvasHeightChanged(oldCanvasHeight,self.$$canvasHeight),self.$$canvasHeight},GridRenderContainer.prototype.getVerticalScrollLength=function(){return this.getCanvasHeight()-this.getViewportHeight()+this.grid.scrollbarHeight},GridRenderContainer.prototype.getHorizontalScrollLength=function(){return this.getCanvasWidth()-this.getViewportWidth()+this.grid.scrollbarWidth},GridRenderContainer.prototype.getCanvasWidth=function(){var self=this,ret=self.canvasWidth;return ret},GridRenderContainer.prototype.setRenderedRows=function(newRows){this.renderedRows.length=newRows.length;for(var i=0;i<newRows.length;i++)this.renderedRows[i]=newRows[i]},GridRenderContainer.prototype.setRenderedColumns=function(newColumns){this.renderedColumns.length=newColumns.length;for(var i=0;i<newColumns.length;i++)this.renderedColumns[i]=newColumns[i];this.updateColumnOffset()},GridRenderContainer.prototype.updateColumnOffset=function(){for(var hiddenColumnsWidth=0,i=0;i<this.currentFirstColumn;i++)hiddenColumnsWidth+=this.visibleColumnCache[i].drawnWidth;this.columnOffset=hiddenColumnsWidth},GridRenderContainer.prototype.scrollVertical=function(newScrollTop){var vertScrollPercentage=-1;if(newScrollTop!==this.prevScrollTop){var yDiff=newScrollTop-this.prevScrollTop;yDiff>0&&(this.grid.scrollDirection=uiGridConstants.scrollDirection.DOWN),yDiff<0&&(this.grid.scrollDirection=uiGridConstants.scrollDirection.UP);var vertScrollLength=this.getVerticalScrollLength();return vertScrollPercentage=newScrollTop/vertScrollLength,vertScrollPercentage>1&&(vertScrollPercentage=1),vertScrollPercentage<0&&(vertScrollPercentage=0),this.adjustScrollVertical(newScrollTop,vertScrollPercentage),vertScrollPercentage}},GridRenderContainer.prototype.scrollHorizontal=function(newScrollLeft){var horizScrollPercentage=-1;if(newScrollLeft!==this.prevScrollLeft){var xDiff=newScrollLeft-this.prevScrollLeft;xDiff>0&&(this.grid.scrollDirection=uiGridConstants.scrollDirection.RIGHT),xDiff<0&&(this.grid.scrollDirection=uiGridConstants.scrollDirection.LEFT);var horizScrollLength=this.getHorizontalScrollLength();return horizScrollPercentage=0!==horizScrollLength?newScrollLeft/horizScrollLength:0,this.adjustScrollHorizontal(newScrollLeft,horizScrollPercentage),horizScrollPercentage}},GridRenderContainer.prototype.adjustScrollVertical=function(scrollTop,scrollPercentage,force){(this.prevScrollTop!==scrollTop||force)&&("undefined"!=typeof scrollTop&&void 0!==scrollTop&&null!==scrollTop||(scrollTop=(this.getCanvasHeight()-this.getViewportHeight())*scrollPercentage),this.adjustRows(scrollTop,scrollPercentage,!1),this.prevScrollTop=scrollTop,this.prevScrolltopPercentage=scrollPercentage,this.grid.queueRefresh())},GridRenderContainer.prototype.adjustScrollHorizontal=function(scrollLeft,scrollPercentage,force){(this.prevScrollLeft!==scrollLeft||force)&&("undefined"!=typeof scrollLeft&&void 0!==scrollLeft&&null!==scrollLeft||(scrollLeft=(this.getCanvasWidth()-this.getViewportWidth())*scrollPercentage),this.adjustColumns(scrollLeft,scrollPercentage),this.prevScrollLeft=scrollLeft,this.prevScrollleftPercentage=scrollPercentage,this.grid.queueRefresh())},GridRenderContainer.prototype.adjustRows=function(scrollTop,scrollPercentage,postDataLoaded){var self=this,minRows=self.minRowsToRender(),rowCache=self.visibleRowCache,maxRowIndex=rowCache.length-minRows;"undefined"!=typeof scrollPercentage&&null!==scrollPercentage||!scrollTop||(scrollPercentage=scrollTop/self.getVerticalScrollLength());
var rowIndex=Math.ceil(Math.min(maxRowIndex,maxRowIndex*scrollPercentage));rowIndex>maxRowIndex&&(rowIndex=maxRowIndex);var newRange=[];if(rowCache.length>self.grid.options.virtualizationThreshold){if("undefined"!=typeof scrollTop&&null!==scrollTop){if(!self.grid.suppressParentScrollDown&&self.prevScrollTop<scrollTop&&rowIndex<self.prevRowScrollIndex+self.grid.options.scrollThreshold&&rowIndex<maxRowIndex)return;if(!self.grid.suppressParentScrollUp&&self.prevScrollTop>scrollTop&&rowIndex>self.prevRowScrollIndex-self.grid.options.scrollThreshold&&rowIndex<maxRowIndex)return}var rangeStart={},rangeEnd={};rangeStart=Math.max(0,rowIndex-self.grid.options.excessRows),rangeEnd=Math.min(rowCache.length,rowIndex+minRows+self.grid.options.excessRows),newRange=[rangeStart,rangeEnd]}else{var maxLen=self.visibleRowCache.length;newRange=[0,Math.max(maxLen,minRows+self.grid.options.excessRows)]}self.updateViewableRowRange(newRange),self.prevRowScrollIndex=rowIndex},GridRenderContainer.prototype.adjustColumns=function(scrollLeft,scrollPercentage){var self=this,minCols=self.minColumnsToRender(),columnCache=self.visibleColumnCache,maxColumnIndex=columnCache.length-minCols;"undefined"!=typeof scrollPercentage&&null!==scrollPercentage||!scrollLeft||(scrollPercentage=scrollLeft/self.getHorizontalScrollLength());var colIndex=Math.ceil(Math.min(maxColumnIndex,maxColumnIndex*scrollPercentage));colIndex>maxColumnIndex&&(colIndex=maxColumnIndex);var newRange=[];if(columnCache.length>self.grid.options.columnVirtualizationThreshold&&self.getCanvasWidth()>self.getViewportWidth()){var rangeStart=Math.max(0,colIndex-self.grid.options.excessColumns),rangeEnd=Math.min(columnCache.length,colIndex+minCols+self.grid.options.excessColumns);newRange=[rangeStart,rangeEnd]}else{var maxLen=self.visibleColumnCache.length;newRange=[0,Math.max(maxLen,minCols+self.grid.options.excessColumns)]}self.updateViewableColumnRange(newRange),self.prevColumnScrollIndex=colIndex},GridRenderContainer.prototype.updateViewableRowRange=function(renderedRange){var rowArr=this.visibleRowCache.slice(renderedRange[0],renderedRange[1]);this.currentTopRow=renderedRange[0],this.setRenderedRows(rowArr)},GridRenderContainer.prototype.updateViewableColumnRange=function(renderedRange){var columnArr=this.visibleColumnCache.slice(renderedRange[0],renderedRange[1]);this.currentFirstColumn=renderedRange[0],this.setRenderedColumns(columnArr)},GridRenderContainer.prototype.headerCellWrapperStyle=function(){var self=this;if(0!==self.currentFirstColumn){var offset=self.columnOffset;return self.grid.isRTL()?{"margin-right":offset+"px"}:{"margin-left":offset+"px"}}return null},GridRenderContainer.prototype.updateColumnWidths=function(){var self=this,asterisksArray=[],asteriskNum=0,usedWidthSum=0,ret="",availableWidth=self.grid.getViewportWidth()-self.grid.scrollbarWidth,columnCache=[];angular.forEach(self.grid.renderContainers,function(container,name){columnCache=columnCache.concat(container.visibleColumnCache)}),columnCache.forEach(function(column,i){var width=0;column.visible&&(angular.isNumber(column.width)?(width=parseInt(column.width,10),usedWidthSum+=width,column.drawnWidth=width):gridUtil.endsWith(column.width,"%")?(width=parseInt(parseInt(column.width.replace(/%/g,""),10)/100*availableWidth),width>column.maxWidth&&(width=column.maxWidth),width<column.minWidth&&(width=column.minWidth),usedWidthSum+=width,column.drawnWidth=width):angular.isString(column.width)&&column.width.indexOf("*")!==-1&&(asteriskNum+=column.width.length,asterisksArray.push(column)))});var remainingWidth=availableWidth-usedWidthSum;if(asterisksArray.length>0){var asteriskVal=remainingWidth/asteriskNum;asterisksArray.forEach(function(column){var width=parseInt(column.width.length*asteriskVal,10);width>column.maxWidth&&(width=column.maxWidth),width<column.minWidth&&(width=column.minWidth),usedWidthSum+=width,column.drawnWidth=width})}for(var processColumnUpwards=function(column){column.drawnWidth<column.maxWidth&&leftoverWidth>0&&(column.drawnWidth++,usedWidthSum++,leftoverWidth--,columnsToChange=!0)},leftoverWidth=availableWidth-usedWidthSum,columnsToChange=!0;leftoverWidth>0&&columnsToChange;)columnsToChange=!1,asterisksArray.forEach(processColumnUpwards);var processColumnDownwards=function(column){column.drawnWidth>column.minWidth&&excessWidth>0&&(column.drawnWidth--,usedWidthSum--,excessWidth--,columnsToChange=!0)},excessWidth=usedWidthSum-availableWidth;for(columnsToChange=!0;excessWidth>0&&columnsToChange;)columnsToChange=!1,asterisksArray.forEach(processColumnDownwards);var canvasWidth=0;self.visibleColumnCache.forEach(function(column){column.visible&&(canvasWidth+=column.drawnWidth)}),columnCache.forEach(function(column){ret+=column.getColClassDefinition()}),self.canvasWidth=canvasWidth,this.columnStyles=ret},GridRenderContainer.prototype.needsHScrollbarPlaceholder=function(){return this.grid.options.enableHorizontalScrollbar&&!this.hasHScrollbar&&!this.grid.disableScrolling},GridRenderContainer.prototype.getViewportStyle=function(){var self=this,styles={};return self.hasHScrollbar=!1,self.hasVScrollbar=!1,self.grid.disableScrolling?(styles["overflow-x"]="hidden",styles["overflow-y"]="hidden",styles):("body"===self.name?(self.hasHScrollbar=self.grid.options.enableHorizontalScrollbar!==uiGridConstants.scrollbars.NEVER,self.grid.isRTL()?self.grid.hasLeftContainerColumns()||(self.hasVScrollbar=self.grid.options.enableVerticalScrollbar!==uiGridConstants.scrollbars.NEVER):self.grid.hasRightContainerColumns()||(self.hasVScrollbar=self.grid.options.enableVerticalScrollbar!==uiGridConstants.scrollbars.NEVER)):"left"===self.name?self.hasVScrollbar=!!self.grid.isRTL()&&self.grid.options.enableVerticalScrollbar!==uiGridConstants.scrollbars.NEVER:self.hasVScrollbar=!self.grid.isRTL()&&self.grid.options.enableVerticalScrollbar!==uiGridConstants.scrollbars.NEVER,styles["overflow-x"]=self.hasHScrollbar?"scroll":"hidden",styles["overflow-y"]=self.hasVScrollbar?"scroll":"hidden",styles)},GridRenderContainer}])}(),function(){angular.module("ui.grid").factory("GridRow",["gridUtil","uiGridConstants",function(gridUtil,uiGridConstants){function GridRow(entity,index,grid){this.grid=grid,this.entity=entity,this.uid=gridUtil.nextUid(),this.visible=!0,this.$$height=grid.options.rowHeight}return Object.defineProperty(GridRow.prototype,"height",{get:function(){return this.$$height},set:function(height){height!==this.$$height&&(this.grid.updateCanvasHeight(),this.$$height=height)}}),GridRow.prototype.getQualifiedColField=function(col){return"row."+this.getEntityQualifiedColField(col)},GridRow.prototype.getEntityQualifiedColField=function(col){var base="entity";return col.field===uiGridConstants.ENTITY_BINDING?base:gridUtil.preEval(base+"."+col.field)},GridRow.prototype.setRowInvisible=function(row){row&&row.setThisRowInvisible&&row.setThisRowInvisible("user")},GridRow.prototype.clearRowInvisible=function(row){row&&row.clearThisRowInvisible&&row.clearThisRowInvisible("user")},GridRow.prototype.setThisRowInvisible=function(reason,fromRowsProcessor){this.invisibleReason||(this.invisibleReason={}),this.invisibleReason[reason]=!0,this.evaluateRowVisibility(fromRowsProcessor)},GridRow.prototype.clearThisRowInvisible=function(reason,fromRowsProcessor){"undefined"!=typeof this.invisibleReason&&delete this.invisibleReason[reason],this.evaluateRowVisibility(fromRowsProcessor)},GridRow.prototype.evaluateRowVisibility=function(fromRowProcessor){var newVisibility=!0;"undefined"!=typeof this.invisibleReason&&angular.forEach(this.invisibleReason,function(value,key){value&&(newVisibility=!1)}),"undefined"!=typeof this.visible&&this.visible===newVisibility||(this.visible=newVisibility,fromRowProcessor||(this.grid.queueGridRefresh(),this.grid.api.core.raise.rowsVisibleChanged(this)))},GridRow}])}(),function(){angular.module("ui.grid").factory("GridRowColumn",["$parse","$filter",function($parse,$filter){var GridRowColumn=function GridRowColumn(row,col){if(!(this instanceof GridRowColumn))throw"Using GridRowColumn as a function insead of as a constructor. Must be called with `new` keyword";this.row=row,this.col=col};return GridRowColumn.prototype.getIntersectionValueRaw=function(){var getter=$parse(this.row.getEntityQualifiedColField(this.col)),context=this.row;return getter(context)},GridRowColumn}])}(),function(){angular.module("ui.grid").factory("ScrollEvent",["gridUtil",function(gridUtil){function ScrollEvent(grid,sourceRowContainer,sourceColContainer,source){var self=this;if(!grid)throw new Error("grid argument is required");self.grid=grid,self.source=source,self.withDelay=!0,self.sourceRowContainer=sourceRowContainer,self.sourceColContainer=sourceColContainer,self.newScrollLeft=null,self.newScrollTop=null,self.x=null,self.y=null,self.verticalScrollLength=-9999999,self.horizontalScrollLength=-999999,self.fireThrottledScrollingEvent=gridUtil.throttle(function(sourceContainerId){self.grid.scrollContainers(sourceContainerId,self)},self.grid.options.wheelScrollThrottle,{trailing:!0})}return ScrollEvent.prototype.getNewScrollLeft=function(colContainer,viewport){var self=this;if(!self.newScrollLeft){var scrollXPercentage,scrollWidth=colContainer.getCanvasWidth()-colContainer.getViewportWidth(),oldScrollLeft=gridUtil.normalizeScrollLeft(viewport,self.grid);if("undefined"!=typeof self.x.percentage&&void 0!==self.x.percentage)scrollXPercentage=self.x.percentage;else{if("undefined"==typeof self.x.pixels||void 0===self.x.pixels)throw new Error("No percentage or pixel value provided for scroll event X axis");scrollXPercentage=self.x.percentage=(oldScrollLeft+self.x.pixels)/scrollWidth}return Math.max(0,scrollXPercentage*scrollWidth)}return self.newScrollLeft},ScrollEvent.prototype.getNewScrollTop=function(rowContainer,viewport){var self=this;if(!self.newScrollTop){var scrollYPercentage,scrollLength=rowContainer.getVerticalScrollLength(),oldScrollTop=viewport[0].scrollTop;if("undefined"!=typeof self.y.percentage&&void 0!==self.y.percentage)scrollYPercentage=self.y.percentage;else{if("undefined"==typeof self.y.pixels||void 0===self.y.pixels)throw new Error("No percentage or pixel value provided for scroll event Y axis");scrollYPercentage=self.y.percentage=(oldScrollTop+self.y.pixels)/scrollLength}return Math.max(0,scrollYPercentage*scrollLength)}return self.newScrollTop},ScrollEvent.prototype.atTop=function(scrollTop){return this.y&&(0===this.y.percentage||this.verticalScrollLength<0)&&0===scrollTop},ScrollEvent.prototype.atBottom=function(scrollTop){return this.y&&(1===this.y.percentage||0===this.verticalScrollLength)&&scrollTop>0},ScrollEvent.prototype.atLeft=function(scrollLeft){return this.x&&(0===this.x.percentage||this.horizontalScrollLength<0)&&0===scrollLeft},ScrollEvent.prototype.atRight=function(scrollLeft){return this.x&&(1===this.x.percentage||0===this.horizontalScrollLength)&&scrollLeft>0},ScrollEvent.Sources={ViewPortScroll:"ViewPortScroll",RenderContainerMouseWheel:"RenderContainerMouseWheel",RenderContainerTouchMove:"RenderContainerTouchMove",Other:99},ScrollEvent}])}(),function(){angular.module("ui.grid").service("gridClassFactory",["gridUtil","$q","$compile","$templateCache","uiGridConstants","Grid","GridColumn","GridRow",function(gridUtil,$q,$compile,$templateCache,uiGridConstants,Grid,GridColumn,GridRow){var service={createGrid:function(options){options="undefined"!=typeof options?options:{},options.id=gridUtil.newId();var grid=new Grid(options);if(grid.options.rowTemplate){var rowTemplateFnPromise=$q.defer();grid.getRowTemplateFn=rowTemplateFnPromise.promise,gridUtil.getTemplate(grid.options.rowTemplate).then(function(template){var rowTemplateFn=$compile(template);rowTemplateFnPromise.resolve(rowTemplateFn)},function(res){throw new Error("Couldn't fetch/use row template '"+grid.options.rowTemplate+"'")})}return grid.registerColumnBuilder(service.defaultColumnBuilder),grid.registerRowBuilder(service.rowTemplateAssigner),grid.registerRowsProcessor(function(rows){return rows.forEach(function(row){row.evaluateRowVisibility(!0)},50),rows}),grid.registerColumnsProcessor(function(columns){return columns.forEach(function(column){column.visible=!angular.isDefined(column.colDef.visible)||column.colDef.visible}),columns},50),grid.registerRowsProcessor(grid.searchRows,100),grid.options.externalSort&&angular.isFunction(grid.options.externalSort)?grid.registerRowsProcessor(grid.options.externalSort,200):grid.registerRowsProcessor(grid.sortByColumn,200),grid},defaultColumnBuilder:function(colDef,col,gridOptions){var templateGetPromises=[],processTemplate=function(templateType,providedType,defaultTemplate,filterType,tooltipType){colDef[templateType]?col[providedType]=colDef[templateType]:col[providedType]=defaultTemplate,templateGetPromises.push(gridUtil.getTemplate(col[providedType]).then(function(template){angular.isFunction(template)&&(template=template());var tooltipCall="cellTooltip"===tooltipType?"col.cellTooltip(row,col)":"col.headerTooltip(col)";tooltipType&&col[tooltipType]===!1?template=template.replace(uiGridConstants.TOOLTIP,""):tooltipType&&col[tooltipType]&&(template=template.replace(uiGridConstants.TOOLTIP,'title="{{'+tooltipCall+' CUSTOM_FILTERS }}"')),filterType?col[templateType]=template.replace(uiGridConstants.CUSTOM_FILTERS,function(){return col[filterType]?"|"+col[filterType]:""}):col[templateType]=template},function(res){throw new Error("Couldn't fetch/use colDef."+templateType+" '"+colDef[templateType]+"'")}))};return processTemplate("cellTemplate","providedCellTemplate","ui-grid/uiGridCell","cellFilter","cellTooltip"),col.cellTemplatePromise=templateGetPromises[0],processTemplate("headerCellTemplate","providedHeaderCellTemplate","ui-grid/uiGridHeaderCell","headerCellFilter","headerTooltip"),processTemplate("footerCellTemplate","providedFooterCellTemplate","ui-grid/uiGridFooterCell","footerCellFilter"),processTemplate("filterHeaderTemplate","providedFilterHeaderTemplate","ui-grid/ui-grid-filter"),col.compiledElementFnDefer=$q.defer(),$q.all(templateGetPromises)},rowTemplateAssigner:function(row){var grid=this;if(row.rowTemplate){var perRowTemplateFnPromise=$q.defer();row.getRowTemplateFn=perRowTemplateFnPromise.promise,gridUtil.getTemplate(row.rowTemplate).then(function(template){var rowTemplateFn=$compile(template);perRowTemplateFnPromise.resolve(rowTemplateFn)},function(res){throw new Error("Couldn't fetch/use row template '"+row.rowTemplate+"'")})}else row.rowTemplate=grid.options.rowTemplate,row.getRowTemplateFn=grid.getRowTemplateFn;return row.getRowTemplateFn}};return service}])}(),function(){function escapeRegExp(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var module=angular.module("ui.grid");module.service("rowSearcher",["gridUtil","uiGridConstants",function(gridUtil,uiGridConstants){var defaultCondition=uiGridConstants.filter.CONTAINS,rowSearcher={};return rowSearcher.getTerm=function(filter){if("undefined"==typeof filter.term)return filter.term;var term=filter.term;return"string"==typeof term&&(term=term.trim()),term},rowSearcher.stripTerm=function(filter){var term=rowSearcher.getTerm(filter);return"string"==typeof term?escapeRegExp(term.replace(/(^\*|\*$)/g,"")):term},rowSearcher.guessCondition=function(filter){if("undefined"==typeof filter.term||!filter.term)return defaultCondition;var term=rowSearcher.getTerm(filter);if(/\*/.test(term)){var regexpFlags="";filter.flags&&filter.flags.caseSensitive||(regexpFlags+="i");var reText=term.replace(/(\\)?\*/g,function($0,$1){return $1?$0:"[\\s\\S]*?"});return new RegExp("^"+reText+"$",regexpFlags)}return defaultCondition},rowSearcher.setupFilters=function(filters){for(var newFilters=[],filtersLength=filters.length,i=0;i<filtersLength;i++){var filter=filters[i];if(filter.noTerm||!gridUtil.isNullOrUndefined(filter.term)){var newFilter={},regexpFlags="";filter.flags&&filter.flags.caseSensitive||(regexpFlags+="i"),gridUtil.isNullOrUndefined(filter.term)||(filter.rawTerm?newFilter.term=filter.term:newFilter.term=rowSearcher.stripTerm(filter)),newFilter.noTerm=filter.noTerm,filter.condition?newFilter.condition=filter.condition:newFilter.condition=rowSearcher.guessCondition(filter),newFilter.flags=angular.extend({caseSensitive:!1,date:!1},filter.flags),newFilter.condition===uiGridConstants.filter.STARTS_WITH&&(newFilter.startswithRE=new RegExp("^"+newFilter.term,regexpFlags)),newFilter.condition===uiGridConstants.filter.ENDS_WITH&&(newFilter.endswithRE=new RegExp(newFilter.term+"$",regexpFlags)),newFilter.condition===uiGridConstants.filter.CONTAINS&&(newFilter.containsRE=new RegExp(newFilter.term,regexpFlags)),newFilter.condition===uiGridConstants.filter.EXACT&&(newFilter.exactRE=new RegExp("^"+newFilter.term+"$",regexpFlags)),newFilters.push(newFilter)}}return newFilters},rowSearcher.runColumnFilter=function(grid,row,column,filter){var value,conditionType=typeof filter.condition,term=filter.term;if(value=column.filterCellFiltered?grid.getCellDisplayValue(row,column):grid.getCellValue(row,column),filter.condition instanceof RegExp)return filter.condition.test(value);if("function"===conditionType)return filter.condition(term,value,row,column);if(filter.startswithRE)return filter.startswithRE.test(value);if(filter.endswithRE)return filter.endswithRE.test(value);if(filter.containsRE)return filter.containsRE.test(value);if(filter.exactRE)return filter.exactRE.test(value);if(filter.condition===uiGridConstants.filter.NOT_EQUAL){var regex=new RegExp("^"+term+"$");return!regex.exec(value)}if("number"==typeof value&&"string"==typeof term){var tempFloat=parseFloat(term.replace(/\\\./,".").replace(/\\\-/,"-"));isNaN(tempFloat)||(term=tempFloat)}return filter.flags.date===!0&&(value=new Date(value),term=new Date(term.replace(/\\/g,""))),filter.condition===uiGridConstants.filter.GREATER_THAN?value>term:filter.condition===uiGridConstants.filter.GREATER_THAN_OR_EQUAL?value>=term:filter.condition===uiGridConstants.filter.LESS_THAN?value<term:filter.condition!==uiGridConstants.filter.LESS_THAN_OR_EQUAL||value<=term},rowSearcher.searchColumn=function(grid,row,column,filters){if(grid.options.useExternalFiltering)return!0;for(var filtersLength=filters.length,i=0;i<filtersLength;i++){var filter=filters[i];if(!gridUtil.isNullOrUndefined(filter.term)&&""!==filter.term||filter.noTerm){var ret=rowSearcher.runColumnFilter(grid,row,column,filter);if(!ret)return!1}}return!0},rowSearcher.search=function(grid,rows,columns){if(rows){if(!grid.options.enableFiltering)return rows;for(var filterData=[],colsLength=columns.length,hasTerm=function(filters){var hasTerm=!1;return filters.forEach(function(filter){(!gridUtil.isNullOrUndefined(filter.term)&&""!==filter.term||filter.noTerm)&&(hasTerm=!0)}),hasTerm},i=0;i<colsLength;i++){var col=columns[i];"undefined"!=typeof col.filters&&hasTerm(col.filters)&&filterData.push({col:col,filters:rowSearcher.setupFilters(col.filters)})}if(filterData.length>0){for(var foreachRow=function(grid,row,col,filters){row.visible&&!rowSearcher.searchColumn(grid,row,col,filters)&&(row.visible=!1)},foreachFilterCol=function(grid,filterData){for(var rowsLength=rows.length,i=0;i<rowsLength;i++)foreachRow(grid,rows[i],filterData.col,filterData.filters)},filterDataLength=filterData.length,j=0;j<filterDataLength;j++)foreachFilterCol(grid,filterData[j]);grid.api.core.raise.rowsVisibleChanged&&grid.api.core.raise.rowsVisibleChanged()}return rows}},rowSearcher}])}(),function(){var module=angular.module("ui.grid");module.service("rowSorter",["$parse","uiGridConstants",function($parse,uiGridConstants){var currencyRegexStr="("+uiGridConstants.CURRENCY_SYMBOLS.map(function(a){return"\\"+a}).join("|")+")?",rowSorter=(new RegExp("^[-+]?"+currencyRegexStr+"[\\d,.]+"+currencyRegexStr+"%?$"),{colSortFnCache:{}});return rowSorter.guessSortFn=function(itemType){switch(itemType){case"number":return rowSorter.sortNumber;case"numberStr":return rowSorter.sortNumberStr;case"boolean":return rowSorter.sortBool;case"string":return rowSorter.sortAlpha;case"date":return rowSorter.sortDate;case"object":return rowSorter.basicSort;default:throw new Error("No sorting function found for type:"+itemType)}},rowSorter.handleNulls=function(a,b){if(!a&&0!==a&&a!==!1||!b&&0!==b&&b!==!1){if(!a&&0!==a&&a!==!1&&!b&&0!==b&&b!==!1)return 0;if(!a&&0!==a&&a!==!1)return 1;if(!b&&0!==b&&b!==!1)return-1}return null},rowSorter.basicSort=function(a,b){var nulls=rowSorter.handleNulls(a,b);return null!==nulls?nulls:a===b?0:a<b?-1:1},rowSorter.sortNumber=function(a,b){var nulls=rowSorter.handleNulls(a,b);return null!==nulls?nulls:a-b},rowSorter.sortNumberStr=function(a,b){var nulls=rowSorter.handleNulls(a,b);if(null!==nulls)return nulls;var numA,numB,badA=!1,badB=!1;return numA=parseFloat(a.replace(/[^0-9.-]/g,"")),isNaN(numA)&&(badA=!0),numB=parseFloat(b.replace(/[^0-9.-]/g,"")),isNaN(numB)&&(badB=!0),badA&&badB?0:badA?1:badB?-1:numA-numB},rowSorter.sortAlpha=function(a,b){var nulls=rowSorter.handleNulls(a,b);if(null!==nulls)return nulls;var strA=a.toString().toLowerCase(),strB=b.toString().toLowerCase();return strA===strB?0:strA.localeCompare(strB)},rowSorter.sortDate=function(a,b){var nulls=rowSorter.handleNulls(a,b);if(null!==nulls)return nulls;a instanceof Date||(a=new Date(a)),b instanceof Date||(b=new Date(b));var timeA=a.getTime(),timeB=b.getTime();return timeA===timeB?0:timeA<timeB?-1:1},rowSorter.sortBool=function(a,b){var nulls=rowSorter.handleNulls(a,b);return null!==nulls?nulls:a&&b?0:a||b?a?1:-1:0},rowSorter.getSortFn=function(grid,col,rows){var sortFn;return rowSorter.colSortFnCache[col.colDef.name]?sortFn=rowSorter.colSortFnCache[col.colDef.name]:void 0!==col.sortingAlgorithm?(sortFn=col.sortingAlgorithm,rowSorter.colSortFnCache[col.colDef.name]=col.sortingAlgorithm):col.sortCellFiltered&&col.cellFilter?(sortFn=rowSorter.sortAlpha,rowSorter.colSortFnCache[col.colDef.name]=sortFn):(sortFn=rowSorter.guessSortFn(col.colDef.type),sortFn?rowSorter.colSortFnCache[col.colDef.name]=sortFn:sortFn=rowSorter.sortAlpha),sortFn},rowSorter.prioritySort=function(a,b){return void 0!==a.sort.priority&&void 0!==b.sort.priority?a.sort.priority<b.sort.priority?-1:a.sort.priority===b.sort.priority?0:1:a.sort.priority||void 0===a.sort.priority?-1:b.sort.priority||void 0===b.sort.priority?1:0},rowSorter.sort=function(grid,rows,columns){if(rows){if(grid.options.useExternalSorting)return rows;var sortCols=[];if(columns.forEach(function(col){!col.sort||col.sort.ignoreSort||!col.sort.direction||col.sort.direction!==uiGridConstants.ASC&&col.sort.direction!==uiGridConstants.DESC||sortCols.push(col)}),sortCols=sortCols.sort(rowSorter.prioritySort),0===sortCols.length)return rows;var col,direction,setIndex=function(row,idx){row.entity.$$uiGridIndex=idx};rows.forEach(setIndex);var r=rows.slice(0),rowSortFn=function(rowA,rowB){for(var sortFn,tem=0,idx=0;0===tem&&idx<sortCols.length;){col=sortCols[idx],direction=sortCols[idx].sort.direction,sortFn=rowSorter.getSortFn(grid,col,r);var propA,propB;col.sortCellFiltered?(propA=grid.getCellDisplayValue(rowA,col),propB=grid.getCellDisplayValue(rowB,col)):(propA=grid.getCellValue(rowA,col),propB=grid.getCellValue(rowB,col)),tem=sortFn(propA,propB,rowA,rowB,direction),idx++}return 0===tem?rowA.entity.$$uiGridIndex-rowB.entity.$$uiGridIndex:direction===uiGridConstants.ASC?tem:0-tem},newRows=rows.sort(rowSortFn),clearIndex=function(row,idx){delete row.entity.$$uiGridIndex};return rows.forEach(clearIndex),newRows}},rowSorter}])}(),function(){function getStyles(elem){var e=elem;return"undefined"!=typeof e.length&&e.length&&(e=elem[0]),e.ownerDocument.defaultView.getComputedStyle(e,null)}function augmentWidthOrHeight(elem,name,extra,isBorderBox,styles){for(var i=extra===(isBorderBox?"border":"content")?4:"width"===name?1:0,val=0,sides=["Top","Right","Bottom","Left"];i<4;i+=2){var side=sides[i];if("margin"===extra){var marg=parseFloat(styles[extra+side]);isNaN(marg)||(val+=marg)}if(isBorderBox){if("content"===extra){var padd=parseFloat(styles["padding"+side]);isNaN(padd)||(val-=padd)}if("margin"!==extra){var bordermarg=parseFloat(styles["border"+side+"Width"]);isNaN(bordermarg)||(val-=bordermarg)}}else{var nocontentPad=parseFloat(styles["padding"+side]);if(isNaN(nocontentPad)||(val+=nocontentPad),"padding"!==extra){var nocontentnopad=parseFloat(styles["border"+side+"Width"]);isNaN(nocontentnopad)||(val+=nocontentnopad)}}}return val}function getWidthOrHeight(elem,name,extra){var val,valueIsBorderBox=!0,styles=getStyles(elem),isBorderBox="border-box"===styles.boxSizing;if(val<=0||null==val){if(val=styles[name],(val<0||null==val)&&(val=elem.style[name]),rnumnonpx.test(val))return val;valueIsBorderBox=isBorderBox&&!0,val=parseFloat(val)||0}var ret=val+augmentWidthOrHeight(elem,name,extra||(isBorderBox?"border":"content"),valueIsBorderBox,styles);return ret}function getLineHeight(elm){elm=angular.element(elm)[0];var parent=elm.parentElement;return parent||(parent=document.getElementsByTagName("body")[0]),parseInt(getStyles(parent).fontSize)||parseInt(getStyles(elm).fontSize)||16}var bindPolyfill,module=angular.module("ui.grid");"function"!=typeof Function.prototype.bind&&(bindPolyfill=function(){var slice=Array.prototype.slice;return function(context){var fn=this,args=slice.call(arguments,1);return args.length?function(){return arguments.length?fn.apply(context,args.concat(slice.call(arguments))):fn.apply(context,args)}:function(){return arguments.length?fn.apply(context,arguments):fn.call(context)}}});var rnumnonpx=new RegExp("^("+/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source+")(?!px)[a-z%]+$","i"),rdisplayswap=/^(block|none|table(?!-c[ea]).+)/,cssShow={position:"absolute",visibility:"hidden",display:"block"},uid=["0","0","0","0"],uidPrefix="uiGrid-";module.service("gridUtil",["$log","$window","$document","$http","$templateCache","$timeout","$interval","$injector","$q","$interpolate","uiGridConstants",function($log,$window,$document,$http,$templateCache,$timeout,$interval,$injector,$q,$interpolate,uiGridConstants){function mousewheelHandler(fn,event){var $elm=angular.element(this),delta=0,deltaX=0,deltaY=0,absDelta=0;if(event.originalEvent&&(event=event.originalEvent),"detail"in event&&(deltaY=event.detail*-1),"wheelDelta"in event&&(deltaY=event.wheelDelta),"wheelDeltaY"in event&&(deltaY=event.wheelDeltaY),"wheelDeltaX"in event&&(deltaX=event.wheelDeltaX*-1),"axis"in event&&event.axis===event.HORIZONTAL_AXIS&&(deltaX=deltaY*-1,deltaY=0),delta=0===deltaY?deltaX:deltaY,"deltaY"in event&&(deltaY=event.deltaY*-1,delta=deltaY),"deltaX"in event&&(deltaX=event.deltaX,0===deltaY&&(delta=deltaX*-1)),0!==deltaY||0!==deltaX){if(1===event.deltaMode){var lineHeight=$elm.data("mousewheel-line-height");delta*=lineHeight,deltaY*=lineHeight,deltaX*=lineHeight}else if(2===event.deltaMode){var pageHeight=$elm.data("mousewheel-page-height");delta*=pageHeight,deltaY*=pageHeight,deltaX*=pageHeight}absDelta=Math.max(Math.abs(deltaY),Math.abs(deltaX)),(!lowestDelta||absDelta<lowestDelta)&&(lowestDelta=absDelta,shouldAdjustOldDeltas(event,absDelta)&&(lowestDelta/=40)),delta=Math[delta>=1?"floor":"ceil"](delta/lowestDelta),deltaX=Math[deltaX>=1?"floor":"ceil"](deltaX/lowestDelta),deltaY=Math[deltaY>=1?"floor":"ceil"](deltaY/lowestDelta);var newEvent={originalEvent:event,deltaX:deltaX,deltaY:deltaY,deltaFactor:lowestDelta,preventDefault:function(){event.preventDefault()},stopPropagation:function(){event.stopPropagation()}};nullLowestDeltaTimeout&&clearTimeout(nullLowestDeltaTimeout),nullLowestDeltaTimeout=setTimeout(nullLowestDelta,200),fn.call($elm[0],newEvent)}}function nullLowestDelta(){lowestDelta=null}function shouldAdjustOldDeltas(orgEvent,absDelta){return"mousewheel"===orgEvent.type&&absDelta%120===0}var s={augmentWidthOrHeight:augmentWidthOrHeight,getStyles:getStyles,createBoundedWrapper:function(object,method){return function(){return method.apply(object,arguments)}},readableColumnName:function(columnName){return"undefined"==typeof columnName||void 0===columnName||null===columnName?columnName:("string"!=typeof columnName&&(columnName=String(columnName)),columnName.replace(/_+/g," ").replace(/^[A-Z]+$/,function(match){return angular.lowercase(angular.uppercase(match.charAt(0))+match.slice(1))}).replace(/([\w\u00C0-\u017F]+)/g,function(match){return angular.uppercase(match.charAt(0))+match.slice(1)}).replace(/(\w+?(?=[A-Z]))/g,"$1 "))},getColumnsFromData:function(data,excludeProperties){var columnDefs=[];if(!data||"undefined"==typeof data[0]||void 0===data[0])return[];angular.isUndefined(excludeProperties)&&(excludeProperties=[]);var item=data[0];return angular.forEach(item,function(prop,propName){excludeProperties.indexOf(propName)===-1&&columnDefs.push({name:propName})}),columnDefs},newId:function(){var seedId=(new Date).getTime();return function(){return seedId+=1}}(),getTemplate:function(template){if($templateCache.get(template))return s.postProcessTemplate($templateCache.get(template));if(angular.isFunction(template.then))return template.then(s.postProcessTemplate);try{if(angular.element(template).length>0)return $q.when(template).then(s.postProcessTemplate)}catch(err){}return s.logDebug("fetching url",template),$http({method:"GET",url:template}).then(function(result){var templateHtml=result.data.trim();return $templateCache.put(template,templateHtml),templateHtml},function(err){throw new Error("Could not get template "+template+": "+err)}).then(s.postProcessTemplate)},postProcessTemplate:function(template){var startSym=$interpolate.startSymbol(),endSym=$interpolate.endSymbol();return"{{"===startSym&&"}}"===endSym||(template=template.replace(/\{\{/g,startSym),template=template.replace(/\}\}/g,endSym)),$q.when(template)},guessType:function(item){var itemType=typeof item;switch(itemType){case"number":case"boolean":case"string":return itemType;default:return angular.isDate(item)?"date":"object"}},elementWidth:function(elem){},elementHeight:function(elem){},getScrollbarWidth:function(){var outer=document.createElement("div");outer.style.visibility="hidden",outer.style.width="100px",outer.style.msOverflowStyle="scrollbar",document.body.appendChild(outer);var widthNoScroll=outer.offsetWidth;outer.style.overflow="scroll";var inner=document.createElement("div");inner.style.width="100%",outer.appendChild(inner);var widthWithScroll=inner.offsetWidth;return outer.parentNode.removeChild(outer),widthNoScroll-widthWithScroll},swap:function(elem,options,callback,args){var ret,name,old={};for(name in options)old[name]=elem.style[name],elem.style[name]=options[name];ret=callback.apply(elem,args||[]);for(name in options)elem.style[name]=old[name];return ret},fakeElement:function(elem,options,callback,args){var ret,name,newElement=angular.element(elem).clone()[0];for(name in options)newElement.style[name]=options[name];return angular.element(document.body).append(newElement),ret=callback.call(newElement,newElement),angular.element(newElement).remove(),ret},normalizeWheelEvent:function(event){var lowestDelta,lowestDeltaXY,fn,orgEvent=event||window.event,delta=([].slice.call(arguments,1),0),deltaX=0,deltaY=0,absDelta=0,absDeltaXY=0;return orgEvent.originalEvent&&(orgEvent=orgEvent.originalEvent),orgEvent.wheelDelta&&(delta=orgEvent.wheelDelta),orgEvent.detail&&(delta=orgEvent.detail*-1),deltaY=delta,void 0!==orgEvent.axis&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS&&(deltaY=0,deltaX=delta*-1),orgEvent.deltaY&&(deltaY=orgEvent.deltaY*-1,delta=deltaY),orgEvent.deltaX&&(deltaX=orgEvent.deltaX,delta=deltaX*-1),void 0!==orgEvent.wheelDeltaY&&(deltaY=orgEvent.wheelDeltaY),void 0!==orgEvent.wheelDeltaX&&(deltaX=orgEvent.wheelDeltaX),absDelta=Math.abs(delta),(!lowestDelta||absDelta<lowestDelta)&&(lowestDelta=absDelta),absDeltaXY=Math.max(Math.abs(deltaY),Math.abs(deltaX)),(!lowestDeltaXY||absDeltaXY<lowestDeltaXY)&&(lowestDeltaXY=absDeltaXY),fn=delta>0?"floor":"ceil",delta=Math[fn](delta/lowestDelta),deltaX=Math[fn](deltaX/lowestDeltaXY),deltaY=Math[fn](deltaY/lowestDeltaXY),{delta:delta,deltaX:deltaX,deltaY:deltaY}},isTouchEnabled:function(){var bool;return("ontouchstart"in $window||$window.DocumentTouch&&$document instanceof DocumentTouch)&&(bool=!0),
bool},isNullOrUndefined:function(obj){return void 0===obj||null===obj},endsWith:function(str,suffix){return!(!str||!suffix||"string"!=typeof str)&&str.indexOf(suffix,str.length-suffix.length)!==-1},arrayContainsObjectWithProperty:function(array,propertyName,propertyValue){var found=!1;return angular.forEach(array,function(object){object[propertyName]===propertyValue&&(found=!0)}),found},numericAndNullSort:function(a,b){return null===a?1:null===b?-1:null===a&&null===b?0:a-b},disableAnimations:function(element){var $animate;try{$animate=$injector.get("$animate"),angular.version.major>1||1===angular.version.major&&angular.version.minor>=4?$animate.enabled(element,!1):$animate.enabled(!1,element)}catch(e){}},enableAnimations:function(element){var $animate;try{return $animate=$injector.get("$animate"),angular.version.major>1||1===angular.version.major&&angular.version.minor>=4?$animate.enabled(element,!0):$animate.enabled(!0,element),$animate}catch(e){}},nextUid:function(){for(var digit,index=uid.length;index;){if(index--,digit=uid[index].charCodeAt(0),57===digit)return uid[index]="A",uidPrefix+uid.join("");if(90!==digit)return uid[index]=String.fromCharCode(digit+1),uidPrefix+uid.join("");uid[index]="0"}return uid.unshift("0"),uidPrefix+uid.join("")},hashKey:function(obj){var key,objType=typeof obj;return"object"===objType&&null!==obj?"function"==typeof(key=obj.$$hashKey)?key=obj.$$hashKey():"undefined"!=typeof obj.$$hashKey&&obj.$$hashKey?key=obj.$$hashKey:void 0===key&&(key=obj.$$hashKey=s.nextUid()):key=obj,objType+":"+key},resetUids:function(){uid=["0","0","0"]},logError:function(logMessage){uiGridConstants.LOG_ERROR_MESSAGES&&$log.error(logMessage)},logWarn:function(logMessage){uiGridConstants.LOG_WARN_MESSAGES&&$log.warn(logMessage)},logDebug:function(){uiGridConstants.LOG_DEBUG_MESSAGES&&$log.debug.apply($log,arguments)}};s.focus={queue:[],byId:function(id,Grid){this._purgeQueue();var promise=$timeout(function(){var elementID=(Grid&&Grid.id?Grid.id+"-":"")+id,element=$window.document.getElementById(elementID);element?element.focus():s.logWarn("[focus.byId] Element id "+elementID+" was not found.")});return this.queue.push(promise),promise},byElement:function(element){if(!angular.isElement(element))return s.logWarn("Trying to focus on an element that isn't an element."),$q.reject("not-element");element=angular.element(element),this._purgeQueue();var promise=$timeout(function(){element&&element[0].focus()});return this.queue.push(promise),promise},bySelector:function(parentElement,querySelector,aSync){var self=this;if(!angular.isElement(parentElement))throw new Error("The parent element is not an element.");parentElement=angular.element(parentElement);var focusBySelector=function(){var element=parentElement[0].querySelector(querySelector);return self.byElement(element)};if(this._purgeQueue(),aSync){var promise=$timeout(focusBySelector);return this.queue.push($timeout(focusBySelector)),promise}return focusBySelector()},_purgeQueue:function(){this.queue.forEach(function(element){$timeout.cancel(element)}),this.queue=[]}},["width","height"].forEach(function(name){var capsName=angular.uppercase(name.charAt(0))+name.substr(1);s["element"+capsName]=function(elem,extra){var e=elem;if(e&&"undefined"!=typeof e.length&&e.length&&(e=elem[0]),e){var styles=getStyles(e);return 0===e.offsetWidth&&rdisplayswap.test(styles.display)?s.swap(e,cssShow,function(){return getWidthOrHeight(e,name,extra)}):getWidthOrHeight(e,name,extra)}return null},s["outerElement"+capsName]=function(elem,margin){return elem?s["element"+capsName].call(this,elem,margin?"margin":"border"):null}}),s.closestElm=function(el,selector){"undefined"!=typeof el.length&&el.length&&(el=el[0]);var matchesFn;["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector"].some(function(fn){return"function"==typeof document.body[fn]&&(matchesFn=fn,!0)});for(var parent;null!==el;){if(parent=el.parentElement,null!==parent&&parent[matchesFn](selector))return parent;el=parent}return null},s.type=function(obj){var text=Function.prototype.toString.call(obj.constructor);return text.match(/function (.*?)\(/)[1]},s.getBorderSize=function(elem,borderType){"undefined"!=typeof elem.length&&elem.length&&(elem=elem[0]);var styles=getStyles(elem);borderType=borderType?"border"+borderType.charAt(0).toUpperCase()+borderType.slice(1):"border",borderType+="Width";var val=parseInt(styles[borderType],10);return isNaN(val)?0:val},s.detectBrowser=function(){var userAgent=$window.navigator.userAgent,browsers={chrome:/chrome/i,safari:/safari/i,firefox:/firefox/i,ie:/internet explorer|trident\//i};for(var key in browsers)if(browsers[key].test(userAgent))return key;return"unknown"},s.rtlScrollType=function rtlScrollType(){if(rtlScrollType.type)return rtlScrollType.type;var definer=angular.element('<div dir="rtl" style="font-size: 14px; width: 1px; height: 1px; position: absolute; top: -1000px; overflow: scroll">A</div>')[0],type="reverse";return document.body.appendChild(definer),definer.scrollLeft>0?type="default":(definer.scrollLeft=1,0===definer.scrollLeft&&(type="negative")),angular.element(definer).remove(),rtlScrollType.type=type,type},s.normalizeScrollLeft=function(element,grid){"undefined"!=typeof element.length&&element.length&&(element=element[0]);var scrollLeft=element.scrollLeft;if(grid.isRTL())switch(s.rtlScrollType()){case"default":return element.scrollWidth-scrollLeft-element.clientWidth;case"negative":return Math.abs(scrollLeft);case"reverse":return scrollLeft}return scrollLeft},s.denormalizeScrollLeft=function(element,scrollLeft,grid){if("undefined"!=typeof element.length&&element.length&&(element=element[0]),grid.isRTL())switch(s.rtlScrollType()){case"default":var maxScrollLeft=element.scrollWidth-element.clientWidth;return maxScrollLeft-scrollLeft;case"negative":return scrollLeft*-1;case"reverse":return scrollLeft}return scrollLeft},s.preEval=function(path){var m=uiGridConstants.BRACKET_REGEXP.exec(path);if(m)return(m[1]?s.preEval(m[1]):m[1])+m[2]+(m[3]?s.preEval(m[3]):m[3]);path=path.replace(uiGridConstants.APOS_REGEXP,"\\'");var parts=path.split(uiGridConstants.DOT_REGEXP),preparsed=[parts.shift()];return angular.forEach(parts,function(part){preparsed.push(part.replace(uiGridConstants.FUNC_REGEXP,"']$1"))}),preparsed.join("['")},s.debounce=function(func,wait,immediate){function debounce(){context=this,args=arguments;var later=function(){timeout=null,immediate||(result=func.apply(context,args))},callNow=immediate&&!timeout;return timeout&&$timeout.cancel(timeout),timeout=$timeout(later,wait,!1),callNow&&(result=func.apply(context,args)),result}var timeout,args,context,result;return debounce.cancel=function(){$timeout.cancel(timeout),timeout=null},debounce},s.throttle=function(func,wait,options){function runFunc(endDate){lastCall=+new Date,func.apply(context,args),$interval(function(){queued=null},0,1,!1)}options=options||{};var context,args,lastCall=0,queued=null;return function(){if(context=this,args=arguments,null===queued){var sinceLast=+new Date-lastCall;sinceLast>wait?runFunc():options.trailing&&(queued=$interval(runFunc,wait-sinceLast,1,!1))}}},s.on={},s.off={},s._events={},s.addOff=function(eventName){s.off[eventName]=function(elm,fn){var idx=s._events[eventName].indexOf(fn);idx>0&&s._events[eventName].removeAt(idx)}};var nullLowestDeltaTimeout,lowestDelta,mouseWheeltoBind="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"];return s.on.mousewheel=function(elm,fn){if(elm&&fn){var $elm=angular.element(elm);$elm.data("mousewheel-line-height",getLineHeight($elm)),$elm.data("mousewheel-page-height",s.elementHeight($elm)),$elm.data("mousewheel-callbacks")||$elm.data("mousewheel-callbacks",{});var cbs=$elm.data("mousewheel-callbacks");cbs[fn]=(Function.prototype.bind||bindPolyfill).call(mousewheelHandler,$elm[0],fn);for(var i=mouseWheeltoBind.length;i;)$elm.on(mouseWheeltoBind[--i],cbs[fn])}},s.off.mousewheel=function(elm,fn){var $elm=angular.element(elm),cbs=$elm.data("mousewheel-callbacks"),handler=cbs[fn];if(handler)for(var i=mouseWheeltoBind.length;i;)$elm.off(mouseWheeltoBind[--i],handler);delete cbs[fn],0===Object.keys(cbs).length&&($elm.removeData("mousewheel-line-height"),$elm.removeData("mousewheel-page-height"),$elm.removeData("mousewheel-callbacks"))},s}]),module.filter("px",function(){return function(str){return str.match(/^[\d\.]+$/)?str+"px":str}})}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){var lang={aggregate:{label:"poloky"},groupPanel:{description:"Pesute zhlav zde pro vytvoen skupiny dle sloupce."},search:{placeholder:"Hledat...",showingItems:"Zobrazuji poloky:",selectedItems:"Vybran poloky:",totalItems:"Celkem poloek:",size:"Velikost strany:",first:"Prvn strana",next:"Dal strana",previous:"Pedchoz strana",last:"Posledn strana"},menu:{text:"Vyberte sloupec:"},sort:{ascending:"Seadit od A-Z",descending:"Seadit od Z-A",remove:"Odebrat seazen"},column:{hide:"Schovat sloupec"},aggregation:{count:"celkem dk: ",sum:"celkem: ",avg:"avg: ",min:"min.: ",max:"max.: "},pinning:{pinLeft:"Zamknout vlevo",pinRight:"Zamknout vpravo",unpin:"Odemknout"},gridMenu:{columns:"Sloupce:",importerTitle:"Importovat soubor",exporterAllAsCsv:"Exportovat vechna data do csv",exporterVisibleAsCsv:"Exportovat viditeln data do csv",exporterSelectedAsCsv:"Exportovat vybran data do csv",exporterAllAsPdf:"Exportovat vechna data do pdf",exporterVisibleAsPdf:"Exportovat viditeln data do pdf",exporterSelectedAsPdf:"Exportovat vybran data do pdf",clearAllFilters:"Odstranit vechny filtry"},importer:{noHeaders:"Nzvy sloupc se nepodailo zskat, obsahuje soubor zhlav?",noObjects:"Data se nepodailo zpracovat, obsahuje soubor dky mimo zhlav?",invalidCsv:"Soubor nelze zpracovat, jedn se o CSV?",invalidJson:"Soubor nelze zpracovat, je to JSON?",jsonNotArray:"Soubor mus obsahovat json. Ukonuji.."},pagination:{sizes:"poloek na strnku",totalItems:"poloek"},grouping:{group:"Seskupit",ungroup:"Odebrat seskupen",aggregate_count:"Agregace: Count",aggregate_sum:"Agregace: Sum",aggregate_max:"Agregace: Max",aggregate_min:"Agregace: Min",aggregate_avg:"Agregace: Avg",aggregate_remove:"Agregace: Odebrat"}};return $delegate.add("cs",lang),$delegate.add("cz",lang),$delegate.add("cs-cz",lang),$delegate.add("cs-CZ",lang),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("da",{aggregate:{label:"artikler"},groupPanel:{description:"Grupr rkker udfra en kolonne ved at trkke dens overskift hertil."},search:{placeholder:"Sg...",showingItems:"Viste rkker:",selectedItems:"Valgte rkker:",totalItems:"Rkker totalt:",size:"Side strrelse:",first:"Frste side",next:"Nste side",previous:"Forrige side",last:"Sidste side"},menu:{text:"Vlg kolonner:"},sort:{ascending:"Sorter stigende",descending:"Sorter faldende",none:"Sorter ingen",remove:"Fjern sortering"},column:{hide:"Skjul kolonne"},aggregation:{count:"antal rkker: ",sum:"sum: ",avg:"gns: ",min:"min: ",max:"max: "},gridMenu:{columns:"Kolonner:",importerTitle:"Importer fil",exporterAllAsCsv:"Eksporter alle data som csv",exporterVisibleAsCsv:"Eksporter synlige data som csv",exporterSelectedAsCsv:"Eksporter markerede data som csv",exporterAllAsPdf:"Eksporter alle data som pdf",exporterVisibleAsPdf:"Eksporter synlige data som pdf",exporterSelectedAsPdf:"Eksporter markerede data som pdf",clearAllFilters:"Clear all filters"},importer:{noHeaders:"Column names were unable to be derived, does the file have a header?",noObjects:"Objects were not able to be derived, was there data in the file other than headers?",invalidCsv:"File was unable to be processed, is it valid CSV?",invalidJson:"File was unable to be processed, is it valid Json?",jsonNotArray:"Imported json file must contain an array, aborting."},pagination:{aria:{pageToFirst:"G til frste",pageBack:"G tilbage",pageSelected:"Valgte side",pageForward:"G frem",pageToLast:"G til sidste"},sizes:"genstande per side",totalItems:"genstande",through:"gennem",of:"af"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("de",{headerCell:{aria:{defaultFilterLabel:"Filter fr Spalte",removeFilter:"Filter lschen",columnMenuButtonLabel:"Spaltenmen"},priority:"Prioritt:",filterLabel:"Filter fr Spalte: "},aggregate:{label:"Eintrag"},groupPanel:{description:"Ziehen Sie eine Spaltenberschrift hierhin, um nach dieser Spalte zu gruppieren."},search:{placeholder:"Suche...",showingItems:"Zeige Eintrge:",selectedItems:"Ausgewhlte Eintrge:",totalItems:"Eintrge gesamt:",size:"Eintrge pro Seite:",first:"Erste Seite",next:"Nchste Seite",previous:"Vorherige Seite",last:"Letzte Seite"},menu:{text:"Spalten auswhlen:"},sort:{ascending:"aufsteigend sortieren",descending:"absteigend sortieren",none:"keine Sortierung",remove:"Sortierung zurcksetzen"},column:{hide:"Spalte ausblenden"},aggregation:{count:"Zeilen insgesamt: ",sum:"gesamt: ",avg:"Durchschnitt: ",min:"min: ",max:"max: "},pinning:{pinLeft:"Links anheften",pinRight:"Rechts anheften",unpin:"Lsen"},columnMenu:{close:"Schlieen"},gridMenu:{aria:{buttonLabel:"Tabellenmen"},columns:"Spalten:",importerTitle:"Datei importieren",exporterAllAsCsv:"Alle Daten als CSV exportieren",exporterVisibleAsCsv:"sichtbare Daten als CSV exportieren",exporterSelectedAsCsv:"markierte Daten als CSV exportieren",exporterAllAsPdf:"Alle Daten als PDF exportieren",exporterVisibleAsPdf:"sichtbare Daten als PDF exportieren",exporterSelectedAsPdf:"markierte Daten als PDF exportieren",clearAllFilters:"Alle Filter zurcksetzen"},importer:{noHeaders:"Es konnten keine Spaltennamen ermittelt werden. Sind in der Datei Spaltendefinitionen enthalten?",noObjects:"Es konnten keine Zeileninformationen gelesen werden, Sind in der Datei auer den Spaltendefinitionen auch Daten enthalten?",invalidCsv:"Die Datei konnte nicht eingelesen werden, ist es eine gltige CSV-Datei?",invalidJson:"Die Datei konnte nicht eingelesen werden. Enthlt sie gltiges JSON?",jsonNotArray:"Die importierte JSON-Datei mu ein Array enthalten. Breche Import ab."},pagination:{aria:{pageToFirst:"Zum Anfang",pageBack:"Seite zurck",pageSelected:"Ausgwhlte Seite",pageForward:"Seite vor",pageToLast:"Zum Ende"},sizes:"Eintrge pro Seite",totalItems:"Eintrge",through:"bis",of:"von"},grouping:{group:"Gruppieren",ungroup:"Gruppierung aufheben",aggregate_count:"Agg: Anzahl",aggregate_sum:"Agg: Summe",aggregate_max:"Agg: Maximum",aggregate_min:"Agg: Minimum",aggregate_avg:"Agg: Mittelwert",aggregate_remove:"Aggregation entfernen"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("en",{headerCell:{aria:{defaultFilterLabel:"Filter for column",removeFilter:"Remove Filter",columnMenuButtonLabel:"Column Menu"},priority:"Priority:",filterLabel:"Filter for column: "},aggregate:{label:"items"},groupPanel:{description:"Drag a column header here and drop it to group by that column."},search:{placeholder:"Search...",showingItems:"Showing Items:",selectedItems:"Selected Items:",totalItems:"Total Items:",size:"Page Size:",first:"First Page",next:"Next Page",previous:"Previous Page",last:"Last Page"},menu:{text:"Choose Columns:"},sort:{ascending:"Sort Ascending",descending:"Sort Descending",none:"Sort None",remove:"Remove Sort"},column:{hide:"Hide Column"},aggregation:{count:"total rows: ",sum:"total: ",avg:"avg: ",min:"min: ",max:"max: "},pinning:{pinLeft:"Pin Left",pinRight:"Pin Right",unpin:"Unpin"},columnMenu:{close:"Close"},gridMenu:{aria:{buttonLabel:"Grid Menu"},columns:"Columns:",importerTitle:"Import file",exporterAllAsCsv:"Export all data as csv",exporterVisibleAsCsv:"Export visible data as csv",exporterSelectedAsCsv:"Export selected data as csv",exporterAllAsPdf:"Export all data as pdf",exporterVisibleAsPdf:"Export visible data as pdf",exporterSelectedAsPdf:"Export selected data as pdf",clearAllFilters:"Clear all filters"},importer:{noHeaders:"Column names were unable to be derived, does the file have a header?",noObjects:"Objects were not able to be derived, was there data in the file other than headers?",invalidCsv:"File was unable to be processed, is it valid CSV?",invalidJson:"File was unable to be processed, is it valid Json?",jsonNotArray:"Imported json file must contain an array, aborting."},pagination:{aria:{pageToFirst:"Page to first",pageBack:"Page back",pageSelected:"Selected page",pageForward:"Page forward",pageToLast:"Page to last"},sizes:"items per page",totalItems:"items",through:"through",of:"of"},grouping:{group:"Group",ungroup:"Ungroup",aggregate_count:"Agg: Count",aggregate_sum:"Agg: Sum",aggregate_max:"Agg: Max",aggregate_min:"Agg: Min",aggregate_avg:"Agg: Avg",aggregate_remove:"Agg: Remove"},validate:{error:"Error:",minLength:"Value should be at least THRESHOLD characters long.",maxLength:"Value should be at most THRESHOLD characters long.",required:"A value is needed."}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("es",{aggregate:{label:"Artculos"},groupPanel:{description:"Arrastre un encabezado de columna aqu y sultelo para agrupar por esa columna."},search:{placeholder:"Buscar...",showingItems:"Artculos Mostrados:",selectedItems:"Artculos Seleccionados:",totalItems:"Artculos Totales:",size:"Tamao de Pgina:",first:"Primera Pgina",next:"Pgina Siguiente",previous:"Pgina Anterior",last:"ltima Pgina"},menu:{text:"Elegir columnas:"},sort:{ascending:"Orden Ascendente",descending:"Orden Descendente",remove:"Sin Ordenar"},column:{hide:"Ocultar la columna"},aggregation:{count:"filas totales: ",sum:"total: ",avg:"media: ",min:"min: ",max:"max: "},pinning:{pinLeft:"Fijar a la Izquierda",pinRight:"Fijar a la Derecha",unpin:"Quitar Fijacin"},gridMenu:{columns:"Columnas:",importerTitle:"Importar archivo",exporterAllAsCsv:"Exportar todo como csv",exporterVisibleAsCsv:"Exportar vista como csv",exporterSelectedAsCsv:"Exportar seleccin como csv",exporterAllAsPdf:"Exportar todo como pdf",exporterVisibleAsPdf:"Exportar vista como pdf",exporterSelectedAsPdf:"Exportar seleccin como pdf",clearAllFilters:"Limpiar todos los filtros"},importer:{noHeaders:"No fue posible derivar los nombres de las columnas, tiene encabezados el archivo?",noObjects:"No fue posible obtener registros, contiene datos el archivo, aparte de los encabezados?",invalidCsv:"No fue posible procesar el archivo, es un CSV vlido?",invalidJson:"No fue posible procesar el archivo, es un Json vlido?",jsonNotArray:"El archivo json importado debe contener un array, abortando."},pagination:{sizes:"registros por pgina",totalItems:"registros",of:"de"},grouping:{group:"Agrupar",ungroup:"Desagrupar",aggregate_count:"Agr: Cont",aggregate_sum:"Agr: Sum",aggregate_max:"Agr: Mx",aggregate_min:"Agr: Min",aggregate_avg:"Agr: Prom",aggregate_remove:"Agr: Quitar"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("fa",{aggregate:{label:""},groupPanel:{description:"            ."},search:{placeholder:"...",showingItems:" :",selectedItems:"  :",totalItems:" :",size:" :",first:" ",next:"",previous:" ",last:" "},menu:{text:" :"},sort:{ascending:" ",descending:" ",remove:"  "},column:{hide:" "},aggregation:{count:": ",sum:": ",avg:": ",min:": ",max:": "},pinning:{pinLeft:"   ",pinRight:"   ",unpin:" "},gridMenu:{columns:":",importerTitle:"  ",exporterAllAsCsv:"     csv",exporterVisibleAsCsv:"      csv",exporterSelectedAsCsv:"     csv",exporterAllAsPdf:"     pdf",exporterVisibleAsPdf:"      pdf",exporterSelectedAsPdf:"     pdf",clearAllFilters:"   "},importer:{noHeaders:"    .    ",noObjects:"   .         ",invalidCsv:"   .    csv   ",invalidJson:"   .   json    ",jsonNotArray:" json      .   ."},pagination:{sizes:"   ",totalItems:"",of:""},grouping:{group:"",ungroup:" ",aggregate_count:"Agg: ",aggregate_sum:"Agg: ",aggregate_max:"Agg: ",aggregate_min:"Agg: ",aggregate_avg:"Agg: ",aggregate_remove:"Agg: "}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("fi",{aggregate:{label:"rivit"},groupPanel:{description:"Raahaa ja pudota otsikko thn ryhmittksesi sarakkeen mukaan."},search:{placeholder:"Hae...",showingItems:"Nytetn rivej:",selectedItems:"Valitut rivit:",totalItems:"Rivej yht.:",size:"Nyt:",first:"Ensimminen sivu",next:"Seuraava sivu",previous:"Edellinen sivu",last:"Viimeinen sivu"},menu:{text:"Valitse sarakkeet:"},sort:{ascending:"Jrjest nouseva",descending:"Jrjest laskeva",remove:"Poista jrjestys"},column:{hide:"Piilota sarake"},aggregation:{count:"Rivej yht.: ",sum:"Summa: ",avg:"K.a.: ",min:"Min: ",max:"Max: "},pinning:{pinLeft:"Lukitse vasemmalle",pinRight:"Lukitse oikealle",unpin:"Poista lukitus"},gridMenu:{columns:"Sarakkeet:",importerTitle:"Tuo tiedosto",exporterAllAsCsv:"Vie tiedot csv-muodossa",exporterVisibleAsCsv:"Vie nkyv tieto csv-muodossa",exporterSelectedAsCsv:"Vie valittu tieto csv-muodossa",exporterAllAsPdf:"Vie tiedot pdf-muodossa",exporterVisibleAsPdf:"Vie nkyv tieto pdf-muodossa",exporterSelectedAsPdf:"Vie valittu tieto pdf-muodossa",clearAllFilters:"Puhdista kaikki suodattimet"},importer:{noHeaders:"Sarakkeen nimi ei voitu ptell, onko tiedostossa otsikkorivi?",noObjects:"Tietoja ei voitu lukea, onko tiedostossa muuta kuin otsikkot?",invalidCsv:"Tiedostoa ei voitu ksitell, oliko se CSV-muodossa?",invalidJson:"Tiedostoa ei voitu ksitell, oliko se JSON-muodossa?",jsonNotArray:"Tiedosto ei sisltnyt taulukkoa, lopetetaan."}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("fr",{headerCell:{aria:{defaultFilterLabel:"Filtre de la colonne",removeFilter:"Supprimer le filtre",columnMenuButtonLabel:"Menu de la colonne"},priority:"Priorit:",filterLabel:"Filtre de la colonne: "},aggregate:{label:"lments"},groupPanel:{description:"Faites glisser une en-tte de colonne ici pour crer un groupe de colonnes."},search:{placeholder:"Recherche...",showingItems:"Affichage des lments :",selectedItems:"lments slectionns :",totalItems:"Nombre total d'lments:",size:"Taille de page:",first:"Premire page",next:"Page Suivante",previous:"Page prcdente",last:"Dernire page"},menu:{text:"Choisir des colonnes :"},sort:{ascending:"Trier par ordre croissant",descending:"Trier par ordre dcroissant",none:"Aucun tri",remove:"Enlever le tri"},column:{hide:"Cacher la colonne"},aggregation:{count:"lignes totales: ",sum:"total: ",avg:"moy: ",min:"min: ",max:"max: "},pinning:{pinLeft:"pingler  gauche",pinRight:"pingler  droite",unpin:"Dtacher"},columnMenu:{close:"Fermer"},gridMenu:{aria:{buttonLabel:"Menu du tableau"},columns:"Colonnes:",importerTitle:"Importer un fichier",exporterAllAsCsv:"Exporter toutes les donnes en CSV",exporterVisibleAsCsv:"Exporter les donnes visibles en CSV",exporterSelectedAsCsv:"Exporter les donnes slectionnes en CSV",exporterAllAsPdf:"Exporter toutes les donnes en PDF",exporterVisibleAsPdf:"Exporter les donnes visibles en PDF",exporterSelectedAsPdf:"Exporter les donnes slectionnes en PDF",clearAllFilters:"Nettoyez tous les filtres"},importer:{noHeaders:"Impossible de dterminer le nom des colonnes, le fichier possde-t-il une en-tte ?",noObjects:"Aucun objet trouv, le fichier possde-t-il des donnes autres que l'en-tte ?",invalidCsv:"Le fichier n'a pas pu tre trait, le CSV est-il valide ?",invalidJson:"Le fichier n'a pas pu tre trait, le JSON est-il valide ?",jsonNotArray:"Le fichier JSON import doit contenir un tableau, abandon."},pagination:{aria:{pageToFirst:"Aller  la premire page",pageBack:"Page prcdente",pageSelected:"Page slectionne",pageForward:"Page suivante",pageToLast:"Aller  la dernire page"},sizes:"lments par page",totalItems:"lments",through:"",of:"sur"},grouping:{group:"Grouper",ungroup:"Dgrouper",aggregate_count:"Agg: Compter",aggregate_sum:"Agg: Somme",aggregate_max:"Agg: Max",aggregate_min:"Agg: Min",aggregate_avg:"Agg: Moy",aggregate_remove:"Agg: Retirer"},validate:{error:"Erreur:",minLength:"La valeur doit tre suprieure ou gale  THRESHOLD caractres.",maxLength:"La valeur doit tre infrieure ou gale  THRESHOLD caractres.",required:"Une valeur est ncssaire."}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("he",{aggregate:{label:"items"},groupPanel:{description:"       ."},search:{placeholder:"...",showingItems:":",selectedItems:'" :',totalItems:'" :',size:" :",first:" ",next:" ",previous:" ",last:" "},menu:{text:" :"},sort:{ascending:" ",descending:" ",remove:""},column:{hide:" "},aggregation:{count:"total rows: ",sum:"total: ",avg:"avg: ",min:"min: ",max:"max: "},gridMenu:{columns:"Columns:",importerTitle:"Import file",exporterAllAsCsv:"Export all data as csv",exporterVisibleAsCsv:"Export visible data as csv",exporterSelectedAsCsv:"Export selected data as csv",exporterAllAsPdf:"Export all data as pdf",exporterVisibleAsPdf:"Export visible data as pdf",exporterSelectedAsPdf:"Export selected data as pdf",clearAllFilters:"Clean all filters"},importer:{noHeaders:"Column names were unable to be derived, does the file have a header?",noObjects:"Objects were not able to be derived, was there data in the file other than headers?",invalidCsv:"File was unable to be processed, is it valid CSV?",invalidJson:"File was unable to be processed, is it valid Json?",jsonNotArray:"Imported json file must contain an array, aborting."}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("hy",{aggregate:{label:""},groupPanel:{description:"        "},search:{placeholder:"...",showingItems:" ",selectedItems:":",totalItems:"",size:"  ",first:" ",next:" ",previous:" ",last:" "},menu:{text:" :"},sort:{ascending:" ",descending:" ",remove:" "},column:{hide:" "},aggregation:{count:"  ",sum:" ",avg:" ",min:" ",max:" "},pinning:{pinLeft:"  ",pinRight:"  ",unpin:""},gridMenu:{columns:":",importerTitle:" ",exporterAllAsCsv:"  CSV",exporterVisibleAsCsv:"   CSV",exporterSelectedAsCsv:"   CSV",exporterAllAsPdf:" PDF",exporterVisibleAsPdf:"   PDF",exporterSelectedAsPdf:"   PDF",clearAllFilters:"  "},importer:{noHeaders:"        ",noObjects:"       ",invalidCsv:"       CSV ",invalidJson:"       Json ",jsonNotArray:" json     ,  "}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("it",{aggregate:{label:"elementi"},groupPanel:{description:"Trascina un'intestazione all'interno del gruppo della colonna."},search:{placeholder:"Ricerca...",showingItems:"Mostra:",selectedItems:"Selezionati:",totalItems:"Totali:",size:"Tot Pagine:",first:"Prima",next:"Prossima",previous:"Precedente",last:"Ultima"},menu:{text:"Scegli le colonne:"},sort:{ascending:"Asc.",descending:"Desc.",remove:"Annulla ordinamento"},column:{hide:"Nascondi"},aggregation:{count:"righe totali: ",sum:"tot: ",avg:"media: ",min:"minimo: ",max:"massimo: "},pinning:{pinLeft:"Blocca a sx",pinRight:"Blocca a dx",unpin:"Blocca in alto"},gridMenu:{columns:"Colonne:",importerTitle:"Importa",exporterAllAsCsv:"Esporta tutti i dati in CSV",exporterVisibleAsCsv:"Esporta i dati visibili in CSV",exporterSelectedAsCsv:"Esporta i dati selezionati in CSV",exporterAllAsPdf:"Esporta tutti i dati in PDF",exporterVisibleAsPdf:"Esporta i dati visibili in PDF",exporterSelectedAsPdf:"Esporta i dati selezionati in PDF",clearAllFilters:"Pulire tutti i filtri"},importer:{noHeaders:"Impossibile reperire i nomi delle colonne, sicuro che siano indicati all'interno del file?",noObjects:"Impossibile reperire gli oggetti, sicuro che siano indicati all'interno del file?",invalidCsv:"Impossibile elaborare il file, sicuro che sia un CSV?",invalidJson:"Impossibile elaborare il file, sicuro che sia un JSON valido?",jsonNotArray:"Errore! Il file JSON da importare deve contenere un array."},pagination:{aria:{pageToFirst:"Prima",pageBack:"Indietro",pageSelected:"Pagina selezionata",pageForward:"Avanti",pageToLast:"Ultima"},sizes:"elementi per pagina",totalItems:"elementi",through:"a",of:"di"},grouping:{group:"Raggruppa",ungroup:"Separa",aggregate_count:"Agg: N. Elem.",aggregate_sum:"Agg: Somma",aggregate_max:"Agg: Massimo",aggregate_min:"Agg: Minimo",aggregate_avg:"Agg: Media",aggregate_remove:"Agg: Rimuovi"},validate:{error:"Errore:",minLength:"Lunghezza minima pari a THRESHOLD caratteri.",maxLength:"Lunghezza massima pari a THRESHOLD caratteri.",required:"Necessario inserire un valore."}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("ja",{aggregate:{label:""},groupPanel:{description:""},search:{placeholder:"...",showingItems:":",selectedItems:":",totalItems:":",size:":",first:"",next:"",previous:"",last:""},menu:{text:":"},sort:{ascending:"",descending:"",remove:""},column:{hide:""},aggregation:{count:": ",sum:": ",avg:": ",min:": ",max:": "},pinning:{pinLeft:"",pinRight:"",unpin:""},gridMenu:{columns:":",importerTitle:"",exporterAllAsCsv:"CSV",exporterVisibleAsCsv:"CSV",exporterSelectedAsCsv:"CSV",exporterAllAsPdf:"PDF",exporterVisibleAsPdf:"PDF",exporterSelectedAsPdf:"PDF",clearAllFilters:""},importer:{noHeaders:"",
noObjects:"",invalidCsv:"CSV",invalidJson:"JSON",jsonNotArray:"JSON"},pagination:{aria:{pageToFirst:"",pageBack:"",pageSelected:"",pageForward:"",pageToLast:""},sizes:"/",totalItems:"",through:"",of:"/"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("ko",{aggregate:{label:""},groupPanel:{description:"       ."},search:{placeholder:"...",showingItems:" :",selectedItems:" :",totalItems:" :",size:" :",first:" ",next:" ",previous:" ",last:" "},menu:{text:" :"},sort:{ascending:" ",descending:" ",remove:" "},column:{hide:" "},aggregation:{count:" : ",sum:": ",avg:": ",min:": ",max:": "},pinning:{pinLeft:" ",pinRight:" ",unpin:" "},gridMenu:{columns:":",importerTitle:" ",exporterAllAsCsv:"csv   ",exporterVisibleAsCsv:"csv   ",exporterSelectedAsCsv:"csv   ",exporterAllAsPdf:"pdf   ",exporterVisibleAsPdf:"pdf   ",exporterSelectedAsPdf:"pdf   ",clearAllFilters:"  "},importer:{noHeaders:"   .      .",noObjects:"   .     .",invalidCsv:"   .  csv  .",invalidJson:"   .  json  .",jsonNotArray:"json    ."},pagination:{sizes:" ",totalItems:" "}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("nl",{aggregate:{label:"items"},groupPanel:{description:"Sleep hier een kolomnaam heen om op te groeperen."},search:{placeholder:"Zoeken...",showingItems:"Getoonde items:",selectedItems:"Geselecteerde items:",totalItems:"Totaal aantal items:",size:"Items per pagina:",first:"Eerste pagina",next:"Volgende pagina",previous:"Vorige pagina",last:"Laatste pagina"},menu:{text:"Kies kolommen:"},sort:{ascending:"Sorteer oplopend",descending:"Sorteer aflopend",remove:"Verwijder sortering"},column:{hide:"Verberg kolom"},aggregation:{count:"Aantal rijen: ",sum:"Som: ",avg:"Gemiddelde: ",min:"Min: ",max:"Max: "},pinning:{pinLeft:"Zet links vast",pinRight:"Zet rechts vast",unpin:"Maak los"},gridMenu:{columns:"Kolommen:",importerTitle:"Importeer bestand",exporterAllAsCsv:"Exporteer alle data als csv",exporterVisibleAsCsv:"Exporteer zichtbare data als csv",exporterSelectedAsCsv:"Exporteer geselecteerde data als csv",exporterAllAsPdf:"Exporteer alle data als pdf",exporterVisibleAsPdf:"Exporteer zichtbare data als pdf",exporterSelectedAsPdf:"Exporteer geselecteerde data als pdf",clearAllFilters:"Reinig alle filters"},importer:{noHeaders:"Kolomnamen kunnen niet worden afgeleid. Heeft het bestand een header?",noObjects:"Objecten kunnen niet worden afgeleid. Bevat het bestand data naast de headers?",invalidCsv:"Het bestand kan niet verwerkt worden. Is het een valide csv bestand?",invalidJson:"Het bestand kan niet verwerkt worden. Is het valide json?",jsonNotArray:"Het json bestand moet een array bevatten. De actie wordt geannuleerd."},pagination:{sizes:"items per pagina",totalItems:"items",of:"van de"},grouping:{group:"Groepeer",ungroup:"Groepering opheffen",aggregate_count:"Agg: Aantal",aggregate_sum:"Agg: Som",aggregate_max:"Agg: Max",aggregate_min:"Agg: Min",aggregate_avg:"Agg: Gem",aggregate_remove:"Agg: Verwijder"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("no",{headerCell:{aria:{defaultFilterLabel:"Filter for column",removeFilter:"Remove Filter",columnMenuButtonLabel:"Column Menu"},priority:"Priority:",filterLabel:"Filter for column: "},aggregate:{label:"items"},groupPanel:{description:"Drag a column header here and drop it to group by that column."},search:{placeholder:"Search...",showingItems:"Showing Items:",selectedItems:"Selected Items:",totalItems:"Total Items:",size:"Page Size:",first:"First Page",next:"Next Page",previous:"Previous Page",last:"Last Page"},menu:{text:"Choose Columns:"},sort:{ascending:"Sort Ascending",descending:"Sort Descending",none:"Sort None",remove:"Remove Sort"},column:{hide:"Hide Column"},aggregation:{count:"total rows: ",sum:"total: ",avg:"avg: ",min:"min: ",max:"max: "},pinning:{pinLeft:"Pin Left",pinRight:"Pin Right",unpin:"Unpin"},columnMenu:{close:"Close"},gridMenu:{aria:{buttonLabel:"Grid Menu"},columns:"Kolonner:",importerTitle:"Importer fil",exporterAllAsCsv:"Eksporter alle data som csv",exporterVisibleAsCsv:"Eksporter synlige data som csv",exporterSelectedAsCsv:"Eksporter utvalgte data som csv",exporterAllAsPdf:"Eksporter alle data som pdf",exporterVisibleAsPdf:"Eksporter synlige data som pdf",exporterSelectedAsPdf:"Eksporter utvalgte data som pdf",clearAllFilters:"Clear all filters"},importer:{noHeaders:"Column names were unable to be derived, does the file have a header?",noObjects:"Objects were not able to be derived, was there data in the file other than headers?",invalidCsv:"File was unable to be processed, is it valid CSV?",invalidJson:"File was unable to be processed, is it valid Json?",jsonNotArray:"Imported json file must contain an array, aborting."},pagination:{aria:{pageToFirst:"Page to first",pageBack:"Page back",pageSelected:"Selected page",pageForward:"Page forward",pageToLast:"Page to last"},sizes:"items per page",totalItems:"items",through:"through",of:"of"},grouping:{group:"Group",ungroup:"Ungroup",aggregate_count:"Agg: Count",aggregate_sum:"Agg: Sum",aggregate_max:"Agg: Max",aggregate_min:"Agg: Min",aggregate_avg:"Agg: Avg",aggregate_remove:"Agg: Remove"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("pl",{headerCell:{aria:{defaultFilterLabel:"Filter dla kolumny",removeFilter:"Usu filter",columnMenuButtonLabel:"Menu kolumny"},priority:"Prioritet:",filterLabel:"Filtr dla kolumny: "},aggregate:{label:"pozycji"},groupPanel:{description:"Przecignij nagwek kolumny tutaj, aby pogrupowa wedug niej."},search:{placeholder:"Szukaj...",showingItems:"Widoczne pozycje:",selectedItems:"Zaznaczone pozycje:",totalItems:"Wszystkich pozycji:",size:"Rozmiar strony:",first:"Pierwsza strona",next:"Nastpna strona",previous:"Poprzednia strona",last:"Ostatnia strona"},menu:{text:"Wybierz kolumny:"},sort:{ascending:"Sortuj rosnco",descending:"Sortuj malejco",none:"Brak sortowania",remove:"Wycz sortowanie"},column:{hide:"Ukryj kolumne"},aggregation:{count:"Razem pozycji: ",sum:"Razem: ",avg:"rednia: ",min:"Min: ",max:"Max: "},pinning:{pinLeft:"Przypnij do lewej",pinRight:"Przypnij do prawej",unpin:"Odepnij"},columnMenu:{close:"Zamknij"},gridMenu:{aria:{buttonLabel:"Menu Grida"},columns:"Kolumny:",importerTitle:"Importuj plik",exporterAllAsCsv:"Eksportuj wszystkie dane do csv",exporterVisibleAsCsv:"Eksportuj widoczne dane do csv",exporterSelectedAsCsv:"Eksportuj zaznaczone dane do csv",exporterAllAsPdf:"Eksportuj wszystkie dane do pdf",exporterVisibleAsPdf:"Eksportuj widoczne dane do pdf",exporterSelectedAsPdf:"Eksportuj zaznaczone dane do pdf",clearAllFilters:"Wyczy filtry"},importer:{noHeaders:"Nie udao si wczyta nazw kolumn. Czy plik posiada nagwek?",noObjects:"Nie udalo si wczyta pozycji. Czy plik zawiera dane??",invalidCsv:"Nie udao si przetworzy pliku, jest to prawidlowy plik CSV??",invalidJson:"Nie udao si przetworzy pliku, jest to prawidlowy plik Json?",jsonNotArray:"Importowany plik json musi zawiera tablic, importowanie przerwane."},pagination:{aria:{pageToFirst:"Pierwsza strona",pageBack:"Poprzednia strona",pageSelected:"Wybrana strona",pageForward:"Nastpna strona",pageToLast:"Ostatnia strona"},sizes:"pozycji na stron",totalItems:"pozycji",through:"do",of:"z"},grouping:{group:"Grupuj",ungroup:"Rozgrupuj",aggregate_count:"Zbiorczo: Razem",aggregate_sum:"Zbiorczo: Suma",aggregate_max:"Zbiorczo: Max",aggregate_min:"Zbiorczo: Min",aggregate_avg:"Zbiorczo: rednia",aggregate_remove:"Zbiorczo: Usu"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("pt-br",{headerCell:{aria:{defaultFilterLabel:"Filtro por coluna",removeFilter:"Remover filtro",columnMenuButtonLabel:"Menu coluna"},priority:"Prioridade:",filterLabel:"Filtro por coluna: "},aggregate:{label:"itens"},groupPanel:{description:"Arraste e solte uma coluna aqui para agrupar por essa coluna"},search:{placeholder:"Procurar...",showingItems:"Mostrando os Itens:",selectedItems:"Items Selecionados:",totalItems:"Total de Itens:",size:"Tamanho da Pgina:",first:"Primeira Pgina",next:"Prxima Pgina",previous:"Pgina Anterior",last:"ltima Pgina"},menu:{text:"Selecione as colunas:"},sort:{ascending:"Ordenar Ascendente",descending:"Ordenar Descendente",none:"Nenhuma Ordem",remove:"Remover Ordenao"},column:{hide:"Esconder coluna"},aggregation:{count:"total de linhas: ",sum:"total: ",avg:"med: ",min:"min: ",max:"max: "},pinning:{pinLeft:"Fixar Esquerda",pinRight:"Fixar Direita",unpin:"Desprender"},columnMenu:{close:"Fechar"},gridMenu:{aria:{buttonLabel:"Menu Grid"},columns:"Colunas:",importerTitle:"Importar arquivo",exporterAllAsCsv:"Exportar todos os dados como csv",exporterVisibleAsCsv:"Exportar dados visveis como csv",exporterSelectedAsCsv:"Exportar dados selecionados como csv",exporterAllAsPdf:"Exportar todos os dados como pdf",exporterVisibleAsPdf:"Exportar dados visveis como pdf",exporterSelectedAsPdf:"Exportar dados selecionados como pdf",clearAllFilters:"Limpar todos os filtros"},importer:{noHeaders:"Nomes de colunas no puderam ser derivados. O arquivo tem um cabealho?",noObjects:"Objetos no puderam ser derivados. Havia dados no arquivo, alm dos cabealhos?",invalidCsv:"Arquivo no pode ser processado.  um CSV vlido?",invalidJson:"Arquivo no pode ser processado.  um Json vlido?",jsonNotArray:"Arquivo json importado tem que conter um array. Abortando."},pagination:{aria:{pageToFirst:"Primeira pgina",pageBack:"Pgina anterior",pageSelected:"Pgina Selecionada",pageForward:"Proxima",pageToLast:"Anterior"},sizes:"itens por pgina",totalItems:"itens",through:"atravs dos",of:"de"},grouping:{group:"Agrupar",ungroup:"Desagrupar",aggregate_count:"Agr: Contar",aggregate_sum:"Agr: Soma",aggregate_max:"Agr: Max",aggregate_min:"Agr: Min",aggregate_avg:"Agr: Med",aggregate_remove:"Agr: Remover"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("pt",{headerCell:{aria:{defaultFilterLabel:"Filtro por coluna",removeFilter:"Remover filtro",columnMenuButtonLabel:"Menu coluna"},priority:"Prioridade:",filterLabel:"Filtro por coluna: "},aggregate:{label:"itens"},groupPanel:{description:"Arraste e solte uma coluna aqui para agrupar por essa coluna"},search:{placeholder:"Procurar...",showingItems:"Mostrando os Itens:",selectedItems:"Itens Selecionados:",totalItems:"Total de Itens:",size:"Tamanho da Pgina:",first:"Primeira Pgina",next:"Prxima Pgina",previous:"Pgina Anterior",last:"ltima Pgina"},menu:{text:"Selecione as colunas:"},sort:{ascending:"Ordenar Ascendente",descending:"Ordenar Descendente",none:"Nenhuma Ordem",remove:"Remover Ordenao"},column:{hide:"Esconder coluna"},aggregation:{count:"total de linhas: ",sum:"total: ",avg:"med: ",min:"min: ",max:"max: "},pinning:{pinLeft:"Fixar Esquerda",pinRight:"Fixar Direita",unpin:"Desprender"},columnMenu:{close:"Fechar"},gridMenu:{aria:{buttonLabel:"Menu Grid"},columns:"Colunas:",importerTitle:"Importar ficheiro",exporterAllAsCsv:"Exportar todos os dados como csv",exporterVisibleAsCsv:"Exportar dados visveis como csv",exporterSelectedAsCsv:"Exportar dados selecionados como csv",exporterAllAsPdf:"Exportar todos os dados como pdf",exporterVisibleAsPdf:"Exportar dados visveis como pdf",exporterSelectedAsPdf:"Exportar dados selecionados como pdf",clearAllFilters:"Limpar todos os filtros"},importer:{noHeaders:"Nomes de colunas no puderam ser derivados. O ficheiro tem um cabealho?",noObjects:"Objetos no puderam ser derivados. Havia dados no ficheiro, alm dos cabealhos?",invalidCsv:"Ficheiro no pode ser processado.  um CSV vlido?",invalidJson:"Ficheiro no pode ser processado.  um Json vlido?",jsonNotArray:"Ficheiro json importado tem que conter um array. Interrompendo."},pagination:{aria:{pageToFirst:"Primeira pgina",pageBack:"Pgina anterior",pageSelected:"Pgina Selecionada",pageForward:"Prxima",pageToLast:"Anterior"},sizes:"itens por pgina",totalItems:"itens",through:"atravs dos",of:"de"},grouping:{group:"Agrupar",ungroup:"Desagrupar",aggregate_count:"Agr: Contar",aggregate_sum:"Agr: Soma",aggregate_max:"Agr: Max",aggregate_min:"Agr: Min",aggregate_avg:"Agr: Med",aggregate_remove:"Agr: Remover"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("ro",{headerCell:{aria:{defaultFilterLabel:"Filtru pentru coloana",removeFilter:"Sterge filtru",columnMenuButtonLabel:"Column Menu"},priority:"Prioritate:",filterLabel:"Filtru pentru coloana:"},aggregate:{label:"Elemente"},groupPanel:{description:"Trage un cap de coloana aici pentru a grupa elementele dupa coloana respectiva"},search:{placeholder:"Cauta...",showingItems:"Arata elementele:",selectedItems:"Elementele selectate:",totalItems:"Total elemente:",size:"Marime pagina:",first:"Prima pagina",next:"Pagina urmatoare",previous:"Pagina anterioara",last:"Ultima pagina"},menu:{text:"Alege coloane:"},sort:{ascending:"Ordoneaza crescator",descending:"Ordoneaza descrescator",none:"Fara ordonare",remove:"Sterge ordonarea"},column:{hide:"Ascunde coloana"},aggregation:{count:"total linii: ",sum:"total: ",avg:"medie: ",min:"min: ",max:"max: "},pinning:{pinLeft:"Pin la stanga",pinRight:"Pin la dreapta",unpin:"Sterge pinul"},columnMenu:{close:"Inchide"},gridMenu:{aria:{buttonLabel:"Grid Menu"},columns:"Coloane:",importerTitle:"Incarca fisier",exporterAllAsCsv:"Exporta toate datele ca csv",exporterVisibleAsCsv:"Exporta datele vizibile ca csv",exporterSelectedAsCsv:"Exporta datele selectate ca csv",exporterAllAsPdf:"Exporta toate datele ca pdf",exporterVisibleAsPdf:"Exporta datele vizibile ca pdf",exporterSelectedAsPdf:"Exporta datele selectate ca csv pdf",clearAllFilters:"Sterge toate filtrele"},importer:{noHeaders:"Numele coloanelor nu a putut fi incarcat, acest fisier are un header?",noObjects:"Datele nu au putut fi incarcate, exista date in fisier in afara numelor de coloane?",invalidCsv:"Fisierul nu a putut fi procesat, ati incarcat un CSV valid ?",invalidJson:"Fisierul nu a putut fi procesat, ati incarcat un Json valid?",jsonNotArray:"Json-ul incarcat trebuie sa contina un array, inchidere."},pagination:{aria:{pageToFirst:"Prima pagina",pageBack:"O pagina inapoi",pageSelected:"Pagina selectata",pageForward:"O pagina inainte",pageToLast:"Ultima pagina"},sizes:"Elemente per pagina",totalItems:"elemente",through:"prin",of:"of"},grouping:{group:"Grupeaza",ungroup:"Opreste gruparea",aggregate_count:"Agg: Count",aggregate_sum:"Agg: Sum",aggregate_max:"Agg: Max",aggregate_min:"Agg: Min",aggregate_avg:"Agg: Avg",aggregate_remove:"Agg: Remove"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("ru",{headerCell:{aria:{defaultFilterLabel:" ",removeFilter:" ",columnMenuButtonLabel:" "},priority:":",filterLabel:" : "},aggregate:{label:""},groupPanel:{description:"       ."},search:{placeholder:"...",showingItems:" :",selectedItems:" :",totalItems:" :",size:" :",first:" ",next:" ",previous:" ",last:" "},menu:{text:" :"},sort:{ascending:" ",descending:" ",none:" ",remove:" "},column:{hide:" "},aggregation:{count:" : ",sum:": ",avg:": ",min:": ",max:": "},pinning:{pinLeft:" ",pinRight:" ",unpin:""},columnMenu:{close:""},gridMenu:{aria:{buttonLabel:""},columns:":",importerTitle:" ",exporterAllAsCsv:"   CSV",exporterVisibleAsCsv:"    CSV",exporterSelectedAsCsv:"    CSV",exporterAllAsPdf:"   PDF",exporterVisibleAsPdf:"    PDF",exporterSelectedAsPdf:"    PDF",clearAllFilters:"  "},importer:{noHeaders:"    ,     ?",noObjects:"   ,       ?",invalidCsv:"   ,   CSV-?",invalidJson:"   ,   JSON?",jsonNotArray:" JSON-   ,  ."},pagination:{aria:{pageToFirst:" ",pageBack:" ",pageSelected:" ",pageForward:" ",pageToLast:" "},sizes:"  ",totalItems:"",through:"",of:""},grouping:{group:"",ungroup:"",aggregate_count:": Count",aggregate_sum:" : ",aggregate_max:" : ",aggregate_min:" : ",aggregate_avg:" : ",aggregate_remove:" : "}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("sk",{aggregate:{label:"items"},groupPanel:{description:"Pretiahni sem nzov stpca pre zoskupenie poda toho stpca."},search:{placeholder:"Hadaj...",showingItems:"Zobrazujem poloky:",selectedItems:"Vybrat poloky:",totalItems:"Poet poloiek:",size:"Poet:",first:"Prv strana",next:"alia strana",previous:"Predchdzajca strana",last:"Posledn strana"},menu:{text:"Vyberte stpce:"},sort:{ascending:"Zotriedi vzostupne",descending:"Zotriedi zostupne",remove:"Vymaza triedenie"},aggregation:{count:"total rows: ",sum:"total: ",avg:"avg: ",min:"min: ",max:"max: "},gridMenu:{columns:"Columns:",importerTitle:"Import file",exporterAllAsCsv:"Export all data as csv",exporterVisibleAsCsv:"Export visible data as csv",exporterSelectedAsCsv:"Export selected data as csv",exporterAllAsPdf:"Export all data as pdf",exporterVisibleAsPdf:"Export visible data as pdf",exporterSelectedAsPdf:"Export selected data as pdf",clearAllFilters:"Clear all filters"},importer:{noHeaders:"Column names were unable to be derived, does the file have a header?",noObjects:"Objects were not able to be derived, was there data in the file other than headers?",invalidCsv:"File was unable to be processed, is it valid CSV?",invalidJson:"File was unable to be processed, is it valid Json?",jsonNotArray:"Imported json file must contain an array, aborting."}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("sv",{aggregate:{label:"Artiklar"},groupPanel:{description:"Dra en kolumnrubrik hit och slpp den fr att gruppera efter den kolumnen."},search:{placeholder:"Sk...",showingItems:"Visar artiklar:",selectedItems:"Valda artiklar:",totalItems:"Antal artiklar:",size:"Sidstorlek:",first:"Frsta sidan",next:"Nsta sida",previous:"Fregende sida",last:"Sista sidan"},menu:{text:"Vlj kolumner:"},sort:{ascending:"Sortera stigande",descending:"Sortera fallande",remove:"Inaktivera sortering"},column:{hide:"Gm kolumn"},aggregation:{count:"Antal rader: ",sum:"Summa: ",avg:"Genomsnitt: ",min:"Min: ",max:"Max: "},pinning:{pinLeft:"Fst vnster",pinRight:"Fst hger",unpin:"Lsgr"},gridMenu:{columns:"Kolumner:",importerTitle:"Importera fil",exporterAllAsCsv:"Exportera all data som CSV",exporterVisibleAsCsv:"Exportera synlig data som CSV",exporterSelectedAsCsv:"Exportera markerad data som CSV",exporterAllAsPdf:"Exportera all data som PDF",exporterVisibleAsPdf:"Exportera synlig data som PDF",exporterSelectedAsPdf:"Exportera markerad data som PDF",clearAllFilters:"Rengr alla filter"},importer:{noHeaders:"Kolumnnamn kunde inte hrledas. Har filen ett sidhuvud?",noObjects:"Objekt kunde inte hrledas. Har filen data undantaget sidhuvud?",invalidCsv:"Filen kunde inte behandlas, r den en giltig CSV?",invalidJson:"Filen kunde inte behandlas, r den en giltig JSON?",jsonNotArray:"Importerad JSON-fil mste innehlla ett flt. Import avbruten."},pagination:{sizes:"Artiklar per sida",totalItems:"Artiklar"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("ta",{aggregate:{label:""},groupPanel:{description:"          "},search:{placeholder:" ...",showingItems:" :",selectedItems:"  :",totalItems:" :",size:" : ",first:" ",next:" ",previous:"  ",last:" "},menu:{text:" :"},sort:{ascending:" ",descending:" ",remove:" "},column:{hide:"   "},aggregation:{count:" :",sum:": ",avg:": ",min:": ",max:": "},pinning:{pinLeft:"  ",pinRight:" ",unpin:""},gridMenu:{columns:":",importerTitle:" : ",exporterAllAsCsv:"  : csv",exporterVisibleAsCsv:"  : csv",exporterSelectedAsCsv:"  : csv",exporterAllAsPdf:"  : pdf",exporterVisibleAsPdf:"  : pdf",exporterSelectedAsPdf:"  : pdf",clearAllFilters:"Clear all filters"},importer:{noHeaders:"   ,   ?",noObjects:"  ,      ? ",invalidCsv:"   ,  ? - csv",invalidJson:"   ,  ? - json",jsonNotArray:"   ,    : json"},pagination:{sizes:" / ",totalItems:" "},grouping:{group:"",ungroup:"",aggregate_count:" : ",aggregate_sum:" : ",aggregate_max:" : ",aggregate_min:" : ",aggregate_avg:" : ",aggregate_remove:" : "}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("tr",{headerCell:{aria:{defaultFilterLabel:"Stun iin filtre",removeFilter:"Filtreyi Kaldr",columnMenuButtonLabel:"Stun Mens"},priority:"ncelik:",filterLabel:"Stun iin filtre: "},aggregate:{label:"kaytlar"},groupPanel:{description:"Stuna gre gruplamak iin stun baln buraya srkleyin ve brakn."},search:{placeholder:"Arama...",showingItems:"Gsterilen Kayt:",selectedItems:"Seili Kayt:",totalItems:"Toplam Kayt:",size:"Sayfa Boyutu:",first:"lk Sayfa",next:"Sonraki Sayfa",previous:"nceki Sayfa",last:"Son Sayfa"},menu:{text:"Stunlar Se:"},sort:{ascending:"Artan Srada Srala",descending:"Azalan Srada Srala",none:"Sralama Yapma",remove:"Sralamay Kaldr"},column:{hide:"Stunu Gizle"},aggregation:{count:"toplam satr: ",sum:"toplam: ",avg:"ort: ",min:"min: ",max:"maks: "},pinning:{pinLeft:"Sola Sabitle",pinRight:"Saa Sabitle",unpin:"Sabitlemeyi Kaldr"},columnMenu:{close:"Kapat"},gridMenu:{aria:{buttonLabel:"Tablo Men"},columns:"Stunlar:",importerTitle:"Dosya ieri aktar",exporterAllAsCsv:"Btn veriyi CSV olarak dar aktar",exporterVisibleAsCsv:"Grnen veriyi CSV olarak dar aktar",exporterSelectedAsCsv:"Seili veriyi CSV olarak dar aktar",exporterAllAsPdf:"Btn veriyi PDF olarak dar aktar",exporterVisibleAsPdf:"Grnen veriyi PDF olarak dar aktar",exporterSelectedAsPdf:"Seili veriyi PDF olarak dar aktar",clearAllFilters:"Btn filtreleri kaldr"},importer:{noHeaders:"Stun isimleri retilemiyor, dosyann bir bal var m?",noObjects:"Nesneler retilemiyor, dosyada balktan baka bir veri var m?",invalidCsv:"Dosya ilenemedi, geerli bir CSV dosyas m?",invalidJson:"Dosya ilenemedi, geerli bir Json dosyas m?",jsonNotArray:"Alnan Json dosyasnda bir dizi bulunmaldr, ilem iptal ediliyor."},pagination:{aria:{pageToFirst:"lk sayfaya",pageBack:"Geri git",pageSelected:"Seili sayfa",pageForward:"leri git",pageToLast:"Sona git"},sizes:"Sayfadaki nesne says",totalItems:"kaytlar",through:"",of:""},grouping:{group:"Grupla",ungroup:"Gruplama",aggregate_count:"Yekun: Say",aggregate_sum:"Yekun: Toplam",aggregate_max:"Yekun: Maks",aggregate_min:"Yekun: Min",aggregate_avg:"Yekun: Ort",aggregate_remove:"Yekun: Sil"}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("ua",{headerCell:{aria:{defaultFilterLabel:" ",removeFilter:" ",columnMenuButtonLabel:" "},priority:":",filterLabel:" : "},aggregate:{label:""},groupPanel:{description:"       ."},search:{placeholder:"...",showingItems:" :",selectedItems:" :",totalItems:" :",size:" :",first:" ",next:" ",previous:" ",last:" "},menu:{text:" :"},sort:{ascending:" ",descending:" ",none:" ",remove:" "},column:{hide:" "},aggregation:{count:" : ",sum:": ",avg:": ",min:": ",max:": "},pinning:{pinLeft:" ",pinRight:" ",unpin:""},columnMenu:{close:""},gridMenu:{aria:{buttonLabel:""},columns:":",importerTitle:" ",exporterAllAsCsv:"   CSV",exporterVisibleAsCsv:"    CSV",exporterSelectedAsCsv:"    CSV",exporterAllAsPdf:"   PDF",exporterVisibleAsPdf:"    PDF",exporterSelectedAsPdf:"    PDF",clearAllFilters:"  "},importer:{noHeaders:"    ,     ?",noObjects:"   ,       ?",invalidCsv:"   ,    CSV-?",invalidJson:"   ,    JSON?",jsonNotArray:"JSON-     ,  ."},pagination:{aria:{pageToFirst:" ",pageBack:" ",pageSelected:" ",pageForward:" ",pageToLast:" "},sizes:"  ",totalItems:"",through:"",of:""},grouping:{group:"",ungroup:"",aggregate_count:": ",aggregate_sum:" : ",aggregate_max:" : ",aggregate_min:" : ",aggregate_avg:" : ",aggregate_remove:" : "}}),$delegate}])}])}(),function(){var DIRECTIVE_ALIASES=["uiT","uiTranslate"],FILTER_ALIASES=["t","uiTranslate"],module=angular.module("ui.grid.i18n");module.constant("i18nConstants",{MISSING:"[MISSING]",UPDATE_EVENT:"$uiI18n",LOCALE_DIRECTIVE_ALIAS:"uiI18n",DEFAULT_LANG:"en"}),module.service("i18nService",["$log","i18nConstants","$rootScope",function($log,i18nConstants,$rootScope){var langCache={_langs:{},current:null,get:function(lang){return this._langs[lang.toLowerCase()]},add:function(lang,strings){var lower=lang.toLowerCase();this._langs[lower]||(this._langs[lower]={}),angular.extend(this._langs[lower],strings)},getAllLangs:function(){var langs=[];if(!this._langs)return langs;for(var key in this._langs)langs.push(key);return langs},setCurrent:function(lang){this.current=lang.toLowerCase()},getCurrentLang:function(){return this.current}},service={add:function(langs,stringMaps){"object"==typeof langs?angular.forEach(langs,function(lang){lang&&langCache.add(lang,stringMaps)}):langCache.add(langs,stringMaps)},getAllLangs:function(){return langCache.getAllLangs()},get:function(lang){var language=lang?lang:service.getCurrentLang();return langCache.get(language)},getSafeText:function(path,lang){var language=lang?lang:service.getCurrentLang(),trans=langCache.get(language);if(!trans)return i18nConstants.MISSING;for(var paths=path.split("."),current=trans,i=0;i<paths.length;++i){if(void 0===current[paths[i]]||null===current[paths[i]])return i18nConstants.MISSING;current=current[paths[i]]}return current},setCurrentLang:function(lang){lang&&(langCache.setCurrent(lang),$rootScope.$broadcast(i18nConstants.UPDATE_EVENT))},getCurrentLang:function(){var lang=langCache.getCurrentLang();return lang||(lang=i18nConstants.DEFAULT_LANG,langCache.setCurrent(lang)),lang}};return service}]);var localeDirective=function(i18nService,i18nConstants){return{compile:function(){return{pre:function($scope,$elm,$attrs){var alias=i18nConstants.LOCALE_DIRECTIVE_ALIAS,lang=$scope.$eval($attrs[alias]);lang?$scope.$watch($attrs[alias],function(){i18nService.setCurrentLang(lang)}):$attrs.$$observers&&$attrs.$observe(alias,function(){i18nService.setCurrentLang($attrs[alias]||i18nConstants.DEFAULT_LANG)})}}}}};module.directive("uiI18n",["i18nService","i18nConstants",localeDirective]);var uitDirective=function($parse,i18nService,i18nConstants){return{restrict:"EA",compile:function(){return{pre:function($scope,$elm,$attrs){var observer,alias1=DIRECTIVE_ALIASES[0],alias2=DIRECTIVE_ALIASES[1],token=$attrs[alias1]||$attrs[alias2]||$elm.html(),missing=i18nConstants.MISSING+token;if($attrs.$$observers){var prop=$attrs[alias1]?alias1:alias2;observer=$attrs.$observe(prop,function(result){result&&$elm.html($parse(result)(i18nService.getCurrentLang())||missing)})}var getter=$parse(token),listener=$scope.$on(i18nConstants.UPDATE_EVENT,function(evt){observer?observer($attrs[alias1]||$attrs[alias2]):$elm.html(getter(i18nService.get())||missing)});$scope.$on("$destroy",listener),$elm.html(getter(i18nService.get())||missing)}}}}};angular.forEach(DIRECTIVE_ALIASES,function(alias){module.directive(alias,["$parse","i18nService","i18nConstants",uitDirective])});var uitFilter=function($parse,i18nService,i18nConstants){return function(data){var getter=$parse(data);return getter(i18nService.get())||i18nConstants.MISSING+data}};angular.forEach(FILTER_ALIASES,function(alias){module.filter(alias,["$parse","i18nService","i18nConstants",uitFilter])})}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("zh-cn",{
headerCell:{aria:{defaultFilterLabel:"",removeFilter:"",columnMenuButtonLabel:""},priority:":",filterLabel:": "},aggregate:{label:""},groupPanel:{description:""},search:{placeholder:"",showingItems:"",selectedItems:"",totalItems:"",size:"",first:"",next:"",previous:"",last:""},menu:{text:""},sort:{ascending:"",descending:"",none:"",remove:""},column:{hide:""},aggregation:{count:"",sum:"",avg:"",min:"",max:""},pinning:{pinLeft:"",pinRight:"",unpin:""},columnMenu:{close:""},gridMenu:{aria:{buttonLabel:""},columns:"",importerTitle:"",exporterAllAsCsv:"CSV",exporterVisibleAsCsv:"CSV",exporterSelectedAsCsv:"CSV",exporterAllAsPdf:"PDF",exporterVisibleAsPdf:"PDF",exporterSelectedAsPdf:"PDF",clearAllFilters:""},importer:{noHeaders:"",noObjects:"",invalidCsv:"CSV",invalidJson:"JSON",jsonNotArray:"JSON"},pagination:{aria:{pageToFirst:"",pageBack:"",pageSelected:"",pageForward:"",pageToLast:""},sizes:"",totalItems:"",through:"",of:""},grouping:{group:"",ungroup:"",aggregate_count:": ",aggregate_sum:": ",aggregate_max:": ",aggregate_min:": ",aggregate_avg:": ",aggregate_remove:": "}}),$delegate}])}])}(),function(){angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("i18nService",["$delegate",function($delegate){return $delegate.add("zh-tw",{aggregate:{label:""},groupPanel:{description:""},search:{placeholder:"",showingItems:"",selectedItems:"",totalItems:"",size:"",first:"",next:"",previous:"",last:""},menu:{text:""},sort:{ascending:"",descending:"",remove:""},column:{hide:""},aggregation:{count:"",sum:"",avg:"",min:"",max:""},pinning:{pinLeft:"",pinRight:"",unpin:""},gridMenu:{columns:"",importerTitle:"",exporterAllAsCsv:"CSV",exporterVisibleAsCsv:"CSV",exporterSelectedAsCsv:"CSV",exporterAllAsPdf:"PDF",exporterVisibleAsPdf:"PDF",exporterSelectedAsPdf:"PDF",clearAllFilters:""},importer:{noHeaders:"",noObjects:"",invalidCsv:"CSV",invalidJson:"JSON",jsonNotArray:"JSON"},pagination:{sizes:"",totalItems:""}}),$delegate}])}])}(),function(){var module=angular.module("ui.grid.autoResize",["ui.grid"]);module.directive("uiGridAutoResize",["$timeout","gridUtil",function($timeout,gridUtil){return{require:"uiGrid",scope:!1,link:function($scope,$elm,$attrs,uiGridCtrl){function getDimensions(){prevGridHeight=gridUtil.elementHeight($elm),prevGridWidth=gridUtil.elementWidth($elm)}function startTimeout(){clearTimeout(resizeTimeoutId),resizeTimeoutId=setTimeout(function(){var newGridHeight=gridUtil.elementHeight($elm),newGridWidth=gridUtil.elementWidth($elm);newGridHeight!==prevGridHeight||newGridWidth!==prevGridWidth?(uiGridCtrl.grid.gridHeight=newGridHeight,uiGridCtrl.grid.gridWidth=newGridWidth,uiGridCtrl.grid.api.core.raise.gridDimensionChanged(prevGridHeight,prevGridWidth,newGridHeight,newGridWidth),$scope.$apply(function(){uiGridCtrl.grid.refresh().then(function(){getDimensions(),startTimeout()})})):startTimeout()},250)}var prevGridWidth,prevGridHeight;getDimensions();var resizeTimeoutId;startTimeout(),$scope.$on("$destroy",function(){clearTimeout(resizeTimeoutId)})}}}])}(),function(){var module=angular.module("ui.grid.cellNav",["ui.grid"]);module.constant("uiGridCellNavConstants",{FEATURE_NAME:"gridCellNav",CELL_NAV_EVENT:"cellNav",direction:{LEFT:0,RIGHT:1,UP:2,DOWN:3,PG_UP:4,PG_DOWN:5},EVENT_TYPE:{KEYDOWN:0,CLICK:1,CLEAR:2}}),module.factory("uiGridCellNavFactory",["gridUtil","uiGridConstants","uiGridCellNavConstants","GridRowColumn","$q",function(gridUtil,uiGridConstants,uiGridCellNavConstants,GridRowColumn,$q){var UiGridCellNav=function(rowContainer,colContainer,leftColContainer,rightColContainer){this.rows=rowContainer.visibleRowCache,this.columns=colContainer.visibleColumnCache,this.leftColumns=leftColContainer?leftColContainer.visibleColumnCache:[],this.rightColumns=rightColContainer?rightColContainer.visibleColumnCache:[],this.bodyContainer=rowContainer};return UiGridCellNav.prototype.getFocusableCols=function(){var allColumns=this.leftColumns.concat(this.columns,this.rightColumns);return allColumns.filter(function(col){return col.colDef.allowCellFocus})},UiGridCellNav.prototype.getFocusableRows=function(){return this.rows.filter(function(row){return row.allowCellFocus!==!1})},UiGridCellNav.prototype.getNextRowCol=function(direction,curRow,curCol){switch(direction){case uiGridCellNavConstants.direction.LEFT:return this.getRowColLeft(curRow,curCol);case uiGridCellNavConstants.direction.RIGHT:return this.getRowColRight(curRow,curCol);case uiGridCellNavConstants.direction.UP:return this.getRowColUp(curRow,curCol);case uiGridCellNavConstants.direction.DOWN:return this.getRowColDown(curRow,curCol);case uiGridCellNavConstants.direction.PG_UP:return this.getRowColPageUp(curRow,curCol);case uiGridCellNavConstants.direction.PG_DOWN:return this.getRowColPageDown(curRow,curCol)}},UiGridCellNav.prototype.initializeSelection=function(){var focusableCols=this.getFocusableCols(),focusableRows=this.getFocusableRows();if(0===focusableCols.length||0===focusableRows.length)return null;return new GridRowColumn(focusableRows[0],focusableCols[0])},UiGridCellNav.prototype.getRowColLeft=function(curRow,curCol){var focusableCols=this.getFocusableCols(),focusableRows=this.getFocusableRows(),curColIndex=focusableCols.indexOf(curCol),curRowIndex=focusableRows.indexOf(curRow);curColIndex===-1&&(curColIndex=1);var nextColIndex=0===curColIndex?focusableCols.length-1:curColIndex-1;return nextColIndex>curColIndex?0===curRowIndex?new GridRowColumn(curRow,focusableCols[nextColIndex]):new GridRowColumn(focusableRows[curRowIndex-1],focusableCols[nextColIndex]):new GridRowColumn(curRow,focusableCols[nextColIndex])},UiGridCellNav.prototype.getRowColRight=function(curRow,curCol){var focusableCols=this.getFocusableCols(),focusableRows=this.getFocusableRows(),curColIndex=focusableCols.indexOf(curCol),curRowIndex=focusableRows.indexOf(curRow);curColIndex===-1&&(curColIndex=0);var nextColIndex=curColIndex===focusableCols.length-1?0:curColIndex+1;return nextColIndex<curColIndex?curRowIndex===focusableRows.length-1?new GridRowColumn(curRow,focusableCols[nextColIndex]):new GridRowColumn(focusableRows[curRowIndex+1],focusableCols[nextColIndex]):new GridRowColumn(curRow,focusableCols[nextColIndex])},UiGridCellNav.prototype.getRowColDown=function(curRow,curCol){var focusableCols=this.getFocusableCols(),focusableRows=this.getFocusableRows(),curColIndex=focusableCols.indexOf(curCol),curRowIndex=focusableRows.indexOf(curRow);return curColIndex===-1&&(curColIndex=0),curRowIndex===focusableRows.length-1?new GridRowColumn(curRow,focusableCols[curColIndex]):new GridRowColumn(focusableRows[curRowIndex+1],focusableCols[curColIndex])},UiGridCellNav.prototype.getRowColPageDown=function(curRow,curCol){var focusableCols=this.getFocusableCols(),focusableRows=this.getFocusableRows(),curColIndex=focusableCols.indexOf(curCol),curRowIndex=focusableRows.indexOf(curRow);curColIndex===-1&&(curColIndex=0);var pageSize=this.bodyContainer.minRowsToRender();return curRowIndex>=focusableRows.length-pageSize?new GridRowColumn(focusableRows[focusableRows.length-1],focusableCols[curColIndex]):new GridRowColumn(focusableRows[curRowIndex+pageSize],focusableCols[curColIndex])},UiGridCellNav.prototype.getRowColUp=function(curRow,curCol){var focusableCols=this.getFocusableCols(),focusableRows=this.getFocusableRows(),curColIndex=focusableCols.indexOf(curCol),curRowIndex=focusableRows.indexOf(curRow);return curColIndex===-1&&(curColIndex=0),0===curRowIndex?new GridRowColumn(curRow,focusableCols[curColIndex]):new GridRowColumn(focusableRows[curRowIndex-1],focusableCols[curColIndex])},UiGridCellNav.prototype.getRowColPageUp=function(curRow,curCol){var focusableCols=this.getFocusableCols(),focusableRows=this.getFocusableRows(),curColIndex=focusableCols.indexOf(curCol),curRowIndex=focusableRows.indexOf(curRow);curColIndex===-1&&(curColIndex=0);var pageSize=this.bodyContainer.minRowsToRender();return curRowIndex-pageSize<0?new GridRowColumn(focusableRows[0],focusableCols[curColIndex]):new GridRowColumn(focusableRows[curRowIndex-pageSize],focusableCols[curColIndex])},UiGridCellNav}]),module.service("uiGridCellNavService",["gridUtil","uiGridConstants","uiGridCellNavConstants","$q","uiGridCellNavFactory","GridRowColumn","ScrollEvent",function(gridUtil,uiGridConstants,uiGridCellNavConstants,$q,UiGridCellNav,GridRowColumn,ScrollEvent){var service={initializeGrid:function(grid){grid.registerColumnBuilder(service.cellNavColumnBuilder),grid.cellNav={},grid.cellNav.lastRowCol=null,grid.cellNav.focusedCells=[],service.defaultGridOptions(grid.options);var publicApi={events:{cellNav:{navigate:function(newRowCol,oldRowCol){},viewPortKeyDown:function(event,rowCol){},viewPortKeyPress:function(event,rowCol){}}},methods:{cellNav:{scrollToFocus:function(rowEntity,colDef){return service.scrollToFocus(grid,rowEntity,colDef)},getFocusedCell:function(){return grid.cellNav.lastRowCol},getCurrentSelection:function(){return grid.cellNav.focusedCells},rowColSelectIndex:function(rowCol){for(var index=-1,i=0;i<grid.cellNav.focusedCells.length;i++)if(grid.cellNav.focusedCells[i].col.uid===rowCol.col.uid&&grid.cellNav.focusedCells[i].row.uid===rowCol.row.uid){index=i;break}return index}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},defaultGridOptions:function(gridOptions){gridOptions.modifierKeysToMultiSelectCells=gridOptions.modifierKeysToMultiSelectCells===!0},decorateRenderContainers:function(grid){var rightContainer=grid.hasRightContainer()?grid.renderContainers.right:null,leftContainer=grid.hasLeftContainer()?grid.renderContainers.left:null;null!==leftContainer&&(grid.renderContainers.left.cellNav=new UiGridCellNav(grid.renderContainers.body,leftContainer,rightContainer,grid.renderContainers.body)),null!==rightContainer&&(grid.renderContainers.right.cellNav=new UiGridCellNav(grid.renderContainers.body,rightContainer,grid.renderContainers.body,leftContainer)),grid.renderContainers.body.cellNav=new UiGridCellNav(grid.renderContainers.body,grid.renderContainers.body,leftContainer,rightContainer)},getDirection:function(evt){return evt.keyCode===uiGridConstants.keymap.LEFT||evt.keyCode===uiGridConstants.keymap.TAB&&evt.shiftKey?uiGridCellNavConstants.direction.LEFT:evt.keyCode===uiGridConstants.keymap.RIGHT||evt.keyCode===uiGridConstants.keymap.TAB?uiGridCellNavConstants.direction.RIGHT:evt.keyCode===uiGridConstants.keymap.UP||evt.keyCode===uiGridConstants.keymap.ENTER&&evt.shiftKey?uiGridCellNavConstants.direction.UP:evt.keyCode===uiGridConstants.keymap.PG_UP?uiGridCellNavConstants.direction.PG_UP:evt.keyCode===uiGridConstants.keymap.DOWN||evt.keyCode===uiGridConstants.keymap.ENTER&&!evt.ctrlKey&&!evt.altKey?uiGridCellNavConstants.direction.DOWN:evt.keyCode===uiGridConstants.keymap.PG_DOWN?uiGridCellNavConstants.direction.PG_DOWN:null},cellNavColumnBuilder:function(colDef,col,gridOptions){var promises=[];return colDef.allowCellFocus=void 0===colDef.allowCellFocus||colDef.allowCellFocus,$q.all(promises)},scrollToFocus:function(grid,rowEntity,colDef){var gridRow=null,gridCol=null;return"undefined"!=typeof rowEntity&&null!==rowEntity&&(gridRow=grid.getRow(rowEntity)),"undefined"!=typeof colDef&&null!==colDef&&(gridCol=grid.getColumn(colDef.name?colDef.name:colDef.field)),grid.api.core.scrollToIfNecessary(gridRow,gridCol).then(function(){var rowCol={row:gridRow,col:gridCol};null!==gridRow&&null!==gridCol&&grid.cellNav.broadcastCellNav(rowCol)})},getLeftWidth:function(grid,upToCol){var width=0;if(!upToCol)return width;var lastIndex=grid.renderContainers.body.visibleColumnCache.indexOf(upToCol);grid.renderContainers.body.visibleColumnCache.forEach(function(col,index){index<lastIndex&&(width+=col.drawnWidth)});var percentage=0===lastIndex?0:(lastIndex+1)/grid.renderContainers.body.visibleColumnCache.length;return width+=upToCol.drawnWidth*percentage}};return service}]),module.directive("uiGridCellnav",["gridUtil","uiGridCellNavService","uiGridCellNavConstants","uiGridConstants","GridRowColumn","$timeout","$compile",function(gridUtil,uiGridCellNavService,uiGridCellNavConstants,uiGridConstants,GridRowColumn,$timeout,$compile){return{replace:!0,priority:-150,require:"^uiGrid",scope:!1,controller:function(){},compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){var _scope=$scope,grid=uiGridCtrl.grid;uiGridCellNavService.initializeGrid(grid),uiGridCtrl.cellNav={},uiGridCtrl.cellNav.makeRowCol=function(obj){return obj instanceof GridRowColumn||(obj=new GridRowColumn(obj.row,obj.col)),obj},uiGridCtrl.cellNav.getActiveCell=function(){var elms=$elm[0].getElementsByClassName("ui-grid-cell-focus");if(elms.length>0)return elms[0]},uiGridCtrl.cellNav.broadcastCellNav=grid.cellNav.broadcastCellNav=function(newRowCol,modifierDown,originEvt){modifierDown=!(void 0===modifierDown||!modifierDown),newRowCol=uiGridCtrl.cellNav.makeRowCol(newRowCol),uiGridCtrl.cellNav.broadcastFocus(newRowCol,modifierDown,originEvt),_scope.$broadcast(uiGridCellNavConstants.CELL_NAV_EVENT,newRowCol,modifierDown,originEvt)},uiGridCtrl.cellNav.clearFocus=grid.cellNav.clearFocus=function(){grid.cellNav.focusedCells=[],_scope.$broadcast(uiGridCellNavConstants.CELL_NAV_EVENT)},uiGridCtrl.cellNav.broadcastFocus=function(rowCol,modifierDown,originEvt){modifierDown=!(void 0===modifierDown||!modifierDown),rowCol=uiGridCtrl.cellNav.makeRowCol(rowCol);var row=rowCol.row,col=rowCol.col,rowColSelectIndex=uiGridCtrl.grid.api.cellNav.rowColSelectIndex(rowCol);if(null===grid.cellNav.lastRowCol||rowColSelectIndex===-1){var newRowCol=new GridRowColumn(row,col);null!==grid.cellNav.lastRowCol&&grid.cellNav.lastRowCol.row===newRowCol.row&&grid.cellNav.lastRowCol.col===newRowCol.col||(grid.api.cellNav.raise.navigate(newRowCol,grid.cellNav.lastRowCol),grid.cellNav.lastRowCol=newRowCol),uiGridCtrl.grid.options.modifierKeysToMultiSelectCells&&modifierDown?grid.cellNav.focusedCells.push(rowCol):grid.cellNav.focusedCells=[rowCol]}else grid.options.modifierKeysToMultiSelectCells&&modifierDown&&rowColSelectIndex>=0&&grid.cellNav.focusedCells.splice(rowColSelectIndex,1)},uiGridCtrl.cellNav.handleKeyDown=function(evt){var direction=uiGridCellNavService.getDirection(evt);if(null===direction)return null;var containerId="body";evt.uiGridTargetRenderContainerId&&(containerId=evt.uiGridTargetRenderContainerId);var lastRowCol=uiGridCtrl.grid.api.cellNav.getFocusedCell();if(lastRowCol){var rowCol=uiGridCtrl.grid.renderContainers[containerId].cellNav.getNextRowCol(direction,lastRowCol.row,lastRowCol.col),focusableCols=uiGridCtrl.grid.renderContainers[containerId].cellNav.getFocusableCols(),rowColSelectIndex=uiGridCtrl.grid.api.cellNav.rowColSelectIndex(rowCol);return direction===uiGridCellNavConstants.direction.LEFT&&rowCol.col===focusableCols[focusableCols.length-1]&&rowCol.row===lastRowCol.row&&evt.keyCode===uiGridConstants.keymap.TAB&&evt.shiftKey?(grid.cellNav.focusedCells.splice(rowColSelectIndex,1),uiGridCtrl.cellNav.clearFocus(),!0):direction!==uiGridCellNavConstants.direction.RIGHT||rowCol.col!==focusableCols[0]||rowCol.row!==lastRowCol.row||evt.keyCode!==uiGridConstants.keymap.TAB||evt.shiftKey?(grid.scrollToIfNecessary(rowCol.row,rowCol.col).then(function(){uiGridCtrl.cellNav.broadcastCellNav(rowCol)}),evt.stopPropagation(),evt.preventDefault(),!1):(grid.cellNav.focusedCells.splice(rowColSelectIndex,1),uiGridCtrl.cellNav.clearFocus(),!0)}}},post:function($scope,$elm,$attrs,uiGridCtrl){function addAriaLiveRegion(){var ariaNotifierDomElt='<div id="'+grid.id+'-aria-speakable" class="ui-grid-a11y-ariascreenreader-speakable ui-grid-offscreen" aria-live="assertive" role="region" aria-atomic="true" aria-hidden="false" aria-relevant="additions" >&nbsp;</div>',ariaNotifier=$compile(ariaNotifierDomElt)($scope);$elm.prepend(ariaNotifier),$scope.$on(uiGridCellNavConstants.CELL_NAV_EVENT,function(evt,rowCol,modifierDown,originEvt){function setNotifyText(text){text!==ariaNotifier.text()&&(ariaNotifier[0].style.clip="rect(0px,0px,0px,0px)",ariaNotifier[0].innerHTML="",ariaNotifier[0].style.visibility="hidden",ariaNotifier[0].style.visibility="visible",""!==text&&(ariaNotifier[0].style.clip="auto",ariaNotifier[0].appendChild(document.createTextNode(text+" ")),ariaNotifier[0].style.visibility="hidden",ariaNotifier[0].style.visibility="visible"))}if(!originEvt||"focus"!==originEvt.type){for(var values=[],currentSelection=grid.api.cellNav.getCurrentSelection(),i=0;i<currentSelection.length;i++)values.push(grid.getCellDisplayValue(currentSelection[i].row,currentSelection[i].col));var cellText=values.toString();setNotifyText(cellText)}})}var grid=uiGridCtrl.grid;addAriaLiveRegion()}}}}}]),module.directive("uiGridRenderContainer",["$timeout","$document","gridUtil","uiGridConstants","uiGridCellNavService","$compile","uiGridCellNavConstants",function($timeout,$document,gridUtil,uiGridConstants,uiGridCellNavService,$compile,uiGridCellNavConstants){return{replace:!0,priority:-99999,require:["^uiGrid","uiGridRenderContainer","?^uiGridCellnav"],scope:!1,compile:function(){return{post:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0],renderContainerCtrl=controllers[1],uiGridCellnavCtrl=controllers[2];if(uiGridCtrl.grid.api.cellNav){var containerId=renderContainerCtrl.containerId,grid=uiGridCtrl.grid;if(uiGridCellNavService.decorateRenderContainers(grid),"body"===containerId){uiGridCtrl.grid.options.modifierKeysToMultiSelectCells?$elm.attr("aria-multiselectable",!0):$elm.attr("aria-multiselectable",!1);var focuser=$compile('<div class="ui-grid-focuser" role="region" aria-live="assertive" aria-atomic="false" tabindex="0" aria-controls="'+grid.id+"-aria-speakable "+grid.id+'-grid-container" aria-owns="'+grid.id+'-grid-container"></div>')($scope);$elm.append(focuser),focuser.on("focus",function(evt){evt.uiGridTargetRenderContainerId=containerId;var rowCol=uiGridCtrl.grid.api.cellNav.getFocusedCell();null===rowCol&&(rowCol=uiGridCtrl.grid.renderContainers[containerId].cellNav.getNextRowCol(uiGridCellNavConstants.direction.DOWN,null,null),rowCol.row&&rowCol.col&&uiGridCtrl.cellNav.broadcastCellNav(rowCol))}),uiGridCellnavCtrl.setAriaActivedescendant=function(id){$elm.attr("aria-activedescendant",id)},uiGridCellnavCtrl.removeAriaActivedescendant=function(id){$elm.attr("aria-activedescendant")===id&&$elm.attr("aria-activedescendant","")},uiGridCtrl.focus=function(){gridUtil.focus.byElement(focuser[0])};var viewPortKeyDownWasRaisedForRowCol=null;focuser.on("keydown",function(evt){evt.uiGridTargetRenderContainerId=containerId;var rowCol=uiGridCtrl.grid.api.cellNav.getFocusedCell(),result=uiGridCtrl.cellNav.handleKeyDown(evt);null===result&&(uiGridCtrl.grid.api.cellNav.raise.viewPortKeyDown(evt,rowCol),viewPortKeyDownWasRaisedForRowCol=rowCol)}),focuser.on("keypress",function(evt){viewPortKeyDownWasRaisedForRowCol&&($timeout(function(){uiGridCtrl.grid.api.cellNav.raise.viewPortKeyPress(evt,viewPortKeyDownWasRaisedForRowCol)},4),viewPortKeyDownWasRaisedForRowCol=null)}),$scope.$on("$destroy",function(){focuser.off()})}}}}}}}]),module.directive("uiGridViewport",["$timeout","$document","gridUtil","uiGridConstants","uiGridCellNavService","uiGridCellNavConstants","$log","$compile",function($timeout,$document,gridUtil,uiGridConstants,uiGridCellNavService,uiGridCellNavConstants,$log,$compile){return{replace:!0,priority:-99999,require:["^uiGrid","^uiGridRenderContainer","?^uiGridCellnav"],scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){},post:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0],renderContainerCtrl=controllers[1];if(uiGridCtrl.grid.api.cellNav){var containerId=renderContainerCtrl.containerId;if("body"===containerId){var grid=uiGridCtrl.grid;grid.api.core.on.scrollBegin($scope,function(args){var lastRowCol=uiGridCtrl.grid.api.cellNav.getFocusedCell();null!==lastRowCol&&renderContainerCtrl.colContainer.containsColumn(lastRowCol.col)&&uiGridCtrl.cellNav.clearFocus()}),grid.api.core.on.scrollEnd($scope,function(args){var lastRowCol=uiGridCtrl.grid.api.cellNav.getFocusedCell();null!==lastRowCol&&renderContainerCtrl.colContainer.containsColumn(lastRowCol.col)&&uiGridCtrl.cellNav.broadcastCellNav(lastRowCol)}),grid.api.cellNav.on.navigate($scope,function(){uiGridCtrl.focus()})}}}}}}}]),module.directive("uiGridCell",["$timeout","$document","uiGridCellNavService","gridUtil","uiGridCellNavConstants","uiGridConstants","GridRowColumn",function($timeout,$document,uiGridCellNavService,gridUtil,uiGridCellNavConstants,uiGridConstants,GridRowColumn){return{priority:-150,restrict:"A",require:["^uiGrid","?^uiGridCellnav"],scope:!1,link:function($scope,$elm,$attrs,controllers){function preventMouseDown(evt){evt.preventDefault()}function setFocused(){if(!$scope.focused){var div=$elm.find("div");div.addClass("ui-grid-cell-focus"),$elm.attr("aria-selected",!0),uiGridCellnavCtrl.setAriaActivedescendant($elm.attr("id")),$scope.focused=!0}}function clearFocus(){if($scope.focused){var div=$elm.find("div");div.removeClass("ui-grid-cell-focus"),$elm.attr("aria-selected",!1),uiGridCellnavCtrl.removeAriaActivedescendant($elm.attr("id")),$scope.focused=!1}}var uiGridCtrl=controllers[0],uiGridCellnavCtrl=controllers[1];if(uiGridCtrl.grid.api.cellNav&&$scope.col.colDef.allowCellFocus){var grid=uiGridCtrl.grid;$scope.focused=!1,$elm.attr("tabindex",-1),$elm.find("div").on("click",function(evt){uiGridCtrl.cellNav.broadcastCellNav(new GridRowColumn($scope.row,$scope.col),evt.ctrlKey||evt.metaKey,evt),evt.stopPropagation(),$scope.$apply()}),$elm.on("mousedown",preventMouseDown),uiGridCtrl.grid.api.edit&&(uiGridCtrl.grid.api.edit.on.beginCellEdit($scope,function(){$elm.off("mousedown",preventMouseDown)}),uiGridCtrl.grid.api.edit.on.afterCellEdit($scope,function(){$elm.on("mousedown",preventMouseDown)}),uiGridCtrl.grid.api.edit.on.cancelCellEdit($scope,function(){$elm.on("mousedown",preventMouseDown)})),$elm.on("focus",function(evt){uiGridCtrl.cellNav.broadcastCellNav(new GridRowColumn($scope.row,$scope.col),!1,evt),evt.stopPropagation(),$scope.$apply()}),$scope.$on(uiGridCellNavConstants.CELL_NAV_EVENT,function(evt,rowCol,modifierDown){var isFocused=grid.cellNav.focusedCells.some(function(focusedRowCol,index){return focusedRowCol.row===$scope.row&&focusedRowCol.col===$scope.col});isFocused?setFocused():clearFocus()}),$scope.$on("$destroy",function(){$elm.find("div").off(),$elm.off()})}}}}])}(),function(){var module=angular.module("ui.grid.edit",["ui.grid"]);module.constant("uiGridEditConstants",{EDITABLE_CELL_TEMPLATE:/EDITABLE_CELL_TEMPLATE/g,EDITABLE_CELL_DIRECTIVE:/editable_cell_directive/g,events:{BEGIN_CELL_EDIT:"uiGridEventBeginCellEdit",END_CELL_EDIT:"uiGridEventEndCellEdit",CANCEL_CELL_EDIT:"uiGridEventCancelCellEdit"}}),module.service("uiGridEditService",["$q","uiGridConstants","gridUtil",function($q,uiGridConstants,gridUtil){var service={initializeGrid:function(grid){service.defaultGridOptions(grid.options),grid.registerColumnBuilder(service.editColumnBuilder),grid.edit={};var publicApi={events:{edit:{afterCellEdit:function(rowEntity,colDef,newValue,oldValue){},beginCellEdit:function(rowEntity,colDef,triggerEvent){},cancelCellEdit:function(rowEntity,colDef){}}},methods:{edit:{}}};grid.api.registerEventsFromObject(publicApi.events)},defaultGridOptions:function(gridOptions){gridOptions.cellEditableCondition=void 0===gridOptions.cellEditableCondition||gridOptions.cellEditableCondition,gridOptions.enableCellEditOnFocus=void 0!==gridOptions.enableCellEditOnFocus&&gridOptions.enableCellEditOnFocus},editColumnBuilder:function(colDef,col,gridOptions){var promises=[];return colDef.enableCellEdit=void 0===colDef.enableCellEdit?void 0===gridOptions.enableCellEdit?"object"!==colDef.type:gridOptions.enableCellEdit:colDef.enableCellEdit,colDef.cellEditableCondition=void 0===colDef.cellEditableCondition?gridOptions.cellEditableCondition:colDef.cellEditableCondition,colDef.enableCellEdit&&(colDef.editableCellTemplate=colDef.editableCellTemplate||gridOptions.editableCellTemplate||"ui-grid/cellEditor",promises.push(gridUtil.getTemplate(colDef.editableCellTemplate).then(function(template){col.editableCellTemplate=template},function(res){throw new Error("Couldn't fetch/use colDef.editableCellTemplate '"+colDef.editableCellTemplate+"'")}))),colDef.enableCellEditOnFocus=void 0===colDef.enableCellEditOnFocus?gridOptions.enableCellEditOnFocus:colDef.enableCellEditOnFocus,$q.all(promises)},isStartEditKey:function(evt){return!(evt.metaKey||evt.keyCode===uiGridConstants.keymap.ESC||evt.keyCode===uiGridConstants.keymap.SHIFT||evt.keyCode===uiGridConstants.keymap.CTRL||evt.keyCode===uiGridConstants.keymap.ALT||evt.keyCode===uiGridConstants.keymap.WIN||evt.keyCode===uiGridConstants.keymap.CAPSLOCK||evt.keyCode===uiGridConstants.keymap.LEFT||evt.keyCode===uiGridConstants.keymap.TAB&&evt.shiftKey||evt.keyCode===uiGridConstants.keymap.RIGHT||evt.keyCode===uiGridConstants.keymap.TAB||evt.keyCode===uiGridConstants.keymap.UP||evt.keyCode===uiGridConstants.keymap.ENTER&&evt.shiftKey||evt.keyCode===uiGridConstants.keymap.DOWN||evt.keyCode===uiGridConstants.keymap.ENTER)}};return service}]),module.directive("uiGridEdit",["gridUtil","uiGridEditService",function(gridUtil,uiGridEditService){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridEditService.initializeGrid(uiGridCtrl.grid)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}]),module.directive("uiGridViewport",["uiGridEditConstants",function(uiGridEditConstants){return{replace:!0,priority:-99998,require:["^uiGrid","^uiGridRenderContainer"],scope:!1,compile:function(){return{post:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0];if(uiGridCtrl.grid.api.edit&&uiGridCtrl.grid.api.cellNav){var containerId=controllers[1].containerId;"body"===containerId&&($scope.$on(uiGridEditConstants.events.CANCEL_CELL_EDIT,function(){uiGridCtrl.focus()}),$scope.$on(uiGridEditConstants.events.END_CELL_EDIT,function(){uiGridCtrl.focus()}))}}}}}}]),module.directive("uiGridCell",["$compile","$injector","$timeout","uiGridConstants","uiGridEditConstants","gridUtil","$parse","uiGridEditService","$rootScope","$q",function($compile,$injector,$timeout,uiGridConstants,uiGridEditConstants,gridUtil,$parse,uiGridEditService,$rootScope,$q){var touchstartTimeout=500;if($injector.has("uiGridCellNavService")){$injector.get("uiGridCellNavService")}return{priority:-100,restrict:"A",scope:!1,require:"?^uiGrid",link:function($scope,$elm,$attrs,uiGridCtrl){function registerBeginEditEvents(){$elm.on("dblclick",beginEdit),$elm.on("touchstart",touchStart),uiGridCtrl&&uiGridCtrl.grid.api.cellNav&&(viewPortKeyDownDereg=uiGridCtrl.grid.api.cellNav.on.viewPortKeyDown($scope,function(evt,rowCol){null!==rowCol&&(rowCol.row!==$scope.row||rowCol.col!==$scope.col||$scope.col.colDef.enableCellEditOnFocus||beginEditKeyDown(evt))}),cellNavNavigateDereg=uiGridCtrl.grid.api.cellNav.on.navigate($scope,function(newRowCol,oldRowCol){$scope.col.colDef.enableCellEditOnFocus&&(oldRowCol&&newRowCol.row===oldRowCol.row&&newRowCol.col===oldRowCol.col||newRowCol.row!==$scope.row||newRowCol.col!==$scope.col||$timeout(function(){beginEdit()}))})),$scope.beginEditEventsWired=!0}function touchStart(event){"undefined"!=typeof event.originalEvent&&void 0!==event.originalEvent&&(event=event.originalEvent),$elm.on("touchend",touchEnd),cancelTouchstartTimeout=$timeout(function(){},touchstartTimeout),cancelTouchstartTimeout.then(function(){setTimeout(beginEdit,0),$elm.off("touchend",touchEnd)})}function touchEnd(event){$timeout.cancel(cancelTouchstartTimeout),$elm.off("touchend",touchEnd)}function cancelBeginEditEvents(){$elm.off("dblclick",beginEdit),$elm.off("keydown",beginEditKeyDown),$elm.off("touchstart",touchStart),cellNavNavigateDereg(),viewPortKeyDownDereg(),$scope.beginEditEventsWired=!1}function beginEditKeyDown(evt){uiGridEditService.isStartEditKey(evt)&&beginEdit(evt)}function shouldEdit(col,row){return!row.isSaving&&(angular.isFunction(col.colDef.cellEditableCondition)?col.colDef.cellEditableCondition($scope):col.colDef.cellEditableCondition)}function beginEdit(triggerEvent){$scope.grid.api.core.scrollToIfNecessary($scope.row,$scope.col).then(function(){beginEditAfterScroll(triggerEvent)})}function beginEditAfterScroll(triggerEvent){if(!inEdit&&shouldEdit($scope.col,$scope.row)){var modelField=$scope.row.getQualifiedColField($scope.col);$scope.col.colDef.editModelField&&(modelField=gridUtil.preEval("row.entity."+$scope.col.colDef.editModelField)),cellModel=$parse(modelField),origCellValue=cellModel($scope),html=$scope.col.editableCellTemplate,html=html.replace(uiGridConstants.MODEL_COL_FIELD,modelField),html=html.replace(uiGridConstants.COL_FIELD,"grid.getCellValue(row, col)");var optionFilter=$scope.col.colDef.editDropdownFilter?"|"+$scope.col.colDef.editDropdownFilter:"";html=html.replace(uiGridConstants.CUSTOM_FILTERS,optionFilter);var inputType="text";switch($scope.col.colDef.type){case"boolean":inputType="checkbox";break;case"number":inputType="number";break;case"date":inputType="date"}html=html.replace("INPUT_TYPE",inputType);var editDropdownOptionsFunction=$scope.col.colDef.editDropdownOptionsFunction;if(editDropdownOptionsFunction)$q.when(editDropdownOptionsFunction($scope.row.entity,$scope.col.colDef)).then(function(result){$scope.editDropdownOptionsArray=result});else{var editDropdownRowEntityOptionsArrayPath=$scope.col.colDef.editDropdownRowEntityOptionsArrayPath;editDropdownRowEntityOptionsArrayPath?$scope.editDropdownOptionsArray=resolveObjectFromPath($scope.row.entity,editDropdownRowEntityOptionsArrayPath):$scope.editDropdownOptionsArray=$scope.col.colDef.editDropdownOptionsArray}$scope.editDropdownIdLabel=$scope.col.colDef.editDropdownIdLabel?$scope.col.colDef.editDropdownIdLabel:"id",$scope.editDropdownValueLabel=$scope.col.colDef.editDropdownValueLabel?$scope.col.colDef.editDropdownValueLabel:"value";var createEditor=function(){inEdit=!0,cancelBeginEditEvents();var cellElement=angular.element(html);$elm.append(cellElement),editCellScope=$scope.$new(),$compile(cellElement)(editCellScope);var gridCellContentsEl=angular.element($elm.children()[0]);gridCellContentsEl.addClass("ui-grid-cell-contents-hidden")};$rootScope.$$phase?createEditor():$scope.$apply(createEditor);var deregOnGridScroll=$scope.col.grid.api.core.on.scrollBegin($scope,function(){$scope.grid.disableScrolling||(endEdit(),$scope.grid.api.edit.raise.afterCellEdit($scope.row.entity,$scope.col.colDef,cellModel($scope),origCellValue),deregOnGridScroll(),deregOnEndCellEdit(),deregOnCancelCellEdit())}),deregOnEndCellEdit=$scope.$on(uiGridEditConstants.events.END_CELL_EDIT,function(){endEdit(),$scope.grid.api.edit.raise.afterCellEdit($scope.row.entity,$scope.col.colDef,cellModel($scope),origCellValue),deregOnEndCellEdit(),deregOnGridScroll(),deregOnCancelCellEdit()}),deregOnCancelCellEdit=$scope.$on(uiGridEditConstants.events.CANCEL_CELL_EDIT,function(){cancelEdit(),deregOnCancelCellEdit(),deregOnGridScroll(),deregOnEndCellEdit()});$scope.$broadcast(uiGridEditConstants.events.BEGIN_CELL_EDIT,triggerEvent),$timeout(function(){$scope.grid.api.edit.raise.beginCellEdit($scope.row.entity,$scope.col.colDef,triggerEvent)})}}function endEdit(){if($scope.grid.disableScrolling=!1,inEdit){uiGridCtrl&&uiGridCtrl.grid.api.cellNav&&uiGridCtrl.focus();var gridCellContentsEl=angular.element($elm.children()[0]);editCellScope.$destroy();for(var children=$elm.children(),i=1;i<children.length;i++)angular.element(children[i]).remove();gridCellContentsEl.removeClass("ui-grid-cell-contents-hidden"),
inEdit=!1,registerBeginEditEvents(),$scope.grid.api.core.notifyDataChange(uiGridConstants.dataChange.EDIT)}}function cancelEdit(){$scope.grid.disableScrolling=!1,inEdit&&(cellModel.assign($scope,origCellValue),$scope.$apply(),$scope.grid.api.edit.raise.cancelCellEdit($scope.row.entity,$scope.col.colDef),endEdit())}function resolveObjectFromPath(object,path){path=path.replace(/\[(\w+)\]/g,".$1"),path=path.replace(/^\./,"");for(var a=path.split(".");a.length;){var n=a.shift();if(!(n in object))return;object=object[n]}return object}var html,origCellValue,cellModel,cancelTouchstartTimeout,editCellScope,inEdit=!1;if($scope.col.colDef.enableCellEdit){var cellNavNavigateDereg=function(){},viewPortKeyDownDereg=function(){},setEditable=function(){$scope.col.colDef.enableCellEdit&&$scope.row.enableCellEdit!==!1?$scope.beginEditEventsWired||registerBeginEditEvents():$scope.beginEditEventsWired&&cancelBeginEditEvents()};setEditable();var rowWatchDereg=$scope.$watch("row",function(n,o){n!==o&&setEditable()});$scope.$on("$destroy",rowWatchDereg)}}}}]),module.directive("uiGridEditor",["gridUtil","uiGridConstants","uiGridEditConstants","$timeout","uiGridEditService",function(gridUtil,uiGridConstants,uiGridEditConstants,$timeout,uiGridEditService){return{scope:!0,require:["?^uiGrid","?^uiGridRenderContainer","ngModel"],compile:function(){return{pre:function($scope,$elm,$attrs){},post:function($scope,$elm,$attrs,controllers){var uiGridCtrl,renderContainerCtrl,ngModel;controllers[0]&&(uiGridCtrl=controllers[0]),controllers[1]&&(renderContainerCtrl=controllers[1]),controllers[2]&&(ngModel=controllers[2]),$scope.$on(uiGridEditConstants.events.BEGIN_CELL_EDIT,function(evt,triggerEvent){if($timeout(function(){if($elm[0].focus(),!$elm[0].select||!$scope.col.colDef.enableCellEditOnFocus&&uiGridCtrl&&uiGridCtrl.grid.api.cellNav)try{$elm[0].setSelectionRange($elm[0].value.length,$elm[0].value.length)}catch(ex){}else $elm[0].select()}),uiGridCtrl&&uiGridCtrl.grid.api.cellNav)var viewPortKeyDownUnregister=uiGridCtrl.grid.api.cellNav.on.viewPortKeyPress($scope,function(evt,rowCol){uiGridEditService.isStartEditKey(evt)&&(ngModel.$setViewValue(String.fromCharCode("number"==typeof evt.which?evt.which:evt.keyCode),evt),ngModel.$render()),viewPortKeyDownUnregister()});$elm.on("blur",function(evt){$scope.stopEdit(evt)})}),$scope.deepEdit=!1,$scope.stopEdit=function(evt){$scope.inputForm&&!$scope.inputForm.$valid?(evt.stopPropagation(),$scope.$emit(uiGridEditConstants.events.CANCEL_CELL_EDIT)):$scope.$emit(uiGridEditConstants.events.END_CELL_EDIT),$scope.deepEdit=!1},$elm.on("click",function(evt){"checkbox"!==$elm[0].type&&($scope.deepEdit=!0,$timeout(function(){$scope.grid.disableScrolling=!0}))}),$elm.on("keydown",function(evt){switch(evt.keyCode){case uiGridConstants.keymap.ESC:evt.stopPropagation(),$scope.$emit(uiGridEditConstants.events.CANCEL_CELL_EDIT)}if(!$scope.deepEdit||evt.keyCode!==uiGridConstants.keymap.LEFT&&evt.keyCode!==uiGridConstants.keymap.RIGHT&&evt.keyCode!==uiGridConstants.keymap.UP&&evt.keyCode!==uiGridConstants.keymap.DOWN)if(uiGridCtrl&&uiGridCtrl.grid.api.cellNav)evt.uiGridTargetRenderContainerId=renderContainerCtrl.containerId,null!==uiGridCtrl.cellNav.handleKeyDown(evt)&&$scope.stopEdit(evt);else switch(evt.keyCode){case uiGridConstants.keymap.ENTER:case uiGridConstants.keymap.TAB:evt.stopPropagation(),evt.preventDefault(),$scope.stopEdit(evt)}else evt.stopPropagation();return!0})}}}}}]),module.directive("uiGridEditor",["$filter",function($filter){function parseDateString(dateString){if("undefined"==typeof dateString||""===dateString)return null;var parts=dateString.split("-");if(3!==parts.length)return null;var year=parseInt(parts[0],10),month=parseInt(parts[1],10),day=parseInt(parts[2],10);return month<1||year<1||day<1?null:new Date(year,month-1,day)}return{priority:-100,require:"?ngModel",link:function(scope,element,attrs,ngModel){2===angular.version.minor&&attrs.type&&"date"===attrs.type&&ngModel&&(ngModel.$formatters.push(function(modelValue){return ngModel.$setValidity(null,!modelValue||!isNaN(modelValue.getTime())),$filter("date")(modelValue,"yyyy-MM-dd")}),ngModel.$parsers.push(function(viewValue){if(viewValue&&viewValue.length>0){var dateValue=parseDateString(viewValue);return ngModel.$setValidity(null,dateValue&&!isNaN(dateValue.getTime())),dateValue}return ngModel.$setValidity(null,!0),null}))}}}]),module.directive("uiGridEditDropdown",["uiGridConstants","uiGridEditConstants",function(uiGridConstants,uiGridEditConstants){return{require:["?^uiGrid","?^uiGridRenderContainer"],scope:!0,compile:function(){return{pre:function($scope,$elm,$attrs){},post:function($scope,$elm,$attrs,controllers){var uiGridCtrl=controllers[0],renderContainerCtrl=controllers[1];$scope.$on(uiGridEditConstants.events.BEGIN_CELL_EDIT,function(){$elm[0].focus(),$elm[0].style.width=$elm[0].parentElement.offsetWidth-1+"px",$elm.on("blur",function(evt){$scope.stopEdit(evt)})}),$scope.stopEdit=function(evt){$scope.$emit(uiGridEditConstants.events.END_CELL_EDIT)},$elm.on("keydown",function(evt){switch(evt.keyCode){case uiGridConstants.keymap.ESC:evt.stopPropagation(),$scope.$emit(uiGridEditConstants.events.CANCEL_CELL_EDIT)}if(uiGridCtrl&&uiGridCtrl.grid.api.cellNav)evt.uiGridTargetRenderContainerId=renderContainerCtrl.containerId,null!==uiGridCtrl.cellNav.handleKeyDown(evt)&&$scope.stopEdit(evt);else switch(evt.keyCode){case uiGridConstants.keymap.ENTER:case uiGridConstants.keymap.TAB:evt.stopPropagation(),evt.preventDefault(),$scope.stopEdit(evt)}return!0})}}}}}]),module.directive("uiGridEditFileChooser",["gridUtil","uiGridConstants","uiGridEditConstants","$timeout",function(gridUtil,uiGridConstants,uiGridEditConstants,$timeout){return{scope:!0,require:["?^uiGrid","?^uiGridRenderContainer"],compile:function(){return{pre:function($scope,$elm,$attrs){},post:function($scope,$elm,$attrs,controllers){var uiGridCtrl,renderContainerCtrl;controllers[0]&&(uiGridCtrl=controllers[0]),controllers[1]&&(renderContainerCtrl=controllers[1]);var handleFileSelect=(uiGridCtrl.grid,function(event){var target=event.srcElement||event.target;target&&target.files&&target.files.length>0?("function"==typeof $scope.col.colDef.editFileChooserCallback?$scope.col.colDef.editFileChooserCallback($scope.row,$scope.col,target.files):gridUtil.logError("You need to set colDef.editFileChooserCallback to use the file chooser"),target.form.reset(),$scope.$emit(uiGridEditConstants.events.END_CELL_EDIT)):$scope.$emit(uiGridEditConstants.events.CANCEL_CELL_EDIT)});$elm[0].addEventListener("change",handleFileSelect,!1),$scope.$on(uiGridEditConstants.events.BEGIN_CELL_EDIT,function(){$elm[0].focus(),$elm[0].select(),$elm.on("blur",function(evt){$scope.$emit(uiGridEditConstants.events.END_CELL_EDIT)})})}}}}}])}(),function(){var module=angular.module("ui.grid.expandable",["ui.grid"]);module.service("uiGridExpandableService",["gridUtil","$compile",function(gridUtil,$compile){var service={initializeGrid:function(grid){grid.expandable={},grid.expandable.expandedAll=!1,grid.options.enableExpandable=grid.options.enableExpandable!==!1,grid.options.expandableRowHeight=grid.options.expandableRowHeight||150,grid.options.expandableRowHeaderWidth=grid.options.expandableRowHeaderWidth||40,grid.options.enableExpandable&&!grid.options.expandableRowTemplate&&(gridUtil.logError("You have not set the expandableRowTemplate, disabling expandable module"),grid.options.enableExpandable=!1);var publicApi={events:{expandable:{rowExpandedBeforeStateChanged:function(scope,row){},rowExpandedStateChanged:function(scope,row){}}},methods:{expandable:{toggleRowExpansion:function(rowEntity){var row=grid.getRow(rowEntity);null!==row&&service.toggleRowExpansion(grid,row)},expandAllRows:function(){service.expandAllRows(grid)},collapseAllRows:function(){service.collapseAllRows(grid)},toggleAllRows:function(){service.toggleAllRows(grid)},expandRow:function(rowEntity){var row=grid.getRow(rowEntity);null===row||row.isExpanded||service.toggleRowExpansion(grid,row)},collapseRow:function(rowEntity){var row=grid.getRow(rowEntity);null!==row&&row.isExpanded&&service.toggleRowExpansion(grid,row)},getExpandedRows:function(){return service.getExpandedRows(grid).map(function(gridRow){return gridRow.entity})}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},toggleRowExpansion:function(grid,row){grid.api.expandable.raise.rowExpandedBeforeStateChanged(row),row.isExpanded=!row.isExpanded,angular.isUndefined(row.expandedRowHeight)&&(row.expandedRowHeight=grid.options.expandableRowHeight),row.isExpanded?row.height=row.grid.options.rowHeight+row.expandedRowHeight:(row.height=row.grid.options.rowHeight,grid.expandable.expandedAll=!1),grid.api.expandable.raise.rowExpandedStateChanged(row)},expandAllRows:function(grid,$scope){grid.renderContainers.body.visibleRowCache.forEach(function(row){row.isExpanded||service.toggleRowExpansion(grid,row)}),grid.expandable.expandedAll=!0,grid.queueGridRefresh()},collapseAllRows:function(grid){grid.renderContainers.body.visibleRowCache.forEach(function(row){row.isExpanded&&service.toggleRowExpansion(grid,row)}),grid.expandable.expandedAll=!1,grid.queueGridRefresh()},toggleAllRows:function(grid){grid.expandable.expandedAll?service.collapseAllRows(grid):service.expandAllRows(grid)},getExpandedRows:function(grid){return grid.rows.filter(function(row){return row.isExpanded})}};return service}]),module.directive("uiGridExpandable",["uiGridExpandableService","$templateCache",function(uiGridExpandableService,$templateCache){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){if(uiGridExpandableService.initializeGrid(uiGridCtrl.grid),uiGridCtrl.grid.options.enableExpandable&&uiGridCtrl.grid.options.enableExpandableRowHeader!==!1){var expandableRowHeaderColDef={name:"expandableButtons",displayName:"",exporterSuppressExport:!0,enableColumnResizing:!1,enableColumnMenu:!1,width:uiGridCtrl.grid.options.expandableRowHeaderWidth||40};expandableRowHeaderColDef.cellTemplate=$templateCache.get("ui-grid/expandableRowHeader"),expandableRowHeaderColDef.headerCellTemplate=$templateCache.get("ui-grid/expandableTopRowHeader"),uiGridCtrl.grid.addRowHeaderColumn(expandableRowHeaderColDef,-90)}},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}]),module.directive("uiGrid",["uiGridExpandableService","$templateCache",function(uiGridExpandableService,$templateCache){return{replace:!0,priority:599,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridCtrl.grid.api.core.on.renderingComplete($scope,function(){$scope.row&&$scope.row.grid&&$scope.row.grid.options&&$scope.row.grid.options.enableExpandable&&(uiGridCtrl.grid.parentRow=$scope.row)})},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}]),module.directive("uiGridExpandableRow",["uiGridExpandableService","$timeout","$compile","uiGridConstants","gridUtil","$interval","$log",function(uiGridExpandableService,$timeout,$compile,uiGridConstants,gridUtil,$interval,$log){return{replace:!1,priority:0,scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){gridUtil.getTemplate($scope.grid.options.expandableRowTemplate).then(function(template){if($scope.grid.options.expandableRowScope){var expandableRowScope=$scope.grid.options.expandableRowScope;for(var property in expandableRowScope)expandableRowScope.hasOwnProperty(property)&&($scope[property]=expandableRowScope[property])}var expandedRowElement=angular.element(template);$elm.append(expandedRowElement),expandedRowElement=$compile(expandedRowElement)($scope),$scope.row.expandedRendered=!0})},post:function($scope,$elm,$attrs,uiGridCtrl){$scope.$on("$destroy",function(){$scope.row.expandedRendered=!1})}}}}}]),module.directive("uiGridRow",["$compile","gridUtil","$templateCache",function($compile,gridUtil,$templateCache){return{priority:-200,scope:!1,compile:function($elm,$attrs){return{pre:function($scope,$elm,$attrs,controllers){$scope.grid.options.enableExpandable&&($scope.expandableRow={},$scope.expandableRow.shouldRenderExpand=function(){var ret="body"===$scope.colContainer.name&&$scope.grid.options.enableExpandable!==!1&&$scope.row.isExpanded&&(!$scope.grid.isScrollingVertically||$scope.row.expandedRendered);return ret},$scope.expandableRow.shouldRenderFiller=function(){var ret=$scope.row.isExpanded&&("body"!==$scope.colContainer.name||$scope.grid.isScrollingVertically&&!$scope.row.expandedRendered);return ret})},post:function($scope,$elm,$attrs,controllers){}}}}}]),module.directive("uiGridViewport",["$compile","gridUtil","$templateCache",function($compile,gridUtil,$templateCache){return{priority:-200,scope:!1,compile:function($elm,$attrs){var rowRepeatDiv=angular.element($elm.children().children()[0]),expandedRowFillerElement=$templateCache.get("ui-grid/expandableScrollFiller"),expandedRowElement=$templateCache.get("ui-grid/expandableRow");return rowRepeatDiv.append(expandedRowElement),rowRepeatDiv.append(expandedRowFillerElement),{pre:function($scope,$elm,$attrs,controllers){},post:function($scope,$elm,$attrs,controllers){}}}}}])}(),function(){var module=angular.module("ui.grid.exporter",["ui.grid"]);module.constant("uiGridExporterConstants",{featureName:"exporter",ALL:"all",VISIBLE:"visible",SELECTED:"selected",CSV_CONTENT:"CSV_CONTENT",BUTTON_LABEL:"BUTTON_LABEL",FILE_NAME:"FILE_NAME"}),module.service("uiGridExporterService",["$q","uiGridExporterConstants","gridUtil","$compile","$interval","i18nService",function($q,uiGridExporterConstants,gridUtil,$compile,$interval,i18nService){var service={delay:100,initializeGrid:function(grid){grid.exporter={},this.defaultGridOptions(grid.options);var publicApi={events:{exporter:{}},methods:{exporter:{csvExport:function(rowTypes,colTypes){service.csvExport(grid,rowTypes,colTypes)},pdfExport:function(rowTypes,colTypes){service.pdfExport(grid,rowTypes,colTypes)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods),grid.api.core.addToGridMenu?service.addToMenu(grid):$interval(function(){grid.api.core.addToGridMenu&&service.addToMenu(grid)},this.delay,1)},defaultGridOptions:function(gridOptions){gridOptions.exporterSuppressMenu=gridOptions.exporterSuppressMenu===!0,gridOptions.exporterMenuLabel=gridOptions.exporterMenuLabel?gridOptions.exporterMenuLabel:"Export",gridOptions.exporterSuppressColumns=gridOptions.exporterSuppressColumns?gridOptions.exporterSuppressColumns:[],gridOptions.exporterCsvColumnSeparator=gridOptions.exporterCsvColumnSeparator?gridOptions.exporterCsvColumnSeparator:",",gridOptions.exporterCsvFilename=gridOptions.exporterCsvFilename?gridOptions.exporterCsvFilename:"download.csv",gridOptions.exporterPdfFilename=gridOptions.exporterPdfFilename?gridOptions.exporterPdfFilename:"download.pdf",gridOptions.exporterOlderExcelCompatibility=gridOptions.exporterOlderExcelCompatibility===!0,gridOptions.exporterPdfDefaultStyle=gridOptions.exporterPdfDefaultStyle?gridOptions.exporterPdfDefaultStyle:{fontSize:11},gridOptions.exporterPdfTableStyle=gridOptions.exporterPdfTableStyle?gridOptions.exporterPdfTableStyle:{margin:[0,5,0,15]},gridOptions.exporterPdfTableHeaderStyle=gridOptions.exporterPdfTableHeaderStyle?gridOptions.exporterPdfTableHeaderStyle:{bold:!0,fontSize:12,color:"black"},gridOptions.exporterPdfHeader=gridOptions.exporterPdfHeader?gridOptions.exporterPdfHeader:null,gridOptions.exporterPdfFooter=gridOptions.exporterPdfFooter?gridOptions.exporterPdfFooter:null,gridOptions.exporterPdfOrientation=gridOptions.exporterPdfOrientation?gridOptions.exporterPdfOrientation:"landscape",gridOptions.exporterPdfPageSize=gridOptions.exporterPdfPageSize?gridOptions.exporterPdfPageSize:"A4",gridOptions.exporterPdfMaxGridWidth=gridOptions.exporterPdfMaxGridWidth?gridOptions.exporterPdfMaxGridWidth:720,gridOptions.exporterMenuAllData=void 0===gridOptions.exporterMenuAllData||gridOptions.exporterMenuAllData,gridOptions.exporterMenuVisibleData=void 0===gridOptions.exporterMenuVisibleData||gridOptions.exporterMenuVisibleData,gridOptions.exporterMenuSelectedData=void 0===gridOptions.exporterMenuSelectedData||gridOptions.exporterMenuSelectedData,gridOptions.exporterMenuCsv=void 0===gridOptions.exporterMenuCsv||gridOptions.exporterMenuCsv,gridOptions.exporterMenuPdf=void 0===gridOptions.exporterMenuPdf||gridOptions.exporterMenuPdf,gridOptions.exporterPdfCustomFormatter=gridOptions.exporterPdfCustomFormatter&&"function"==typeof gridOptions.exporterPdfCustomFormatter?gridOptions.exporterPdfCustomFormatter:function(docDef){return docDef},gridOptions.exporterHeaderFilterUseName=gridOptions.exporterHeaderFilterUseName===!0,gridOptions.exporterFieldCallback=gridOptions.exporterFieldCallback?gridOptions.exporterFieldCallback:function(grid,row,col,value){return value},gridOptions.exporterAllDataFn=gridOptions.exporterAllDataFn?gridOptions.exporterAllDataFn:null,null==gridOptions.exporterAllDataFn&&gridOptions.exporterAllDataPromise&&(gridOptions.exporterAllDataFn=gridOptions.exporterAllDataPromise)},addToMenu:function(grid){grid.api.core.addToGridMenu(grid,[{title:i18nService.getSafeText("gridMenu.exporterAllAsCsv"),action:function($event){this.grid.api.exporter.csvExport(uiGridExporterConstants.ALL,uiGridExporterConstants.ALL)},shown:function(){return this.grid.options.exporterMenuCsv&&this.grid.options.exporterMenuAllData},order:200},{title:i18nService.getSafeText("gridMenu.exporterVisibleAsCsv"),action:function($event){this.grid.api.exporter.csvExport(uiGridExporterConstants.VISIBLE,uiGridExporterConstants.VISIBLE)},shown:function(){return this.grid.options.exporterMenuCsv&&this.grid.options.exporterMenuVisibleData},order:201},{title:i18nService.getSafeText("gridMenu.exporterSelectedAsCsv"),action:function($event){this.grid.api.exporter.csvExport(uiGridExporterConstants.SELECTED,uiGridExporterConstants.VISIBLE)},shown:function(){return this.grid.options.exporterMenuCsv&&this.grid.options.exporterMenuSelectedData&&this.grid.api.selection&&this.grid.api.selection.getSelectedRows().length>0},order:202},{title:i18nService.getSafeText("gridMenu.exporterAllAsPdf"),action:function($event){this.grid.api.exporter.pdfExport(uiGridExporterConstants.ALL,uiGridExporterConstants.ALL)},shown:function(){return this.grid.options.exporterMenuPdf&&this.grid.options.exporterMenuAllData},order:203},{title:i18nService.getSafeText("gridMenu.exporterVisibleAsPdf"),action:function($event){this.grid.api.exporter.pdfExport(uiGridExporterConstants.VISIBLE,uiGridExporterConstants.VISIBLE)},shown:function(){return this.grid.options.exporterMenuPdf&&this.grid.options.exporterMenuVisibleData},order:204},{title:i18nService.getSafeText("gridMenu.exporterSelectedAsPdf"),action:function($event){this.grid.api.exporter.pdfExport(uiGridExporterConstants.SELECTED,uiGridExporterConstants.VISIBLE)},shown:function(){return this.grid.options.exporterMenuPdf&&this.grid.options.exporterMenuSelectedData&&this.grid.api.selection&&this.grid.api.selection.getSelectedRows().length>0},order:205}])},csvExport:function(grid,rowTypes,colTypes){var self=this;this.loadAllDataIfNeeded(grid,rowTypes,colTypes).then(function(){var exportColumnHeaders=grid.options.showHeader?self.getColumnHeaders(grid,colTypes):[],exportData=self.getData(grid,rowTypes,colTypes),csvContent=self.formatAsCsv(exportColumnHeaders,exportData,grid.options.exporterCsvColumnSeparator);self.downloadFile(grid.options.exporterCsvFilename,csvContent,grid.options.exporterCsvColumnSeparator,grid.options.exporterOlderExcelCompatibility)})},loadAllDataIfNeeded:function(grid,rowTypes,colTypes){if(rowTypes===uiGridExporterConstants.ALL&&grid.rows.length!==grid.options.totalItems&&grid.options.exporterAllDataFn)return grid.options.exporterAllDataFn().then(function(){grid.modifyRows(grid.options.data)});var deferred=$q.defer();return deferred.resolve(),deferred.promise},getColumnHeaders:function(grid,colTypes){var columns,headers=[];if(colTypes===uiGridExporterConstants.ALL)columns=grid.columns;else{var leftColumns=grid.renderContainers.left?grid.renderContainers.left.visibleColumnCache.filter(function(column){return column.visible}):[],bodyColumns=grid.renderContainers.body?grid.renderContainers.body.visibleColumnCache.filter(function(column){return column.visible}):[],rightColumns=grid.renderContainers.right?grid.renderContainers.right.visibleColumnCache.filter(function(column){return column.visible}):[];columns=leftColumns.concat(bodyColumns,rightColumns)}return columns.forEach(function(gridCol,index){gridCol.colDef.exporterSuppressExport!==!0&&grid.options.exporterSuppressColumns.indexOf(gridCol.name)===-1&&headers.push({name:gridCol.field,displayName:grid.options.exporterHeaderFilter?grid.options.exporterHeaderFilterUseName?grid.options.exporterHeaderFilter(gridCol.name):grid.options.exporterHeaderFilter(gridCol.displayName):gridCol.displayName,width:gridCol.drawnWidth?gridCol.drawnWidth:gridCol.width,align:"number"===gridCol.colDef.type?"right":"left"})}),headers},getData:function(grid,rowTypes,colTypes,applyCellFilters){var rows,columns,data=[];switch(rowTypes){case uiGridExporterConstants.ALL:rows=grid.rows;break;case uiGridExporterConstants.VISIBLE:rows=grid.getVisibleRows();break;case uiGridExporterConstants.SELECTED:grid.api.selection?rows=grid.api.selection.getSelectedGridRows():gridUtil.logError("selection feature must be enabled to allow selected rows to be exported")}if(colTypes===uiGridExporterConstants.ALL)columns=grid.columns;else{var leftColumns=grid.renderContainers.left?grid.renderContainers.left.visibleColumnCache.filter(function(column){return column.visible}):[],bodyColumns=grid.renderContainers.body?grid.renderContainers.body.visibleColumnCache.filter(function(column){return column.visible}):[],rightColumns=grid.renderContainers.right?grid.renderContainers.right.visibleColumnCache.filter(function(column){return column.visible}):[];columns=leftColumns.concat(bodyColumns,rightColumns)}return rows.forEach(function(row,index){if(row.exporterEnableExporting!==!1){var extractedRow=[];columns.forEach(function(gridCol,index){if((gridCol.visible||colTypes===uiGridExporterConstants.ALL)&&gridCol.colDef.exporterSuppressExport!==!0&&grid.options.exporterSuppressColumns.indexOf(gridCol.name)===-1){var cellValue=applyCellFilters?grid.getCellDisplayValue(row,gridCol):grid.getCellValue(row,gridCol),extractedField={value:grid.options.exporterFieldCallback(grid,row,gridCol,cellValue)};gridCol.colDef.exporterPdfAlign&&(extractedField.alignment=gridCol.colDef.exporterPdfAlign),extractedRow.push(extractedField)}}),data.push(extractedRow)}}),data},formatAsCsv:function(exportColumnHeaders,exportData,separator){var self=this,bareHeaders=exportColumnHeaders.map(function(header){return{value:header.displayName}}),csv=bareHeaders.length>0?self.formatRowAsCsv(this,separator)(bareHeaders)+"\n":"";return csv+=exportData.map(this.formatRowAsCsv(this,separator)).join("\n")},formatRowAsCsv:function(exporter,separator){return function(row){return row.map(exporter.formatFieldAsCsv).join(separator)}},formatFieldAsCsv:function(field){return null==field.value?"":"number"==typeof field.value?field.value:"boolean"==typeof field.value?field.value?"TRUE":"FALSE":"string"==typeof field.value?'"'+field.value.replace(/"/g,'""')+'"':JSON.stringify(field.value)},isIE:function(){var match=navigator.userAgent.search(/(?:Edge|MSIE|Trident\/.*; rv:)/),isIE=!1;return match!==-1&&(isIE=!0),isIE},downloadFile:function(fileName,csvContent,columnSeparator,exporterOlderExcelCompatibility){var rawFile,D=document,a=D.createElement("a"),strMimeType="application/octet-stream;charset=utf-8",ieVersion=this.isIE();if(navigator.msSaveBlob)return navigator.msSaveOrOpenBlob(new Blob([exporterOlderExcelCompatibility?"\ufeff":"",csvContent],{type:strMimeType}),fileName);if(ieVersion){var frame=D.createElement("iframe");return document.body.appendChild(frame),frame.contentWindow.document.open("text/html","replace"),frame.contentWindow.document.write("sep="+columnSeparator+"\r\n"+csvContent),frame.contentWindow.document.close(),frame.contentWindow.focus(),frame.contentWindow.document.execCommand("SaveAs",!0,fileName),document.body.removeChild(frame),!0}if("download"in a){var blob=new Blob([exporterOlderExcelCompatibility?"\ufeff":"",csvContent],{type:strMimeType});rawFile=URL.createObjectURL(blob),a.setAttribute("download",fileName)}else rawFile="data:"+strMimeType+","+encodeURIComponent(csvContent),a.setAttribute("target","_blank");a.href=rawFile,a.setAttribute("style","display:none;"),D.body.appendChild(a),setTimeout(function(){if(a.click)a.click();else if(document.createEvent){var eventObj=document.createEvent("MouseEvents");eventObj.initEvent("click",!0,!0),a.dispatchEvent(eventObj)}D.body.removeChild(a)},this.delay)},pdfExport:function(grid,rowTypes,colTypes){var self=this;this.loadAllDataIfNeeded(grid,rowTypes,colTypes).then(function(){var exportColumnHeaders=self.getColumnHeaders(grid,colTypes),exportData=self.getData(grid,rowTypes,colTypes),docDefinition=self.prepareAsPdf(grid,exportColumnHeaders,exportData);self.isIE()||navigator.appVersion.indexOf("Edge")!==-1?self.downloadPDF(grid.options.exporterPdfFilename,docDefinition):pdfMake.createPdf(docDefinition).open()})},downloadPDF:function(fileName,docDefinition){var ieVersion,D=document;D.createElement("a");ieVersion=this.isIE();var blob,doc=pdfMake.createPdf(docDefinition);doc.getBuffer(function(buffer){if(blob=new Blob([buffer]),navigator.msSaveBlob)return navigator.msSaveBlob(blob,fileName);if(ieVersion){var frame=D.createElement("iframe");return document.body.appendChild(frame),frame.contentWindow.document.open("text/html","replace"),frame.contentWindow.document.write(blob),frame.contentWindow.document.close(),frame.contentWindow.focus(),frame.contentWindow.document.execCommand("SaveAs",!0,fileName),document.body.removeChild(frame),!0}})},prepareAsPdf:function(grid,exportColumnHeaders,exportData){var headerWidths=this.calculatePdfHeaderWidths(grid,exportColumnHeaders),headerColumns=exportColumnHeaders.map(function(header){return{text:header.displayName,style:"tableHeader"}}),stringData=exportData.map(this.formatRowAsPdf(this)),allData=[headerColumns].concat(stringData),docDefinition={pageOrientation:grid.options.exporterPdfOrientation,pageSize:grid.options.exporterPdfPageSize,content:[{style:"tableStyle",table:{headerRows:1,widths:headerWidths,body:allData}}],styles:{tableStyle:grid.options.exporterPdfTableStyle,tableHeader:grid.options.exporterPdfTableHeaderStyle},defaultStyle:grid.options.exporterPdfDefaultStyle};return grid.options.exporterPdfLayout&&(docDefinition.layout=grid.options.exporterPdfLayout),grid.options.exporterPdfHeader&&(docDefinition.header=grid.options.exporterPdfHeader),grid.options.exporterPdfFooter&&(docDefinition.footer=grid.options.exporterPdfFooter),grid.options.exporterPdfCustomFormatter&&(docDefinition=grid.options.exporterPdfCustomFormatter(docDefinition)),docDefinition},calculatePdfHeaderWidths:function(grid,exportHeaders){var baseGridWidth=0;exportHeaders.forEach(function(value){"number"==typeof value.width&&(baseGridWidth+=value.width)});var extraColumns=0;exportHeaders.forEach(function(value){if("*"===value.width&&(extraColumns+=100),"string"==typeof value.width&&value.width.match(/(\d)*%/)){var percent=parseInt(value.width.match(/(\d)*%/)[0]);value.width=baseGridWidth*percent/100,extraColumns+=value.width}});var gridWidth=baseGridWidth+extraColumns;return exportHeaders.map(function(header){return"*"===header.width?header.width:header.width*grid.options.exporterPdfMaxGridWidth/gridWidth})},formatRowAsPdf:function(exporter){return function(row){return row.map(exporter.formatFieldAsPdfString)}},formatFieldAsPdfString:function(field){var returnVal;return returnVal=null==field.value?"":"number"==typeof field.value?field.value.toString():"boolean"==typeof field.value?field.value?"TRUE":"FALSE":"string"==typeof field.value?field.value.replace(/"/g,'""'):JSON.stringify(field.value).replace(/^"/,"").replace(/"$/,""),field.alignment&&"string"==typeof field.alignment&&(returnVal={text:returnVal,alignment:field.alignment}),returnVal}};return service}]),module.directive("uiGridExporter",["uiGridExporterConstants","uiGridExporterService","gridUtil","$compile",function(uiGridExporterConstants,uiGridExporterService,gridUtil,$compile){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,link:function($scope,$elm,$attrs,uiGridCtrl){uiGridExporterService.initializeGrid(uiGridCtrl.grid),uiGridCtrl.grid.exporter.$scope=$scope}}}])}(),function(){var module=angular.module("ui.grid.grouping",["ui.grid","ui.grid.treeBase"]);module.constant("uiGridGroupingConstants",{featureName:"grouping",rowHeaderColName:"treeBaseRowHeaderCol",EXPANDED:"expanded",COLLAPSED:"collapsed",aggregation:{COUNT:"count",SUM:"sum",MAX:"max",MIN:"min",AVG:"avg"}}),module.service("uiGridGroupingService",["$q","uiGridGroupingConstants","gridUtil","rowSorter","GridRow","gridClassFactory","i18nService","uiGridConstants","uiGridTreeBaseService",function($q,uiGridGroupingConstants,gridUtil,rowSorter,GridRow,gridClassFactory,i18nService,uiGridConstants,uiGridTreeBaseService){var service={initializeGrid:function(grid,$scope){uiGridTreeBaseService.initializeGrid(grid,$scope),grid.grouping={},grid.grouping.groupHeaderCache={},service.defaultGridOptions(grid.options),grid.registerRowsProcessor(service.groupRows,400),grid.registerColumnBuilder(service.groupingColumnBuilder),grid.registerColumnsProcessor(service.groupingColumnProcessor,400);var publicApi={events:{grouping:{aggregationChanged:{},groupingChanged:{}}},methods:{grouping:{getGrouping:function(getExpanded){var grouping=service.getGrouping(grid);return grouping.grouping.forEach(function(group){group.colName=group.col.name,delete group.col}),grouping.aggregations.forEach(function(aggregation){aggregation.colName=aggregation.col.name,delete aggregation.col}),grouping.aggregations=grouping.aggregations.filter(function(aggregation){return!aggregation.aggregation.source||"grouping"!==aggregation.aggregation.source}),getExpanded&&(grouping.rowExpandedStates=service.getRowExpandedStates(grid.grouping.groupingHeaderCache)),grouping},setGrouping:function(config){service.setGrouping(grid,config)},groupColumn:function(columnName){var column=grid.getColumn(columnName);service.groupColumn(grid,column)},ungroupColumn:function(columnName){var column=grid.getColumn(columnName);service.ungroupColumn(grid,column)},clearGrouping:function(){service.clearGrouping(grid)},aggregateColumn:function(columnName,aggregationDef,aggregationLabel){var column=grid.getColumn(columnName);service.aggregateColumn(grid,column,aggregationDef,aggregationLabel)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods),grid.api.core.on.sortChanged($scope,service.tidyPriorities)},defaultGridOptions:function(gridOptions){gridOptions.enableGrouping=gridOptions.enableGrouping!==!1,gridOptions.groupingShowCounts=gridOptions.groupingShowCounts!==!1,gridOptions.groupingNullLabel="undefined"==typeof gridOptions.groupingNullLabel?"Null":gridOptions.groupingNullLabel,gridOptions.enableGroupHeaderSelection=gridOptions.enableGroupHeaderSelection===!0},groupingColumnBuilder:function(colDef,col,gridOptions){if(colDef.enableGrouping!==!1){"undefined"==typeof col.grouping&&"undefined"!=typeof colDef.grouping?(col.grouping=angular.copy(colDef.grouping),"undefined"!=typeof col.grouping.groupPriority&&col.grouping.groupPriority>-1&&(col.treeAggregationFn=uiGridTreeBaseService.nativeAggregations()[uiGridGroupingConstants.aggregation.COUNT].aggregationFn,col.treeAggregationFinalizerFn=service.groupedFinalizerFn)):"undefined"==typeof col.grouping&&(col.grouping={}),"undefined"!=typeof col.grouping&&"undefined"!=typeof col.grouping.groupPriority&&col.grouping.groupPriority>=0&&(col.suppressRemoveSort=!0);var groupColumn={name:"ui.grid.grouping.group",title:i18nService.get().grouping.group,
icon:"ui-grid-icon-indent-right",shown:function(){return"undefined"==typeof this.context.col.grouping||"undefined"==typeof this.context.col.grouping.groupPriority||this.context.col.grouping.groupPriority<0},action:function(){service.groupColumn(this.context.col.grid,this.context.col)}},ungroupColumn={name:"ui.grid.grouping.ungroup",title:i18nService.get().grouping.ungroup,icon:"ui-grid-icon-indent-left",shown:function(){return"undefined"!=typeof this.context.col.grouping&&"undefined"!=typeof this.context.col.grouping.groupPriority&&this.context.col.grouping.groupPriority>=0},action:function(){service.ungroupColumn(this.context.col.grid,this.context.col)}},aggregateRemove={name:"ui.grid.grouping.aggregateRemove",title:i18nService.get().grouping.aggregate_remove,shown:function(){return"undefined"!=typeof this.context.col.treeAggregationFn},action:function(){service.aggregateColumn(this.context.col.grid,this.context.col,null)}},addAggregationMenu=function(type,title){title=title||i18nService.get().grouping["aggregate_"+type]||type;var menuItem={name:"ui.grid.grouping.aggregate"+type,title:title,shown:function(){return"undefined"==typeof this.context.col.treeAggregation||"undefined"==typeof this.context.col.treeAggregation.type||this.context.col.treeAggregation.type!==type},action:function(){service.aggregateColumn(this.context.col.grid,this.context.col,type)}};gridUtil.arrayContainsObjectWithProperty(col.menuItems,"name","ui.grid.grouping.aggregate"+type)||col.menuItems.push(menuItem)};col.colDef.groupingShowGroupingMenu!==!1&&(gridUtil.arrayContainsObjectWithProperty(col.menuItems,"name","ui.grid.grouping.group")||col.menuItems.push(groupColumn),gridUtil.arrayContainsObjectWithProperty(col.menuItems,"name","ui.grid.grouping.ungroup")||col.menuItems.push(ungroupColumn)),col.colDef.groupingShowAggregationMenu!==!1&&(angular.forEach(uiGridTreeBaseService.nativeAggregations(),function(aggregationDef,name){addAggregationMenu(name)}),angular.forEach(gridOptions.treeCustomAggregations,function(aggregationDef,name){addAggregationMenu(name,aggregationDef.menuTitle)}),gridUtil.arrayContainsObjectWithProperty(col.menuItems,"name","ui.grid.grouping.aggregateRemove")||col.menuItems.push(aggregateRemove))}},groupingColumnProcessor:function(columns,rows){return columns=service.moveGroupColumns(this,columns,rows)},groupedFinalizerFn:function(aggregation){var col=this;"undefined"!=typeof aggregation.groupVal?(aggregation.rendered=aggregation.groupVal,col.grid.options.groupingShowCounts&&"date"!==col.colDef.type&&(aggregation.rendered+=" ("+aggregation.value+")")):aggregation.rendered=null},moveGroupColumns:function(grid,columns,rows){return grid.options.moveGroupColumns===!1?columns:(columns.forEach(function(column,index){column.groupingPosition=index}),columns.sort(function(a,b){var a_group,b_group;return a_group=a.isRowHeader?a.headerPriority:"undefined"==typeof a.grouping||"undefined"==typeof a.grouping.groupPriority||a.grouping.groupPriority<0?null:a.grouping.groupPriority,b_group=b.isRowHeader?b.headerPriority:"undefined"==typeof b.grouping||"undefined"==typeof b.grouping.groupPriority||b.grouping.groupPriority<0?null:b.grouping.groupPriority,null!==a_group&&null===b_group?-1:null!==b_group&&null===a_group?1:null!==a_group&&null!==b_group?a_group-b_group:a.groupingPosition-b.groupingPosition}),columns.forEach(function(column,index){delete column.groupingPosition}),columns)},groupColumn:function(grid,column){"undefined"==typeof column.grouping&&(column.grouping={});var existingGrouping=service.getGrouping(grid);column.grouping.groupPriority=existingGrouping.grouping.length,column.sort?"undefined"!=typeof column.sort.direction&&null!==column.sort.direction||(column.sort.direction=uiGridConstants.ASC):column.sort={direction:uiGridConstants.ASC},column.treeAggregation={type:uiGridGroupingConstants.aggregation.COUNT,source:"grouping"},column.treeAggregationFn=uiGridTreeBaseService.nativeAggregations()[uiGridGroupingConstants.aggregation.COUNT].aggregationFn,column.treeAggregationFinalizerFn=service.groupedFinalizerFn,grid.api.grouping.raise.groupingChanged(column),grid.api.core.raise.sortChanged(grid,grid.getColumnSorting()),grid.queueGridRefresh()},ungroupColumn:function(grid,column){"undefined"!=typeof column.grouping&&(delete column.grouping.groupPriority,delete column.treeAggregation,delete column.customTreeAggregationFinalizer,service.tidyPriorities(grid),grid.api.grouping.raise.groupingChanged(column),grid.queueGridRefresh())},aggregateColumn:function(grid,column,aggregationType){"undefined"!=typeof column.grouping&&"undefined"!=typeof column.grouping.groupPriority&&column.grouping.groupPriority>=0&&service.ungroupColumn(grid,column);var aggregationDef={};"undefined"!=typeof grid.options.treeCustomAggregations[aggregationType]?aggregationDef=grid.options.treeCustomAggregations[aggregationType]:"undefined"!=typeof uiGridTreeBaseService.nativeAggregations()[aggregationType]&&(aggregationDef=uiGridTreeBaseService.nativeAggregations()[aggregationType]),column.treeAggregation={type:aggregationType,label:i18nService.get().aggregation[aggregationDef.label]||aggregationDef.label},column.treeAggregationFn=aggregationDef.aggregationFn,column.treeAggregationFinalizerFn=aggregationDef.finalizerFn,grid.api.grouping.raise.aggregationChanged(column),grid.queueGridRefresh()},setGrouping:function(grid,config){"undefined"!=typeof config&&(service.clearGrouping(grid),config.grouping&&config.grouping.length&&config.grouping.length>0&&config.grouping.forEach(function(group){var col=grid.getColumn(group.colName);col&&service.groupColumn(grid,col)}),config.aggregations&&config.aggregations.length&&config.aggregations.forEach(function(aggregation){var col=grid.getColumn(aggregation.colName);col&&service.aggregateColumn(grid,col,aggregation.aggregation.type)}),config.rowExpandedStates&&service.applyRowExpandedStates(grid.grouping.groupingHeaderCache,config.rowExpandedStates))},clearGrouping:function(grid){var currentGrouping=service.getGrouping(grid);currentGrouping.grouping.length>0&&currentGrouping.grouping.forEach(function(group){group.col||(group.col=grid.getColumn(group.colName)),service.ungroupColumn(grid,group.col)}),currentGrouping.aggregations.length>0&&currentGrouping.aggregations.forEach(function(aggregation){aggregation.col||(aggregation.col=grid.getColumn(aggregation.colName)),service.aggregateColumn(grid,aggregation.col,null)})},tidyPriorities:function(grid){"undefined"!=typeof grid&&"undefined"==typeof grid.grid||"undefined"==typeof this.grid||(grid=this.grid);var groupArray=[],sortArray=[];grid.columns.forEach(function(column,index){"undefined"!=typeof column.grouping&&"undefined"!=typeof column.grouping.groupPriority&&column.grouping.groupPriority>=0?groupArray.push(column):"undefined"!=typeof column.sort&&"undefined"!=typeof column.sort.priority&&column.sort.priority>=0&&sortArray.push(column)}),groupArray.sort(function(a,b){return a.grouping.groupPriority-b.grouping.groupPriority}),groupArray.forEach(function(column,index){column.grouping.groupPriority=index,column.suppressRemoveSort=!0,"undefined"==typeof column.sort&&(column.sort={}),column.sort.priority=index});var i=groupArray.length;sortArray.sort(function(a,b){return a.sort.priority-b.sort.priority}),sortArray.forEach(function(column,index){column.sort.priority=i,column.suppressRemoveSort=column.colDef.suppressRemoveSort,i++})},groupRows:function(renderableRows){if(0===renderableRows.length)return renderableRows;var grid=this;grid.grouping.oldGroupingHeaderCache=grid.grouping.groupingHeaderCache||{},grid.grouping.groupingHeaderCache={};for(var processingState=service.initialiseProcessingState(grid),updateProcessingState=function(groupFieldState,stateIndex){var fieldValue=grid.getCellValue(row,groupFieldState.col);groupFieldState.initialised&&0===rowSorter.getSortFn(grid,groupFieldState.col,renderableRows)(fieldValue,groupFieldState.currentValue)||(service.insertGroupHeader(grid,renderableRows,i,processingState,stateIndex),i++)},i=0;i<renderableRows.length;i++){var row=renderableRows[i];row.visible&&processingState.forEach(updateProcessingState)}return delete grid.grouping.oldGroupingHeaderCache,renderableRows},initialiseProcessingState:function(grid){var processingState=[],columnSettings=service.getGrouping(grid);return columnSettings.grouping.forEach(function(groupItem,index){processingState.push({fieldName:groupItem.field,col:groupItem.col,initialised:!1,currentValue:null,currentRow:null})}),processingState},getGrouping:function(grid){var groupArray=[],aggregateArray=[];return grid.columns.forEach(function(column,columnIndex){column.grouping&&"undefined"!=typeof column.grouping.groupPriority&&column.grouping.groupPriority>=0&&groupArray.push({field:column.field,col:column,groupPriority:column.grouping.groupPriority,grouping:column.grouping}),column.treeAggregation&&column.treeAggregation.type&&aggregateArray.push({field:column.field,col:column,aggregation:column.treeAggregation})}),groupArray.sort(function(a,b){return a.groupPriority-b.groupPriority}),groupArray.forEach(function(group,index){group.grouping.groupPriority=index,group.groupPriority=index,delete group.grouping}),{grouping:groupArray,aggregations:aggregateArray}},insertGroupHeader:function(grid,renderableRows,rowIndex,processingState,stateIndex){var col=(processingState[stateIndex].fieldName,processingState[stateIndex].col),newValue=grid.getCellValue(renderableRows[rowIndex],col),newDisplayValue=newValue;"undefined"!=typeof newValue&&null!==newValue||(newDisplayValue=grid.options.groupingNullLabel);for(var getKeyAsValueForCacheMap=function(key){return angular.isObject(key)?JSON.stringify(key):key},cacheItem=grid.grouping.oldGroupingHeaderCache,i=0;i<stateIndex;i++)cacheItem&&cacheItem[getKeyAsValueForCacheMap(processingState[i].currentValue)]&&(cacheItem=cacheItem[getKeyAsValueForCacheMap(processingState[i].currentValue)].children);var headerRow;for(cacheItem&&cacheItem[getKeyAsValueForCacheMap(newValue)]?(headerRow=cacheItem[getKeyAsValueForCacheMap(newValue)].row,headerRow.entity={}):(headerRow=new GridRow({},null,grid),gridClassFactory.rowTemplateAssigner.call(grid,headerRow)),headerRow.entity["$$"+processingState[stateIndex].col.uid]={groupVal:newDisplayValue},headerRow.treeLevel=stateIndex,headerRow.groupHeader=!0,headerRow.internalRow=!0,headerRow.enableCellEdit=!1,headerRow.enableSelection=grid.options.enableGroupHeaderSelection,processingState[stateIndex].initialised=!0,processingState[stateIndex].currentValue=newValue,processingState[stateIndex].currentRow=headerRow,service.finaliseProcessingState(processingState,stateIndex+1),renderableRows.splice(rowIndex,0,headerRow),cacheItem=grid.grouping.groupingHeaderCache,i=0;i<stateIndex;i++)cacheItem=cacheItem[getKeyAsValueForCacheMap(processingState[i].currentValue)].children;cacheItem[getKeyAsValueForCacheMap(newValue)]={row:headerRow,children:{}}},finaliseProcessingState:function(processingState,stateIndex){for(var i=stateIndex;i<processingState.length;i++)processingState[i].initialised=!1,processingState[i].currentRow=null,processingState[i].currentValue=null},getRowExpandedStates:function(treeChildren){if("undefined"==typeof treeChildren)return{};var newChildren={};return angular.forEach(treeChildren,function(value,key){newChildren[key]={state:value.row.treeNode.state},value.children?newChildren[key].children=service.getRowExpandedStates(value.children):newChildren[key].children={}}),newChildren},applyRowExpandedStates:function(currentNode,expandedStates){"undefined"!=typeof expandedStates&&angular.forEach(expandedStates,function(value,key){currentNode[key]&&(currentNode[key].row.treeNode.state=value.state,value.children&&currentNode[key].children&&service.applyRowExpandedStates(currentNode[key].children,value.children))})}};return service}]),module.directive("uiGridGrouping",["uiGridGroupingConstants","uiGridGroupingService","$templateCache",function(uiGridGroupingConstants,uiGridGroupingService,$templateCache){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridCtrl.grid.options.enableGrouping!==!1&&uiGridGroupingService.initializeGrid(uiGridCtrl.grid,$scope)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}])}(),function(){var module=angular.module("ui.grid.importer",["ui.grid"]);module.constant("uiGridImporterConstants",{featureName:"importer"}),module.service("uiGridImporterService",["$q","uiGridConstants","uiGridImporterConstants","gridUtil","$compile","$interval","i18nService","$window",function($q,uiGridConstants,uiGridImporterConstants,gridUtil,$compile,$interval,i18nService,$window){var service={initializeGrid:function($scope,grid){grid.importer={$scope:$scope},this.defaultGridOptions(grid.options);var publicApi={events:{importer:{}},methods:{importer:{importFile:function(fileObject){service.importThisFile(grid,fileObject)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods),grid.options.enableImporter&&grid.options.importerShowMenu&&(grid.api.core.addToGridMenu?service.addToMenu(grid):$interval(function(){grid.api.core.addToGridMenu&&service.addToMenu(grid)},100,1))},defaultGridOptions:function(gridOptions){gridOptions.enableImporter||void 0===gridOptions.enableImporter?$window.hasOwnProperty("File")&&$window.hasOwnProperty("FileReader")&&$window.hasOwnProperty("FileList")&&$window.hasOwnProperty("Blob")?gridOptions.enableImporter=!0:(gridUtil.logError("The File APIs are not fully supported in this browser, grid importer cannot be used."),gridOptions.enableImporter=!1):gridOptions.enableImporter=!1,gridOptions.importerProcessHeaders=gridOptions.importerProcessHeaders||service.processHeaders,gridOptions.importerHeaderFilter=gridOptions.importerHeaderFilter||function(displayName){return displayName},gridOptions.importerErrorCallback&&"function"==typeof gridOptions.importerErrorCallback||delete gridOptions.importerErrorCallback,gridOptions.enableImporter!==!0||gridOptions.importerDataAddCallback||(gridUtil.logError("You have not set an importerDataAddCallback, importer is disabled"),gridOptions.enableImporter=!1),gridOptions.importerShowMenu=gridOptions.importerShowMenu!==!1,gridOptions.importerObjectCallback=gridOptions.importerObjectCallback||function(grid,newObject){return newObject}},addToMenu:function(grid){grid.api.core.addToGridMenu(grid,[{title:i18nService.getSafeText("gridMenu.importerTitle"),order:150},{templateUrl:"ui-grid/importerMenuItemContainer",action:function($event){this.grid.api.importer.importAFile(grid)},order:151}])},importThisFile:function(grid,fileObject){if(!fileObject)return void gridUtil.logError("No file object provided to importThisFile, should be impossible, aborting");var reader=new FileReader;switch(fileObject.type){case"application/json":reader.onload=service.importJsonClosure(grid);break;default:reader.onload=service.importCsvClosure(grid)}reader.readAsText(fileObject)},importJsonClosure:function(grid){return function(importFile){var newObject,newObjects=[],importArray=service.parseJson(grid,importFile);null!==importArray&&(importArray.forEach(function(value,index){newObject=service.newObject(grid),angular.extend(newObject,value),newObject=grid.options.importerObjectCallback(grid,newObject),newObjects.push(newObject)}),service.addObjects(grid,newObjects))}},parseJson:function(grid,importFile){var loadedObjects;try{loadedObjects=JSON.parse(importFile.target.result)}catch(e){return void service.alertError(grid,"importer.invalidJson","File could not be processed, is it valid json? Content was: ",importFile.target.result)}return Array.isArray(loadedObjects)?loadedObjects:(service.alertError(grid,"importer.jsonNotarray","Import failed, file is not an array, file was: ",importFile.target.result),[])},importCsvClosure:function(grid){return function(importFile){var importArray=service.parseCsv(importFile);if(!importArray||importArray.length<1)return void service.alertError(grid,"importer.invalidCsv","File could not be processed, is it valid csv? Content was: ",importFile.target.result);var newObjects=service.createCsvObjects(grid,importArray);return newObjects&&0!==newObjects.length?void service.addObjects(grid,newObjects):void service.alertError(grid,"importer.noObjects","Objects were not able to be derived, content was: ",importFile.target.result)}},parseCsv:function(importFile){var csv=importFile.target.result;return CSV.parse(csv)},createCsvObjects:function(grid,importArray){var headerMapping=grid.options.importerProcessHeaders(grid,importArray.shift());if(!headerMapping||0===headerMapping.length)return service.alertError(grid,"importer.noHeaders","Column names could not be derived, content was: ",importArray),[];var newObject,newObjects=[];return importArray.forEach(function(row,index){newObject=service.newObject(grid),null!==row&&row.forEach(function(field,index){null!==headerMapping[index]&&(newObject[headerMapping[index]]=field)}),newObject=grid.options.importerObjectCallback(grid,newObject),newObjects.push(newObject)}),newObjects},processHeaders:function(grid,headerRow){var headers=[];if(grid.options.columnDefs&&0!==grid.options.columnDefs.length){var lookupHash=service.flattenColumnDefs(grid,grid.options.columnDefs);return headerRow.forEach(function(value,index){lookupHash[value]?headers.push(lookupHash[value]):lookupHash[value.toLowerCase()]?headers.push(lookupHash[value.toLowerCase()]):headers.push(null)}),headers}return headerRow.forEach(function(value,index){headers.push(value.replace(/[^0-9a-zA-Z\-_]/g,"_"))}),headers},flattenColumnDefs:function(grid,columnDefs){var flattenedHash={};return columnDefs.forEach(function(columnDef,index){columnDef.name&&(flattenedHash[columnDef.name]=columnDef.field||columnDef.name,flattenedHash[columnDef.name.toLowerCase()]=columnDef.field||columnDef.name),columnDef.field&&(flattenedHash[columnDef.field]=columnDef.field||columnDef.name,flattenedHash[columnDef.field.toLowerCase()]=columnDef.field||columnDef.name),columnDef.displayName&&(flattenedHash[columnDef.displayName]=columnDef.field||columnDef.name,flattenedHash[columnDef.displayName.toLowerCase()]=columnDef.field||columnDef.name),columnDef.displayName&&grid.options.importerHeaderFilter&&(flattenedHash[grid.options.importerHeaderFilter(columnDef.displayName)]=columnDef.field||columnDef.name,flattenedHash[grid.options.importerHeaderFilter(columnDef.displayName).toLowerCase()]=columnDef.field||columnDef.name)}),flattenedHash},addObjects:function(grid,newObjects,$scope){if(grid.api.rowEdit){var dataChangeDereg=grid.registerDataChangeCallback(function(){grid.api.rowEdit.setRowsDirty(newObjects),dataChangeDereg()},[uiGridConstants.dataChange.ROW]);grid.importer.$scope.$on("$destroy",dataChangeDereg)}grid.importer.$scope.$apply(grid.options.importerDataAddCallback(grid,newObjects))},newObject:function(grid){return"undefined"!=typeof grid.options&&"undefined"!=typeof grid.options.importerNewObject?new grid.options.importerNewObject:{}},alertError:function(grid,alertI18nToken,consoleMessage,context){grid.options.importerErrorCallback?grid.options.importerErrorCallback(grid,alertI18nToken,consoleMessage,context):($window.alert(i18nService.getSafeText(alertI18nToken)),gridUtil.logError(consoleMessage+context))}};return service}]),module.directive("uiGridImporter",["uiGridImporterConstants","uiGridImporterService","gridUtil","$compile",function(uiGridImporterConstants,uiGridImporterService,gridUtil,$compile){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,link:function($scope,$elm,$attrs,uiGridCtrl){uiGridImporterService.initializeGrid($scope,uiGridCtrl.grid)}}}]),module.directive("uiGridImporterMenuItem",["uiGridImporterConstants","uiGridImporterService","gridUtil","$compile",function(uiGridImporterConstants,uiGridImporterService,gridUtil,$compile){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,templateUrl:"ui-grid/importerMenuItem",link:function($scope,$elm,$attrs,uiGridCtrl){var handleFileSelect=function(event){var target=event.srcElement||event.target;if(target&&target.files&&1===target.files.length){var fileObject=target.files[0];uiGridImporterService.importThisFile(grid,fileObject),target.form.reset()}},fileChooser=$elm[0].querySelectorAll(".ui-grid-importer-file-chooser"),grid=uiGridCtrl.grid;1!==fileChooser.length?gridUtil.logError("Found > 1 or < 1 file choosers within the menu item, error, cannot continue"):fileChooser[0].addEventListener("change",handleFileSelect,!1)}}}])}(),function(){var module=angular.module("ui.grid.infiniteScroll",["ui.grid"]);module.service("uiGridInfiniteScrollService",["gridUtil","$compile","$timeout","uiGridConstants","ScrollEvent","$q",function(gridUtil,$compile,$timeout,uiGridConstants,ScrollEvent,$q){var service={initializeGrid:function(grid,$scope){if(service.defaultGridOptions(grid.options),grid.options.enableInfiniteScroll){grid.infiniteScroll={dataLoading:!1},service.setScrollDirections(grid,grid.options.infiniteScrollUp,grid.options.infiniteScrollDown),grid.api.core.on.scrollEnd($scope,service.handleScroll);var publicApi={events:{infiniteScroll:{needLoadMoreData:function($scope,fn){},needLoadMoreDataTop:function($scope,fn){}}},methods:{infiniteScroll:{dataLoaded:function(scrollUp,scrollDown){service.setScrollDirections(grid,scrollUp,scrollDown);var promise=service.adjustScroll(grid).then(function(){grid.infiniteScroll.dataLoading=!1});return promise},resetScroll:function(scrollUp,scrollDown){return service.setScrollDirections(grid,scrollUp,scrollDown),service.adjustInfiniteScrollPosition(grid,0)},saveScrollPercentage:function(){grid.infiniteScroll.prevScrollTop=grid.renderContainers.body.prevScrollTop,grid.infiniteScroll.previousVisibleRows=grid.getVisibleRowCount()},dataRemovedTop:function(scrollUp,scrollDown){service.dataRemovedTop(grid,scrollUp,scrollDown)},dataRemovedBottom:function(scrollUp,scrollDown){service.dataRemovedBottom(grid,scrollUp,scrollDown)},setScrollDirections:function(scrollUp,scrollDown){service.setScrollDirections(grid,scrollUp,scrollDown)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)}},defaultGridOptions:function(gridOptions){gridOptions.enableInfiniteScroll=gridOptions.enableInfiniteScroll!==!1,gridOptions.infiniteScrollRowsFromEnd=gridOptions.infiniteScrollRowsFromEnd||20,gridOptions.infiniteScrollUp=gridOptions.infiniteScrollUp===!0,gridOptions.infiniteScrollDown=gridOptions.infiniteScrollDown!==!1},setScrollDirections:function(grid,scrollUp,scrollDown){grid.infiniteScroll.scrollUp=scrollUp===!0,grid.suppressParentScrollUp=scrollUp===!0,grid.infiniteScroll.scrollDown=scrollDown!==!1,grid.suppressParentScrollDown=scrollDown!==!1},handleScroll:function(args){if(!(args.grid.infiniteScroll&&args.grid.infiniteScroll.dataLoading||"ui.grid.adjustInfiniteScrollPosition"===args.source)&&args.y)if(0===args.y.percentage)args.grid.scrollDirection=uiGridConstants.scrollDirection.UP,service.loadData(args.grid);else if(1===args.y.percentage)args.grid.scrollDirection=uiGridConstants.scrollDirection.DOWN,service.loadData(args.grid);else{var percentage,targetPercentage=args.grid.options.infiniteScrollRowsFromEnd/args.grid.renderContainers.body.visibleRowCache.length;args.grid.scrollDirection===uiGridConstants.scrollDirection.UP?(percentage=args.y.percentage,percentage<=targetPercentage&&service.loadData(args.grid)):args.grid.scrollDirection===uiGridConstants.scrollDirection.DOWN&&(percentage=1-args.y.percentage,percentage<=targetPercentage&&service.loadData(args.grid))}},loadData:function(grid){grid.infiniteScroll.previousVisibleRows=grid.renderContainers.body.visibleRowCache.length,grid.infiniteScroll.direction=grid.scrollDirection,delete grid.infiniteScroll.prevScrollTop,grid.scrollDirection===uiGridConstants.scrollDirection.UP&&grid.infiniteScroll.scrollUp?(grid.infiniteScroll.dataLoading=!0,grid.api.infiniteScroll.raise.needLoadMoreDataTop()):grid.scrollDirection===uiGridConstants.scrollDirection.DOWN&&grid.infiniteScroll.scrollDown&&(grid.infiniteScroll.dataLoading=!0,grid.api.infiniteScroll.raise.needLoadMoreData())},adjustScroll:function(grid){var promise=$q.defer();return $timeout(function(){var viewportHeight,rowHeight,newVisibleRows,oldTop,newTop;viewportHeight=grid.getViewportHeight()+grid.headerHeight-grid.renderContainers.body.headerHeight-grid.scrollbarHeight,rowHeight=grid.options.rowHeight,void 0===grid.infiniteScroll.direction&&service.adjustInfiniteScrollPosition(grid,0),newVisibleRows=grid.getVisibleRowCount();var canvasHeight=rowHeight*newVisibleRows;grid.infiniteScroll.scrollDown&&viewportHeight>canvasHeight&&grid.api.infiniteScroll.raise.needLoadMoreData(),grid.infiniteScroll.direction===uiGridConstants.scrollDirection.UP&&(oldTop=grid.infiniteScroll.prevScrollTop||0,newTop=oldTop+(newVisibleRows-grid.infiniteScroll.previousVisibleRows)*rowHeight,service.adjustInfiniteScrollPosition(grid,newTop),$timeout(function(){promise.resolve()})),grid.infiniteScroll.direction===uiGridConstants.scrollDirection.DOWN&&(newTop=grid.infiniteScroll.prevScrollTop||grid.infiniteScroll.previousVisibleRows*rowHeight-viewportHeight,service.adjustInfiniteScrollPosition(grid,newTop),$timeout(function(){promise.resolve()}))},0),promise.promise},adjustInfiniteScrollPosition:function(grid,scrollTop){var scrollEvent=new ScrollEvent(grid,null,null,"ui.grid.adjustInfiniteScrollPosition"),visibleRows=grid.getVisibleRowCount(),viewportHeight=grid.getViewportHeight()+grid.headerHeight-grid.renderContainers.body.headerHeight-grid.scrollbarHeight,rowHeight=grid.options.rowHeight,scrollHeight=visibleRows*rowHeight-viewportHeight;0===scrollTop&&grid.infiniteScroll.scrollUp?scrollEvent.y={percentage:1/scrollHeight}:scrollEvent.y={percentage:scrollTop/scrollHeight},grid.scrollContainers("",scrollEvent)},dataRemovedTop:function(grid,scrollUp,scrollDown){var newVisibleRows,oldTop,newTop,rowHeight;return service.setScrollDirections(grid,scrollUp,scrollDown),newVisibleRows=grid.renderContainers.body.visibleRowCache.length,oldTop=grid.infiniteScroll.prevScrollTop,rowHeight=grid.options.rowHeight,newTop=oldTop-(grid.infiniteScroll.previousVisibleRows-newVisibleRows)*rowHeight,service.adjustInfiniteScrollPosition(grid,newTop)},dataRemovedBottom:function(grid,scrollUp,scrollDown){var newTop;return service.setScrollDirections(grid,scrollUp,scrollDown),newTop=grid.infiniteScroll.prevScrollTop,service.adjustInfiniteScrollPosition(grid,newTop)}};return service}]),module.directive("uiGridInfiniteScroll",["uiGridInfiniteScrollService",function(uiGridInfiniteScrollService){return{priority:-200,scope:!1,require:"^uiGrid",compile:function($scope,$elm,$attr){return{pre:function($scope,$elm,$attr,uiGridCtrl){uiGridInfiniteScrollService.initializeGrid(uiGridCtrl.grid,$scope)},post:function($scope,$elm,$attr){}}}}}])}(),function(){var module=angular.module("ui.grid.moveColumns",["ui.grid"]);module.service("uiGridMoveColumnService",["$q","$timeout","$log","ScrollEvent","uiGridConstants","gridUtil",function($q,$timeout,$log,ScrollEvent,uiGridConstants,gridUtil){var service={initializeGrid:function(grid){var self=this;this.registerPublicApi(grid),this.defaultGridOptions(grid.options),grid.moveColumns={orderCache:[]},grid.registerColumnBuilder(self.movableColumnBuilder),grid.registerDataChangeCallback(self.verifyColumnOrder,[uiGridConstants.dataChange.COLUMN])},registerPublicApi:function(grid){var self=this,publicApi={events:{colMovable:{columnPositionChanged:function(colDef,originalPosition,newPosition){}}},methods:{colMovable:{moveColumn:function(originalPosition,finalPosition){var columns=grid.columns;if(!angular.isNumber(originalPosition)||!angular.isNumber(finalPosition))return void gridUtil.logError("MoveColumn: Please provide valid values for originalPosition and finalPosition");for(var nonMovableColumns=0,i=0;i<columns.length;i++)(angular.isDefined(columns[i].colDef.visible)&&columns[i].colDef.visible===!1||columns[i].isRowHeader===!0)&&nonMovableColumns++;if(originalPosition>=columns.length-nonMovableColumns||finalPosition>=columns.length-nonMovableColumns)return void gridUtil.logError("MoveColumn: Invalid values for originalPosition, finalPosition");var findPositionForRenderIndex=function(index){for(var position=index,i=0;i<=position;i++)angular.isDefined(columns[i])&&(angular.isDefined(columns[i].colDef.visible)&&columns[i].colDef.visible===!1||columns[i].isRowHeader===!0)&&position++;return position};self.redrawColumnAtPosition(grid,findPositionForRenderIndex(originalPosition),findPositionForRenderIndex(finalPosition))}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},defaultGridOptions:function(gridOptions){gridOptions.enableColumnMoving=gridOptions.enableColumnMoving!==!1},movableColumnBuilder:function(colDef,col,gridOptions){var promises=[];return colDef.enableColumnMoving=void 0===colDef.enableColumnMoving?gridOptions.enableColumnMoving:colDef.enableColumnMoving,$q.all(promises)},updateColumnCache:function(grid){grid.moveColumns.orderCache=grid.getOnlyDataColumns()},verifyColumnOrder:function(grid){var newIndex,headerRowOffset=grid.rowHeaderColumns.length;angular.forEach(grid.moveColumns.orderCache,function(cacheCol,cacheIndex){if(newIndex=grid.columns.indexOf(cacheCol),newIndex!==-1&&newIndex-headerRowOffset!==cacheIndex){var column=grid.columns.splice(newIndex,1)[0];grid.columns.splice(cacheIndex+headerRowOffset,0,column)}})},redrawColumnAtPosition:function(grid,originalPosition,newPosition){var columns=grid.columns;if(originalPosition!==newPosition){var pos=originalPosition<newPosition?originalPosition+1:originalPosition-1,i0=Math.min(pos,newPosition);for(i0;i0<=Math.max(pos,newPosition)&&!columns[i0].visible;i0++);if(!(i0>Math.max(pos,newPosition))){var originalColumn=columns[originalPosition];if(originalColumn.colDef.enableColumnMoving){if(originalPosition>newPosition)for(var i1=originalPosition;i1>newPosition;i1--)columns[i1]=columns[i1-1];else if(newPosition>originalPosition)for(var i2=originalPosition;i2<newPosition;i2++)columns[i2]=columns[i2+1];columns[newPosition]=originalColumn,service.updateColumnCache(grid),grid.queueGridRefresh(),$timeout(function(){grid.api.core.notifyDataChange(uiGridConstants.dataChange.COLUMN),grid.api.colMovable.raise.columnPositionChanged(originalColumn.colDef,originalPosition,newPosition)})}}}}};return service}]),module.directive("uiGridMoveColumns",["uiGridMoveColumnService",function(uiGridMoveColumnService){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridMoveColumnService.initializeGrid(uiGridCtrl.grid)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}]),module.directive("uiGridHeaderCell",["$q","gridUtil","uiGridMoveColumnService","$document","$log","uiGridConstants","ScrollEvent",function($q,gridUtil,uiGridMoveColumnService,$document,$log,uiGridConstants,ScrollEvent){return{priority:-10,require:"^uiGrid",compile:function(){return{post:function($scope,$elm,$attrs,uiGridCtrl){if($scope.col.colDef.enableColumnMoving){var gridLeft,previousMouseX,totalMouseMovement,rightMoveLimit,movingElm,reducedWidth,$contentsElm=angular.element($elm[0].querySelectorAll(".ui-grid-cell-contents")),elmCloned=!1,moveOccurred=!1,downFn=function(event){gridLeft=$scope.grid.element[0].getBoundingClientRect().left,$scope.grid.hasLeftContainer()&&(gridLeft+=$scope.grid.renderContainers.left.header[0].getBoundingClientRect().width),previousMouseX=event.pageX||(event.originalEvent?event.originalEvent.pageX:0),totalMouseMovement=0,rightMoveLimit=gridLeft+$scope.grid.getViewportWidth(),"mousedown"===event.type?($document.on("mousemove",moveFn),$document.on("mouseup",upFn)):"touchstart"===event.type&&($document.on("touchmove",moveFn),$document.on("touchend",upFn))},moveFn=function(event){var pageX=event.pageX||(event.originalEvent?event.originalEvent.pageX:0),changeValue=pageX-previousMouseX;0!==changeValue&&(document.onselectstart=function(){
return!1},moveOccurred=!0,elmCloned?elmCloned&&(moveElement(changeValue),previousMouseX=pageX):cloneElement())},upFn=function(event){if(document.onselectstart=null,movingElm&&(movingElm.remove(),elmCloned=!1),offAllEvents(),onDownEvents(),moveOccurred){for(var columns=$scope.grid.columns,columnIndex=0,i=0;i<columns.length&&columns[i].colDef.name!==$scope.col.colDef.name;i++)columnIndex++;var targetIndex;if(totalMouseMovement<0){var il,totalColumnsLeftWidth=0;if($scope.grid.isRTL()){for(il=columnIndex+1;il<columns.length;il++)if((angular.isUndefined(columns[il].colDef.visible)||columns[il].colDef.visible===!0)&&(totalColumnsLeftWidth+=columns[il].drawnWidth||columns[il].width||columns[il].colDef.width,totalColumnsLeftWidth>Math.abs(totalMouseMovement))){uiGridMoveColumnService.redrawColumnAtPosition($scope.grid,columnIndex,il-1);break}}else for(il=columnIndex-1;il>=0;il--)if((angular.isUndefined(columns[il].colDef.visible)||columns[il].colDef.visible===!0)&&(totalColumnsLeftWidth+=columns[il].drawnWidth||columns[il].width||columns[il].colDef.width,totalColumnsLeftWidth>Math.abs(totalMouseMovement))){uiGridMoveColumnService.redrawColumnAtPosition($scope.grid,columnIndex,il+1);break}totalColumnsLeftWidth<Math.abs(totalMouseMovement)&&(targetIndex=0,$scope.grid.isRTL()&&(targetIndex=columns.length-1),uiGridMoveColumnService.redrawColumnAtPosition($scope.grid,columnIndex,targetIndex))}else if(totalMouseMovement>0){var ir,totalColumnsRightWidth=0;if($scope.grid.isRTL()){for(ir=columnIndex-1;ir>0;ir--)if((angular.isUndefined(columns[ir].colDef.visible)||columns[ir].colDef.visible===!0)&&(totalColumnsRightWidth+=columns[ir].drawnWidth||columns[ir].width||columns[ir].colDef.width,totalColumnsRightWidth>totalMouseMovement)){uiGridMoveColumnService.redrawColumnAtPosition($scope.grid,columnIndex,ir);break}}else for(ir=columnIndex+1;ir<columns.length;ir++)if((angular.isUndefined(columns[ir].colDef.visible)||columns[ir].colDef.visible===!0)&&(totalColumnsRightWidth+=columns[ir].drawnWidth||columns[ir].width||columns[ir].colDef.width,totalColumnsRightWidth>totalMouseMovement)){uiGridMoveColumnService.redrawColumnAtPosition($scope.grid,columnIndex,ir-1);break}totalColumnsRightWidth<totalMouseMovement&&(targetIndex=columns.length-1,$scope.grid.isRTL()&&(targetIndex=0),uiGridMoveColumnService.redrawColumnAtPosition($scope.grid,columnIndex,targetIndex))}}},onDownEvents=function(){$contentsElm.on("touchstart",downFn),$contentsElm.on("mousedown",downFn)},offAllEvents=function(){$contentsElm.off("touchstart",downFn),$contentsElm.off("mousedown",downFn),$document.off("mousemove",moveFn),$document.off("touchmove",moveFn),$document.off("mouseup",upFn),$document.off("touchend",upFn)};onDownEvents();var cloneElement=function(){elmCloned=!0,movingElm=$elm.clone(),$elm.parent().append(movingElm),movingElm.addClass("movingColumn");var movingElementStyles={};movingElementStyles.left=$elm[0].offsetLeft+"px";var gridRight=$scope.grid.element[0].getBoundingClientRect().right,elmRight=$elm[0].getBoundingClientRect().right;elmRight>gridRight&&(reducedWidth=$scope.col.drawnWidth+(gridRight-elmRight),movingElementStyles.width=reducedWidth+"px"),movingElm.css(movingElementStyles)},moveElement=function(changeValue){for(var columns=$scope.grid.columns,totalColumnWidth=0,i=0;i<columns.length;i++)(angular.isUndefined(columns[i].colDef.visible)||columns[i].colDef.visible===!0)&&(totalColumnWidth+=columns[i].drawnWidth||columns[i].width||columns[i].colDef.width);var newElementLeft,currentElmLeft=movingElm[0].getBoundingClientRect().left-1,currentElmRight=movingElm[0].getBoundingClientRect().right;if(newElementLeft=currentElmLeft-gridLeft+changeValue,newElementLeft=newElementLeft<rightMoveLimit?newElementLeft:rightMoveLimit,(currentElmLeft>=gridLeft||changeValue>0)&&(currentElmRight<=rightMoveLimit||changeValue<0))movingElm.css({visibility:"visible",left:movingElm[0].offsetLeft+(newElementLeft<rightMoveLimit?changeValue:rightMoveLimit-currentElmLeft)+"px"});else if(totalColumnWidth>Math.ceil(uiGridCtrl.grid.gridWidth)){changeValue*=8;var scrollEvent=new ScrollEvent($scope.col.grid,null,null,"uiGridHeaderCell.moveElement");scrollEvent.x={pixels:changeValue},scrollEvent.grid.scrollContainers("",scrollEvent)}for(var totalColumnsLeftWidth=0,il=0;il<columns.length;il++)if(angular.isUndefined(columns[il].colDef.visible)||columns[il].colDef.visible===!0){if(columns[il].colDef.name===$scope.col.colDef.name)break;totalColumnsLeftWidth+=columns[il].drawnWidth||columns[il].width||columns[il].colDef.width}void 0===$scope.newScrollLeft?totalMouseMovement+=changeValue:totalMouseMovement=$scope.newScrollLeft+newElementLeft-totalColumnsLeftWidth,reducedWidth<$scope.col.drawnWidth&&(reducedWidth+=Math.abs(changeValue),movingElm.css({width:reducedWidth+"px"}))}}}}}}}])}(),function(){var module=angular.module("ui.grid.pagination",["ng","ui.grid"]);module.service("uiGridPaginationService",["gridUtil",function(gridUtil){var service={initializeGrid:function(grid){service.defaultGridOptions(grid.options);var publicApi={events:{pagination:{paginationChanged:function(currentPage,pageSize){}}},methods:{pagination:{getPage:function(){return grid.options.enablePagination?grid.options.paginationCurrentPage:null},getTotalPages:function(){return grid.options.enablePagination?0===grid.options.totalItems?1:Math.ceil(grid.options.totalItems/grid.options.paginationPageSize):null},nextPage:function(){grid.options.enablePagination&&(grid.options.totalItems>0?grid.options.paginationCurrentPage=Math.min(grid.options.paginationCurrentPage+1,publicApi.methods.pagination.getTotalPages()):grid.options.paginationCurrentPage++)},previousPage:function(){grid.options.enablePagination&&(grid.options.paginationCurrentPage=Math.max(grid.options.paginationCurrentPage-1,1))},seek:function(page){if(grid.options.enablePagination){if(!angular.isNumber(page)||page<1)throw"Invalid page number: "+page;grid.options.paginationCurrentPage=Math.min(page,publicApi.methods.pagination.getTotalPages())}}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods);var processPagination=function(renderableRows){if(grid.options.useExternalPagination||!grid.options.enablePagination)return renderableRows;var pageSize=parseInt(grid.options.paginationPageSize,10),currentPage=parseInt(grid.options.paginationCurrentPage,10),visibleRows=renderableRows.filter(function(row){return row.visible});grid.options.totalItems=visibleRows.length;var firstRow=(currentPage-1)*pageSize;return firstRow>visibleRows.length&&(currentPage=grid.options.paginationCurrentPage=1,firstRow=(currentPage-1)*pageSize),visibleRows.slice(firstRow,firstRow+pageSize)};grid.registerRowsProcessor(processPagination,900)},defaultGridOptions:function(gridOptions){gridOptions.enablePagination=gridOptions.enablePagination!==!1,gridOptions.enablePaginationControls=gridOptions.enablePaginationControls!==!1,gridOptions.useExternalPagination=gridOptions.useExternalPagination===!0,gridUtil.isNullOrUndefined(gridOptions.totalItems)&&(gridOptions.totalItems=0),gridUtil.isNullOrUndefined(gridOptions.paginationPageSizes)&&(gridOptions.paginationPageSizes=[250,500,1e3]),gridUtil.isNullOrUndefined(gridOptions.paginationPageSize)&&(gridOptions.paginationPageSizes.length>0?gridOptions.paginationPageSize=gridOptions.paginationPageSizes[0]:gridOptions.paginationPageSize=0),gridUtil.isNullOrUndefined(gridOptions.paginationCurrentPage)&&(gridOptions.paginationCurrentPage=1),gridUtil.isNullOrUndefined(gridOptions.paginationTemplate)&&(gridOptions.paginationTemplate="ui-grid/pagination")},onPaginationChanged:function(grid,currentPage,pageSize){grid.api.pagination.raise.paginationChanged(currentPage,pageSize),grid.options.useExternalPagination||grid.queueGridRefresh()}};return service}]),module.directive("uiGridPagination",["gridUtil","uiGridPaginationService",function(gridUtil,uiGridPaginationService){return{priority:-200,scope:!1,require:"uiGrid",link:{pre:function($scope,$elm,$attr,uiGridCtrl){uiGridPaginationService.initializeGrid(uiGridCtrl.grid),gridUtil.getTemplate(uiGridCtrl.grid.options.paginationTemplate).then(function(contents){var template=angular.element(contents);$elm.append(template),uiGridCtrl.innerCompile(template)})}}}}]),module.directive("uiGridPager",["uiGridPaginationService","uiGridConstants","gridUtil","i18nService",function(uiGridPaginationService,uiGridConstants,gridUtil,i18nService){return{priority:-200,scope:!0,require:"^uiGrid",link:function($scope,$elm,$attr,uiGridCtrl){var defaultFocusElementSelector=".ui-grid-pager-control-input";$scope.aria=i18nService.getSafeText("pagination.aria"),$scope.paginationApi=uiGridCtrl.grid.api.pagination,$scope.sizesLabel=i18nService.getSafeText("pagination.sizes"),$scope.totalItemsLabel=i18nService.getSafeText("pagination.totalItems"),$scope.paginationOf=i18nService.getSafeText("pagination.of"),$scope.paginationThrough=i18nService.getSafeText("pagination.through");var options=uiGridCtrl.grid.options;uiGridCtrl.grid.renderContainers.body.registerViewportAdjuster(function(adjustment){return adjustment.height=adjustment.height-gridUtil.elementHeight($elm,"padding"),adjustment});var dataChangeDereg=uiGridCtrl.grid.registerDataChangeCallback(function(grid){grid.options.useExternalPagination||(grid.options.totalItems=grid.rows.length)},[uiGridConstants.dataChange.ROW]);$scope.$on("$destroy",dataChangeDereg);var setShowing=function(){$scope.showingLow=(options.paginationCurrentPage-1)*options.paginationPageSize+1,$scope.showingHigh=Math.min(options.paginationCurrentPage*options.paginationPageSize,options.totalItems)},deregT=$scope.$watch("grid.options.totalItems + grid.options.paginationPageSize",setShowing),deregP=$scope.$watch("grid.options.paginationCurrentPage + grid.options.paginationPageSize",function(newValues,oldValues){if(newValues!==oldValues&&void 0!==oldValues){if(!angular.isNumber(options.paginationCurrentPage)||options.paginationCurrentPage<1)return void(options.paginationCurrentPage=1);if(options.totalItems>0&&options.paginationCurrentPage>$scope.paginationApi.getTotalPages())return void(options.paginationCurrentPage=$scope.paginationApi.getTotalPages());setShowing(),uiGridPaginationService.onPaginationChanged($scope.grid,options.paginationCurrentPage,options.paginationPageSize)}});$scope.$on("$destroy",function(){deregT(),deregP()}),$scope.cantPageForward=function(){return options.totalItems>0?options.paginationCurrentPage>=$scope.paginationApi.getTotalPages():options.data.length<1},$scope.cantPageToLast=function(){return!(options.totalItems>0)||$scope.cantPageForward()},$scope.cantPageBackward=function(){return options.paginationCurrentPage<=1};var focusToInputIf=function(condition){condition&&gridUtil.focus.bySelector($elm,defaultFocusElementSelector)};$scope.pageFirstPageClick=function(){$scope.paginationApi.seek(1),focusToInputIf($scope.cantPageBackward())},$scope.pagePreviousPageClick=function(){$scope.paginationApi.previousPage(),focusToInputIf($scope.cantPageBackward())},$scope.pageNextPageClick=function(){$scope.paginationApi.nextPage(),focusToInputIf($scope.cantPageForward())},$scope.pageLastPageClick=function(){$scope.paginationApi.seek($scope.paginationApi.getTotalPages()),focusToInputIf($scope.cantPageToLast())}}}}])}(),function(){var module=angular.module("ui.grid.pinning",["ui.grid"]);module.constant("uiGridPinningConstants",{container:{LEFT:"left",RIGHT:"right",NONE:""}}),module.service("uiGridPinningService",["gridUtil","GridRenderContainer","i18nService","uiGridPinningConstants",function(gridUtil,GridRenderContainer,i18nService,uiGridPinningConstants){var service={initializeGrid:function(grid){service.defaultGridOptions(grid.options),grid.registerColumnBuilder(service.pinningColumnBuilder);var publicApi={events:{pinning:{columnPinned:function(colDef,container){}}},methods:{pinning:{pinColumn:function(col,container){service.pinColumn(grid,col,container)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},defaultGridOptions:function(gridOptions){gridOptions.enablePinning=gridOptions.enablePinning!==!1},pinningColumnBuilder:function(colDef,col,gridOptions){if(colDef.enablePinning=void 0===colDef.enablePinning?gridOptions.enablePinning:colDef.enablePinning,colDef.pinnedLeft?(col.renderContainer="left",col.grid.createLeftContainer()):colDef.pinnedRight&&(col.renderContainer="right",col.grid.createRightContainer()),colDef.enablePinning){var pinColumnLeftAction={name:"ui.grid.pinning.pinLeft",title:i18nService.get().pinning.pinLeft,icon:"ui-grid-icon-left-open",shown:function(){return"undefined"==typeof this.context.col.renderContainer||!this.context.col.renderContainer||"left"!==this.context.col.renderContainer},action:function(){service.pinColumn(this.context.col.grid,this.context.col,uiGridPinningConstants.container.LEFT)}},pinColumnRightAction={name:"ui.grid.pinning.pinRight",title:i18nService.get().pinning.pinRight,icon:"ui-grid-icon-right-open",shown:function(){return"undefined"==typeof this.context.col.renderContainer||!this.context.col.renderContainer||"right"!==this.context.col.renderContainer},action:function(){service.pinColumn(this.context.col.grid,this.context.col,uiGridPinningConstants.container.RIGHT)}},removePinAction={name:"ui.grid.pinning.unpin",title:i18nService.get().pinning.unpin,icon:"ui-grid-icon-cancel",shown:function(){return"undefined"!=typeof this.context.col.renderContainer&&null!==this.context.col.renderContainer&&"body"!==this.context.col.renderContainer},action:function(){service.pinColumn(this.context.col.grid,this.context.col,uiGridPinningConstants.container.NONE)}};gridUtil.arrayContainsObjectWithProperty(col.menuItems,"name","ui.grid.pinning.pinLeft")||col.menuItems.push(pinColumnLeftAction),gridUtil.arrayContainsObjectWithProperty(col.menuItems,"name","ui.grid.pinning.pinRight")||col.menuItems.push(pinColumnRightAction),gridUtil.arrayContainsObjectWithProperty(col.menuItems,"name","ui.grid.pinning.unpin")||col.menuItems.push(removePinAction)}},pinColumn:function(grid,col,container){container===uiGridPinningConstants.container.NONE?(col.renderContainer=null,col.colDef.pinnedLeft=col.colDef.pinnedRight=!1):(col.renderContainer=container,container===uiGridPinningConstants.container.LEFT?grid.createLeftContainer():container===uiGridPinningConstants.container.RIGHT&&grid.createRightContainer()),grid.refresh().then(function(){grid.api.pinning.raise.columnPinned(col.colDef,container)})}};return service}]),module.directive("uiGridPinning",["gridUtil","uiGridPinningService",function(gridUtil,uiGridPinningService){return{require:"uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridPinningService.initializeGrid(uiGridCtrl.grid)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}])}(),function(){var module=angular.module("ui.grid.resizeColumns",["ui.grid"]);module.service("uiGridResizeColumnsService",["gridUtil","$q","$timeout",function(gridUtil,$q,$timeout){var service={defaultGridOptions:function(gridOptions){gridOptions.enableColumnResizing=gridOptions.enableColumnResizing!==!1,gridOptions.enableColumnResize===!1&&(gridOptions.enableColumnResizing=!1)},colResizerColumnBuilder:function(colDef,col,gridOptions){var promises=[];return colDef.enableColumnResizing=void 0===colDef.enableColumnResizing?gridOptions.enableColumnResizing:colDef.enableColumnResizing,colDef.enableColumnResize===!1&&(colDef.enableColumnResizing=!1),$q.all(promises)},registerPublicApi:function(grid){var publicApi={events:{colResizable:{columnSizeChanged:function(colDef,deltaChange){}}}};grid.api.registerEventsFromObject(publicApi.events)},fireColumnSizeChanged:function(grid,colDef,deltaChange){$timeout(function(){grid.api.colResizable?grid.api.colResizable.raise.columnSizeChanged(colDef,deltaChange):gridUtil.logError("The resizeable api is not registered, this may indicate that you've included the module but not added the 'ui-grid-resize-columns' directive to your grid definition.  Cannot raise any events.")})},findTargetCol:function(col,position,rtlMultiplier){var renderContainer=col.getRenderContainer();if("left"===position){var colIndex=renderContainer.visibleColumnCache.indexOf(col);return renderContainer.visibleColumnCache[colIndex-1*rtlMultiplier]}return col}};return service}]),module.directive("uiGridResizeColumns",["gridUtil","uiGridResizeColumnsService",function(gridUtil,uiGridResizeColumnsService){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridResizeColumnsService.defaultGridOptions(uiGridCtrl.grid.options),uiGridCtrl.grid.registerColumnBuilder(uiGridResizeColumnsService.colResizerColumnBuilder),uiGridResizeColumnsService.registerPublicApi(uiGridCtrl.grid)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}]),module.directive("uiGridHeaderCell",["gridUtil","$templateCache","$compile","$q","uiGridResizeColumnsService","uiGridConstants","$timeout",function(gridUtil,$templateCache,$compile,$q,uiGridResizeColumnsService,uiGridConstants,$timeout){return{priority:-10,require:"^uiGrid",compile:function(){return{post:function($scope,$elm,$attrs,uiGridCtrl){var grid=uiGridCtrl.grid;if(grid.options.enableColumnResizing){var columnResizerElm=$templateCache.get("ui-grid/columnResizer"),rtlMultiplier=1;grid.isRTL()&&($scope.position="left",rtlMultiplier=-1);var displayResizers=function(){for(var resizers=$elm[0].getElementsByClassName("ui-grid-column-resizer"),i=0;i<resizers.length;i++)angular.element(resizers[i]).remove();var otherCol=uiGridResizeColumnsService.findTargetCol($scope.col,"left",rtlMultiplier),renderContainer=$scope.col.getRenderContainer();if(otherCol&&0!==renderContainer.visibleColumnCache.indexOf($scope.col)&&otherCol.colDef.enableColumnResizing!==!1){var resizerLeft=angular.element(columnResizerElm).clone();resizerLeft.attr("position","left"),$elm.prepend(resizerLeft),$compile(resizerLeft)($scope)}if($scope.col.colDef.enableColumnResizing!==!1){var resizerRight=angular.element(columnResizerElm).clone();resizerRight.attr("position","right"),$elm.append(resizerRight),$compile(resizerRight)($scope)}};displayResizers();var waitDisplay=function(){$timeout(displayResizers)},dataChangeDereg=grid.registerDataChangeCallback(waitDisplay,[uiGridConstants.dataChange.COLUMN]);$scope.$on("$destroy",dataChangeDereg)}}}}}}]),module.directive("uiGridColumnResizer",["$document","gridUtil","uiGridConstants","uiGridResizeColumnsService",function($document,gridUtil,uiGridConstants,uiGridResizeColumnsService){var resizeOverlay=angular.element('<div class="ui-grid-resize-overlay"></div>'),resizer={priority:0,scope:{col:"=",position:"@",renderIndex:"="},require:"?^uiGrid",link:function($scope,$elm,$attrs,uiGridCtrl){function refreshCanvas(xDiff){uiGridCtrl.grid.refreshCanvas(!0).then(function(){uiGridCtrl.grid.queueGridRefresh()})}function constrainWidth(col,width){var newWidth=width;return col.minWidth&&newWidth<col.minWidth?newWidth=col.minWidth:col.maxWidth&&newWidth>col.maxWidth&&(newWidth=col.maxWidth),newWidth}function moveFunction(event,args){event.originalEvent&&(event=event.originalEvent),event.preventDefault(),x=(event.targetTouches?event.targetTouches[0]:event).clientX-gridLeft,x<0?x=0:x>uiGridCtrl.grid.gridWidth&&(x=uiGridCtrl.grid.gridWidth);var col=uiGridResizeColumnsService.findTargetCol($scope.col,$scope.position,rtlMultiplier);if(col.colDef.enableColumnResizing!==!1){uiGridCtrl.grid.element.hasClass("column-resizing")||uiGridCtrl.grid.element.addClass("column-resizing");var xDiff=x-startX,newWidth=parseInt(col.drawnWidth+xDiff*rtlMultiplier,10);x+=(constrainWidth(col,newWidth)-newWidth)*rtlMultiplier,resizeOverlay.css({left:x+"px"}),uiGridCtrl.fireEvent(uiGridConstants.events.ITEM_DRAGGING)}}function upFunction(event,args){event.originalEvent&&(event=event.originalEvent),event.preventDefault(),uiGridCtrl.grid.element.removeClass("column-resizing"),resizeOverlay.remove(),x=(event.changedTouches?event.changedTouches[0]:event).clientX-gridLeft;var xDiff=x-startX;if(0===xDiff)return offAllEvents(),void onDownEvents();var col=uiGridResizeColumnsService.findTargetCol($scope.col,$scope.position,rtlMultiplier);if(col.colDef.enableColumnResizing!==!1){var newWidth=parseInt(col.drawnWidth+xDiff*rtlMultiplier,10);col.width=constrainWidth(col,newWidth),col.hasCustomWidth=!0,refreshCanvas(xDiff),uiGridResizeColumnsService.fireColumnSizeChanged(uiGridCtrl.grid,col.colDef,xDiff),offAllEvents(),onDownEvents()}}var startX=0,x=0,gridLeft=0,rtlMultiplier=1;uiGridCtrl.grid.isRTL()&&($scope.position="left",rtlMultiplier=-1),"left"===$scope.position?$elm.addClass("left"):"right"===$scope.position&&$elm.addClass("right");var downFunction=function(event,args){event.originalEvent&&(event=event.originalEvent),event.stopPropagation(),gridLeft=uiGridCtrl.grid.element[0].getBoundingClientRect().left,startX=(event.targetTouches?event.targetTouches[0]:event).clientX-gridLeft,uiGridCtrl.grid.element.append(resizeOverlay),resizeOverlay.css({left:startX}),"touchstart"===event.type?($document.on("touchend",upFunction),$document.on("touchmove",moveFunction),$elm.off("mousedown",downFunction)):($document.on("mouseup",upFunction),$document.on("mousemove",moveFunction),$elm.off("touchstart",downFunction))},onDownEvents=function(){$elm.on("mousedown",downFunction),$elm.on("touchstart",downFunction)},offAllEvents=function(){$document.off("mouseup",upFunction),$document.off("touchend",upFunction),$document.off("mousemove",moveFunction),$document.off("touchmove",moveFunction),$elm.off("mousedown",downFunction),$elm.off("touchstart",downFunction)};onDownEvents();var dblClickFn=function(event,args){event.stopPropagation();var col=uiGridResizeColumnsService.findTargetCol($scope.col,$scope.position,rtlMultiplier);if(col.colDef.enableColumnResizing!==!1){var maxWidth=0,xDiff=0,renderContainerElm=gridUtil.closestElm($elm,".ui-grid-render-container"),cells=renderContainerElm.querySelectorAll("."+uiGridConstants.COL_CLASS_PREFIX+col.uid+" .ui-grid-cell-contents");Array.prototype.forEach.call(cells,function(cell){var menuButton;angular.element(cell).parent().hasClass("ui-grid-header-cell")&&(menuButton=angular.element(cell).parent()[0].querySelectorAll(".ui-grid-column-menu-button")),gridUtil.fakeElement(cell,{},function(newElm){var e=angular.element(newElm);e.attr("style","float: left");var width=gridUtil.elementWidth(e);if(menuButton){var menuButtonWidth=gridUtil.elementWidth(menuButton);width+=menuButtonWidth}width>maxWidth&&(maxWidth=width,xDiff=maxWidth-width)})}),col.width=constrainWidth(col,maxWidth),col.hasCustomWidth=!0,refreshCanvas(xDiff),uiGridResizeColumnsService.fireColumnSizeChanged(uiGridCtrl.grid,col.colDef,xDiff)}};$elm.on("dblclick",dblClickFn),$elm.on("$destroy",function(){$elm.off("dblclick",dblClickFn),offAllEvents()})}};return resizer}])}(),function(){var module=angular.module("ui.grid.rowEdit",["ui.grid","ui.grid.edit","ui.grid.cellNav"]);module.constant("uiGridRowEditConstants",{}),module.service("uiGridRowEditService",["$interval","$q","uiGridConstants","uiGridRowEditConstants","gridUtil",function($interval,$q,uiGridConstants,uiGridRowEditConstants,gridUtil){var service={initializeGrid:function(scope,grid){grid.rowEdit={};var publicApi={events:{rowEdit:{saveRow:function(rowEntity){}}},methods:{rowEdit:{setSavePromise:function(rowEntity,savePromise){service.setSavePromise(grid,rowEntity,savePromise)},getDirtyRows:function(){return grid.rowEdit.dirtyRows?grid.rowEdit.dirtyRows:[]},getErrorRows:function(){return grid.rowEdit.errorRows?grid.rowEdit.errorRows:[]},flushDirtyRows:function(){return service.flushDirtyRows(grid)},setRowsDirty:function(dataRows){service.setRowsDirty(grid,dataRows)},setRowsClean:function(dataRows){service.setRowsClean(grid,dataRows)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods),grid.api.core.on.renderingComplete(scope,function(gridApi){grid.api.edit.on.afterCellEdit(scope,service.endEditCell),grid.api.edit.on.beginCellEdit(scope,service.beginEditCell),grid.api.edit.on.cancelCellEdit(scope,service.cancelEditCell),grid.api.cellNav&&grid.api.cellNav.on.navigate(scope,service.navigate)})},defaultGridOptions:function(gridOptions){},saveRow:function(grid,gridRow){var self=this;return function(){if(gridRow.isSaving=!0,gridRow.rowEditSavePromise)return gridRow.rowEditSavePromise;var promise=grid.api.rowEdit.raise.saveRow(gridRow.entity);return gridRow.rowEditSavePromise?gridRow.rowEditSavePromise.then(self.processSuccessPromise(grid,gridRow),self.processErrorPromise(grid,gridRow)):gridUtil.logError("A promise was not returned when saveRow event was raised, either nobody is listening to event, or event handler did not return a promise"),promise}},setSavePromise:function(grid,rowEntity,savePromise){var gridRow=grid.getRow(rowEntity);gridRow.rowEditSavePromise=savePromise},processSuccessPromise:function(grid,gridRow){var self=this;return function(){delete gridRow.isSaving,delete gridRow.isDirty,delete gridRow.isError,delete gridRow.rowEditSaveTimer,delete gridRow.rowEditSavePromise,self.removeRow(grid.rowEdit.errorRows,gridRow),self.removeRow(grid.rowEdit.dirtyRows,gridRow)}},processErrorPromise:function(grid,gridRow){return function(){delete gridRow.isSaving,delete gridRow.rowEditSaveTimer,delete gridRow.rowEditSavePromise,gridRow.isError=!0,grid.rowEdit.errorRows||(grid.rowEdit.errorRows=[]),service.isRowPresent(grid.rowEdit.errorRows,gridRow)||grid.rowEdit.errorRows.push(gridRow)}},removeRow:function(rowArray,removeGridRow){"undefined"!=typeof rowArray&&null!==rowArray&&rowArray.forEach(function(gridRow,index){gridRow.uid===removeGridRow.uid&&rowArray.splice(index,1)})},isRowPresent:function(rowArray,removeGridRow){var present=!1;return rowArray.forEach(function(gridRow,index){gridRow.uid===removeGridRow.uid&&(present=!0)}),present},flushDirtyRows:function(grid){var promises=[];return grid.api.rowEdit.getDirtyRows().forEach(function(gridRow){service.saveRow(grid,gridRow)(),promises.push(gridRow.rowEditSavePromise)}),$q.all(promises)},endEditCell:function(rowEntity,colDef,newValue,previousValue){var grid=this.grid,gridRow=grid.getRow(rowEntity);return gridRow?void((newValue!==previousValue||gridRow.isDirty)&&(grid.rowEdit.dirtyRows||(grid.rowEdit.dirtyRows=[]),gridRow.isDirty||(gridRow.isDirty=!0,grid.rowEdit.dirtyRows.push(gridRow)),delete gridRow.isError,service.considerSetTimer(grid,gridRow))):void gridUtil.logError("Unable to find rowEntity in grid data, dirty flag cannot be set")},beginEditCell:function(rowEntity,colDef){var grid=this.grid,gridRow=grid.getRow(rowEntity);return gridRow?void service.cancelTimer(grid,gridRow):void gridUtil.logError("Unable to find rowEntity in grid data, timer cannot be cancelled")},cancelEditCell:function(rowEntity,colDef){var grid=this.grid,gridRow=grid.getRow(rowEntity);return gridRow?void service.considerSetTimer(grid,gridRow):void gridUtil.logError("Unable to find rowEntity in grid data, timer cannot be set")},navigate:function(newRowCol,oldRowCol){var grid=this.grid;newRowCol.row.rowEditSaveTimer&&service.cancelTimer(grid,newRowCol.row),oldRowCol&&oldRowCol.row&&oldRowCol.row!==newRowCol.row&&service.considerSetTimer(grid,oldRowCol.row)},considerSetTimer:function(grid,gridRow){if(service.cancelTimer(grid,gridRow),gridRow.isDirty&&!gridRow.isSaving&&grid.options.rowEditWaitInterval!==-1){var waitTime=grid.options.rowEditWaitInterval?grid.options.rowEditWaitInterval:2e3;gridRow.rowEditSaveTimer=$interval(service.saveRow(grid,gridRow),waitTime,1)}},cancelTimer:function(grid,gridRow){gridRow.rowEditSaveTimer&&!gridRow.isSaving&&($interval.cancel(gridRow.rowEditSaveTimer),delete gridRow.rowEditSaveTimer)},setRowsDirty:function(grid,myDataRows){var gridRow;myDataRows.forEach(function(value,index){gridRow=grid.getRow(value),gridRow?(grid.rowEdit.dirtyRows||(grid.rowEdit.dirtyRows=[]),gridRow.isDirty||(gridRow.isDirty=!0,grid.rowEdit.dirtyRows.push(gridRow)),delete gridRow.isError,service.considerSetTimer(grid,gridRow)):gridUtil.logError("requested row not found in rowEdit.setRowsDirty, row was: "+value)})},setRowsClean:function(grid,myDataRows){var gridRow;myDataRows.forEach(function(value,index){gridRow=grid.getRow(value),gridRow?(delete gridRow.isDirty,service.removeRow(grid.rowEdit.dirtyRows,gridRow),service.cancelTimer(grid,gridRow),delete gridRow.isError,service.removeRow(grid.rowEdit.errorRows,gridRow)):gridUtil.logError("requested row not found in rowEdit.setRowsClean, row was: "+value)})}};return service}]),module.directive("uiGridRowEdit",["gridUtil","uiGridRowEditService","uiGridEditConstants",function(gridUtil,uiGridRowEditService,uiGridEditConstants){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridRowEditService.initializeGrid($scope,uiGridCtrl.grid)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}]),module.directive("uiGridViewport",["$compile","uiGridConstants","gridUtil","$parse",function($compile,uiGridConstants,gridUtil,$parse){return{priority:-200,scope:!1,compile:function($elm,$attrs){var rowRepeatDiv=angular.element($elm.children().children()[0]),existingNgClass=rowRepeatDiv.attr("ng-class"),newNgClass="";return newNgClass=existingNgClass?existingNgClass.slice(0,-1)+", 'ui-grid-row-dirty': row.isDirty, 'ui-grid-row-saving': row.isSaving, 'ui-grid-row-error': row.isError}":"{'ui-grid-row-dirty': row.isDirty, 'ui-grid-row-saving': row.isSaving, 'ui-grid-row-error': row.isError}",rowRepeatDiv.attr("ng-class",newNgClass),{pre:function($scope,$elm,$attrs,controllers){},post:function($scope,$elm,$attrs,controllers){}}}}}])}(),function(){var module=angular.module("ui.grid.saveState",["ui.grid","ui.grid.selection","ui.grid.cellNav","ui.grid.grouping","ui.grid.pinning","ui.grid.treeView"]);module.constant("uiGridSaveStateConstants",{featureName:"saveState"}),module.service("uiGridSaveStateService",["$q","uiGridSaveStateConstants","gridUtil","$compile","$interval","uiGridConstants",function($q,uiGridSaveStateConstants,gridUtil,$compile,$interval,uiGridConstants){var service={initializeGrid:function(grid){grid.saveState={},this.defaultGridOptions(grid.options);var publicApi={events:{saveState:{}},methods:{saveState:{save:function(){return service.save(grid)},restore:function($scope,state){service.restore(grid,$scope,state)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},defaultGridOptions:function(gridOptions){gridOptions.saveWidths=gridOptions.saveWidths!==!1,gridOptions.saveOrder=gridOptions.saveOrder!==!1,gridOptions.saveScroll=gridOptions.saveScroll===!0,gridOptions.saveFocus=gridOptions.saveScroll!==!0&&gridOptions.saveFocus!==!1,gridOptions.saveVisible=gridOptions.saveVisible!==!1,gridOptions.saveSort=gridOptions.saveSort!==!1,gridOptions.saveFilter=gridOptions.saveFilter!==!1,gridOptions.saveSelection=gridOptions.saveSelection!==!1,gridOptions.saveGrouping=gridOptions.saveGrouping!==!1,gridOptions.saveGroupingExpandedStates=gridOptions.saveGroupingExpandedStates===!0,gridOptions.savePinning=gridOptions.savePinning!==!1,gridOptions.saveTreeView=gridOptions.saveTreeView!==!1},save:function(grid){var savedState={};return savedState.columns=service.saveColumns(grid),savedState.scrollFocus=service.saveScrollFocus(grid),savedState.selection=service.saveSelection(grid),savedState.grouping=service.saveGrouping(grid),savedState.treeView=service.saveTreeView(grid),savedState.pagination=service.savePagination(grid),savedState},restore:function(grid,$scope,state){state.columns&&service.restoreColumns(grid,state.columns),state.scrollFocus&&service.restoreScrollFocus(grid,$scope,state.scrollFocus),state.selection&&service.restoreSelection(grid,state.selection),state.grouping&&service.restoreGrouping(grid,state.grouping),state.treeView&&service.restoreTreeView(grid,state.treeView),state.pagination&&service.restorePagination(grid,state.pagination),
grid.refresh()},saveColumns:function(grid){var columns=[];return grid.getOnlyDataColumns().forEach(function(column){var savedColumn={};savedColumn.name=column.name,grid.options.saveVisible&&(savedColumn.visible=column.visible),grid.options.saveWidths&&(savedColumn.width=column.width),grid.options.saveSort&&(savedColumn.sort=angular.copy(column.sort)),grid.options.saveFilter&&(savedColumn.filters=[],column.filters.forEach(function(filter){var copiedFilter={};angular.forEach(filter,function(value,key){"condition"!==key&&"$$hashKey"!==key&&"placeholder"!==key&&(copiedFilter[key]=value)}),savedColumn.filters.push(copiedFilter)})),grid.api.pinning&&grid.options.savePinning&&(savedColumn.pinned=column.renderContainer?column.renderContainer:""),columns.push(savedColumn)}),columns},saveScrollFocus:function(grid){if(!grid.api.cellNav)return{};var scrollFocus={};if(grid.options.saveFocus){scrollFocus.focus=!0;var rowCol=grid.api.cellNav.getFocusedCell();null!==rowCol&&(null!==rowCol.col&&(scrollFocus.colName=rowCol.col.colDef.name),null!==rowCol.row&&(scrollFocus.rowVal=service.getRowVal(grid,rowCol.row)))}return(grid.options.saveScroll||grid.options.saveFocus&&!scrollFocus.colName&&!scrollFocus.rowVal)&&(scrollFocus.focus=!1,grid.renderContainers.body.prevRowScrollIndex&&(scrollFocus.rowVal=service.getRowVal(grid,grid.renderContainers.body.visibleRowCache[grid.renderContainers.body.prevRowScrollIndex])),grid.renderContainers.body.prevColScrollIndex&&(scrollFocus.colName=grid.renderContainers.body.visibleColumnCache[grid.renderContainers.body.prevColScrollIndex].name)),scrollFocus},saveSelection:function(grid){if(!grid.api.selection||!grid.options.saveSelection)return[];var selection=grid.api.selection.getSelectedGridRows().map(function(gridRow){return service.getRowVal(grid,gridRow)});return selection},saveGrouping:function(grid){return grid.api.grouping&&grid.options.saveGrouping?grid.api.grouping.getGrouping(grid.options.saveGroupingExpandedStates):{}},savePagination:function(grid){return grid.api.pagination&&grid.options.paginationPageSize?{paginationCurrentPage:grid.options.paginationCurrentPage,paginationPageSize:grid.options.paginationPageSize}:{}},saveTreeView:function(grid){return grid.api.treeView&&grid.options.saveTreeView?grid.api.treeView.getTreeView():{}},getRowVal:function(grid,gridRow){if(!gridRow)return null;var rowVal={};return grid.options.saveRowIdentity?(rowVal.identity=!0,rowVal.row=grid.options.saveRowIdentity(gridRow.entity)):(rowVal.identity=!1,rowVal.row=grid.renderContainers.body.visibleRowCache.indexOf(gridRow)),rowVal},restoreColumns:function(grid,columnsState){var isSortChanged=!1;columnsState.forEach(function(columnState,index){var currentCol=grid.getColumn(columnState.name);if(currentCol&&!grid.isRowHeaderColumn(currentCol)){!grid.options.saveVisible||currentCol.visible===columnState.visible&&currentCol.colDef.visible===columnState.visible||(currentCol.visible=columnState.visible,currentCol.colDef.visible=columnState.visible,grid.api.core.raise.columnVisibilityChanged(currentCol)),grid.options.saveWidths&&currentCol.width!==columnState.width&&(currentCol.width=columnState.width,currentCol.hasCustomWidth=!0),!grid.options.saveSort||angular.equals(currentCol.sort,columnState.sort)||void 0===currentCol.sort&&angular.isEmpty(columnState.sort)||(currentCol.sort=angular.copy(columnState.sort),isSortChanged=!0),grid.options.saveFilter&&!angular.equals(currentCol.filters,columnState.filters)&&(columnState.filters.forEach(function(filter,index){angular.extend(currentCol.filters[index],filter),"undefined"!=typeof filter.term&&null!==filter.term||delete currentCol.filters[index].term}),grid.api.core.raise.filterChanged()),grid.api.pinning&&grid.options.savePinning&&currentCol.renderContainer!==columnState.pinned&&grid.api.pinning.pinColumn(currentCol,columnState.pinned);var currentIndex=grid.getOnlyDataColumns().indexOf(currentCol);if(currentIndex!==-1&&grid.options.saveOrder&&currentIndex!==index){var column=grid.columns.splice(currentIndex+grid.rowHeaderColumns.length,1)[0];grid.columns.splice(index+grid.rowHeaderColumns.length,0,column)}}}),isSortChanged&&grid.api.core.raise.sortChanged(grid,grid.getColumnSorting())},restoreScrollFocus:function(grid,$scope,scrollFocusState){if(grid.api.cellNav){var colDef,row;if(scrollFocusState.colName){var colDefs=grid.options.columnDefs.filter(function(colDef){return colDef.name===scrollFocusState.colName});colDefs.length>0&&(colDef=colDefs[0])}scrollFocusState.rowVal&&scrollFocusState.rowVal.row&&(row=scrollFocusState.rowVal.identity?service.findRowByIdentity(grid,scrollFocusState.rowVal):grid.renderContainers.body.visibleRowCache[scrollFocusState.rowVal.row]);var entity=row&&row.entity?row.entity:null;(colDef||entity)&&(scrollFocusState.focus?grid.api.cellNav.scrollToFocus(entity,colDef):grid.scrollTo(entity,colDef))}},restoreSelection:function(grid,selectionState){grid.api.selection&&(grid.api.selection.clearSelectedRows(),selectionState.forEach(function(rowVal){if(rowVal.identity){var foundRow=service.findRowByIdentity(grid,rowVal);foundRow&&grid.api.selection.selectRow(foundRow.entity)}else grid.api.selection.selectRowByVisibleIndex(rowVal.row)}))},restoreGrouping:function(grid,groupingState){grid.api.grouping&&"undefined"!=typeof groupingState&&null!==groupingState&&!angular.equals(groupingState,{})&&grid.api.grouping.setGrouping(groupingState)},restoreTreeView:function(grid,treeViewState){grid.api.treeView&&"undefined"!=typeof treeViewState&&null!==treeViewState&&!angular.equals(treeViewState,{})&&grid.api.treeView.setTreeView(treeViewState)},restorePagination:function(grid,pagination){grid.api.pagination&&grid.options.paginationPageSize&&(grid.options.paginationCurrentPage=pagination.paginationCurrentPage,grid.options.paginationPageSize=pagination.paginationPageSize)},findRowByIdentity:function(grid,rowVal){if(!grid.options.saveRowIdentity)return null;var filteredRows=grid.rows.filter(function(gridRow){return grid.options.saveRowIdentity(gridRow.entity)===rowVal.row});return filteredRows.length>0?filteredRows[0]:null}};return service}]),module.directive("uiGridSaveState",["uiGridSaveStateConstants","uiGridSaveStateService","gridUtil","$compile",function(uiGridSaveStateConstants,uiGridSaveStateService,gridUtil,$compile){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,link:function($scope,$elm,$attrs,uiGridCtrl){uiGridSaveStateService.initializeGrid(uiGridCtrl.grid)}}}])}(),function(){var module=angular.module("ui.grid.selection",["ui.grid"]);module.constant("uiGridSelectionConstants",{featureName:"selection",selectionRowHeaderColName:"selectionRowHeaderCol"}),angular.module("ui.grid").config(["$provide",function($provide){$provide.decorator("GridRow",["$delegate",function($delegate){return $delegate.prototype.setSelected=function(selected){selected!==this.isSelected&&(this.isSelected=selected,this.grid.selection.selectedCount+=selected?1:-1)},$delegate}])}]),module.service("uiGridSelectionService",["$q","$templateCache","uiGridSelectionConstants","gridUtil",function($q,$templateCache,uiGridSelectionConstants,gridUtil){var service={initializeGrid:function(grid){grid.selection={},grid.selection.lastSelectedRow=null,grid.selection.selectAll=!1,grid.selection.selectedCount=0,service.defaultGridOptions(grid.options);var publicApi={events:{selection:{rowSelectionChanged:function(scope,row,evt){},rowSelectionChangedBatch:function(scope,rows,evt){}}},methods:{selection:{toggleRowSelection:function(rowEntity,evt){var row=grid.getRow(rowEntity);null!==row&&service.toggleRowSelection(grid,row,evt,grid.options.multiSelect,grid.options.noUnselect)},selectRow:function(rowEntity,evt){var row=grid.getRow(rowEntity);null===row||row.isSelected||service.toggleRowSelection(grid,row,evt,grid.options.multiSelect,grid.options.noUnselect)},selectRowByVisibleIndex:function(rowNum,evt){var row=grid.renderContainers.body.visibleRowCache[rowNum];null===row||"undefined"==typeof row||row.isSelected||service.toggleRowSelection(grid,row,evt,grid.options.multiSelect,grid.options.noUnselect)},unSelectRow:function(rowEntity,evt){var row=grid.getRow(rowEntity);null!==row&&row.isSelected&&service.toggleRowSelection(grid,row,evt,grid.options.multiSelect,grid.options.noUnselect)},selectAllRows:function(evt){if(grid.options.multiSelect!==!1){var changedRows=[];grid.rows.forEach(function(row){row.isSelected||row.enableSelection===!1||(row.setSelected(!0),service.decideRaiseSelectionEvent(grid,row,changedRows,evt))}),service.decideRaiseSelectionBatchEvent(grid,changedRows,evt),grid.selection.selectAll=!0}},selectAllVisibleRows:function(evt){if(grid.options.multiSelect!==!1){var changedRows=[];grid.rows.forEach(function(row){row.visible?row.isSelected||row.enableSelection===!1||(row.setSelected(!0),service.decideRaiseSelectionEvent(grid,row,changedRows,evt)):row.isSelected&&(row.setSelected(!1),service.decideRaiseSelectionEvent(grid,row,changedRows,evt))}),service.decideRaiseSelectionBatchEvent(grid,changedRows,evt),grid.selection.selectAll=!0}},clearSelectedRows:function(evt){service.clearSelectedRows(grid,evt)},getSelectedRows:function(){return service.getSelectedRows(grid).map(function(gridRow){return gridRow.entity})},getSelectedGridRows:function(){return service.getSelectedRows(grid)},getSelectedCount:function(){return grid.selection.selectedCount},setMultiSelect:function(multiSelect){grid.options.multiSelect=multiSelect},setModifierKeysToMultiSelect:function(modifierKeysToMultiSelect){grid.options.modifierKeysToMultiSelect=modifierKeysToMultiSelect},getSelectAllState:function(){return grid.selection.selectAll}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},defaultGridOptions:function(gridOptions){gridOptions.enableRowSelection=gridOptions.enableRowSelection!==!1,gridOptions.multiSelect=gridOptions.multiSelect!==!1,gridOptions.noUnselect=gridOptions.noUnselect===!0,gridOptions.modifierKeysToMultiSelect=gridOptions.modifierKeysToMultiSelect===!0,gridOptions.enableRowHeaderSelection=gridOptions.enableRowHeaderSelection!==!1,"undefined"==typeof gridOptions.enableFullRowSelection&&(gridOptions.enableFullRowSelection=!gridOptions.enableRowHeaderSelection),gridOptions.enableSelectAll=gridOptions.enableSelectAll!==!1,gridOptions.enableSelectionBatchEvent=gridOptions.enableSelectionBatchEvent!==!1,gridOptions.selectionRowHeaderWidth=angular.isDefined(gridOptions.selectionRowHeaderWidth)?gridOptions.selectionRowHeaderWidth:30,gridOptions.enableFooterTotalSelected=gridOptions.enableFooterTotalSelected!==!1,gridOptions.isRowSelectable=angular.isDefined(gridOptions.isRowSelectable)?gridOptions.isRowSelectable:angular.noop},toggleRowSelection:function(grid,row,evt,multiSelect,noUnselect){var selected=row.isSelected;if(row.enableSelection!==!1||selected){var selectedRows;multiSelect||selected?!multiSelect&&selected&&(selectedRows=service.getSelectedRows(grid),selectedRows.length>1&&(selected=!1,service.clearSelectedRows(grid,evt))):service.clearSelectedRows(grid,evt),selected&&noUnselect||(row.setSelected(!selected),row.isSelected===!0&&(grid.selection.lastSelectedRow=row),selectedRows=service.getSelectedRows(grid),grid.selection.selectAll=grid.rows.length===selectedRows.length,grid.api.selection.raise.rowSelectionChanged(row,evt))}},shiftSelect:function(grid,row,evt,multiSelect){if(multiSelect){var selectedRows=service.getSelectedRows(grid),fromRow=selectedRows.length>0?grid.renderContainers.body.visibleRowCache.indexOf(grid.selection.lastSelectedRow):0,toRow=grid.renderContainers.body.visibleRowCache.indexOf(row);if(fromRow>toRow){var tmp=fromRow;fromRow=toRow,toRow=tmp}for(var changedRows=[],i=fromRow;i<=toRow;i++){var rowToSelect=grid.renderContainers.body.visibleRowCache[i];rowToSelect&&(rowToSelect.isSelected||rowToSelect.enableSelection===!1||(rowToSelect.setSelected(!0),grid.selection.lastSelectedRow=rowToSelect,service.decideRaiseSelectionEvent(grid,rowToSelect,changedRows,evt)))}service.decideRaiseSelectionBatchEvent(grid,changedRows,evt)}},getSelectedRows:function(grid){return grid.rows.filter(function(row){return row.isSelected})},clearSelectedRows:function(grid,evt){var changedRows=[];service.getSelectedRows(grid).forEach(function(row){row.isSelected&&(row.setSelected(!1),service.decideRaiseSelectionEvent(grid,row,changedRows,evt))}),service.decideRaiseSelectionBatchEvent(grid,changedRows,evt),grid.selection.selectAll=!1,grid.selection.selectedCount=0},decideRaiseSelectionEvent:function(grid,row,changedRows,evt){grid.options.enableSelectionBatchEvent?changedRows.push(row):grid.api.selection.raise.rowSelectionChanged(row,evt)},decideRaiseSelectionBatchEvent:function(grid,changedRows,evt){changedRows.length>0&&grid.api.selection.raise.rowSelectionChangedBatch(changedRows,evt)}};return service}]),module.directive("uiGridSelection",["uiGridSelectionConstants","uiGridSelectionService","$templateCache","uiGridConstants",function(uiGridSelectionConstants,uiGridSelectionService,$templateCache,uiGridConstants){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){if(uiGridSelectionService.initializeGrid(uiGridCtrl.grid),uiGridCtrl.grid.options.enableRowHeaderSelection){var selectionRowHeaderDef={name:uiGridSelectionConstants.selectionRowHeaderColName,displayName:"",width:uiGridCtrl.grid.options.selectionRowHeaderWidth,minWidth:10,cellTemplate:"ui-grid/selectionRowHeader",headerCellTemplate:"ui-grid/selectionHeaderCell",enableColumnResizing:!1,enableColumnMenu:!1,exporterSuppressExport:!0,allowCellFocus:!0};uiGridCtrl.grid.addRowHeaderColumn(selectionRowHeaderDef,0)}var processorSet=!1,processSelectableRows=function(rows){return rows.forEach(function(row){row.enableSelection=uiGridCtrl.grid.options.isRowSelectable(row)}),rows},updateOptions=function(){uiGridCtrl.grid.options.isRowSelectable!==angular.noop&&processorSet!==!0&&(uiGridCtrl.grid.registerRowsProcessor(processSelectableRows,500),processorSet=!0)};updateOptions();var dataChangeDereg=uiGridCtrl.grid.registerDataChangeCallback(updateOptions,[uiGridConstants.dataChange.OPTIONS]);$scope.$on("$destroy",dataChangeDereg)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}]),module.directive("uiGridSelectionRowHeaderButtons",["$templateCache","uiGridSelectionService","gridUtil",function($templateCache,uiGridSelectionService,gridUtil){return{replace:!0,restrict:"E",template:$templateCache.get("ui-grid/selectionRowHeaderButtons"),scope:!0,require:"^uiGrid",link:function($scope,$elm,$attrs,uiGridCtrl){function selectButtonClick(row,evt){evt.stopPropagation(),evt.shiftKey?uiGridSelectionService.shiftSelect(self,row,evt,self.options.multiSelect):evt.ctrlKey||evt.metaKey?uiGridSelectionService.toggleRowSelection(self,row,evt,self.options.multiSelect,self.options.noUnselect):uiGridSelectionService.toggleRowSelection(self,row,evt,self.options.multiSelect&&!self.options.modifierKeysToMultiSelect,self.options.noUnselect)}function selectButtonMouseDown(evt){(evt.ctrlKey||evt.shiftKey)&&(evt.target.onselectstart=function(){return!1},window.setTimeout(function(){evt.target.onselectstart=null},0))}var self=uiGridCtrl.grid;$scope.selectButtonClick=selectButtonClick,"ie"===gridUtil.detectBrowser()&&$elm.on("mousedown",selectButtonMouseDown)}}}]),module.directive("uiGridSelectionSelectAllButtons",["$templateCache","uiGridSelectionService",function($templateCache,uiGridSelectionService){return{replace:!0,restrict:"E",template:$templateCache.get("ui-grid/selectionSelectAllButtons"),scope:!1,link:function($scope,$elm,$attrs,uiGridCtrl){var self=$scope.col.grid;$scope.headerButtonClick=function(row,evt){self.selection.selectAll?(uiGridSelectionService.clearSelectedRows(self,evt),self.options.noUnselect&&self.api.selection.selectRowByVisibleIndex(0,evt),self.selection.selectAll=!1):self.options.multiSelect&&(self.api.selection.selectAllVisibleRows(evt),self.selection.selectAll=!0)}}}}]),module.directive("uiGridViewport",["$compile","uiGridConstants","uiGridSelectionConstants","gridUtil","$parse","uiGridSelectionService",function($compile,uiGridConstants,uiGridSelectionConstants,gridUtil,$parse,uiGridSelectionService){return{priority:-200,scope:!1,compile:function($elm,$attrs){var rowRepeatDiv=angular.element($elm.children().children()[0]),existingNgClass=rowRepeatDiv.attr("ng-class"),newNgClass="";return newNgClass=existingNgClass?existingNgClass.slice(0,-1)+",'ui-grid-row-selected': row.isSelected}":"{'ui-grid-row-selected': row.isSelected}",rowRepeatDiv.attr("ng-class",newNgClass),{pre:function($scope,$elm,$attrs,controllers){},post:function($scope,$elm,$attrs,controllers){}}}}}]),module.directive("uiGridCell",["$compile","uiGridConstants","uiGridSelectionConstants","gridUtil","$parse","uiGridSelectionService","$timeout",function($compile,uiGridConstants,uiGridSelectionConstants,gridUtil,$parse,uiGridSelectionService,$timeout){return{priority:-200,restrict:"A",require:"?^uiGrid",scope:!1,link:function($scope,$elm,$attrs,uiGridCtrl){function registerRowSelectionEvents(){$scope.grid.options.enableRowSelection&&$scope.grid.options.enableFullRowSelection&&($elm.addClass("ui-grid-disable-selection"),$elm.on("touchstart",touchStart),$elm.on("touchend",touchEnd),$elm.on("click",selectCells),$scope.registered=!0)}function deregisterRowSelectionEvents(){$scope.registered&&($elm.removeClass("ui-grid-disable-selection"),$elm.off("touchstart",touchStart),$elm.off("touchend",touchEnd),$elm.off("click",selectCells),$scope.registered=!1)}var touchStartTime=0,touchTimeout=300;uiGridCtrl.grid.api.cellNav&&uiGridCtrl.grid.api.cellNav.on.viewPortKeyDown($scope,function(evt,rowCol){null!==rowCol&&rowCol.row===$scope.row&&rowCol.col===$scope.col&&32===evt.keyCode&&"selectionRowHeaderCol"===$scope.col.colDef.name&&(uiGridSelectionService.toggleRowSelection($scope.grid,$scope.row,evt,$scope.grid.options.multiSelect&&!$scope.grid.options.modifierKeysToMultiSelect,$scope.grid.options.noUnselect),$scope.$apply())});var selectCells=function(evt){$elm.off("touchend",touchEnd),evt.shiftKey?uiGridSelectionService.shiftSelect($scope.grid,$scope.row,evt,$scope.grid.options.multiSelect):evt.ctrlKey||evt.metaKey?uiGridSelectionService.toggleRowSelection($scope.grid,$scope.row,evt,$scope.grid.options.multiSelect,$scope.grid.options.noUnselect):uiGridSelectionService.toggleRowSelection($scope.grid,$scope.row,evt,$scope.grid.options.multiSelect&&!$scope.grid.options.modifierKeysToMultiSelect,$scope.grid.options.noUnselect),$scope.$apply(),$timeout(function(){$elm.on("touchend",touchEnd)},touchTimeout)},touchStart=function(evt){touchStartTime=(new Date).getTime(),$elm.off("click",selectCells)},touchEnd=function(evt){var touchEndTime=(new Date).getTime(),touchTime=touchEndTime-touchStartTime;touchTime<touchTimeout&&selectCells(evt),$timeout(function(){$elm.on("click",selectCells)},touchTimeout)};registerRowSelectionEvents();var dataChangeDereg=$scope.grid.registerDataChangeCallback(function(){$scope.grid.options.enableRowSelection&&$scope.grid.options.enableFullRowSelection&&!$scope.registered?registerRowSelectionEvents():$scope.grid.options.enableRowSelection&&$scope.grid.options.enableFullRowSelection||!$scope.registered||deregisterRowSelectionEvents()},[uiGridConstants.dataChange.OPTIONS]);$elm.on("$destroy",dataChangeDereg)}}}]),module.directive("uiGridGridFooter",["$compile","uiGridConstants","gridUtil",function($compile,uiGridConstants,gridUtil){return{restrict:"EA",replace:!0,priority:-1e3,require:"^uiGrid",scope:!0,compile:function($elm,$attrs){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridCtrl.grid.options.showGridFooter&&gridUtil.getTemplate("ui-grid/gridFooterSelectedItems").then(function(contents){var template=angular.element(contents),newElm=$compile(template)($scope);angular.element($elm[0].getElementsByClassName("ui-grid-grid-footer")[0]).append(newElm)})},post:function($scope,$elm,$attrs,controllers){}}}}}])}(),function(){var module=angular.module("ui.grid.treeBase",["ui.grid"]);module.constant("uiGridTreeBaseConstants",{featureName:"treeBase",rowHeaderColName:"treeBaseRowHeaderCol",EXPANDED:"expanded",COLLAPSED:"collapsed",aggregation:{COUNT:"count",SUM:"sum",MAX:"max",MIN:"min",AVG:"avg"}}),module.service("uiGridTreeBaseService",["$q","uiGridTreeBaseConstants","gridUtil","GridRow","gridClassFactory","i18nService","uiGridConstants","rowSorter",function($q,uiGridTreeBaseConstants,gridUtil,GridRow,gridClassFactory,i18nService,uiGridConstants,rowSorter){var service={initializeGrid:function(grid,$scope){grid.treeBase={},grid.treeBase.numberLevels=0,grid.treeBase.expandAll=!1,grid.treeBase.tree=[],service.defaultGridOptions(grid.options),grid.registerRowsProcessor(service.treeRows,410),grid.registerColumnBuilder(service.treeBaseColumnBuilder),service.createRowHeader(grid);var publicApi={events:{treeBase:{rowExpanded:{},rowCollapsed:{}}},methods:{treeBase:{expandAllRows:function(){service.expandAllRows(grid)},collapseAllRows:function(){service.collapseAllRows(grid)},toggleRowTreeState:function(row){service.toggleRowTreeState(grid,row)},expandRow:function(row){service.expandRow(grid,row)},expandRowChildren:function(row){service.expandRowChildren(grid,row)},collapseRow:function(row){service.collapseRow(grid,row)},collapseRowChildren:function(row){service.collapseRowChildren(grid,row)},getTreeExpandedState:function(){return{expandedState:service.getTreeState(grid)}},setTreeState:function(config){service.setTreeState(grid,config)},getRowChildren:function(row){return row.treeNode.children.map(function(childNode){return childNode.row})}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},defaultGridOptions:function(gridOptions){gridOptions.treeRowHeaderBaseWidth=gridOptions.treeRowHeaderBaseWidth||30,gridOptions.treeIndent=gridOptions.treeIndent||10,gridOptions.showTreeRowHeader=gridOptions.showTreeRowHeader!==!1,gridOptions.showTreeExpandNoChildren=gridOptions.showTreeExpandNoChildren!==!1,gridOptions.treeRowHeaderAlwaysVisible=gridOptions.treeRowHeaderAlwaysVisible!==!1,gridOptions.treeCustomAggregations=gridOptions.treeCustomAggregations||{},gridOptions.enableExpandAll=gridOptions.enableExpandAll!==!1},treeBaseColumnBuilder:function(colDef,col,gridOptions){"undefined"!=typeof colDef.customTreeAggregationFn&&(col.treeAggregationFn=colDef.customTreeAggregationFn),"undefined"!=typeof colDef.treeAggregationType&&(col.treeAggregation={type:colDef.treeAggregationType},"undefined"!=typeof gridOptions.treeCustomAggregations[colDef.treeAggregationType]?(col.treeAggregationFn=gridOptions.treeCustomAggregations[colDef.treeAggregationType].aggregationFn,col.treeAggregationFinalizerFn=gridOptions.treeCustomAggregations[colDef.treeAggregationType].finalizerFn,col.treeAggregation.label=gridOptions.treeCustomAggregations[colDef.treeAggregationType].label):"undefined"!=typeof service.nativeAggregations()[colDef.treeAggregationType]&&(col.treeAggregationFn=service.nativeAggregations()[colDef.treeAggregationType].aggregationFn,col.treeAggregation.label=service.nativeAggregations()[colDef.treeAggregationType].label)),"undefined"!=typeof colDef.treeAggregationLabel&&("undefined"==typeof col.treeAggregation&&(col.treeAggregation={}),col.treeAggregation.label=colDef.treeAggregationLabel),col.treeAggregationUpdateEntity=colDef.treeAggregationUpdateEntity!==!1,"undefined"==typeof col.customTreeAggregationFinalizerFn&&(col.customTreeAggregationFinalizerFn=colDef.customTreeAggregationFinalizerFn)},createRowHeader:function(grid){var rowHeaderColumnDef={name:uiGridTreeBaseConstants.rowHeaderColName,displayName:"",width:grid.options.treeRowHeaderBaseWidth,minWidth:10,cellTemplate:"ui-grid/treeBaseRowHeader",headerCellTemplate:"ui-grid/treeBaseHeaderCell",enableColumnResizing:!1,enableColumnMenu:!1,exporterSuppressExport:!0,allowCellFocus:!0};rowHeaderColumnDef.visible=grid.options.treeRowHeaderAlwaysVisible,grid.addRowHeaderColumn(rowHeaderColumnDef,-100)},expandAllRows:function(grid){grid.treeBase.tree.forEach(function(node){service.setAllNodes(grid,node,uiGridTreeBaseConstants.EXPANDED)}),grid.treeBase.expandAll=!0,grid.queueGridRefresh()},collapseAllRows:function(grid){grid.treeBase.tree.forEach(function(node){service.setAllNodes(grid,node,uiGridTreeBaseConstants.COLLAPSED)}),grid.treeBase.expandAll=!1,grid.queueGridRefresh()},setAllNodes:function(grid,treeNode,targetState){"undefined"!=typeof treeNode.state&&treeNode.state!==targetState&&(treeNode.state=targetState,targetState===uiGridTreeBaseConstants.EXPANDED?grid.api.treeBase.raise.rowExpanded(treeNode.row):grid.api.treeBase.raise.rowCollapsed(treeNode.row)),treeNode.children&&treeNode.children.forEach(function(childNode){service.setAllNodes(grid,childNode,targetState)})},toggleRowTreeState:function(grid,row){"undefined"==typeof row.treeLevel||null===row.treeLevel||row.treeLevel<0||(row.treeNode.state===uiGridTreeBaseConstants.EXPANDED?service.collapseRow(grid,row):service.expandRow(grid,row),grid.queueGridRefresh())},expandRow:function(grid,row){"undefined"==typeof row.treeLevel||null===row.treeLevel||row.treeLevel<0||row.treeNode.state!==uiGridTreeBaseConstants.EXPANDED&&(row.treeNode.state=uiGridTreeBaseConstants.EXPANDED,grid.api.treeBase.raise.rowExpanded(row),grid.treeBase.expandAll=service.allExpanded(grid.treeBase.tree),grid.queueGridRefresh())},expandRowChildren:function(grid,row){"undefined"==typeof row.treeLevel||null===row.treeLevel||row.treeLevel<0||(service.setAllNodes(grid,row.treeNode,uiGridTreeBaseConstants.EXPANDED),grid.treeBase.expandAll=service.allExpanded(grid.treeBase.tree),grid.queueGridRefresh())},collapseRow:function(grid,row){"undefined"==typeof row.treeLevel||null===row.treeLevel||row.treeLevel<0||row.treeNode.state!==uiGridTreeBaseConstants.COLLAPSED&&(row.treeNode.state=uiGridTreeBaseConstants.COLLAPSED,grid.treeBase.expandAll=!1,grid.api.treeBase.raise.rowCollapsed(row),grid.queueGridRefresh())},collapseRowChildren:function(grid,row){"undefined"==typeof row.treeLevel||null===row.treeLevel||row.treeLevel<0||(service.setAllNodes(grid,row.treeNode,uiGridTreeBaseConstants.COLLAPSED),grid.treeBase.expandAll=!1,grid.queueGridRefresh())},allExpanded:function(tree){var allExpanded=!0;return tree.forEach(function(node){service.allExpandedInternal(node)||(allExpanded=!1)}),allExpanded},allExpandedInternal:function(treeNode){if(treeNode.children&&treeNode.children.length>0){if(treeNode.state===uiGridTreeBaseConstants.COLLAPSED)return!1;var allExpanded=!0;return treeNode.children.forEach(function(node){service.allExpandedInternal(node)||(allExpanded=!1)}),allExpanded}return!0},treeRows:function(renderableRows){if(0===renderableRows.length)return renderableRows;var grid=this;uiGridTreeBaseConstants.EXPANDED;return grid.treeBase.tree=service.createTree(grid,renderableRows),service.updateRowHeaderWidth(grid),service.sortTree(grid),service.fixFilter(grid),service.renderTree(grid.treeBase.tree)},updateRowHeaderWidth:function(grid){var rowHeader=grid.getColumn(uiGridTreeBaseConstants.rowHeaderColName),newWidth=grid.options.treeRowHeaderBaseWidth+grid.options.treeIndent*Math.max(grid.treeBase.numberLevels-1,0);rowHeader&&newWidth!==rowHeader.width&&(rowHeader.width=newWidth,grid.queueRefresh());var newVisibility=!0;grid.options.showTreeRowHeader===!1&&(newVisibility=!1),grid.options.treeRowHeaderAlwaysVisible===!1&&grid.treeBase.numberLevels<=0&&(newVisibility=!1),rowHeader.visible!==newVisibility&&(rowHeader.visible=newVisibility,rowHeader.colDef.visible=newVisibility,grid.queueGridRefresh())},renderTree:function(nodeList){var renderableRows=[];return nodeList.forEach(function(node){node.row.visible&&renderableRows.push(node.row),node.state===uiGridTreeBaseConstants.EXPANDED&&node.children&&node.children.length>0&&(renderableRows=renderableRows.concat(service.renderTree(node.children)))}),renderableRows},createTree:function(grid,renderableRows){var currentState,currentLevel=-1,parents=[];grid.treeBase.tree=[],grid.treeBase.numberLevels=0;var aggregations=service.getAggregations(grid),createNode=function(row){if("undefined"!=typeof row.entity.$$treeLevel&&row.treeLevel!==row.entity.$$treeLevel&&(row.treeLevel=row.entity.$$treeLevel),row.treeLevel<=currentLevel){for(;row.treeLevel<=currentLevel;){var lastParent=parents.pop();service.finaliseAggregations(lastParent),currentLevel--}currentState=parents.length>0?service.setCurrentState(parents):uiGridTreeBaseConstants.EXPANDED}("undefined"==typeof row.treeLevel||null===row.treeLevel||row.treeLevel<0)&&row.visible&&service.aggregate(grid,row,parents),service.addOrUseNode(grid,row,parents,aggregations),"undefined"!=typeof row.treeLevel&&null!==row.treeLevel&&row.treeLevel>=0&&(parents.push(row),currentLevel++,currentState=service.setCurrentState(parents)),grid.treeBase.numberLevels<row.treeLevel+1&&(grid.treeBase.numberLevels=row.treeLevel+1)};for(renderableRows.forEach(createNode);parents.length>0;){var lastParent=parents.pop();service.finaliseAggregations(lastParent)}return grid.treeBase.tree},addOrUseNode:function(grid,row,parents,aggregationBase){var newAggregations=[];aggregationBase.forEach(function(aggregation){newAggregations.push(service.buildAggregationObject(aggregation.col))});var newNode={state:uiGridTreeBaseConstants.COLLAPSED,row:row,parentRow:null,aggregations:newAggregations,children:[]};row.treeNode&&(newNode.state=row.treeNode.state),parents.length>0&&(newNode.parentRow=parents[parents.length-1]),row.treeNode=newNode,0===parents.length?grid.treeBase.tree.push(newNode):parents[parents.length-1].treeNode.children.push(newNode)},setCurrentState:function(parents){var currentState=uiGridTreeBaseConstants.EXPANDED;return parents.forEach(function(parent){parent.treeNode.state===uiGridTreeBaseConstants.COLLAPSED&&(currentState=uiGridTreeBaseConstants.COLLAPSED)}),currentState},sortTree:function(grid){grid.columns.forEach(function(column){column.sort&&column.sort.ignoreSort&&delete column.sort.ignoreSort}),grid.treeBase.tree=service.sortInternal(grid,grid.treeBase.tree)},sortInternal:function(grid,treeList){var rows=treeList.map(function(node){return node.row});rows=rowSorter.sort(grid,rows,grid.columns);var treeNodes=rows.map(function(row){return row.treeNode});return treeNodes.forEach(function(node){node.state===uiGridTreeBaseConstants.EXPANDED&&node.children&&node.children.length>0&&(node.children=service.sortInternal(grid,node.children))}),treeNodes},fixFilter:function(grid){var parentsVisible;grid.treeBase.tree.forEach(function(node){node.children&&node.children.length>0&&(parentsVisible=node.row.visible,service.fixFilterInternal(node.children,parentsVisible))})},fixFilterInternal:function(nodes,parentsVisible){return nodes.forEach(function(node){node.row.visible&&!parentsVisible&&(service.setParentsVisible(node),parentsVisible=!0),node.children&&node.children.length>0&&service.fixFilterInternal(node.children,parentsVisible&&node.row.visible)&&(parentsVisible=!0)}),parentsVisible},setParentsVisible:function(node){for(;node.parentRow;)node.parentRow.visible=!0,node=node.parentRow.treeNode},buildAggregationObject:function(column){var newAggregation={col:column};return column.treeAggregation&&column.treeAggregation.type&&(newAggregation.type=column.treeAggregation.type),column.treeAggregation&&column.treeAggregation.label&&(newAggregation.label=column.treeAggregation.label),newAggregation},getAggregations:function(grid){var aggregateArray=[];return grid.columns.forEach(function(column){"undefined"!=typeof column.treeAggregationFn&&(aggregateArray.push(service.buildAggregationObject(column)),grid.options.showColumnFooter&&"undefined"==typeof column.colDef.aggregationType&&column.treeAggregation&&(column.treeFooterAggregation=service.buildAggregationObject(column),column.aggregationType=service.treeFooterAggregationType))}),aggregateArray},aggregate:function(grid,row,parents){0===parents.length&&row.treeNode&&row.treeNode.aggregations&&row.treeNode.aggregations.forEach(function(aggregation){
if("undefined"!=typeof aggregation.col.treeFooterAggregation){var fieldValue=grid.getCellValue(row,aggregation.col),numValue=Number(fieldValue);aggregation.col.treeAggregationFn(aggregation.col.treeFooterAggregation,fieldValue,numValue,row)}}),parents.forEach(function(parent,index){parent.treeNode.aggregations&&parent.treeNode.aggregations.forEach(function(aggregation){var fieldValue=grid.getCellValue(row,aggregation.col),numValue=Number(fieldValue);aggregation.col.treeAggregationFn(aggregation,fieldValue,numValue,row),0===index&&"undefined"!=typeof aggregation.col.treeFooterAggregation&&aggregation.col.treeAggregationFn(aggregation.col.treeFooterAggregation,fieldValue,numValue,row)})})},nativeAggregations:function(){var nativeAggregations={count:{label:i18nService.get().aggregation.count,menuTitle:i18nService.get().grouping.aggregate_count,aggregationFn:function(aggregation,fieldValue,numValue){"undefined"==typeof aggregation.value?aggregation.value=1:aggregation.value++}},sum:{label:i18nService.get().aggregation.sum,menuTitle:i18nService.get().grouping.aggregate_sum,aggregationFn:function(aggregation,fieldValue,numValue){isNaN(numValue)||("undefined"==typeof aggregation.value?aggregation.value=numValue:aggregation.value+=numValue)}},min:{label:i18nService.get().aggregation.min,menuTitle:i18nService.get().grouping.aggregate_min,aggregationFn:function(aggregation,fieldValue,numValue){"undefined"==typeof aggregation.value?aggregation.value=fieldValue:"undefined"!=typeof fieldValue&&null!==fieldValue&&(fieldValue<aggregation.value||null===aggregation.value)&&(aggregation.value=fieldValue)}},max:{label:i18nService.get().aggregation.max,menuTitle:i18nService.get().grouping.aggregate_max,aggregationFn:function(aggregation,fieldValue,numValue){"undefined"==typeof aggregation.value?aggregation.value=fieldValue:"undefined"!=typeof fieldValue&&null!==fieldValue&&(fieldValue>aggregation.value||null===aggregation.value)&&(aggregation.value=fieldValue)}},avg:{label:i18nService.get().aggregation.avg,menuTitle:i18nService.get().grouping.aggregate_avg,aggregationFn:function(aggregation,fieldValue,numValue){"undefined"==typeof aggregation.count?aggregation.count=1:aggregation.count++,isNaN(numValue)||("undefined"==typeof aggregation.value||"undefined"==typeof aggregation.sum?(aggregation.value=numValue,aggregation.sum=numValue):(aggregation.sum+=numValue,aggregation.value=aggregation.sum/aggregation.count))}}};return nativeAggregations},finaliseAggregation:function(row,aggregation){aggregation.col.treeAggregationUpdateEntity&&"undefined"!=typeof row&&"undefined"!=typeof row.entity["$$"+aggregation.col.uid]&&angular.extend(aggregation,row.entity["$$"+aggregation.col.uid]),"function"==typeof aggregation.col.treeAggregationFinalizerFn&&aggregation.col.treeAggregationFinalizerFn(aggregation),"function"==typeof aggregation.col.customTreeAggregationFinalizerFn&&aggregation.col.customTreeAggregationFinalizerFn(aggregation),"undefined"==typeof aggregation.rendered&&(aggregation.rendered=aggregation.label?aggregation.label+aggregation.value:aggregation.value)},finaliseAggregations:function(row){null!=row&&"undefined"!=typeof row.treeNode.aggregations&&row.treeNode.aggregations.forEach(function(aggregation){if(service.finaliseAggregation(row,aggregation),aggregation.col.treeAggregationUpdateEntity){var aggregationCopy={};angular.forEach(aggregation,function(value,key){aggregation.hasOwnProperty(key)&&"col"!==key&&(aggregationCopy[key]=value)}),row.entity["$$"+aggregation.col.uid]=aggregationCopy}})},treeFooterAggregationType:function(rows,column){return service.finaliseAggregation(void 0,column.treeFooterAggregation),"undefined"==typeof column.treeFooterAggregation.value||null===column.treeFooterAggregation.rendered?"":column.treeFooterAggregation.rendered}};return service}]),module.directive("uiGridTreeBaseRowHeaderButtons",["$templateCache","uiGridTreeBaseService",function($templateCache,uiGridTreeBaseService){return{replace:!0,restrict:"E",template:$templateCache.get("ui-grid/treeBaseRowHeaderButtons"),scope:!0,require:"^uiGrid",link:function($scope,$elm,$attrs,uiGridCtrl){var self=uiGridCtrl.grid;$scope.treeButtonClick=function(row,evt){uiGridTreeBaseService.toggleRowTreeState(self,row,evt)}}}}]),module.directive("uiGridTreeBaseExpandAllButtons",["$templateCache","uiGridTreeBaseService",function($templateCache,uiGridTreeBaseService){return{replace:!0,restrict:"E",template:$templateCache.get("ui-grid/treeBaseExpandAllButtons"),scope:!1,link:function($scope,$elm,$attrs,uiGridCtrl){var self=$scope.col.grid;$scope.headerButtonClick=function(row,evt){self.treeBase.expandAll?uiGridTreeBaseService.collapseAllRows(self,evt):uiGridTreeBaseService.expandAllRows(self,evt)}}}}]),module.directive("uiGridViewport",["$compile","uiGridConstants","gridUtil","$parse",function($compile,uiGridConstants,gridUtil,$parse){return{priority:-200,scope:!1,compile:function($elm,$attrs){var rowRepeatDiv=angular.element($elm.children().children()[0]),existingNgClass=rowRepeatDiv.attr("ng-class"),newNgClass="";return newNgClass=existingNgClass?existingNgClass.slice(0,-1)+",'ui-grid-tree-header-row': row.treeLevel > -1}":"{'ui-grid-tree-header-row': row.treeLevel > -1}",rowRepeatDiv.attr("ng-class",newNgClass),{pre:function($scope,$elm,$attrs,controllers){},post:function($scope,$elm,$attrs,controllers){}}}}}])}(),function(){var module=angular.module("ui.grid.treeView",["ui.grid","ui.grid.treeBase"]);module.constant("uiGridTreeViewConstants",{featureName:"treeView",rowHeaderColName:"treeBaseRowHeaderCol",EXPANDED:"expanded",COLLAPSED:"collapsed",aggregation:{COUNT:"count",SUM:"sum",MAX:"max",MIN:"min",AVG:"avg"}}),module.service("uiGridTreeViewService",["$q","uiGridTreeViewConstants","uiGridTreeBaseConstants","uiGridTreeBaseService","gridUtil","GridRow","gridClassFactory","i18nService","uiGridConstants",function($q,uiGridTreeViewConstants,uiGridTreeBaseConstants,uiGridTreeBaseService,gridUtil,GridRow,gridClassFactory,i18nService,uiGridConstants){var service={initializeGrid:function(grid,$scope){uiGridTreeBaseService.initializeGrid(grid,$scope),grid.treeView={},grid.registerRowsProcessor(service.adjustSorting,60);var publicApi={events:{treeView:{}},methods:{treeView:{}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods)},defaultGridOptions:function(gridOptions){gridOptions.enableTreeView=gridOptions.enableTreeView!==!1},adjustSorting:function(renderableRows){var grid=this;return grid.columns.forEach(function(column){column.sort&&(column.sort.ignoreSort=!0)}),renderableRows}};return service}]),module.directive("uiGridTreeView",["uiGridTreeViewConstants","uiGridTreeViewService","$templateCache",function(uiGridTreeViewConstants,uiGridTreeViewService,$templateCache){return{replace:!0,priority:0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridCtrl.grid.options.enableTreeView!==!1&&uiGridTreeViewService.initializeGrid(uiGridCtrl.grid,$scope)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}])}(),function(){var module=angular.module("ui.grid.validate",["ui.grid"]);module.service("uiGridValidateService",["$sce","$q","$http","i18nService","uiGridConstants",function($sce,$q,$http,i18nService,uiGridConstants){var service={validatorFactories:{},setExternalFactoryFunction:function(externalFactoryFunction){service.externalFactoryFunction=externalFactoryFunction},clearExternalFactory:function(){delete service.externalFactoryFunction},getValidatorFromExternalFactory:function(name,argument){return service.externalFactoryFunction(name,argument).validatorFactory(argument)},getMessageFromExternalFactory:function(name,argument){return service.externalFactoryFunction(name,argument).messageFunction(argument)},setValidator:function(name,validatorFactory,messageFunction){service.validatorFactories[name]={validatorFactory:validatorFactory,messageFunction:messageFunction}},getValidator:function(name,argument){if(service.externalFactoryFunction){var validator=service.getValidatorFromExternalFactory(name,argument);if(validator)return validator}if(!service.validatorFactories[name])throw"Invalid validator name: "+name;return service.validatorFactories[name].validatorFactory(argument)},getMessage:function(name,argument){if(service.externalFactoryFunction){var message=service.getMessageFromExternalFactory(name,argument);if(message)return message}return service.validatorFactories[name].messageFunction(argument)},isInvalid:function(rowEntity,colDef){return rowEntity["$$invalid"+colDef.name]},setInvalid:function(rowEntity,colDef){rowEntity["$$invalid"+colDef.name]=!0},setValid:function(rowEntity,colDef){delete rowEntity["$$invalid"+colDef.name]},setError:function(rowEntity,colDef,validatorName){rowEntity["$$errors"+colDef.name]||(rowEntity["$$errors"+colDef.name]={}),rowEntity["$$errors"+colDef.name][validatorName]=!0},clearError:function(rowEntity,colDef,validatorName){rowEntity["$$errors"+colDef.name]&&validatorName in rowEntity["$$errors"+colDef.name]&&delete rowEntity["$$errors"+colDef.name][validatorName]},getErrorMessages:function(rowEntity,colDef){var errors=[];return rowEntity["$$errors"+colDef.name]&&0!==Object.keys(rowEntity["$$errors"+colDef.name]).length?(Object.keys(rowEntity["$$errors"+colDef.name]).sort().forEach(function(validatorName){errors.push(service.getMessage(validatorName,colDef.validators[validatorName]))}),errors):errors},getFormattedErrors:function(rowEntity,colDef){var msgString="",errors=service.getErrorMessages(rowEntity,colDef);if(errors.length)return errors.forEach(function(errorMsg){msgString+=errorMsg+"<br/>"}),$sce.trustAsHtml("<p><b>"+i18nService.getSafeText("validate.error")+"</b></p>"+msgString)},getTitleFormattedErrors:function(rowEntity,colDef){var newLine="\n",msgString="",errors=service.getErrorMessages(rowEntity,colDef);if(errors.length)return errors.forEach(function(errorMsg){msgString+=errorMsg+newLine}),$sce.trustAsHtml(i18nService.getSafeText("validate.error")+newLine+msgString)},runValidators:function(rowEntity,colDef,newValue,oldValue,grid){if(newValue!==oldValue){if("undefined"==typeof colDef.name||!colDef.name)throw new Error("colDef.name is required to perform validation");service.setValid(rowEntity,colDef);var validateClosureFactory=function(rowEntity,colDef,validatorName){return function(value){value||(service.setInvalid(rowEntity,colDef),service.setError(rowEntity,colDef,validatorName),grid&&grid.api.validate.raise.validationFailed(rowEntity,colDef,newValue,oldValue))}},promises=[];for(var validatorName in colDef.validators){service.clearError(rowEntity,colDef,validatorName);var validatorFunction=service.getValidator(validatorName,colDef.validators[validatorName]),promise=$q.when(validatorFunction(oldValue,newValue,rowEntity,colDef)).then(validateClosureFactory(rowEntity,colDef,validatorName));promises.push(promise)}return $q.all(promises)}},createDefaultValidators:function(){service.setValidator("minLength",function(argument){return function(oldValue,newValue,rowEntity,colDef){return void 0===newValue||null===newValue||""===newValue||newValue.length>=argument}},function(argument){return i18nService.getSafeText("validate.minLength").replace("THRESHOLD",argument)}),service.setValidator("maxLength",function(argument){return function(oldValue,newValue,rowEntity,colDef){return void 0===newValue||null===newValue||""===newValue||newValue.length<=argument}},function(threshold){return i18nService.getSafeText("validate.maxLength").replace("THRESHOLD",threshold)}),service.setValidator("required",function(argument){return function(oldValue,newValue,rowEntity,colDef){return!argument||!(void 0===newValue||null===newValue||""===newValue)}},function(argument){return i18nService.getSafeText("validate.required")})},initializeGrid:function(scope,grid){grid.validate={isInvalid:service.isInvalid,getFormattedErrors:service.getFormattedErrors,getTitleFormattedErrors:service.getTitleFormattedErrors,runValidators:service.runValidators};var publicApi={events:{validate:{validationFailed:function(rowEntity,colDef,newValue,oldValue){}}},methods:{validate:{isInvalid:function(rowEntity,colDef){return grid.validate.isInvalid(rowEntity,colDef)},getErrorMessages:function(rowEntity,colDef){return grid.validate.getErrorMessages(rowEntity,colDef)},getFormattedErrors:function(rowEntity,colDef){return grid.validate.getFormattedErrors(rowEntity,colDef)},getTitleFormattedErrors:function(rowEntity,colDef){return grid.validate.getTitleFormattedErrors(rowEntity,colDef)}}}};grid.api.registerEventsFromObject(publicApi.events),grid.api.registerMethodsFromObject(publicApi.methods),grid.edit&&grid.api.edit.on.afterCellEdit(scope,function(rowEntity,colDef,newValue,oldValue){grid.validate.runValidators(rowEntity,colDef,newValue,oldValue,grid)}),service.createDefaultValidators()}};return service}]),module.directive("uiGridValidate",["gridUtil","uiGridValidateService",function(gridUtil,uiGridValidateService){return{priority:0,replace:!0,require:"^uiGrid",scope:!1,compile:function(){return{pre:function($scope,$elm,$attrs,uiGridCtrl){uiGridValidateService.initializeGrid($scope,uiGridCtrl.grid)},post:function($scope,$elm,$attrs,uiGridCtrl){}}}}}])}(),angular.module("ui.grid").run(["$templateCache",function($templateCache){$templateCache.put("ui-grid/ui-grid-filter",'<div class="ui-grid-filter-container" ng-repeat="colFilter in col.filters" ng-class="{\'ui-grid-filter-cancel-button-hidden\' : colFilter.disableCancelFilterButton === true }"><div ng-if="colFilter.type !== \'select\'"><input type="text" class="ui-grid-filter-input ui-grid-filter-input-{{$index}}" ng-model="colFilter.term" ng-attr-placeholder="{{colFilter.placeholder || \'\'}}" aria-label="{{colFilter.ariaLabel || aria.defaultFilterLabel}}"><div role="button" class="ui-grid-filter-button" ng-click="removeFilter(colFilter, $index)" ng-if="!colFilter.disableCancelFilterButton" ng-disabled="colFilter.term === undefined || colFilter.term === null || colFilter.term === \'\'" ng-show="colFilter.term !== undefined && colFilter.term !== null && colFilter.term !== \'\'"><i class="ui-grid-icon-cancel" ui-grid-one-bind-aria-label="aria.removeFilter">&nbsp;</i></div></div><div ng-if="colFilter.type === \'select\'"><select class="ui-grid-filter-select ui-grid-filter-input-{{$index}}" ng-model="colFilter.term" ng-attr-placeholder="{{colFilter.placeholder || aria.defaultFilterLabel}}" aria-label="{{colFilter.ariaLabel || \'\'}}" ng-options="option.value as option.label for option in colFilter.selectOptions"><option value=""></option></select><div role="button" class="ui-grid-filter-button-select" ng-click="removeFilter(colFilter, $index)" ng-if="!colFilter.disableCancelFilterButton" ng-disabled="colFilter.term === undefined || colFilter.term === null || colFilter.term === \'\'" ng-show="colFilter.term !== undefined && colFilter.term != null"><i class="ui-grid-icon-cancel" ui-grid-one-bind-aria-label="aria.removeFilter">&nbsp;</i></div></div></div>'),$templateCache.put("ui-grid/ui-grid-footer",'<div class="ui-grid-footer-panel ui-grid-footer-aggregates-row"><!-- tfooter --><div class="ui-grid-footer ui-grid-footer-viewport"><div class="ui-grid-footer-canvas"><div class="ui-grid-footer-cell-wrapper" ng-style="colContainer.headerCellWrapperStyle()"><div role="row" class="ui-grid-footer-cell-row"><div ui-grid-footer-cell role="gridcell" ng-repeat="col in colContainer.renderedColumns track by col.uid" col="col" render-index="$index" class="ui-grid-footer-cell ui-grid-clearfix"></div></div></div></div></div></div>'),$templateCache.put("ui-grid/ui-grid-grid-footer",'<div class="ui-grid-footer-info ui-grid-grid-footer"><span>{{\'search.totalItems\' | t}} {{grid.rows.length}}</span> <span ng-if="grid.renderContainers.body.visibleRowCache.length !== grid.rows.length" class="ngLabel">({{"search.showingItems" | t}} {{grid.renderContainers.body.visibleRowCache.length}})</span></div>'),$templateCache.put("ui-grid/ui-grid-group-panel",'<div class="ui-grid-group-panel"><div ui-t="groupPanel.description" class="description" ng-show="groupings.length == 0"></div><ul ng-show="groupings.length > 0" class="ngGroupList"><li class="ngGroupItem" ng-repeat="group in configGroups"><span class="ngGroupElement"><span class="ngGroupName">{{group.displayName}} <span ng-click="removeGroup($index)" class="ngRemoveGroup">x</span></span> <span ng-hide="$last" class="ngGroupArrow"></span></span></li></ul></div>'),$templateCache.put("ui-grid/ui-grid-header",'<div role="rowgroup" class="ui-grid-header"><!-- theader --><div class="ui-grid-top-panel"><div class="ui-grid-header-viewport"><div class="ui-grid-header-canvas"><div class="ui-grid-header-cell-wrapper" ng-style="colContainer.headerCellWrapperStyle()"><div role="row" class="ui-grid-header-cell-row"><div class="ui-grid-header-cell ui-grid-clearfix" ng-repeat="col in colContainer.renderedColumns track by col.uid" ui-grid-header-cell col="col" render-index="$index"></div></div></div></div></div></div></div>'),$templateCache.put("ui-grid/ui-grid-menu-button",'<div class="ui-grid-menu-button"><div role="button" ui-grid-one-bind-id-grid="\'grid-menu\'" class="ui-grid-icon-container" ng-click="toggleMenu()" aria-haspopup="true"><i class="ui-grid-icon-menu" ui-grid-one-bind-aria-label="i18n.aria.buttonLabel">&nbsp;</i></div><div ui-grid-menu menu-items="menuItems"></div></div>'),$templateCache.put("ui-grid/ui-grid-no-header",'<div class="ui-grid-top-panel"></div>'),$templateCache.put("ui-grid/ui-grid-row","<div ng-repeat=\"(colRenderIndex, col) in colContainer.renderedColumns track by col.uid\" ui-grid-one-bind-id-grid=\"rowRenderIndex + '-' + col.uid + '-cell'\" class=\"ui-grid-cell\" ng-class=\"{ 'ui-grid-row-header-cell': col.isRowHeader }\" role=\"{{col.isRowHeader ? 'rowheader' : 'gridcell'}}\" ui-grid-cell></div>"),$templateCache.put("ui-grid/ui-grid",'<div ui-i18n="en" class="ui-grid"><!-- TODO (c0bra): add "scoped" attr here, eventually? --><style ui-grid-style>.grid{{ grid.id }} {\n      /* Styles for the grid */\n    }\n\n    .grid{{ grid.id }} .ui-grid-row, .grid{{ grid.id }} .ui-grid-cell, .grid{{ grid.id }} .ui-grid-cell .ui-grid-vertical-bar {\n      height: {{ grid.options.rowHeight }}px;\n    }\n\n    .grid{{ grid.id }} .ui-grid-row:last-child .ui-grid-cell {\n      border-bottom-width: {{ ((grid.getTotalRowHeight() < grid.getViewportHeight()) && \'1\') || \'0\' }}px;\n    }\n\n    {{ grid.verticalScrollbarStyles }}\n    {{ grid.horizontalScrollbarStyles }}\n\n    /*\n    .ui-grid[dir=rtl] .ui-grid-viewport {\n      padding-left: {{ grid.verticalScrollbarWidth }}px;\n    }\n    */\n\n    {{ grid.customStyles }}</style><div class="ui-grid-contents-wrapper"><div ui-grid-menu-button ng-if="grid.options.enableGridMenu"></div><div ng-if="grid.hasLeftContainer()" style="width: 0" ui-grid-pinned-container="\'left\'"></div><div ui-grid-render-container container-id="\'body\'" col-container-name="\'body\'" row-container-name="\'body\'" bind-scroll-horizontal="true" bind-scroll-vertical="true" enable-horizontal-scrollbar="grid.options.enableHorizontalScrollbar" enable-vertical-scrollbar="grid.options.enableVerticalScrollbar"></div><div ng-if="grid.hasRightContainer()" style="width: 0" ui-grid-pinned-container="\'right\'"></div><div ui-grid-grid-footer ng-if="grid.options.showGridFooter"></div><div ui-grid-column-menu ng-if="grid.options.enableColumnMenus"></div><div ng-transclude></div></div></div>'),$templateCache.put("ui-grid/uiGridCell",'<div class="ui-grid-cell-contents" title="TOOLTIP">{{COL_FIELD CUSTOM_FILTERS}}</div>'),$templateCache.put("ui-grid/uiGridColumnMenu",'<div class="ui-grid-column-menu"><div ui-grid-menu menu-items="menuItems"><!-- <div class="ui-grid-column-menu">\n    <div class="inner" ng-show="menuShown">\n      <ul>\n        <div ng-show="grid.options.enableSorting">\n          <li ng-click="sortColumn($event, asc)" ng-class="{ \'selected\' : col.sort.direction == asc }"><i class="ui-grid-icon-sort-alt-up"></i> Sort Ascending</li>\n          <li ng-click="sortColumn($event, desc)" ng-class="{ \'selected\' : col.sort.direction == desc }"><i class="ui-grid-icon-sort-alt-down"></i> Sort Descending</li>\n          <li ng-show="col.sort.direction" ng-click="unsortColumn()"><i class="ui-grid-icon-cancel"></i> Remove Sort</li>\n        </div>\n      </ul>\n    </div>\n  </div> --></div></div>'),$templateCache.put("ui-grid/uiGridFooterCell",'<div class="ui-grid-cell-contents" col-index="renderIndex"><div>{{ col.getAggregationText() + ( col.getAggregationValue() CUSTOM_FILTERS ) }}</div></div>'),$templateCache.put("ui-grid/uiGridHeaderCell",'<div role="columnheader" ng-class="{ \'sortable\': sortable }" ui-grid-one-bind-aria-labelledby-grid="col.uid + \'-header-text \' + col.uid + \'-sortdir-text\'" aria-sort="{{col.sort.direction == asc ? \'ascending\' : ( col.sort.direction == desc ? \'descending\' : (!col.sort.direction ? \'none\' : \'other\'))}}"><div role="button" tabindex="0" class="ui-grid-cell-contents ui-grid-header-cell-primary-focus" col-index="renderIndex" title="TOOLTIP"><span class="ui-grid-header-cell-label" ui-grid-one-bind-id-grid="col.uid + \'-header-text\'">{{ col.displayName CUSTOM_FILTERS }}</span> <span ui-grid-one-bind-id-grid="col.uid + \'-sortdir-text\'" ui-grid-visible="col.sort.direction" aria-label="{{getSortDirectionAriaLabel()}}"><i ng-class="{ \'ui-grid-icon-up-dir\': col.sort.direction == asc, \'ui-grid-icon-down-dir\': col.sort.direction == desc, \'ui-grid-icon-blank\': !col.sort.direction }" title="{{isSortPriorityVisible() ? i18n.headerCell.priority + \' \' + ( col.sort.priority + 1 )  : null}}" aria-hidden="true"></i> <sub ui-grid-visible="isSortPriorityVisible()" class="ui-grid-sort-priority-number">{{col.sort.priority + 1}}</sub></span></div><div role="button" tabindex="0" ui-grid-one-bind-id-grid="col.uid + \'-menu-button\'" class="ui-grid-column-menu-button" ng-if="grid.options.enableColumnMenus && !col.isRowHeader  && col.colDef.enableColumnMenu !== false" ng-click="toggleMenu($event)" ng-class="{\'ui-grid-column-menu-button-last-col\': isLastCol}" ui-grid-one-bind-aria-label="i18n.headerCell.aria.columnMenuButtonLabel" aria-haspopup="true"><i class="ui-grid-icon-angle-down" aria-hidden="true">&nbsp;</i></div><div ui-grid-filter></div></div>'),$templateCache.put("ui-grid/uiGridMenu",'<div class="ui-grid-menu" ng-if="shown"><style ui-grid-style>{{dynamicStyles}}</style><div class="ui-grid-menu-mid" ng-show="shownMid"><div class="ui-grid-menu-inner"><ul role="menu" class="ui-grid-menu-items"><li ng-repeat="item in menuItems" role="menuitem" ui-grid-menu-item ui-grid-one-bind-id="\'menuitem-\'+$index" action="item.action" name="item.title" active="item.active" icon="item.icon" shown="item.shown" context="item.context" template-url="item.templateUrl" leave-open="item.leaveOpen" screen-reader-only="item.screenReaderOnly"></li></ul></div></div></div>'),$templateCache.put("ui-grid/uiGridMenuItem",'<button type="button" class="ui-grid-menu-item" ng-click="itemAction($event, title)" ng-show="itemShown()" ng-class="{ \'ui-grid-menu-item-active\': active(), \'ui-grid-sr-only\': (!focus && screenReaderOnly) }" aria-pressed="{{active()}}" tabindex="0" ng-focus="focus=true" ng-blur="focus=false"><i ng-class="icon" aria-hidden="true">&nbsp;</i> {{ name }}</button>'),$templateCache.put("ui-grid/uiGridRenderContainer","<div role=\"grid\" ui-grid-one-bind-id-grid=\"'grid-container'\" class=\"ui-grid-render-container\" ng-style=\"{ 'margin-left': colContainer.getMargin('left') + 'px', 'margin-right': colContainer.getMargin('right') + 'px' }\"><!-- All of these dom elements are replaced in place --><div ui-grid-header></div><div ui-grid-viewport></div><div ng-if=\"colContainer.needsHScrollbarPlaceholder()\" class=\"ui-grid-scrollbar-placeholder\" ng-style=\"{height:colContainer.grid.scrollbarHeight + 'px'}\"></div><ui-grid-footer ng-if=\"grid.options.showColumnFooter\"></ui-grid-footer></div>"),$templateCache.put("ui-grid/uiGridViewport",'<div role="rowgroup" class="ui-grid-viewport" ng-style="colContainer.getViewportStyle()"><!-- tbody --><div class="ui-grid-canvas"><div ng-repeat="(rowRenderIndex, row) in rowContainer.renderedRows track by $index" class="ui-grid-row" ng-style="Viewport.rowStyle(rowRenderIndex)"><div role="row" ui-grid-row="row" row-render-index="rowRenderIndex"></div></div></div></div>'),$templateCache.put("ui-grid/cellEditor",'<div><form name="inputForm"><input type="INPUT_TYPE" ng-class="\'colt\' + col.uid" ui-grid-editor ng-model="MODEL_COL_FIELD"></form></div>'),$templateCache.put("ui-grid/dropdownEditor",'<div><form name="inputForm"><select ng-class="\'colt\' + col.uid" ui-grid-edit-dropdown ng-model="MODEL_COL_FIELD" ng-options="field[editDropdownIdLabel] as field[editDropdownValueLabel] CUSTOM_FILTERS for field in editDropdownOptionsArray"></select></form></div>'),$templateCache.put("ui-grid/fileChooserEditor",'<div><form name="inputForm"><input ng-class="\'colt\' + col.uid" ui-grid-edit-file-chooser type="file" id="files" name="files[]" ng-model="MODEL_COL_FIELD"></form></div>'),$templateCache.put("ui-grid/expandableRow",'<div ui-grid-expandable-row ng-if="expandableRow.shouldRenderExpand()" class="expandableRow" style="float:left; margin-top: 1px; margin-bottom: 1px" ng-style="{width: (grid.renderContainers.body.getCanvasWidth()) + \'px\', height: row.expandedRowHeight + \'px\'}"></div>'),$templateCache.put("ui-grid/expandableRowHeader",'<div class="ui-grid-row-header-cell ui-grid-expandable-buttons-cell"><div class="ui-grid-cell-contents"><i ng-if="!row.groupHeader==true" ng-class="{ \'ui-grid-icon-plus-squared\' : !row.isExpanded, \'ui-grid-icon-minus-squared\' : row.isExpanded }" ng-click="grid.api.expandable.toggleRowExpansion(row.entity)"></i></div></div>'),$templateCache.put("ui-grid/expandableScrollFiller","<div ng-if=\"expandableRow.shouldRenderFiller()\" ng-class=\"{scrollFiller:true, scrollFillerClass:(colContainer.name === 'body')}\" ng-style=\"{ width: (grid.getViewportWidth()) + 'px', height: row.expandedRowHeight + 2 + 'px', 'margin-left': grid.options.rowHeader.rowHeaderWidth + 'px' }\"><i class=\"ui-grid-icon-spin5 ui-grid-animate-spin\" ng-style=\"{'margin-top': ( row.expandedRowHeight/2 - 5) + 'px', 'margin-left' : ((grid.getViewportWidth() - grid.options.rowHeader.rowHeaderWidth)/2 - 5) + 'px'}\"></i></div>"),$templateCache.put("ui-grid/expandableTopRowHeader",'<div class="ui-grid-row-header-cell ui-grid-expandable-buttons-cell"><div class="ui-grid-cell-contents"><i ng-class="{ \'ui-grid-icon-plus-squared\' : !grid.expandable.expandedAll, \'ui-grid-icon-minus-squared\' : grid.expandable.expandedAll }" ng-click="grid.api.expandable.toggleAllRows()"></i></div></div>'),$templateCache.put("ui-grid/csvLink",'<span class="ui-grid-exporter-csv-link-span"><a href="data:text/csv;charset=UTF-8,CSV_CONTENT" download="FILE_NAME">LINK_LABEL</a></span>'),$templateCache.put("ui-grid/importerMenuItem",'<li class="ui-grid-menu-item"><form><input class="ui-grid-importer-file-chooser" type="file" id="files" name="files[]"></form></li>'),$templateCache.put("ui-grid/importerMenuItemContainer","<div ui-grid-importer-menu-item></div>"),$templateCache.put("ui-grid/pagination",'<div role="contentinfo" class="ui-grid-pager-panel" ui-grid-pager ng-show="grid.options.enablePaginationControls"><div role="navigation" class="ui-grid-pager-container"><div role="menubar" class="ui-grid-pager-control"><button type="button" role="menuitem" class="ui-grid-pager-first" ui-grid-one-bind-title="aria.pageToFirst" ui-grid-one-bind-aria-label="aria.pageToFirst" ng-click="pageFirstPageClick()" ng-disabled="cantPageBackward()"><div ng-class="grid.isRTL() ? \'last-triangle\' : \'first-triangle\'"><div ng-class="grid.isRTL() ? \'last-bar-rtl\' : \'first-bar\'"></div></div></button> <button type="button" role="menuitem" class="ui-grid-pager-previous" ui-grid-one-bind-title="aria.pageBack" ui-grid-one-bind-aria-label="aria.pageBack" ng-click="pagePreviousPageClick()" ng-disabled="cantPageBackward()"><div ng-class="grid.isRTL() ? \'last-triangle prev-triangle\' : \'first-triangle prev-triangle\'"></div></button> <input type="number" ui-grid-one-bind-title="aria.pageSelected" ui-grid-one-bind-aria-label="aria.pageSelected" class="ui-grid-pager-control-input" ng-model="grid.options.paginationCurrentPage" min="1" max="{{ paginationApi.getTotalPages() }}" required> <span class="ui-grid-pager-max-pages-number" ng-show="paginationApi.getTotalPages() > 0"><abbr ui-grid-one-bind-title="paginationOf">/</abbr> {{ paginationApi.getTotalPages() }}</span> <button type="button" role="menuitem" class="ui-grid-pager-next" ui-grid-one-bind-title="aria.pageForward" ui-grid-one-bind-aria-label="aria.pageForward" ng-click="pageNextPageClick()" ng-disabled="cantPageForward()"><div ng-class="grid.isRTL() ? \'first-triangle next-triangle\' : \'last-triangle next-triangle\'"></div></button> <button type="button" role="menuitem" class="ui-grid-pager-last" ui-grid-one-bind-title="aria.pageToLast" ui-grid-one-bind-aria-label="aria.pageToLast" ng-click="pageLastPageClick()" ng-disabled="cantPageToLast()"><div ng-class="grid.isRTL() ? \'first-triangle\' : \'last-triangle\'"><div ng-class="grid.isRTL() ? \'first-bar-rtl\' : \'last-bar\'"></div></div></button></div><div class="ui-grid-pager-row-count-picker" ng-if="grid.options.paginationPageSizes.length > 1"><select ui-grid-one-bind-aria-labelledby-grid="\'items-per-page-label\'" ng-model="grid.options.paginationPageSize" ng-options="o as o for o in grid.options.paginationPageSizes"></select><span ui-grid-one-bind-id-grid="\'items-per-page-label\'" class="ui-grid-pager-row-count-label">&nbsp;{{sizesLabel}}</span></div><span ng-if="grid.options.paginationPageSizes.length <= 1" class="ui-grid-pager-row-count-label">{{grid.options.paginationPageSize}}&nbsp;{{sizesLabel}}</span></div><div class="ui-grid-pager-count-container"><div class="ui-grid-pager-count"><span ng-show="grid.options.totalItems > 0">{{showingLow}} <abbr ui-grid-one-bind-title="paginationThrough">-</abbr> {{showingHigh}} {{paginationOf}} {{grid.options.totalItems}} {{totalItemsLabel}}</span></div></div></div>'),$templateCache.put("ui-grid/columnResizer",'<div ui-grid-column-resizer ng-if="grid.options.enableColumnResizing" class="ui-grid-column-resizer" col="col" position="right" render-index="renderIndex" unselectable="on"></div>'),$templateCache.put("ui-grid/gridFooterSelectedItems",'<span ng-if="grid.selection.selectedCount !== 0 && grid.options.enableFooterTotalSelected">({{"search.selectedItems" | t}} {{grid.selection.selectedCount}})</span>'),$templateCache.put("ui-grid/selectionHeaderCell",'<div><!-- <div class="ui-grid-vertical-bar">&nbsp;</div> --><div class="ui-grid-cell-contents" col-index="renderIndex"><ui-grid-selection-select-all-buttons ng-if="grid.options.enableSelectAll"></ui-grid-selection-select-all-buttons></div></div>'),$templateCache.put("ui-grid/selectionRowHeader",'<div class="ui-grid-disable-selection"><div class="ui-grid-cell-contents"><ui-grid-selection-row-header-buttons></ui-grid-selection-row-header-buttons></div></div>'),$templateCache.put("ui-grid/selectionRowHeaderButtons",'<div class="ui-grid-selection-row-header-buttons ui-grid-icon-ok" ng-class="{\'ui-grid-row-selected\': row.isSelected}" ng-click="selectButtonClick(row, $event)">&nbsp;</div>'),$templateCache.put("ui-grid/selectionSelectAllButtons",'<div class="ui-grid-selection-row-header-buttons ui-grid-icon-ok" ng-class="{\'ui-grid-all-selected\': grid.selection.selectAll}" ng-click="headerButtonClick($event)"></div>'),$templateCache.put("ui-grid/treeBaseExpandAllButtons",'<div class="ui-grid-tree-base-row-header-buttons" ng-class="{\'ui-grid-icon-minus-squared\': grid.treeBase.numberLevels > 0 && grid.treeBase.expandAll, \'ui-grid-icon-plus-squared\': grid.treeBase.numberLevels > 0 && !grid.treeBase.expandAll}" ng-click="headerButtonClick($event)"></div>'),$templateCache.put("ui-grid/treeBaseHeaderCell",'<div><div class="ui-grid-cell-contents" col-index="renderIndex"><ui-grid-tree-base-expand-all-buttons ng-if="grid.options.enableExpandAll"></ui-grid-tree-base-expand-all-buttons></div></div>'),
$templateCache.put("ui-grid/treeBaseRowHeader",'<div class="ui-grid-cell-contents"><ui-grid-tree-base-row-header-buttons></ui-grid-tree-base-row-header-buttons></div>'),$templateCache.put("ui-grid/treeBaseRowHeaderButtons","<div class=\"ui-grid-tree-base-row-header-buttons\" ng-class=\"{'ui-grid-tree-base-header': row.treeLevel > -1 }\" ng-click=\"treeButtonClick(row, $event)\"><i ng-class=\"{'ui-grid-icon-minus-squared': ( ( grid.options.showTreeExpandNoChildren && row.treeLevel > -1 ) || ( row.treeNode.children && row.treeNode.children.length > 0 ) ) && row.treeNode.state === 'expanded', 'ui-grid-icon-plus-squared': ( ( grid.options.showTreeExpandNoChildren && row.treeLevel > -1 ) || ( row.treeNode.children && row.treeNode.children.length > 0 ) ) && row.treeNode.state === 'collapsed'}\" ng-style=\"{'padding-left': grid.options.treeIndent * row.treeLevel + 'px'}\"></i> &nbsp;</div>"),$templateCache.put("ui-grid/cellTitleValidator",'<div class="ui-grid-cell-contents" ng-class="{invalid:grid.validate.isInvalid(row.entity,col.colDef)}" title="{{grid.validate.getTitleFormattedErrors(row.entity,col.colDef)}}">{{COL_FIELD CUSTOM_FILTERS}}</div>'),$templateCache.put("ui-grid/cellTooltipValidator",'<div class="ui-grid-cell-contents" ng-class="{invalid:grid.validate.isInvalid(row.entity,col.colDef)}" tooltip-html-unsafe="{{grid.validate.getFormattedErrors(row.entity,col.colDef)}}" tooltip-enable="grid.validate.isInvalid(row.entity,col.colDef)" tooltip-append-to-body="true" tooltip-placement="top" title="TOOLTIP">{{COL_FIELD CUSTOM_FILTERS}}</div>')}]),services.factory("Assignment",["AssignmentHistoryPredicate",function(HistoryPredicate){var isActive=HistoryPredicate.isActive,inTeam=HistoryPredicate.inTeam,inPeriod=HistoryPredicate.inPeriod,inWeek=HistoryPredicate.inWeek,isTerminated=HistoryPredicate.isTerminated,isOngoing=HistoryPredicate.isOngoing,Assignment=function(assignment){_.extend(this,assignment)};return Object.defineProperty(Assignment.prototype,"name",{get:function(){try{return this.selection.marketplaceMember.application.candidate.printableName}catch(e){return""}}}),Object.defineProperty(Assignment.prototype,"photoUrl",{get:function(){try{return this.selection.marketplaceMember.application.candidate.photoUrl}catch(e){return"/images/1f34682a.user.png"}}}),Assignment.prototype.isActive=function(optional){optional=optional||{};var filter=isActive().and(inTeam(optional.teamId)).and(inPeriod(optional.period)).and(inWeek(optional.week));return _.filter(this.assignmentHistories,filter.build()).length>0},Assignment.prototype.isLeft=function(optional){optional=optional||{};var filter=isActive().and(inTeam(optional.teamId)),usedToWork=_.filter(this.assignmentHistories,filter.build()).length>0,notWorkingNow=0===_.filter(this.assignmentHistories,filter.and(isOngoing()).build()).length;return usedToWork&&notWorkingNow},Assignment.prototype.getLastDay=function(optional){if(optional=optional||{},!this.isLeft(optional))return null;var latestHistory=_.chain(this.assignmentHistories).filter(isTerminated().and(inTeam(optional.teamId)).build()).sortBy("effectiveDateBegin").last().value();return latestHistory?moment(latestHistory.effectiveDateEnd).format(moment.DateFormat.ISO_8601):null},Assignment}]),services.factory("predicate",[function(){var Predicate=function(expression){if("function"!=typeof expression)throw new Error("Expression must be a function");this.expression=expression};Predicate.prototype.and=function(predicate){var _this=this,newExpression=function(target){return _this.apply(target)&&predicate.apply(target)};return new Predicate(newExpression)},Predicate.prototype.or=function(predicate){var _this=this,newExpression=function(target){return _this.apply(target)||predicate.apply(target)};return new Predicate(newExpression)},Predicate.prototype.apply=function(target){return this.expression(target)},Predicate.prototype.build=function(){return this.expression};var alwaysTruePredicate=new Predicate(function(){return!0}),predicate=function(expression){return expression?new Predicate(expression):alwaysTruePredicate};return predicate.AlwaysTrue=alwaysTruePredicate,predicate}]),services.factory("AssignmentHistoryPredicate",["predicate",function(predicate){var AssignmentStatus={ACTIVE:"ACTIVE"},isActive=function(){var isActive=function(history){return history.status===AssignmentStatus.ACTIVE};return predicate(isActive)},isOngoing=function(){var isOngoing=function(history){var hasEndDate=!!history.effectiveDateEnd;return history.status===AssignmentStatus.ACTIVE&&!hasEndDate};return predicate(isOngoing)},isTerminated=function(){var isTerminated=function(history){var hasEndDate=!!history.effectiveDateEnd;return history.status===AssignmentStatus.ACTIVE&&hasEndDate};return predicate(isTerminated)},inTeam=function(teamId){var inTeam=function(history){return history.team.id===teamId};return teamId?predicate(inTeam):predicate.AlwaysTrue},hasManager=function(managerId){var hasManager=function(history){return history.manager.id===managerId};return managerId?predicate(hasManager):predicate.AlwaysTrue},inPeriod=function(period){var inPeriod=function(history){var startBeforePeriod=moment(history.effectiveDateBegin).isBefore(period.to,"day"),leaveAfterPeriod=!history.effectiveDateEnd||moment(history.effectiveDateEnd).isAfter(period.from,"day");return startBeforePeriod&&leaveAfterPeriod};return period?predicate(inPeriod):predicate.AlwaysTrue},inWeek=function(anyDayOfWeek){var monday=moment(anyDayOfWeek).weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),nextMonday=moment(anyDayOfWeek).weekday(moment.DAY_OF_WEEK.MONDAY).add(1,"week").format(moment.DateFormat.ISO_8601);return anyDayOfWeek?inPeriod({from:monday,to:nextMonday}):predicate.AlwaysTrue};return{isActive:isActive,isOngoing:isOngoing,isTerminated:isTerminated,inTeam:inTeam,hasManager:hasManager,inPeriod:inPeriod,inWeek:inWeek}}]),services.factory("AdminAssignmentsService",function($resource,baseUrl){return $resource(baseUrl+"/admin/assignments/:id",{id:"@id"},{edit:{method:"PUT"},scheduleHistories:{url:baseUrl+"/admin/assignments/:id/histories",method:"PUT"}})}),services.factory("AdminUsersService",function($resource,baseUrl){return $resource(baseUrl+"/admin/users/:id",{id:"@id"},{edit:{method:"PUT"},updateAvatars:{url:baseUrl+"/users/:id/avatars",method:"PUT",params:{id:"@id",avatars:"@avatars"}},searchUser:{url:baseUrl+"/admin/users/searchUser",method:"GET",params:{email:"@email",id:"@id",page:"@page"}}})}),services.factory("AdminApplicationService",function($resource,baseUrl){return $resource(baseUrl+"/admin/applications/:id",{id:"@id"},{edit:{method:"PUT"}})}),services.factory("AssignmentService",function(baseUrl,$resource,$rootScope,Assignment){var notify=function(data){return $rootScope.updateNotifications(),angular.fromJson(data)},assignmentService=$resource(baseUrl+"/assignments/:id",{id:"@id",page:"@page",teamId:"@teamId",status:"@status",marketplaceMemberId:"@marketplaceMemberId"},{teamAssignments:{url:baseUrl+"/assignments",method:"GET",params:{page:"@page",teamId:"@teamId",status:"@status",limit:"@limit",avatarType:"@avatarType"},responseType:"json",transformResponse:[function(response){return response.content=_.map(response.content,function(assignment){return new Assignment(assignment)}),response}]},assignments:{url:baseUrl+"/assignments",method:"GET",params:{status:"@status",page:"@page"}},listSimpleAssigments:{url:baseUrl+"/assignments/simple",method:"GET",isArray:!0,params:{teamIds:"@teamIds"}},getLatestWorkDiaries:{url:baseUrl+"/assignments/workdiary/latest",method:"GET",isArray:!0,params:{teamId:"@teamId",managerId:"@managerId",fullTeam:"@fullTeam"}},edit:{method:"PUT",transformResponse:notify},list:{method:"GET",params:{page:"@page",managerId:"@managerId"}},setMeetingTimeLimit:{url:baseUrl+"/assignments/:id",method:"PUT",params:{status:"@status",weeklyMeetingMinutesLimit:"@weeklyMeetingMinutesLimit"}},getMemo:{method:"GET",url:baseUrl+"/assignments/:id/workdiary",params:{id:"@id",startDate:"@startDate",endDate:"@endDate",type:"PENDING_MANUAL_TIME"},transformResponse:function(data){if(data){var res=angular.fromJson(data);return data={},data.res=res,data}}},getUsedMeetingTimeText:{method:"GET",url:baseUrl+"/assignments/:id/workdiary",params:{startDate:"@startDate",endDate:"@endDate",type:"@type"},transformResponse:function(data){if(data){var res=angular.fromJson(data),usedMeetingTime=10*res.length,hours=Math.floor(usedMeetingTime/60),minutes=usedMeetingTime%60,usedMeetingTimeText=hours+" h "+minutes+" min";return data={},data.meetingTime=usedMeetingTimeText,data}}},addMemo:{method:"POST",url:baseUrl+"/assignments/:assignmentId/workdiary",params:{assignmentId:"@assignmentId"}},approveRejectMemo:{method:"POST",url:baseUrl+"/assignments/:assignmentId/workdiary/action",params:{assignmentId:"@assignmentId"}},deleteWorkdiaries:{method:"POST",url:baseUrl+"/assignments/workdiary/delete"},changToMeetingTimeWorkdiaries:{method:"POST",url:baseUrl+"/assignments/:id/workdiary/action",params:{action:"@action"}},workDiary:{method:"GET",url:baseUrl+"/assignments/:id/workdiary",params:{id:"@id",date:"@date",timeZoneId:"@timeZoneId"},isArray:!0},updateWorkDiary:{method:"PUT",url:baseUrl+"/assignments/:id/workdiary/:workdiaryId",params:{id:"@id",workdiaryId:"@workdiaryId"}},candidateAcceptsDeclinesOffer:{method:"POST",url:baseUrl+"/assignments/:id/cado",params:{status:"@status"},transformResponse:notify},managerSetupTeam:{method:"POST",url:baseUrl+"/assignments/:id/mst"},candidateAcceptsTeamAgreements:{method:"POST",url:baseUrl+"/assignments/:id/cata"},candidateProvidesTrackerPassword:{method:"POST",url:baseUrl+"/assignments/:id/cptp",headers:{"Content-Type":"text/plain;charset=UTF-8"}},getMemberProductivity:{method:"GET",cache:!0,url:baseUrl+"/assignments/:id/productivity",params:{id:"@assignmentId",type:"@type",date:"@date"}},getMemberProductivityFourWeeks:{method:"GET",isArray:!0,cache:!0,url:baseUrl+"/assignments/:id/productivity",params:{id:"@assignmentId",type:"four_weeks",date:"@date"}},getWeeklyTimeSheets:{method:"GET",isArray:!0,url:baseUrl+"/tracker/timesheet",params:{teamId:"@teamId",managerId:"@managerId",userId:"@userId",date:"@date",isCacheAccess:"@isCacheAccess"}},getMonthlyTimeSheets:{method:"GET",isArray:!0,url:baseUrl+"/tracker/timesheet/fourweeks",params:{teamId:"@teamId",managerId:"@managerId",userId:"@userId",date:"@date"}},changeTeam:{url:baseUrl+"/assignments/:id/mcct",method:"POST",params:{id:"@id",managerId:"@managerId",teamId:"@teamId"}},getMetricValues:{url:baseUrl+"/assignments/:id/metric/values",method:"GET",params:{id:"@id",type:"@type",from:"@from",to:"@to",refresh:"@refresh"}},changeToNewTeam:{url:baseUrl+"/assignments/:id/mccnt",method:"POST",params:{id:"@id",managerId:"@managerId"}},search:{url:baseUrl+"/assignments/search",method:"GET",cache:!1,param:{page:"@page",q:"@q",sortField:"@sortField",sortDir:"@sortDir",limit:"@limit",myTeam:"@myTeam",myCompany:"@myCompany",me:"@me",assgnId:"@assgnId"}},updateGoogleCalendar:{url:baseUrl+"/assignments/:id/calendar",method:"PUT",params:{id:"@id",googleCalendarEmail:"@googleCalendarEmail",googleCalendarId:"@googleCalendarId",googleAuthCode:"@googleAuthCode"}},unlinkGoogleCalendar:{url:baseUrl+"/assignments/:id/calendar",method:"DELETE",params:{id:"@id"}},updateMetricValues:{url:baseUrl+"/assignments/:id/metric/values/",method:"PUT",params:{id:"@id"}},updateMetricConfig:{url:baseUrl+"/assignments/:id/metric/config/",method:"PUT",params:{id:"@id"}}});return assignmentService.getCandidateAfterLoginPath=function(assignments,applications){for(var redirectPath="/candidate/dashboard",i=0;i<assignments.length;i++){if("ACTIVE"===assignments[i].status)return"/contractor/home";if("CANDIDATE_ACCEPTED"===assignments[i].status)return"/candidate/dashboard/hiring"}return"/candidate/dashboard"===redirectPath&&(assignments.length||applications.length>0)?"/candidate/dashboard/applications":redirectPath},assignmentService.filterActiveAssignmentsInRange=function(assignments,from,to,status,teamId,managerId){var activeAssignments=assignments.filter(function(a){var matchedHist=a.assignmentHistories.filter(function(h){var effectiveDateBegin=moment(h.effectiveDateBegin),effectiveDateEnd=moment(h.effectiveDateEnd);return!(teamId&&teamId!==h.team.id||managerId&&managerId!==h.manager.id||status&&status!==h.status||!(effectiveDateBegin<to)||h.effectiveDateEnd&&!(effectiveDateEnd>from))}).pop();return!!matchedHist&&(a.selectedHistory=matchedHist,!0)});return activeAssignments=_.uniq(_.pluck(activeAssignments,"id"))},assignmentService.getAssignmentEndDateInTeam=function(assignment,teamId,managerId){var matchedHist=assignment.assignmentHistories.filter(function(h){return!("TERMINATED"!==h.status&&"ACTIVE"!==h.status||null!==teamId&&h.team.id!==teamId||null!==managerId&&h.manager.id!==managerId)}).sort(function(a,b){return moment(a.effectiveDateBegin)-moment(b.effectiveDateBegin)}).pop();return matchedHist?"TERMINATED"===matchedHist.status?matchedHist.effectiveDateBegin:matchedHist.effectiveDateEnd:null},assignmentService.isAssignmentActiveInTeamForDate=function(assignment,teamId,date){var matchedHist=assignment.assignmentHistories.filter(function(h){return h.team.id.toString()===teamId.toString()&&"ACTIVE"===h.status&&date>=moment(h.effectiveDateBegin)&&(!h.effectiveDateEnd||date<moment(h.effectiveDateEnd))});return matchedHist&&matchedHist.length>0},assignmentService}),services.factory("AuditsService",function($resource,baseUrl){return $resource(baseUrl+"/admin/audits",{},{query:{method:"GET",params:{searchQuery:"@searchQuery",page:"@page"}}})}),services.factory("AuthenticationFactory",function($http,baseUrl){function base64encode(input){var chr1,chr2,enc1,enc2,enc3,output="",chr3="",enc4="",i=0;do chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+keyStr.charAt(enc1)+keyStr.charAt(enc2)+keyStr.charAt(enc3)+keyStr.charAt(enc4),chr1=chr2=chr3="",enc1=enc2=enc3=enc4="";while(i<input.length);return output}var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{login:function(email,password,bb1,bb2){var req={method:"POST",url:baseUrl+"/session/login",headers:{Authorization:"Basic "+base64encode(email+":"+password)},data:{blackbox:bb1,blackbox2:bb2}};return $http(req)},getUpdatedToken:function(){var req={method:"POST",url:baseUrl+"/session/token"};return $http(req)}}}),angular.module("bandcampApp").constant("APPLICATION_TASKS",{HACKERRANK_ASSIGNMENT:[{task:"candidateVerifiesEmailAddress",printableName:"Verify Email"},{task:"techTrialUpdatesStatus1",printableName:"Taking HR"},{task:"candidateProvidesContactInformation1",printableName:"Personal Information"},{task:"candidateCompletesProfile",printableName:"Complete Profile"},{task:"candidateStartsAssignment",printableName:"Invited to TT"},{task:"candidateEndsAssignment",printableName:"Taking TT"},{task:"techTrialUpdatesStatus2",printableName:"Waiting TT evaluation"},{task:"recruiterConductsPreMarketplaceInterview",printableName:"Pre-MP"}],HACKERRANK_FIVEQ:[{task:"candidateVerifiesEmailAddress",printableName:"Verify Email"},{task:"techTrialUpdatesStatus1",printableName:"Taking HR"},{task:"candidateProvidesContactInformation2",printableName:"Personal Information"},{task:"candidateSubmits5QTest",printableName:"Taking 5Qs"},{task:"recruitmentAnalystGrades5QTest",printableName:"Waiting 5Qs Evaluation"},{task:"accountManagerEndorsesApplication",printableName:"Waiting for Endorsement"},{task:"recruiterConductsPreMarketplaceInterview",printableName:"Pre-MP"}],FIVEQ:[{task:"candidateVerifiesEmailAddress",printableName:"Verify Email"},{task:"candidateProvidesContactInformation2",printableName:"Personal Information"},{task:"candidateSubmits5QTest",printableName:"Taking 5Qs"},{task:"recruitmentAnalystGrades5QTest",printableName:"Waiting 5Qs Evaluation"},{task:"accountManagerEndorsesApplication",printableName:"Waiting for Endorsement"},{task:"recruiterConductsPreMarketplaceInterview",printableName:"Pre-MP"}],HACKERRANK:[{task:"candidateVerifiesEmailAddress",printableName:"Verify Email"},{task:"techTrialUpdatesStatus1",printableName:"Taking HR"},{task:"candidateProvidesContactInformation1",printableName:"Personal Information"},{task:"candidateCompletesProfile",printableName:"Complete Profile"},{task:"recruiterConductsPreMarketplaceInterview",printableName:"Pre-MP"}],ALL:[{task:"candidateVerifiesEmailAddress",printableName:"Verify Email"},{task:"techTrialUpdatesStatus1",printableName:"Taking HR"},{task:"candidateProvidesContactInformation",printableName:"Personal Information"},{task:"candidateCompletesProfile",printableName:"Complete Profile"},{task:"candidateStartsAssignment",printableName:"Invited to TT"},{task:"candidateEndsAssignment",printableName:"Taking TT"},{task:"techTrialUpdatesStatus2",printableName:"Waiting TT evaluation"},{task:"candidateSubmits5QTest",printableName:"Taking 5Qs"},{task:"recruitmentAnalystGrades5QTest",printableName:"Waiting 5Qs Evaluation"},{task:"accountManagerEndorsesApplication",printableName:"Waiting for Endorsement"},{task:"recruiterConductsPreMarketplaceInterview",printableName:"Pre-MP"}]}),services.factory("CacheService",function($cacheFactory,$rootScope,baseUrl){return{remove:function(url,cache){url.indexOf(baseUrl)===-1&&(url=baseUrl+url),void 0!==$rootScope.runAsId&&(url+="?runAs="+$rootScope.runAsId),$cacheFactory.get(cache||"$http").remove(url)}}}),services.factory("CandidatesService",function($resource,baseUrl){return $resource(baseUrl+"/candidates/:id",{id:"@id"},{save:{method:"POST",url:baseUrl+"/public/candidates",transformRequest:function(data){return angular.toJson(data)}},update:{method:"PUT"},importProfile:{method:"POST",url:baseUrl+"/candidates/:id/importProfile"}})}),services.factory("CandidatesHelperService",function($resource,$http,baseUrl){return{checkSkypeIdUsed:function(skypeId){return $http.get(baseUrl+"/public/candidates/skypeId/exist?skypeId="+skypeId)}}}),services.factory("CategoriesService",function($resource,baseUrl){return $resource(baseUrl+"/public/categories",{},{query:{method:"GET",isArray:!0,cache:!0}})}),services.factory("CheckinService",function(baseUrl,$resource){return $resource(baseUrl+"/productivity/checkins",{},{list:{url:baseUrl+"/productivity/checkins",method:"GET",isArray:!0,params:{teamId:"@teamId",managerId:"@managerId",from:"@from",to:"@to",assignmentId:"@assignmentId",status:"@status"}},getBlockStreak:{url:baseUrl+"/productivity/checkins/blocks-streak",method:"GET",isArray:!0,params:{teamId:"@teamId",managerId:"@managerId"}},update:{url:baseUrl+"/productivity/checkins/:id",method:"PUT",params:{id:"@id"}},create:{url:baseUrl+"/productivity/checkins",method:"POST",params:{assignmentId:"@assignmentId"}}})}),services.factory("CompaniesService",function($resource,baseUrl){return $resource(baseUrl+"/companies/:id",{id:"@id",accountManagerId:"@accountManagerId"},{query:{url:baseUrl+"/companies",method:"GET",transformResponse:function(data){if(data){var res=angular.fromJson(data);return angular.isArray(res)&&(res=res[0]),data=res}},params:{page:"@page",accountManagerId:"@accountManagerId",searchWord:"@searchWord"}},update:{method:"PUT"}})}),services.factory("EarningsService",function(baseUrl,$resource){return $resource(baseUrl+"/users/current/payments",{from:"@from",to:"@to"},{list:{cache:!0,method:"GET",isArray:!0}})}),services.factory("PaymentReportService",function($http,baseUrl){return{downloadPdf:function(from,to){var config={method:"GET",url:baseUrl+"/payments/getPaymentReport?to="+to+"&from="+from,responseType:"arraybuffer"};return $http(config).success(function(res){return res}).error(function(res){return res})}}}),services.factory("ReportingService",function($resource,baseUrl){return $resource(baseUrl+"/reports",{},{runhiresCountReport:{method:"POST",url:baseUrl+"/reports/hires"},runMetricsReport:{method:"POST",url:baseUrl+"/reports/metrics"},runConversionReport:{method:"POST",url:baseUrl+"/reports/conversion",params:{conversionPeriod:"@conversionPeriod"}},runPipelineStatesReport:{method:"POST",url:baseUrl+"/reports/pipelineStates"},runTeamPerformanceReport:{method:"GET",url:baseUrl+"/reports/teamPerformance",params:{option:"@option",companyId:"@companyId",teamId:"@teamId",period:"@period",pastWeeks:"@pastWeeks"}}})}),services.factory("CountriesService",function($resource,baseUrl){return $resource(baseUrl+"/public/countries",{},{query:{method:"GET",isArray:!0,cache:!0}})}),services.factory("CrossoverTasksService",function($resource,baseUrl){return $resource(baseUrl+"/users/current/tasks")}),services.factory("DownloadService",function($http,baseUrl,$window,$sce,$rootScope,$q){function download(url,params,defaultFormat){var format="";angular.isDefined(defaultFormat)&&!defaultFormat||(format="&downloadFormat=CSV");var api=baseUrl+url,reportUrl=api+"?token="+$rootScope.getAuthToken()+format;for(var key in params)null!==params[key]&&(reportUrl+="&"+key+"="+params[key]);$rootScope.runAsId&&(reportUrl+="&runAs="+$rootScope.runAsId),$window.location.href=$sce.trustAsResourceUrl(reportUrl)}function download5QFile(url){return $http.get(url,{responseType:"arraybuffer"}).success(function(data){return data})}function downloadFile(url,newWindow){return $http.get(url,{responseType:"arraybuffer"}).then(function(d){var blob,url,data=d.data,headers=d.headers(),success=!1,filename=headers["x-filename"]||"resume.pdf",contentType=headers["content-type"]||"application/octet-stream";if(blob=new Blob([data],{type:contentType}),navigator.msSaveBlob)navigator.msSaveBlob(blob,filename);else{var saveBlob=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob;void 0!==saveBlob&&(saveBlob(blob,filename),success=!0)}if(!success){var urlCreator=window.URL||window.webkitURL||window.mozURL||window.msURL;if(urlCreator){var link=document.createElement("a");if("download"in link){blob=new Blob([data],{type:contentType}),url=urlCreator.createObjectURL(blob),link.setAttribute("href",url),link.setAttribute("download",filename);var event=document.createEvent("MouseEvents");event.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),link.dispatchEvent(event),success=!0}success||(navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&!navigator.userAgent.match("CriOS")&&newWindow?(url="data:"+contentType+";base64,"+_arrayBufferToBase64(data),newWindow.name="Crossover",newWindow.location.href=url):(blob=new Blob([data],{type:"application/octet-stream"}),url=urlCreator.createObjectURL(blob),window.location=url),success=!0)}}},function(data){var decoded=String.fromCharCode.apply(null,new Uint8Array(data.data));return $q.reject(JSON.parse(decoded))})}function _arrayBufferToBase64(buffer){for(var binary="",bytes=new Uint8Array(buffer),len=bytes.byteLength,i=0;i<len;i++)binary+=String.fromCharCode(bytes[i]);return window.btoa(binary)}return{download:download,downloadFile:downloadFile,download5QFile:download5QFile}}),services.factory("EmailUpdateService",function($resource,baseUrl){return $resource(baseUrl+"/users/current/email/:email",{email:"@email"},{post:{method:"POST"}})}),services.factory("EnumsService",function($resource,baseUrl){return $resource(baseUrl+"/public/enums",{},{get:{cache:!0},getDays:{url:"data/days.json",isArray:!0,cache:!0}})}),services.factory("fileReader",function($q){var onLoad=function(reader,deferred,scope){return function(){scope.$apply(function(){deferred.resolve(reader.result)})}},onError=function(reader,deferred,scope){return function(){scope.$apply(function(){deferred.reject(reader.result)})}},onProgress=function(reader,scope){return function(event){scope.$broadcast("fileProgress",{total:event.total,loaded:event.loaded})}},getReader=function(deferred,scope){var reader=new FileReader;return reader.onload=onLoad(reader,deferred,scope),reader.onerror=onError(reader,deferred,scope),reader.onprogress=onProgress(reader,scope),reader},readAsDataURL=function(file,scope){var deferred=$q.defer(),reader=getReader(deferred,scope);return reader.readAsDataURL(file),deferred.promise},dataURItoBlob=function(dataURI){var byteString;byteString=dataURI.split(",")[0].indexOf("base64")>=0?atob(dataURI.split(",")[1]):decodeURI(dataURI.split(",")[1]);for(var mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],ia=new Uint8Array(byteString.length),i=0;i<byteString.length;i++)ia[i]=byteString.charCodeAt(i);return new Blob([ia],{type:mimeString})};return{readAsDataUrl:readAsDataURL,dataURItoBlob:dataURItoBlob}}),services.factory("Flash",function($rootScope,$location){var flKey="__$FLASH_KEY",queue=[];if(window.localStorage)if(window.localStorage.hasOwnProperty(flKey)){var val=window.localStorage[flKey];queue=angular.isDefined(val)?JSON.parse(val):[]}else queue=[];var saveQueue=function(){window.localStorage&&(window.localStorage[flKey]=JSON.stringify(queue))},currentMessage="",disableUpdate=!1,updateMessage=function(){return disableUpdate?void(disableUpdate=!1):(currentMessage=queue.shift()||"",void saveQueue())},addMessage=function(message,type,redirect){queue.push({message:message,type:type,redirect:redirect}),saveQueue(),angular.isDefined(redirect)&&(updateMessage(),disableUpdate=!0,$location.path(redirect))};return $rootScope.Flash=this,{addSuccess:function(msg,redirect){addMessage(msg,"success",redirect)},addError:function(msg,redirect){addMessage(msg,"error",redirect)},addInfo:function(msg,redirect){addMessage(msg,"info",redirect)},add:addMessage,getMessage:function(){return updateMessage(),currentMessage}}}),services.factory("GlobalDataFactory",function(){var globalData={};return{getItem:function(key){return globalData[key]},setItem:function(key,value){globalData[key]=value},deleteItem:function(key){delete globalData[key]},data:globalData}}),services.factory("GoogleLocationService",function(){return{getCity:function(e){var parts=e.split(","),city=parts[0],result={city:city};return 3===parts.length?(result.state=parts[1],result.country=parts[2]):result.country=parts[1],_.each(result,function(v,p){result[p]=(""+v).trim()}),result}}}),services.factory("highlight",function(){function iterate(obj,regex){Object.keys(obj).forEach(function(key){angular.isObject(obj[key])?iterate(obj[key],regex):angular.isString(obj[key])&&(obj[key]=obj[key].replace(regex,wrap))})}function wrap(word){return"<mark>"+word+"</mark>"}function highlightRegex(query){var tokens=[];return escape(query).match(/(".*?"|[^"\s]+)+(?=\s*|\s*$)/g).forEach(function(match){tokens.push(match.replace(/['"]+/g,""))}),new RegExp(tokens.join("|"),"ig")}function escape(str){return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}return function(obj,query){return iterate(obj,highlightRegex(query)),obj}}),services.factory("IndustriesService",function($resource,baseUrl){return $resource(baseUrl+"/public/industries",{},{query:{method:"GET",isArray:!0,cache:!0}})}),services.factory("IntegrationsService",function($resource,baseUrl){return $resource(baseUrl+"/integrations",{},{list:{method:"GET",isArray:!0},get:{method:"GET",url:baseUrl+"/integrations/:type",params:{type:"@type"}},update:{method:"PUT",url:baseUrl+"/integrations/:type",params:{type:"@type",enabled:"@enabled"}},metrics:{method:"GET",url:baseUrl+"/integrations/metrics",isArray:!0}})}),services.factory("InterviewsService",function(baseUrl,$resource,$rootScope,$cookies){var notify=function(data){return $rootScope.updateNotifications(),angular.fromJson(data)},res=$resource(baseUrl+"/interviews/:id",{id:"@id"},{list:{url:baseUrl+"/interviews",method:"GET",params:{avatarType:"@avatarType",selectionId:"@selectionId",candidateId:"@candidateId",status:"@status",selectionStatus:"@selectionStatus",type:"@type"},transformResponse:function(data){var copied=data;return angular.isObject(data)||(copied=angular.fromJson(data)),angular.isDefined(copied.content)?(copied.content=copied.content.map(function(interview){var date=moment(interview.startDateTime),offset=interview.selection.manager.location.timeZone.offset,calculatedDate=new Date(date.add(offset,"ms"));return calculatedDate.setTime(calculatedDate.getTime()+6e4*calculatedDate.getTimezoneOffset()),interview.date=calculatedDate,interview}),copied):copied}},update:{url:baseUrl+"/interviews/:id/mci",method:"PUT",params:{id:"@id"},transformResponse:notify},acceptSlot:{url:baseUrl+"/interviews/:id/cadi",method:"PUT",params:{status:"@status"},transformResponse:notify}});return res.checkAvailable=function(candidate){var excludes=$cookies.availabilityWarningUsers||[];return"MORE_THAN_4_WEEKS"!==candidate.availability||excludes.indexOf(candidate.id)>-1},res}),services.factory("InvoicesService",function($resource,baseUrl){return $resource(baseUrl+"/invoices/:id",{id:"@id",assignmentId:"@assignmentId",status:"@status"},{edit:{method:"PUT"}})}),services.factory("InvoicesReportService",function($resource,baseUrl){return $resource(baseUrl+"/invoices",{},{get:{method:"GET",url:baseUrl+"/invoices/:id/items",cache:!0,pageSize:"@pageSize"}})}),services.factory("JobApplicationService",function($resource,$location,$http,baseUrl,$window,GlobalDataFactory,$uibModal,routePrefix,$rootScope){function getPage(currentPage,targetPage,id){return currentPage!==targetPage?"/candidate/application/"+targetPage+"/"+id:null}function cancelApplicationModal(app){$uibModal.open({templateUrl:routePrefix+"candidate/application/cancel-application-modal.tpl.html",controller:function($scope,$uibModalInstance){$scope.modal=$uibModalInstance}}).result.then(function(){applicationService.cancel({id:app.id},function(){$location.search("cancel",null),$location.path("/marketplace/available-jobs")})},function(){$location.search("cancel",null),$window.history.back()})}var baseURI="/applications/",applicationService=$resource(baseUrl+baseURI+":id",{id:"@id",page:"@page",jobId:"@jobId"},{list:{url:baseUrl+baseURI+"list",cache:!1,method:"POST",params:{page:"@page",jobId:"@jobId"}},getApplications:{url:baseUrl+baseURI+"list",cache:!1,method:"POST",params:{page:"@page",orderBy:"@orderBy",sortDir:"@sortDir",avatarType:"@avatarType"}},reapply:{url:baseUrl+baseURI,cache:!1,method:"PUT",params:{oldApplicationId:"@oldApplicationId"}},getScores:{url:baseUrl+baseURI+"scores/statistics",cache:!1,isArray:!0,params:{jobId:"@jobId",testId:"@testId"}},getApplicantsPerDay:{url:baseUrl+baseURI+"statistics",cache:!1,isArray:!0,params:{jobId:"@jobId",type:"@type",endDate:"@endDate"}},test:{url:baseUrl+baseURI+":id/test/current",params:{id:"@id"}},getCampaigns:{url:baseUrl+baseURI+"campaigns",method:"GET",isArray:!0},checkCanApply:{url:baseUrl+baseURI+"check",method:"POST",params:{jobId:"@jobId"}},getLanguageReviews:{url:baseUrl+baseURI+"rarset",isArray:!0},getWrittenEvaluationReviews:{url:baseUrl+baseURI+"ragwe",isArray:!0},getWrittenEvaluationReview:{url:baseUrl+baseURI+":id/fqr",method:"GET"},raReviewsSpokenTest:{url:baseUrl+baseURI+":id/rarset",method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"}},raReviewsWrittenEvaluation:{url:baseUrl+baseURI+":id/rag5qt",method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"}},updateFiveqScore:{method:"PUT",url:baseUrl+baseURI+":id/5q",params:{sequenceNumber:"@sequenceNumber",score:"@score"}},updateFiveqScoreBatch:{method:"PUT",url:baseUrl+baseURI+"5qbatch"},resumeRubricEvaluations:{method:"GET",url:baseUrl+baseURI+"reru",params:{jobId:"@jobId"},isArray:!0},raAddRubricScore:{method:"PUT",url:baseUrl+baseURI+":id/test/resumeRubrics",params:{resumeRubricId:"@resumeRubricId",score:"@score"}},resumeRubricScoreBatch:{method:"PUT",url:baseUrl+baseURI+"rrbatch"},raAddOtherTestScore:{method:"PUT",url:baseUrl+baseURI+":id/test/other",params:{otherTestId:"@otherTestId",otherCriterionId:"@otherCriterionId",score:"@score"}},otherTestScoreBatch:{method:"PUT",url:baseUrl+baseURI+"otherbatch"},endorsementAction:{method:"POST",url:baseUrl+baseURI+":id/amea",params:{accepted:"@accepted"},headers:{"Content-Type":"text/plain;charset=UTF-8"}},candidateProvidesContactInformation:{
method:"POST",url:baseUrl+baseURI+":id/cpci",interceptor:{response:$rootScope.updateNotifications}},scoreResumes:{url:baseUrl+baseURI+"resumeScore",method:"POST",params:{applicationId:"@applicationId"}},sendHmPreview:{url:baseUrl+baseURI+"hmPreview",method:"POST",params:{applicationsIds:"@applicationsIds"}},sendPassersPreview:{url:baseUrl+baseURI+"previewTestPassers",method:"POST",params:{applicationsIds:"@applicationsIds"}},getRating:{url:baseUrl+baseURI+":id/rating",method:"GET"},updateRating:{url:baseUrl+baseURI+":id/rating",method:"PUT",params:{rating:"@rating"}},getActivePreMPInterviews:{url:baseUrl+baseURI+"/rcpmi",isArray:!0},unPreview:{url:baseUrl+baseURI+"/preview",method:"DELETE",params:{applicationsIds:"@applicationsIds"}},cancel:{url:baseUrl+baseURI+":id/cancel",method:"POST"}});applicationService.getFileUrl=function(id,fileId){var url=baseUrl+baseURI+id+"/files?fileId="+fileId,req={method:"GET",url:url,transformResponse:function(data){return data.slice(1,-1)}};return $http(req)},applicationService.openFile=function(id,fileId){var newTab=$window.open("about:blank","_blank");return this.getFileUrl(id,fileId).success(function(res){newTab.location.href=res})},applicationService.openFileInGoogleDocViewer=function(id,fileId){var newTab=$window.open("about:blank","_blank");return this.getFileUrl(id,fileId).success(function(res){newTab.location.href=applicationService.getGoogleDocUrl(res)})},applicationService.getGoogleDocUrl=function(url){return"https://docs.google.com/gview?embedded=true&url="+encodeURIComponent(url)},applicationService.printDocument=function(data){if(data){var ifr=document.createElement("iframe");ifr.style.display="none",document.body.appendChild(ifr),ifr.contentWindow.document.open(),ifr.contentWindow.document.write(data),ifr.contentWindow.document.execCommand("print",!1,null)||ifr.contentWindow.print(),ifr.contentWindow.document.close()}};var tasks={candidateStartsHackerRank:{url:"first-test",step:2},candidateWaitsTestSetup:{url:"pending-test",step:2},techTrialUpdatesStatus1:{url:"first-test",step:2},candidateCompletesProfile:{url:"complete-profile",step:3},candidateStartsAssignment:{url:"second-test",step:4,state:"BEFORE-TEST"},candidateEndsAssignment:{url:"second-test",step:4,state:"ONGOING-TEST"},techTrialUpdatesStatus2:{url:"second-test",step:4,state:"AFTER-TEST"},techTrialUpdatesStatus3:{url:"second-chance",step:4,state:"AFTER-TEST"},recruiterConductsPreMarketplaceInterview:{url:"phone",step:5},candidateSubmits5QTest:{url:"questionnaire",step:3},recruitmentAnalystGrades5QTest:{url:"second-test",step:3,state:"AFTER-TEST"},recruitmentAnalystReviewsSpokenEnglishTest2:{url:"second-test",step:4,state:"AFTER-TEST"},accountManagerEndorsesApplication:{url:"second-test",step:4,state:"AFTER-TEST"}};return applicationService.getTasksNames=function(){var tasks={candidateVerifiesEmailAddress:"Verify Email",candidateSpokenEnglishTest:"Taking English Test",recruiterReviewsSpokenEnglishTest2:"Reviewing English Test",candidateWaitsTestSetup:"Awaiting test setup",recruitmentAnalystGrades5QTest:"Reviewing 5Qs Test",candidateSubmits5QTest:"Taking 5Qs Test",candidateStartsHackerRank:"Invited to HackerRank",techTrialUpdatesStatus1:"Invited to HackerRank",candidateProvidesContactInformation1:"Entering Contact Info",candidateProvidesContactInformation2:"Entering Contact Info",candidateCompletesProfile:"Complete Profile",candidateStartsAssignment:"Invited to TechTrial",candidateEndsAssignment:"Taking TechTrial",techTrialUpdatesStatus2:"Reviewing TechTrial",techTrialUpdatesStatus3:"Second Chance",recruiterConductsPreMarketplaceInterview:"Pre-Marketplace Approval",accountManagerEndorsesApplication:"AM Endorses Application"};return tasks},applicationService.identifyCurrentStep=function(application,currentPage,callback){var path=null,step=null;if(GlobalDataFactory.setItem("application",application),"REJECTED"===application.status)$location.path("/candidate/application/rejected");else if("ACCEPTED"===application.status)$location.path("/candidate/application/accepted");else if(_.isEmpty($location.search().cancel))if("candidateProvidesContactInformation1"===application.task||"candidateProvidesContactInformation2"===application.task)path=getPage(currentPage,"contact-data",application.id),step=application.job.flowType.indexOf("HACKERRANK")>=0?3:2;else{var task=tasks[application.task||Object.keys(tasks)[0]];step=task.step,GlobalDataFactory.setItem("application.state",task.state),path=getPage(currentPage,task.url,application.id),"recruitmentAnalystReviewsSpokenEnglishTest1"===application.task&&path&&(path+="/verification"),"recruitmentAnalystGrades5QTest"===application.task&&"HACKERRANK_FIVEQ"===application.job.flowType&&(step=4)}else cancelApplicationModal(application);GlobalDataFactory.setItem("currentStep",step),path?$location.path(path):callback&&callback()},applicationService.setResumeThresholds=function(score){var sum=_.reduce(_.pluck(score.test.weightedKeywords,"weight"),function(memo,num){return memo+num});return score.test.highThreshold=score.test.highThreshold/sum*100,score.test.lowThreshold=score.test.lowThreshold/sum*100,score},applicationService}),services.factory("JobService",function($resource,$http,baseUrl,$cacheFactory){var jobCache;try{jobCache=$cacheFactory("jobCache")}catch(e){jobCache=$cacheFactory.get("jobCache")}return{crud:$resource(baseUrl+"/public/jobs/:id",{id:"@id"},{query:{method:"GET",isArray:!0,cache:!0,params:{avatarType:"@avatarType"}},getByTitle:{url:baseUrl+"/public/jobs/title/:title",method:"GET"},update:{url:baseUrl+"/jobs/:id",method:"PUT"},list:{method:"GET",url:baseUrl+"/public/jobs",params:{accountManagerId:"@accountManagerId",flowType:"@flowType"},cache:!0,isArray:!0},findMatchingJobs:{method:"GET",url:baseUrl+"/public/jobs/findmatching",cache:!0,isArray:!0},listWithSameTestStrategy:{method:"GET",url:baseUrl+"/jobs/:id/sameTest",params:{id:"@id"},isArray:!0},save:{url:baseUrl+"/jobs",method:"POST"},getAuthenticated:{url:baseUrl+"/jobs/:id",cache:jobCache,params:{id:"@id"}},demand:{url:baseUrl+"/jobs/:id/demand",method:"PUT",params:{managerId:"@managerId",demand:"@demand"}},statistics:{url:baseUrl+"/jobs/statistics",isArray:!0},statisticsByJob:{url:baseUrl+"/jobs/:id/statistics",isArray:!0},sourcing:{url:baseUrl+"/jobs/sourcing"},sourcingByJob:{url:baseUrl+"/jobs/:id/sourcing"},campaignSourcing:{url:baseUrl+"/jobs/campaignstats"},subscribe:{url:baseUrl+"/jobs/:id/subscribe",method:"POST"},unsubscribe:{url:baseUrl+"/jobs/:id/subscribe",method:"DELETE"},health:{url:baseUrl+"/jobs/health",isArray:!0},updateSourcing:{url:baseUrl+"/jobs/:id/sourcing",method:"PUT"},labels:{url:baseUrl+"/public/jobs/labels/all",method:"GET",params:{label:"@label",title:"@title",page:"@page"},isArray:!0,cache:!0},requestApprovalAM:{url:baseUrl+"/jobs/:id/calibration",method:"POST",params:{type:"@type"}},requestApprovalHM:{url:baseUrl+"/jobs/:id/calibration",method:"PUT",params:{type:"@type"}},saveNote:{url:baseUrl+"/jobs/:id/notes",method:"POST",params:{avatarType:"@userAvatarType"},isArray:!0},getNotes:{url:baseUrl+"/jobs/:id/notes",method:"GET",params:{type:"@type"},isArray:!0},getJobsSlas:{url:baseUrl+"/slas/jobs",isArray:!0},getSlas:{url:baseUrl+"/slas",isArray:!0}}),validate:function(inputData){var data=angular.copy(inputData);if(angular.isDefined(data.team)){var team=data.team;data.team={id:team}}else delete data.team;if(angular.isArray(data.skills)&&data.skills.length>0){var skills=angular.copy(data.skills);data.skills=[],angular.forEach(skills,function(value){angular.isObject(value)&&angular.isDefined(value.id)&&data.skills.push({id:value.id})})}else delete data.skills;return data},isAvailable:function(job){return void 0!==job&&job.status&&"ACTIVE"===job.status}}}),services.factory("LanguageService",function($resource,baseUrl){return $resource(baseUrl+"/public/languages/:id",{id:"@id"})}),services.factory("LinkedInService",function($http,baseUrl,$rootScope,localStorageService,clientUrl,UtilsService,linkedInApiKey){var profileData=null;return{generateAuthorizationUrl:function(importProfileType){var urlParams={base:"https://www.linkedin.com/uas/oauth2/authorization?response_type=code",clientId:linkedInApiKey,scope:["r_basicprofile","r_fullprofile","r_emailaddress","r_contactinfo"],state:UtilsService.generateRandomString(),redirectUri:clientUrl+"/linkedin.html"},url=urlParams.base+"&client_id="+urlParams.clientId+"&scope="+urlParams.scope.join(" ")+"&state="+urlParams.state;return importProfileType&&(url+=importProfileType),url+="&redirect_uri="+urlParams.redirectUri},authenticate:function(authorizationCode,successCallback,errorCallback){var bb1,bb2;try{bb1=fpGetBlackbox()}catch(e){bb1=null}try{bb2=ioGetBlackbox()}catch(e){bb2=null}$http.post(baseUrl+"/public/session/login/linkedin",{token:authorizationCode,blackbox:bb1,blackbox2:bb2}).success(function(response){$rootScope.setAuthToken(response.token),successCallback(response)}).error(function(response){errorCallback(response)})},setJobApplicationData:function(data){localStorageService.set("jobApplicationData",data)},getJobApplicationData:function(){var data=localStorageService.get("jobApplicationData");return localStorageService.remove("jobApplicationData"),data},setRedirectUrl:function(url){localStorageService.set("linkedinRedirectUrl",url)},getRedirectUrl:function(){return localStorageService.get("linkedinRedirectUrl")},setProfileData:function(data){profileData=data},getProfileData:function(){return profileData},setProfileImportFlag:function(){localStorageService.set("profileImportFlag",!0)},getProfileImportFlag:function(){var data=localStorageService.get("profileImportFlag");return localStorageService.remove("profileImportFlag"),data},setApplicationId:function(data){localStorageService.set("jobApplicationId",data)},getApplicationId:function(){var data=localStorageService.get("jobApplicationId");return localStorageService.remove("jobApplicationId"),data},setJobId:function(data){localStorageService.set("jobId",data)},getJobId:function(){var data=localStorageService.get("jobId");return localStorageService.remove("jobId"),data},setShowContractDashboard:function(){localStorageService.set("showContractDashboard",!0)},getShowContractDashboard:function(){var showContractDashboard=localStorageService.get("showContractDashboard");return localStorageService.remove("showContractDashboard"),showContractDashboard}}}),services.service("Location",function($resource,baseUrl){return $resource(baseUrl+"/locations/:id",{},{update:{method:"PUT",params:{id:"@id"}}})}),services.service("LocationUtils",function(){var UPPER_BOUND=-164.5,LOWER_BOUND=-175.8,CENTER=Math.abs((UPPER_BOUND-LOWER_BOUND)/2),getText=function(loc){if(void 0!==loc.latLong){var latLong=loc.latLong.split(",");if(isNaN(latLong[0])||isNaN(latLong[1]))return;var longitude=latLong[1];return longitude>LOWER_BOUND&&longitude<UPPER_BOUND&&(longitude=Math.abs(LOWER_BOUND-longitude)<=CENTER?LOWER_BOUND:UPPER_BOUND),loc.latLong=latLong[0]+","+longitude,[loc.latLong].filter(function(item){return item}).join(",").replace(/['"]/g,"")}return[loc.country.name].filter(function(item){return item}).join(",").replace(/['"]/g,"")};return{getText:getText}}),services.factory("ManagerService",function($resource,baseUrl){return $resource(baseUrl+"/managers",{},{get:{cache:!0,isArray:!0},save:{method:"POST",url:baseUrl+"/public/managers"},getReportingManagers:{method:"GET",isArray:!0,params:{managerId:"@managerId",avatarType:"MANAGER"}},listTeamLogicalManagers:{url:baseUrl+"/managers/logicalWatchers/:teamId",method:"GET",isArray:!0,cache:!0,params:{teamId:"@teamId"}},listTeamReportingManagers:{url:baseUrl+"/managers/teamReporting/:teamId",method:"GET",isArray:!0,cache:!0,params:{teamId:"@teamId"}},listJobDemands:{url:baseUrl+"/managers/:id/job/demands",method:"GET",isArray:!0,params:{id:"@id"}},getManager:{url:baseUrl+"/managers/:id",method:"GET",params:{id:"@id"}},update:{url:baseUrl+"/managers/:id",method:"PUT",params:{id:"@id"}},updateJiraSetup:{cache:!1,url:baseUrl+"/managers/jiraSetup",method:"PUT"},updateZendeskSetup:{url:baseUrl+"/managers/zendeskSetup",method:"PUT"},updateDeskSetup:{url:baseUrl+"/managers/deskSetup",method:"PUT"},updateSpreadsheetSetup:{url:baseUrl+"/managers/spreadsheetSetup",method:"PUT"},updateSalesforceSetup:{url:baseUrl+"/managers/salesforceSetup",method:"PUT"},addFeedback:{url:baseUrl+"/managers/feedback",method:"POST"},deleteJiraSetup:{url:baseUrl+"/managers/jiraSetup/:id",method:"DELETE",params:{id:"@id",teamId:"@teamId"}},deleteZendeskSetup:{url:baseUrl+"/managers/zendeskSetup/:id",method:"DELETE",params:{id:"@id",teamId:"@teamId"}},deleteDeskSetup:{url:baseUrl+"/managers/deskSetup/:id",method:"DELETE",params:{id:"@id",teamId:"@teamId"}},deleteSpreadsheetSetup:{url:baseUrl+"/managers/spreadsheetSetup/:id",method:"DELETE",params:{id:"@id",teamId:"@teamId"}}})}),services.factory("ManagerInvitationService",function($resource,baseUrl){return $resource(baseUrl+"/managerInvitations",{},{save:{method:"POST",isArray:!0},findByToken:{url:baseUrl+"/public/managerInvitations",method:"GET",params:{t:"@t"},cache:!1},resend:{method:"POST",url:baseUrl+"/managerInvitations/:id/resend",params:{id:"@id"}}})}),services.factory("AccountManagerService",function($resource,baseUrl){return $resource(baseUrl+"/accountManagers")}),services.factory("ManagerCommonService",function(){function addFrequencyToAssingment(assignment){var frequencies=[{id:0,name:"Disabled"},{id:1,name:"1x"},{id:2,name:"2x"},{id:5,name:"5x"},{id:10,name:"10x"}];return assignment.featureValues?assignment.screenshootFrequencies=frequencies:(assignment.featureValues={screenshotFrequency:0,webcamshotFrequency:0},assignment.screenshootFrequencies=[{id:0,name:"Disabled"}],assignment.screenshootFrequency=assignment.screenshootFrequencies[0]),assignment}return{addFrequencyToAssingment:addFrequencyToAssingment}}),services.factory("MarketplaceMembersService",function($resource,baseUrl,InterviewsService,SelectionService,$location,$uibModal,routePrefix){var resource=$resource(baseUrl+"/marketplaceMembers/:id",{id:"@id"},{matches:{method:"POST",url:baseUrl+"/marketplaceMembers/matches",isArray:!0},simpleMatches:{method:"GET",url:baseUrl+"/marketplaceMembers/matches",params:{jobId:"@jobId",page:"@page"},isArray:!1},all:{method:"GET",url:baseUrl+"/marketplaceMembers",params:{jobId:"@jobId",page:"@page",candidateId:"@candidateId",status:"@status"},isArray:!1},update:{method:"PUT"},disable:{method:"POST",url:baseUrl+"/marketplaceMembers/:id/disable",params:{id:"@id"}},enable:{method:"POST",url:baseUrl+"/marketplaceMembers/:id/enable",params:{id:"@id"}}});return resource.availabilityModal=function(mm,type){$uibModal.open({templateUrl:routePrefix+"interview/availability-warning.tpl.html",controller:"AvailabilityModalCtrl",backdrop:"static",resolve:{marketplaceMember:function(){return mm},type:function(){return type}}})},resource.hire=function(marketplaceMember){if(InterviewsService.checkAvailable(marketplaceMember.application.candidate)){var redirect=function(){$location.path("/hire/direct/"+marketplaceMember.id)},modalInstance=$uibModal.open({templateUrl:routePrefix+"job/job-candidates-hire-confirm.tpl.html",controller:"JobCandidatesHireConfirmCtrl",backdrop:"static"});modalInstance.result.then(function(){SelectionService.advancePaymentModal(marketplaceMember.application.candidate,redirect)})}else resource.availabilityModal(marketplaceMember,"HIRE")},resource}),services.factory("MessagesService",function(){var messages={alignmentScore:"This score measures how aligned the individual is to the managers plan by comparing the minutes spent on each activity with the target schedule laid out by the manager.",focusScore:"This score represents the individuals ability to focus on one activity at a time rather than frequently switching from one activity to another.",intensityScore:"This score uses keyboard strokes and mouse clicks to represent the intensity of the work the individual is performing on his or her computer."};return messages}),services.factory("MigratedUserService",function($resource,baseUrl,$rootScope){var users=$resource(baseUrl+"/migratedCandidates/:id",{id:"@id"},{edit:{method:"PUT"}}),managers=$resource(baseUrl+"/migratedManagers/:id",{id:"@id"},{edit:{method:"PUT"}}),nextStep=function(user){var refresh=function(){$rootScope.menuRefresh=$rootScope.menuRefresh+1};if(angular.isDefined(user.avatarTypes))for(var i=user.avatarTypes.length;i--;)switch(user.avatarTypes[i]){case"MIGRATED_MANAGER":switch(user.status){case"INITIAL":return"/migrated/password";default:return refresh(),"/manager/dashboard/home"}case"MIGRATED_CANDIDATE":switch(user.status){case"INITIAL":return"/migrated/password";case"PASSWORD_CHANGED":return"/migrated/job";case"JOB_OFFER_ACCEPTED":return"/migrated/terms";case"AGREEMENT_ACCEPTED":return"/migrated/payoneer";case"PAYONEER_SETUP":return refresh(),"/migrated/worksmart";default:return refresh(),"/candidate/dashboard/home"}case"MANAGER":return refresh(),"/manager/dashboard/home";case"CANDIDATE":return refresh(),"/candidate/dashboard/home"}return refresh(),"/candidate/dashboard/home"};return{users:users,managers:managers,nextStep:nextStep}}),services.factory("NotificationService",function(){function getUserLocalTime(user,startDateTime){var date=moment.utc(startDateTime),offset=user.location.timeZone.offset,calculatedDate=new Date(date.add(offset,"ms"));return calculatedDate.setTime(calculatedDate.getTime()+6e4*calculatedDate.getTimezoneOffset()),moment(date).format("MMM DD, YYYY hh:mm a")}var templates=[{taskType:"candidateAcceptsDeclinesInterview",message:'Congratulations! You have been invited for an interview with %NAME% for position %POSITION%, please follow <a href="%URL%">this link</a> to proceed.',url:"interview/%ID%/view"},{taskType:"leaderTeamInterview_INITIAL",message:'Congratulations! You have been invited for an interview with %NAME% to discuss hiring %TEAM% team, please follow <a href="%URL%">this link</a> to proceed.',url:"teaminterview/%ID%/view"},{taskType:"hmTeamInterview_CANDIDATE_ACCEPTED",message:'You have an upcoming interview on %DATE% with %NAME% to discuess hiriing %TEAM% team. Click on this <a href="%URL%">this link</a> to proceed when it is time to start the interview.',url:"teaminterview/%ID%/video-conference"},{taskType:"candidateAttendsInterview",message:'You have an upcoming interview on %DATE% with %NAME% for position %POSITION%. Click on this <a href="%URL%">this link</a> to proceed when it is time to start the interview.',url:"interview/%ID%/video-conference"},{taskType:"leaderTeamInterview_CANDIDATE_ACCEPTED",message:'You have an upcoming interview on %DATE% with %NAME% to discuess hiring %TEAM% team. Click on this <a href="%URL%">this link</a> to proceed when it is time to start the interview.',url:"teaminterview/%ID%/video-conference"},{taskType:"candidateWasRescheduled",message:'The hiring manager %NAME%has asked for a postponement of the interview for position %POSITION%. Please click on <a href="%URL%">this link</a> to rechedule your interview',url:"interview/%ID%/video-conference"},{taskType:"candidateAcceptsDeclinesOffer",message:'Congratulations! You have received an offer, please follow <a href="%URL%">this link</a> to proceed.',url:"contract/%ID%/view"},{taskType:"candidateProvidesTrackerPassword",message:'Congratulations! You have accepted an offer, please follow <a href="%URL%">this link</a> to setup your Crossover Tracker account.',url:"contract/%ID%/tracker"},{taskType:"candidateSetsUpPayoneer",message:'Please follow <a href="%URL%">this link</a> to setup your Payoneer account.',url:"onboard/payoneer"},{taskType:"candidateAcceptsAgreements",message:'Please follow <a href="%URL%">this link</a> to accept team agreement and start working.',url:"contract/%ID%/agree"},{taskType:"managerConductsInterview",message:'You have an upcoming interview on %DATE% with %NAME% for position %POSITION%. Click on this <a href="%URL%">this link</a> to proceed when it is time to start the interview.',url:"interview/%ID%/video-conference"},{taskType:"managerDecidesOnSelection",message:'Please follow <a href="%URL%">this link</a> to make a decision about %NAME%.',url:"interview/%ID%/view"},{taskType:"managerApprovesPayment",message:'Please follow <a href="%URL%">this link</a> to approve the invoice for the assignemnt.',url:"assignments/%ID%/setup-payment"},{taskType:"managerSelectsTeam",message:'Please follow <a href="%URL%">this link</a> to setup the team for %NAME%.',url:"manager/candidates"},{taskType:"candidateStartsHackerRank",message:'Please follow <a href="%URL%">this link</a> to start your technical screen.',url:"candidate/application/contact-data/%ID%"},{taskType:"techTrialUpdatesStatus1",message:'Please follow <a href="%URL%">this link</a> to start your technical screen.',url:"candidate/application/contact-data/%ID%"},{taskType:"candidateCompletesProfile",message:'Please follow <a href="%URL%">this link</a> to create your profile.',url:"candidate/application/complete-profile/%ID%"},{taskType:"candidateStartsAssignment",message:'Please follow <a href="%URL%">this link</a> to start your project evaluation.',url:"candidate/application/second-test/%ID%"},{taskType:"candidateEndsAssignment",message:'Please follow <a href="%URL%">this link</a> to submit your project evaluation.',url:"candidate/application/second-test/%ID%"},{taskType:"candidateProvidesContactInformation1",message:'Please follow <a href="%URL%">this link</a> to update your contact data.',url:"candidate/application/contact-data/%ID%"},{taskType:"candidateProvidesContactInformation2",message:'Please follow <a href="%URL%">this link</a> to update your contact data.',url:"candidate/application/contact-data/%ID%"}],getList=function(tasks){var notifications=[];return tasks.forEach(function(task){var template=templates.filter(function(t){return t.taskType===task.taskType})[0];if(template){var notification={},url=template.url,object=task.object,txt=template.message;if(object&&object.id){"candidateAttendsInterview"===task.taskType||"candidateWasRescheduled"===task.taskType||"candidateAcceptsDeclinesInterview"===task.taskType?txt=template.message.replace(/%DATE%/,getUserLocalTime(object.selection.marketplaceMember.application.candidate,object.startDateTime,object.selection.manager.location.timeZone.offset)).replace(/%NAME%/,object.selection.manager.printableName).replace(/%POSITION%/,object.selection.marketplaceMember.application.job.title):"leaderTeamInterview_INITIAL"===task.taskType?txt=template.message.replace(/%NAME%/,object.selection.manager.printableName).replace(/%TEAM%/,object.selection.team.name):"hmTeamInterview_CANDIDATE_ACCEPTED"===task.taskType?txt=template.message.replace(/%DATE%/,getUserLocalTime(object.selection.manager,object.startDateTime)).replace(/%NAME%/,object.interviewee.printableName).replace(/%TEAM%/,object.selection.team.name):"leaderTeamInterview_CANDIDATE_ACCEPTED"===task.taskType?txt=template.message.replace(/%DATE%/,getUserLocalTime(object.interviewee,object.startDateTime)).replace(/%NAME%/,object.selection.manager.printableName).replace(/%TEAM%/,object.selection.team.name):"managerConductsInterview"===task.taskType?txt=template.message.replace(/%DATE%/,getUserLocalTime(object.selection.manager,object.startDateTime)).replace(/%NAME%/,object.selection.marketplaceMember.application.candidate.printableName).replace(/%POSITION%/,object.selection.marketplaceMember.application.job.title):"managerDecidesOnSelection"!==task.taskType&&"managerSelectsTeam"!==task.taskType||(txt=template.message.replace(/%NAME%/,object.selection.marketplaceMember.application.candidate.printableName)),url=template.url.replace(/%ID%/,object.id),notification.updated=object.updatedOn;var message=txt.replace(/%URL%/,url);notification.message=message,notifications.push(notification)}}}),notifications};return{getList:getList}}),services.factory("PasswordResetFactory",function($resource,baseUrl){return $resource(baseUrl+"/public/users/:email/reset",{},{assignToken:{method:"POST",params:{email:"@email"}}})}),services.factory("PasswordResetUpdateFactory",function($resource,baseUrl){return $resource(baseUrl+"/public/users/reset/:passwordResetToken",{},{show:{method:"GET"},update:{method:"PUT",params:{passwordResetToken:"@passwordResetToken"}}})}),services.factory("PasswordUpdateService",function($resource,baseUrl){return $resource(baseUrl+"/users/current/password",{},{post:{method:"POST"}})}),services.factory("PaymentDestinationsService",function($resource,baseUrl,$rootScope){var notify=function(data){return $rootScope.updateNotifications(),angular.fromJson(data)};return $resource(baseUrl+"/paymentdestinations",{type:"@type"},{query:{method:"GET",isArray:!0,transformResponse:notify}})}),services.factory("ProductivityService",function($resource,baseUrl,$cacheFactory){function transformResponse(data){var response=angular.fromJson(data);if(_.isArray(response))return response;var arr;for(var key in response)if(response.hasOwnProperty(key)&&_.isArray(response[key])){arr=response[key];break}return arr}var productivityCache;try{productivityCache=$cacheFactory("productivityCache")}catch(e){productivityCache=$cacheFactory.get("productivityCache")}return $resource(baseUrl+"/productivity/:id",{id:"@id"},{readApplications:{method:"GET",isArray:!0,cache:productivityCache,url:baseUrl+"/productivity/apps",params:{teamId:"@teamId",date:"@date"}},readActivities:{method:"GET",isArray:!0,cache:productivityCache,url:baseUrl+"/productivity/acts",params:{teamId:"@teamId",date:"@date"}},readTeamPlannedActivities:{method:"GET",isArray:!0,cache:productivityCache,url:baseUrl+"/productivity/team/acts"},addActivity:{method:"POST",url:baseUrl+"/productivity/act",params:{swapAliasesIfExist:"@swapAliasesIfExist"}},updateActivity:{method:"PUT",url:baseUrl+"/productivity/act",params:{swapAliasesIfExist:"@swapAliasesIfExist"}},deleteActivity:{method:"DELETE",url:baseUrl+"/productivity/act/:id",params:{id:"@id"}},addTeamActivity:{method:"POST",url:baseUrl+"/productivity/team/act",params:{managerId:"@id",teamId:"@teamId",activity:"@activity",startTime:"@startTime",endTime:"@endTime"}},updateTeamActivity:{method:"PUT",url:baseUrl+"/productivity/team/act",isArray:!0,params:{teamId:"@teamId"}},deleteTeamActivity:{method:"DELETE",url:baseUrl+"/productivity/team/act/:id",params:{id:"@planId"}},readTeamActivities:{cache:productivityCache,isArray:!0,url:baseUrl+"/tracker/activity/:groups",transformResponse:transformResponse},readGroupedTeamActivities:{cache:productivityCache,isArray:!0,url:baseUrl+"/tracker/activity/groups",params:{refresh:"@refresh"},transformResponse:transformResponse}})}),services.service("Profile",function($resource,baseUrl){return $resource(baseUrl+"/profiles/:id",{},{update:{method:"PUT",url:baseUrl+"/profiles"},get:{method:"GET",params:{id:"@id"}},summary:{method:"GET",params:{id:"@id"},url:baseUrl+"/profiles/:id/summary"},getForEmployer:{method:"GET",params:{id:"@id"},url:baseUrl+"/profiles/:id/employer"}})}),services.service("ProfileUtils",function($upload,$filter,baseUrl,UserService){var service={profilePhotoUrl:function(profile){return profile&&profile.photoUrl&&profile.photoUrl.length>0?profile.photoUrl:"/images/1f34682a.user.png"},countPassed:function(tests){var passed=0;if(tests)for(var i=0;i<tests.length;i++)parseFloat(tests[i].score)>=parseFloat(tests[i].test.passingScore)&&passed++;return passed},skillsStr:function(skills,limit){if(!skills||0===skills.length)return"";var skillsArr=[],i=0;for(limit=limit||5,i=0;i<skills.length&&i<limit;i++)skillsArr.push(skills[i].title);return i>=limit?skillsArr.join(", ")+"...":skillsArr.join(", ")},uploadProfilePhoto:function(profile,photo,callback){var id=profile.userId||profile.id;$upload.upload({url:baseUrl+"/users/"+id+"/image",fileFormDataName:"image",file:photo}).success(callback)},deleteProfilePhoto:function(profile,callback){UserService.user.deleteProfileImage({id:profile.id},profile).$promise.then(callback)},profileUrlPublic:function(profile){var pageUrl=location.href.replace(/#\/.*/g,"");return pageUrl+"profile/user-profile/"+profile.id},describeMoney:function(money){var prefix="$";return money?(money=(money+"").trim(),money.indexOf(">")>-1&&(money=money.replace(">","").trim(),prefix="More than "+prefix),prefix+$filter("currency")(Math.round(parseFloat(money)),"")):prefix+"0.00"},getTimeByOffset:function(op){if(void 0===op)return"";var date=new Date(Date.now()+op),hour=date.getUTCHours(),min=date.getUTCMinutes(),aP=hour>11?" PM":" AM";return hour>12&&(hour-=12),0===hour&&(hour=12),(hour>10?hour:"0"+hour)+":"+(min>10?min:"0"+min)+aP},getProfileTime:function(profile){return profile&&profile.user.location&&profile.user.location.timeZone?service.getTimeByOffset(profile.user.location.timeZone.offset):""},formatUtcOffset:function(offset){var cp=Math.abs(offset)/36e5,hours=Math.floor(cp),min=0;return cp>hours&&(min=60*(cp-hours)),(offset>=0?"+":"-")+(hours<10?"0"+hours:hours)+":"+(min<10?"0"+min:min)}};return service}),services.factory("RecruitersService",function($resource,baseUrl){return $resource(baseUrl+"/recruiters")}),services.factory("RecruiterCandidateApprovalService",function($resource,baseUrl){return $resource(baseUrl+"/applications/:id/preMarketplaceInterview",{id:"@id"},{edit:{method:"PUT"},get:{method:"GET"},acceptReject:{url:baseUrl+"/applications/:id/rcpmi",method:"POST",params:{id:"@id",accept:"@accept"}},removeFile:{url:baseUrl+"/applications/:id/files",method:"DELETE",params:{id:"@id",fileId:"@fileId"}}})}),services.factory("ReviewService",function($resource,baseUrl){return $resource(baseUrl+"/teams/:teamId/reviews/:reviewId",{},{status:{url:baseUrl+"/teams/:teamId/reviews/status",method:"GET",params:{teamId:"@teamId"}},create:{params:{teamId:"@teamId"},method:"POST"},get:{params:{teamId:"@teamId",date:"@date"},method:"GET"},update:{method:"PUT",params:{teamId:"@team.id",reviewId:"@id"}}})}),services.factory("SelectionService",function($resource,baseUrl,$uibModal,CurrentUser,CompaniesService){var res=$resource(baseUrl+"/selections/:id",{id:"@id",status:"@status",marketplaceMemberId:"@marketplaceMemberId"},{query:{isArray:!1},directOffer:{method:"POST",url:baseUrl+"/selections/direct"},mdos:{method:"PUT",url:baseUrl+"/selections/:id/mdos",params:{status:"@status"}},cancel:{method:"DELETE",url:baseUrl+"/selections/:id"},directAssignment:{method:"POST",url:baseUrl+"/selections/directAssignment"},tasks:{method:"GET",url:baseUrl+"/selections/:id/tasks",isArray:!0}});return res.advancePaymentModal=function(candidate,callback){CurrentUser.getAvatar({avatarType:"MANAGER"},function(cu){!cu.company.internal&&cu.company.advancePaymentPeriod>0?CompaniesService.get({id:cu.company.id},function(company){$uibModal.open({templateUrl:"advance-payment-modal.tpl.html",controller:"AdvancePaymentCtrl",backdrop:"static",windowClass:"modal540",resolve:{candidate:function(){return candidate},manager:function(){return cu},company:function(){return company}}}).result.then(callback)}):callback()})},res}),ctrls.controller("AdvancePaymentCtrl",["$scope","$uibModalInstance","candidate","manager","company",function($scope,$uibModalInstance,candidate,manager,company){$scope.modal=$uibModalInstance,$scope.candidate=candidate,$scope.manager=manager,$scope.company=company}]),services.factory("SkillsService",function($resource,baseUrl){return $resource(baseUrl+"/skills",{},{query:{cache:!0,isArray:!0},get:{cache:!0,isArray:!0}})}),services.factory("TeamService",function($resource,$http,baseUrl,$cacheFactory){var teamCache;try{teamCache=$cacheFactory("teamCache")}catch(e){teamCache=$cacheFactory.get("teamCache")}var teamService=$resource(baseUrl+"/teams/:id",{id:"@id",activeAssignments:"@activeAssignments",managerId:"@managerId"},{getTeam:{cache:teamCache,url:baseUrl+"/teams/:id",transformResponse:function(data){var res=angular.fromJson(data);if(data&&!_.isArray(res))return res},params:{id:"@id"}},query:{cache:teamCache,url:baseUrl+"/teams/:id",params:{id:"@id",avatarType:"@avatarType"},isArray:!0},shallowlist:{cache:teamCache,
url:baseUrl+"/teams",params:{avatarType:"@avatarType",projection:"COLLECTION_0"},isArray:!0},teamsManagersMap:{cache:teamCache,isArray:!0,url:baseUrl+"/teams",params:{related:!0}},teamProductivitySummary:{url:baseUrl+"/teams/:id/productivitySummary",params:{id:"@id",managerId:"@managerId",fullTeam:"@fullTeam",date:"@date",weeksCount:"@weeksCount"}},teamAvg:{url:baseUrl+"/teams/:id/productivityAvg",cache:teamCache,params:{id:"@id",managerId:"@managerId",fullTeam:"@fullTeam",date:"@date",weeksCount:"@weeksCount"}},update:{method:"PUT"},create:{method:"POST",params:{avatarType:"@avatarType"}},getTeamProductivity:{method:"GET",url:baseUrl+"/teams/:id/productivity",cache:!0,params:{id:"@id",type:"@type",date:"@date"}},getTeamsProductivity:{method:"GET",url:baseUrl+"/teams/productivity",cache:!0,isArray:!0,params:{teamId:"@teamId",type:"@type",date:"@date",managerId:"@managerId"}},getWeeklyTimeSheets:{method:"GET",isArray:!0,url:baseUrl+"/tracker/timesheet",params:{teamId:"@teamId",managerId:"@managerId",date:"@date"}},getMonthlyTimeSheets:{method:"GET",isArray:!0,cache:!0,url:baseUrl+"/tracker/timesheet/fourweeks",params:{teamId:"@teamId",managerId:"@managerId",date:"@date"}},list:{url:baseUrl+"/teams/:id",params:{id:"@id"},cache:!0,isArray:!0},getMetricValues:{url:baseUrl+"/teams/:id/metric/values",isArray:!0,cache:!1,params:{id:"@id",type:"@type",managerId:"@managerId",from:"@from",to:"@to",refresh:"@refresh",costInclusive:"@costInclusive"}},createSetup:{url:baseUrl+"/teams/:id/metric/setups/",method:"POST",params:{id:"@id"}},updateSetup:{url:baseUrl+"/teams/:id/metric/setups/:setupId",method:"PUT",params:{id:"@id",setupId:"@setupId"}},deleteSetup:{url:baseUrl+"/teams/:id/metric/setups/:setupId",method:"DELETE",params:{id:"@id",setupId:"@setupId"}},getMetricServer:{url:baseUrl+"/teams/:id/metric/servers",method:"POST",params:{id:"@id"}},refreshMetric:{url:baseUrl+"/teams/:id/metric/values",method:"PUT",params:{id:"@id",setupId:"@setupId"}},getAllMetricSetups:{url:baseUrl+"/teams/:id/metric/setups",isArray:!0,cache:!1,params:{id:"@id"}},deleteAgreement:{url:baseUrl+"/teams/:id/agreements",method:"DELETE",params:{id:"@id",originalFilename:"@originalFilename"}},setWorkflowProject:{method:"POST",url:baseUrl+"/teams/:id/workflows",params:{id:"@id"}},getWorkflowStatistics:{method:"GET",url:baseUrl+"/teams/:id/workflows/statistics",params:{managerId:"@managerId"}},getXOStatusMappings:{method:"GET",url:baseUrl+"/teams/:id/workflows/states",isArray:!0},setXOStatusMappings:{method:"PUT",url:baseUrl+"/teams/:id/workflows/states",isArray:!0}});return teamService.getSpreadsheetAuthUrl=function(id){var url=baseUrl+"/teams/"+id+"/metric/spreadsheet",req={method:"GET",url:url,transformResponse:function(data){return data.slice(1,-1)}};return $http(req)},teamService.getTimeWindow=function(numberOfWeeks){if(numberOfWeeks<0)throw new Error("Number of weeks should be greater than 0");var from=moment().subtract(numberOfWeeks,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY),to=moment().weekday(moment.DAY_OF_WEEK.SUNDAY);return{from:from.format(moment.DateFormat.ISO_8601),to:to.format(moment.DateFormat.ISO_8601),numberOfWeeks:numberOfWeeks}},teamService.getCurrentWeekWindow=function(){return teamService.getTimeWindow(0)},teamService}),services.factory("TechTrialApplicationService",function($resource,baseUrl,$upload,$rootScope,$http){var notify=function(data){return $rootScope.updateNotifications(),angular.fromJson(data||null)},techTrialService=$resource(baseUrl+"/applications/:id",{id:"@id"},{startTest1:{method:"POST",url:baseUrl+"/applications/:id/test/1",transformResponse:notify},startAssignment:{method:"POST",url:baseUrl+"/applications/:id/test/2",transformResponse:notify},candidateCompleteProfile:{method:"POST",url:baseUrl+"/applications/:id/ccp",transformResponse:notify},getInvitation:{method:"GET",url:baseUrl+"/applications/:id/invitation"},getAssignment:{method:"GET",url:baseUrl+"/applications/:id/test/2"},listVMs:{method:"GET",url:baseUrl+"/applications/:id/test/vms",isArray:!0},endAssignment:{method:"DELETE",url:baseUrl+"/applications/:id/test/2",transformResponse:notify},extendAssignment:{method:"POST",url:baseUrl+"/applications/:id/test/2/extends"},startVM:{method:"POST",url:baseUrl+"/applications/:id/test/vms/start",params:{vmId:"@vmId"}},stopVM:{method:"POST",url:baseUrl+"/applications/:id/test/vms/stop",params:{vmId:"@vmId"}}});return techTrialService.getAssignmentAnswerLink=function(appId){var url=baseUrl+"/applications/"+appId+"/test/2/answerlink",req={method:"GET",url:url,transformResponse:function(data){return data.slice(1,-1)}};return $http(req)},techTrialService.getAssignmentDetails=function(appId){var url=baseUrl+"/applications/"+appId+"/test/2/assignmentDetails",req={method:"GET",url:url};return $http(req)},techTrialService.uploadAssignment=function(id,file,bb1,bb2){var config=$upload.prepareUpload({url:baseUrl+"/applications/"+id+"/test/2/data",fileFormDataName:"assignment",data:{blackbox:bb1,blackbox2:bb2},file:file});return $upload.http(config)},techTrialService}),services.factory("TestsService",function($resource,baseUrl,$cacheFactory){function clearCache(params){$cacheFactory.get("$http").remove(baseUrl+testUrl+params)}var appUrl="/applications/:id",testUrl="/applications/tests";return $resource(baseUrl+testUrl,{},{list:{isArray:!0,url:baseUrl+testUrl,cache:!0},get:{url:baseUrl+testUrl+"/:id",cache:!0},getCurrent:{method:"GET",url:baseUrl+appUrl+"/test/current"},getRR:{method:"GET",url:baseUrl+testUrl+"/rr",isArray:!0},addRR:{method:"POST",url:baseUrl+testUrl+"/rrt"},updateRR:{method:"PUT",url:baseUrl+testUrl+"/rrt/:id"},save5QAnswers:{method:"POST",url:baseUrl+appUrl+"/test/5q"},submit5QAnswers:{method:"POST",url:baseUrl+appUrl+"/cs5qt"},addResumeKeywordTest:{method:"POST",url:baseUrl+testUrl+"/rkt"},updateResumeKeywordTest:{method:"PUT",url:baseUrl+testUrl+"/rkt/:id"},addOtherTest:{method:"POST",url:baseUrl+testUrl+"/ot"},updateOtherTest:{method:"PUT",url:baseUrl+testUrl+"/ot/:id"},add5QTest:{method:"POST",url:baseUrl+testUrl+"/5qt",transformResponse:function(data){return clearCache("?status=ACTIVE&type=FIVEQ"),angular.fromJson(data)}},update5QTest:{method:"PUT",url:baseUrl+testUrl+"/5qt/:id",transformResponse:function(data){return clearCache("?status=ACTIVE&type=FIVEQ"),angular.fromJson(data)}},addMandatoryAttrsTest:{method:"POST",url:baseUrl+testUrl+"/mat"},createHRTestOnTT:{method:"PUT",url:baseUrl+testUrl+"/hrtest/:id"},updateMandatoryAttrsTest:{method:"PUT",url:baseUrl+testUrl+"/mat/:id"}})}),services.factory("TimezonesService",function($resource,baseUrl){return $resource(baseUrl+"/public/timeZones",{},{query:{method:"GET",isArray:!0,cache:!0}})}),services.service("TimeUtils",function(){var MILLISECONDS_PER_HOUR=36e5,getUTCTime=function(){var now=new Date,dt=new Date;return dt.setHours(now.getUTCHours()),dt.setMinutes(now.getUTCMinutes()),dt},service={getUTCTime:function(){return getUTCTime()},getTimeByTimezoneOffset:function(offset){var dt=getUTCTime();return new Date(dt.getTime()+offset)},formatUtcOffset:function(offset){var cp=Math.abs(offset)/MILLISECONDS_PER_HOUR,hours=Math.floor(cp),min=0;return cp>hours&&(min=60*(cp-hours)),(offset>=0?"+":"-")+(hours<10?"0"+hours:hours)+":"+(min<10?"0"+min:min)},hoursDiffBetweenTimezones:function(offset1,offset2){return(offset2-offset1)/MILLISECONDS_PER_HOUR},convertToUtc:function(date){var millis=date.getTime(),offset=date.getTimezoneOffset();return new Date(millis+6e4*offset)},convertToHours:function(daysArr){var days=daysArr[0],hours=daysArr[1];return 24*(days||null)+(hours||null)},convertToDays:function(hours){return hours=hours||0,[Math.floor(hours/24),hours%24]}};return service}),services.factory("TrainingService",function($resource,baseUrl){return $resource(baseUrl+"/trainings",{},{query:{method:"GET",isArray:!0},update:{url:baseUrl+"/trainings",method:"PUT",params:{id:"@id"}},"delete":{url:baseUrl+"/trainings/:id",method:"DELETE",params:{id:"@id"}}})}),services.factory("UserService",function($resource,$http,baseUrl){var userData={};return{checkEmailUsed:function(email){return $http.get(baseUrl+"/public/users/exist?email="+email)},getUser:function(){return userData},setUser:function(user){userData=user},activate:$resource(baseUrl+"/public/users/activate").save,resendActivation:$resource(baseUrl+"/public/users/:email/resendActivation",{email:"@email"}).save,user:$resource(baseUrl+"/users/:id",{id:"@id"},{deleteProfileImage:{method:"DELETE",url:baseUrl+"/users/:id/image"}}),verifyEmailUpdate:$resource(baseUrl+"/public/users/:token/verifyEmail",{token:"@token"}).save,userRoles:$resource(baseUrl+"/users/:id/avatars",{},{updateUserRoles:{url:baseUrl+"/users/:id/avatars",method:"PUT",params:{id:"@id",avatars:"@avatars"}}})}}),services.factory("CurrentUser",function($resource,$cacheFactory,baseUrl,ManagerService,$rootScope,CacheService,$uibModal,routePrefix,$location){function openFeedbackPopup(){feedbackModal=!0;var tpl="manager/feedback.tpl.html",modal=$uibModal.open({templateUrl:routePrefix?routePrefix+tpl:tpl,backdrop:"static",windowClass:"modal540",controller:function($scope,$uibModalInstance){$scope.modal=$uibModalInstance,$scope.feedback={}}});modal.result.then(function(fb){ManagerService.addFeedback(fb)})["finally"](function(){feedbackModal=!1})}function collectFeedback(){feedbackRequired&&void 0===$rootScope.runAsId&&(feedbackRequired=!1,getAvatar({avatarType:"MANAGER"},function(res){res&&res.feedbackRequired&&openFeedbackPopup()}))}var CurrentUserCache=$cacheFactory("CurrentUser"),url=baseUrl+"/users/current",feedbackRequired=!0,feedbackModal=!1,confUpdatePhotoUrl={save:{params:{value:"@value"},method:"POST"}},getAvatar=$resource(url+"/avatar",{avatarType:"@avatarType"}).get;return{feedbackModal:function(){return feedbackModal},clearCache:function(callback){if(CacheService.remove(url),callback)return callback()},get:$resource(url,{},{get:{cache:CurrentUserCache,transformResponse:function(res){var o;try{o=angular.fromJson(res)}catch(e){return res}var isManager=o&&(_.contains(o.avatarTypes,"MANAGER")||_.contains(o.avatarTypes,"COMPANY_ADMIN"));return isManager&&collectFeedback(o),o}}}).get,getAvatar:getAvatar,updatePassword:$resource(url+"/password",{}).save,updateLocation:$resource(url+"/location",{}).save,getLocation:$resource(baseUrl+"/public/users/current/location",{}).get,updatePhotoUrl:$resource(url+"/photoUrl",{},confUpdatePhotoUrl).save,updateAccountInfo:$resource(url+"/accountInfo",{},{update:{method:"PUT"}}).update,updateSecurityQuestion:$resource(url+"/securityQuestion",{}).save,getAndSet:function(cuService,scope){scope.isLoading=!0,cuService.get(function(res){scope.currentUser=res,scope.isLoading=!1})},getAndSetAvatar:function(cuService,scope,avatarType){scope.isLoading=!0,cuService.getAvatar({avatarType:avatarType},function(res){scope.currentUser=res,scope.isLoading=!1})},restoreImpersonation:function(){var userId=parseInt($location.search().runAsId);isNaN(userId)||($rootScope.runAsId=userId)},getAssignments:$resource(url+"/assignments",{}).query}}),services.factory("UtilsService",function($filter){function getWeekNumberOfDate(date){var dt=new Date(date),firstJan=new Date(dt.getFullYear(),0,1),daysDiff=(dt-firstJan)/MS_PER_DAY;return Math.ceil((daysDiff+firstJan.getDay()-1)/7)}var alphaNumerics="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",vimeoRegex=/^((http|https):\/\/)?(www\.)?vimeo.com\/(\d+)($|\/)/,MS_PER_DAY=864e5,colorPalette=["#ff8a80","#ef5350","#ec407a","#ab47bc","#7e57c2","#5c6bc0","#42a5f5","#26c6da","#009688","#26a69a","#66bb6a","#9ccc65","#d4e157","#ffee58","#ffca28","#ffa726","#ff7043","#8d6e63","#bdbdbd","#78909c"];return{generateRandomString:function(length){length=length||16;for(var result="",i=length;i>0;--i)result+=alphaNumerics[Math.round(Math.random()*(alphaNumerics.length-1))];return result},isValidVimeoUrl:function(str){return vimeoRegex.test(str)},getWeekOfDate:function(date,startFromSunday){var dt=new Date(date),dayOfWeek=dt.getDay();startFromSunday||(dayOfWeek=0===dt.getDay()?6:dt.getDay()-1);var first=new Date(dt.setDate(dt.getDate()-dayOfWeek)),last=new Date(dt.setDate(first.getDate()+6));return{weekNumber:getWeekNumberOfDate(dt),firstDate:first,lastDate:last}},isInSameWeek:function(dt1,dt2){return moment(dt1).isoWeek()===moment(dt2).isoWeek()},daysDiff:function(dt1,dt2){var msDiff=new Date(dt1).getTime()-new Date(dt2).getTime();return Math.ceil(Math.abs(msDiff/MS_PER_DAY))},getNumberOfDays:function(year,month){var isLeap=year%4===0&&(year%100!==0||year%400===0);return[31,isLeap?29:28,31,30,31,30,31,31,30,31,30,31][month]},getHexColor:function(colorIndex){return colorIndex>colorPalette.length-1&&(colorIndex%=colorPalette.length),colorPalette[colorIndex]},getUrlParam:function(url,paramName){var v,params=url.substring(url.indexOf("?")+1).split("&");return params.forEach(function(p){var name=p.split("=")[0],value=p.split("=")[1];paramName===name&&(v=value)}),v},timecardRangeExists:function(diary,startTimeRange,endTimeRange){for(var rangeExists=!0;startTimeRange<endTimeRange&&(rangeExists=this.timecardExists(diary,startTimeRange));)startTimeRange.setMinutes(startTimeRange.getMinutes()+10);return rangeExists},timecardExists:function(diary,time){var timecardExists=!1;return _.some(diary,function(t){_.some(t.timecards,function(tc){if(tc&&tc.localDate.getHours()===time.getHours()&&tc.localDate.getMinutes()===time.getMinutes())return timecardExists=!0,!0})}),timecardExists},fillWeeksRangeArr:function(countOfWeeks,delFirst,firstWeek){var weeksRange=[],sun=moment().endOf("isoWeek").add(firstWeek,"weeks").toDate();for(delFirst&&(sun=moment(sun).subtract(1,"weeks").toDate());countOfWeeks--;)weeksRange.push(sun),sun=moment(sun).subtract(1,"weeks").toDate();return weeksRange},roundToOne:function(num){return+(Math.round(num+"e+1")+"e-1")},getStartOfWeek:function(date,i){return moment(date).startOf("week").subtract(i,"weeks").format("YYYY-MM-DD")},getEndOfWeek:function(date,i){return moment(date).endOf("week").subtract(i,"weeks").format("YYYY-MM-DD")},progressbarColor:function(x){return x<30?"red":x>=30&&x<70?"yellow":void 0},convertToHoursAndMinutes:function(minutes,format){var separator=":",hourAffix="",minuteAffix="",showZeroMinute=!0,showZeroHour=!0;if(format&&(separator=format.separator,hourAffix=format.hour,minuteAffix=format.minute,showZeroMinute=format.showZeroMinute,showZeroHour=format.showZeroHour),!minutes)return"0"+hourAffix+separator+"00"+minuteAffix;var hours=minutes/60,h=hours-hours%1,m=$filter("number")(60*hours%60,0);m<10&&showZeroMinute&&(m="0"+m);var hour=h+hourAffix,minute=m+minuteAffix;return 0===h&&showZeroHour?"0"+separator+minute:0===h?minute:hour+separator+minute},getUtc:function(date){return new Date(date.getTime()+6e4*date.getTimezoneOffset())},isToday:function(date){var now=moment();return 0===now.diff(moment(date),"days")},isThisWeek:function(date,startDate){var now=moment(startDate).startOf("week"),diff=now.diff(moment(date).startOf("week"),"weeks");return 0===diff},getWeekText:function(date,startFormat,endFormat){startFormat?startFormat:startFormat="MMM DD",endFormat?endFormat:endFormat="MMM DD, YYYY";var m=moment(date).startOf("isoweek");return m.format(startFormat)+" - "+m.endOf("isoweek").format(endFormat)},transformToDateObject:function(date){return date instanceof Date||(date=new Date(date)),date}}}),services.factory("ManagerNotesService",function(baseUrl,$resource){return $resource(baseUrl+"/applications/notes",{noteId:"@noteId"},{query:{url:baseUrl+"/applications/:id/notes",method:"GET",isArray:!0},save:{url:baseUrl+"/applications/:id/notes",method:"POST",params:{id:"@id"}}})}),services.factory("RequestQueue",function($q){function execute(){var task=queue[0],def=task.deferred;task.call(task.reqParam).$promise.then(function(data){queue.shift(),def.resolve(data),queue.length>0&&execute()},function(err){queue.shift(),def.reject(err),queue.length>0&&execute()})}var queue=[];return{queue:queue,addTask:function(call,reqParam){var def=$q.defer();return queue.push({call:call,reqParam:reqParam,deferred:def}),1===queue.length&&execute(),def.promise}}}),services.service("QueryParams",function($location){this.read=function(params){var ls=$location.search();_.each(params,function(value,key){var newValue=ls[key];angular.isDefined(newValue)&&(params[key]=newValue)})},this.write=function(params){_.each(params,function(value,key){angular.isDefined(value)&&$location.search(key,value)})},this.readValue=function(name,defaultValue){var p={};return p[name]=defaultValue,this.read(p),p[name]}}),services.factory("BusinessGoalService",function($resource,$http,baseUrl){var businessGoalService=$resource(baseUrl+"/goals/:id",{id:"@id"},{list:{url:baseUrl+"/goals",params:{teamId:"@teamId",active:"@active"},isArray:!0},update:{method:"PUT"},create:{method:"POST"},listStatuses:{url:baseUrl+"/goals/statuses",params:{teamId:"@teamId",from:"@from",to:"@to"},isArray:!0},saveStatus:{url:baseUrl+"/goals/statuses",method:"POST"},postComment:{url:baseUrl+"/goals/comments",method:"POST",params:{status:"@status",content:"@content",category:"@category"}},updateComment:{url:baseUrl+"/goals/comments",method:"PUT",params:{id:"@id",status:"@status",content:"@content",category:"@category"}}});return businessGoalService.getSpreadsheetAuthUrl=function(){var url=baseUrl+"/teams/1/metrics/spreadsheet/auth",req={method:"GET",url:url,transformResponse:function(data){return data.slice(1,-1)}};return $http(req)},businessGoalService}),services.factory("TeamTemplateService",function($resource,baseUrl){return $resource(baseUrl+"/teamTemplates",{},{list:{url:baseUrl+"/teamTemplates",cache:!0,isArray:!0}})}),services.factory("TeamCategoryService",function($resource,baseUrl,$cacheFactory){var teamCategoryCache;try{teamCategoryCache=$cacheFactory("teamCategoryCache")}catch(e){teamCategoryCache=$cacheFactory.get("teamCategoryCache")}var teamCategoryService=$resource(baseUrl+"/teamCategories",{},{getTeams:{url:baseUrl+"/teamCategories/:id",params:{id:"@id"},cache:teamCategoryCache}});return teamCategoryService}),services.factory("TeamSelectionsService",function($resource,baseUrl){var teamSelectionsService=$resource(baseUrl+"/teamSelections",{},{saveInterview:{method:"POST",url:baseUrl+"/teamSelections"}});return teamSelectionsService}),services.factory("TeamInterviewService",function($resource,baseUrl,$rootScope){var notify=function(data){return $rootScope.updateNotifications(),angular.fromJson(data)},teamInterviewService=$resource(baseUrl+"/teaminterviews/:id",{id:"@id"},{update:{url:baseUrl+"/teaminterviews/:id/mci",method:"PUT",params:{id:"@id"},transformResponse:notify},acceptSlot:{url:baseUrl+"/teaminterviews/:id/interviewee/accept",method:"POST",params:{id:"@id",startDateTime:"@startDateTime",endDateTime:"@endDateTime"},transformResponse:notify},declineSlot:{url:baseUrl+"/teaminterviews/:id/interviewee/reject",method:"POST",params:{id:"@id",intervieweeNotes:"@intervieweeNotes",rejectionType:"@rejectionType"},transformResponse:notify}});return teamInterviewService}),services.factory("WorkflowServerService",function($resource,baseUrl){return $resource(baseUrl+"/workflows/servers",{})}),services.factory("WorkflowProjectService",function($resource,baseUrl){var workflowProjectService=$resource(baseUrl+"/workflows/projects",{});return workflowProjectService}),services.factory("WorkflowUserService",function($resource,baseUrl){var workflowUserService=$resource(baseUrl+"/workflows/users",{});return workflowUserService}),services.factory("WorkflowSchemeService",function($resource,baseUrl){var url=baseUrl+"/workflows/scheme";return $resource(url,{},{setup:{method:"GET",url:url+"/setup"}})}),services.service("WorkflowsService",function(routePrefix,$uibModal){this.openModal=function(templateUrl,controller,resolve){$uibModal.open({templateUrl:routePrefix+templateUrl,windowClass:"hire-team-modal workflows-wizard-modal",backdrop:!1,controllerAs:"vm",controller:controller,resolve:resolve})},this.openFinishModal=function(){this.openModal("manager/workflows/workflows-wizard-finish.tpl.html","WorkflowWizardFinishCtrl")}}),services.factory("WorkflowStatusService",function($resource,baseUrl){var workflowStatusService=$resource(baseUrl+"/workflows/projects/:id/states",{},{getXOStatuses:{url:baseUrl+"/workflows/states",isArray:!0}});return workflowStatusService}),services.factory("WorkflowTeamGoalsService",function($resource,baseUrl){return $resource(baseUrl+"/teams/:id/workflows/goals",{},{update:{method:"PUT"}})}),bandcampApp.filter("auto2application",function(){function convert(input,dontCapitalize){if(!angular.isString(input))return input;if(!input.match(/^AUTO_/))return input;var parts=input.replace(/^AUTO_/,"").trim().toLowerCase().split(/[_\s]+/g);if(!dontCapitalize)for(var i=0;i<parts.length;i++)parts[i].length>0&&(parts[i]=parts[i][0].toUpperCase()+parts[i].substring(1));var result=parts.join(" ").trim();return angular.isString(result)&&0===result.length||"Null"===result?"Unknown application":result}return function(input,dontCapitalize){return input?angular.isArray(input)?input.map(function(item){return convert(item,dontCapitalize)}):convert(input,dontCapitalize):input}}),bandcampApp.filter("customCurrency",["$filter",function($filter){return function(amount,currencySymbol){var currency=$filter("currency");return amount<0?currency(amount,currencySymbol).replace("(","-").replace(")",""):currency(amount,currencySymbol)}}]),bandcampApp.filter("enum2string",function(){function convert(enumItem,dontCapitalize,capitalizeFirst,dontChangeInputCase){if(dontChangeInputCase)return enumItem.trim().split(/[_\s]+/g).join(" ");var parts=enumItem.trim().toLowerCase().split(/[_\s]+/g);if(!dontCapitalize)for(var i=0;i<parts.length;i++)parts[i].length>0&&(parts[i]=parts[i][0].toUpperCase()+parts[i].substring(1));return capitalizeFirst&&parts[0]&&parts[0].length>0&&(parts[0]=parts[0][0].toUpperCase()+parts[0].substring(1)),parts.join(" ")}return function(input,dontCapitalize,capitalizeFirst,dontChangeInputCase){return input?angular.isArray(input)?input.map(function(item){return convert(item,dontCapitalize,capitalizeFirst,dontChangeInputCase)}):convert(input,dontCapitalize,capitalizeFirst,dontChangeInputCase):input}}),bandcampApp.filter("fmt",function(){return function(input,dp,suffix){var op;return op=input?Number(input).toPrecision(dp||3):"0.00",suffix?op+suffix:op}}),bandcampApp.filter("formatHours",function(){return function(input,format){var mn=!1;input<-.1&&(input=Math.abs(input),mn=!0);var isPadZero=format&&"hh:mm"===format,minutes=Math.round(60*input),h=Math.floor(minutes/60),hh=(h<10?"0":"")+h,m=minutes%60,mm=(m<10?"0":"")+m;return isNaN(minutes)?isPadZero?"00:00":"0:00":(mn?"-":"")+(isPadZero?hh:h)+":"+mm}}),bandcampApp.filter("formatHours2",function(){return function(input){var minutes=Math.round(60*input),h=Math.floor(minutes/60),m=minutes%60,mm=(m<10?"0":"")+m;return isNaN(minutes)?"0h 00m":h+"h "+mm+"m"}}),bandcampApp.filter("formatMinutesToHours",function(){return function(input,format){var isPadZero=format&&"hh:mm"===format,minutes=parseInt(input,10),h=Math.floor(minutes/60),m=minutes%60,mm=(m<10?"0":"")+m,hh=(h<10?"0":"")+h;return isNaN(minutes)?isPadZero?"00:00":"0:00":(isPadZero?hh:h)+":"+mm}}),bandcampApp.filter("formatTimezone",function(){var categorizedTzByUS=[{name:"US Eastern",STD:"-05:00",DST:"-04:00"},{name:"US Central",STD:"-06:00",DST:"-05:00"},{name:"US Mountain",STD:"-07:00",DST:"-06:00"},{name:"US Pacific",STD:"-08:00",DST:"-07:00"}];return function(location){function getDateAsUTC(date){return new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(),date.getSeconds()))}function stdTimezoneOffset(){var jan=new Date(date.getFullYear(),0,1),jul=new Date(date.getFullYear(),6,1);return Math.max(jan.getTimezoneOffset(),jul.getTimezoneOffset())}function isDST(){return date.getTimezoneOffset()<stdTimezoneOffset()}function getStdOrDst(){return isDST()?"DST":"STD"}function checkIfTzInUS(hourlyOffset){var stdOrDst=getStdOrDst();return _.find(categorizedTzByUS,function(category){return category[stdOrDst]===hourlyOffset})}var code=location.country.code,tz=location.timeZone,date=getDateAsUTC(new Date),timezoneName="UTC "+tz.hourlyOffset;if("us"===code){var usTimezoneCategory=checkIfTzInUS(tz.hourlyOffset);usTimezoneCategory&&(timezoneName=usTimezoneCategory.name)}return timezoneName}}),bandcampApp.filter("singleDecimal",function(){return function(input){return isNaN(input)?input:Math.round(10*input)/10}}),bandcampApp.filter("setDecimal",function(){return function(input,places){if(isNaN(input))return input;var factor="1"+Array(+(places>0&&places+1)).join("0");return Math.round(input*factor)/factor}}),bandcampApp.filter("localeDateShort",function(){return function(input){return input?input instanceof Date?input.toLocaleDateString():new Date(input).toLocaleDateString():""}}),bandcampApp.filter("shortdate",function(){return function(item){return moment(item).format("MMM DD")}}),bandcampApp.filter("shortdateWeek",function(){return function(item){return moment(item).format("MMM DD (dddd)")}}),bandcampApp.filter("fulldate",function(){return function(item){return moment(item).format("MMM DD, YYYY")}}),bandcampApp.filter("reportdate",function(){return function(item){return moment(item).format("MM/DD/YYYY")}}),bandcampApp.filter("monthpicker",function(){return function(item){return moment(item).format("MMMM, YYYY")}}),bandcampApp.filter("dateSuffix",function(){var suffixes=["th","st","nd","rd"];return function(item){var dtfilter=moment(item).format("MMMM D"),day=parseInt(dtfilter.slice(-2),10),relevantDigits=day<30?day%20:day%30,suffix=relevantDigits<=3?suffixes[relevantDigits]:suffixes[0];return dtfilter+suffix}}),bandcampApp.filter("newlines",function(){return function(text){if(text)return text.replace(/\n/g,"<br/>")}}),bandcampApp.filter("removeInvalidChars",function(){return function(text){if(text)return text.replace(/[^ -~ ]/g,"")}}),bandcampApp.filter("nl2br",function($sce){return function(msg,isXhtml){var isXHTML=isXhtml||!0,breakTag=isXHTML?"<br />":"<br>",MSG=(msg+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+breakTag+"$2");return $sce.trustAsHtml(MSG)}}),bandcampApp.filter("range",function(){return function(input){var lowBound,highBound,step=1;switch(input.length){case 1:lowBound=0,highBound=parseInt(input[0],10)-1;break;case 3:step=parseInt(input[2],10);break;case 2:lowBound=parseInt(input[0],10),highBound=parseInt(input[1],10);break;default:return input}for(var result=[],i=lowBound;i<=highBound;i+=step)result.push(i);return result}}),bandcampApp.filter("yearsRange",function(){return function(input,min,max){min=parseInt(min,10),max=parseInt(max,10);for(var i=max;i>=min;i--)input.push(i);return input}}),bandcampApp.filter("numRange",function(){return function(input,min,max){for(min=parseInt(min,10),max=parseInt(max,10);min<=max--;)input.push(max);return input}}),bandcampApp.filter("truncate",function(){return function(str,length,etc,breakWords,middle){if(!str)return"";if(length=void 0!==length?length:80,etc=etc||"...",0===length)return"";var originalLen=str.length;if(str.length>length){if(length-=etc.length,!breakWords&&!middle){var part=str.substr(0,length+1);str=part.replace(/\s+?(\S+)?$/,"")}return middle?str.substr(0,length/2)+etc+str.substr(originalLen-length/2+1,length/2):str.substr(0,length)+etc}return str}}),bandcampApp.filter("jobApplicationTest",function(){return function(application,testType,requiredField,suffix){if(application&&application.testScores)for(var i=0;i<application.testScores.length;i++){var testScore=application.testScores[i];if(testScore.test.type===testType&&requiredField&&angular.isDefined(testScore[requiredField]))return suffix?testScore[requiredField]+suffix:testScore[requiredField]}return null}}),bandcampApp.filter("visiblescors",function(){return function(tests,selectedstep){var filtered=[];return void 0===selectedstep||""===selectedstep?filtered:(angular.forEach(tests,function(test){var add=!0;"Resume"===selectedstep&&"RESUME_RUBRIC"!==test.test.type&&(add=!1),"First Screening"===selectedstep&&"HACKER_RANK"!==test.test.type&&"RESUME_KEYWORD"!==test.test.type&&"RESUME_RUBRIC"!==test.test.type&&(add=!1),add&&filtered.push(test)}),filtered)}}),bandcampApp.filter("indexOfObjectArray",function(){return function(arr,searchTerm,property){var r=-1,i=arr.length;if(i===-1||property.length===-1||searchTerm.length===-1)return r;for(;i--;)for(var j=property.length;j--;)arr[i].hasOwnProperty(property[j])&&arr[i][property[j]]===searchTerm&&(r=i);return r}}),bandcampApp.filter("titleCase",function(){return function(text){return text=text||"",text.replace(/\w\S*/g,function(txt){return txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase()})}}),bandcampApp.filter("fastFilter",function(){return function(exclude,searchTerm,arr){if(!(arr.length<=0)&&searchTerm){for(var res=[],i=arr.length;i--;)0!==arr[i].name.toLowerCase().indexOf(searchTerm.toLowerCase())||exclude&&exclude.indexOf(arr[i])!==-1||res.push(arr[i].name);return res}}}),bandcampApp.filter("startsWith",function(){return function(input,propertyName,filterText){return _.isEmpty(filterText)?input:_.filter(input,function(element){return 0===element[propertyName].toLowerCase().indexOf(filterText.toLowerCase())})}}),bandcampApp.filter("ifEmpty",function(){return function(input,defaultValue){return angular.isUndefined(input)||null===input||""===input?defaultValue:input}}),angular.module("bandcampApp.bcTemplate",[]).directive("bcTemplate",function(routePrefix){function resolveTemplate(elem,attrs){var tag=attrs.tag?attrs.tag:"div";return routePrefix?"<"+tag+" ng-include='\""+routePrefix+attrs.src+"\"'></"+tag+">":"<"+tag+" ng-include='\""+attrs.src+"\"'></"+tag+">"}return{replace:!0,restrict:"E",template:resolveTemplate}}),angular.module("bandcampApp.coFillHeight",[]).directive("coFillHeight",["$timeout","$window",function($timeout,$window){return{restrict:"A",link:function(scope,elem){function adjustHeight(){scope.timer||(scope.timer=$timeout(function(){var heightParant=elem[0].parentElement.clientHeight,top=elem[0].offsetTop;if(heightParant>0&&top>0){var padding=parseInt(elem.parent().css("padding-bottom"),10),h=heightParant-top-padding,height=elem[0].clientHeight;height!==h&&elem.css("height",h+"px")}},100),scope.timer.then(function(){scope.timer=null}))}scope.timer=null,scope.$watch("ngBind",function(){adjustHeight()}),angular.element($window).bind("resize",function(){adjustHeight()})}}}]),bandcampApp.directive("fitVisibleScreen",["$timeout",function($timeout){return{restrict:"A",scope:{},link:function(scope,element){var d=$(document);$timeout(function(){scope.$watch(function(){return d.height()},function(){var e=$(element),height=d.height(),footer=$("body > footer").height()||90,offset=e.offset().top||0;e.css("min-height",height-footer-offset)})})}}}]),angular.module("bandcampApp.compile",[]).directive("compile",["$compile",function($compile){return{scope:{customScope:"="},link:function(scope,element,attrs){scope.$watch(function(scope){for(var i in scope.customScope)i.indexOf("$")===-1&&(scope[i]=scope.customScope[i]);return scope.$parent.$eval(attrs.compile)},function(value){element.html(value),$compile(element.contents())(scope)})}}}]),bandcampApp.directive("contenteditable",function(){return{require:"ngModel",link:function(scope,element,attrs,ngModel){var useHtml=/^html$/i.test(attrs.contenteditableModelValue);if(attrs["class"].indexOf("wysiwyg")===-1){var read=function(){var val=useHtml?element.html():element.text();ngModel.$setViewValue(val)};ngModel.$render=function(){element.html(ngModel.$viewValue||"")},element.bind("blur",function(){scope.$apply(read)})}}}}),angular.module("bandcampApp.customAutoComplete",[]).directive("customAutocomplete",function(){return{restrict:"A",scope:{suggestions:"=",model:"="},link:function(scope,element){scope.$watch("suggestions",function(newV){newV&&newV.length>0&&$(element).autocomplete({source:scope.suggestions})}),scope.$watch(function(){return element.val()},function(newV){
newV&&(scope.$parent.data.activityApp=newV)})}}}),angular.module("bandcampApp.dragSelect",[]).directive("dragSelect",function($window,$document){return{restrict:"A",scope:{selectedPlanSlots:"="},link:function(scope,element){function mouseUp(){dragging&&(dragging=!1)}function mouseDown(el){scope.$emit("SlotsSelectionStart"),dragging=!0,scope.selectedPlanSlots=[],startCell=el.data("index")-1,setEndCell(el)}function mouseEnter(el){dragging&&setEndCell(el)}function setEndCell(el){scope.selectedPlanSlots=[];var min=Math.min(startCell,el.data("index")-1),max=Math.max(startCell+1,el.data("index"));if(!isNaN(min)&&!isNaN(max))for(;min++!==max;)scope.selectedPlanSlots.push(min)}function wrap(fn){return function(){var el=angular.element(this);scope.$apply(function(){fn(el)})}}var startCell=null,dragging=!1;scope.$on("RemoveSelectClass",function(){scope.selectedPlanSlots=[]}),element.delegate("td","mousedown",wrap(mouseDown)),element.delegate("td","mouseenter",wrap(mouseEnter)),$document.delegate("body","mouseup",wrap(mouseUp))}}}),angular.module("bandcampApp.fileSelect",[]).directive("fileSelect",["$parse","$timeout",function($parse){return{restrict:"EA",template:'<input type="file"/>',replace:!0,link:function(scope,element,attrs){var modelGet=$parse(attrs.fileInput),modelSet=modelGet.assign,onChange=$parse(attrs.onChange),updateModel=function(){scope.$apply(function(){modelSet(scope,element[0].files[0]),onChange(scope)})};element.bind("change",updateModel)}}}]).directive("ngFileSelect",["$parse","$timeout",function($parse,$timeout){return function(scope,elem,attr){var fn=$parse(attr.ngFileSelect);if("input"!==elem[0].tagName.toLowerCase()||"file"!==(elem.attr("type")&&elem.attr("type").toLowerCase())){for(var fileElem=angular.element('<input type="file">'),i=0;i<elem[0].attributes.length;i++)fileElem.attr(elem[0].attributes[i].name,elem[0].attributes[i].value);elem.attr("data-multiple")&&fileElem.attr("multiple","true"),fileElem.css("top",0).css("bottom",0).css("left",0).css("right",0).css("width","100%").css("opacity",0).css("position","absolute").css("filter","alpha(opacity=0)"),elem.append(fileElem),fileElem.parent()[0]!==elem[0]&&(elem.wrap("<span>"),elem.css("z-index","-1000"),elem.parent().append(fileElem),elem=elem.parent()),""!==elem.css("position")&&"static"!==elem.css("position")||elem.css("position","relative"),elem=fileElem}elem.bind("change",function(evt){var fileList,i,files=[];if(fileList=evt.__files_||evt.target.files,null!==fileList)for(i=0;i<fileList.length;i++)files.push(fileList.item(i));$timeout(function(){fn(scope,{$files:files,$event:evt})})})}}]).directive("pickFile",function(){return{restrict:"A",link:function(scope,elem,attrs){var targetInput=attrs.pickFile&&attrs.pickFile.length?angular.element("#"+attrs.pickFile):angular.element("input[type=file]");elem.bind("click",function(e){e.preventDefault(),targetInput.trigger("click")})}}}),angular.module("bandcampApp.fixedTableHeader",[]).directive("fixedTableHeader",function(){return{restrict:"A",link:function(scope,element){element.find("thead tr").css("border-bottom","2px Solid #ddd !important"),element.find("thead tr th").css("border-bottom","0 !important"),element.on("scroll",function(){element.find("> *").css("width",element.width()+element.scrollLeft()+"px"),element.find("tr").css("width",element.width()+element.scrollLeft()+"px"),element.find("thead tr").css("border-bottom","0px"),element.find("thead tr th").css("border-bottom","2px Solid #ddd")}),scope.$watch(function(){return element.find("tbody").scrollLeft()},function(newV){newV&&newV>0?element.scrollLeft(newV):(element.find("thead tr").css("border-bottom","2px Solid #ddd !important"),element.find("thead tr th").css("border-bottom","0 !important"))},!0)}}}),angular.module("bandcampApp.imageOnLoad",[]).directive("imageonload",function(){return{restrict:"A",link:function(scope,element,attrs){element.bind("load",function(){scope.$apply(attrs.imageonload)})}}}),angular.module("bandcampApp.infiniteScroll",[]).directive("infiniteScroll",function(){return{restrict:"A",scope:{infiniteScroll:"&",infiniteScrollContainer:"="},link:function(scope,element){function handler(){element.scrollTop()+element.outerHeight()>=element[0].scrollHeight&&scope.infiniteScroll()}var scrollElement=element;angular.isDefined(scope.infiniteScrollContainer)&&(scrollElement=angular.element(scope.infiniteScrollContainer)),scrollElement.on("scroll",handler)}}}),angular.module("bandcampApp.intercom",[]).directive("intercom",["IntercomService","intercomKey",function(IntercomService,intercomKey){return{link:function(scope){scope.$watch("user",function(user){if(angular.isObject(user)&&angular.isDefined(user.intercomId)){var data={app_id:intercomKey,name:user.printableName,email:user.email,user_id:user.id};IntercomService.init(intercomKey).then(function(iCom){angular.extend(data,{app_id:intercomKey}),iCom("boot",data)})}})}}}]).directive("intercomWidget",["$filter","IntercomService","CurrentUser","AssignmentService","intercomContractorAppId",function($filter,IntercomService,CurrentUser,AssignmentService,intercomContractorAppId){return{link:function(scope){scope.$watch("user",function(user){angular.isObject(user)&&user.avatarTypes.indexOf("CANDIDATE")>-1&&AssignmentService.assignments({page:0,avatarType:"CANDIDATE",status:"ACTIVE"},function(res){var assignmentsPage=res.content||[],candidateAv=user.userAvatars.filter(function(a){return"CANDIDATE"===a.type}).pop();if(assignmentsPage.length>0&&candidateAv&&candidateAv.id===assignmentsPage[0].selection.marketplaceMember.application.candidate.id){var assignment=assignmentsPage[0];if(angular.isObject(assignment)){var candidate=assignment.selection.marketplaceMember.application.candidate,manager=assignment.manager,userType=user.avatarTypes.indexOf("MANAGER")>-1?"MANAGER":"CONTRACTOR";if(angular.isObject(candidate)&&angular.isObject(manager)){var data={name:candidate.printableName,email:candidate.email,job_title:assignment.jobTitle,user_type:userType,salary:"$"+assignment.salary+"/"+assignment.salaryUnit,salary_type:assignment.salaryType,manager_name:manager.printableName,manager_email:manager.email,team:assignment.team.name,company:manager.company.name,start_date:$filter("date")(assignment.startDate,"yyyy-MM-dd")};IntercomService.init(intercomContractorAppId).then(function(intercom){angular.extend(data,{app_id:intercomContractorAppId}),intercom("boot",data)})}}}})})}}}]).directive("intercomVisitor",["$filter","IntercomService","intercomVisitorAppId",function($filter,IntercomService,intercomVisitorAppId){return{link:function(scope){scope.$watch("data.visitor",function(visitor){if(visitor){var data={email:"N/A",start_date:$filter("date")(new Date,"yyyy-MM-dd")};IntercomService.init(intercomVisitorAppId).then(function(intercom){angular.extend(data,{app_id:intercomVisitorAppId}),intercom("boot",data)})}})}}}]),angular.module("bandcampApp.passwordStrength",[]).directive("passwordStrength",["$sce",function($sce){return{restrict:"A",link:function(scope,element,attrs){var buildStrengthBar=function(score){var strengthBarHtml="<b>Password strength:</b> "+getLabel(score);strengthBarHtml+="<ul>";for(var i=0;i<2;i++)strengthBarHtml+='<li class="point">';for(var j=0;j<score;j++)strengthBarHtml=strengthBarHtml.replace(/"point"/i,getColor(score));return strengthBarHtml+="</ul>",$sce.trustAsHtml(strengthBarHtml)},getLabel=function(score){return score<2?"Too short":score<3?"Fair":score<4?"Medium":"Strong"},getColor=function(score){return score<2?"point-weak":score<3?"point-fair":score<4?"point-good":"point-strong"};scope.$watch(attrs.passwordStrength,function(pass){var score=0;angular.isDefined(pass)?(pass.length>8&&score++,pass.match(/[a-z]/)&&pass.match(/[A-Z]/)&&score++,pass.match(/\d+/)&&score++,pass.match(/.[!,@,#,$,%,^,&,*,?,_,~,-,(,)]/)&&score++,pass.length>12&&score++):score=0,scope.strengthBar=buildStrengthBar(score)})}}}]),function(){var mod=angular.module("routeStyles",["ngRoute"]);mod.directive("head",["$rootScope","$compile",function($rootScope,$compile){return{restrict:"E",link:function(scope,elem){var html='<link rel="stylesheet" ng-repeat="(routeCtrl, cssUrl) in routeStyles" ng-href="{{cssUrl}}" >';elem.append($compile(html)(scope)),scope.routeStyles={},$rootScope.$on("$routeChangeStart",function(e,next,current){current&&current.$$route&&current.$$route.css&&(Array.isArray(current.$$route.css)||(current.$$route.css=[current.$$route.css]),angular.forEach(current.$$route.css,function(sheet){delete scope.routeStyles[sheet]})),next&&next.$$route&&next.$$route.css&&(Array.isArray(next.$$route.css)||(next.$$route.css=[next.$$route.css]),angular.forEach(next.$$route.css,function(sheet){scope.routeStyles[sheet]=sheet}))})}}}])}(),angular.module("bandcampApp.scrollToMe",[]).directive("scrollToMe",function($window){return{restrict:"A",link:function(scope,element){scope.$watch("ui.activeBlock.TotalApplicants",function(newV){if(newV){var top=element.offset().top;$window.scrollTo(0,top)}})}}}),angular.module("bandcampApp.draggable",[]).directive("draggable",function(){return{restrict:"A",link:function(scope,element,attrs){element.draggable({cursor:"move",stop:function(event,ui){scope[attrs.xpos]=ui.position.left,scope[attrs.ypos]=ui.position.top,scope.$apply()}})}}}),angular.module("bandcampApp.errSrc",[]).directive("errSrc",function(){return{link:function(scope,element,attrs){element.bind("error",function(){attrs.src!==attrs.errSrc&&attrs.$set("src",attrs.errSrc)})}}}),bandcampApp.directive("ngEnter",function(){return{link:function(scope,element,attrs){element.bind("keydown keypress",function(event){13===event.which&&(scope.$apply(function(){scope.$eval(attrs.ngEnter,{$event:event})}),event.preventDefault())})}}}),bandcampApp.directive("keepScroll",function(){return{controller:function(){var element;this.setElement=function(el){element=el},this.scroll=function(){$(element).animate({scrollTop:element.scrollHeight},500)}},link:function(scope,el,attr,ctrl){ctrl.setElement(el[0])}}}).directive("scrollItem",["$timeout",function($timeout){return{require:"^keepScroll",link:function(scope,el,att,scrCtrl){scope.$last===!0&&$timeout(function(){scrCtrl.scroll()})}}}]),angular.module("bandcampApp.jobSelector",[]).directive("jobSelector",function(){return{restrict:"E",require:"ngModel",scope:{jobs:"=",clear:"="},templateUrl:"template/job-select/job-select.tpl.html",link:function(scope,element,attrs,ngModel){function getJobById(id){return _.find(scope.jobs,function(job){return job.id===id})}scope.filteredJobs=scope.jobs,scope.data={},scope.$watch("data.selectedJob",function(value,old){value!==old&&ngModel.$setViewValue(getJobById(value))}),scope.$watch("jobs",function(){scope.filteredJobs=scope.jobs}),scope.$watch(function(){return ngModel.$modelValue},function(value){value&&(scope.data.selectedJob=value.id)}),scope.jobFilterByIdAndTitle=function(filterText){if(filterText){var txt=filterText.toLowerCase();scope.filteredJobs=scope.jobs.filter(function(x){return String(x.id).indexOf(txt)>=0||x.title.toLowerCase().indexOf(txt)>=0})}else scope.filteredJobs=scope.jobs}}}}),angular.module("bandcampApp.jobLabelSelect",[]).directive("jobLabelSelect",["$filter",function($filter){return{restrict:"E",require:"ngModel",scope:{labels:"="},templateUrl:"template/job-label-select/job-label-select.tpl.html",link:function(scope,element,attrs,ngModelCtrl){function checkIfParentExists(parentName){for(var found=!1,i=scope.labelTree.length;i--;)if(scope.labelTree[i].name===parentName){found=i;break}return found}function addParentLabelAndReturnPosition(label){return label.children=[],label.treelevel=0,scope.labelTree.push(label)-1}function getLabelsToArray(labels){return $filter("orderBy")(angular.copy(labels),"id").forEach(function(label){var parentPosition=!1;angular.isDefined(label.parent)?(parentPosition=checkIfParentExists(label.parent.name),angular.isNumber(parentPosition)||(parentPosition=addParentLabelAndReturnPosition(label.parent)),label.treelevel=1,scope.labelTree[parentPosition].children.push(label)):angular.isNumber(checkIfParentExists(label.name))||addParentLabelAndReturnPosition(label)}),scope.labelTree}function buildLabelsTree(labels){var dropdownLabelTree=[];getLabelsToArray(labels).forEach(function(parentLabel){var parent=angular.copy(parentLabel);delete parent.children,dropdownLabelTree.push(parent),parentLabel.children.forEach(function(childLabel){dropdownLabelTree.push(childLabel)})}),scope.labelTree=[{id:"",name:"All Job Categories",treelevel:0}],scope.labelTree=scope.labelTree.concat(dropdownLabelTree)}function getLabelObjectById(id){return _.find(scope.labelTree,function(label){return label.id===id})}scope.data={},scope.labelTree=[],buildLabelsTree(scope.labels),scope.labelFilter=function(filterText){if(filterText){var txt=filterText.toLowerCase();scope.filteredLabels=scope.labelTree.filter(function(x){return x.name.toLowerCase().indexOf(txt)>=0})}else scope.filteredLabels=scope.labelTree},scope.$watch("data.selectedLabel",function(value){value&&ngModelCtrl.$setViewValue(value)}),scope.$watch(function(){return ngModelCtrl.$modelValue},function(value){value?scope.data.selectedLabel=getLabelObjectById(value.id):scope.data.selectedLabel=scope.labelTree[0]})}}}]),function(window,angular){angular.module("bandcampApp.multitracker",["angulartics"]).config(["$analyticsProvider",function($analyticsProvider){$analyticsProvider.settings.pageTracking.trackRelativePath=!0,angular.isObject(window.trackingCodes)&&angular.isDefined(window.trackingCodes.googleAdwords)&&angular.isDefined(window.trackingCodes.facebook)&&$analyticsProvider.registerPageTrack(function(path){if(path.match(/\/redirect\/verify/)){window.fbq&&fbq("track","CompleteRegistration");var adWordsFunction=window.google_trackConversion,adWordsParameters=void 0===window.trackingCodes?void 0:window.trackingCodes.googleAdwords;if(adWordsFunction&&adWordsParameters){var o=angular.copy(adWordsParameters);o.google_custom_params={uri:path},window.google_trackConversion(o)}}})}])}(window,window.angular),bandcampApp.directive("warnOnBlur",["$timeout",function($timeout){return{restrict:"E",transclude:!0,replace:!0,template:'<form> <div ng-transclude></div> <input type="submit" style="display: none;"></form>',controller:function(){},link:function(scope,e,attrs,ctrl){ctrl.submit=function(){$timeout(function(){e.find(":submit")[0].click()})}}}}]),bandcampApp.directive("validateOnBlur",function(){return{restrict:"A",require:"^warnOnBlur",link:function(scope,element,attrs,warnOnBlur){element.on("blur",function(){element.checkValidity()||warnOnBlur.submit()})}}}),angular.module("bandcampApp.showFocus",[]).directive("showFocus",function($timeout){return function(scope,element,attrs){scope.$watch(attrs.showFocus,function(newValue){$timeout(function(){newValue&&element.focus()})},!0)}}),angular.module("bandcampApp.fixedOnScroll",[]).directive("fixedOnScroll",["$window","$timeout",function($window,$timeout){return{restrict:"A",scope:{tableData:"="},link:function(scope,element,attrs){function initialiseTableCloneSize(){if(scope.data.isTableHeader&&!scope.data.isWidthFixed){var elementChildren=element.find("th");scope.data.tableClone=angular.element(document.querySelector("#"+attrs.rel));var tableCloneChildren=scope.data.tableClone.find("th");scope.data.tableClone.css({width:element[0].offsetWidth});for(var iterator=tableCloneChildren.length;iterator--;)angular.element(tableCloneChildren[iterator]).css({width:elementChildren[iterator].offsetWidth});scope.data.isWidthFixed=!0,scope.data.target=scope.data.tableClone}}function checkIfIsTableHeader(){scope.data.isTableHeader=element.hasClass("fixed-table-header")}function init(){$timeout(function(){scope.data.isWidthFixed=!1,initialiseTableCloneSize()},500)}scope.data={isTableHeader:!1,isWidthFixed:!1,tableClone:null,target:element,targetInitialPosition:$(element[0]).offset().top},checkIfIsTableHeader(),angular.isDefined(scope.tableData)?scope.$watch("tableData",function(value){value&&init()}):init();var windowElement=angular.element($window);windowElement.bind("resize",init),windowElement.bind("scroll",function(){this.pageYOffset>=scope.data.targetInitialPosition?scope.data.target.addClass("fixed-on-scroll"):scope.data.target.removeClass("fixed-on-scroll")})}}}]),angular.module("bandcampApp.elResize",[]).directive("elResize",["$window",function($window){return function(scope,element,attr){scope.elResize={wDiff:angular.isDefined(attr.wDiff)?parseInt(attr.wDiff):0,hDiff:angular.isDefined(attr.hDiff)?parseInt(attr.hDiff):0,wIgnore:!!angular.isDefined(attr.wIgnore),hIgnore:!!angular.isDefined(attr.hIgnore)};var w=angular.element($window);scope.getWindowDimensions=function(){return{h:w.height(),w:w.width()}},scope.$watch(scope.getWindowDimensions,function(newValue){scope.windowHeight=newValue.h,scope.windowWidth=newValue.w,scope.style=function(){return scope.elResize.wIgnore?{height:newValue.h-scope.elResize.hDiff+"px"}:scope.elResize.hIgnore?{width:newValue.w-scope.elResize.wDiff+"px"}:{height:newValue.h-scope.elResize.hDiff+"px",width:newValue.w-scope.elResize.wDiff+"px"}}},!0),w.bind("resize",function(){scope.$apply()})}}]),bandcampApp.directive("horizontalScroll",["$window",function($window){return{restrict:"A",link:function(scope,el){var element=el[0],hamster=$window.Hamster(element);hamster.wheel(function(e,delta){element.scrollLeft-=30*delta,e.preventDefault()})}}}]),angular.module("bandcampApp.jobNotes",[]).directive("jobNotes",["JobService","$filter","$timeout",function(JobService,$filter,$timeout){return{restrict:"E",replace:!0,scope:{jobId:"=",type:"=",showNotes:"=",loading:"="},templateUrl:"template/job-notes/job-notes.tpl.html",link:function(scope,element){function formatNotesDate(notes){return angular.forEach(notes,function(note){note.date=$filter("date")(note.createdOn,"MMMM d, yyyy"),note.time=$filter("date")(note.createdOn,"h:mma")}),notes}function scrollNotesToBottom(){var el=angular.element(element[0].querySelector(".chat"));$timeout(function(){el[0].scrollTop=el[0].scrollHeight},100)}function getNotes(){JobService.crud.getNotes({id:scope.jobId,type:scope.type},function(data){scope.data.notes=formatNotesDate(data),scrollNotesToBottom()})}scope.data={notes:null,note:null},scope.UI={showNotes:!1},getNotes(),scope.saveNote=function(){if(scope.data.note){var note={content:scope.data.note,type:scope.type};scope.loading=JobService.crud.saveNote({id:scope.jobId,avatarType:"MANAGER"},note,function(res){scope.data.notes=formatNotesDate(res),scrollNotesToBottom(),scope.data.note=null})}}}}}]),ctrls.controller("CommandCenterCtrl",["JobService","$scope","uiGridConstants","$uibModal","$rootScope","$location",function(JobService,$scope,uiGridConstants,$uibModal,$rootScope,$location){var vm=this;vm.UI={},vm.load=function(){vm.loading=JobService.crud.getJobsSlas(),vm.loading.$promise.then(function(data){vm.gridOptions.data=data})["catch"](function(err){vm.UI.error=err.data.text})},vm.init=function(){vm.gridOptions={enableColumnMenus:!1},vm.gridOptions.columnDefs=[{displayName:"Job Name",field:"job.title",width:350,pinnedLeft:!0,enableSorting:!0,cellTooltip:!0,cellTemplate:"job-name.tpl.html"},{displayName:"Job Code",field:"job.id",width:90,pinnedLeft:!0,enableSorting:!0,type:"number",sort:{direction:uiGridConstants.DESC}},{displayName:"AM Name",field:"job.accountManager.printableName",width:150,pinnedLeft:!0,enableSorting:!0,cellTooltip:!0},{displayName:"HM Name(s)",field:"job.visibleManagers[0].printableName",width:150,enableSorting:!1,cellTemplate:"visible-managers.tpl.html"},{displayName:"Total #Candidates",field:"totalCandidates",width:150,enableSorting:!1},{displayName:"In Progress Candidates",field:"inprogressCandidates",width:170,enableSorting:!1},{name:"#Resumes Previewed / Calibrated",width:235,enableSorting:!1,cellTemplate:"resume-previewed-calibrated.tpl.html"},{name:"#Passers Previewed / Calibrated",width:235,enableSorting:!1,cellTemplate:"passers-previewed-calibrated.tpl.html"},{displayName:"#Endorsed",field:"endorsedCandidates",width:100,enableSorting:!1},{name:"#Interviews Scheduled / Conducted",width:245,enableSorting:!1,cellTemplate:"interviews-scheduled-conducted.tpl.html"},{displayName:"#Rejected By HM",field:"rejectedByHM",width:150,enableSorting:!1},{displayName:"#Hired",field:"hiredCount",width:75,enableSorting:!1},{displayName:"Outstanding Demand",field:"outstandingDemand",width:165,enableSorting:!1},{displayName:"Next Action",field:"delayAction",width:175,enableSorting:!1},{name:"Red/Green",field:"delayAction",displayName:"Red/Green status of SLA timeline",width:265,enableSorting:!0,cellTemplate:"sla-timeline-status.tpl.html"}],vm.load()},vm.init(),$scope.getSlaTimelineStatus=function(entity){return!(!angular.isDefined(entity.delayAction)||0===entity.delayAction.length)},$scope.getSlaDelayPeriod=function(entity){var str="";return angular.isDefined(entity.delayDays)&&(str=entity.delayReason+" ("+entity.delayDays+" day",entity.delayDays>1&&(str+="s"),str+=" delay)"),str},vm.openOtherManagersModalCtrl=function($scope,$uibModalInstance,job){$scope.job=job,$scope.close=function(){$uibModalInstance.dismiss("cancel")}},$scope.redirectToJobCalibration=function(jobId){jobId&&($rootScope.selectedGlobalPipelineId=jobId,$location.path("/calibrations"))},$scope.openOtherManagersModal=function(job){$scope.modalInstance=$uibModal.open({templateUrl:"other-managers.tpl.html",controller:vm.openOtherManagersModalCtrl,scope:$scope,resolve:{job:function(){return job}}})}}]),angular.module("bandcampApp.ngInline",[]).directive("ngInline",["$compile","$templateCache",function($compile,$templateCache){return{restrict:"A",priority:400,compile:function(element,attrs){var templateName=attrs.ngInline;if(!templateName)throw new Error("ngInline: expected template name");var template=$templateCache.get(templateName);if(angular.isUndefined(template))throw new Error("ngInline: unknown template "+templateName);return function(scope,element){element.html(template),$compile(element.contents())(scope)}}}}]),angular.module("afkl.lazyImage",[]),angular.module("afkl.lazyImage").service("afklSrcSetService",["$window","$timeout",function($window,$timeout){function ImageInfo(options){this.src=options.src,this.w=options.w||1/0,this.h=options.h||1/0,this.x=options.x||1}function debounce(call,delay){var preventCalls=!1;return function(){preventCalls||(call(),preventCalls=!0,$timeout(function(){preventCalls=!1},delay))}}var INT_REGEXP=/^[0-9]+$/,_parseDescriptors=function(descString){for(var descriptors=descString.split(/\s/),out={},i=0,l=descriptors.length;i<l;i++){var desc=descriptors[i];if(desc.length>0){var lastChar=desc.slice(-1),value=desc.substring(0,desc.length-1),intVal=parseInt(value,10),floatVal=parseFloat(value);value.match(INT_REGEXP)&&"w"===lastChar?out[lastChar]=intVal:value.match(INT_REGEXP)&&"h"===lastChar?out[lastChar]=intVal:isNaN(floatVal)||"x"!==lastChar||(out[lastChar]=floatVal)}}return out},_getBestCandidateIf=function(images,criteriaFn){for(var bestCandidate=images[0],i=0,l=images.length;i<l;i++){var candidate=images[i];criteriaFn(candidate,bestCandidate)&&(bestCandidate=candidate)}return bestCandidate},_removeCandidatesIf=function(images,criteriaFn){for(var i=images.length-1;i>=0;i--){var candidate=images[i];criteriaFn(candidate)&&images.splice(i,1)}return images},getBestImage=function(imageCandidates,view){if(imageCandidates){view||(view={w:$window.innerWidth||document.documentElement.clientWidth,h:$window.innerHeight||document.documentElement.clientHeight,x:$window.devicePixelRatio||1});var images=imageCandidates.slice(0),largestWidth=_getBestCandidateIf(images,function(a,b){return a.w>b.w});_removeCandidatesIf(images,function(){return function(a){return a.w<view.w}}(this)),0===images.length&&(images=[largestWidth]);var largestHeight=_getBestCandidateIf(images,function(a,b){return a.h>b.h});_removeCandidatesIf(images,function(){return function(a){return a.h<view.h}}(this)),0===images.length&&(images=[largestHeight]);var largestPxDensity=_getBestCandidateIf(images,function(a,b){return a.x>b.x});_removeCandidatesIf(images,function(){return function(a){return a.x<view.x}}(this)),0===images.length&&(images=[largestPxDensity]);var smallestWidth=_getBestCandidateIf(images,function(a,b){return a.w<b.w});_removeCandidatesIf(images,function(a){return a.w>smallestWidth.w});var smallestHeight=_getBestCandidateIf(images,function(a,b){return a.h<b.h});_removeCandidatesIf(images,function(a){return a.h>smallestHeight.h});var smallestPxDensity=_getBestCandidateIf(images,function(a,b){return a.x<b.x});return _removeCandidatesIf(images,function(a){return a.x>smallestPxDensity.x}),images[0]}},getSrcset=function(options){var imageCandidates=[],srcValue=options.src,srcsetValue=options.srcset;if(srcsetValue){var _addCandidate=function(img){for(var j=0,ln=imageCandidates.length;j<ln;j++){var existingCandidate=imageCandidates[j];if(existingCandidate.x===img.x&&existingCandidate.w===img.w&&existingCandidate.h===img.h)return}imageCandidates.push(img)},_parse=function(){for(var url,descriptors,input=srcsetValue,position=0,rawCandidates=[];""!==input;){for(;" "===input.charAt(0);)input=input.slice(1);position=input.indexOf(" "),position!==-1?(url=input.slice(0,position),input=input.slice(position+1),position=input.indexOf(","),position===-1?(descriptors=input,input=""):(descriptors=input.slice(0,position),input=input.slice(position+1)),rawCandidates.push({url:url,descriptors:descriptors})):(rawCandidates.push({url:input,descriptors:""}),input="")}for(var i=0,l=rawCandidates.length;i<l;i++){var candidate=rawCandidates[i],desc=_parseDescriptors(candidate.descriptors);_addCandidate(new ImageInfo({src:candidate.url,x:desc.x,w:desc.w,h:desc.h}))}srcValue&&_addCandidate(new ImageInfo({src:srcValue}))};_parse();var bestImage=getBestImage(imageCandidates),object={best:bestImage,candidates:imageCandidates};return imageCandidates=null,object}};return{get:getSrcset,image:getBestImage,debounce:debounce}}]),angular.module("afkl.lazyImage").directive("afklImageContainer",function(){return{restrict:"A",controller:["$scope","$element",function($scope,$element){$element.data("afklImageContainer",$element)}]}}).directive("afklLazyImage",["$rootScope","$window","$timeout","afklSrcSetService","$parse",function($rootScope,$window,$timeout,srcSetService,$parse){var bestImage=function(images){var sourceUrl,image=srcSetService.get({srcset:images});return image&&(sourceUrl=image.best.src),sourceUrl};return{restrict:"A",link:function(scope,element,attrs){var _concatImgAttrs=function(imgAttrs){var result=[];return options.imgAttrs&&(result=Array.prototype.map.call(imgAttrs,function(item){for(var key in item)if(item.hasOwnProperty(key))return String.prototype.concat.call(key,'="',item[key],'"')})),result.join(" ")},$container=element.inheritedData("afklImageContainer");$container||($container=angular.element(attrs.afklLazyImageContainer||$window));var timeout,loaded=!1,images=attrs.afklLazyImage,options=attrs.afklLazyImageOptions?$parse(attrs.afklLazyImageOptions)(scope):{},img=null,currentImage=null,offset=options.offset?options.offset:50,imgAttrs=_concatImgAttrs(options.imgAttrs),LOADING="afkl-lazy-image-loading";attrs.afklLazyImageLoaded=!1;var _containerScrollTop=function(){if($container.scrollTop){var scrollTopPosition=$container.scrollTop();if(scrollTopPosition)return scrollTopPosition}var c=$container[0];return void 0!==c.pageYOffset?c.pageYOffset:void 0!==c.scrollTop?c.scrollTop:document.documentElement.scrollTop||0},_containerInnerHeight=function(){if($container.innerHeight)return $container.innerHeight();var c=$container[0];return void 0!==c.innerHeight?c.innerHeight:void 0!==c.clientHeight?c.clientHeight:document.documentElement.clientHeight||0},_elementOffset=function(){if(element.offset)return element.offset().top;var box=element[0].getBoundingClientRect();return box.top+_containerScrollTop()-document.documentElement.clientTop},_elementOffsetContainer=function(){return element.offset?element.offset().top-$container.offset().top:element[0].getBoundingClientRect().top-$container[0].getBoundingClientRect().top},_setImage=function(){options.background?element[0].style.backgroundImage='url("'+currentImage+'")':img&&(img[0].src=currentImage)},_placeImage=function(){loaded=!0;var hasImage=bestImage(images);hasImage&&(options.background||img||(element.addClass(LOADING),img=angular.element("<img "+imgAttrs+" />"),img.one("load",_loaded),img.one("error",_error),element.append(img)),_checkIfNewImage()),$container.off("scroll",_onViewChange)},_checkIfNewImage=function(){if(loaded){var newImage=bestImage(images);newImage!==currentImage&&(currentImage=newImage,_setImage())}};_checkIfNewImage();var _loaded=function(){attrs.$set("afklLazyImageLoaded","done"),element.removeClass(LOADING)},_error=function(){attrs.$set("afklLazyImageLoaded","fail")},_onViewChange=function(){if(!loaded){var remaining,shouldLoad,windowBottom,height=_containerInnerHeight(),scroll=_containerScrollTop(),elOffset=$container[0]===$window?_elementOffset():_elementOffsetContainer();windowBottom=$container[0]===$window?height+scroll:height,remaining=elOffset-windowBottom,shouldLoad=remaining<=offset,shouldLoad&&_placeImage()}},_onViewChangeDebounced=srcSetService.debounce(_onViewChange,300),_onResize=function(){$timeout.cancel(timeout),timeout=$timeout(function(){_checkIfNewImage(),_onViewChange()},300)},_eventsOff=function(){$timeout.cancel(timeout),angular.element($window).off("resize",_onResize),angular.element($window).off("scroll",_onViewChangeDebounced),$container[0]!==$window&&($container.off("resize",_onResize),$container.off("scroll",_onViewChangeDebounced)),img&&img.remove(),img=timeout=currentImage=void 0};return angular.element($window).on("resize",_onResize),angular.element($window).on("scroll",_onViewChangeDebounced),$container[0]!==$window&&($container.on("resize",_onResize),$container.on("scroll",_onViewChangeDebounced)),attrs.$observe("afklLazyImage",function(){images=attrs.afklLazyImage,loaded&&_placeImage()}),options.nolazy&&_placeImage(),scope.$on("afkl.lazyImage.destroyed",_onResize),scope.$on("$destroy",function(){return $rootScope.$broadcast("afkl.lazyImage.destroyed"),_eventsOff()}),_onViewChange()}}}]),angular.module("afkl.lazyImage").directive("veryLazyImage",["$window","$timeout","afklSrcSetService","$parse","afklLazyImageDirective",function($window,$timeout,srcSetService,$parse,afklLazyImage){var l=afklLazyImage[0].link;return{restrict:"A",link:function($scope,element,attrs){return attrs.afklLazyImage=attrs.veryLazyImage,l($scope,element,attrs)}}}]),angular.module("bandcampApp.imgFadein",[]).directive("imgFadein",function(){return{restrict:"A",link:function($scope,$element,attrs){$element.on("load",function(){$element.removeClass("ng-hide-remove"),$element.addClass("ng-hide-add")}),attrs.$observe("ngSrc",function(){$element.removeClass("ng-hide-add"),$element.addClass("ng-hide-remove")})}}}),angular.module("bandcampApp.tableToCsv",[]).directive("tableToCsv",["$parse",function($parse){return{restrict:"A",scope:!1,link:function(scope,element,attrs){var data="",separator=attrs.separator?attrs.separator:",",csv={stringify:function(str){return'"'+str.replace(/^\s\s*/,"").replace(/\s*\s$/,"").replace(/"/g,'""')+'"'},generate:function(){data="";var rows=element.find("tr");angular.forEach(rows,function(row){var tr=angular.element(row),tds=tr.find("th"),rowData="";tr.attr("export-csv-ignore")||(0===tds.length&&(tds=tr.find("td")),angular.forEach(tds,function(td){var value="";if(td=angular.element(td),!td.attr("export-csv-ignore")){var possibleText=angular.element(td).find('[csv-showable-text="true"]');value=0===possibleText.length?angular.element(td).text():possibleText.text()}rowData+=csv.stringify(value)+separator}),rowData=rowData.slice(0,rowData.length-1),data+=rowData+"\n")})},link:function(){return"data:text/csv;charset=UTF-8,"+encodeURIComponent(data)}};$parse(attrs.tableToCsv).assign(scope.$parent,csv)}}}]),bandcampApp.directive("convertToNumber",function(){return{require:"ngModel",
link:function(scope,element,attrs,ngModel){ngModel.$parsers.push(function(val){return val?parseInt(val,10):null}),ngModel.$formatters.push(function(val){return val?""+val:null})}}}),bandcampApp.directive("progressbarCircleArrow",["routePrefix","$location","$interval",function(routePrefix,$location,$interval){var tplUrl="common/directives/progressbar-circle-arrow/progressbar-circle-arrow.tpl.html";return{restrict:"E",replace:!0,scope:{data:"=chart"},templateUrl:routePrefix?routePrefix+tplUrl:tplUrl,link:function(scope,element){function clamp(n,min,max){return Math.max(min,Math.min(max,n))}function drawProgress(percent){if(!isNaN(percent)){percent=clamp(parseFloat(percent),0,1);var angle=clamp(360*percent,0,359.99999),paddedRadius=51,radians=angle*Math.PI/180,x=Math.sin(radians)*paddedRadius,y=Math.cos(radians)*-paddedRadius,mid=angle>180?1:0,pathData="M 0 0 v -%@ A %@ %@ 1 ".replace(/%@/gi,paddedRadius)+mid+" 1 "+x+" "+y+" z";progressBar.setAttribute("d",pathData)}}function init(){var max=100*scope.data.value/scope.data.maxValue/100,progress=0;if(scope.data.value>0){drawProgress(progress);var promise=$interval(function(){progress+=.01,progress>=max&&$interval.cancel(promise),drawProgress(progress)},10)}}var progressBar=element[0].querySelector(".pca-bar");scope.runId=(new Date).getTime(),scope.absUrl=$location.absUrl(),scope.$watch("data",function(value){value&&init()},!0)}}}]),angular.module("bandcampApp.autoFocus",[]).directive("autoFocus",["$timeout",function($timeout){return{link:function(scope,element,attrs){attrs.$observe("autoFocus",function(){$timeout(function(){element[0].focus()})})}}}]),bandcampApp.directive("hasFeature",["CurrentUser",function(CurrentUser){return{restrict:"AE",link:function(scope,element,attrs){element.hide(),CurrentUser.get().$promise.then(function(res){var exists=_.findWhere(res.userFeatures,{userFeature:attrs.hasFeature});exists&&element.show()})}}}]),bandcampApp.directive("bcDatePicker",["routePrefix",function(routePrefix){return{restrict:"E",transclude:!0,templateUrl:routePrefix+"common/directives/date-picker/bc-date-picker.tpl.html",scope:{periodMode:"=",pickedDate:"="},controller:"BcDatePickerCtrl"}}]).controller("BcDatePickerCtrl",["$scope",function($scope){var Period={DAILY:{next:function(date){return moment(date).add(1,"days").format(moment.DateFormat.ISO_8601)},back:function(date){return moment(date).subtract(1,"days").format(moment.DateFormat.ISO_8601)}},WEEKLY:{next:function(date){return moment(date).add(1,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601)},back:function(date){return moment(date).subtract(1,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601)}},MONTHLY:{next:function(date){return moment(date).add(1,"months").date(1).format(moment.DateFormat.ISO_8601)},back:function(date){return moment(date).subtract(1,"months").date(1).format(moment.DateFormat.ISO_8601)}}},today=moment().format(moment.DateFormat.ISO_8601);$scope.periodMode=$scope.periodMode||"DAILY",$scope.period=Period[$scope.periodMode],$scope.pickedDate=$scope.pickedDate||today,$scope.maxDate=today,$scope.options={startingDay:1,showWeeks:!1},$scope.isOpen=!1,$scope.toggle=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.isOpen=!$scope.isOpen},$scope.back=function(){$scope.pickedDate=$scope.period.back($scope.pickedDate)},$scope.next=function(){$scope.pickedDate=$scope.period.next($scope.pickedDate)},$scope.updatePickedDate=function(newCalendarDate){$scope.pickedDate=moment(newCalendarDate).format(moment.DateFormat.ISO_8601)},$scope.$watch("pickedDate",function(pickedDate){$scope.calendarDate=moment(pickedDate).toDate(),$scope.isNext=moment($scope.maxDate).add(1,"days").isAfter($scope.period.next(pickedDate))}),$scope.$watch("periodMode",function(newMode){$scope.period=Period[newMode]})}]),bandcampApp.directive("xoAppendToBody",function(){return{scope:{placement:"@xoPlacement",show:"=xoShow"},link:function(scope,element){function getCoords(elem){var box=elem.getBoundingClientRect(),body=document.body,docEl=document.documentElement,scrollTop=window.pageYOffset||docEl.scrollTop||body.scrollTop,scrollLeft=window.pageXOffset||docEl.scrollLeft||body.scrollLeft,clientTop=docEl.clientTop||body.clientTop||0,clientLeft=docEl.clientLeft||body.clientLeft||0,top=box.top+scrollTop-clientTop,left=box.left+scrollLeft-clientLeft;return{top:Math.round(top),left:Math.round(left),width:box.width}}function init(){switch(parentPosition=getCoords(parent[0]),angular.element(document.body).append(element),scope.placement){case"right":elementPosition={top:parentPosition.top,left:parentPosition.left+parentPosition.width};break;default:elementPosition={top:parentPosition.top,left:parentPosition.left}}for(prop in elementPosition)element.css(prop,elementPosition[prop])}function hide(){parent[0].contains(element[0])||parent.append(element)}var parentPosition,elementPosition,prop,parent=element.parent();scope.$watch("show",function(value){value?init():hide()}),scope.$on("$destroy",function(){scope.show&&element.remove()})}}}),bandcampApp.directive("fullscreenModal",["routePrefix",function(routePrefix){return{restrict:"E",transclude:!0,templateUrl:routePrefix+"common/directives/fullscreen-modal/fullscreen-modal.tpl.html",scope:{show:"="},link:function(scope){scope.$watch("show",function(show){var body=angular.element("body");show?body.addClass("overflowAllh"):body.removeClass("overflowAllh")}),scope.$on("$locationChangeStart",scope.hide),scope.hide=function(){scope.show=!1}}}}]),bandcampApp.directive("optionTitle",["$timeout",function(){return{scope:{managers:"=managers"},link:function(scope,element){function populateTitle(){_.isEmpty(managersByIds)&&(managersByIds=_.indexBy(scope.managers,"id")),element.find("option").each(function(){var value=this.getAttribute("value");_.has(managersByIds,value)&&(this.title=managersByIds[value].email)})}var managersByIds;scope.$watch(function(){return element.get(0).childNodes.length},function(newValue){scope.managers&&newValue===scope.managers.length&&populateTitle()})}}}]),ctrls.controller("AdminAssignmentEditCtrl",["$scope","$routeParams","AdminAssignmentsService","$uibModal","TeamService","ManagerService","JobService","Flash","CurrentUser","$location","EnumsService","$window","$q",function($scope,$routeParams,AdminAssignmentsService,$uibModal,TeamService,ManagerService,JobService,Flash,CurrentUser,$location,EnumsService,$window,$q){function isFeatureEnabled(assignment,feature){return assignment.disabledFeatures.indexOf(feature)===-1}function initFeatures(a){a.features={},a.features.screenshots=isFeatureEnabled(a,"SCREENSHOTS"),a.features.webcam=isFeatureEnabled(a,"WEBCAM_PICTURES"),a.features.applicationTracking=isFeatureEnabled(a,"APPLICATION_TRACKING"),a.features.marketplace=isFeatureEnabled(a,"MARKETPLACE"),a.features.activities=isFeatureEnabled(a,"TIME_ACTIVITIES"),a.features.metrics=isFeatureEnabled(a,"TICKETING_INTEGRATION"),a.features.enforcerReview=isFeatureEnabled(a,"ENFORCER_REVIEW")}function setDisabledFeatures(a){a.disabledFeatures=[],a.features.screenshots||a.disabledFeatures.push("SCREENSHOTS"),a.features.webcam||a.disabledFeatures.push("WEBCAM_PICTURES"),a.features.applicationTracking||a.disabledFeatures.push("APPLICATION_TRACKING"),a.features.marketplace||a.disabledFeatures.push("MARKETPLACE"),a.features.activities||a.disabledFeatures.push("TIME_ACTIVITIES"),a.features.metrics||a.disabledFeatures.push("TICKETING_INTEGRATION"),a.features.enforcerReview||a.disabledFeatures.push("ENFORCER_REVIEW")}function showError(err){$scope.UI.error||($scope.UI.error=err)}$scope.UI={isLoading:!0,title:"Edit assignment",left:4,right:8,datePickerOptions:{startingDay:1,showWeeks:!1},companies:[],teams:[],isDatePickerDisplayed:!1,minDate:moment().add(1,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).toDate()},$scope.data={},CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home")});var idSort=function(a,b){return a.id-b.id},processJob=function(input){var i=angular.copy(input);return delete i.candidateDescription,delete i.managerDescription,delete i.skills,i};$scope.disabled=function(date,mode){return"day"===mode&&1!==date.getDay()},$scope.updateEffectiveDate=function(history,newEffectiveDate){history.effectiveDateBegin=moment(newEffectiveDate).format(moment.DateFormat.ISO_8601)},$scope.scheduleNewHistory=function(){var ash,hasScheduledHistory=!!$scope.data.deletedHistory;if(hasScheduledHistory)ash=$scope.data.deletedHistory,$scope.data.deletedHistory=null;else{var currentHistory=$scope.data.assignment.currentAssignmentHistory;ash=angular.copy(currentHistory),ash.company=angular.copy(currentHistory.team.company),ash.team=angular.copy(currentHistory.team),ash.manager=angular.copy(currentHistory.manager),ash.id=0}$scope.data.assignment.assignmentHistories.push(ash),$scope.data.scheduledHistory=ash,$scope.changeCompany(ash),ash.assignmentHistoryStatus="SCHEDULED",ash.effectiveDateBegin=moment().add(1,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601)},$scope.deleteHistory=function(ash){$scope.data.scheduledHistory=null,$scope.data.assignment.assignmentHistories=_.without($scope.data.assignment.assignmentHistories,ash),$scope.data.deletedHistory=ash},$scope.changeCompany=function(history,isNew){var company=history.company,teams=_.filter($scope.allTeams,function(t){return company&&t.company.id===company.id});$scope.UI.teams=_.sortBy(teams,function(t){return t.name}),isNew&&(history.team=_.isEmpty($scope.UI.teams)?null:$scope.UI.teams[0],history.manager=_.isEmpty($scope.managers)?null:$scope.managers[0])},$scope.save=function(){$scope.UI.isLoading=!0;var req={id:$scope.data.assignment.id,assignment:angular.copy($scope.data.assignment)};angular.isDefined($scope.data.manager)&&(req.managerId=$scope.data.manager.id),angular.isDefined($scope.data.job)&&(req.jobId=$scope.data.job.id),setDisabledFeatures(req.assignment),delete req.assignment.selection,delete req.assignment.team,AdminAssignmentsService.edit(req,function(res){"TERMINATED"===res.status?Flash.addSuccess("Changes saved successfully!","/admin/assignments"):scheduleHistory(req.assignment)},function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})};var scheduleHistory=function(assignment){assignment.assignmentHistories=_.filter(assignment.assignmentHistories,function(ash){return"SCHEDULED"===ash.assignmentHistoryStatus}),AdminAssignmentsService.scheduleHistories({id:assignment.id},assignment,function(){Flash.addSuccess("Changes saved successfully!","/admin/assignments")},function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})};$scope.terminate=function(){$scope.hideModal(),$scope.data.assignment.status="TERMINATED",$scope.save()},$scope.back=function(){$window.history.back()};var modal=null;$scope.openModal=function(){modal=$uibModal.open({templateUrl:"termination-warning.tpl.html",scope:$scope,backdrop:"static"})},$scope.hideModal=function(){modal.dismiss("cancel")},$scope.salaryTypeChanged=function(){$scope.data.assignment.weeklySalary=null,$scope.data.assignment.weeklyLimit=null,$scope.data.assignment.salary=null};var userData=function(i){return angular.isObject(i)?{id:i.id,userId:i.userId,email:i.email,firstName:i.firstName,lastName:i.lastName,type:i.type}:i};!function(){var promises=[TeamService.shallowlist({avatarType:"ADMIN"}).$promise,AdminAssignmentsService.get({id:$routeParams.id}).$promise,ManagerService.query().$promise,EnumsService.get().$promise,JobService.crud.query().$promise];$q.all(promises).then(function(res){$scope.allTeams=res[0].sort(idSort);var a=res[1];$scope.managers=res[2].sort(idSort),$scope.data.enums=res[3],$scope.jobs=res[4].sort(idSort).map(processJob).filter(function(e){return e.custom}),$scope.assignment=a,initFeatures(a),$scope.data.id=a.id,$scope.data.manager=angular.copy(a.manager),$scope.data.customJob=a.selection.marketplaceMember.application.job.custom,$scope.data.job=processJob(a.selection.marketplaceMember.application.job),angular.isDefined(a.team)&&($scope.data.team=angular.copy(a.team)),$scope.data.assignment=a;var job=angular.copy(a.selection.marketplaceMember.application.job);$scope.data.assignment.selection.marketplaceMember.application.job={id:job.id,title:job.title},$scope.data.assignment.manager=userData($scope.data.assignment.manager),$scope.data.assignment.selection.marketplaceMember.application.candidate=userData($scope.data.assignment.selection.marketplaceMember.application.candidate);var companies=[];_.each($scope.managers,function(mgr){var existed=_.some(companies,function(c){return c.id===mgr.company.id});existed||companies.push(mgr.company)}),$scope.UI.companies=_.sortBy(companies,function(c){return c.name});var scheduled=_.find(a.assignmentHistories,function(ash){return"SCHEDULED"===ash.assignmentHistoryStatus}),company=$scope.assignment.team?$scope.assignment.team.company:null;scheduled&&(company=angular.copy(scheduled.team.company),scheduled.company=angular.copy(scheduled.team.company),$scope.data.scheduledHistory=scheduled),$scope.changeCompany({company:company}),$scope.UI.isLoading=!1,$scope.UI.error=!1})["catch"](function(err){showError(err.data.text)})}()}]),ctrls.controller("AdminAssignmentListCtrl",["$scope","$window","AdminAssignmentsService","CurrentUser","$location","QueryParams",function($scope,$window,AdminAssignmentsService,CurrentUser,$location,QueryParams){$scope.UI={isLoading:!0,title:"Assignments list",currentPage:1,pagination:{}},$scope.params={page:"1",search:""},QueryParams.read($scope.params),CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home")}),$scope.update=function(){var p=0;if($scope.UI.isLoading=!0,angular.isDefined($scope.params.page)&&(p=parseInt($scope.params.page)),p-1===$scope.UI.pagination.number&&angular.isDefined($scope.params.search)&&angular.isDefined($scope.UI.oldSearch)&&$scope.params.search===$scope.UI.oldSearch)return void($scope.UI.isLoading=!1);QueryParams.write($scope.params);var query={page:p-1};angular.isDefined($scope.params.search)&&(query.email=$scope.params.search),AdminAssignmentsService.get(query,function(d){$scope.data=angular.copy(d.content),delete d.content,$scope.UI.oldSearch=angular.copy($scope.params.search),$scope.UI.pagination=d,$scope.UI.isLoading=!1},function(e){$window.alert(e.data.text),$scope.UI.isLoading=!1})},$scope.update()}]),ctrls.controller("AdminAuditsCtrl",["$scope","AuditsService","CurrentUser","$location","QueryParams","$timeout",function($scope,AuditsService,CurrentUser,$location,QueryParams,$timeout){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}$scope.data={audits:[],searchQuery:QueryParams.readValue("searchQuery",null)},$scope.resetPagination=function(){return{size:10,totalPages:0,totalElements:0,currentPage:1}},$scope.ui={isLoading:!0,pagination:$scope.resetPagination()},$scope.ui.pagination.currentPage=QueryParams.readValue("page",0),CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home"),$scope.user=data}),$scope.doFilter=function(){QueryParams.write({searchQuery:$scope.data.searchQuery}),$scope.ui.pagination=$scope.resetPagination(),$scope.changePage()},$scope.changePage=function(){QueryParams.write({page:$scope.ui.pagination.currentPage-1}),$scope.load($scope.ui.pagination.currentPage-1,$scope.data.searchQuery)},$scope.load=function(page,searchQuery){$scope.timeoutPromise&&$timeout.cancel($scope.timeoutPromise),$scope.timeoutPromise=$timeout(function(){$scope.msg&&($scope.msg.show=!1),$scope.loadResource=AuditsService.query({searchQuery:searchQuery,page:page},function(data){$scope.data.audits=data.content,$scope.ui.pagination={size:data.size,currentPage:data.number+1,totalPages:data.totalPages,totalElements:data.totalElements},$scope.ui.isLoading=!1},function(err){showMessage("alert-danger",err.data.text)})},250)},$scope.load($scope.ui.pagination.currentPage,$scope.data.searchQuery)}]),ctrls.controller("AdminCompanyCtrl",["$scope","CompaniesService","CurrentUser","$location",function($scope,CompaniesService,CurrentUser,$location){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function setCompanyWebsiteURL(c){/^https?:\/\/.+/.test(c.website)?c.url=c.website:c.url="http://"+c.website}function loadCompanies(page,searchWord){$scope.ui.isLoading=!0,CompaniesService.query({page:page,searchWord:searchWord}).$promise.then(function(data){$scope.data.companies=data,$scope.ui.currentPage=$scope.data.companies.number+1,($scope.data.companies.content||[]).forEach(setCompanyWebsiteURL)})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}$scope.data={companies:null},$scope.ui={isLoading:!0,currentPage:0},$scope.msg={clazz:"",show:!1,message:""},CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home")}),$scope.changePage=function(){loadCompanies($scope.ui.currentPage-1,$scope.data.filterText)},$scope.doFilter=function(){loadCompanies(0,$scope.data.filterText)},loadCompanies(0)}]),ctrls.controller("AdminCompanyEditCtrl",["$scope","$routeParams","CompaniesService","CountriesService","TimezonesService","CurrentUser","$location","AccountManagerService","GoogleLocationService","EnumsService",function($scope,$routeParams,CompaniesService,CountriesService,TimezonesService,CurrentUser,$location,AccountManagerService,GoogleLocationService,EnumsService){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function errHandler(err){showMessage("alert-danger",err.data.text)}$scope.data={company:{},password:null,countries:[],timezones:[],filteredTimezones:[],selectedCountryId:null,selectedTimeZoneId:null,enums:[]},$scope.ui={isLoading:!0,isNewCompany:!$routeParams.id,title:($routeParams.id?"Edit":"Add")+" Company"},$scope.msg={clazz:"",show:!1,message:""},CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home")}),$scope.options={types:"(cities)"},$scope.$watch("data.selectedCountryId",function(newValue,oldValue){"undefined"!=typeof oldValue&&null!==oldValue&&oldValue!==newValue&&(delete $scope.data.company.location.city,delete $scope.data.company.location.state)}),$scope.changeCity=function(){if(void 0!==$scope.data.company.location.city){var result=GoogleLocationService.getCity($scope.data.company.location.city);$scope.data.company.location.city=result.city,$scope.data.company.location.state=result.state}},$scope.changeCountry=function(){var c=$scope.data.countries.filter(function(x){return x.id===$scope.data.selectedCountryId})[0];if($scope.options.country=c.code,$scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.selectedTimeZoneId=c.timezones[0].id;else if($scope.data.selectedTimeZoneId){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.selectedTimeZoneId},!1);isIncluded||($scope.data.selectedTimeZoneId=null)}},$scope.changeTimezone=function(){var tz=$scope.data.timezones.filter(function(x){return x.id===$scope.data.selectedTimeZoneId})[0];1===tz.countries.length&&($scope.data.selectedCountryId=tz.countries[0].id,$scope.options.country=tz.countries[0].code)},$scope.renewPassword=function(){$scope.data.password=Math.random().toString(26).substr(2)},$scope.save=function(form){if(!form.$invalid){var company=angular.copy($scope.data.company);company.location=company.location||{},company.location.country={id:$scope.data.selectedCountryId},company.location.timeZone={id:$scope.data.selectedTimeZoneId},company.location.city=$scope.data.company.location.city,company.location.state=$scope.data.company.location.state,void 0!==$scope.details&&(company.location.latLong=$scope.details.geometry.location.lat()+","+$scope.details.geometry.location.lng()),$scope.ui.isNewCompany&&(company.administrators=[company.administrator],company.administrators[0].location=angular.copy(company.location),company.administrators[0].avatarTypes||(company.administrators[0].avatarTypes=[]),company.administrators[0].type="COMPANY_ADMIN",company.administrators[0].avatarTypes.push("COMPANY_ADMIN"),company.administrators[0].userSecurity=company.administrators[0].userSecurity||{},company.administrators[0].userSecurity.rawPassword=$scope.data.password),$scope.ui.isLoading=!0;var promise=null;promise=$scope.ui.isNewCompany?CompaniesService.save(company).$promise:CompaniesService.update({id:company.id},company).$promise,promise.then(function(data){var str=$scope.ui.isNewCompany?"saved":"updated",msg="The company "+company.name+" is "+str+".";showMessage("alert-success",msg),$scope.data.company=data,$scope.ui.isNewCompany=!1})["catch"](errHandler)["finally"](function(){$scope.ui.isLoading=!1})}},$scope.renewPassword(),AccountManagerService.query(function(res){$scope.data.accountManagers=res}).$promise["catch"](errHandler),TimezonesService.query(function(timezones){CountriesService.query(function(countries){EnumsService.get(function(enums){$scope.data.timezones=timezones,$scope.data.filteredTimezones=timezones,$scope.data.countries=countries,$scope.data.enums=enums,$routeParams.id?CompaniesService.get({id:$routeParams.id}).$promise.then(function(data){$scope.data.company=data,$scope.data.selectedCountryId=data.location.country.id,$scope.data.selectedTimeZoneId=data.location.timeZone.id,$scope.changeCountry(),$scope.data.administrators="",angular.forEach($scope.data.company.administrators,function(adm){$scope.data.administrators+=adm.printableName+" - "+adm.email+"\r\n"})})["catch"](errHandler)["finally"](function(){$scope.ui.isLoading=!1}):($scope.data.company.xoPercentage=10,$scope.ui.isLoading=!1)})})})}]),ctrls.controller("AdminJobEditCtrl",["$scope","JobService","ManagerService","CompaniesService","TestsService","$cacheFactory","$uibModal","Flash","$routeParams","$upload","baseUrl","$timeout","RecruitersService","AccountManagerService","$location","$q","CurrentUser","fileReader","routePrefix","EnumsService",function($scope,JobService,ManagerService,CompaniesService,TestsService,$cacheFactory,$uibModal,Flash,$routeParams,$upload,baseUrl,$timeout,RecruitersService,AccountManagerService,$location,$q,CurrentUser,fileReader,routePrefix,EnumsService){function resetUi(){$scope.ui={isLoading:!1,companyListIsLoading:!1,isDone:!1,kwTest:!1,rrTest:!1,orTest:!1}}function handleError(err){"CROS-0051"===err.data.errorCode&&err.data.text.indexOf("uk_jobs_title")>=0&&(err.data.text="Job with title "+$scope.data.job.title+" already exists."),$scope.ui.isLoading=!1,showMessage("alert-danger",err.data.text),resetUi()}function stopLoading(){$scope.ui.isLoading=!1}function updateVisibleManagersCheckedStatus(){var m=$scope.data.managers,i=m.length,counter=0;if($scope.ui.visibleManagersCheckedStatus="none",i>0){for(;i--;)m[i].checked&&counter++;counter===m.length?$scope.ui.visibleManagersCheckedStatus="all":counter>0&&($scope.ui.visibleManagersCheckedStatus=counter)}}function loadManagers(company){var mgrs=$scope.data.managers.filter(function(m){return angular.isDefined(m.company)&&m.company.id===company.id});mgrs.length>0||($scope.ui.isManagersLoading=!0,ManagerService.get({companyId:company.id},function(res){angular.isArray(res)&&(parseChecked(res,$scope.data.job.visibleManagers),$scope.data.managers=$scope.data.managers.concat(res))}).$promise["finally"](function(){$scope.ui.isManagersLoading=!1,updateVisibleManagersCheckedStatus()}))}function loadJobRelatedData(){$scope.ui.companyListIsLoading=!0,CompaniesService.query({avatarType:$scope.avatarType}).$promise.then(function(res){$scope.data.companies=res.content;for(var promises=[],i=1;i<res.totalPages;i++)promises.push(CompaniesService.query({page:i,avatarType:$scope.avatarType}).$promise);$q.all(promises).then(function(r){angular.forEach(r,function(result){$scope.data.companies=$scope.data.companies.concat(result.content)}),$scope.data.job&&parseChecked($scope.data.managers,$scope.data.job.visibleManagers),$scope.ui.companyListIsLoading=!1})}),$scope.ui.isLoading=!0;var promises=[RecruitersService.query().$promise,JobService.crud.query().$promise,TestsService.getRR({type:"PRE_DEFINED"}).$promise,JobService.crud.labels().$promise];$routeParams.id&&angular.isDefined($routeParams.id)&&promises.push(JobService.crud.get({id:$routeParams.id}).$promise),$q.all(promises).then(function(data){$scope.data.recruiters=data[0];var jobs=data[1];if($scope.data.testStrategies=[],angular.forEach(jobs,function(job){job.tests&&job.tests.length>0&&$scope.data.testStrategies.push(job)}),$scope.data.rrTests=data[2],$scope.data.jobLabels=data[3],data[4]){var job=data[4];job.visibleCompanies=job.visibleCompanies||[],job.visibleManagers=job.visibleManagers||[],job.oldStatus=job.status,_.uniq(job.visibleManagers,function(m){return m.company.id}).forEach(function(m){loadManagers(m.company)}),setTests(job),$scope.data.flowType=isCustom(job)?"CUSTOM":"GENERIC",$scope.data.job=job,$scope.ui.companyListIsLoading||parseChecked($scope.data.managers,job.visibleManagers),angular.forEach(job.visibleCompanies,function(comp){loadManagers(comp)}),job.jobSla&&($scope.data.selectedSla=job.jobSla.sla)}else $scope.data.job={visibleCompanies:[],visibleManagers:[],applicationType:"NATIVE",workingHoursPerWeek:40},setTests($scope.data.job)})["catch"](handleError)["finally"](stopLoading)}function isCustom(job){return!_.isEmpty(job.visibleManagers)}function setTests(job){var getTest=function(type){return _.find(job.tests,function(t){return t.test.type===type})};$scope.data.selectedEnglishTest=getTest("SPOKEN_ENGLISH"),$scope.data.selectedFiveqTest=getTest("FIVEQ"),$scope.data.selectedHackerRankTest=getTest("HACKER_RANK"),$scope.data.selectedAssignment=getTest("ASSIGNMENT"),$scope.data.selectedRKT=getTest("RESUME_KEYWORD"),$scope.data.selectedRR=getTest("RESUME_RUBRIC"),$scope.data.selectedOR=getTest("OTHER"),$scope.data.selectedMAT=getTest("MANDATORY_ATTRIBUTES"),0===_.filter($scope.data.rrTests,function(t){return 0===t.id}).length&&$scope.data.rrTests.push({name:"Custom",id:0,type:"PRE_DEFINED"}),$scope.data.selectedRR||($scope.data.selectedRR={},$scope.data.selectedRR.test={resumeRubrics:[{}]},$scope.data.selectedRR.test.status="ACTIVE",$scope.data.selectedRR.test.type="RESUME_RUBRIC",$scope.data.selectedRR.test.name="Resume Rubric-"+Date.now(),$scope.data.selectedRR.test.description="",$scope.data.selectedRR["new"]=!0);var rrt=$scope.data.selectedRR.test;if(void 0!==rrt.resumeRubrics&&(rrt.resumeRubrics.filter(function(s){return s.weight}),!_.isEmpty(rrt.resumeRubrics[0]))){var customRR=rrt.resumeRubrics.filter(function(s){return"CUSTOM"===s.resumeRubric.type});customRR.length>0&&_.each(rrt.resumeRubrics.filter(function(s){return"CUSTOM"===s.resumeRubric.type}),function(c){c.name=c.resumeRubric.name,c.description=c.resumeRubric.description,c.resumeRubric.name="Custom",void 0!==c.resumeRubric.id?(c.resumeRubric.cid=c.resumeRubric.id,c.resumeRubric.id=0):c.resumeRubric.id=0})}}function parseChecked(arr,checkedArr){angular.forEach(checkedArr,function(checkedObj){angular.forEach(arr,function(obj){if(checkedObj.id===obj.id&&(obj.checked=!0,checkedObj.company)){var company=[checkedObj.company];parseChecked($scope.data.companies,company)}})})}function showMessage(clazz,msg){$scope.scrollToTop(),$scope.msg={clazz:clazz,show:!0,message:msg}}function hideMessage(){$location.search("result",null),$timeout(function(){$scope.msg.show=!1},9e3)}function alertSuccess(){showMessage("alert-success","Job is saved."),hideMessage(),resetUi(),void 0===$scope.data.job.visibleManagers&&($scope.data.job.visibleManagers=[]),"/job/create"===$location.path()&&$location.path("/job/"+$scope.data.job.id+"/edit").search({result:"success"}),$scope.ui.isLoading=!1}function uploadImage(jobId){return $scope.fileForUpload?void $upload.upload({url:baseUrl+"/jobs/"+jobId+"/image",fileFormDataName:"image",file:$scope.fileForUpload}).success(function(data){$scope.data.job=data,$scope.fileForUpload=null,alertSuccess()}).error(function(response){handleError(response)}):void alertSuccess()}$scope.data={job:null,managers:[],englishTests:TestsService.list({type:"SPOKEN_ENGLISH",status:"ACTIVE"}),hrTests:TestsService.list({type:"HACKER_RANK",status:"ACTIVE"}),asgnTests:TestsService.list({type:"ASSIGNMENT",status:"ACTIVE"}),fiveqTests:TestsService.list({type:"FIVEQ",status:"ACTIVE"}),amEndorsementTests:TestsService.list({type:"AM_ENDORSEMENT",status:"ACTIVE"}),slas:JobService.crud.getSlas(),enums:EnumsService.get(),jobLabels:null},$scope.ui={isLoading:!1,isDone:!1,kwTest:!1,rrTest:!1,orTest:!1,maTest:!1,mDropdown:!1,editorMenu:[["bold","italic","underline","strikethrough","subscript","superscript"],["format-block"],["font-size"],["font-color","hilite-color"],["remove-format"],["ordered-list","unordered-list","outdent","indent"],["left-justify","center-justify","right-justify"],["code","quote","paragraph"],["link","image"]]},$scope.msg={clazz:"",show:!1,message:""},$scope.getJobTitleError=function(minMaxError){return minMaxError?"Job title must be over 10 and must not exceed 160 characters":""},$scope.$watch("[ui.kwTest, ui.rrTest, ui.orTest, ui.maTest]",function(){$scope.ui.kwTest&&$scope.ui.rrTest&&$scope.ui.orTest&&$scope.ui.maTest&&($scope.ui.isDone=!0)},!0),$scope.$watch("ui.isDone",function(){$scope.ui.isDone&&$scope.submitJob()}),CurrentUser.get(function(data){if(data.avatarTypes.indexOf("ADMIN")!==-1)$scope.avatarType="ADMIN";else if(data.avatarTypes.indexOf("ACCOUNT_MANAGER")!==-1)$scope.avatarType="ACCOUNT_MANAGER";else{if(data.avatarTypes.indexOf("RECRUITER")===-1)return void $location.path("/home");$scope.avatarType="RECRUITER"}loadJobRelatedData(),AccountManagerService.query().$promise.then(function(accountManagers){$scope.data.accountManagers=accountManagers}),"success"===$location.search().result&&(showMessage("alert-success","Job is saved."),hideMessage())}),$scope.changeFindable=function(){$scope.data.job.findable="GENERIC"===$scope.data.flowType,$scope.data.selectedTestPlanJob=null,"GENERIC"===$scope.data.flowType&&($scope.data.job.visibleCompanies=[],$scope.data.job.visibleManagers=[])},$scope.toggleVisibleCompany=function(company){function filterPredicate(m){return m.company.id!==company.id}if(angular.isArray($scope.data.job.visibleCompanies)){var idx=-1;_.each($scope.data.job.visibleCompanies,function(c,index){if(company.id===c.id)return void(idx=index)}),idx>-1?(company.checked=!1,$scope.data.job.visibleCompanies.splice(idx,1),$scope.data.managers=$scope.data.managers.filter(filterPredicate),$scope.data.job.visibleManagers=$scope.data.job.visibleManagers.filter(filterPredicate)):(company.checked=!0,$scope.data.job.visibleCompanies.push(company),loadManagers(company),$scope.ui.mDropdown=!0),updateVisibleManagersCheckedStatus()}},$scope.toggleVisibleManager=function(manager){var idx=-1;_.each($scope.data.job.visibleManagers,function(m,index){if(manager.id===m.id)return void(idx=index)}),idx>-1?(manager.checked=!1,$scope.data.job.visibleManagers.splice(idx,1)):(manager.checked=!0,$scope.data.job.visibleManagers.push(manager)),updateVisibleManagersCheckedStatus()},$scope.onchange=function(){$scope.ui.isLoading=!0;var job=$scope.data.job;JobService.crud.update({id:job.id},job).$promise.then(function(data){$scope.data.job=data,showMessage("alert-success","Change is saved."),hideMessage()})["catch"](handleError)["finally"](stopLoading)},$scope.isCompanyVisible=function(company){for(var companies=$scope.data.job.visibleCompanies||[],i=0;i<companies.length;i++)if(angular.isObject(companies[i])&&angular.isObject(company)&&companies[i].id===company.id)return!0;return!1},$scope.mandatoryAttributes=function(){$scope.modal=$uibModal.open({templateUrl:"mandatory-attributes.tpl.html",windowClass:"admin-job-edit mandatory-attributes hollow-buttons",size:"lg",backdrop:"static",resolve:{mat:function(){return $scope.data.selectedMAT},degreeTypes:function(){return $scope.data.enums.degreeTypes},schoolRubrics:function(){return _.filter($scope.data.rrTests,function(rr){return"Top Engineering Schools"===rr.name||"Top B-Schools"===rr.name;
})}},controller:function($scope,CountriesService,$uibModalInstance,mat,degreeTypes,schoolRubrics){mat||(mat={test:{skills:["","",""],type:"MANDATORY_ATTRIBUTES",countries:[],educations:[]},weight:0}),$scope.modal=$uibModalInstance,$scope.degreeTypes=degreeTypes,$scope.schoolRubrics=schoolRubrics,$scope.mat=mat,$scope.selectedCountries=mat.test.countries,$scope.selectedDegreeTypes=_.uniq(_.filter(_.pluck(mat.test.educations,"degreeType"),function(v){return void 0!==v})),$scope.selectedSchoolRubrics=_.filter(_.pluck(mat.test.educations,"resumeRubric"),function(v){return void 0!==v}),CountriesService.query(function(res){$scope.countries=res}),$scope.countryFilter=function(country){return!!_.isEmpty($scope.filterText)||country.name.toLowerCase().indexOf($scope.filterText.toLowerCase())!==-1},$scope.toggleSelection=function(value,arr){var id=$scope.checkValueSelected(value,arr);return id>-1?arr.splice(id,1):arr.push(value)},$scope.checkValueSelected=function(value,arr){var id=-1;return _.each(arr,function(v,i){(void 0!==value.id&&void 0!==v&&v.id===value.id||v===value)&&(id=i)}),id},$scope.submit=function(){$scope.mat.test.countries=$scope.selectedCountries,$scope.mat.test.skills=_.filter($scope.mat.test.skills,function(s){return!_.isEmpty(s)});var educations=[];_.isEmpty($scope.selectedDegreeTypes)||_.isEmpty($scope.selectedSchoolRubrics)?educations=_.isEmpty($scope.selectedDegreeTypes)?_.map($scope.selectedSchoolRubrics,function(sr){return{resumeRubric:sr}}):_.map($scope.selectedDegreeTypes,function(dt){return{degreeType:dt}}):$scope.selectedDegreeTypes.forEach(function(dt){$scope.selectedSchoolRubrics.forEach(function(sr){educations.push({resumeRubric:sr,degreeType:dt})})}),$scope.mat.test.educations=educations,$uibModalInstance.close($scope.mat)}}}),$scope.modal.result.then(function(res){$scope.data.selectedMAT=res})},$scope.keywordsRubric=function(){var modal=$uibModal.open({templateUrl:"keywords-rubric.tpl.html",windowClass:"admin-job-edit hollow-buttons",backdrop:"static",resolve:{rrTests:function(){return $scope.data.rrTests},rkTest:function(){return $scope.data.selectedRKT}},controller:function($scope,rrTests,rkTest,$uibModalInstance){$scope.modal=$uibModalInstance,rkTest?$scope.rkTest=angular.copy(rkTest):$scope.rkTest={weight:0,test:{type:"RESUME_KEYWORD",status:"ACTIVE",lowThreshold:1,weightedKeywords:[{},{},{},{},{},{}],experienceRubricWeight:2}},$scope.rkTest.test.bizSchoolRubric||($scope.rkTest.test.bizSchoolRubric={resumeRubric:_.find(rrTests,function(t){return"Top B-Schools"===t.name}),weight:2}),$scope.rkTest.test.techSchoolRubric||($scope.rkTest.test.techSchoolRubric={resumeRubric:_.find(rrTests,function(t){return"Top Engineering Schools"===t.name}),weight:2}),$scope.submit=function(){$scope.err="";var t=$scope.rkTest.test,total=0;void 0===t.bizSchoolRubric.weight&&(t.bizSchoolRubric.weight=0),void 0===t.techSchoolRubric.weight&&(t.techSchoolRubric.weight=0),void 0===t.experienceRubricWeight&&(t.experienceRubricWeight=0),total+=t.bizSchoolRubric.weight,total+=t.techSchoolRubric.weight,total+=t.experienceRubricWeight;var weights=_.pluck(t.weightedKeywords,"weight");return total+=_.reduce(weights,function(memo,num){return void 0!==num?memo+num:memo},0),0===total&&(t.highThreshold=0),!_.isNumber(t.highThreshold)||t.highThreshold>total?void($scope.err="Incorrect threshold specified!"):void $uibModalInstance.close($scope.rkTest)}}});modal.result.then(function(rkt){$scope.data.selectedRKT=rkt})},$scope.resumeRubric=function(){$scope.modal=$uibModal.open({templateUrl:"resume-rubric.tpl.html",windowClass:"admin-job-edit hollow-buttons",backdrop:"static",resolve:{rr:function(){return $scope.data.selectedRR},rrTests:function(){return $scope.data.rrTests}},controller:function($scope,rr,rrTests,$uibModalInstance){$scope.modal=$uibModalInstance,$scope.rr=angular.copy(rr),$scope.rrTests=rrTests,$scope.submit=function(){$scope.err="";var incorrect=_.filter($scope.rr.test.resumeRubrics,function(w){return void 0===w.weight||""===w.weight||void 0===w.resumeRubric});return incorrect.length>0?void($scope.err='Please select criteria and fill "Weight" field.'):void $uibModalInstance.close($scope.rr)}}}),$scope.modal.result.then(function(rr){$scope.data.selectedRR=rr})},$scope.fiveqRubric=function(){var modal=$uibModal.open({templateUrl:"fiveq-rubric.tpl.html",windowClass:"admin-job-edit hollow-buttons",backdrop:"static",resolve:{fiveqTest:function(){return $scope.data.selectedFiveqTest}},controller:function($scope,fiveqTest,$sce,$uibModalInstance){$scope.modal=$uibModalInstance,$scope.test=angular.copy(fiveqTest.test),$scope.sce=$sce}});modal.result.then(function(test){TestsService.update5QTest({id:test.id},test,function(res){$scope.data.selectedFiveqTest={test:res}})})},$scope.otherRubric=function(){var modal=$uibModal.open({templateUrl:"other-rubric.tpl.html",backdrop:"static",windowClass:"hollow-buttons",size:"lg",resolve:{otherTest:function(){return $scope.data.selectedOR}},controller:function($scope,$uibModalInstance,otherTest){otherTest||(otherTest={test:{groups:[],type:"OTHER"},weight:0}),$scope.otherTest=otherTest,$scope.modal=$uibModalInstance,$scope.isTestValid=function(){return $scope.otherTest.test.groups.length>0}}});modal.result.then(function(res){$scope.data.selectedOR=res})},$scope.fiveqModal=function(existingTest){existingTest?$scope.editTest=angular.copy(existingTest):$scope.editTest={type:"FIVEQ",status:"ACTIVE",questions:[{sequenceNumber:1}]},$scope.modal=$uibModal.open({templateUrl:"fiveq-setup.tpl.html",scope:$scope,backdrop:"static",size:"lg"}),$scope.modal.result.then(function(){var test=$scope.editTest;test.id?TestsService.update5QTest({id:test.id},test,function(res){var tests=$scope.data.fiveqTests.filter(function(t){return t.id!==test.id});tests.push(res),$scope.data.fiveqTests=tests,$scope.data.selectedFiveqTest={test:res}}):TestsService.add5QTest(test,function(res){$scope.data.fiveqTests.push(res),$scope.data.selectedFiveqTest={test:res}})})},$scope.hrtestModal=function(){$scope.data.hrtestid=void 0,$scope.modal=$uibModal.open({templateUrl:"hrtest-setup.tpl.html",scope:$scope,backdrop:"static",size:"lg"}),$scope.modal.result.then(function(){var res=TestsService.createHRTestOnTT({id:$scope.data.hrtestid},{});res.$promise.then(function(d){d&&($scope.data.hrTests=TestsService.list({type:"HACKER_RANK",status:"ACTIVE"}))})["catch"](handleError)})},$scope.submit=function(job,confirmed){if($scope.ui.validationErr="","CUSTOM"===$scope.data.flowType&&!isCustom(job))return void showMessage("alert-danger","Please select at least one manager for the custom job");if(void 0!==job.id&&void 0!==job.oldStatus&&"CLOSED"!==job.oldStatus&&"CLOSED"===job.status&&!confirmed){var tplUrl="account-manager/reject-all-modal.tpl.html",modalInstance=$uibModal.open({templateUrl:routePrefix?routePrefix+tplUrl:tplUrl,backdrop:"static",controller:function($scope,$uibModalInstance){$scope.modal=$uibModalInstance}});return void modalInstance.result.then(function(){$scope.submit(job,!0)})}if(job.tests=[],$scope.data.job.flowType&&$scope.data.job.flowType.indexOf("FIVEQ")>=0&&(job.tests.push($scope.data.selectedFiveqTest),job.tests.push({test:$scope.data.amEndorsementTests[0],weight:0}),$scope.data.selectedSla?job.jobSla?job.jobSla.sla=$scope.data.selectedSla:job.jobSla={sla:$scope.data.selectedSla}:job.jobSla=void 0),$scope.data.job.flowType&&$scope.data.job.flowType.indexOf("HACKERRANK")>=0&&job.tests.push($scope.data.selectedHackerRankTest),$scope.data.job.flowType&&$scope.data.job.flowType.indexOf("ASSIGNMENT")>=0&&job.tests.push($scope.data.selectedAssignment),job.tests=_.filter(job.tests,function(t){return _.isObject(t)}),job.visibleManagers=job.visibleManagers.map(function(c){return{id:c.id,type:c.type,company:{id:c.company.id}}}),$scope.ui.isLoading=!0,$scope.data.selectedRKT){var rkt=$scope.data.selectedRKT.test;rkt.weightedKeywords=_.filter(rkt.weightedKeywords,function(pair){return pair.keyword&&pair.keyword.length>0&&pair.weight}),void 0===rkt.id?TestsService.addResumeKeywordTest(rkt).$promise.then(function(res){$scope.data.selectedRKT.test=res,job.tests.push($scope.data.selectedRKT),$scope.ui.kwTest=!0})["catch"](handleError):TestsService.updateResumeKeywordTest({id:rkt.id},rkt).$promise.then(function(res){$scope.data.selectedRKT.test=res,job.tests.push($scope.data.selectedRKT),$scope.ui.kwTest=!0})["catch"](handleError)}else $scope.ui.kwTest=!0;var rrt=$scope.data.selectedRR.test;if(rrt.resumeRubrics.filter(function(s){return s.weight}),_.isEmpty(rrt.resumeRubrics[0]))$scope.ui.rrTest=!0;else{var customRR=rrt.resumeRubrics.filter(function(s){return 0===s.resumeRubric.id});customRR.length>0&&_.each(customRR,function(c){var rr={name:c.name,description:c.description,type:"CUSTOM"};void 0!==c.resumeRubric.cid&&(rr.id=c.resumeRubric.cid),c.resumeRubric=rr,delete c.name,delete c.description}),$scope.data.selectedRR["new"]?TestsService.addRR(rrt).$promise.then(function(res){$scope.data.selectedRR.test=res,job.tests.push($scope.data.selectedRR),$scope.ui.rrTest=!0})["catch"](handleError):TestsService.updateRR({id:rrt.id},rrt).$promise.then(function(res){$scope.data.selectedRR.test=res,job.tests.push($scope.data.selectedRR),$scope.ui.rrTest=!0})["catch"](handleError)}if($scope.data.selectedOR&&$scope.data.selectedOR.test){var ot=$scope.data.selectedOR.test;void 0===ot.id?TestsService.addOtherTest(ot).$promise.then(function(res){$scope.data.selectedOR.test=res,job.tests.push($scope.data.selectedOR),$scope.ui.orTest=!0})["catch"](handleError):TestsService.updateOtherTest({id:ot.id},ot).$promise.then(function(res){$scope.data.selectedOR.test=res,job.tests.push($scope.data.selectedOR),$scope.ui.orTest=!0})["catch"](handleError)}else $scope.ui.orTest=!0;if($scope.data.selectedMAT&&$scope.data.selectedMAT.test){var mat=$scope.data.selectedMAT.test;void 0===mat.id?TestsService.addMandatoryAttrsTest(mat).$promise.then(function(res){$scope.data.selectedMAT.test=res,job.tests.push($scope.data.selectedMAT),$scope.ui.maTest=!0})["catch"](handleError):TestsService.updateMandatoryAttrsTest({id:mat.id},mat).$promise.then(function(res){$scope.data.selectedMAT.test=res,job.tests.push($scope.data.selectedMAT),$scope.ui.maTest=!0})["catch"](handleError)}else $scope.ui.maTest=!0},$scope.submitJob=function(){var success=function(data){$scope.data.job=data,setTests(data),uploadImage($scope.data.job.id)},done=function(){$scope.data.success=!0};$scope.ui.isLoading=!0;var promise=null;$cacheFactory.get("$http").remove(baseUrl+"/public/jobs"),promise="/job/create"===$location.path()?JobService.crud.save($scope.data.job).$promise:JobService.crud.update({id:$scope.data.job.id},$scope.data.job).$promise,promise.then(success)["catch"](handleError)["finally"](done)},$scope.changeFile=function($files){$files&&$files.length&&fileReader.readAsDataUrl($files[0],$scope).then(function(result){$scope.jobImage=result,$scope.fileForUpload=$files})}}]),ctrls.controller("AdminJobsListCtrl",["$scope","JobService","CurrentUser","$location","QueryParams",function($scope,JobService,CurrentUser,$location,QueryParams){function refreshPagination(){$scope.ui.pagination={size:10,currentPage:1,totalPages:Math.ceil($scope.data.filteredJobs.length/$scope.ui.pagination.size),totalElements:$scope.data.filteredJobs.length}}$scope.data={jobs:[],filterText:null,filteredJobs:[]},$scope.ui={isLoading:!0,pagination:{size:10,totalPages:0,totalElements:0}},$scope.msg={clazz:"",show:!1,message:""},CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&data.avatarTypes.indexOf("ACCOUNT_MANAGER")===-1&&data.avatarTypes.indexOf("RECRUITER")===-1&&$location.path("/home"),$scope.user=data}),$scope.doFilter=function(){if($scope.data.filterText){var txt=$scope.data.filterText.toLowerCase();$scope.data.filteredJobs=$scope.data.jobs.filter(function(x){return String(x.id).indexOf(txt)>=0||x.title.toLowerCase().indexOf(txt)>=0})}else $scope.data.filteredJobs=$scope.data.jobs;refreshPagination(),$scope.changePage()},$scope.changePage=function(){QueryParams.write({page:$scope.ui.pagination.currentPage})},JobService.crud.query(function(data){$scope.data.jobs=data||[],$scope.data.filteredJobs=$scope.data.jobs,refreshPagination(),$scope.ui.isLoading=!1,$scope.ui.pagination.currentPage=QueryParams.readValue("page",1)})}]),ctrls.controller("AdminOnboardCtrl",["$scope","CountriesService","JobService","TeamService","ManagerService","SelectionService","TimezonesService","EnumsService","CurrentUser","$location","$q","$uibModal",function($scope,CountriesService,JobService,TeamService,ManagerService,SelectionService,TimezonesService,EnumsService,CurrentUser,$location,$q,$uibModal){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function openWarningModal(text){var modal=$uibModal.open({templateUrl:"onboarding-warning.tpl.html",backdrop:"static",resolve:{text:function(){return text}},controller:function($scope,text,$uibModalInstance){$scope.text=text,$scope.modal=$uibModalInstance}});modal.result.then(function(){$scope.data.overrideWarnings=!0,$scope.submit($scope.data.onboard)})}CurrentUser.get(function(data){$scope.currentUser=data,$q.all([CountriesService.query().$promise,TimezonesService.query().$promise,TeamService.shallowlist({avatarType:"ADMIN"}).$promise,ManagerService.query().$promise,EnumsService.get().$promise,JobService.crud.query().$promise]).then(function(r){$scope.ui.isLoading=!1,$scope.data.countries=r[0],$scope.data.timezones=r[1],$scope.data.teams=r[2],$scope.data.managers=r[3],$scope.data.enums=r[4],function(jobs){var d=jobs.map(function(j){return j.start=j.title[0].toUpperCase().replace(/[^A-Z]/gi,"_"),j.title=j.title.trim(),j});d=_.sortBy(d,"title"),d=[{id:"new",title:"Create new job",letter:"______"}].concat(d),$scope.data.jobs=d}(r[5])})}),$scope.data={onboard:{paymentPlatform:"PAYONEER",trackerRequired:!0},overrideWarnings:!1},$scope.ui={title:"Onboard User",startDatePicker:!1,endDatePicker:!1,isLoading:!0},$scope.msg={clazz:"",show:!1,message:""},$scope.openDatePicker=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.ui.startDatePicker=!0},$scope.changeCountry=function(){var c=$scope.data.countries.filter(function(x){return x.id===$scope.data.onboard.countryId})[0];if($scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.onboard.timeZoneId=c.timezones[0].id;else if($scope.data.onboard.timeZoneId){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.onboard.timeZoneId},!1);isIncluded||($scope.data.onboard.timeZoneId=null)}},$scope.updateTeams=function(){$scope.teams=$scope.data.teams.filter(function(e){return angular.isDefined(e.company)&&e.company.id===$scope.data.onboard.manager.company.id})},$scope.salaryTypeChanged=function(){$scope.data.onboard.weeklySalary=null,$scope.data.onboard.weeklyLimit=null,$scope.data.onboard.salary=null,"MONTHLY"===$scope.data.onboard.salaryType&&($scope.data.onboard.salaryUnit="MONTH")},$scope.platformTypeChanged=function(){$scope.data.onboard.weeklySalary=null,$scope.data.onboard.salary=null,$scope.data.onboard.trackerRequired=!0},$scope.jobChanged=function(jobId){jobId=Number(jobId);for(var i=0;i<$scope.data.jobs.length;i++)if($scope.data.jobs[i].id===jobId){var job=$scope.data.jobs[i];$scope.data.onboard.salaryType=job.salaryType,$scope.data.onboard.salaryUnit=job.salaryUnit,$scope.data.onboard.trackerRequired=job.trackerRequired}},$scope.submit=function(data){var d=angular.copy(data);if($scope.ui.isLoading=!0,"new"===d.jobId?(delete d.jobId,d.salaryType=$scope.data.onboard.salaryType,d.salaryUnit=$scope.data.onboard.salaryUnit,d.trackerRequired=$scope.data.onboard.trackerRequired):d.jobId=parseInt(d.jobId,10),angular.isObject(d.managerId)&&(d.managerId=d.managerId.id),angular.isObject(d.manager)&&(d.managerId=d.manager.id,delete d.manager),angular.isObject(d.team)){var t={id:d.team.id};d.team=t}var params={};$scope.data.overrideWarnings&&(params.overrideWarnings=!0),SelectionService.directAssignment(params,d).$promise.then(function(){$scope.data.onboard={note:""},showMessage("alert-success","Onboard invitation successfully sent.")})["catch"](function(err){err&&err.data&&("CROS-0085"===err.data.errorCode||"CROS-0086"===err.data.errorCode||"CROS-0087"===err.data.errorCode?openWarningModal(err.data.text):showMessage("alert-danger",err.data.text))})["finally"](function(){$scope.ui.isLoading=!1,$scope.data.overrideWarnings=!1})}}]),ctrls.controller("AdminTrainingCtrl",["$scope","TrainingService","$uibModal","CurrentUser","$location",function($scope,TrainingService,$uibModal,CurrentUser,$location){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function openModal(){$uibModal.open({templateUrl:"training-edit.tpl.html",controller:"AdminTrainingModalCtrl",backdrop:"static",resolve:{training:function(){return $scope.data.training},trainings:function(){return $scope.trainings},editing:function(){return $scope.editing}}})}$scope.training={videoUrl:"",title:"",description:"",featured:!1},CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home")}),TrainingService.query(function(data){$scope.trainings=data},function(err){showMessage("alert-danger",err.data.text)}),$scope.save=function(form,training){$scope.editing?TrainingService.update(training,function(){TrainingService.query(function(data){$scope.trainings=data})}):TrainingService.save(training,function(){TrainingService.query(function(data){$scope.trainings=data})})},$scope["delete"]=function(training){for(var i=0;i<$scope.trainings.length;i++)if(angular.equals($scope.trainings[i],training)){$scope.trainings.splice(i,1);break}TrainingService["delete"]({id:training.id})},$scope.addTraining=function(){$scope.editing=!1,$scope.data={training:{}},openModal()},$scope.editTraining=function(t){$scope.editing=!0,$scope.data={training:angular.copy(t)},openModal()}}]),ctrls.controller("AdminTrainingModalCtrl",["$scope","$uibModalInstance","training","trainings","editing","TrainingService","UtilsService",function($scope,$uibModalInstance,training,trainings,editing,TrainingService,UtilsService){$scope.data={training:training},$scope.save=function(form,val){if(!UtilsService.isValidVimeoUrl(val.videoUrl))return void($scope.invalidId=!0);if(val.title&&0!==val.length)if($scope.invalidId=!1,editing){for(var i=0;i<trainings.length;i++)if(trainings[i].id===val.id){trainings.splice(i,1);break}TrainingService.update(val,function(res){trainings.push(res),$uibModalInstance.close()})}else TrainingService.save(val,function(res){trainings.push(res),$uibModalInstance.close()})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("AdminUserEditCtrl",["$scope","$routeParams","AdminUsersService","AdminApplicationService","JobApplicationService","Flash","MarketplaceMembersService","CurrentUser","$location","$window","$rootScope","$q",function($scope,$routeParams,AdminUsersService,AdminApplicationService,JobApplicationService,Flash,MarketplaceMembersService,CurrentUser,$location,$window,$rootScope,$q){function check(str){return angular.isDefined(str)&&str.length>0}function getAvatarId(userAvatars,type){var avatar=_.find(userAvatars,function(a){return a.type===type});return avatar?avatar.id:null}function isAvatarEnabled(user,avatar){var isAvatarEnabled=!1;return angular.forEach(user.avatarTypes,function(a){a&&a===avatar&&(isAvatarEnabled=!0)}),isAvatarEnabled}function initUserAvatars(user){user.userAvatar={},user.userAvatar.candidate=isAvatarEnabled(user,"CANDIDATE"),user.userAvatar.manager=isAvatarEnabled(user,"MANAGER"),user.userAvatar.companyAdmin=isAvatarEnabled(user,"COMPANY_ADMIN"),user.userAvatar.admin=isAvatarEnabled(user,"ADMIN"),user.userAvatar.systemUser=isAvatarEnabled(user,"SYSTEM_USER"),user.userAvatar.recruiter=isAvatarEnabled(user,"RECRUITER"),user.userAvatar.accountManager=isAvatarEnabled(user,"ACCOUNT_MANAGER"),user.userAvatar.recruitmentAnalyst=isAvatarEnabled(user,"RECRUITMENT_ANALYST"),user.userAvatar.enforcer=isAvatarEnabled(user,"ENFORCER"),user.userAvatar.jobBoardPoster=isAvatarEnabled(user,"JOB_BOARD_POSTER"),user.userAvatar.outboundRecruiter=isAvatarEnabled(user,"OUTBOUND_RECRUITER")}function getAvatarsSelected(user){var avatars="";return user.userAvatar.candidate&&(avatars+="CANDIDATE,"),user.userAvatar.manager&&(avatars+="MANAGER,"),user.userAvatar.companyAdmin&&(avatars+="COMPANY_ADMIN,"),user.userAvatar.admin&&(avatars+="ADMIN,"),user.userAvatar.systemUser&&(avatars+="SYSTEM_USER,"),user.userAvatar.recruiter&&(avatars+="RECRUITER,"),user.userAvatar.accountManager&&(avatars+="ACCOUNT_MANAGER,"),user.userAvatar.recruitmentAnalyst&&(avatars+="RECRUITMENT_ANALYST,"),user.userAvatar.enforcer&&(avatars+="ENFORCER,"),user.userAvatar.jobBoardPoster&&(avatars+="JOB_BOARD_POSTER,"),user.userAvatar.outboundRecruiter&&(avatars+="OUTBOUND_RECRUITER,"),avatars&&avatars.length>1&&(avatars=avatars.substring(0,avatars.length-1)),avatars}$scope.UI={isLoading:!0,left:3,right:9,title:"Edit user"},$scope.PASSWORD_REGEXP=/^(?=.*[^a-zA-Z])(?=.*[a-zA-Z]).{8,64}$/,$scope.data={user:{userSecurity:{}}},CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home")}),$scope.mmArray=[],$scope.invalidScore=function(score){return null===score||angular.isUndefined(score)||0===score},$scope.reject=function(id,action){var application={id:id,action:action};$scope.UI.isLoading=!0,AdminApplicationService.edit(application,function(){Flash.addSuccess("Application updated!","/admin/users")},function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})},$scope.reapply=function(oldApplicationId){$scope.UI.isLoading=!0,JobApplicationService.reapply({oldApplicationId:oldApplicationId}).$promise.then(function(){Flash.addSuccess("Application updated!","/admin/users")})["catch"](function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})},$scope.save=function(){var promises=[],user=angular.copy($scope.data.user),params={id:user.id,avatars:getAvatarsSelected(user)};promises.push(AdminUsersService.updateAvatars(params).$promise);var isEmailChanged=!1,isPasswordChanged=!1;if(!$scope.data.tracker||!$scope.data.tracker.adAuthentication){var pass=user.userSecurity.rawPassword;if(check(pass)){if(!$scope.PASSWORD_REGEXP.test(pass))return void($scope.UI.error="Password must be at least 8 characters and at most 64 characters, 1 letter and a number or symbol is required.");isPasswordChanged=!0}isEmailChanged=user.email!==$scope.user.user.email}(isEmailChanged||isPasswordChanged)&&(isPasswordChanged||delete user.userSecurity,promises.push(AdminUsersService.edit(user).$promise)),$scope.mmArray.forEach(function(mm){$scope.UI.isLoading=!0,$scope.mmStatus&&"INACTIVE"===mm.status&&promises.push(MarketplaceMembersService.enable({id:mm.id}).$promise),$scope.mmStatus||"AVAILABLE"!==mm.status||promises.push(MarketplaceMembersService.disable({id:mm.id}).$promise)}),$scope.UI.isLoading=!0,$q.all(promises).then(function(){Flash.addSuccess("User details changed!","/admin/users")})["catch"](function(e){$scope.UI.error=e.data.text,start()})["finally"](function(){$scope.UI.isLoading=!1})},$scope.impersonate=function(id){$rootScope.runAsId=id,$location.path("/home")},$scope.goBack=function(){$window.history.back()};var start=function(){var userAvatarId=null;$scope.UI.isLoading=!0,AdminUsersService.get({id:$routeParams.id},function(data){$scope.user=data,$scope.data=angular.copy(data),$scope.data.email=void 0,$scope.data.id=data.id,$scope.UI.isLoading=!1,userAvatarId=getAvatarId($scope.user.user.userAvatars,"CANDIDATE"),userAvatarId&&(getApplications(userAvatarId),checkMMStatus(userAvatarId)),initUserAvatars($scope.data.user)},function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})},getApplications=function(userAvatarId){$scope.UI.isLoading=!0,AdminApplicationService.get({candidateId:userAvatarId},function(data){$scope.applications=data.content},function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})},checkMMStatus=function(userAvatarId){$scope.UI.isLoading=!0,MarketplaceMembersService.all({candidateId:userAvatarId},function(data){var marketplaceMembers=data.content||[],mma=[];$scope.mmChecked=!1,marketplaceMembers.forEach(function(mm){"ASSIGNED"!==mm.status&&mma.push({id:mm.id,status:mm.status}),"AVAILABLE"===mm.status&&($scope.mmChecked=!0)}),$scope.disableMMCheckBox=!1,mma.length<=0&&($scope.disableMMCheckBox=!0),$scope.mmArray=angular.copy(mma),$scope.UI.isLoading=!1},function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})};start(),$scope.updateRelatedAvatars=function(actionToggle,user){(actionToggle||user)&&("MANAGER"===actionToggle&&!user.userAvatar.manager&&user.userAvatar.companyAdmin&&(user.userAvatar.companyAdmin=!1),"COMPANY_ADMIN"===actionToggle&&user.userAvatar.companyAdmin&&!user.userAvatar.manager&&(user.userAvatar.manager=!0))}}]),ctrls.controller("AdminUserListCtrl",["$scope","AdminUsersService","$rootScope","$location","JobApplicationService","DownloadService","$window","$q","CurrentUser","$routeParams","$timeout",function($scope,AdminUsersService,$rootScope,$location,JobApplicationService,DownloadService,$window,$q,CurrentUser,$routeParams,$timeout){function getSortDirForBackend(){return $scope.UI.sortDir?"ASC":"DESC"}function getAvatarId(userAvatars,type){var avatar=_.find(userAvatars,function(a){return a.type===type});return avatar?avatar.id:null}function autoFocusOnElement(){$timeout(function(){angular.element(document.querySelector("#user_email_search")).focus()})}$scope.UI={isLoading:!0,title:"Users list",currentPage:1,pagination:{},sortBy:null,sortDir:!1},$scope.impersonate=function(id){$rootScope.runAsId=id,$location.path("/home")},CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")===-1&&$location.path("/home")}),$scope.update=function(){if(angular.isDefined($scope.UI.search)&&""!==$scope.UI.search){var p=1;if($scope.UI.isLoading=!0,angular.isDefined($scope.UI.currentPage)&&angular.isNumber($scope.UI.currentPage)&&(p=$scope.UI.currentPage),p-1===$scope.UI.pagination.number&&angular.isDefined($scope.UI.search)&&angular.isDefined($scope.UI.oldSearch)&&$scope.UI.search===$scope.UI.oldSearch&&$scope.UI.sortBy===$scope.UI.oldSortBy&&$scope.UI.sortDir===$scope.UI.oldSortDir)return void($scope.UI.isLoading=!1);var query={page:p-1};$location.search("page",query.page),angular.isDefined($scope.UI.search)&&(query.email=$scope.UI.search,$location.search("search",query.email)),$scope.UI.sortBy&&(query.orderBy=$scope.UI.sortBy,query.sortDir=getSortDirForBackend(),$location.search("orderBy",query.orderBy),$location.search("sortDir",query.sortDir)),AdminUsersService.get(query,function(d){$scope.data=angular.copy(d.content),delete d.content,angular.forEach($scope.data,function(user){var userAvatarId=getAvatarId(user.userAvatars,"CANDIDATE");userAvatarId&&JobApplicationService.getApplications({avatarType:"ADMIN"},{candidateId:userAvatarId}).$promise.then(function(applications){user.applications=applications.content;var promises=[];if(applications.totalElements>applications.numberOfElements)for(var pagesLeft=Math.ceil(applications.totalElements/applications.numberOfElements)-1,i=1;i<=pagesLeft;i++){var promise=JobApplicationService.getApplications({avatarType:"ADMIN",page:i},{candidateId:userAvatarId}).$promise;promises.push(promise)}$q.all(promises).then(function(res){angular.forEach(res,function(data){user.applications=user.applications.concat(data.content)})})})}),$scope.UI.oldSearch=angular.copy($scope.UI.search),$scope.UI.oldSortBy=angular.copy($scope.UI.sortBy),$scope.UI.oldSortDir=angular.copy($scope.UI.sortDir),$scope.UI.pagination=d,$scope.UI.isLoading=!1},function(e){$window.alert(e.data.text),$scope.UI.isLoading=!1})}else $scope.UI.isLoading=!1},($routeParams.search||$routeParams.page)&&($scope.UI.search=$routeParams.search,$scope.UI.currentPage=parseInt($routeParams.page)+1,$routeParams.orderBy&&($scope.UI.sortBy=$routeParams.orderBy,$scope.UI.sortDir="ASC"===$routeParams.sortDir)),$scope.sort=function(sortBy){$scope.UI.sortBy!==sortBy?($scope.UI.sortBy=sortBy,$scope.UI.sortDir=!1):$scope.UI.sortDir=!$scope.UI.sortDir,$scope.update()},$scope.showFile=function(application,file){JobApplicationService.getFileUrl(application.id,file.id).success(function(url){DownloadService.downloadFile(url)})},$scope.update(),autoFocusOnElement()}]),ctrls.controller("AdminFeaturesCtrl",["$scope","CompaniesService","ManagerService","TeamService","CandidatesService","AssignmentService","AdminAssignmentsService","EnumsService","$q",function($scope,CompaniesService,ManagerService,TeamService,CandidatesService,AssignmentService,AdminAssignmentsService,EnumsService,$q){$scope.data={},$scope.UI={isLoading:!1};var showMessage=function(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg},setTimeout(function(){$scope.msg.show=!1},6e3)};CompaniesService.query().$promise.then(function(res){function isFeatureEnabled(assignment,feature){return assignment.disabledFeatures.indexOf(feature)===-1}function initFeatures(a){a.features={},a.features.screenshots=isFeatureEnabled(a,"SCREENSHOTS"),a.features.webcam=isFeatureEnabled(a,"WEBCAM_PICTURES"),a.features.applicationTracking=isFeatureEnabled(a,"APPLICATION_TRACKING"),a.features.marketplace=isFeatureEnabled(a,"MARKETPLACE"),a.features.activities=isFeatureEnabled(a,"TIME_ACTIVITIES"),a.features.metrics=isFeatureEnabled(a,"TICKETING_INTEGRATION"),a.features.enforcerReview=isFeatureEnabled(a,"ENFORCER_REVIEW")}function setDisabledFeatures(a){a.disabledFeatures=[],a.features.screenshots||a.disabledFeatures.push("SCREENSHOTS"),a.features.webcam||a.disabledFeatures.push("WEBCAM_PICTURES"),a.features.applicationTracking||a.disabledFeatures.push("APPLICATION_TRACKING"),a.features.marketplace||a.disabledFeatures.push("MARKETPLACE"),a.features.activities||a.disabledFeatures.push("TIME_ACTIVITIES"),a.features.metrics||a.disabledFeatures.push("TICKETING_INTEGRATION"),a.features.enforcerReview||a.disabledFeatures.push("ENFORCER_REVIEW")}$scope.data.companies=res.content||[];for(var promises=[],i=1;i<res.totalPages;i++)promises.push(CompaniesService.query({page:i}).$promise);$q.all(promises).then(function(r){angular.forEach(r,function(result){$scope.data.companies=$scope.data.companies.concat(result.content)})}),CandidatesService.get().$promise.then(function(contractors){$scope.data.allContractors=contractors.content||[]}),EnumsService.get(function(e){$scope.data.features=e.features}),$scope.changeCompany=function(company,team){$scope.data.noResults=!1,company&&company.id?TeamService.shallowlist({companyId:company.id,avatarType:"ADMIN"}).$promise.then(function(teams){$scope.data.teams=teams,team&&($scope.data.team=_.find($scope.data.teams,function(t){return t.id===team.id}))}):($scope.data.assignments=null,$scope.data.teams=null)},$scope.changeTeam=function(team){$scope.data.noResults=!1,team&&team.id?AssignmentService.get({status:"ACTIVE",teamId:team.id,limit:1e3,avatarType:"ADMIN"}).$promise.then(function(res){var assignments=res.content||[];$scope.data.assignments=assignments,angular.forEach($scope.data.assignments,initFeatures),$scope.data.unchangedAssignments=angular.copy(assignments),assignments&&0===assignments.length&&($scope.data.noResults=!0)}):$scope.data.assignments=null},$scope.search=function(email){email&&AdminAssignmentsService.get({email:email},function(res){if(res.content&&res.content.length>0){$scope.data.assignments=res.content,angular.forEach($scope.data.assignments,initFeatures),$scope.data.unchangedAssignments=angular.copy(res.content);var team=$scope.data.assignments[0].team;$scope.data.company=_.find($scope.data.companies,function(c){return c.id===team.company.id}),$scope.changeCompany($scope.data.company,team)}else $scope.data.assignments=[],$scope.data.noResults=!0})},$scope.featureChecked=function(feature){return $scope.data.assignment.disabledFeatures.indexOf(feature)===-1},$scope.submit=function(){$scope.UI.isLoading=!0;var promises=[];angular.forEach($scope.data.assignments,function(a){setDisabledFeatures(a),promises.push(AssignmentService.edit({
id:a.id},a).$promise)}),$q.all(promises).then(function(){showMessage("alert-success","Contractors features updated successfully!!")})["catch"](function(error){showMessage("alert-danger",error.data.text),$scope.UI.isLoading=!1})["finally"](function(){$scope.UI.isLoading=!1})},$scope.cancel=function(){$scope.data.assignments=angular.copy($scope.data.unchangedAssignments)}})}]),ctrls.controller("AdminIntegrationsCtrl",["$scope","IntegrationsService",function($scope,IntegrationsService){$scope.data={intgrServices:{}},IntegrationsService.list(function(intgrList){intgrList.forEach(function(intgr){$scope.data.intgrServices[intgr.type]={enabled:intgr.enabled,type:intgr.type,description:intgr.description}})}),$scope.updateIntegration=function(intgrService){IntegrationsService.update({type:intgrService.type,enabled:intgrService.enabled})}}]),ctrls.controller("ApplicationHeaderCtrl",["$scope","GlobalDataFactory",function($scope,GlobalDataFactory){$scope.setDarkHeader(),$scope.steps=[{id:1,stepNumber:"STEP 1",title:"Email Verification",icon:"EMAIL"},{id:2,stepNumber:"STEP 2",title:"Technical Screen",icon:"TECH"},{id:3,stepNumber:"STEP 3",title:"Profile Completion",icon:"PROFILE"},{id:4,stepNumber:"STEP 4",title:"Project Evaluation",icon:"TECH"},{id:5,stepNumber:"STEP 5",title:"Phone Screen",icon:"PHONE"}];var fiveQSteps=$scope.steps.slice(0,1);fiveQSteps.push({id:2,stepNumber:"STEP 2",title:"Contact Information",icon:"PROFILE"}),fiveQSteps.push({id:3,stepNumber:"STEP 3",title:"Written Evaluation",icon:"TECH"}),fiveQSteps.push({id:5,stepNumber:"STEP 4",title:"Phone Screen",icon:"PHONE"});var hackerRankFiveQSteps=$scope.steps.slice(0,2);hackerRankFiveQSteps.push({id:3,stepNumber:"STEP 3",title:"Contact Information",icon:"PROFILE"}),hackerRankFiveQSteps.push({id:4,stepNumber:"STEP 4",title:"Written Evaluation",icon:"TECH"}),hackerRankFiveQSteps.push({id:5,stepNumber:"STEP 5",title:"Phone Screen",icon:"PHONE"});var hackerRankSteps=$scope.steps.slice(0,3);hackerRankSteps.push({id:5,stepNumber:"STEP 4",title:"Phone Screen",icon:"PHONE"}),$scope.$watch(function(){return GlobalDataFactory},function(val){$scope.currentStep=val.getItem("currentStep");var application=val.getItem("application");if(application)switch($scope.job=application.job,$scope.job.flowType){case"FIVEQ":$scope.steps=fiveQSteps;break;case"HACKERRANK_FIVEQ":$scope.steps=hackerRankFiveQSteps;break;case"HACKERRANK":$scope.steps=hackerRankSteps}},!0)}]),ctrls.controller("AudioDataCtrl",["$scope","$routeParams","$document","$window","baseUrl","$rootScope","JobApplicationService","CurrentUser","GlobalDataFactory","$location",function($scope,$routeParams,$document,$window,baseUrl,$rootScope,JobApplicationService,CurrentUser,GlobalDataFactory,$location){$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&!angular.isUndefined($rootScope.getAuthToken())&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),$scope.document=$document;var swfVersionStr="11.1.0",vars={};vars.lstext="Loading...",vars.recorderId="recorder1",vars.userId="user1",vars.licenseKey="63726f73736f7665722e636faurc8be6d3f6c6f63616c686f7374aurc0c2c4bacebac6";var url=baseUrl+"/public/applications/"+$routeParams.applicationId+"/"+$rootScope.getAuthToken()+"/audio";vars.settingsFile=url,$scope.routeParams=$routeParams,$scope.testContent="Describe, in your own words, your responsibilities in your current or last job.",JobApplicationService.test({id:$routeParams.applicationId},function(a){angular.isObject(a)&&angular.isDefined(a.type)&&"SPOKEN_ENGLISH"===a.type&&($scope.testContent=a.displayText)});var params={};params.quality="high",params.bgcolor="#FFFFFF",params.allowscriptaccess="sameDomain",params.allowfullscreen="true";var attributes={};attributes.id="Audior",attributes.name="Audior",attributes.align="middle",CurrentUser.get(function(data){$scope.user=data,JobApplicationService.get({id:$routeParams.applicationId,avatarType:"CANDIDATE"},function(res){$scope.application=res,GlobalDataFactory.setItem("application",$scope.application),GlobalDataFactory.setItem("currentStep",2),$scope.ui.isLoading=!1})});var isMobile=function(){var n=$window.navigator,ua=n.userAgent.toLowerCase();return!(n.appVersion.indexOf("iPad")===-1&&n.appVersion.indexOf("iPhone")===-1&&ua.indexOf("android")===-1&&ua.indexOf("ipod")===-1&&ua.indexOf("windows ce")===-1&&ua.indexOf("windows phone")===-1)};$scope.flash={visible:!1,config:{swfUrl:"/Audior.swf",width:800,height:200,minFlashVersion:swfVersionStr,flashvars:vars,params:params,attributes:attributes}},$scope.document=$document,$scope.toggle=function(){$scope.flash.visible=!$scope.flash.visible};var audio=function(){var audior=$document.find("#Audior");return audior.length>0?($scope.audior=audior[0],{audior:audior[0]}):{}};$scope.ui={state:0},$scope.getLabel=function(){switch($scope.ui.state){case 1:return"End recording and review";case 2:return"Review";default:return"Record and review afterwards"}},$scope.main=function(){audio().audior.mainbtn();var u=$scope.ui;u.state<2&&u.state++},$scope.pauseRecording=function(){audio().audior.pauseResumeBtn()},$scope.recordAgain=function(){$scope.ui.state=0,audio().audior.recordagain()},$scope.upload=function(){audio().audior.save()},angular.element($document).ready(function(){isMobile()||$scope.toggle()})}]),ctrls.controller("ContactDataCtrl",["$scope","$routeParams","UserService","JobApplicationService","TimezonesService","$location","CountriesService","EnumsService","CandidatesService","CurrentUser","$q","skypeIdRegex",function($scope,$routeParams,UserService,JobApplicationService,TimezonesService,$location,CountriesService,EnumsService,CandidatesService,CurrentUser,$q,skypeIdRegex){function loadContactConfigData(){TimezonesService.query(function(timezones){CountriesService.query(function(countries){$scope.data.timezones=timezones,$scope.data.filteredTimezones=timezones,$scope.data.countries=countries,$scope.ui.isLoadingData=!1,$scope.changeCountry()})}),$scope.enums=EnumsService.get()}$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),$scope.data={countries:[],timezones:[],filteredTimezones:[],selectedCountryId:null,selectedTimeZoneId:null,userSecurity:{},skypeIdRegex:new RegExp(skypeIdRegex,"i")},$scope.options={},$scope.ui={isLoading:!0,isLoadingData:!0,isLocationRequired:!1,isSecurityQuestionRequired:!1};var promises=[],userGetAvatarPromise=CurrentUser.getAvatar({avatarType:"CANDIDATE"},function(fetchedUser){$scope.user=fetchedUser,$scope.user.location.country.id&&($scope.data.selectedCountryId=$scope.user.location.country.id),$scope.ui.isSecurityQuestionRequired=angular.isUndefined($scope.user.userSecurity)||angular.isUndefined($scope.user.userSecurity.securityQuestion),$scope.ui.isLocationRequired=!0}).$promise;promises.push(userGetAvatarPromise),promises.push(JobApplicationService.get({id:$routeParams.applicationId,avatarType:"CANDIDATE"},function(res){$scope.application=res,$scope.ui.isLocationRequired=!0,JobApplicationService.identifyCurrentStep($scope.application,"contact-data"),loadContactConfigData()},function(err){$scope.ui.err=err.data.text,$scope.ui.appNotFound=!0,$scope.ui.isLoadingData=!1}).$promise),$q.all(promises)["finally"](function(){$scope.ui.isLoading=!1}),$scope.changeCountry=function(){var c=$scope.data.countries.filter(function(x){return x.id===$scope.data.selectedCountryId})[0];if($scope.options.country=c.code,$scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.selectedTimeZoneId=c.timezones[0].id;else if($scope.data.selectedTimeZoneId){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.selectedTimeZoneId},!1);isIncluded||($scope.data.selectedTimeZoneId=null)}$scope.user.location.city=null},$scope.saveUpdatedContactData=function(form){if(!form.$invalid){$scope.ui.isLoading=!0;var candidate=angular.copy($scope.user);$scope.ui.isSecurityQuestionRequired&&("other"===$scope.data.userSecurity.securityQuestion&&$scope.data.customQuestion?(candidate.userSecurity=candidate.userSecurity||{},candidate.userSecurity.securityQuestion=$scope.data.customQuestion):candidate.userSecurity.securityQuestion=$scope.data.userSecurity.securityQuestion,candidate.userSecurity.rawSecurityAnswer=$scope.data.userSecurity.rawSecurityAnswer),$scope.ui.isLocationRequired&&(candidate.location=candidate.location||{},candidate.location.country={id:$scope.data.selectedCountryId},candidate.location.timeZone={id:$scope.data.selectedTimeZoneId},candidate.location.phone=form.phoneNumber.$modelValue.replace(/\D/g,"")),candidate.type="CANDIDATE",candidate.skypeId=form.skypeId.$modelValue,JobApplicationService.candidateProvidesContactInformation({id:$scope.application.id},candidate,function(data){$scope.user=data,$scope.application.candidate=$scope.user,$scope.loading=JobApplicationService.get({id:$routeParams.applicationId},function(res){$scope.application=res,JobApplicationService.identifyCurrentStep($scope.application,"contact-data")}),$scope.ui.isLoading=!1},function(err){$scope.ui.err=err.data.text,$scope.ui.isLoading=!1})}}}]),ctrls.controller("CompleteProfileCtrl",["$scope","LinkedInService","CandidatesService","CurrentUser","$routeParams","$location","$uibModal","GlobalDataFactory","JobApplicationService","TechTrialApplicationService","$window",function($scope,LinkedInService,CandidatesService,CurrentUser,$routeParams,$location,$uibModal,GlobalDataFactory,JobApplicationService,TechTrialApplicationService,$window){function endsWith(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1}$scope.msg={message:null};var token=$routeParams.code,appId=$routeParams.applicationId,url=$window.location.href;url&&url.length>0&&url.indexOf("profileEdit=true")>-1&&($scope.data.showProfileEdit=!0),endsWith($routeParams.applicationId,"?profileEdit=true")&&($scope.data.showProfileEdit=!0,appId=appId.substring(0,appId.indexOf("?profileEdit=true"))),appId&&!angular.isUndefined(appId)&&/^\d+$/.test(appId)||$location.path("/home"),CurrentUser.get(function(data){$scope.user=data,JobApplicationService.get({id:appId,avatarType:"CANDIDATE"},function(res){LinkedInService.setApplicationId(appId),$scope.application=res,GlobalDataFactory.setItem("application",$scope.application),GlobalDataFactory.setItem("currentStep",3)}),token&&($scope.isLoading=!0,CandidatesService.importProfile({id:data.id},{token:token}).$promise.then(function(data){$scope.updateProfile(data)})["catch"](function(err){$scope.msg.message=err.data.text})["finally"](function(){$scope.isLoading=!1}))}),$scope.isLoading=!1,$scope.submitProfile=function(){var rel=function(){$location.path("/candidate/application/second-test/"+appId)};$scope.isLoading=!0,$scope.updateProfile($scope.editingProfile,function(){TechTrialApplicationService.candidateCompleteProfile({id:appId},rel).$promise["catch"](function(err){$scope.msg.message=err.data.text})["finally"](function(){$scope.isLoading=!1})})},$scope.importProfile=function(){$uibModal.open({templateUrl:"overwrite-confirmation.tpl.html",controller:"ProfileOverwriteCtrl",windowClass:"center-modal"})}}]),ctrls.controller("ProfileOverwriteCtrl",["$scope","$uibModalInstance","LinkedInService",function($scope,$uibModalInstance,LinkedInService){$scope.confirm=function(){window.location=LinkedInService.generateAuthorizationUrl("profileImportApplication")},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("FirstTestCtrl",["$scope","$routeParams","CurrentUser","JobApplicationService","$location","CandidatesService","TechTrialApplicationService","techScreenUrl",function($scope,$routeParams,CurrentUser,JobApplicationService,$location,CandidatesService,TechTrialApplicationService,techScreenUrl){function initData(){var app=$scope.application;if(app.testInstances)for(var i=0;i<app.testInstances.length;i++){var testInstance=app.testInstances[i];"HACKER_RANK"===testInstance.test.type&&($scope.hackerRankUrl=testInstance.url,$scope.hackerRankUsername=testInstance.username,$scope.hackerRankPassword=testInstance.password,$scope.usernameAndPasswordVisible=$scope.hackerRankUrl.indexOf(techScreenUrl)!==-1)}$scope.hackerRankUrl||startTest1(),$scope.ui.isLoading=!1}function startTest1(){$scope.ui.isStartingTest=!0,$scope.ui.err=null,TechTrialApplicationService.startTest1({id:$scope.application.id},function(data){$scope.hackerRankUrl=data.url,$scope.hackerRankUsername=data.username,$scope.hackerRankPassword=data.password,$scope.usernameAndPasswordVisible=$scope.hackerRankUrl.indexOf(techScreenUrl)!==-1},function(err){$scope.ui.err=err.data.text}).$promise["finally"](function(){$scope.ui.isStartingTest=!1})}$scope.ui={isLoading:!0,isLoadingData:!0},$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),$scope.routeParams=$routeParams,JobApplicationService.get({id:$routeParams.applicationId,avatarType:"CANDIDATE"},function(res){$scope.user=res.candidate,$scope.application=res,JobApplicationService.identifyCurrentStep($scope.application,"first-test",initData),$scope.ui.isLoading=!1},function(err){$scope.ui.err=err.data.text,$scope.ui.appNotFound=!0,$scope.ui.isLoading=!1,$scope.ui.isLoadingData=!1})}]),ctrls.controller("PendingTestCtrl",["$routeParams","JobApplicationService","$location",function($routeParams,JobApplicationService,$location){var vm=this;$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),vm.loading=JobApplicationService.get({id:$routeParams.applicationId,avatarType:"CANDIDATE"},function(res){JobApplicationService.identifyCurrentStep(res,"pending-test")})}]),ctrls.controller("CandidatePhoneCtrl",["$scope","GlobalDataFactory","JobApplicationService","$routeParams","CurrentUser","$location",function($scope,GlobalDataFactory,JobApplicationService,$routeParams,CurrentUser,$location){$scope.ui={isLoading:!0},$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),CurrentUser.get(function(data){$scope.user=data,JobApplicationService.get({id:$routeParams.applicationId},function(res){$scope.application=res,GlobalDataFactory.setItem("application",$scope.application),GlobalDataFactory.setItem("currentStep",5),$scope.ui.isLoading=!1})})}]),ctrls.controller("QuestionnaireCtrl",["$scope","GlobalDataFactory","$uibModal","$routeParams","JobApplicationService","TestsService","$location","$sce","$timeout","CurrentUser",function($scope,GlobalDataFactory,$uibModal,$routeParams,JobApplicationService,TestsService,$location,$sce,$timeout,CurrentUser){function init(){$scope.loading=TestsService.getCurrent({id:$routeParams.applicationId},function(r){r.answers=_.sortBy(r.answers,"sequenceNumber"),r.test.questions=_.sortBy(r.test.questions,"sequenceNumber"),$scope.data.test=r},errCallback)}function errCallback(err){$scope.err=angular.isObject(err.data)?err.data.text:err.text,document.getElementsByClassName("questionnaire")[0].scrollIntoView(),$scope.submitInProgress=!1}$scope.data={},$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),$scope.loading=JobApplicationService.get({id:$routeParams.applicationId,avatarType:"CANDIDATE"},function(res){JobApplicationService.identifyCurrentStep(res,"questionnaire",init),"HACKERRANK_FIVEQ"===res.job.flowType&&GlobalDataFactory.setItem("currentStep",4)});var timeout,saveInProgress=!1,responseIsSubmitted=!1,saveFinished=function(){saveInProgress=!1},debounceSaveUpdates=function(){saveInProgress||responseIsSubmitted||(saveInProgress=!0,timeout&&$timeout.cancel(timeout),timeout=$timeout($scope.autosave,6e4))};$scope.expand=function(ind){$($(".answer")[ind]).slideToggle(),$($(".text")[ind]).toggleClass("expanded")},$scope.$on("$destroy",function(){timeout&&$timeout.cancel(timeout)}),$scope.autosave=function(){var test=$scope.data.test;$routeParams.applicationId&&angular.isObject(test)&&TestsService.save5QAnswers({id:$routeParams.applicationId},test,null,errCallback).$promise["finally"](saveFinished)},$scope.save=function(){$scope.err="",$scope.saving=TestsService.save5QAnswers({id:$routeParams.applicationId},$scope.data.test,null,errCallback)},$scope.$watch("data.test.answers",debounceSaveUpdates,!0),$scope.submit=function(){$scope.submitInProgress=!0,$scope.modal.dismiss(),timeout&&$timeout.cancel(timeout),$scope.loading=TestsService.submit5QAnswers({id:$routeParams.applicationId},$scope.data.test,function(){responseIsSubmitted=!0,GlobalDataFactory.setItem("application.state","AFTER-TEST"),$location.path("/candidate/application/second-test/"+$routeParams.applicationId)},errCallback)},$scope.questionnaireModal=function(form){$scope.err="",form.$valid&&($scope.modal=$uibModal.open({templateUrl:"questionnaire-modal.tpl.html",scope:$scope,backdrop:"static",windowClass:"questionnaire"}))},$scope.trustAsHtml=function(t){return $sce.trustAsHtml(t)},CurrentUser.get(function(data){$scope.user=data})}]),ctrls.controller("SecondTestCtrl",["$scope","$rootScope","GlobalDataFactory","$routeParams","$uibModal","TechTrialApplicationService","JobApplicationService","$timeout","CurrentUser","$location",function($scope,$rootScope,GlobalDataFactory,$routeParams,$uibModal,TechTrialApplicationService,JobApplicationService,$timeout,CurrentUser,$location){function processAssignment(){$scope.ui.state=GlobalDataFactory.getItem("application.state");var application={id:$routeParams.applicationId},promise=null;"BEFORE-TEST"===$scope.ui.state?($scope.ui.isLoading=!0,promise=TechTrialApplicationService.getInvitation(application,function(res){$scope.ui.canSubmitRequest=res.canSubmitInviteRequest,$scope.ui.maxRequest=res.maxInviteRequestDays,$scope.ui.assignmentDaysCount=res.assignmentDaysCount,$scope.ui.prerequisites=res.prerequisites,void 0===res.assignmentDaysCount&&($scope.ui.assignmentDaysCount=3);var invitationDays=21-res.maxInviteRequestDays,endDate=moment().add(invitationDays,"d").toDate();if(res.inviteStartDate){var sDate=moment.unix(res.inviteStartDate).toDate();endDate=moment()-sDate.getTime()>1e3*invitationDays*3600*24?moment().add(1,"d").toDate():moment(endDate.getTime()-(moment()-sDate.getTime())).toDate()}$scope.data.endDate=endDate,$scope.data.countdown=endDate}).$promise):"ONGOING-TEST"===$scope.ui.state&&($scope.ui.isLoading=!0,promise=TechTrialApplicationService.getAssignment(application,function(res){$scope.ui.canSubmitRequest=res.canSubmitAssignmentRequest,$scope.maxDeliverySize=res.maxDeliveryInMB,$scope.data.endDate=moment.unix(res.assignmentEndDate).toDate(),$scope.data.countdown=moment.unix(res.assignmentEndDate).valueOf(),$scope.data.uploaded=res.deliverablesUploaded,$scope.data.assignment=res.assignmentData.replace(//g,""),res.vmAvailable&&listVM()}).$promise),promise&&promise["catch"](errorCallback)["finally"](finalCallback),$scope.data.application=GlobalDataFactory.getItem("application")}function listVM(){$scope.ui.isLoading=!0,TechTrialApplicationService.listVMs({id:$routeParams.applicationId},function(res){$scope.data.vms=res,startPolling(res)},errorCallback).$promise["finally"](finalCallback)}function pollVM(){$timeout(function(){TechTrialApplicationService.listVMs({id:$routeParams.applicationId},function(res){$scope.data.vms=res,startPolling(res)})},2e4)}function startPolling(res){var filtered=res.filter(function(vm){return"pending"===vm.status||"stopping"===vm.status});filtered&&filtered.length>0&&pollVM()}function errorCallback(err){$scope.ui.err=angular.isObject(err.data)?err.data.text:err.text}function finalCallback(){$scope.ui.isLoading=!1}function checkIfStringEndsWith(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1}var BYTES_MB=1048576;$scope.ui={state:"BEFORE-TEST"},$scope.data={},$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),CurrentUser.get(function(data){$scope.user=data}),$scope.init=function(){$scope.ui.isLoading=!0,JobApplicationService.get({id:$routeParams.applicationId,avatarType:"CANDIDATE"},function(res){JobApplicationService.identifyCurrentStep(res,"second-test",processAssignment)},errorCallback).$promise["finally"](finalCallback)},$scope.init(),$scope.startVM=function(vm){$scope.ui.isLoading=!0,TechTrialApplicationService.startVM({id:$routeParams.applicationId,vmId:vm.id},function(){listVM()},errorCallback).$promise["finally"](finalCallback)},$scope.stopVM=function(vm){$scope.ui.isLoading=!0,TechTrialApplicationService.stopVM({id:$routeParams.applicationId,vmId:vm.id},function(){listVM()},errorCallback).$promise["finally"](finalCallback)},$scope.startTrialConfirmation=function(){var modalInstance=$uibModal.open({templateUrl:"start-trial-confirmation.tpl.html",controller:"StartTrialConfirmationCtrl",scope:$scope});modalInstance.result.then(function(res){"start"===res&&$scope.start()})},$scope.start=function(){$scope.ui.isLoading=!0,$scope.ui.err=null,$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&null!==$routeParams.applicationId&&"null"!==$routeParams.applicationId||$location.path("/home"),TechTrialApplicationService.startAssignment({id:$routeParams.applicationId},function(){GlobalDataFactory.setItem("application.state","ONGOING-TEST"),processAssignment()},errorCallback).$promise["finally"](finalCallback)};var bb1,bb2;try{bb1=fpGetBlackbox()}catch(e){bb1=null}try{bb2=ioGetBlackbox()}catch(e){bb2=null}$scope.upload=function(){$scope.ui.isLoading=!0,TechTrialApplicationService.uploadAssignment($routeParams.applicationId,$scope.delivery,bb1,bb2).success(function(){$scope.data.uploaded=!0,processAssignment()}).error(errorCallback)["finally"](finalCallback)},$scope.end=function(){$scope.ui.isLoading=!0,TechTrialApplicationService.endAssignment({id:$routeParams.applicationId},function(){GlobalDataFactory.setItem("application.state","AFTER-TEST"),processAssignment()},errorCallback).$promise["finally"](finalCallback)},$scope.fileChange=function($files){if($scope.ui.err="",$scope.ui.deliveryName=$scope.delivery=null,angular.isArray($files)&&0!==$files.length){if($scope.data.uploaded=!1,0===$files[0].size)return void($scope.ui.err="Empty files are not allowed. Please select a correct file.");if($files[0].size/BYTES_MB>=$scope.maxDeliverySize)return void($scope.ui.err="Your upload is too big. Max upload size is "+$scope.maxDeliverySize+"MB.");if($files[0].type.indexOf("zip")===-1&&!checkIfStringEndsWith($files[0].name,".zip"))return void($scope.ui.err="Only file with type '.zip, application/zip' is acceptable.");$scope.ui.deliveryName=$files[0].name,$scope.delivery=$files}},$scope.openPrerequistesModal=function(){$scope.ui.extenstionModal=$uibModal.open({templateUrl:"show-pre-requisites.tpl.html",windowClass:"top30 second-test",scope:$scope})},$scope.openExtensionModal=function(){$scope.ui.extenstionModal=$uibModal.open({templateUrl:"assignment-extension.tpl.html",windowClass:"top30 second-test",scope:$scope})},$scope.submitRequest=function(form){if(form.$valid){var type=null;if("BEFORE-TEST"===$scope.ui.state)type="InvitationExtension";else{if("ONGOING-TEST"!==$scope.ui.state)return;type="AssignmentExtension"}$scope.closeModal(),$scope.ui.isLoading=!0,TechTrialApplicationService.extendAssignment({id:$routeParams.applicationId,requestType:type,requiredDuration:$scope.data.requiredDuration,content:$scope.data.reason},function(){processAssignment()}).$promise["catch"](errorCallback)["finally"](finalCallback),$scope.data.reason="",$scope.data.requiredDuration=1}},$scope.closeModal=function(){$scope.ui.extenstionModal.close()}}]),ctrls.controller("StartTrialConfirmationCtrl",["$scope","$uibModalInstance",function($scope,$uibModalInstance){$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.start=function(){$uibModalInstance.close("start")}}]),ctrls.controller("SecondChanceCtrl",["$scope","JobApplicationService","$routeParams","$location",function($scope,JobApplicationService,$routeParams,$location){$routeParams.applicationId&&!angular.isUndefined($routeParams.applicationId)&&/^\d+$/.test($routeParams.applicationId)||$location.path("/home"),JobApplicationService.get({id:$routeParams.applicationId,page:0,avatarType:"CANDIDATE"},function(app){$scope.application=app})}]),ctrls.controller("CandidateApplicationsCtrl",["$scope","JobApplicationService",function($scope,JobApplicationService){$scope.selectedApplication={},$scope.currentPage=1,$scope.applicationIndex=0,$scope.totalElements=0,$scope.ui={isLoading:!0,showDashboard:!1},$scope.getApplications=function(){$scope.applicationIndex=0;var page=$scope.currentPage-1;JobApplicationService.getApplications({page:page,avatarType:"CANDIDATE"}).$promise.then(function(data){$scope.applications=data.content||[],$scope.applications[0]&&"NATIVE"===$scope.applications[0].applicationType&&"IN_PROGRESS"!==$scope.applications[0].status?JobApplicationService.identifyCurrentStep($scope.applications[0],function(){$scope.ui.showDashboard=!0}):$scope.applications[0]&&$scope.applications[0].id&&"NATIVE"===$scope.applications[0].applicationType&&"IN_PROGRESS"===$scope.applications[0].status?JobApplicationService.get({id:$scope.applications[0].id,jobId:$scope.applications[0].job.id,page:page,avatarType:"CANDIDATE"},function(app){JobApplicationService.identifyCurrentStep(app,function(){$scope.ui.showDashboard=!0})}):$scope.ui.showDashboard=!0,$scope.totalElements=data.totalElements,$scope.applications.length>0?setSelected():$scope.selectedApplication={}})["catch"](function(){$scope.ui.isLoading=!1}).then(function(){$scope.ui.isLoading=!1})};var setSelected=function(){$scope.selectedApplication=$scope.applications[$scope.applicationIndex],$scope.applicationFailed=!1,$scope.applicationProgress=5,$scope.applicationProgressStep=1,$scope.progressIndication1="Thank you for applying for the "+$scope.selectedApplication.job.title+" role.",$scope.progressIndication2="If you pass our initial screen, you will receive an email from us with a link to the technical screen.","FAILED"===$scope.selectedApplication.hackerRankStatus||"FAILED"===$scope.selectedApplication.rmtStatus?$scope.applicationFailed=!0:"PASSED"===$scope.selectedApplication.rmtStatus?($scope.applicationProgress=95,$scope.applicationProgressStep=4,$scope.progressIndication1="Congratulations on passing the project evaluation.",$scope.progressIndication2="You are available for hire in our marketplace."):"PASSED"===$scope.selectedApplication.hackerRankStatus?($scope.applicationProgress=60,$scope.applicationProgressStep=3,$scope.progressIndication1="Congratulations on passing the technical screen",$scope.progressIndication2="You should have received an email with a link to the project evaluation. If you pass the evaluation, you will be available for hire in our marketplace."):"INVITED"===$scope.selectedApplication.hackerRankStatus&&($scope.applicationProgress=15,$scope.applicationProgressStep=2,$scope.progressIndication1="Congratulations on passing the initial screen",$scope.progressIndication2="You should have received an email with a link to the technical screen. If you pass that screen, you will move to the project evaluation stage.")};$scope.next=function(){$scope.applicationIndex+1<$scope.applications.length?($scope.applicationIndex=$scope.applicationIndex+1,setSelected()):10*$scope.currentPage<$scope.totalElements&&($scope.currentPage++,$scope.applicationIndex=0,$scope.getApplications())},$scope.previous=function(){$scope.applicationIndex-1>=0?($scope.applicationIndex=$scope.applicationIndex-1,setSelected()):$scope.currentPage>1&&($scope.currentPage--,$scope.getApplications(),$scope.applicationIndex=9)}}]),ctrls.controller("CandidateDashboardCtrl",["$scope","$routeParams","AssignmentService","$location",function($scope,$routeParams,AssignmentService,$location){AssignmentService.assignments({page:0,avatarType:"CANDIDATE",status:"ACTIVE"},function(res){var asgn=res.content||[];$scope.asgnCheck=asgn.length>0}),$scope.landingPage=$routeParams.landingPage,"contract"===$scope.landingPage&&$location.path("/contractor/home")}]),ctrls.controller("CandidateDashboardHiringCtrl",["$scope","$uibModal","$location","InterviewsService","AssignmentService","CrossoverTasksService","CurrentUser",function($scope,$uibModal,$location,InterviewsService,AssignmentService,CrossoverTasksService,CurrentUser){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function getAssignmentsRecursive(page){$scope.ui.isLoading=!0;var p=page||0;AssignmentService.list({avatarType:"CANDIDATE"},function(data){assignments=assignments.concat(data.content||[]),data.last?(assignments.forEach(function(x){x.job=x.selection.marketplaceMember.application.job,acceptedStatus.indexOf(x.status)>=0?(x.steps=1,(x.isTrackerPasswordRequired||x.isPayoneerRequired)&&x.steps++,"MANAGER_SETUP"!==x.status||x.isTrackerPasswordRequired||x.isPayoneerRequired||x.isTeamAgreementRequired||x.steps++,(x.isTrackerPasswordRequired||x.isPayoneerRequired||x.isTeamAgreementRequired)&&x.steps++,x.isPayoneerRequired||x.isTeamAgreementRequired||x.isTrackerPasswordRequired||x.steps++,$scope.data.assignments.accepted.push(x)):otherStatus.indexOf(x.status)>=0&&$scope.data.assignments.others.push(x)}),$scope.ui.isLoading=!1,loadUserTasks()):getAssignmentsRecursive(p+1)})}function loadUserTasks(){$scope.ui.isLoading=!0,CrossoverTasksService.query().$promise.then(function(data){$scope.data.tasks=data||[],$scope.data.tasks.forEach(function(x){var arr=$scope.data.assignments.accepted.filter(function(assignment){return x.object&&assignment.id===x.object.id});if(1===arr.length){var matchedAssignemnt=arr[0];switch(x.taskType){case"candidateSetsUpPayoneer":matchedAssignemnt.isPayoneerRequired=!0;break;case"candidateAcceptsAgreements":matchedAssignemnt.isTeamAgreementRequired=!0;break;case"candidateProvidesTrackerPassword":matchedAssignemnt.isTrackerPasswordRequired=!0}}}),$scope.ui.isLoading=!1})["catch"](function(err){showMessage("alert-danger","Error: "+err.data.text),$scope.ui.isLoading=!1})}$scope.data={assignments:{accepted:[],others:[]},interviews:[],tasks:[]},$scope.ui={isLoading:!0},$scope.msg={clazz:"",show:!1,message:""},$scope.acceptOffer=function(assignment){$location.path("/contract/"+assignment.id+"/view")},$scope.rejectOffer=function(assignment){$location.path("/contract/"+assignment.id+"/view")},$scope.begin=function(interview){$location.path("/interview/"+interview.id+"/video-conference")},$scope.goToInterview=function(interview){interview&&("CANDIDATE_ACCEPTED"===interview.status?$scope.begin(interview):$location.path("/interview/"+interview.id+"/view"))},$scope.cancel=function(interview){var modalInstance=$uibModal.open({templateUrl:"candidate-interview-cancel-feedback.tpl.html",controller:"InterviewCancelFeedbackCtrl",backdrop:"static",resolve:{interview:function(){return interview}}});modalInstance.result.then(function(){var idx=$scope.data.interviews.indexOf(interview);$scope.data.interviews.splice(idx,1);var msg='The interview of "'+interview.job.title+'" is canceled.';showMessage("alert-success",msg)})},$scope.schedule=function(interview){var modalInstance=$uibModal.open({templateUrl:"candidate-dashboard-hiring-schedule.tpl.html",controller:"CandidateDashboardHiringScheduleCtrl",backdrop:"static",resolve:{interviewId:function(){return interview.id}}});modalInstance.result.then(function(result){if(result.error)showMessage("alert-danger",result.error.data.text);else{var idx=$scope.data.interviews.indexOf(interview);result.job=result.selection.marketplaceMember.application.job,$scope.data.interviews[idx]=result,$scope.data.interviews[idx].startDateTime=getInterViewTime($scope.data.interviews[idx])}})},$scope.next=function(step,assignment){var assignmentId=assignment.id;switch(step){case 1:var url=assignment.isTrackerPasswordRequired?"/contract/"+assignmentId+"/tracker":"/worksmart";
$location.path(url);break;case 2:if(assignment.isPayoneerRequired){var url2="/onboard/payoneer";$location.path(url2)}break;case 3:if(assignment.isTeamAgreementRequired){var url3="/contract/"+assignmentId+"/agree";$location.path(url3)}break;case 4:$location.path("/onboard/training");break;case 5:}};var assignments=[],acceptedStatus="CANDIDATE_ACCEPTED|MANAGER_SETUP|ACTIVE",otherStatus="PENDING|CANDIDATE_REJECTED";CurrentUser.get(function(me){$scope.me=me,InterviewsService.list({avatarType:"CANDIDATE"}).$promise.then(function(data){(data.content||[]).forEach(function(x){"INITIAL|CANDIDATE_ACCEPTED".indexOf(x.status)>=0&&"IN_PROGRESS|REINTERVIEW".indexOf(x.selection.status)>=0&&(x.job=x.selection.marketplaceMember.application.job,x.startDateTime=getInterViewTime(x),$scope.data.interviews.push(x))})})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){getAssignmentsRecursive()})});var getInterViewTime=function(i){if(angular.isObject(i)){var a=moment(i.startDateTime),b=$scope.me.location.timeZone.offset,d=new Date(a.add(b,"ms"));return d.setTime(d.getTime()+6e4*d.getTimezoneOffset()),d}}}]),ctrls.controller("CandidateDashboardHiringScheduleCtrl",["$scope","InterviewsService","$uibModalInstance","interviewId","CurrentUser",function($scope,InterviewsService,$uibModalInstance,interviewId,CurrentUser){function selectEvent(evt){$scope.data.eventSources[0].forEach(function(x){x.title!==evt.title&&(x.className=["available"])}),evt.className=["selected","available"],$scope.data.selectedDate=moment(evt.start).toDate()}function setCalendarEvents(i){var dates=[],slots=i.interviewSlots;slots.forEach(function(slot){var date=moment(getInterViewSlotTime(i,slot)).toDate();date.setHours(0),date.setMinutes(0);var dt=date.getTime();dates.indexOf(dt)<0&&dates.push(dt)}),dates.forEach(function(x){$scope.data.eventSources[0].push({start:new Date(x),title:new Date(x).getDate()+"",className:["available"],allDay:!0})}),selectEvent($scope.data.eventSources[0][0])}function decorateInterviewSlots(i){i.interviewSlots.forEach(function(slot){moment(slot.startDateTime)>moment()&&(slot.valid=!0),slot.candidateInterviewStartTime=getInterViewSlotTime(i,slot)})}$scope.data={interview:null,selectedDate:null,eventSources:[[]]},$scope.ui={isLoading:!0,isNoSlotSelected:!1,calendarConfig:{editable:!1,titleFormat:"MMMM, yyyy",dayNamesShort:["S","M","T","W","T","F","S"],header:{left:"prev",center:"title",right:"next"},eventClick:selectEvent}},$scope.msg={clazz:"",show:!1,message:""},$scope.isSlotInSelectedDate=function(slot){var slotDate=moment(slot.candidateInterviewStartTime).toDate(),selectedDate=moment($scope.data.selectedDate).toDate();return slotDate.getFullYear()===selectedDate.getFullYear()&&slotDate.getMonth()===selectedDate.getMonth()&&slotDate.getDate()===selectedDate.getDate()},$scope.toggleSlot=function(slot){slot.isSelected&&($scope.ui.isNoSlotSelected=!1,$scope.data.interview.interviewSlots.forEach(function(x){x!==slot&&(x.isSelected=!1)}))},$scope.close=function(){$uibModalInstance.dismiss()},$scope.save=function(){var arr=$scope.data.interview.interviewSlots.filter(function(x){return x.isSelected});if(!arr||0===arr.length)return void($scope.ui.isNoSlotSelected=!0);$scope.ui.isLoading=!0;var params={id:$scope.data.interview.id,slotId:arr[0].id};InterviewsService.acceptSlot(params,{}).$promise.then(function(data){$uibModalInstance.close(data)})["catch"](function(err){$uibModalInstance.close({error:err})})};var getInterViewSlotTime=function(i,slot){if(angular.isObject(i)){var a=moment(slot.startDateTime),b=$scope.me.location.timeZone.offset,d=new Date(a.add(b,"ms"));return d.setTime(d.getTime()+6e4*d.getTimezoneOffset()),d}};CurrentUser.get(function(me){$scope.me=me,InterviewsService.get({id:interviewId}).$promise.then(function(data){$scope.data.interview=data,decorateInterviewSlots($scope.data.interview),setCalendarEvents($scope.data.interview),data.interviewSlots.forEach(function(x){x.isSelected=!1})})["catch"](function(err){$uibModalInstance.close({error:err})})["finally"](function(){$scope.ui.isLoading=!1})})}]),ctrls.controller("InterviewCancelFeedbackCtrl",["$scope","$uibModalInstance","InterviewsService","interview",function($scope,$uibModalInstance,InterviewsService,interview){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}$scope.data={interview:interview},$scope.ui={isLoading:!1},$scope.submit=function(){var interview=angular.copy($scope.data.interview);delete interview.job;var params={id:interview.id,slotId:-1};$scope.ui.isLoading=!0,InterviewsService.acceptSlot(params,interview.intervieweeNotes).$promise.then(function(data){$uibModalInstance.close(data)})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("CandidateWelcomeCtrl",["$scope","$location","JobService",function($scope,$location,JobService){$scope.started=!1,JobService.crud.query(function(data){$scope.started=!0,0===data.length&&$location.path("/candidate/dashboard")})}]),ctrls.controller("JobsHealthCtrl",["JobService",function(JobService){function loadJobHealths(){vm.promise=JobService.crud.health(function(res){vm.customJobs=_.filter(res,function(h){return"CUSTOM"===h.job.type}),vm.genericJobs=_.filter(res,function(h){return"GENERIC"===h.job.type})})}function jobFilter(item){var mgr,colorMatch=!0,searchMatch=!0,job=item.job;if(_.isEmpty(vm.color)||(colorMatch=item.color===vm.color),!_.isEmpty(vm.search)){var s=vm.search.toLowerCase();searchMatch=job.title.toLowerCase().indexOf(s)>=0,mgr=_.find(job.visibleManagers,function(mgr){return mgr.printableName.toLowerCase().indexOf(s)>=0}),void 0!==mgr&&(searchMatch=!0)}return colorMatch&&searchMatch}var vm=this;vm.jobFilter=jobFilter,vm.color="",loadJobHealths()}]),ctrls.controller("ContactUsCtrl",["$scope","uploadedDocsUrl",function($scope,uploadedDocsUrl){$scope.ui={isLoading:!0},$scope.text=uploadedDocsUrl+"/documents/contact_us.md"}]),ctrls.controller("MakeOfferCtrl",["$scope","AssignmentService","$routeParams","ProfileUtils","SelectionService","MarketplaceMembersService","$location",function($scope,AssignmentService,$routeParams,ProfileUtils,SelectionService,MarketplaceMembersService,$location){function initDirectOffer(){MarketplaceMembersService.get({id:$routeParams.marketplaceMemberId}).$promise.then(function(res){$scope.candidate=res.application.candidate,$scope.photoUrl=ProfileUtils.profilePhotoUrl($scope.candidate),$scope.data={marketplaceMember:{id:res.id}},$routeParams.teamId&&($scope.data.team={id:$routeParams.teamId}),vm.checkOfferExists(res.id)})}function initSelectionOffer(){SelectionService.get({id:$routeParams.selectionId}).$promise.then(function(res){$scope.candidate=res.marketplaceMember.application.candidate,$scope.photoUrl=ProfileUtils.profilePhotoUrl($scope.candidate),$scope.data={selection:res},vm.checkOfferExists(res.id)})}var vm=this;$scope.ui={isLoading:!0,created:!1,hireInitiated:!1},$scope.data={},$scope.message={},$scope.toggleMessage=function(show,type,text){$scope.message={show:show,type:type,text:text}},vm.init=function(){$routeParams.selectionId?initSelectionOffer():initDirectOffer()},vm.checkOfferExists=function(marketplaceMemberId){AssignmentService.get({marketplaceMemberId:marketplaceMemberId}).$promise.then(function(res){if(res&&res.content&&res.content.length>0)for(var i=0;i<res.content.length;i++){var assignment=res.content[i];if("PENDING"===assignment.status)return $scope.toggleMessage(!0,"danger","Offer has been already sent!"),void($scope.ui.isLoading=!1);if("ACTIVE"===assignment.status)return $scope.toggleMessage(!0,"danger","There is running contract for this candidate with you already!"),void($scope.ui.isLoading=!1)}$scope.submit()})},vm.init(),$scope.submit=function(){if($scope.data){var offerPromise=null;return offerPromise=$routeParams.selectionId?SelectionService.save($scope.data).$promise:SelectionService.directOffer($scope.data).$promise,offerPromise.then(function(ret){$scope.ui.created=ret,$location.path("/manager/candidates")})["catch"](function(err){$scope.toggleMessage(!0,"danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1}),!0}}}]),ctrls.controller("TeamAgreementCtrl",["$scope","$location","$routeParams","AssignmentService",function($scope,$location,$routeParams,AssignmentService){function updateStatus(){AssignmentService.candidateAcceptsTeamAgreements({id:$routeParams.assignmentId},{}).$promise.then(function(){$location.path("/candidate/dashboard")})}var vm=this;vm.init=function(){$scope.agreed=!1,AssignmentService.get({id:$routeParams.assignmentId}).$promise.then(function(data){$scope.assignment=data,$scope.agreements=data.team.agreements||[],0===$scope.agreements.length&&($scope.agreed=!0,updateStatus())})},vm.init(),$scope.$on("$routeChangeStart",function(){$scope.agreed||$location.path("/contract/"+$routeParams.assignmentId+"/agree")}),$scope.next=function(){$scope.agreed&&updateStatus()}}]),ctrls.controller("TrackerCtrl",["$scope","AssignmentService","$routeParams","Flash","$location","CurrentUser","CrossoverTasksService",function($scope,AssignmentService,$routeParams,Flash,$location,CurrentUser,CrossoverTasksService){function getCurrentUser(){CurrentUser.get().$promise.then(function(res){$scope.data.me=res})["catch"](function(err){setMessage("alert-danger",err.statusText)})["finally"](function(){$scope.ui.isLoading=!1})}var vm=this;vm.init=function(){$scope.data={me:null,password:"",passwordRetype:""},$scope.ui={isLoading:!0},$scope.PASSWORD_REGEXP=/^(?=.*[^a-zA-Z])(?=.*[a-zA-Z]).{8,64}$/,getCurrentUser()};var setMessage=function(clazz,message){$scope.message=message,$scope.messageClass="alert "+clazz};vm.init(),$scope.cancel=function(){$location.path("/contract/"+$routeParams.assignmentId+"/view")},$scope.createTrackerUser=function(form){if(!(form.$invalid||$scope.data.me.userSecurity.linkedInLogin&&$scope.data.password!==$scope.data.passwordRetype))return $scope.ui.isLoading=!0,AssignmentService.candidateProvidesTrackerPassword({id:$routeParams.assignmentId},$scope.data.password).$promise.then(function(){Flash.addSuccess("Your WorkSmart account has been created successfully."),CrossoverTasksService.query().$promise.then(function(data){$scope.data.tasks=data||[];var isPayoneerNotReady=(data||[]).reduce(function(ret,x){return ret||"candidateSetsUpPayoneer"===x.taskType},!1),url=isPayoneerNotReady?"/onboard/payoneer":"/candidate/dashboard/hiring";$location.path(url)})["catch"](function(e){setMessage("alert-danger",e.data.text),$scope.ui.isLoading=!1})})["catch"](function(e){setMessage("alert-warning",e.data.text),$scope.ui.isLoading=!1}),!0}}]),ctrls.controller("ContractViewCtrl",["$scope","$routeParams","CurrentUser","ProfileUtils","AssignmentService","$location","$uibModal","Flash","CrossoverTasksService",function($scope,$routeParams,CurrentUser,ProfileUtils,AssignmentService,$location,$uibModal,Flash,CrossoverTasksService){function getCurrentUser(){CurrentUser.get().$promise.then(function(res){$scope.data.me=res,getAssignmentDetails(),$scope.clearError()})["catch"](function(err){$scope.setError(err.statusText)})["finally"](function(){$scope.ui.isLoading=!1})}function getAssignmentDetails(){$scope.ui.isLoading=!0,AssignmentService.get({id:$routeParams.assignmentId}).$promise.then(function(res){assignData(res),$scope.clearError()})["catch"](function(err){$scope.setError(err.statusText)})["finally"](function(){$scope.ui.isLoading=!1})}function assignData(assignment){$scope.data.assignment=assignment,$scope.data.manager=assignment.manager,$scope.data.candidate=assignment.selection.marketplaceMember.application.candidate,$scope.data.job=assignment.selection.marketplaceMember.application.job,$scope.ui.managerPhotoUrl=ProfileUtils.profilePhotoUrl($scope.data.manager),$scope.ui.candidatePhotoUrl=ProfileUtils.profilePhotoUrl($scope.data.candidate);var candidateAv=$scope.data.me.userAvatars.filter(function(a){return"CANDIDATE"===a.type}).pop();candidateAv&&$scope.data.candidate.id===candidateAv.id&&($scope.data.candidateUser=!0)}function openModal(name){$scope.modalInstance=$uibModal.open({templateUrl:name,scope:$scope})}var vm=this;$scope.msg={showMessage:!1,messageClass:"",message:""},$scope.setMessage=function(text,type){$scope.ui.isLoading=!1,$scope.msg.message=text,$scope.msg.messageClass="alert "+type,$scope.msg.showMessage=!0},vm.init=function(){$scope.data={me:null,assignment:null,manager:null,candidate:null},$scope.ui={isLoading:!0,managerPhotoUrl:null,candidatePhotoUrl:null},getCurrentUser()},vm.init(),$scope.setError=function(err){$scope.hasErrors=!0,$scope.errorMessage=err},$scope.clearError=function(){$scope.hasErrors=!1},$scope.declineOfferModal=function(){openModal("decline-offer.tpl.html")},$scope.declineOffer=function(){$scope.data.candidateUser?($scope.modalInstance.close(),$scope.ui.isLoading=!0,AssignmentService.candidateAcceptsDeclinesOffer({id:$scope.data.assignment.id,status:"CANDIDATE_REJECTED"},{}).$promise.then(function(){Flash.addSuccess("You have declined the offer.","/candidate/dashboard")})["catch"](function(err){$scope.setError(err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})):$scope.setError("You are not allowed to perform this action!")},$scope.modalCancel=function(){$scope.modalInstance.dismiss("cancel")},$scope.acceptOffer=function(){$scope.ui.isLoading=!0;var data={id:$scope.data.assignment.id,status:"CANDIDATE_ACCEPTED"};AssignmentService.candidateAcceptsDeclinesOffer(data,{}).$promise.then(function(){Flash.addSuccess("You have successfully accepted job offer. Your response has been sent."),CrossoverTasksService.query().$promise.then(function(data){var tasks=data||[],trackerReq=!1;tasks.forEach(function(x){"candidateProvidesTrackerPassword"===x.taskType&&x.object.id===parseInt($scope.data.assignment.id,10)&&(trackerReq=!0,$location.path("/contract/"+$scope.data.assignment.id+"/tracker"))}),trackerReq||$location.path("/onboard/payoneer")})["catch"](function(err){$scope.setMessage(err.data.text,"alert-danger")})},function(err){$scope.setMessage(err.data.text,"alert-danger"),$scope.scrollToTop()})}}]),ctrls.controller("TeamMemberCtrl",["$scope","$document","$routeParams","TimeUtils","UtilsService","$uibModal","AssignmentService","TeamService","CurrentUser","ProductivityService","CandidatesService","$filter","$cacheFactory","$cookies","$q","CompaniesService","$window","$location","DownloadService",function($scope,$document,$routeParams,TimeUtils,UtilsService,$uibModal,AssignmentService,TeamService,CurrentUser,ProductivityService,CandidatesService,$filter,$cacheFactory,$cookies,$q,CompaniesService,$window,$location,DownloadService){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg},setTimeout(function(){$scope.msg.show=!1},6e3)}function calculateTime(timeInMin){var printableTime=Math.floor(timeInMin/60)+":",minutes=timeInMin%60;return printableTime+=minutes>0?minutes:"00"}function setTimecardFlags(timecard){timecard.isMeeting=(timecard.actions||[]).reduce(function(ret,x){return ret||"SET_MEETING_TIME"===x.actionType},!1),timecard.isIdle=!timecard.isMeeting&&timecard.autoTracker&&timecard.activityLevel<$scope.PRODUCTIVITY_THRESHOLD,timecard.isManual=!timecard.autoTracker,timecard.isApproved=timecard.isManual,timecard.isRejected=!1,timecard.isDisputed=timecard.rejected,timecard.isDisputeResolved=(timecard.actions||[]).reduce(function(ret,x){return ret||"RESOLVE_DISPUTE"===x.actionType},!1),timecard.expaned=$scope.ui.isListViewExpand}function convertToZone(millis,offset){var d=new Date(millis),utc=d.getTime()+6e4*d.getTimezoneOffset();return moment(utc+offset).toDate()}function loadData(){$scope.data.isEnforcerUser=!1,$scope.initEnforcer(),$scope.data.monthTitle=getCurrentMonthTitle(),$scope.data.hoursRange=$scope.data.hoursRange8,$scope.data.weeksRange=$scope.data.weekRange40,$scope.data.applicationsRange=$scope.data.applicationsRange40}function loadAssignment(assignmentId,avatarType){$scope.ui.isLoading=!0,AssignmentService.get({id:assignmentId,avatarType:avatarType}).$promise.then(function(res){$scope.assignment=res,$scope.assignment.showActivities=isFeatureEnabled($scope.assignment,"TIME_ACTIVITIES"),$scope.assignment.isScreenshotFeatureActive=isFeatureEnabled($scope.assignment,"SCREENSHOTS"),$scope.assignment.isWebcamshotFeatureActive=isFeatureEnabled($scope.assignment,"WEBCAM_PICTURES"),$scope.assignment.isAppTrackingFeatureActive=isFeatureEnabled($scope.assignment,"APPLICATION_TRACKING"),$scope.assignment.isEnforcerReviewFeatureActive=isFeatureEnabled($scope.assignment,"ENFORCER_REVIEW"),$scope.getTimezoneOffsets(),$scope.user&&$scope.user.avatarTypes.indexOf("ENFORCER")>-1&&$scope.data.isEnforcerUser&&($scope.data.displayTimecards="24HOUR",angular.isDefined($scope.data.timeZoneOffsets[1])&&null!==$scope.data.timeZoneOffsets[1]&&($scope.data.timezone=$scope.data.timeZoneOffsets[1]),$scope.assignment.isEnforcerReviewEnabled=isFeatureEnabled($scope.assignment,"ENFORCER_REVIEW")),$scope.data.assignmentId=assignmentId,initAssignment(),$scope.data.assignmentId=$scope.assignment.id,$scope.data.teamId=$scope.assignment.team.id,$scope.data.candidate=$scope.assignment.selection.marketplaceMember.application.candidate,loadWeeklyTimesheets($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date,$scope.data.isTimesheetAccessFrmCache),$scope.data.isEnforcerUser||(loadMemberFourWeeksTrackerData($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date),loadTrackerData($scope.data.assignmentId,$scope.data.periodType,$scope.data.date)),$scope.setUsedMeetingTimeForCurrentWeek(),$scope.setMeetingTimeLimitText()})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}function loadTrackerData(assignemntId,periodBase,date){$scope.ui.isTrackerDataLoading=!0;var formatedDate=$filter("date")(date,"yyyy-MM-dd","UTC");AssignmentService.getMemberProductivity({id:assignemntId,type:periodBase,date:formatedDate}).$promise.then(function(res){$scope.memberTrackerData=res,processApplications()})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isTrackerDataLoading=!1})}function loadWeeklyTimesheets(teamId,userId,date,isCacheAccess){$scope.ui.isTeamsheetsLoading=!0;var managerId=null;$scope.data.isManagerUser&&(managerId=$scope.assignment.manager.id);var req={teamId:teamId,managerId:managerId,userId:userId,date:$filter("date")(date,"yyyy-MM-dd"),isCacheAccess:isCacheAccess};AssignmentService.getWeeklyTimeSheets(req).$promise.then(function(resArr){var res=resArr[0];if(res[0]){$scope.weeklyTimesheets=res[0];var loggedTime=Math.round(60*$scope.weeklyTimesheets.totalHours);$scope.printableTime=Math.floor(loggedTime/60)+" hours ";var minutes=loggedTime%60;minutes>0&&($scope.printableTime+=minutes+" minutes");var maxLogedForDay=($scope.weeklyTimesheets.stats||[]).reduce(function(ret,x){return x.hours>ret?x.hours:ret},0);maxLogedForDay>16?$scope.data.hoursRange=$scope.data.hoursRange20:maxLogedForDay>12?$scope.data.hoursRange=$scope.data.hoursRange16:maxLogedForDay>10?$scope.data.hoursRange=$scope.data.hoursRange12:maxLogedForDay>8?$scope.data.hoursRange=$scope.data.hoursRange10:$scope.data.hoursRange=$scope.data.hoursRange8}else $scope.weeklyTimesheets={},$scope.printableTime="0 hours",$scope.timeSheetTotalHours=0,$scope.data.hoursRange=$scope.data.hoursRange8})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isTeamsheetsLoading=!1,$scope.data.isTimesheetAccessFrmCache=!0})}function loadMemberFourWeeksTrackerData(teamId,userId,date){$scope.ui.isTrackerData4WeeksLoading=!0;var managerId=null;$scope.data.isManagerUser&&(managerId=$scope.assignment.manager.id);var req={teamId:teamId,managerId:managerId,userId:userId,date:$filter("date")(date,"yyyy-MM-dd")};AssignmentService.getMonthlyTimeSheets(req).$promise.then(function(res){if(res&&res.length>0){$scope.memberFourWeeksData=res;var maxTotalHours=0;$scope.memberFourWeeksData.forEach(function(week,i){var st=moment().startOf("isoweek").subtract(i,"w").format("MMM DD"),end=moment().endOf("isoweek").subtract(i,"w").format("MMM DD"),weekTitle=st+" - "+end;week[0]?week[0].weekTitle=weekTitle:week[0]={weekTitle:weekTitle,totalHours:0},week[0].totalHours>maxTotalHours&&(maxTotalHours=week[0].totalHours)}),maxTotalHours>70?$scope.data.weeksRange=$scope.data.weekRange80:maxTotalHours>60?$scope.data.weeksRange=$scope.data.weekRange70:maxTotalHours>50?$scope.data.weeksRange=$scope.data.weekRange60:maxTotalHours>40?$scope.data.weeksRange=$scope.data.weekRange50:$scope.data.weeksRange=$scope.data.weekRange40}else $scope.memberFourWeeksData=[],$scope.data.weeksRange=$scope.data.weekRange40})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isTrackerData4WeeksLoading=!1})}function initAssignment(){if($scope.data.offset=TimeUtils.formatUtcOffset($scope.assignment.selection.marketplaceMember.application.candidate.location.timeZone.offset),$scope.assignment.lengthInDays){var lengthInDays=$scope.assignment.lengthInDays,currentDate=new Date,diff=UtilsService.daysDiff(currentDate,$scope.assignment.startDate);diff<lengthInDays&&($scope.data.contractTime=(lengthInDays-diff)/30)}}function processApplications(){if($scope.memberTrackerData.byCategory&&$scope.memberTrackerData.byCategory.length>0){var categories=$scope.memberTrackerData.byCategory,arr=[];(categories||[]).forEach(function(c){(c.applications||[]).forEach(function(app){if(angular.isObject(app)&&angular.isDefined(app.applicationName)){var mainAppName=app.applicationName;angular.isDefined(app.xoApplication)&&(mainAppName=app.xoApplication.name);var accApplication=arr[mainAppName];(null===accApplication||angular.isUndefined(accApplication))&&(accApplication={name:mainAppName,time:0},angular.isDefined(app.xoActivity)?accApplication.category=app.xoActivity:accApplication.category={name:"Other",color:"grey"},arr[mainAppName]=accApplication),accApplication.time=accApplication.time+app.totalTime}})});var apps=[];for(var key in arr)apps.push(arr[key]);$scope.trackedApplications=apps.sort(function(a,b){return b.time-a.time});var maxTime=$scope.trackedApplications[0].time;maxTime/60<8?$scope.data.applicationsRange=$scope.data.applicationsRange10:maxTime/60<20?$scope.data.applicationsRange=$scope.data.applicationsRange20:$scope.data.applicationsRange=$scope.data.applicationsRange40}else $scope.trackedApplications=[]}function reloadTimeTracker(){angular.isDefined($scope.data.assignmentId)&&($scope.memberTrackerData=null,$scope.formatedMemberData={maxCatPercentage:0},angular.isObject($scope.assignment)&&loadWeeklyTimesheets($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date,$scope.data.isTimesheetAccessFrmCache),$scope.data.isEnforcerUser||loadTrackerData($scope.data.assignmentId,$scope.data.periodType,$scope.data.date))}function getCurrentMonthTitle(){var dt=new Date,dayOfWeek=0===dt.getDay()?6:dt.getDay()-1,first=new Date(dt.setDate(dt.getDate()-dayOfWeek)),lastDay=new Date(dt.setDate(first.getDate()+6)),firstOfMonth=new Date(dt.setDate(dt.getDate()-21));dayOfWeek=0===firstOfMonth.getDay()?6:firstOfMonth.getDay()-1;var firstDay=new Date(firstOfMonth.setDate(firstOfMonth.getDate()-dayOfWeek)),monthTitle=$filter("dateSuffix")(firstDay)+" - "+$filter("dateSuffix")(lastDay);return monthTitle}function checkLastCacheUpdate(){angular.isUndefined($cookies.lastCacheUpdate)?$cookies.lastCacheUpdate=(new Date).getTime():(new Date).getTime()-$cookies.lastCacheUpdate>=6e5&&($cookies.lastCacheUpdate=(new Date).getTime(),$cacheFactory.get("$http").removeAll())}function isFeatureEnabled(assignment,feature){return!(assignment.disabledFeatures&&assignment.disabledFeatures.length>0&&assignment.disabledFeatures.indexOf(feature)>-1)}if($scope.Math=window.Math,$scope.data={isEnforcerUser:!1,isCompanyAdmin:!1,editTeam:!1,newTeam:null,offset:null,monthTitle:null,weeks:[],timeZoneOffsets:[],diary:[],autoTrackedTimeLogged:"00:00",manualTimeLogged:"00:00",idleTimeLogged:"00:00",disputedTimeLogged:"00:00",overTimeLogged:"00:00",billableTimeLogged:"00:00",isTimesheetAccessFrmCache:!0,selectedTC:[],checkAllTC:{},periodType:"weekly",date:new Date,today:new Date,logbookDate:moment(new Date).toDate(),startOfCurrentWeek:moment().startOf("week").toDate(),isToday:!0,isCurrentWeek:!0,isCurrentMonth:!0,assignmentId:void 0,weekRange40:{hoursName:["10h","20h","30h","40h"],width:"25%",hours:40},weekRange50:{hoursName:["10h","20h","30h","40h","50h"],width:"20%",hours:50},weekRange60:{hoursName:["10h","20h","30h","40h","50h","60h"],width:"16.66%",hours:60},weekRange70:{hoursName:["10h","20h","30h","40h","50h","60h","70h"],width:"14.28%",hours:70},weekRange80:{hoursName:["10h","20h","30h","40h","50h","60h","70h","80h"],width:"12.5%",hours:80},hoursRange8:{hoursName:[1,2,3,4,5,6,7,8],rowHeight:"30px",hours:8},hoursRange10:{hoursName:[1,2,3,4,5,6,7,8,9,10],rowHeight:"24px",hours:10},hoursRange12:{hoursName:[1,2,3,4,5,6,7,8,9,10,11,12],rowHeight:"20px",hours:12},hoursRange16:{hoursName:[2,4,6,8,10,12,14,16],rowHeight:"30px",hours:16},hoursRange20:{hoursName:[2,4,6,8,10,12,14,16,18,20],rowHeight:"24px",hours:20},applicationsRange60:{hoursName:[15,30,45,60],hours:60},applicationsRange40:{hoursName:[10,20,30,40],hours:40},applicationsRange20:{hoursName:[5,10,15,20],hours:20},applicationsRange10:{hoursName:[2.5,5,7.5,10],hours:10},timeLimitBox:{hours:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],minutes:[0,10,20,30,40,50]},hoursRange:{},weeksRange:{},applicationsRange:{},displayTimecards:"ALL",prod:{selectedTime:"LOCAL",viewMode:"Advanced",viewType:"Time",periodType:"Daily",fLoad:!1},teams:[],companies:[],selteamid:null,selAssignment:null,urlParams:{},selTimecard:null,teamIds:[],companyIds:[],enforcerReportType:"HOURS_WORKED"},$scope.slotsName="contractorTimeSlots",$scope.PRODUCTIVITY_THRESHOLD=10,$scope.dateOptions={showWeeks:!1,startingDay:1},!angular.isDefined($scope.data.cachedDiary)){var id=0;angular.isDefined($routeParams.id)&&(id=$routeParams.id);try{$scope.data.cachedDiary=$cacheFactory("diaryCacheId_"+id)}catch(e){$scope.data.cachedDiary=$cacheFactory.get("diaryCacheId_"+id)}}$scope.setMeetingTimeLimitText=function(){if($scope.assignment.weeklyMeetingMinutesLimit&&$scope.assignment.weeklyMeetingMinutesLimit>0){var hours=Math.floor($scope.assignment.weeklyMeetingMinutesLimit/60),minutes=$scope.assignment.weeklyMeetingMinutesLimit%60;$scope.meetingTimeLimitText=hours+" h "+minutes+" min"}else $scope.meetingTimeLimitText="0 h 0 min"},$scope.setUsedMeetingTimeForCurrentWeek=function(){var date=UtilsService.getWeekOfDate(new Date,!1),params={id:$scope.assignment.id,type:"MEETING_TIME",startDate:$filter("date")(date.firstDate,"yyyy-MM-dd"),endDate:$filter("date")(date.lastDate,"yyyy-MM-dd")};AssignmentService.getUsedMeetingTimeText(params).$promise.then(function(resp){resp&&resp.meetingTime&&($scope.meetingTimeUsedText=resp.meetingTime)})["catch"](function(err){showMessage("alert-danger",err.data.text)})},$scope.getTimezoneOffsets=function(){var manager,contractor,timezones=[],utc={name:"UTC",niceName:"UTC: 00:00h",id:null,hourlyOffset:"00:00",offset:0};if(angular.isObject($scope.assignment)){var a=$scope.assignment;angular.isDefined(a.manager)&&angular.isDefined(a.manager.location)&&angular.isDefined(a.manager.location.timeZone)&&angular.isDefined(a.manager.location.timeZone.hourlyOffset)&&(manager=angular.copy(a.manager.location.timeZone),manager.niceName="Manager: "+manager.hourlyOffset+"h"),angular.isDefined(a.selection)&&angular.isDefined(a.selection.marketplaceMember)&&angular.isDefined(a.selection.marketplaceMember.application)&&angular.isDefined(a.selection.marketplaceMember.application.candidate)&&angular.isDefined(a.selection.marketplaceMember.application.candidate.location)&&angular.isDefined(a.selection.marketplaceMember.application.candidate.location.timeZone)&&angular.isDefined(a.selection.marketplaceMember.application.candidate.location.timeZone.hourlyOffset)&&(contractor=a.selection.marketplaceMember.application.candidate.location.timeZone,contractor.niceName="Contractor: "+contractor.hourlyOffset+"h")}var p=function(timezone,array){return void 0!==timezone&&array.push(timezone),angular.isDefined($scope.data.timezone)||($scope.data.timezone=timezone),array};return $scope.data.timeZoneOffsets=timezones,angular.isObject($scope.user)&&($scope.user.avatarTypes.indexOf("CANDIDATE")>-1||$scope.data.isEnforcerUser?timezones=p(contractor,timezones):(timezones=p(manager,timezones),timezones=p(contractor,timezones))),timezones=p(utc,timezones)},$scope.ui={isTeamListLoading:!1,isMemberListLoading:!1,isLoading:!0,isWeeklyDP:!1,isProdDP:!1,isLogDP:!1,isProdLoading:!1,isLogbookLoading:!1,showfPicker:!1,showtPicker:!1,hasTimecardSelected:!1,onlyIdleTC:!1,onlyDisputedTC:!1,isListView:!1,isListViewExpand:!0,isCheckedAllTC:!1,onlyNonDisputedTC:!1,isMemberSearchLoading:!1},$scope.changeWeek=function(next){var updated=moment($scope.data.date).add(next,"w").startOf("isoweek").toDate();updated.getTime()<(new Date).getTime()&&($scope.data.date=updated,$scope.data.logbookDate=updated)},$scope.printTime=function(time,h,m){var r,t=Math.round(60*time),min=t%60;return r=Math.floor(t/60)+h,min>0&&(r+=min+m),r},$scope.changeDay=function(next,logbook){if("Weekly"===$scope.data.prod.periodType&&!logbook)return void $scope.changeWeek(next);var updated=moment($scope.data.logbookDate).add(next,"d").toDate();updated.getTime()<(new Date).getTime()&&($scope.data.logbookDate=updated)},$scope.viewSceenshotThumbnailImg=function(timecard){$scope.data.selTimecard=timecard,$scope.data.selHourformat="hh:mm a",null!==$scope.data.displayTimecards&&"24HOUR"===$scope.data.displayTimecards&&($scope.data.selHourformat="HH:mm")},$scope.viewSceenshotFullscreenImg=function(cb){cb(),angular.isDefined($scope.data.selTimecard)&&$scope.viewSceenshotImg("lg",$scope.data.selTimecard,"timecard-popup-large")},$scope.viewWebcamThumbnailImg=function(timecard){$scope.data.selTimecard=timecard},$scope.viewWebcamFullscreenImg=function(cb){cb(),angular.isDefined($scope.data.selTimecard)&&angular.isDefined($scope.data.selTimecard.webcam)&&$scope.viewWebcamImg($scope.data.selTimecard.webcam.url,"lg",$scope.data.selTimecard)},$scope.viewSceenshotImg=function(size,timecard,windowClass){var selSlideindex=0;$scope.data.sliderdiary.some(function(value,index){return selSlideindex=index,value.id===timecard.id});var slides=$scope.data.sliderdiary,hourformat="hh:mm a";"24HOUR"===$scope.data.displayTimecards&&(hourformat="HH:mm"),windowClass=!windowClass&&timecard.isManual?"timecard-popup memo-modal":windowClass?windowClass:"timecard-popup",windowClass+=" team-member",size=timecard.isManual?"sm":size,$uibModal.open({templateUrl:"view-work-diary-image.tpl.html",controller:ViewScreenshotCtrl,backdrop:"false",windowClass:windowClass,resolve:{timecard:function(){return timecard},slides:function(){return slides},selSlideindex:function(){return selSlideindex},hourformat:function(){return hourformat}},size:size})},$scope.viewWebcamImg=function(imageSource,size,timecard){if(imageSource){var hourformat="hh:mm a",fullDateHourformat="MMM, dd yyyy hh:mm a";"24HOUR"===$scope.data.displayTimecards&&(hourformat="HH:mm",fullDateHourformat="MMM, dd yyyy HH:mm"),$uibModal.open({templateUrl:"view-work-diary-webcam-image.tpl.html",controller:ViewCtrl,backdrop:"false",windowClass:"timecard-popup",resolve:{image:function(){return imageSource},timecard:function(){return timecard},hourformat:function(){return hourformat},fullDateHourformat:function(){return fullDateHourformat}},size:size})}},$scope.detailsModal=function(tc){var hourformat="hh:mm a",fullDateHourformat="MMM, dd yyyy hh:mm a";"24HOUR"===$scope.data.displayTimecards&&(hourformat="HH:mm",fullDateHourformat="MMM, dd yyyy HH:mm"),
$uibModal.open({templateUrl:"timecard-details.tpl.html",controller:ViewCtrl,backdrop:"false",windowClass:"team-member",resolve:{image:function(){return null},timecard:function(){return tc&&tc.events&&_.map(tc.events,function(ev){var offset=$scope.data.timezone.offset;return ev.localDate=convertToZone(ev.date,offset),ev}),tc},hourformat:function(){return hourformat},fullDateHourformat:function(){return fullDateHourformat}},size:"lg"})};var ViewScreenshotCtrl=function($scope,$uibModalInstance,timecard,slides,selSlideindex,hourformat){$scope.Math=window.Math,timecard&&($scope.timecard=timecard),$scope.slides=slides,$scope.selSlideindex=selSlideindex,$scope.hourformat=hourformat,$scope.timecard&&$scope.timecard.screenshot&&$scope.timecard.screenshot.url?$scope.imgLoading=!0:$scope.imgLoading=!1,$document.on("keydown",function(evt){$scope.keycode=evt.which,$scope.keycode&&39===$scope.keycode&&$scope.selSlideindex<$scope.slides.length-1?$scope.nextSlide():$scope.keycode&&37===$scope.keycode&&$scope.selSlideindex>0&&$scope.prevSlide(),$scope.$apply()}),$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.nextSlide=function(){$scope.selSlideindex>=$scope.slides.length-1?$scope.selSlideindex=0:$scope.selSlideindex=$scope.selSlideindex+1,$scope.timecard=$scope.slides[$scope.selSlideindex],$scope.timecard&&$scope.timecard.screenshot&&$scope.timecard.screenshot.url?$scope.imgLoading=!0:$scope.imgLoading=!1},$scope.prevSlide=function(){0===$scope.selSlideindex?$scope.selSlideindex=$scope.slides.length-1:$scope.selSlideindex=$scope.selSlideindex-1,$scope.timecard=$scope.slides[$scope.selSlideindex],$scope.timecard&&$scope.timecard.screenshot&&$scope.timecard.screenshot.url?$scope.imgLoading=!0:$scope.imgLoading=!1},$scope.fullScreenSize=function(){angular.element(".modal ").removeClass("timecard-popup"),angular.element(".modal ").addClass("timecard-popup-large")},$scope.imageReady=function(){$scope.imgLoading=!1}},ViewCtrl=function($scope,$uibModalInstance,image,timecard,hourformat,fullDateHourformat){$scope.Math=window.Math,$scope.hourformat=hourformat,$scope.fullDateHourformat=fullDateHourformat,$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.image=image,timecard&&($scope.timecard=timecard)},loadDiary=function(useCache){if(angular.isDefined($scope.data.assignmentId)){$scope.ui.isLogbookLoading=!0;var date=$scope.data.logbookDate,formattedDate=moment(date).startOf("day").format("YYYY-MM-DD"),timeZoneId=$scope.data.timezone.id,params={id:$scope.data.assignmentId,date:formattedDate,timeZoneId:timeZoneId},save=function(e){var date=$scope.data.logbookDate,todaysDate=new Date;date.setHours(0,0,0,0)!==todaysDate.setHours(0,0,0,0)&&$scope.data.cachedDiary.put(date,e),initDiaryElements(e)},filterTimecards=function(diary,predicate){return _.chain(diary).filter(predicate).groupBy(function(element,index){return Math.floor(index/6)}).toArray().map(function(timecards){return{hour:moment(timecards[0].localDate).format("hh a"),timecards:timecards}}).value()},filterTimecardsByType=function(diary,predicate){return _.chain(diary).filter(predicate).toArray().value()},getDateWithOffset=function(date,offset){return moment(moment(date).valueOf()).utcOffset(offset/6e4).toDate()},initDiaryElements=function(diary){diary=_.map(diary,function(tc){var offset=$scope.data.timezone.offset;return tc.localDate=convertToZone(tc.date,offset),tc.events=_.map(tc.events,function(ev){return ev.localDate=convertToZone(ev.date,offset),ev}),setTimecardFlags(tc),tc}),$scope.data.sliderdiary=_.chain(diary).sortBy("date").toArray().value();var idleDiary=[],manualDiary=[],disputedDiary=[],autoTrackedDiary=[],overtimeDiary=[];idleDiary=filterTimecardsByType(diary,function(tc){return tc.isIdle}),manualDiary=filterTimecardsByType(diary,function(tc){return tc.isManual}),disputedDiary=filterTimecardsByType(diary,function(tc){return tc.isDisputed}),autoTrackedDiary=filterTimecardsByType(diary,function(tc){return tc.autoTracker}),overtimeDiary=filterTimecardsByType(diary,function(tc){return tc.overtime}),$scope.data.autoTrackedTimeLogged=calculateTime(10*autoTrackedDiary.length),$scope.data.manualTimeLogged=calculateTime(10*manualDiary.length),$scope.data.idleTimeLogged=calculateTime(10*idleDiary.length),$scope.data.disputedTimeLogged=calculateTime(10*disputedDiary.length),$scope.data.overTimeLogged=calculateTime(10*overtimeDiary.length);var totalBillingTime=autoTrackedDiary.length+manualDiary.length-(idleDiary.length+disputedDiary.length+overtimeDiary.length);if($scope.data.billableTimeLogged=calculateTime(10*totalBillingTime),"LOW_ACTIVITY"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.activityLevel<=10&&!tc.isIdle&&tc.autoTracker});else if("IDLE"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isIdle});else if("MANUAL"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isManual});else if("MEETING"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isMeeting});else if("DISPUTED"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isDisputed});else{var hourFormt="hh a";"24HOUR"===$scope.data.displayTimecards&&(hourFormt="HH"),$scope.data.diary=_.chain(diary).sortBy("date").groupBy(function(t){return getDateWithOffset(t.localDate,t.offset).getHours()}).map(function(timecards){var tcArray=new Array(6);return _.each(timecards,function(tc){tcArray[Math.floor(getDateWithOffset(tc.localDate,tc.offset).getMinutes()/10)]=tc}),{hour:moment(timecards[0].localDate).format(hourFormt),timecards:tcArray}}).value()}$scope.ui.isLogbookLoading=!1,$scope.ui.hasTimecardSelected=!1,$scope.ui.onlyIdleTC=!1,$scope.ui.onlyDisputedTC=!1,$scope.ui.onlyNonDisputedTC=!1,$scope.ui.isCheckedAllTC=!1},err=function(e){showMessage("alert-danger",e.data.text),$scope.ui.isLogbookLoading=!1};date.setHours(0,0,0,0),useCache&&$scope.data.cachedDiary.get(date)?initDiaryElements($scope.data.cachedDiary.get(date)):(AssignmentService.workDiary(params,save,err),$scope.data.date=params.date)}};$scope.getCurrentTime=function(){if(angular.isDefined($scope.data.candidate)){var offset=$scope.data.candidate.location.timeZone.offset;return offset?TimeUtils.getTimeByTimezoneOffset(offset):TimeUtils.getUTCTime()}},$scope.$watch("data.date",function(newVal,oldVal){$scope.data.currentWeekStart=moment().startOf("isoweek").toDate(),$scope.data.weekStart=moment(newVal).startOf("isoweek").toDate(),$scope.data.weekEnd=moment(newVal).endOf("isoweek").toDate(),$scope.data.prvWeekStart=moment().weekday(-7),$scope.data.prvWeekEnd=moment().weekday(0),newVal&&oldVal&&"weekly"===$scope.data.periodType&&UtilsService.isInSameWeek(newVal,oldVal)||newVal&&oldVal&&"monthly"===$scope.data.periodType&&newVal.getMonth()===oldVal.getMonth()||(0===UtilsService.daysDiff(newVal,$scope.data.today)?($scope.data.isToday=!0,$scope.data.isCurrentWeek=!0,$scope.data.isCurrentMonth=!0):UtilsService.isInSameWeek(newVal,$scope.data.today)?($scope.data.isToday=!1,$scope.data.isCurrentWeek=!0,$scope.data.isCurrentMonth=!0):angular.isObject(newVal)&&newVal.getMonth()===$scope.data.today.getMonth()?($scope.data.isToday=!1,$scope.data.isCurrentWeek=!1,$scope.data.isCurrentMonth=!0):($scope.data.isToday=!1,$scope.data.isCurrentWeek=!1,$scope.data.isCurrentMonth=!1),reloadTimeTracker())}),$scope.$watch("data.periodType",function(){reloadTimeTracker()}),$scope.saveUpdateProgress=function(form){form.$valid&&($scope.ui.isLoading=!0,AssignmentService.edit({id:$scope.assignment.id},$scope.assignment).$promise.then(function(res){$scope.assignment=res,initAssignment()})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1}))},$scope.importProfile=function(){$uibModal.open({templateUrl:"overwrite-profile-confirmation.tpl.html",controller:"LinkedInProfileImportCtrl",windowClass:"center-modal"})};var infoModal=null;$scope.infoModal=function(){infoModal=$uibModal.open({templateUrl:"productivity-info-modal.tpl.html",windowClass:"productivity-info-modal",scope:$scope,size:"lg"})},$scope.gotIt=function(){infoModal.close()},$scope.checkAllGroupTC=function(hourGroup){for(var i=0;hourGroup.timecards.length>i;i++)angular.isDefined(hourGroup.timecards[i])&&(!hourGroup.isSelected||hourGroup.timecards[i].isDisputeResolved||hourGroup.timecards[i].isIdle?hourGroup.timecards[i].isSelected=!1:hourGroup.timecards[i].isDisputed||$scope.ui.onlyDisputedTC?hourGroup.timecards[i].isDisputed&&!$scope.ui.onlyNonDisputedTC&&(hourGroup.timecards[i].isSelected=!0):hourGroup.timecards[i].isSelected=!0,$scope.checkSelectedItems())},$scope.checkSelectedItems=function(){var i,iLock,dLock,sLock,diary=[];for(i=0;$scope.data.diary.length>i;i++)diary.push($scope.data.diary[i].timecards);var tc=_.filter(_.flatten(diary),function(t){if(angular.isDefined(t))return t.isSelected});if($scope.data.selectedTC=tc,tc.length>0){for($scope.ui.hasTimecardSelected=!0,i=0;tc.length>i;i++)tc[i].isIdle&&(iLock=!0),tc[i].isDisputed&&(dLock=!0),!tc[i].isIdle&!tc[i].isDisputed&&(sLock=!0);$scope.ui.onlyIdleTC=!!(iLock&!dLock&!sLock),$scope.ui.onlyDisputedTC=!!(!iLock&dLock&!sLock),$scope.ui.onlyNonDisputedTC=!!(!iLock&!dLock&sLock)}else $scope.ui.hasTimecardSelected=!1,$scope.ui.onlyIdleTC=!1,$scope.ui.onlyDisputedTC=!1,$scope.ui.onlyNonDisputedTC=!1},$scope.invokeDeleteCardsConfirmation=function(){if($scope.data.diary){var hourformat="hh:mm a";"24HOUR"===$scope.data.displayTimecards&&(hourformat="HH:mm");var timecardsToDelete=[];$scope.data.diary.forEach(function(diary){diary.timecards.forEach(function(t){t.isSelected&&timecardsToDelete.push(t)})});var modalInstance=$uibModal.open({templateUrl:"delete-cards-confirm.tpl.html",controller:ConfirmDeleteCardsModalInstanceCtrl,resolve:{timecardsToDelete:function(){return timecardsToDelete},hourformat:function(){return hourformat}},backdrop:"static"});modalInstance.result.then(function(){deleteSelectedTimeCards(timecardsToDelete)})}},$scope.invokeChangeNotIdleCardsConfirmation=function(){if($scope.data.diary&&$scope.ui.onlyIdleTC){var timecards=[],comment={};$scope.data.diary.forEach(function(diary){diary.timecards.forEach(function(t){t.isSelected&&timecards.push(t)})});var modalInstance=$uibModal.open({templateUrl:"not-idle-time-cards-confirm.tpl.html",controller:ConfirmNotIdleCardsModalInstanceCtrl,resolve:{timecards:function(){return timecards},comment:function(){return comment}},backdrop:"static"});modalInstance.result.then(function(){markSelectedTimeCardsAsNotIdle(timecards,comment.value)})}};var ConfirmNotIdleCardsModalInstanceCtrl=function($scope,$uibModalInstance,timecards,comment){$scope.modalDiary=timecards.sort(function(t1,t2){return t1.date-t2.date}),$scope.comment=comment,$scope.confirm=function(){return $scope.comment.value&&""!==$scope.comment.value.trim()?void $uibModalInstance.close():void($scope.isFormInvalid=!0)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},ConfirmDeleteCardsModalInstanceCtrl=function($scope,$uibModalInstance,timecardsToDelete,hourformat){$scope.modalDiary=timecardsToDelete.sort(function(t1,t2){return t1.date-t2.date}),$scope.hourformat=hourformat,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},markSelectedTimeCardsAsNotIdle=function(timecards,comment){$scope.ui.isLogbookLoading=!0;var timecardIds=timecards.map(function(t){return t.id}),params={id:$scope.assignment.id,action:"SET_MEETING_TIME",timecards:timecardIds,comment:comment};AssignmentService.changToMeetingTimeWorkdiaries(params).$promise.then(function(){$scope.ui.hasTimecardSelected=!1,loadDiary(!1),$scope.setUsedMeetingTimeForCurrentWeek()})["catch"](function(err){showMessage("alert-danger",err.data.text),$scope.ui.isLogbookLoading=!1})},deleteSelectedTimeCards=function(timecardsToDelete){$scope.ui.isLogbookLoading=!0,timecardsToDelete.forEach(function(t){delete t.actions,t.date=null}),AssignmentService.deleteWorkdiaries(timecardsToDelete).$promise.then(function(){$scope.ui.hasTimecardSelected=!1,$scope.data.isTimesheetAccessFrmCache=!1,loadDiary(!1),$scope.setUsedMeetingTimeForCurrentWeek()})["catch"](function(err){showMessage("alert-danger",err.data.text),$scope.ui.isLogbookLoading=!1})};$scope.invokeAddMemo=function(){var params={assignmentId:$scope.assignment.id},modalInstance=$uibModal.open({templateUrl:"add-memo.tpl.html",controller:ConfirmAddMemoModalInstanceCtrl,windowClass:"team-member",backdrop:"static",size:"sm",scope:$scope,resolve:{params:function(){return params}}});modalInstance.result.then(function(){addMemoTimeCards(params)})};var ConfirmAddMemoModalInstanceCtrl=function($scope,$uibModalInstance,params){$scope.fromTime=new Date($scope.data.logbookDate),$scope.fromTime.setHours(7,0),$scope.toTime=new Date($scope.data.logbookDate),$scope.toTime.setHours(7,30),$scope.hstep=1,$scope.mstep=10,$scope.ismeridian=!0,$scope.memoText="",$scope.isFormInvalid=!1,$scope.fChange=function(){$scope.toTime=$scope.fromTime.getTime()+18e5},$scope.confirm=function(){return $scope.memoText&&""!==$scope.memoText.trim()?(params.createDate=$filter("date")($scope.fromTime,"yyyy-MM-dd"),params.startTimeSel=$filter("date")($scope.fromTime,"HH:mm"),params.endTimeSel=$filter("date")($scope.toTime,"HH:mm"),params.startTime=params.createDate+" "+params.startTimeSel,params.startTime=moment(params.startTime).utc().utcOffset($scope.data.timezone.hourlyOffset).format(),angular.isDefined(params.endTimeSel)&&"00:00"===params.endTimeSel?params.endTime=moment(params.createDate).add(1,"days").utc().utcOffset($scope.data.timezone.hourlyOffset).format():(params.endTime=params.createDate+" "+params.endTimeSel,params.endTime=moment(params.endTime).utc().utcOffset($scope.data.timezone.hourlyOffset).format()),params.timeZoneId=$scope.assignment.selection.marketplaceMember.application.candidate.location.timeZone.id,params.memo=$scope.memoText,params.approved=!0,valExTimecards(params),void($scope.ui.wrongTR?setTimeout(function(){$scope.ui.wrongTR=!1},6e3):$uibModalInstance.close())):void($scope.isFormInvalid=!0)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},ChangeMeetingTimeLimitModalInstanceCtrl=function($scope,$uibModalInstance){if($scope.assignment.weeklyMeetingMinutesLimit&&$scope.assignment.weeklyMeetingMinutesLimit>0){var hours=Math.floor($scope.assignment.weeklyMeetingMinutesLimit/60),minutes=$scope.assignment.weeklyMeetingMinutesLimit%60;$scope.hourLimit=hours,$scope.minLimit=minutes}else $scope.hourLimit=0,$scope.minLimit=0;$scope.confirm=function(){$scope.ui.isMeetingTimeLoading=!0,$uibModalInstance.close();var meetingLimitTimeInMinutes=60*$scope.hourLimit+$scope.minLimit,params={id:$scope.assignment.id,weeklyMeetingMinutesLimit:meetingLimitTimeInMinutes,status:"ACTIVE"};AssignmentService.setMeetingTimeLimit(params).$promise.then(function(){$scope.assignment.weeklyMeetingMinutesLimit=meetingLimitTimeInMinutes,$scope.meetingTimeLimitText=$scope.setMeetingTimeLimitText(),$scope.ui.isMeetingTimeLoading=!1,$scope.data.isTimesheetAccessFrmCache=!1})["catch"](function(err){showMessage("alert-danger",err.data.text),$scope.ui.isMeetingTimeLoading=!1})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}};$scope.invokeChangeMeetingLimit=function(){var params={assignmentId:$scope.assignment.id};$uibModal.open({templateUrl:"change-meeting-time-limit.tpl.html",controller:ChangeMeetingTimeLimitModalInstanceCtrl,backdrop:"static",size:"sm",scope:$scope,resolve:{params:function(){return params}}})};var valExTimecards=function(p){if(new Date(p.endTime)>new Date)$scope.ui.wrongTR=!0,$scope.ui.wrongTRMessage="The time range can't be in the future";else if(new Date(p.startTime)>new Date(p.endTime))$scope.ui.wrongTR=!0,$scope.ui.wrongTRMessage="Invalid time range, end time should be greater than start time";else{var startTimeRange=new Date(p.startTime),endTimeRange=new Date(p.endTime);UtilsService.timecardRangeExists($scope.data.diary,startTimeRange,endTimeRange)&&($scope.ui.wrongTR=!0,endTimeRange.getMinutes()-new Date(p.startTime).getMinutes()>10?$scope.ui.wrongTRMessage="Time cards for the selected time range already exist!":$scope.ui.wrongTRMessage="Time card for the selected time range already exists!")}},addMemoTimeCards=function(memo){AssignmentService.addMemo(memo).$promise.then(function(){$scope.data.isTimesheetAccessFrmCache=!1,loadDiary(!1)})["catch"](function(err){$scope.memomsg={clazz:"alert-danger",show:!0,message:err.data.text},setTimeout(function(){$scope.memomsg.show=!1},6e3)})};$scope.getWeekText=function(date){var week=UtilsService.getWeekOfDate(date,!1);return $filter("date")(week.firstDate,"MMM d")+" - "+$filter("date")(week.lastDate,"MMM d, yyyy")};var timeTable=function(a,p){if(angular.isDefined(a)&&angular.isDefined(p)){var i,r=[],c=a;for(i=0;i<24;i++)i>=12&&(c=p),0===i||12===i?r.push("12:00 "+c):r.push(i%12+":00 "+c);return r}},str2Time=function(t){t=moment(t).utc();var ap=t.hours()<12?"am":"pm",m=0===t.minutes()?"00":t.minutes();return t.hours()+":"+m+" "+ap},prodFinal=function(){var top=angular.element(".plan .overflowAllh"),bottom=angular.element(".activity .overflowXa");bottom.bind("scroll",function(el){top.scrollLeft(angular.element(el.target).scrollLeft())})},groupPlannedActivitiesPercent=function(i){for(var perGrouped=[],tmp={},c=0,totalTime=0;i--;)if(angular.isDefined($scope.data.prod.plan[i])&&angular.isDefined($scope.data.prod.plan[i].activity)&&null!==$scope.data.prod.plan[i].activity){var a=$scope.data.prod.plan[i].activity;tmp[a.name]?(perGrouped[tmp[a.name][0]].time=perGrouped[tmp[a.name][0]].time+10,totalTime+=10,tmp[a.name].push([])):(tmp[a.name]=[],tmp[a.name].push(c),a.time=10,totalTime+=10,perGrouped[c]=a,c++)}return $scope.data.prod.planTotalTime=totalTime<=480?480:totalTime,$filter("orderBy")(perGrouped||[],"time",!0)},groupActivities=function(arr){for(var i=arr.length,j=3,actGrouped=[{name:"PRODUCTIVE",color:"#3fa9fe",time:0,act:[]},{name:"COMMUNICATION",color:"#ffd54f",time:0,act:[]},{name:"UNPRODUCTIVE",color:"#ef5350",time:0,act:[]}],sortOrder={PRODUCTIVE:0,COMMUNICATION:1,UNPRODUCTIVE:2};i--;)angular.isDefined(arr[i])&&(actGrouped[sortOrder[arr[i].category]].act.push(arr[i]),actGrouped[sortOrder[arr[i].category]].time=actGrouped[sortOrder[arr[i].category]].time+arr[i].time);for(;j--;)actGrouped[j].act=$filter("orderBy")(actGrouped[j].act||[],"name");return actGrouped},sortBySpendTimeAndGroup=function(obj){return obj.grouping.advancedGroups=$filter("orderBy")(obj.grouping.advancedGroups||[],"spentTime",!0),obj.grouping.simpleGroups.reverse(),obj},loadProductivity=function(id){function getActivity(s){var deferred=$q.defer();checkLastCacheUpdate();var promises=[],candidateAv=$scope.user.userAvatars.filter(function(a){return"CANDIDATE"===a.type||"MIGRATED_CANDIDATE"===a.type}).pop();for(candidateAv&&$scope.assignment.selection.marketplaceMember.application.candidate.id===candidateAv.id&&delete s.teamId,s.date=moment($scope.data.logbookDate).format("YYYY-MM-DD");promises.length<3;)1===promises.length&&(s.groups="groups"),2===promises.length&&(s.weekly=!0),promises.push(ProductivityService.readTeamActivities(s).$promise);return $q.all(promises).then(function(r){if(angular.isUndefined(r[0][0])){if($scope.ui.isProdLoading=!1,$scope.data.prod.maxActTime=$scope.data.prod.planTotalTime<480?480:$scope.data.prod.planTotalTime,"Weekly"===$scope.data.prod.periodType){var max=5*$scope.data.prod.planTotalTime;$scope.data.prod.maxActTime=max<=2400?2400:max}return $scope.data.prod.activityTime=[],$scope.data.prod.activityPerc=[],$scope.data.prod.activityPercArch=[],$scope.data.prod.activityPercWeek=[],void(angular.isDefined(r[2][0])&&($scope.data.prod.activityPercWeek=sortBySpendTimeAndGroup(r[2][0]),$scope.data.prod.activityPerc=$scope.data.prod.activityPercWeek,$scope.data.prod.maxActTime=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPerc.grouping.totalTrackedTime)))}if($scope.data.prod.activityTime=r[0][0],$scope.data.prod.activityPerc=sortBySpendTimeAndGroup(r[1][0]),$scope.data.prod.activityPercArch=$scope.data.prod.activityPerc,angular.isDefined(r[2][0])?$scope.data.prod.activityPercWeek=sortBySpendTimeAndGroup(r[2][0]):$scope.data.prod.activityPercWeek=$scope.data.prod.activityPerc,$scope.data.prod.maxActTime=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPerc.grouping.totalTrackedTime),$scope.data.prod.maxActTime=$scope.data.prod.maxActTime<480?480:$scope.data.prod.maxActTime,"Weekly"===$scope.data.prod.periodType){$scope.data.prod.activityPerc=$scope.data.prod.activityPercWeek;var maxplan=Math.max(5*$scope.data.prod.planTotalTime,$scope.data.prod.activityPercWeek.grouping.totalTrackedTime);$scope.data.prod.maxActTime=maxplan<=2400?2400:maxplan}$scope.ui.isProdLoading=!1,deferred.resolve("All was fine obtaining activities")})["catch"](function(err){showMessage("alert-danger",err.data.text),$scope.ui.isProdLoading=!1,deferred.reject("Error obtaining activities")}),deferred.promise}function getPlannedActivities(){var deferred=$q.defer();return ProductivityService.readTeamPlannedActivities(s).$promise.then(function(p){for(var i=144;i--;)angular.isDefined(p[i])&&(p[i].startTime=str2Time(p[i].startTime),p[i].endTime=str2Time(p[i].endTime));$scope.data.prod.plan=p,$scope.data.prod.planPerc=groupPlannedActivitiesPercent(144),$scope.data.prod.planPercSimple=groupActivities($scope.data.prod.planPerc),$scope.data.prod.timeHead=timeTable("AM","PM"),$scope.data.prod.fLoad=!1,deferred.resolve("Planned activities obtained")})["catch"](function(err){showMessage("alert-danger",err.data.text),deferred.reject("Error obtaining planned activities")}),deferred.promise}$scope.ui.isProdLoading=!0,!angular.isDefined(id)&&angular.isDefined($scope.assignment)&&(id=$scope.assignment.id),$scope.data.prod.fLoad=!0;var managerId=null;$scope.data.isManagerUser&&(managerId=$scope.assignment.manager.id);var s={assignmentId:id,teamId:$scope.assignment.team.id,managerId:managerId};$scope.user&&$scope.user.avatarTypes.indexOf("CANDIDATE")<0&&delete s.assignmentId,s.teamId=$scope.assignment.team.id,getPlannedActivities().then(function(){return getActivity(s)})};$scope.helpersPopup=function(e,b){if(!b)return $scope.data.prod.selectedSlot=null,$scope.data.prod.selectedGroup=null,void($scope.data.prod.popup.open=!1);var x,y,height=115,prodDiv=angular.element(".productivity > .relative").offset();if($scope.data.prod.selectedSlotPlan||(height=185),null!==$scope.data.prod.selectedGroup&&angular.isDefined($scope.data.prod.selectedGroup.groupItems)){var itemsHeight=$scope.data.prod.selectedGroup.groupItems.length>10?10:$scope.data.prod.selectedGroup.groupItems.length;height=145+20*itemsHeight}angular.isDefined($scope.data.prod.selectedGroup)&&$scope.data.prod.selectedSlotPlan&&null===$scope.data.prod.selectedSlot&&(height=85),e.pageX+230-e.view.innerWidth>115&&(e.pageX=e.view.innerWidth-130,e.offsetX=0),e.view.innerWidth<1520&&e.pageX<115&&(e.pageX=115,e.offsetX=0),x=e.currentTarget.clientWidth/2+e.pageX-prodDiv.left-e.offsetX-117,y=e.pageY-prodDiv.top-e.offsetY-height-20,$scope.data.prod.popup={x:x,y:y,corner:45,open:!0}},$scope.initEnforcer=function(){CurrentUser.get(function(user){if($scope.user=user,$scope.user&&$scope.user.avatarTypes.indexOf("ENFORCER")>-1)return $scope.data.urlParams=$location.search(),$scope.loadTeams(),$scope.ui.isListView=!0,void($scope.data.isEnforcerUser=!0)})},$scope.loadTeams=function(){$scope.data.assignments=[],$scope.data.teams=[],$scope.ui.isTeamListLoading=!0,TeamService.shallowlist({activeAssignments:!0,avatarType:"ENFORCER"},function(res){$scope.data.teams=res.sort(function(t1,t2){return t1.id-t2.id}),$scope.data.teams.forEach(function(t){$scope.data.teamIds.push(t.id)});var urlParams={};urlParams=$location.search(),angular.isDefined(urlParams.teamId)&&(urlParams.teamId&&"All"!==urlParams.teamId?($scope.data.selteamid=$scope.data.teams.filter(function(t){return parseInt(t.id+"",10)===parseInt(urlParams.teamId+"",10)})[0].id,$scope.loadMembers(0),$scope.setSelTeam()):urlParams.teamId&&"All"===urlParams.teamId&&($scope.data.selteamid="All",$scope.setSelTeam())),$scope.ui.isTeamListLoading=!1},function(err){showMessage("alert-danger",err.data.text),$scope.ui.isTeamListLoading=!1})},$scope.setSelTeam=function(){$scope.data.selteamid&&"All"!==$scope.data.selteamid?($scope.data.teamIds=[],$scope.data.teamIds.push($scope.data.selteamid)):($scope.data.teamIds=[],$scope.data.teams.forEach(function(t){$scope.data.teamIds.push(t.id)}))},$scope.generateWeeklyTimesheetReport=function(){if($scope.data.teamIds&&$scope.data.date){var teamIds=$scope.data.teamIds.join(),params={teamId:teamIds,date:$filter("date")($scope.data.date,"yyyy-MM-dd"),isCacheAccess:!1,reportType:$scope.data.enforcerReportType,avatarType:"ENFORCER"};DownloadService.download("/tracker/timesheet",params)}},$scope.loadMembers=function(page){$scope.assignment=null,$scope.data.assignments=[],$scope.data.selAssignment=null,$scope.ui.isMemberListLoading=!0;var limit=1e3,p=page||0,req={page:p,status:"ACTIVE",limit:limit,avatarType:"ENFORCER"};return null===$scope.data.selteamid?void($scope.ui.isMemberListLoading=!1):(req.teamId=parseInt($scope.data.selteamid+"",10),void AssignmentService.teamAssignments(req,function(data){angular.isArray(data.content)&&($scope.data.assignments=[],data.content.forEach(function(e){$scope.data.assignments.push(e)})),accessURLParams(),$scope.ui.isMemberListLoading=!1},function(err){showMessage("alert-danger",err.data.text),$scope.ui.isMemberListLoading=!1}))},$scope.searchMembers=function(){$scope.ui.isMemberSearchLoading=!0,$scope.data.searchedAssignments=[],$scope.data.searchedAssignmentsFilter=[],$("#searchContractorTxtBox").focus();var limit=200,p=0,req={page:p,status:"ACTIVE",limit:limit,avatarType:"ENFORCER"};return null===$scope.dynamicSearchCriteria||""===$scope.dynamicSearchCriteria?void($scope.ui.isMemberSearchLoading=!1):(req.dynamicCriteria=$scope.dynamicSearchCriteria,void AssignmentService.teamAssignments(req,function(data){angular.isArray(data.content)&&($scope.data.searchedAssignments=[],data.content.forEach(function(e){$scope.data.searchedAssignments.push(e)})),$scope.data.searchedAssignmentsFilter=angular.copy($scope.data.searchedAssignments),$scope.ui.isMemberSearchLoading=!1},function(err){$scope.ui.isMemberSearchLoading=!1,showMessage("alert-danger",err.data.text)}))};var accessURLParams=function(){var urlParams={};urlParams=$location.search(),angular.isDefined(urlParams.assignmentId)&&($scope.data.selAssignment=$scope.data.assignments.filter(function(a){return parseInt(a.id+"",10)===parseInt(urlParams.assignmentId+"",10)})[0].id,angular.isDefined($scope.data.selAssignment)&&null!==$scope.data.selAssignment&&($scope.data.date=new Date,$scope.loadMemberAssgnment())),angular.isDefined(urlParams.date)&&(moment(urlParams.date,"YYYY-MM-DD",!0).isValid()?($scope.data.date=moment(urlParams.date,"YYYY-MM-DD").toDate(),$scope.data.logbookDate=moment(urlParams.date,"YYYY-MM-DD").toDate()):($scope.data.date=new Date,$scope.data.logbookDate=moment($scope.data.date).toDate()))};$scope.loadMemberAssgnment=function(){$scope.data.selAssignment&&angular.isDefined($scope.data.selAssignment)&&($scope.assignment=null,$scope.data.displayTimecards="24HOUR",loadAssignment($scope.data.selAssignment,"ENFORCER"),angular.isDefined($scope.data.timeZoneOffsets[1])&&null!==$scope.data.timeZoneOffsets[1]&&($scope.data.timezone=$scope.data.timeZoneOffsets[1]))},$scope.loadSearchedAssignment=function(assignment){assignment&&angular.isDefined(assignment.id)&&angular.isDefined(assignment.team.id)&&($scope.data.selteamid=assignment.team.id,$scope.loadMembers(0),$scope.data.selAssignment=assignment.id,$scope.loadMemberAssgnment())},$scope.$watch("data.selteamid",function(v){angular.isDefined(v)&&null!==$scope.data.selteamid&&(parseInt($scope.data.urlParams.teamId+"",10)!==parseInt($scope.data.selteamid+"",10)&&($location.search("assignmentId",null),$location.search("date",null)),$location.search("teamId",$scope.data.selteamid))}),$scope.$watch("data.selAssignment",function(v){angular.isDefined(v)&&null!==$scope.data.selAssignment&&($location.search("assignmentId",$scope.data.selAssignment),$location.search("date",$filter("date")($scope.data.date,"yyyy-MM-dd")))});var ConfirmDisputeActionModalInstanceCtrl=function($scope,$uibModalInstance,params){$scope.disputeAction="DISPUTE_TIME"===params.action?"Dispute":"Resolve",$scope.disputComment="",$scope.disupteCategory="surfing",$scope.confirm=function(){params.comment=$scope.disputComment,params.disupteCategory=$scope.disupteCategory,$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},executeDisputeAction=function(params){$scope.ui.isLogbookLoading=!0,AssignmentService.changToMeetingTimeWorkdiaries(params).$promise.then(function(){$scope.ui.hasTimecardSelected=!1,$scope.data.isTimesheetAccessFrmCache=!1,loadDiary(!1),$scope.setUsedMeetingTimeForCurrentWeek()})["catch"](function(err){$scope.memomsg={clazz:"alert-danger",show:!0,message:err.data.text},setTimeout(function(){$scope.memomsg.show=!1},6e3),$scope.ui.isLogbookLoading=!1})};$scope.disputeIR=function(dispute){if($scope.data.selectedTC){var timecardIds=$scope.data.selectedTC.map(function(t){return t.id}),action=dispute?"DISPUTE_TIME":"RESOLVE_DISPUTE",params={id:$scope.assignment.id,action:action,timecards:timecardIds},modalInstance=$uibModal.open({templateUrl:"dispute-action-timecard.tpl.html",controller:ConfirmDisputeActionModalInstanceCtrl,resolve:{params:function(){return params}},backdrop:"static"});modalInstance.result.then(function(){executeDisputeAction(params)})}};var fixSubtitle=function(){var w=angular.element($window),fixIt=function(){w.scrollTop()>400?angular.element(".subtitleWrapper").addClass("fixed"):angular.element(".subtitleWrapper").removeClass("fixed")};w.bind("scroll",fixIt);var w1=angular.element($window),fixIt1=function(){w.scrollTop()>400?angular.element(".subtitleWrapperEnforcer").addClass("fixed"):angular.element(".subtitleWrapperEnforcer").removeClass("fixed")};w1.bind("scroll",fixIt1)};$scope.$watch("data.assignmentId",function(nid){!angular.isDefined(nid)||$scope.data.prod.fLoad||$scope.data.isEnforcerUser||(angular.element(".subtitleWrapper").removeClass("fixed"),loadProductivity(nid)),$scope.user&&$scope.user.avatarTypes.indexOf("ENFORCER")>-1&&angular.isDefined($scope.assignment)&&$scope.data.isEnforcerUser&&(loadDiary(!1),fixSubtitle())}),$scope.$watch("data.prod.selectedTime",function(v){if(angular.isDefined(v)&&angular.isDefined($scope.assignment)&&!$scope.data.isEnforcerUser){var b="LOCAL"===$scope.data.prod.selectedTime;b?$scope.slotsName="contractorTimeSlots":$scope.slotsName="managerTimeSlots"}}),$scope.$watch("data.prod.periodType",function(nv){if("Weekly"===nv&&($scope.data.prod.viewType="Percentage"),angular.isDefined(nv)&&angular.isDefined($scope.data.prod.activityPerc)){var max=null;switch(nv){case"Weekly":$scope.data.prod.activityPerc=$scope.data.prod.activityPercWeek,max=5*$scope.data.prod.planTotalTime,angular.isDefined($scope.data.prod.activityPercWeek.grouping)&&(max=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPercWeek.grouping.totalTrackedTime)),$scope.data.prod.maxActTime=max<=2400?2400:max;break;default:$scope.data.prod.activityPerc=$scope.data.prod.activityPercArch,max=$scope.data.prod.planTotalTime,angular.isDefined($scope.data.prod.activityPercArch.grouping)&&(max=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPercArch.grouping.totalTrackedTime)),$scope.data.prod.maxActTime=max<=480?480:max}}}),$scope.$watch("data.prod.viewType",function(nv){if("Time"===nv&&"Weekly"===$scope.data.prod.periodType)return void($scope.data.prod.viewType="Percentage")}),$scope.getIndexHour=function(index){var dayMinutes=10*index,m=dayMinutes%60,dayhours=(dayMinutes-m)/60;dayMinutes%=60;var ap=dayhours<12||24===dayhours?"am":"pm";return m=0===m?"00":m,
(dayhours%12===0?12:dayhours%12)+":"+m+" "+ap},$scope.$watch("data.logbookDate",function(v){angular.isDefined(v)&&angular.isDefined($scope.assignment)&&($scope.data.isEnforcerUser||loadProductivity(),loadDiary(!1),$scope.user&&$scope.user.avatarTypes.indexOf("ENFORCER")>-1&&$scope.data.isEnforcerUser&&$location.search("date",moment($scope.data.logbookDate).startOf("day").format("YYYY-MM-DD")))}),$scope.$watch("ui.isProdLoading",function(v){angular.isDefined(v)&&!v&&prodFinal()}),$scope.$watch("data.timezone",function(v){angular.isDefined(v)&&angular.isDefined($scope.assignment)&&loadDiary(!1)}),$scope.$watch("data.displayTimecards",function(v){angular.isDefined(v)&&angular.isDefined($scope.assignment)&&loadDiary(!1)}),$scope.$watch("ui.isCheckedAllTC",function(v){if(angular.isDefined(v)&&angular.isDefined($scope.assignment)){var i,j,iLock,dLock,sLock,stc=$scope.data.selectedTC,idleWay=$scope.ui.onlyIdleTC,disputeWay=$scope.ui.onlyDisputedTC;if(angular.isDefined(stc)&&v&&stc.length>0){for($scope.ui.hasTimecardSelected=!0,i=0;stc.length>i;i++)stc[i].isIdle&&(iLock=!0),stc[i].isDisputed&&(dLock=!0),!stc[i].isIdle&!stc[i].isDisputed&&(sLock=!0);$scope.ui.onlyIdleTC=!!(iLock&!dLock&!sLock),$scope.ui.onlyDisputedTC=!!(!iLock&dLock&!sLock)}for(i=0;$scope.data.diary.length>i;i++)for(j=0;$scope.data.diary[i].timecards.length>j;j++)if(angular.isDefined($scope.data.diary[i].timecards[j])){var tc=$scope.data.diary[i].timecards[j];tc.isDisputeResolved||tc.isDisputed||tc.isIdle||idleWay||disputeWay||(tc.isSelected=v,v&&$scope.data.selectedTC.push(tc)),idleWay&&tc.isIdle&&(tc.isSelected=v,v&&$scope.data.selectedTC.push(tc)),disputeWay&&tc.isDisputed&&(tc.isSelected=v,v&&$scope.data.selectedTC.push(tc))}$scope.data.selectedTC.length>0&&($scope.ui.hasTimecardSelected=!0),v||($scope.data.selectedTC=[],$scope.ui.hasTimecardSelected=!1,$scope.ui.onlyIdleTC=!1,$scope.ui.onlyDisputedTC=!1)}}),$scope.$watch("ui.isListViewExpand",function(v){if(angular.isDefined(v)&&angular.isDefined($scope.assignment)){var i,j;for(i=0;$scope.data.diary.length>i;i++)for(j=0;$scope.data.diary[i].timecards.length>j;j++)if(angular.isDefined($scope.data.diary[i].timecards[j])){var tc=$scope.data.diary[i].timecards[j];tc.expaned=v}}}),loadData(),$scope.getActionComment=function(timecard,action){var actions=timecard.actions;if(timecard&&angular.isObject(actions)){for(var count=0;count<actions.length;count++)if(actions[count]&&actions[count].actionType===action)return actions[count].comment;return"No comment found!!"}return"No comment found!!"},$scope.isActionAvailable=function(timecard,action){var isActionPresent=(timecard.actions||[]).reduce(function(ret,x){return ret||angular.isDefined(x.actionType)&&x.actionType===action},!1);return isActionPresent},$scope.isMetricsVisible=function(){var isAssignmentAvailable=_.isObject($scope.assignment),isCandidate=$scope.user&&$scope.user.avatarTypes.indexOf("CANDIDATE")>-1;return isAssignmentAvailable&&isCandidate}}]),ctrls.controller("LinkedInProfileImportCtrl",["$scope","$uibModalInstance","LinkedInService",function($scope,$uibModalInstance,LinkedInService){$scope.confirm=function(){LinkedInService.setShowContractDashboard(),window.location=LinkedInService.generateAuthorizationUrl("profileImport")},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("NoPaymentOnboardCtrl",["$scope","$location","$routeParams","$rootScope",function($scope,$location,$routeParams,$rootScope){$routeParams.token&&($rootScope.setAuthToken($routeParams.token),$location.path("/candidate/dashboard/contract"))}]),ctrls.controller("ContractorDashboardTicketsCtrl",["$scope","UtilsService","CurrentUser","TeamService","DownloadService",function($scope,UtilsService,CurrentUser,TeamService,DownloadService){function getColorIndexByName(name){for(var colorIndex=0,i=0;i<$scope.data.jiraStats.length;i++)$scope.data.jiraStats[i].name===name&&(colorIndex=$scope.data.jiraStats[i].colorIndex);return colorIndex}function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg},setTimeout(function(){$scope.msg.show=!1},6e3)}function getTimeWindow(numberOfWeeks){if(numberOfWeeks<=0)throw new Error("Number of weeks should be greater than 0");var currentWeek=1,from=moment().subtract(numberOfWeeks,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY),to=moment().subtract(currentWeek,"weeks").weekday(moment.DAY_OF_WEEK.SUNDAY);return{from:from.format(moment.DateFormat.ISO_8601),to:to.format(moment.DateFormat.ISO_8601),numberOfWeeks:numberOfWeeks}}function addMissedWeeks(contractorStats,numberOfWeeks){var stats=contractorStats.stats||[];contractorStats.stats=stats;for(var i=1;i<=numberOfWeeks;i++){var week=moment().subtract(i,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),found=stats.filter(function(s){return s.startDate===week}).pop();found||stats.push({startDate:week,ticketsResolved:0})}}$scope.data={};var xAxisLabelFormatter=function(){var start=moment(new Date(this.value)),end=moment(start).add(6,"days");return start.format("MMM DD")+"<br/>"+end.format("MMM DD")},setLabelBold=function(label){$(".highcharts-axis-labels tspan:contains("+label+")").css("font-weight","bold")},resetLabelWeight=function(){$(".highcharts-axis-labels tspan").css("font-weight","normal")},initBoldListener=function(date,chartId){var chartContainer=$(chartId).highcharts().container,boldStart=moment(date).format("MMM DD"),boldEnd=moment(boldStart).add(6,"days").format("MMM DD");resetLabelWeight(),setLabelBold(boldStart),setLabelBold(boldEnd),chartContainer.onmouseleave=function(){resetLabelWeight()}};$scope.data.velocityChartConfig={title:{text:""},options:{chart:{type:"column"},legend:{enabled:!1},tooltip:{useHTML:!0,formatter:function(){var weekStats,d=moment(new Date(this.x)).format("YYYY-MM-DD");return weekStats=$scope.data.startDates[d],initBoldListener(d,"#chartVelocity"),"Total Resolved: <b>"+weekStats.totalResolved+"</b> <br/> Team Size: <b>"+weekStats.teamSize+"</b><br/> Per Contractor: <b>"+weekStats.perEmployee.toFixed(1)}}},xAxis:{type:"datetime",labels:{formatter:xAxisLabelFormatter},tickInterval:6048e5,title:{text:""},gridLineWidth:1},yAxis:{title:{text:""}},series:[],plotOptions:{column:{pointWidth:40}}},$scope.data.chartType="Efficiency",$scope.data.chartTarget="Tickets",$scope.data.chartConfig={plotOptions:{series:{marker:{fillColor:"#FFFFFF",lineWidth:2,lineColor:null},connectNulls:!1}},title:{text:""},xAxis:{type:"datetime",labels:{formatter:xAxisLabelFormatter},tickInterval:6048e5,title:{text:""},gridLineWidth:1},yAxis:{title:{text:""},min:0,gridLineDashStyle:"Dot"},options:{chart:{type:"line"},legend:{enabled:!1},tooltip:{useHTML:!0,formatter:function(){var weekStats,d=moment(new Date(this.x)).format("YYYY-MM-DD");if(initBoldListener(d,"#chartEfficiency"),"Team Average"===this.series.name){weekStats=$scope.data.startDates[d];var content="Per Contractor: <b>"+weekStats.perEmployee.toFixed(1)+"</b> <br/> Team Size: <b>"+weekStats.teamSize+"</b><br/> Total Resolved: <b>"+weekStats.totalResolved;return content}var name=this.series.name,personalStats=_.find($scope.data.jiraStats,function(s){return s.name===name});weekStats=_.find(personalStats.stats,function(obj){return obj.startDate===d});var popUpContent="<b>"+name+"</b><br/>";return popUpContent+="Resolved:<b>"+weekStats.ticketsResolved}}},series:[],loading:!1,useHighStocks:!1};var calculateSeries=function(data,type){var seriesData=[],findByStartDate=function(obj){return obj.startDate===startDates[j]};if("Team Average"===type){var startDates=[];angular.forEach(data,function(entry){for(var i=0;i<entry.stats.length;i++)startDates.push(entry.stats[i].startDate)});for(var cb=function(entry){$scope.data.colors[entry.name]=UtilsService.getHexColor(entry.colorIndex);var c=entry.stats;if(angular.isArray(c)){var obj=_.find(c,findByStartDate);candidatesWorked+=1,tmp[1]+=obj.ticketsResolved}},j=0;j<startDates.length;j++){var candidatesWorked=0,tmp=[moment(startDates[j]).valueOf(),0];angular.forEach(data,cb),candidatesWorked>0&&(tmp[1]/=candidatesWorked,tmp[1]=Math.round(10*tmp[1])/10),seriesData.push(tmp)}}else{var candData=_.find(data,function(c){return c.name===type});if(candData)for(var k=0;k<candData.stats.length;k++){var ticketsCount=candData.stats[k].ticketsResolved;seriesData.push([moment(candData.stats[k].startDate).valueOf(),ticketsCount])}}return seriesData.sort(function(a,b){return a[0]-b[0]}),seriesData},getSeriesObject=function(data,name){var res={id:name,type:"area",dashStyle:"Solid",pointInterval:6048e5,name:name,data:calculateSeries(data,name),fillColor:"transparent",marker:{fillColor:"#FFFFFF",lineWidth:2,lineColor:null,symbol:"circle"}};return"Team Average"===name?(res.color="#02A8F3",$scope.data.colors["Team Average"]=res.color,res.lineWidth=4):(res.color=UtilsService.getHexColor(getColorIndexByName(name)),$scope.data.colors[name]=res.color),res},getMetrics=function(){$scope.ui.isLoading=!0,$scope.data.colors=[];var getVelocitySeries=function(data){var series=[];angular.forEach(data,function(week){series.push([moment(week.date).valueOf(),week.data.totalResolved])});var res={pointInterval:6048e5,pointWidth:28,data:series,color:"#6EBAF7"};return res};$scope.assignment.jiraSetup?$scope.metricSetup=$scope.assignment.jiraSetup:$scope.assignment.zendeskSetup&&($scope.metricSetup=$scope.assignment.zendeskSetup);var timeWindow=getTimeWindow($scope.data.weeks||4);TeamService.getMetricValues({id:$scope.assignment.team.id,from:timeWindow.from,to:timeWindow.to,type:$scope.assignment.activeMetricType,managerId:$scope.assignment.manager.id},function(res){function calculateAverage(cand){var weeks=0,tickets=0;angular.forEach(cand.stats,function(week){tickets+=week.ticketsResolved,weeks+=1,startDates[week.startDate].totalResolved+=week.ticketsResolved,startDates[week.startDate].teamSize+=1}),weeks>0&&tickets>0&&(cand.perWeek=tickets/weeks)}function calculateWeekStats(stats){angular.forEach(stats,function(stat){startDates[stat.startDate]={perEmployee:0,teamSize:0,totalResolved:0}})}$scope.data.jiraStats=res;for(var i=0,len=$scope.data.jiraStats.length;i<len;i++)$scope.data.jiraStats[i].colorIndex=i,addMissedWeeks($scope.data.jiraStats[i],$scope.data.weeks||4);$scope.data.candidateStats=[];var teamAverageSum=0,candidatesWorked=0,startDates=[];if($scope.data.jiraStats.length>0&&calculateWeekStats($scope.data.jiraStats[0].stats||[]),angular.forEach($scope.data.jiraStats,function(entry){entry.perWeek=0,calculateAverage(entry),$scope.assignment.selection.marketplaceMember.application.candidate.printableName===entry.name&&$scope.data.candidateStats.push({name:entry.name,perWeek:entry.perWeek}),teamAverageSum+=entry.perWeek,candidatesWorked+=1}),candidatesWorked>0?$scope.data.teamAverage=teamAverageSum/candidatesWorked:$scope.data.teamAverage=0,0===$scope.data.chartConfig.series.length)$scope.data.chartConfig.series.push(getSeriesObject(res,"Team Average")),$scope.ui.showAverage=!0;else for(i=0,len=$scope.data.chartConfig.series.length;i<len;i++){var current=$scope.data.chartConfig.series[i];$scope.data.chartConfig.series[i]=getSeriesObject(res,current.id)}$scope.data.velocity=[],$scope.data.weekAverage=0;for(var k in startDates){startDates[k].teamSize>0&&(startDates[k].perEmployee=startDates[k].totalResolved/startDates[k].teamSize);var label=moment(new Date(k)).format("MMM DD")+" - "+moment(new Date(k)).add(6,"days").format("MMM DD");$scope.data.weekAverage+=startDates[k].totalResolved,$scope.data.velocity.push({label:label,date:k,data:startDates[k],dateValue:new Date(k).getTime()})}$scope.data.velocity.sort(function(a,b){return new Date(a.date).getTime()-new Date(b.date).getTime()}),$scope.data.weekAverage/=$scope.data.velocity.length,$scope.data.velocityChartConfig.series=[getVelocitySeries($scope.data.velocity)],$scope.data.startDates=startDates,$scope.toggleSelection($scope.assignment.selection.marketplaceMember.application.candidate.printableName),$scope.ui.isLoading=!1},function(err){showMessage("alert-danger",err.data.text),$scope.ui.isLoading=!1})};$scope.toggleSelection=function(key){var series=$scope.data.chartConfig.series,obj=_.find(series,function(s){return s.id===key});obj||$scope.data.chartConfig.series.push(getSeriesObject($scope.data.jiraStats,key))},$scope.$watch("data.weeks",function(nv){$scope.data.weeks=nv,getMetrics()}),$scope.data.weeks=4,CurrentUser.get(function(user){$scope.currentUser=user,getMetrics()}),$scope.downloadReport=function(){var asgnId;asgnId=$scope.currentUser&&$scope.currentUser.avatarTypes.indexOf("CANDIDATE")>-1?$scope.assignment.id:$scope.teamMemberShow;var timeWindow=getTimeWindow(12),params={from:timeWindow.from,to:timeWindow.to,type:$scope.assignment.activeMetricType};DownloadService.download("/assignments/"+asgnId+"/metric/values",params)}}]),ctrls.controller("ContractorHomeCtrl",["$scope","TimeUtils","UtilsService","$uibModal","AssignmentService","CurrentUser","$filter","$cookies","$routeParams","MarketplaceMembersService","$location",function($scope,TimeUtils,UtilsService,$uibModal,AssignmentService,CurrentUser,$filter,$cookies,$routeParams,MarketplaceMembersService,$location){function initView(){var qs=$scope.data.qs,views=$scope.data.views;for(var key in qs)qs.hasOwnProperty(key)&&"view"===key&&views.indexOf(qs[key])>-1&&($scope.data.activeView=qs[key])}function prodFinal(){var top=angular.element(".plan .overflowXa"),bottom=angular.element(".activity .overflowXa");bottom.bind("scroll",function(el){top.scrollLeft(angular.element(el.target).scrollLeft())}),top.bind("scroll",function(el){bottom.scrollLeft(angular.element(el.target).scrollLeft())})}function getTimezoneOffsets(){var manager,contractor,timezones=[],utc={name:"UTC",niceName:"UTC: 00:00h",id:null,hourlyOffset:"00:00",offset:0};if(angular.isObject($scope.assignment)){var a=$scope.assignment;angular.isDefined(a.currentAssignmentHistory.manager)&&angular.isDefined(a.currentAssignmentHistory.manager.location)&&angular.isDefined(a.currentAssignmentHistory.manager.location.timeZone)&&angular.isDefined(a.currentAssignmentHistory.manager.location.timeZone.hourlyOffset)&&(manager=angular.copy(a.currentAssignmentHistory.manager.location.timeZone),manager.niceName="Manager: "+manager.hourlyOffset+"h"),angular.isDefined(a.selection)&&angular.isDefined(a.selection.marketplaceMember)&&angular.isDefined(a.selection.marketplaceMember.application)&&angular.isDefined(a.selection.marketplaceMember.application.candidate)&&angular.isDefined(a.selection.marketplaceMember.application.candidate.location)&&angular.isDefined(a.selection.marketplaceMember.application.candidate.location.timeZone)&&angular.isDefined(a.selection.marketplaceMember.application.candidate.location.timeZone.hourlyOffset)&&(contractor=a.selection.marketplaceMember.application.candidate.location.timeZone,contractor.niceName="Contractor: "+contractor.hourlyOffset+"h")}var p=function(timezone,array){return void 0!==timezone&&array.push(timezone),angular.isDefined($scope.data.timezone)||($scope.data.timezone=timezone),array};return $scope.data.timeZoneOffsets=timezones,angular.isObject($scope.user)&&($scope.user.avatarTypes.indexOf("CANDIDATE")>-1?timezones=p(contractor,timezones):(timezones=p(manager,timezones),timezones=p(contractor,timezones))),timezones=p(utc,timezones)}function isFeatureEnabled(assignment,feature){return!(assignment.disabledFeatures&&assignment.disabledFeatures.length>0&&assignment.disabledFeatures.indexOf(feature)>-1)}function loadData(){CurrentUser.get(function(user){if($scope.user=user,$routeParams.date&&moment($routeParams.date)<moment()&&($scope.data.logbookDate=$routeParams.date),$routeParams.activeView&&($scope.data.activeView=$routeParams.activeView),$routeParams.id)if(user.avatarTypes.indexOf("MANAGER")>-1||user.avatarTypes.indexOf("COMPANY_ADMIN")>-1||user.avatarTypes.indexOf("MIGRATED_MANAGER")>-1){var avatarType="MANAGER";user.avatarTypes.indexOf("COMPANY_ADMIN")>-1&&($scope.data.isCompanyAdmin=!0,avatarType="COMPANY_ADMIN"),$scope.data.isManagerUser=!0,$scope.data.isProfile=!1,loadAssignment($routeParams.id,avatarType)}else $scope.ui.isLoading=!1,$scope.showMessage("alert-danger","Error: Not Allowed to access this page");else AssignmentService.assignments({page:0,avatarType:"CANDIDATE",status:"ACTIVE"},function(res){var assignmentsPage=res.content||[],candidateAv=$scope.user.userAvatars.filter(function(a){return"CANDIDATE"===a.type||"MIGRATED_CANDIDATE"===a.type}).pop();assignmentsPage.length>0&&candidateAv&&candidateAv.id===assignmentsPage[0].selection.marketplaceMember.application.candidate.id?loadAssignment(assignmentsPage[0].id,"CANDIDATE"):$scope.ui.isLoading=!1})}),$scope.data.monthTitle=getCurrentMonthTitle(),$scope.data.hoursRange=hoursRange8,$scope.data.weeksRange=weekRange40,$scope.data.applicationsRange=applicationsRange40}function loadAssignment(assignmentId,avatarType){$scope.ui.isLoading=!0,AssignmentService.get({id:assignmentId,avatarType:avatarType}).$promise.then(function(res){$scope.assignment=res,angular.isDefined($scope.assignment)&&angular.isDefined($scope.assignment.selection)&&angular.isDefined($scope.assignment.selection.marketplaceMember)&&angular.isDefined($scope.assignment.selection.marketplaceMember.id)&&"CANDIDATE"!==avatarType&&MarketplaceMembersService.get({id:$scope.assignment.selection.marketplaceMember.id},function(data){$scope.marketplaceMember=data,$scope.application=$scope.marketplaceMember.application}),$scope.assignment.showActivities=isFeatureEnabled($scope.assignment,"TIME_ACTIVITIES"),$scope.assignment.isScreenshotFeatureActive=isFeatureEnabled($scope.assignment,"SCREENSHOTS"),$scope.assignment.isWebcamshotFeatureActive=isFeatureEnabled($scope.assignment,"WEBCAM_PICTURES"),$scope.assignment.isAppTrackingFeatureActive=isFeatureEnabled($scope.assignment,"APPLICATION_TRACKING"),$scope.assignment.isEnforcerReviewFeatureActive=isFeatureEnabled($scope.assignment,"ENFORCER_REVIEW"),getTimezoneOffsets(),getTimezoneOffsets(),$scope.data.assignmentId=assignmentId,initAssignment(),$scope.data.assignmentId=$scope.assignment.id,$scope.data.teamId=$scope.assignment.currentAssignmentHistory.team.id,$scope.data.candidate=$scope.assignment.selection.marketplaceMember.application.candidate,loadWeeklyTimesheets($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date,$scope.assignment.currentAssignmentHistory.manager.id,$scope.data.isTimesheetAccessFrmCache),loadMemberFourWeeksTrackerData($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date,$scope.assignment.currentAssignmentHistory.manager.id),loadTrackerData($scope.data.assignmentId,$scope.data.periodType,$scope.data.date),$scope.setUsedMeetingTimeForCurrentWeek(),setMeetingTimeLimitText(),$scope.data.dateOptions.minDate=$scope.assignment.startDate})["catch"](function(err){$scope.showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}function loadTrackerData(assignemntId,periodBase,date){$scope.ui.isTrackerDataLoading=!0,AssignmentService.getMemberProductivity({id:assignemntId,type:periodBase,date:moment(date).startOf("week").format("YYYY-MM-DD")}).$promise.then(function(res){$scope.memberTrackerData=res,processApplications()})["catch"](function(err){$scope.showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isTrackerDataLoading=!1})}function loadWeeklyTimesheets(teamId,userId,date,managerId,isCacheAccess,silentUpdate){silentUpdate||($scope.ui.isTeamsheetsLoading=!0);var req={teamId:teamId,managerId:managerId,userId:userId,date:$filter("date")(date,"yyyy-MM-dd"),isCacheAccess:isCacheAccess};AssignmentService.getWeeklyTimeSheets(req).$promise.then(function(resArr){if(!silentUpdate||req.date===$filter("date")(date,"yyyy-MM-dd")){var res=resArr[0];if(res[0]){$scope.weeklyTimesheets=res[0];var loggedTime=Math.round(60*$scope.weeklyTimesheets.totalHours);$scope.printableTime=Math.floor(loggedTime/60)+" hours ";var minutes=loggedTime%60;minutes>0&&($scope.printableTime+=minutes+" minutes");var maxLogedForDay=($scope.weeklyTimesheets.stats||[]).reduce(function(ret,x){return x.hours>ret?x.hours:ret},0);maxLogedForDay>16?$scope.data.hoursRange=hoursRange20:maxLogedForDay>12?$scope.data.hoursRange=hoursRange16:maxLogedForDay>10?$scope.data.hoursRange=hoursRange12:maxLogedForDay>8?$scope.data.hoursRange=hoursRange10:$scope.data.hoursRange=hoursRange8}else $scope.weeklyTimesheets={},$scope.printableTime="0 hours",$scope.timeSheetTotalHours=0,$scope.data.hoursRange=hoursRange8}})["catch"](function(err){silentUpdate||$scope.showMessage("alert-danger",err.data.text)})["finally"](function(){silentUpdate||($scope.ui.isTeamsheetsLoading=!1),$scope.data.isTimesheetAccessFrmCache=!0})}function loadMemberFourWeeksTrackerData(teamId,userId,date,managerId,silentUpdate){silentUpdate||($scope.ui.isTrackerData4WeeksLoading=!0);var req={teamId:teamId,managerId:managerId,userId:userId,date:$filter("date")(date,"yyyy-MM-dd")};AssignmentService.getMonthlyTimeSheets(req).$promise.then(function(res){if(res&&res.length>0){$scope.memberFourWeeksData=res;var maxTotalHours=0;$scope.memberFourWeeksData.forEach(function(week,i){var st=moment().startOf("isoweek").subtract(i,"w").format("MMM DD"),end=moment().endOf("isoweek").subtract(i,"w").format("MMM DD"),weekTitle=st+" - "+end;week[0]?week[0].weekTitle=weekTitle:week[0]={weekTitle:weekTitle,totalHours:0},week[0].totalHours>maxTotalHours&&(maxTotalHours=week[0].totalHours)}),maxTotalHours>70?$scope.data.weeksRange=weekRange80:maxTotalHours>60?$scope.data.weeksRange=weekRange70:maxTotalHours>50?$scope.data.weeksRange=weekRange60:maxTotalHours>40?$scope.data.weeksRange=weekRange50:$scope.data.weeksRange=weekRange40}else $scope.memberFourWeeksData=[],$scope.data.weeksRange=weekRange40})["catch"](function(err){$scope.showMessage("alert-danger",err.data.text)})["finally"](function(){silentUpdate||($scope.ui.isTrackerData4WeeksLoading=!1)})}function initAssignment(){if($scope.data.offset=TimeUtils.formatUtcOffset($scope.assignment.selection.marketplaceMember.application.candidate.location.timeZone.offset),$scope.assignment.lengthInDays){var lengthInDays=$scope.assignment.lengthInDays,currentDate=new Date,diff=UtilsService.daysDiff(currentDate,$scope.assignment.startDate);diff<lengthInDays&&($scope.data.contractTime=(lengthInDays-diff)/30)}}function processApplications(){if($scope.memberTrackerData.byCategory&&$scope.memberTrackerData.byCategory.length>0){var categories=$scope.memberTrackerData.byCategory,arr=[];(categories||[]).forEach(function(c){(c.applications||[]).forEach(function(app){if(angular.isObject(app)&&angular.isDefined(app.applicationName)){var mainAppName=app.applicationName;angular.isDefined(app.xoApplication)&&(mainAppName=app.xoApplication.name);var accApplication=arr[mainAppName];(null===accApplication||angular.isUndefined(accApplication))&&(accApplication={name:mainAppName,time:0},angular.isDefined(app.xoActivity)?accApplication.category=app.xoActivity:accApplication.category={name:"Other",color:"grey"},arr[mainAppName]=accApplication),accApplication.time=accApplication.time+app.totalTime}})});var apps=[];for(var key in arr)apps.push(arr[key]);$scope.trackedApplications=apps.sort(function(a,b){return b.time-a.time});var maxTime=$scope.trackedApplications[0].time;maxTime/60<8?$scope.data.applicationsRange=applicationsRange10:maxTime/60<20?$scope.data.applicationsRange=applicationsRange20:$scope.data.applicationsRange=applicationsRange40}else $scope.trackedApplications=[]}function reloadTimeTracker(){angular.isDefined($scope.data.assignmentId)&&($scope.memberTrackerData=null,$scope.formatedMemberData={maxCatPercentage:0},loadWeeklyTimesheets($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date,$scope.assignment.currentAssignmentHistory.manager.id,$scope.data.isTimesheetAccessFrmCache),loadTrackerData($scope.data.assignmentId,$scope.data.periodType,$scope.data.date))}function getCurrentMonthTitle(){var dt=new Date,dayOfWeek=0===dt.getDay()?6:dt.getDay()-1,first=new Date(dt.setDate(dt.getDate()-dayOfWeek)),lastDay=new Date(dt.setDate(first.getDate()+6)),firstOfMonth=new Date(dt.setDate(dt.getDate()-21));dayOfWeek=0===firstOfMonth.getDay()?6:firstOfMonth.getDay()-1;var firstDay=new Date(firstOfMonth.setDate(firstOfMonth.getDate()-dayOfWeek)),monthTitle=$filter("dateSuffix")(firstDay)+" - "+$filter("dateSuffix")(lastDay);return monthTitle}function setMeetingTimeLimitText(){if($scope.assignment.weeklyMeetingMinutesLimit&&$scope.assignment.weeklyMeetingMinutesLimit>0){var hours=Math.floor($scope.assignment.weeklyMeetingMinutesLimit/60),minutes=$scope.assignment.weeklyMeetingMinutesLimit%60;$scope.meetingTimeLimitText=hours+" h "+minutes+" min"}else $scope.meetingTimeLimitText="0 h 0 min"}var infoModal=null,weekRange40={hoursName:["10h","20h","30h","40h"],width:"25%",hours:40},weekRange50={hoursName:["10h","20h","30h","40h","50h"],width:"20%",hours:50},weekRange60={hoursName:["10h","20h","30h","40h","50h","60h"],width:"16.66%",hours:60},weekRange70={hoursName:["10h","20h","30h","40h","50h","60h","70h"],width:"14.28%",hours:70},weekRange80={hoursName:["10h","20h","30h","40h","50h","60h","70h","80h"],width:"12.5%",hours:80},hoursRange8={hoursName:[1,2,3,4,5,6,7,8],rowHeight:"30px",hours:8},hoursRange10={hoursName:[1,2,3,4,5,6,7,8,9,10],rowHeight:"24px",hours:10},hoursRange12={hoursName:[1,2,3,4,5,6,7,8,9,10,11,12],rowHeight:"20px",hours:12},hoursRange16={hoursName:[2,4,6,8,10,12,14,16],rowHeight:"30px",hours:16},hoursRange20={hoursName:[2,4,6,8,10,12,14,16,18,20],rowHeight:"24px",hours:20},applicationsRange40={hoursName:[10,20,30,40],hours:40},applicationsRange20={hoursName:[5,10,15,20],hours:20},applicationsRange10={hoursName:[2.5,5,7.5,10],hours:10};$scope.Math=window.Math,$scope.data={isProfile:!0,offset:null,monthTitle:null,weeks:[],timeZoneOffsets:[],diary:[],autoTrackedTimeLogged:"00:00",manualTimeLogged:"00:00",idleTimeLogged:"00:00",disputedTimeLogged:"00:00",overTimeLogged:"00:00",billableTimeLogged:"00:00",isTimesheetAccessFrmCache:!0,selectedTC:[],checkAllTC:{},periodType:"weekly",date:new Date,today:new Date,logbookDate:moment(new Date).toDate(),startOfCurrentWeek:moment().startOf("week").toDate(),isToday:!0,isCurrentWeek:!0,isCurrentMonth:!0,assignmentId:void 0,hoursRange:{},weeksRange:{},applicationsRange:{},displayTimecards:"ALL",prod:{selectedTime:"LOCAL",viewMode:"Advanced",viewType:"Time",periodType:"Daily",fLoad:!1},teams:[],activeView:"weeklyDashboard",views:["metrics","dailyLogbook","productivity","weeklyDashboard","profile"],dateOptions:{showWeeks:!1,startingDay:1,maxDate:moment().toDate()},PRODUCTIVITY_THRESHOLD:10,qs:$location.search()},$scope.ui={isLoading:!0,isDPToday:!1,isProdLoading:!1,isLogbookLoading:!1,isMeetingTimeLoading:!1,showfPicker:!1,showtPicker:!1,hasTimecardSelected:!1,onlyIdleTC:!1,onlyDisputedTC:!1,isListView:!1,isListViewExpand:!0,onlyNonDisputedTC:!1};var updateInterval=setInterval(function(){UtilsService.isInSameWeek($scope.data.date,new Date)&&loadWeeklyTimesheets($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date,$scope.assignment.currentAssignmentHistory.manager.id,!1,!0),loadMemberFourWeeksTrackerData($scope.data.teamId,$scope.assignment.selection.marketplaceMember.application.candidate.id,$scope.data.date,$scope.assignment.currentAssignmentHistory.manager.id,!0)},6e5);$scope.$on("$destroy",function(){clearInterval(updateInterval)}),$scope.reload=function(){reloadTimeTracker(),loadData(),$scope.$broadcast("reload")},$scope.changeDay=function(next,logbook){var updated=moment($scope.data.logbookDate).add(next,"Weekly"!==$scope.data.prod.periodType||logbook?"d":"w").toDate();updated.getTime()<(new Date).getTime()&&($scope.data.logbookDate=updated)},$scope.hasRole=function(roleRequired){return $scope.user.avatarTypes.indexOf(roleRequired)>-1},$scope.setUsedMeetingTimeForCurrentWeek=function(){var date=UtilsService.getWeekOfDate(new Date,!1),params={id:$scope.assignment.id,type:"MEETING_TIME",startDate:$filter("date")(date.firstDate,"yyyy-MM-dd"),endDate:$filter("date")(date.lastDate,"yyyy-MM-dd")};AssignmentService.getUsedMeetingTimeText(params).$promise.then(function(resp){resp&&resp.meetingTime&&($scope.meetingTimeUsedText=resp.meetingTime)})["catch"](function(err){$scope.showMessage("alert-danger",err.data.text)})},$scope.showMessage=function(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg},setTimeout(function(){$scope.msg.show=!1},6e3)},$scope.infoModal={open:function(){infoModal=$uibModal.open({templateUrl:"infoModal.tpl.html",windowClass:"productivity-info-modal",scope:$scope,size:"lg"})},close:function(){infoModal.close()}},$scope.$watch("data.logbookDate",function(newVal,oldVal){var currentStartOfWeek=moment().startOf("week"),datePickerStartOfWeek=moment($scope.data.logbookDate).startOf("week");$scope.data.isThisWeek=0===currentStartOfWeek.diff(datePickerStartOfWeek,"weeks"),$scope.ui.isToday=0===moment().diff(newVal,"days"),newVal!==oldVal&&$scope.data.isThisWeek&&"weeklyDashboard"===$scope.data.activeView&&($scope.data.logbookDate=moment().startOf("day").format("YYYY-MM-DD"))}),$scope.$watch("data.date",function(newVal,oldVal){$scope.data.currentWeekStart=moment().startOf("isoweek").toDate(),$scope.data.weekStart=moment(newVal).startOf("isoweek").toDate(),$scope.data.weekEnd=moment(newVal).endOf("isoweek").toDate(),$scope.data.prvWeekStart=moment().weekday(-7),$scope.data.prvWeekEnd=moment().weekday(0),newVal&&oldVal&&"weekly"===$scope.data.periodType&&UtilsService.isInSameWeek(newVal,oldVal)||newVal&&oldVal&&"monthly"===$scope.data.periodType&&newVal.getMonth()===oldVal.getMonth()||(0===UtilsService.daysDiff(newVal,$scope.data.today)?($scope.data.isToday=!0,$scope.data.isCurrentWeek=!0,$scope.data.isCurrentMonth=!0):UtilsService.isInSameWeek(newVal,$scope.data.today)?($scope.data.isToday=!1,$scope.data.isCurrentWeek=!0,$scope.data.isCurrentMonth=!0):angular.isObject(newVal)&&newVal.getMonth()===$scope.data.today.getMonth()?($scope.data.isToday=!1,$scope.data.isCurrentWeek=!1,$scope.data.isCurrentMonth=!0):($scope.data.isToday=!1,$scope.data.isCurrentWeek=!1,$scope.data.isCurrentMonth=!1),reloadTimeTracker())}),$scope.$watch("data.periodType",function(){reloadTimeTracker()}),$scope.$watch("ui.isProdLoading",function(v){angular.isDefined(v)&&!v&&prodFinal()}),$scope.$watch("data.prod.periodType",function(nv){if("Weekly"===nv&&($scope.data.prod.viewType="Percentage"),angular.isDefined(nv)&&angular.isDefined($scope.data.prod.activityPerc)){var max=null;switch(nv){case"Weekly":$scope.data.prod.activityPerc=$scope.data.prod.activityPercWeek,max=5*$scope.data.prod.planTotalTime,angular.isDefined($scope.data.prod.activityPercWeek.grouping)&&(max=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPercWeek.grouping.totalTrackedTime)),$scope.data.prod.maxActTime=max<=2400?2400:max;break;default:$scope.data.prod.activityPerc=$scope.data.prod.activityPercArch,max=$scope.data.prod.planTotalTime,angular.isDefined($scope.data.prod.activityPercArch.grouping)&&(max=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPercArch.grouping.totalTrackedTime)),$scope.data.prod.maxActTime=max<=480?480:max}}}),$scope.$watch("data.prod.viewType",function(nv){if("Time"===nv&&"Weekly"===$scope.data.prod.periodType)return void($scope.data.prod.viewType="Percentage")}),loadData(),initView()}]),ctrls.controller("ContractorNavigationCtrl",["$scope","$filter","UtilsService","$location",function($scope,$filter,UtilsService,$location){function changeWeek(next){var updated=moment($scope.data.date).add(next,"w").startOf("isoweek").toDate();$scope.data.logbookDate=updated,updated.getTime()<(new Date).getTime()&&($scope.data.date=updated)}function getWeekText(date){var week=UtilsService.getWeekOfDate(date,!1);return $filter("date")(week.firstDate,"MMM d")+" - "+$filter("date")(week.lastDate,"MMM d, yyyy")}$scope.isActiveView=function(views,className){
return views.indexOf($scope.data.activeView)>-1?className:null},$scope.changeView=function(view){$location.search("view",view),$scope.data.activeView=view},$scope.datepickerFormattedDate=function(){return"weeklyDashboard"===$scope.data.activeView?$filter("shortdate")($scope.data.weekStart)+" - "+$filter("fulldate")($scope.data.weekEnd):("productivity"===$scope.data.activeView||"metrics"===$scope.data.activeView)&&"Weekly"===$scope.data.prod.periodType?getWeekText($scope.data.logbookDate):$filter("date")($scope.data.logbookDate,"MMMM d, yyyy")},$scope.handleDatepickerClick=function(){$scope.ui.isDP=!$scope.ui.isDP},$scope.handleDateChangeClick=function(inc,logbook){("weeklyDashboard"===$scope.data.activeView||"productivity"===$scope.data.activeView&&"Weekly"===$scope.data.prod.periodType)&&changeWeek(inc),("productivity"===$scope.data.activeView&&"Weekly"!==$scope.data.prod.periodType||"dailyLogbook"===$scope.data.activeView||"metrics"===$scope.data.activeView||"profile"===$scope.data.activeView)&&$scope.changeDay(inc,logbook)},$scope.showOrHideDatepickerArrow=function(){return"weeklyDashboard"===$scope.data.activeView?{hidden:$scope.data.isCurrentWeek}:{hidden:$scope.ui.isToday}},$scope.handleDatepickerTodayClick=function(){$scope.data.logbookDate=$scope.data.today},$scope.showDatepickerToday=function(){var classes=[],d=$scope.data.isToday,hide=!$scope.ui.isDPToday;return d&&classes.push("is-today"),hide&&classes.push("hide"),classes},$scope.$watch("data.activeView",function(newValue){return $scope.data.prod.periodType="Daily","dailyLogbook"===newValue?$scope.ui.isDPToday=!0:void($scope.ui.isDPToday=!1)}),$scope.$watch("data.logbookDate",function(newValue){var now=moment(),d=moment($scope.data.logbookDate),diff=0===now.diff(d,"days");$scope.data.isToday=diff,(angular.isDefined(newValue)&&"weeklyDashboard"===$scope.data.activeView||"productivity"===$scope.data.activeView&&"Weekly"===$scope.data.prod.periodType)&&($scope.data.date=$scope.data.logbookDate)})}]),ctrls.controller("ContractorPictureCardCtrl",["$scope","TimeUtils","$document",function($scope,TimeUtils,$document){$scope.showSalary=!1,$scope.getCurrentTime=function(){if(angular.isDefined($scope.data.candidate)){var offset=$scope.data.candidate.location.timeZone.offset;return offset?TimeUtils.getTimeByTimezoneOffset(offset):TimeUtils.getUTCTime()}},$scope.getSkypeToolTip=function(assignment){return assignment.selection.marketplaceMember.application.candidate.skypeId&&!$scope.showSkype?"Make a call or chat with "+assignment.selection.marketplaceMember.application.candidate.printableName:assignment.selection.marketplaceMember.application.candidate.skypeId?"":"Please ask this person to enter their Skype ID in their profile."},$scope.showSkype=!1,$document.bind("click",function(event){angular.element(event.target).hasClass("ciSkype")||($scope.showSkype=!1)})}]),ctrls.controller("ContractorWeeklyDashboardApplicationsUsedCtrl",["$scope","$filter",function($scope,$filter){$scope.applicationsTooltip=function(application){return application&&void 0!==application.time&&$filter("number")(application.time/60,1)?$filter("auto2application")(application.name):""},$scope.applicationsBarWidth=function(time){var w=100*time/(60*$scope.data.applicationsRange.hours)+"%";return{width:w}},$scope.applicationsBarTitle=function(application){return(application.time-application.time%60)/60+"h "+application.time%60+"m"}}]),ctrls.controller("ContractorWeeklyDashboardTimeLoggedCtrl",["$scope","$filter",function($scope,$filter){function timeloggedBarHeight(hours){var h=hours?100*hours/$scope.data.hoursRange.hours:120;return h+"%"}function timeloggedBarBackground(hours){return hours?"#22aae4":"#f3f3f3"}$scope.timeloggedStyle=function(hours){return{height:timeloggedBarHeight(hours),background:timeloggedBarBackground(hours)}},$scope.timeloggedBarTitle=function(hours){var h=hours-hours%1+"h ",m=$filter("number")(60*hours%60,0)+"m";return h+m}}]),ctrls.controller("ContractorProductivityCtrl",["$scope","$filter","MessagesService",function($scope,$filter,MessagesService){function managerActivityStatsHours(activity){return(("Weekly"===$scope.data.prod.periodType?5*activity.time:1*activity.time)-("Weekly"===$scope.data.prod.periodType?5*activity.time:1*activity.time)%60)/60+"h"}function managerActivityStatsMinutes(activity){return("Weekly"===$scope.data.prod.periodType?5*activity.time:1*activity.time)%60+"m"}function contractorActivityStatsHours(activity){return(activity.spentTime-activity.spentTime%60)/60+"h"}function contractorActivityStatsMinutes(activity){return activity.spentTime%60+"m"}var totalActivityTime,popup={period:function(){if($scope.data.prod&&$scope.data.prod.selectedGroup)return"Weekly"===$scope.data.prod.periodType?"week":"day"},planMinutes:function(){if($scope.data.prod&&$scope.data.prod.selectedGroup)return("Weekly"===$scope.data.prod.periodType?5*$scope.data.prod.selectedGroup.time:1*$scope.data.prod.selectedGroup.time)%60+"m"},planHours:function(){if($scope.data.prod&&$scope.data.prod.selectedGroup)return(("Weekly"===$scope.data.prod.periodType?5*$scope.data.prod.selectedGroup.time:1*$scope.data.prod.selectedGroup.time)-("Weekly"===$scope.data.prod.periodType?5*$scope.data.prod.selectedGroup.time:1*$scope.data.prod.selectedGroup.time)%60)/60+"h"},planPercent:function(){if($scope.data.prod&&$scope.data.prod.selectedGroup)return $filter("number")(100*("Weekly"===$scope.data.prod.periodType?5*$scope.data.prod.selectedGroup.time:1*$scope.data.prod.selectedGroup.time)/$scope.data.prod.maxActTime,0)+"%"},activityHours:function(){return($scope.data.prod.selectedGroup.spentTime-$scope.data.prod.selectedGroup.spentTime%60)/60+"h"},activityMinutes:function(){return $scope.data.prod.selectedGroup.spentTime%60+"m"},activityPercent:function(){return totalActivityTime="Daily"===$scope.data.prod.periodType?$scope.data.prod.activityPerc.grouping.totalTrackedTime:$scope.data.prod.activityPercWeek.grouping.totalTrackedTime,$filter("number")(100*$scope.data.prod.selectedGroup.spentTime/totalActivityTime,0)+"%"},usedApplicationHours:function(app){return(app.spentTime-app.spentTime%60)/60+"h"},usedApplicationMinutes:function(app){return app.spentTime%60+"m"}};$scope.myProductivityData={slotsName:"contractorTimeSlots"},$scope.showManagerContractorTime=function(){return"Time"===$scope.data.prod.viewType&&"Advanced"===$scope.data.prod.viewMode&&$scope.user&&1!==$scope.user.avatarTypes.length},$scope.activityColor=function(activity){if(activity)return"Advanced"===$scope.data.prod.viewMode&&{background:activity.color}||{background:activity.catColor}},$scope.handleTimePlanMouseEnter=function(event,selectedSlot,selectedSlotPlan){$scope.data.prod.selectedSlot=selectedSlot,$scope.data.prod.selectedSlotPlan=selectedSlotPlan,$scope.data.prod.selectedGroup=null,$scope.helpersPopup(event,!0),$scope.data.prod.selectedGroupPlan=null},$scope.handlePercentagePlanMouseEnter=function(event,selectedGroup,selectedSlotPlan){$scope.data.prod.selectedSlot=null,$scope.data.prod.selectedSlotPlan=selectedSlotPlan,$scope.data.prod.selectedGroup=selectedGroup,$scope.helpersPopup(event,!0)},$scope.handleManagerTimePlanMouseLeave=function(event){$scope.data.prod.selectedSlot=null,$scope.data.prod.selectedSlotPlan=!1,$scope.helpersPopup(event,!1)},$scope.percentagePlanWidth=function(activity,viewMode){return"Percentage"===$scope.data.prod.viewType&&$scope.data.prod.viewMode===viewMode&&{width:100*("Weekly"===$scope.data.prod.periodType?5*activity.time:activity.time)/$scope.data.prod.maxActTime+"%"}},$scope.getActivityTitle=function(){return $scope.user&&$scope.user.avatarTypes.indexOf("CANDIDATE")>-1&&1===$scope.user.avatarTypes.length?"My Activity":"Activity"},$scope.activityWidth=function(activity,viewMode){return"Percentage"===$scope.data.prod.viewType&&$scope.data.prod.viewMode===viewMode&&{width:100*activity.spentTime/$scope.data.prod.maxActTime+"%"}},$scope.showManagerActivityStats=function(activity){return 100*("Weekly"===$scope.data.prod.periodType?5*activity.time:activity.time)/$scope.data.prod.maxActTime>7},$scope.managerActivityStatsTime=function(activity){return managerActivityStatsHours(activity)+" "+managerActivityStatsMinutes(activity)},$scope.managerActivityStatsPercent=function(activity){var minutes=100*("Weekly"===$scope.data.prod.periodType?5*activity.time:1*activity.time);return $filter("number")(minutes/$scope.data.prod.maxActTime,0)+"%"},$scope.showContratorActivityStats=function(activity){return 100*("Weekly"===$scope.data.prod.periodType?5*activity.spentTime:activity.spentTime)/("Weekly"===$scope.data.prod.periodType?5*$scope.data.prod.maxActTime:$scope.data.prod.maxActTime)>7},$scope.contractorActivityStatsTime=function(activity){return contractorActivityStatsHours(activity)+" "+contractorActivityStatsMinutes(activity)},$scope.contractorActivityStatsPercent=function(activity){return totalActivityTime="Daily"===$scope.data.prod.periodType?$scope.data.prod.activityPerc.grouping.totalTrackedTime:$scope.data.prod.activityPercWeek.grouping.totalTrackedTime,$filter("number")(100*activity.spentTime/totalActivityTime,0)+"%"},$scope.popup=function(){if($scope.data.prod&&$scope.data.prod.popup)return{top:$scope.data.prod.popup.y,left:$scope.data.prod.popup.x,opacity:$scope.data.prod.popup.open?1:0}},$scope.helpersPopup=function(e,b){if(!b){if(angular.element(e.toElement).hasClass("popupHelper"))return;return $scope.data.prod.selectedSlot=null,$scope.data.prod.selectedGroup=null,void($scope.data.prod.popup.open=!1)}var x,y,height=115,prodDiv=angular.element(".productivity > .relative").offset();if($scope.data.prod.selectedSlotPlan||(height=185),null!==$scope.data.prod.selectedGroup&&angular.isDefined($scope.data.prod.selectedGroup.groupItems)){var itemsHeight=$scope.data.prod.selectedGroup.groupItems.length>10?10:$scope.data.prod.selectedGroup.groupItems.length;height=145+20*itemsHeight}angular.isDefined($scope.data.prod.selectedGroup)&&$scope.data.prod.selectedSlotPlan&&null===$scope.data.prod.selectedSlot&&(height=85),e.pageX+230-e.view.innerWidth>115&&(e.pageX=e.view.innerWidth-130,e.offsetX=0),e.view.innerWidth<1520&&e.pageX<115&&(e.pageX=115,e.offsetX=0),x=e.currentTarget.clientWidth/2+e.pageX-prodDiv.left-e.offsetX-117,y=e.pageY-prodDiv.top-e.offsetY-height-20,$scope.data.prod.popup={x:x,y:y,open:!0}},$scope.getIndexHour=function(index){var dayMinutes=10*index,m=dayMinutes%60,dayhours=(dayMinutes-m)/60,ap=dayhours<12||24===dayhours?"am":"pm";return dayMinutes%=60,m=0===m?"00":m,(dayhours%12===0?12:dayhours%12)+":"+m+" "+ap},$scope.popupPlan=function(){if($scope.data.prod&&$scope.data.prod.selectedGroup)return popup.planHours()+" "+popup.planMinutes()+" ("+popup.planPercent()+" of the "+popup.period()+")"},$scope.popupActivity=function(){return popup.activityHours()+" "+popup.activityMinutes()+" ("+popup.activityPercent()+" of the "+popup.period()+")"},$scope.popupUsedApplicationTime=function(app){return popup.usedApplicationHours(app)+" "+popup.usedApplicationMinutes(app)},$scope.popupUsedApplicationPercent=function(app){return $filter("number")(100*app.spentTime/totalActivityTime,0)+"%"},$scope.getMessage=function(msg){return MessagesService[msg]},$scope.$watch("data.prod.periodType",function(){angular.isDefined($scope.data)&&angular.isDefined($scope.data.prod)&&angular.isDefined($scope.data.prod.activityPerc)&&angular.isDefined($scope.data.prod.activityPercWeek)&&(totalActivityTime=$scope.data.prod.planTotalTime,$scope.data.prod.activityPerc&&$scope.data.prod.activityPerc.grouping&&$scope.data.prod.activityPerc.grouping.totalTrackedTime&&(totalActivityTime="Daily"===$scope.data.prod.periodType?$scope.data.prod.activityPerc.grouping.totalTrackedTime:$scope.data.prod.activityPercWeek.grouping.totalTrackedTime))}),$scope.$watch("data.prod.selectedTime",function(v){if(angular.isDefined(v)&&angular.isDefined($scope.assignment)){var b="LOCAL"===$scope.data.prod.selectedTime;b?$scope.myProductivityData.slotsName="contractorTimeSlots":$scope.myProductivityData.slotsName="managerTimeSlots"}})}]),ctrls.controller("ContractorDailyLogbookCtrl",["$scope","$filter","$cacheFactory","$cookies","$q","$window","$location","$uibModal","TimeUtils","AssignmentService","ProductivityService","$routeParams","UtilsService",function($scope,$filter,$cacheFactory,$cookies,$q,$window,$location,$uibModal,TimeUtils,AssignmentService,ProductivityService,$routeParams,UtilsService){function initCachedDiary(){if(!angular.isDefined($scope.data.cachedDiary)){var id=0;angular.isDefined($routeParams.id)&&(id=$routeParams.id);try{$scope.data.cachedDiary=$cacheFactory("diaryCacheId_"+id)}catch(e){$scope.data.cachedDiary=$cacheFactory.get("diaryCacheId_"+id)}}}function convertToZone(millis,offset){var d=new Date(millis),utc=d.getTime()+6e4*d.getTimezoneOffset();return moment(utc+offset).toDate()}function checkLastCacheUpdate(clearCache){return clearCache?void $cacheFactory.get("productivityCache").removeAll():void(angular.isUndefined($cookies.lastCacheUpdate)?$cookies.lastCacheUpdate=(new Date).getTime():(new Date).getTime()-$cookies.lastCacheUpdate>=6e5&&($cookies.lastCacheUpdate=(new Date).getTime(),$cacheFactory.get("productivityCache").removeAll()))}function timeTable(a,p){if(angular.isDefined(a)&&angular.isDefined(p)){var i,r=[],c=a;for(i=0;i<24;i++)i>=12&&(c=p),0===i||12===i?r.push("12:00 "+c):r.push(i%12+":00 "+c);return r}}function str2Time(t){t=moment(t).utc();var ap=t.hours()<12?"am":"pm",m=0===t.minutes()?"00":t.minutes();return t.hours()+":"+m+" "+ap}function groupPlannedActivitiesPercent(i){for(var perGrouped=[],tmp={},c=0,totalTime=0;i--;)if(angular.isDefined($scope.data.prod.plan[i])&&angular.isDefined($scope.data.prod.plan[i].activity)&&null!==$scope.data.prod.plan[i].activity){var a=$scope.data.prod.plan[i].activity;tmp[a.name]?(perGrouped[tmp[a.name][0]].time=perGrouped[tmp[a.name][0]].time+10,totalTime+=10,tmp[a.name].push([])):(tmp[a.name]=[],tmp[a.name].push(c),a.time=10,totalTime+=10,perGrouped[c]=a,c++)}return $scope.data.prod.planTotalTime=totalTime<=480?480:totalTime,$filter("orderBy")(perGrouped||[],"time",!0)}function groupActivities(arr){for(var i=arr.length,j=3,actGrouped=[{name:"PRODUCTIVE",color:"#3fa9fe",time:0,act:[]},{name:"COMMUNICATION",color:"#ffd54f",time:0,act:[]},{name:"UNPRODUCTIVE",color:"#ef5350",time:0,act:[]}],sortOrder={PRODUCTIVE:0,COMMUNICATION:1,UNPRODUCTIVE:2};i--;)angular.isDefined(arr[i])&&(actGrouped[sortOrder[arr[i].category]].act.push(arr[i]),actGrouped[sortOrder[arr[i].category]].time=actGrouped[sortOrder[arr[i].category]].time+arr[i].time);for(;j--;)actGrouped[j].act=$filter("orderBy")(actGrouped[j].act||[],"name");return actGrouped}function sortBySpendTimeAndGroup(obj){return obj?angular.isDefined(obj.grouping)?(obj.grouping.advancedGroups=$filter("orderBy")(obj.grouping.advancedGroups||[],"spentTime",!0),obj.grouping.simpleGroups.reverse(),obj):void 0:{grouping:{advancedGroups:[],alignmentScore:0,periodLong:0,simpleMetrics:0,simpleGroups:[],totalTrackedTime:0}}}function loadProductivity(id,silentUpdate,forceRefresh){silentUpdate||($scope.data.prod.fLoad=!0,$scope.ui.isProdLoading=!0),!angular.isDefined(id)&&angular.isDefined($scope.assignment)&&(id=$scope.assignment.id),angular.isDefined(forceRefresh)&&forceRefresh||(forceRefresh=!1);var managerId=null,s={assignmentId:id,teamId:$scope.assignment.team.id,managerId:managerId,refresh:forceRefresh},getActivity=function(s,silentUpdate,forceRefresh){checkLastCacheUpdate(forceRefresh);var promises=[],candidate=$scope.assignment.selection.marketplaceMember.application.candidate,candidateAv=$scope.user.userAvatars.filter(function(a){return"CANDIDATE"===a.type||"MIGRATED_CANDIDATE"===a.type}).pop();for(candidateAv&&candidate.id===candidateAv.id&&delete s.teamId,s.date=moment($scope.data.logbookDate).utc().utcOffset($scope.user.location.timeZone.hourlyOffset).format("YYYY-MM-DD");promises.length<3;)1===promises.length&&(s.groups="groups"),2===promises.length&&(s.weekly=!0),promises.push(ProductivityService.readTeamActivities(s).$promise);$q.all(promises).then(function(r){if(!silentUpdate||!$scope.ui.isProdLoading&&s.date===moment($scope.data.logbookDate).utc().utcOffset($scope.user.location.timeZone.hourlyOffset).format("YYYY-MM-DD")){if(angular.isUndefined(r[0][0])){if(silentUpdate||($scope.ui.isProdLoading=!1),$scope.data.prod.maxActTime=$scope.data.prod.planTotalTime<480?480:$scope.data.prod.planTotalTime,"Weekly"===$scope.data.prod.periodType){var max=5*$scope.data.prod.planTotalTime;$scope.data.prod.maxActTime=max<=2400?2400:max}return $scope.data.prod.activityTime=[],$scope.data.prod.activityPerc=[],$scope.data.prod.activityPercArch=[],$scope.data.prod.activityPercWeek=[],void(angular.isDefined(r[2][0])&&($scope.data.prod.activityPercWeek=sortBySpendTimeAndGroup(r[2][0]),$scope.data.prod.maxActTime=$scope.data.prod.planTotalTime,$scope.data.prod.activityPerc&&$scope.data.prod.activityPerc.grouping&&$scope.data.prod.activityPerc.grouping.totalTrackedTime&&($scope.data.prod.maxActTime=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPerc.grouping.totalTrackedTime)),$scope.data.prod.maxActTime=$scope.data.prod.maxActTime<=2400?2400:$scope.data.prod.maxActTime,"Weekly"===$scope.data.prod.periodType&&($scope.data.prod.activityPerc=$scope.data.prod.activityPercWeek)))}if($scope.data.prod.activityTime=r[0][0],$scope.data.prod.activityPerc=sortBySpendTimeAndGroup(r[1][0]),$scope.data.prod.activityPercArch=$scope.data.prod.activityPerc,$scope.data.prod.activityPercWeek=sortBySpendTimeAndGroup(r[2][0]),$scope.data.prod.maxActTime=Math.max($scope.data.prod.planTotalTime,$scope.data.prod.activityPerc.grouping.totalTrackedTime),$scope.data.prod.maxActTime=$scope.data.prod.maxActTime<480?480:$scope.data.prod.maxActTime,"Weekly"===$scope.data.prod.periodType){$scope.data.prod.activityPerc=$scope.data.prod.activityPercWeek;var maxplan=Math.max(5*$scope.data.prod.planTotalTime,$scope.data.prod.activityPercWeek.grouping.totalTrackedTime);$scope.data.prod.maxActTime=maxplan<=2400?2400:maxplan}silentUpdate||($scope.ui.isProdLoading=!1)}})["catch"](function(err){!silentUpdate&&err&&err.data&&err.data.text&&($scope.showMessage("alert-danger",err.data.text),$scope.ui.isProdLoading=!1)})};$scope.user&&$scope.user.avatarTypes.indexOf("CANDIDATE")<0&&delete s.assignmentId,s.teamId=$scope.assignment.team.id,silentUpdate?getActivity(s,!0):ProductivityService.readTeamPlannedActivities(s).$promise.then(function(p){for(var i=144;i--;)angular.isDefined(p[i])&&(p[i].startTime=str2Time(p[i].startTime),p[i].endTime=str2Time(p[i].endTime));$scope.data.prod.plan=p,$scope.data.prod.planPerc=groupPlannedActivitiesPercent(144),$scope.data.prod.planPercSimple=groupActivities($scope.data.prod.planPerc),getActivity(s,!1,forceRefresh),$scope.data.prod.timeHead=timeTable("AM","PM"),$scope.data.prod.fLoad=!1})["catch"](function(err){$scope.showMessage("alert-danger",err.data.text)})}function setTimecardFlags(timecard){timecard.isMeeting=(timecard.actions||[]).reduce(function(ret,x){return ret||"SET_MEETING_TIME"===x.actionType},!1),timecard.isIdle=!timecard.isMeeting&&timecard.autoTracker&&timecard.activityLevel<$scope.data.PRODUCTIVITY_THRESHOLD,timecard.isManual=!timecard.autoTracker,timecard.isApproved=timecard.isManual,timecard.isRejected=!1,timecard.isDisputed=timecard.rejected,timecard.isDisputeResolved=(timecard.actions||[]).reduce(function(ret,x){return ret||"RESOLVE_DISPUTE"===x.actionType},!1),timecard.expaned=$scope.ui.isListViewExpand}function calculateTime(timeInMin){var printableTime=Math.floor(timeInMin/60)+":",minutes=timeInMin%60;return printableTime+=minutes>0?minutes:"00"}function fixSubtitle(){var w=angular.element($window),fixIt=function(){w.scrollTop()>400?angular.element(".subtitleWrapper").addClass("fixed"):angular.element(".subtitleWrapper").removeClass("fixed")};w.bind("scroll",fixIt);var w1=angular.element($window),fixIt1=function(){w.scrollTop()>400?angular.element(".subtitleWrapperEnforcer").addClass("fixed"):angular.element(".subtitleWrapperEnforcer").removeClass("fixed")};w1.bind("scroll",fixIt1)}$scope.loadDiary=function(useCache,silentUpdate){if(angular.isDefined($scope.data.assignmentId)){silentUpdate||($scope.ui.isLogbookLoading=!0);var date=moment($scope.data.logbookDate).toDate(),timeZoneId=$scope.data.timezone.id,_dateWithUTCoffset=moment($scope.data.logbookDate).utc().utcOffset($scope.user.location.timeZone.hourlyOffset).format("YYYY-MM-DD"),params={id:$scope.data.assignmentId,date:_dateWithUTCoffset,timeZoneId:timeZoneId},save=function(e){var date=moment($scope.data.logbookDate).toDate(),todaysDate=new Date;date.setHours(0,0,0,0)!==todaysDate.setHours(0,0,0,0)&&$scope.data.cachedDiary.put(date,e),initDiaryElements(e)},filterTimecards=function(diary,predicate){return _.chain(diary).filter(predicate).groupBy(function(element,index){return Math.floor(index/6)}).toArray().map(function(timecards){return{hour:moment($scope.data.logbookDate).format("DD MMM YYYY"),timecards:timecards}}).value()},filterTimecardsByType=function(diary,predicate){return _.chain(diary).filter(predicate).toArray().value()},getDateWithOffset=function(date,offset){return moment(moment(date).valueOf()).utcOffset(offset/6e4).toDate()},initDiaryElements=function(diary){diary=_.map(diary,function(tc){var offset=$scope.data.timezone.offset;return tc.localDate=convertToZone(tc.date,offset),tc.events=_.map(tc.events,function(ev){return ev.localDate=convertToZone(ev.date,offset),ev}),setTimecardFlags(tc),tc.isMeeting&&tc.activityLevel>100&&(tc.activityLevel=tc.activityLevel/2),tc});var sliderdiary=_.chain(diary).sortBy("date").toArray().value();if(!(silentUpdate&&sliderdiary.length>0&&sliderdiary[0].localDate.getDate()!==$scope.data.logbookDate.getDate()||silentUpdate&&sliderdiary.length>0&&sliderdiary.length===$scope.data.sliderdiary.length&&sliderdiary[sliderdiary.length-1].localDate.getTime()===$scope.data.sliderdiary[$scope.data.sliderdiary.length-1].localDate.getTime())){$scope.data.sliderdiary=sliderdiary;var idleDiary=[],manualDiary=[],disputedDiary=[],autoTrackedDiary=[],overtimeDiary=[];idleDiary=filterTimecardsByType(diary,function(tc){return tc.isIdle}),manualDiary=filterTimecardsByType(diary,function(tc){return tc.isManual}),disputedDiary=filterTimecardsByType(diary,function(tc){return tc.isDisputed}),autoTrackedDiary=filterTimecardsByType(diary,function(tc){return tc.autoTracker}),overtimeDiary=filterTimecardsByType(diary,function(tc){return tc.overtime}),$scope.data.autoTrackedTimeLogged=calculateTime(10*autoTrackedDiary.length),$scope.data.manualTimeLogged=calculateTime(10*manualDiary.length),$scope.data.idleTimeLogged=calculateTime(10*idleDiary.length),$scope.data.disputedTimeLogged=calculateTime(10*disputedDiary.length),$scope.data.overTimeLogged=calculateTime(10*overtimeDiary.length);var totalBillingTime=autoTrackedDiary.length+manualDiary.length-(idleDiary.length+disputedDiary.length+overtimeDiary.length);if($scope.data.billableTimeLogged=calculateTime(10*totalBillingTime),"LOW_ACTIVITY"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.activityLevel<=10&&!tc.isIdle&&!tc.isManual});else if("IDLE"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isIdle});else if("MANUAL"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isManual});else if("MEETING"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isMeeting});else if("DISPUTED"===$scope.data.displayTimecards)$scope.data.diary=filterTimecards(diary,function(tc){return tc.isDisputed});else{var hourFormt="hh a";"24HOUR"===$scope.data.displayTimecards&&(hourFormt="HH"),$scope.data.diary=_.chain(diary).sortBy("date").groupBy(function(t){return getDateWithOffset(t.localDate,t.offset).getHours()}).map(function(timecards){var tcArray=new Array(6);return _.each(timecards,function(tc){tcArray[Math.floor(getDateWithOffset(tc.localDate,tc.offset).getMinutes()/10)]=tc}),{hour:moment(timecards[0].localDate).format(hourFormt),timecards:tcArray}}).value()}silentUpdate||($scope.ui.isLogbookLoading=!1,$scope.ui.hasTimecardSelected=!1,$scope.ui.onlyIdleTC=!1,$scope.ui.onlyDisputedTC=!1,$scope.ui.onlyNonDisputedTC=!1)}},err=function(e){silentUpdate||($scope.showMessage("alert-danger",e.data.text),$scope.ui.isLogbookLoading=!1)};date.setHours(0,0,0,0),useCache&&$scope.data.cachedDiary.get(date)?initDiaryElements($scope.data.cachedDiary.get(date)):AssignmentService.workDiary(params,save,err)}},$scope.detailsModal=function(tc){var hourformat="hh:mm a",fullDateHourformat="MMM, dd yyyy hh:mm a";"24HOUR"===$scope.data.displayTimecards&&(hourformat="HH:mm",fullDateHourformat="MMM, dd yyyy HH:mm"),$uibModal.open({templateUrl:"timecardDetailsModal.tpl.html",controller:"TimecardDetailsModalCtrl",backdrop:"false",windowClass:"team-member",resolve:{image:function(){return null},timecard:function(){return tc&&tc.events&&_.map(tc.events,function(ev){var offset=$scope.data.timezone.offset;return ev.localDate=convertToZone(ev.date,offset),ev}),tc},hourformat:function(){return hourformat},fullDateHourformat:function(){return fullDateHourformat}},size:"lg"})},$scope.isActionAvailable=function(timecard,action){var isActionPresent=(timecard.actions||[]).reduce(function(ret,x){return ret||angular.isDefined(x.actionType)&&x.actionType===action},!1);return isActionPresent},$scope.checkSelectedItems=function(){var i,iLock,dLock,sLock,diary=[];for(i=0;$scope.data.diary.length>i;i++)diary.push($scope.data.diary[i].timecards);var tc=_.filter(_.flatten(diary),function(t){if(angular.isDefined(t))return t.isSelected});if($scope.data.selectedTC=tc,tc.length>0){for($scope.ui.hasTimecardSelected=!0,i=0;tc.length>i;i++)tc[i].isIdle&&(iLock=!0),tc[i].isDisputed&&(dLock=!0),!tc[i].isIdle&!tc[i].isDisputed&&(sLock=!0);$scope.ui.onlyIdleTC=!!(iLock&!dLock&!sLock),$scope.ui.onlyDisputedTC=!!(!iLock&dLock&!sLock),$scope.ui.onlyNonDisputedTC=!!(!iLock&!dLock&sLock)}else $scope.ui.hasTimecardSelected=!1,$scope.ui.onlyIdleTC=!1,$scope.ui.onlyDisputedTC=!1,$scope.ui.onlyNonDisputedTC=!1},$scope.viewTimecardImg=function(size,timecard,windowClass,html){var selSlideindex=0;$scope.data.sliderdiary.some(function(value,index){return selSlideindex=index,value.id===timecard.id});var slides=$scope.data.sliderdiary,hourformat="hh:mm a";"24HOUR"===$scope.data.displayTimecards&&(hourformat="HH:mm"),windowClass=!windowClass&&timecard.isManual?"timecard-popup memo-modal":windowClass?windowClass:"timecard-popup",windowClass+=" team-member",size=timecard.isManual?"sm":size,$uibModal.open({templateUrl:html,controller:"WorkDiaryScreenshotCtrl",backdrop:"false",windowClass:windowClass,resolve:{timecard:function(){return timecard},slides:function(){return slides},selSlideindex:function(){return selSlideindex},hourformat:function(){return hourformat},offset:function(){return $scope.data.timezone.offset}},size:size})},$scope.getActionComment=function(timecard,action){var actions=timecard.actions;if(timecard&&angular.isObject(actions)){for(var count=0;count<actions.length;count++)if(actions[count]&&actions[count].actionType===action)return actions[count].comment;return"No comment found!!"}return"No comment found!!"},$scope.timezoneOffset=function(){return TimeUtils.formatUtcOffset($scope.data.timezone.offset)};var updateInterval=setInterval(function(){$scope.ui.isProdLoading||$scope.ui.isLogbookLoading||!UtilsService.isInSameWeek($scope.data.logbookDate,new Date)||($cacheFactory.get("productivityCache").removeAll(),loadProductivity($scope.assignment.id,!0,!0),$scope.loadDiary(!1,!0))},6e5);$scope.$on("$destroy",function(){clearInterval(updateInterval)}),$scope.$watch("data.assignmentId",function(nid){angular.isDefined(nid)&&!$scope.data.prod.fLoad&&(angular.element(".subtitleWrapper").removeClass("fixed"),loadProductivity(nid)),$scope.user&&$scope.user.avatarTypes.indexOf("ENFORCER")>-1&&angular.isDefined($scope.assignment)&&($scope.loadDiary(!1),fixSubtitle())}),$scope.$watch("data.logbookDate",function(v){angular.isDefined(v)&&angular.isDefined($scope.assignment)&&(loadProductivity(),$scope.loadDiary(!1),$location.search("date",$filter("date")($scope.data.logbookDate,"yyyy-MM-dd")))}),$scope.$watch("data.timezone",function(v){angular.isDefined(v)&&angular.isDefined($scope.assignment)&&$scope.loadDiary(!1)}),$scope.$watch("data.displayTimecards",function(v){angular.isDefined(v)&&angular.isDefined($scope.assignment)&&$scope.loadDiary(!1)}),$scope.$on("reload",function(){var c=$scope.assignment.selection.marketplaceMember.application.candidate;loadProductivity(c.id.assignmentId,null,!0),$cacheFactory.get("productivityCache").removeAll()}),initCachedDiary()}]),ctrls.controller("ContractorDailyLogbookDashboardContractorCtrl",["$scope","$uibModal","AssignmentService","$document",function($scope,$uibModal,AssignmentService,$document){function closeDropdown(){$document.bind("click",function(event){var isDropdown=angular.element(".dropdown").find(event.target).length>0;isDropdown||($scope.data.logbookDropdown=!1)})}function addMemoTimeCards(memo){AssignmentService.addMemo(memo).$promise.then(function(){$scope.data.isTimesheetAccessFrmCache=!1,$scope.loadDiary(!1),$scope.reload()})["catch"](function(err){$scope.memomsg={clazz:"alert-danger",show:!0,message:err.data.text},setTimeout(function(){$scope.memomsg.show=!1},1500)})}function deleteSelectedTimeCards(timecardsToDelete){$scope.ui.isLogbookLoading=!0,timecardsToDelete.forEach(function(t){delete t.actions,t.date=null}),AssignmentService.deleteWorkdiaries(timecardsToDelete).$promise.then(function(){$scope.ui.hasTimecardSelected=!1,$scope.data.isTimesheetAccessFrmCache=!1,$scope.loadDiary(!1),$scope.setUsedMeetingTimeForCurrentWeek(),$scope.reload()})["catch"](function(err){$scope.showMessage("alert-danger",err.data.text),$scope.ui.isLogbookLoading=!1})}function markSelectedTimeCardsAsNotIdle(timecards,comment){$scope.ui.isLogbookLoading=!0;var timecardIds=timecards.map(function(t){return t.id}),params={id:$scope.assignment.id,action:"SET_MEETING_TIME",timecards:timecardIds,comment:comment};AssignmentService.changToMeetingTimeWorkdiaries(params).$promise.then(function(){$scope.ui.hasTimecardSelected=!1,$scope.loadDiary(!1),$scope.setUsedMeetingTimeForCurrentWeek(),$scope.reload()})["catch"](function(err){$scope.showMessage("alert-danger",err.data.text),$scope.ui.isLogbookLoading=!1})}$scope.invokeAddMemo=function(){$scope.data.logbookDropdown=!1;var params={assignmentId:$scope.assignment.id},modalInstance=$uibModal.open({templateUrl:"contractorManualTimecardsModal.tpl.html",controller:"ContractorManualTimecardsModalCtrl",windowClass:"team-member",backdrop:"static",size:"sm",scope:$scope,resolve:{params:function(){return params}}});modalInstance.result.then(function(){addMemoTimeCards(params)})},$scope.invokeDeleteCardsConfirmation=function(){if($scope.data.logbookDropdown=!1,$scope.data.diary){var hourformat="hh:mm a";"24HOUR"===$scope.data.displayTimecards&&(hourformat="HH:mm");var timecardsToDelete=[];$scope.data.diary.forEach(function(diary){diary.timecards.forEach(function(t){t.isSelected&&timecardsToDelete.push(t)})});var modalInstance=$uibModal.open({templateUrl:"contractorDeleteTimecardsModal.tpl.html",controller:"ContractorDeleteTimecardsModalCtrl",resolve:{timecardsToDelete:function(){return timecardsToDelete},hourformat:function(){return hourformat}},backdrop:"static"});modalInstance.result.then(function(){$scope.ui.isLogbookLoading=!0,deleteSelectedTimeCards(timecardsToDelete)})}},$scope.invokeChangeNotIdleCardsConfirmation=function(){if($scope.data.logbookDropdown=!1,$scope.data.diary&&$scope.ui.onlyIdleTC){var timecards=[],comment={};$scope.data.diary.forEach(function(diary){diary.timecards.forEach(function(t){t.isSelected&&timecards.push(t)})});var modalInstance=$uibModal.open({templateUrl:"contractorNotIdleTimecardsModal.tpl.html",controller:"ContractorNotIdleTimecardsModalCtrl",resolve:{timecards:function(){return timecards},
comment:function(){return comment}},backdrop:"static"});modalInstance.result.then(function(){markSelectedTimeCardsAsNotIdle(timecards,comment.value)})}},closeDropdown()}]),ctrls.controller("ContractorDailyLogbookListView",["$scope",function($scope){$scope.$watch("ui.isCheckedAllTC",function(v){if(angular.isDefined(v)&&angular.isDefined($scope.assignment)){var i,j,iLock,dLock,sLock,stc=$scope.data.selectedTC,idleWay=$scope.ui.onlyIdleTC,disputeWay=$scope.ui.onlyDisputedTC;if(angular.isDefined(stc)&&v&&stc.length>0){for($scope.ui.hasTimecardSelected=!0,i=0;stc.length>i;i++)stc[i].isIdle&&(iLock=!0),stc[i].isDisputed&&(dLock=!0),!stc[i].isIdle&!stc[i].isDisputed&&(sLock=!0);$scope.ui.onlyIdleTC=!!(iLock&!dLock&!sLock),$scope.ui.onlyDisputedTC=!!(!iLock&dLock&!sLock)}for(i=0;$scope.data.diary.length>i;i++)for(j=0;$scope.data.diary[i].timecards.length>j;j++)if(angular.isDefined($scope.data.diary[i].timecards[j])){var tc=$scope.data.diary[i].timecards[j];tc.isDisputed||tc.isIdle||idleWay||disputeWay||(tc.isSelected=v,v&&$scope.data.selectedTC.push(tc)),idleWay&&tc.isIdle&&(tc.isSelected=v,v&&$scope.data.selectedTC.push(tc)),disputeWay&&tc.isDisputed&&(tc.isSelected=v,v&&$scope.data.selectedTC.push(tc))}$scope.data.selectedTC.length>0&&($scope.ui.hasTimecardSelected=!0),v||($scope.data.selectedTC=[],$scope.ui.hasTimecardSelected=!1,$scope.ui.onlyIdleTC=!1,$scope.ui.onlyDisputedTC=!1)}}),$scope.$watch("ui.isListViewExpand",function(v){if(angular.isDefined(v)&&angular.isDefined($scope.assignment)){var i,j;for(i=0;$scope.data.diary.length>i;i++)for(j=0;$scope.data.diary[i].timecards.length>j;j++)if(angular.isDefined($scope.data.diary[i].timecards[j])){var tc=$scope.data.diary[i].timecards[j];tc.expaned=v}}})}]),ctrls.controller("ContractorDeleteTimecardsModalCtrl",["$scope","$uibModalInstance","timecardsToDelete","hourformat",function($scope,$uibModalInstance,timecardsToDelete,hourformat){$scope.modalDiary=timecardsToDelete.sort(function(t1,t2){return t1.date-t2.date}),$scope.hourformat=hourformat,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("ContractorManualTimecardsModalCtrl",["$scope","$filter","$uibModalInstance","UtilsService","params",function($scope,$filter,$uibModalInstance,UtilsService,params){function valExTimecards(p){var endTime=moment(p.endTime).format("HH.mm"),startTime=moment(p.startTime).format("HH.mm"),now=moment().utc().utcOffset($scope.data.timezone.hourlyOffset).format("HH.mm"),isToday=UtilsService.isToday($scope.data.logbookDate),endTimeIsInFuture=now-endTime<0,startTimeIsAfterEndTime=endTime-startTime<0;if(endTime=Number(endTime),startTime=Number(startTime),now=Number(now),endTimeIsInFuture&&isToday)$scope.ui.wrongTR=!0,$scope.ui.wrongTRMessage="The time range can't be in the future";else if(startTimeIsAfterEndTime||startTime===endTime)$scope.ui.wrongTR=!0,$scope.ui.wrongTRMessage="Invalid time range";else{var startTimeRange=moment($scope.modalInstance.fromTime).toDate(),endTimeRange=moment($scope.modalInstance.toTime).toDate(),timeCardExists=UtilsService.timecardRangeExists($scope.data.diary,startTimeRange,endTimeRange);timeCardExists&&($scope.ui.wrongTR=!0,endTimeRange.getMinutes()-new Date(p.startTime).getMinutes()>10?$scope.ui.wrongTRMessage="Time cards for the selected time range already exist!":$scope.ui.wrongTRMessage="Time card for the selected time range already exists!")}}function initTimeFrame(){$scope.modalInstance.fromTime.setHours(7,0),$scope.modalInstance.toTime.setHours(7,30)}$scope.modalInstance={fromTime:moment($scope.data.logbookDate).toDate(),toTime:moment($scope.data.logbookDate).toDate(),hstep:1,mstep:10,ismeridian:!0,memoText:"",isFormInvalid:!1},$scope.fChange=function(){$scope.modalInstance.toTime=$scope.modalInstance.fromTime.getTime()+18e5},$scope.confirm=function(){return $scope.modalInstance.memoText&&""!==$scope.modalInstance.memoText.trim()?(params.startTime=moment($scope.modalInstance.fromTime).format(),params.endTime=moment($scope.modalInstance.toTime).format(),params.createDate=$filter("date")($scope.modalInstance.fromTime,"yyyy-MM-dd"),params.startTimeSel=$filter("date")($scope.modalInstance.fromTime,"HH:mm"),params.endTimeSel=$filter("date")($scope.modalInstance.toTime,"HH:mm"),params.timeZoneId=$scope.data.timezone.id,params.memo=$scope.modalInstance.memoText,params.approved=!0,valExTimecards(params),void($scope.ui.wrongTR?setTimeout(function(){$scope.ui.wrongTR=!1},1500):$uibModalInstance.close())):void($scope.modalInstance.isFormInvalid=!0)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},initTimeFrame()}]),ctrls.controller("ContractorNotIdleTimecardsModalCtrl",["$scope","$uibModalInstance","timecards","comment",function($scope,$uibModalInstance,timecards,comment){$scope.modalDiary=timecards.sort(function(t1,t2){return t1.date-t2.date}),$scope.comment=comment,$scope.confirm=function(){return $scope.comment.value&&""!==$scope.comment.value.trim()?void $uibModalInstance.close():void($scope.isFormInvalid=!0)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("TimecardDetailsModalCtrl",["$scope","$uibModalInstance","image","timecard","hourformat","fullDateHourformat",function($scope,$uibModalInstance,image,timecard,hourformat,fullDateHourformat){function initTimecard(){timecard&&($scope.timecard=timecard)}$scope.modalInstance={hourformat:hourformat,fullDateHourformat:fullDateHourformat},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},initTimecard()}]),ctrls.controller("WorkDiaryScreenshotCtrl",["$scope","$document","$uibModalInstance","timecard","slides","selSlideindex","hourformat","offset",function($scope,$document,$uibModalInstance,timecard,slides,selSlideindex,hourformat,offset){function initTimecard(){timecard&&(timecard=mapScreenshotsToTimecard(timecard),$scope.timecard=timecard),slides&&($scope.modalInstance.slides=slides.map(function(slide){return slide=mapScreenshotsToTimecard(slide)}))}function mapScreenshotsToTimecard(timecard){return timecard.screenshots=timecard.images.filter(function(image){if("SCREENSHOT"===image.type)return image}),timecard.screenshots.length>0&&(timecard.activeScreenshot=timecard.screenshots[0],timecard.activeScreenshot.active=!0),timecard}$scope.modalInstance={slides:slides,selSlideindex:selSlideindex,hourformat:hourformat,Math:window.Math,offset:offset},$scope.convertToZone=function(millis,offset){if(millis)return moment(millis).utc().utcOffset(offset/36e5).toDate()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.nextSlide=function(){$scope.modalInstance.selSlideindex>=$scope.modalInstance.slides.length-1?$scope.modalInstance.selSlideindex=0:$scope.modalInstance.selSlideindex=$scope.modalInstance.selSlideindex+1,$scope.timecard=$scope.modalInstance.slides[$scope.modalInstance.selSlideindex]},$scope.prevSlide=function(){0===$scope.modalInstance.selSlideindex?$scope.modalInstance.selSlideindex=$scope.modalInstance.slides.length-1:$scope.modalInstance.selSlideindex=$scope.modalInstance.selSlideindex-1,$scope.timecard=$scope.modalInstance.slides[$scope.modalInstance.selSlideindex]},$scope.fullScreenSize=function(){angular.element(".modal ").removeClass("timecard-popup"),angular.element(".modal ").addClass("timecard-popup-large")},$scope.selectScreenshot=function(ss){$scope.timecard.activeScreenshot=ss,$scope.timecard.screenshots.forEach(function(x){x.active=!1}),ss.active=!0},$document.on("keydown",function(evt){$scope.keycode=evt.which,$scope.keycode&&39===$scope.keycode&&$scope.modalInstance.selSlideindex<$scope.modalInstance.slides.length-1?$scope.nextSlide():$scope.keycode&&37===$scope.keycode&&$scope.modalInstance.selSlideindex>0&&$scope.prevSlide(),$scope.$apply()}),initTimecard()}]),ctrls.controller("WorkDiaryWebcamImageCtrl",["$scope","$uibModalInstance","image","timecard","hourformat",function($scope,$uibModalInstance,image,timecard,hourformat){$scope.Math=window.Math,$scope.hourformat=hourformat,$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.image=image,timecard&&($scope.timecard=timecard)}]),ctrls.controller("ContractorMetricsController",["$scope","$timeout","UtilsService","TeamService","MetricsDisplayService",function($scope,$timeout,UtilsService,TeamService,MetricsDisplayService){function xAxisLabelFormatter(){var start=moment(new Date(this.value)),end=moment(start).add(6,"days");return start.format("MMM DD")+"<br/>"+end.format("MMM DD")}function setLabelBold(label){$(".highcharts-axis-labels tspan:contains("+label+")").css("font-weight","bold")}function resetLabelWeight(){$(".highcharts-axis-labels tspan").css("font-weight","normal")}function initBoldListener(date,chartId){var chartContainer=$(chartId).highcharts().container,boldStart=moment(date).format("MMM DD"),boldEnd=moment(boldStart).add(6,"days").format("MMM DD");resetLabelWeight(),setLabelBold(boldStart),setLabelBold(boldEnd),chartContainer.onmouseleave=function(){resetLabelWeight()}}function getColorIndexByName(name){for(var colorIndex=0,i=0;i<$scope.metricsData.jiraStats.length;i++)$scope.metricsData.jiraStats[i].name===name&&(colorIndex=$scope.metricsData.jiraStats[i].colorIndex);return colorIndex}function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg},setTimeout(function(){$scope.msg.show=!1},6e3)}function calculateSeries(data,type){var dataPoints=[];if("Team Average"===type){_.each(data,function(contractor){$scope.metricsData.colors[contractor.name]=UtilsService.getHexColor(contractor.colorIndex)});var allStats=_.chain(data).map("stats").flatten().value(),weeklyTeamMetrics=MetricsDisplayService.calWeeklyTeamMetrics(allStats);dataPoints=_.map(weeklyTeamMetrics,function(week){return[moment(week.startDate).valueOf(),week.unitPerAssignment]})}else{var candData=_.find(data,function(c){return c.name===type});if(candData)for(var k=0;k<candData.stats.length;k++){var ticketsCount=candData.stats[k].ticketsResolved;dataPoints.push([moment(candData.stats[k].startDate).valueOf(),ticketsCount])}}return dataPoints.sort(function(a,b){return a[0]-b[0]}),dataPoints}function getSeriesObject(data,name){var res={id:name,type:"area",dashStyle:"Solid",pointInterval:6048e5,name:name,data:calculateSeries(data,name),fillColor:"transparent",marker:{fillColor:"#FFFFFF",lineWidth:2,lineColor:null,symbol:"circle"}};return"Team Average"===name?(res.color="#02A8F3",$scope.metricsData.colors["Team Average"]=res.color,res.lineWidth=4):(res.color=UtilsService.getHexColor(getColorIndexByName(name)),$scope.metricsData.colors[name]=res.color),res}function getVelocitySeries(data){var series=[];angular.forEach(data,function(week){series.push([moment(week.date).valueOf(),week.data.totalResolved])});var res={pointInterval:6048e5,pointWidth:28,data:series,color:"#6EBAF7"};return res}function getMetrics(){$scope.metricsData.colors=[],$scope.assignment.jiraSetup?$scope.metricSetup=$scope.assignment.jiraSetup:$scope.assignment.zendeskSetup&&($scope.metricSetup=$scope.assignment.zendeskSetup),$scope.metricsData.metricName=$scope.assignment.activeMetricName,getTeamStats()}function getTeamStats(){$scope.timeWindow=$scope.getTimeWindow($scope.metricsData.weeks||4),$scope.hasMetricSetting=!!$scope.assignment.activeMetricType,$scope.hasMetricSetting&&TeamService.getMetricValues({id:$scope.assignment.team.id,from:$scope.timeWindow.from,to:$scope.timeWindow.to,type:$scope.assignment.activeMetricType,managerId:$scope.assignment.currentAssignmentHistory.manager.id},function(res){function calculateAverage(cand){var weeks=0,tickets=0;angular.forEach(cand.stats,function(week){tickets+=week.ticketsResolved,weeks+=1,startDates[week.startDate].totalResolved+=week.ticketsResolved,startDates[week.startDate].teamSize+=1}),weeks>0&&tickets>0&&(cand.perWeek=tickets/weeks)}function calculateWeekStats(stats){angular.forEach(stats,function(stat){startDates[stat.startDate]={perEmployee:0,teamSize:0,totalResolved:0}})}var startDates=[],teamAverageSum=0,candidatesWorked=0;$scope.metricsData.jiraStats=res,$scope.metricsData.candidateStats=[];for(var i=0,len=$scope.metricsData.jiraStats.length;i<len;i++)$scope.metricsData.jiraStats[i].colorIndex=i,addMissedWeeks($scope.metricsData.jiraStats[i],$scope.metricsData.weeks||4);if($scope.metricsData.jiraStats.length>0&&calculateWeekStats($scope.metricsData.jiraStats[0].stats||[]),angular.forEach($scope.metricsData.jiraStats,function(entry){entry.perWeek=0,calculateAverage(entry),$scope.assignment.selection.marketplaceMember.application.candidate.printableName===entry.name&&$scope.metricsData.candidateStats.push({name:entry.name,perWeek:entry.perWeek}),teamAverageSum+=entry.perWeek,candidatesWorked+=1}),candidatesWorked>0?$scope.metricsData.teamAverage=teamAverageSum/candidatesWorked:$scope.metricsData.teamAverage=0,0===$scope.metricsData.chartConfig.series.length)$scope.metricsData.chartConfig.series.push(getSeriesObject(res,"Team Average")),$scope.ui.showAverage=!0;else for(i=0,len=$scope.metricsData.chartConfig.series.length;i<len;i++){var current=$scope.metricsData.chartConfig.series[i];$scope.metricsData.chartConfig.series[i]=getSeriesObject(res,current.id)}$scope.metricsData.velocity=[],$scope.metricsData.weekAverage=0;for(var k in startDates){startDates[k].teamSize>0&&(startDates[k].perEmployee=startDates[k].totalResolved/startDates[k].teamSize);var label=moment(new Date(k)).format("MMM DD")+" - "+moment(new Date(k)).add(6,"days").format("MMM DD");$scope.metricsData.weekAverage+=startDates[k].totalResolved,$scope.metricsData.velocity.push({label:label,date:k,data:startDates[k],dateValue:new Date(k).getTime()})}$scope.metricsData.velocity.sort(function(a,b){return new Date(a.date).getTime()-new Date(b.date).getTime()}),$scope.metricsData.weekAverage/=$scope.metricsData.velocity.length,$scope.metricsData.velocityChartConfig.series=[getVelocitySeries($scope.metricsData.velocity)],$scope.metricsData.startDates=startDates,toggleSelection($scope.assignment.selection.marketplaceMember.application.candidate.printableName)},function(err){showMessage("alert-danger",err.data.text)})}function toggleSelection(key){var series=$scope.metricsData.chartConfig.series,obj=_.find(series,function(s){return s.id===key});obj||$scope.metricsData.chartConfig.series.push(getSeriesObject($scope.metricsData.jiraStats,key))}function addMissedWeeks(contractorStats,numberOfWeeks){var stats=contractorStats.stats||[];contractorStats.stats=stats;for(var i=1;i<=numberOfWeeks;i++){var week=moment().subtract(i,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),found=stats.filter(function(s){return s.startDate===week}).pop();found||stats.push({startDate:week,ticketsResolved:0})}}$scope.metricsData={chartType:"Efficiency",chartTarget:"Tickets",weeks:4,activeChart:"lineChart",metricName:"",viewMode:"chart",tableView:{ownStats:null}},$scope.metricsData.velocityChartConfig={title:{text:""},options:{chart:{type:"column"},legend:{enabled:!1},tooltip:{useHTML:!0,formatter:function(){var weekStats,d=moment(new Date(this.x)).format("YYYY-MM-DD");return weekStats=$scope.metricsData.startDates[d],initBoldListener(d,"#chartC"),"Total Resolved: <b>"+weekStats.totalResolved+"</b> <br/> Team Size: <b>"+weekStats.teamSize+"</b><br/> Per Contractor: <b>"+weekStats.perEmployee.toFixed(1)}}},xAxis:{type:"datetime",labels:{formatter:xAxisLabelFormatter},tickInterval:6048e5,title:{text:""},gridLineWidth:1},yAxis:{title:{text:""}},series:[],plotOptions:{column:{pointWidth:40}}},$scope.metricsData.chartConfig={plotOptions:{series:{marker:{fillColor:"#FFFFFF",lineWidth:2,lineColor:null},connectNulls:!1}},title:{text:""},xAxis:{type:"datetime",labels:{formatter:xAxisLabelFormatter},tickInterval:6048e5,title:{text:""},gridLineWidth:1},yAxis:{title:{text:""},min:0,gridLineDashStyle:"Dot"},options:{chart:{type:"line",events:{load:function(){var chart=this;$timeout(function(){chart.reflow()})}}},legend:{enabled:!1},tooltip:{useHTML:!0,formatter:function(){var weekStats,d=moment(new Date(this.x)).format("YYYY-MM-DD");if(initBoldListener(d,"#chartC"),"Team Average"===this.series.name){weekStats=$scope.metricsData.startDates[d];var content="Per Team Member: <b>"+weekStats.perEmployee.toFixed(1)+"</b> <br/> Team Size: <b>"+weekStats.teamSize+"</b><br/> Total Units: <b>"+weekStats.totalResolved;return content}var name=this.series.name,personalStats=_.find($scope.metricsData.jiraStats,function(s){return s.name===name});weekStats=_.find(personalStats.stats,function(obj){return obj.startDate===d});var popUpContent="<b>"+name+"</b><br/>";return popUpContent+="Units:<b>"+weekStats.ticketsResolved}}},series:[],loading:!1,useHighStocks:!1},$scope.getTimeWindow=function(numberOfWeeks){if(numberOfWeeks<=0)throw new Error("Number of weeks should be greater than 0");var currentWeek=1,from=moment().subtract(numberOfWeeks,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY),to=moment().subtract(currentWeek,"weeks").weekday(moment.DAY_OF_WEEK.SUNDAY);return{from:from.format(moment.DateFormat.ISO_8601),to:to.format(moment.DateFormat.ISO_8601),numberOfWeeks:numberOfWeeks}},$scope.$watch("metricsData.weeks",function(){getMetrics()}),$scope.getOwnMetrics=function(teamStats,asgID){return _.findWhere(teamStats,{assignmentId:asgID})},$scope.$watch("metricsData.jiraStats",function(){$scope.metricsData.tableView.ownStats=$scope.getOwnMetrics($scope.metricsData.jiraStats,$scope.assignment.id)})}]),ctrls.controller("ContractorMetricsDashboardCtrl",["$scope","DownloadService",function($scope,DownloadService){$scope.downloadReport=function(){var asgnId,timeWindow=$scope.getTimeWindow(12),params={from:timeWindow.from,to:timeWindow.to,type:$scope.assignment.activeMetricType};asgnId=$scope.user&&$scope.user.avatarTypes.indexOf("CANDIDATE")>-1?$scope.assignment.id:$scope.teamMemberShow,DownloadService.download("/assignments/"+asgnId+"/metric/values",params)}}]),ctrls.contractorMyTeamGlobal={build:function(make,skipLinking,ctrl){if(make)for(var cat in make)if(this[cat]||(this[cat]=new Object),"object"==typeof make[cat])for(var item in make[cat])this[cat][item]=make[cat][item];else this[cat]=make[cat];if(make["do"]&&!skipLinking&&(this["do"].srv=this.srv,this["do"].data=this.data,this["do"].ui=this.ui),make.data)for(var d in make.data)"string"==typeof make.data[d]?this.data[d]=this["do"][make.data[d]]():this.data[d]=make.data[d];if(ctrl)for(var t in this)ctrl[t]=this[t]}},ctrls.controller("ContractorMyTeamCtrl",["$scope","CurrentUser","TeamService","AssignmentService","$q","$document",function($scope,CurrentUser,TeamService,AssignmentService,$q,$document){var home={getUserRole:function(user){function isRole(type){return user.avatarTypes.indexOf(type)>-1}return isRole("COMPANY_ADMIN")?"Admin":isRole("MANAGER")?"Manager":"Contractor"},getCurrentUser:function(){var gl=this;return this.srv.user.get().$promise.then(function(u){gl.data.currentUser=u,gl.data.currentUser.role=gl.getUserRole(u),gl.ui.loading.user=!1})},getTeam:function(){var gl=this;return this.srv.asg.teamAssignments({teamId:gl.data.asg.team.id,status:"ACTIVE",avatarType:"CANDIDATE",fullTeam:!0,limit:1e3})},getTeamOnlineStatus:function(){var gl=this;return this.srv.asg.getLatestWorkDiaries({teamId:gl.data.asg.team.id,fullTeam:!0})},getTeamProductivity:function(){var gl=this;return this.srv.team.teamAvg({id:gl.data.asg.team.id,avatarType:"CANDIDATE"})},getAssignment:function(){var gl=this;return this.srv.asg.get({avatarType:"CANDIDATE",status:"ACTIVE"}).$promise.then(function(response){gl.data.asg=response.content[0],gl.ui.loading.assignment=!1,gl.loadTeamMembers()})},initTeam:function(){return{members:null,productivity:null,activity:null,online:null,chartConfig:null}}},srv={user:CurrentUser,scope:$scope,team:TeamService,asg:AssignmentService,$q:$q},ui={loading:{team:!0,productivity:!0,user:!0,assignment:!0},error:{message:null}},data={currentUser:"getCurrentUser",team:"initTeam",asg:"getAssignment"},vm=this,make={"do":home,srv:srv,ui:ui,data:data};$document.bind("click",function(event){$scope.vm.data.skype.show&&!angular.element(event.target).hasClass("skype-el")&&($scope.vm.data.skype=null),$scope.$apply()}),$scope.$on("$destroy",function(){$document.unbind("click")}),ctrls.contractorMyTeamGlobal.build(make,!1,vm)}]),ctrls.controller("ContractorMyTeamDetailBoxCtrl",[function(){var detailBox={handleContractorHover:function(event,contractor,offset,type){type||(type="popup");var gl=this,rd=offset?offset:angular.element("#my-team").offset();return event||contractor?(gl.data.selectedContractor=contractor,"popup"===type&&(gl.data.skype=null,gl.data[type]={x:event.pageX-rd.left-event.offsetX+event.currentTarget.clientWidth,y:event.pageY-rd.top-event.offsetY-40,show:!0}),void("skype"===type&&(gl.data[type]={},gl.data[type].skypeId=contractor.skypeId,gl.data[type].show=!0,gl.data[type].x=event.pageX-event.offsetX,gl.data[type].y=event.pageY-event.offsetY-38))):(gl.data.selectedContractor=null,void(gl.data.popup=null))},getSkypeTest:function(skypeEnabled){return skypeEnabled?"":"Please ask this person to enter their Skype ID in their profile."},getLocation:function(contractor){if("Unknown"===contractor.location.country.name)return contractor.location.country.name;var country=contractor.location.country.name,city=contractor.location.city;return city?country+", "+city:country},getTime:function(contractor){var offset=contractor.location.timeZone.hourlyOffset,time=moment().utcOffset(offset).format("LT");return time+" local time"}},vm=this,make={"do":detailBox};ctrls.contractorMyTeamGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorMyTeamLeftCtrl",[function(){var leftSide={loadTeamMembers:function(){var gl=this,getTeamPromise=gl.getTeam().$promise,getTeamOnlineStatusPromise=gl.getTeamOnlineStatus().$promise,promises=[getTeamPromise,getTeamOnlineStatusPromise];gl.srv.$q.all(promises).then(function(response){var teamMembers=response[0].content,teamMembersOnline=response[1];teamMembers=teamMembers.map(function(member){var c=member.selection.marketplaceMember.application.candidate,online=_.findWhere(teamMembersOnline,{candidateId:c.id}),manager=gl.data.asg.manager.id,teamMemberManager=member.manager.id;if(manager===teamMemberManager)return{id:c.id,photoUrl:c.photoUrl,printableName:c.printableName,jobTitle:member.jobTitle,online:online,location:c.location,manager:member.manager,team:member.team,skypeId:c.skypeId}}).filter(Boolean),gl.data.team.members=_.sortBy(teamMembers,"printableName"),gl.data.team.online=teamMembersOnline,gl.ui.loading.team=!1,setTimeout(function(){gl.getLatestWorkDiaries()},3e4),gl.loadTeamProductivity()})["catch"](function(err){err&&err.data&&err.data.text&&(gl.ui.error.message=err.data.text)})},getOnline:function(tc){if(tc){var diff=moment().valueOf()-tc.date;return diff/=6e4,diff<=29||void 0}},getWorkerImg:function(idx){return idx>5?this.getWorkerImg(idx-5):idx},getLatestWorkDiaries:function(refresh){var gl=this;clearInterval(refresh),gl.getTeamOnlineStatus().$promise.then(function(teamMembersOnline){var teamMembers=gl.data.team.members;teamMembers=teamMembers.map(function(member){var online=_.findWhere(teamMembersOnline,{candidateId:member.id});return{id:member.id,photoUrl:member.photoUrl,printableName:member.printableName,jobTitle:member.jobTitle,online:online}}),refresh=setInterval(function(){gl.getLatestWorkDiaries(refresh)},3e4)})}},vm=this,make={"do":leftSide};ctrls.contractorMyTeamGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorMyTeamRightCtrl",[function(){var rightSide={loadTeamProductivity:function(){var gl=this;gl.getTeamProductivity().$promise.then(function(response){var teamProducitity=response;gl.data.team.productivity=teamProducitity,gl.data.team.chartConfig=gl.getChart(teamProducitity),gl.data.team.activity=teamProducitity.activitiAvg})["catch"](function(err){err&&err.data&&err.data.text&&(gl.ui.error.message=err.data.text)})},fillWeeksRangeArr:function(countOfWeeks,delFirst){var weeksRange=[],sun=moment().endOf("isoWeek").toDate();for(delFirst&&(sun=moment(sun).subtract(7,"days").toDate());countOfWeeks--;)weeksRange.push(sun),sun=moment(sun).subtract(7,"days").toDate();return weeksRange},getChart:function(d){var gl=this,mTarget=d.metricAvg.metricTarget?d.metricAvg.metricTarget:0,avgScore=d.metricAvg.statsMetricAvg?d.metricAvg.statsMetricAvg.reduce(function(a,b){return a+b})/4:0,metric={name:d.metricAvg.metricName?d.metricAvg.metricName:"No metric",data:d.metricAvg.statsMetricAvg?d.metricAvg.statsMetricAvg:[],allowPointSelect:!0,dataLabels:{enabled:!0,backgroundColor:"#ffffff",borderRadius:10,padding:5,shadow:{color:"#000000",offsetX:0,offsetY:1,opacity:.2,width:2},align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},format:"{point.y:,.1f}",y:-6},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3",symbol:"circle"},states:{select:{enabled:!1}},color:"#e5f6fe",zIndex:1},target={id:1,type:"line",dashStyle:"Dot",color:"#02a8f3",cursor:"pointer",visible:0!==mTarget,data:[mTarget,mTarget,mTarget,{y:mTarget,marker:{enabled:!0,symbol:"url(images/icons/5b20372c.metric-target-icon.png)"}}],stickyTracking:!1,marker:{enabled:!1},tooltip:{pointFormatter:function(){return"Metric Target: <b>"+this.y+"</b>"}},states:{hover:{enabled:!1}},zIndex:2},config={options:{chart:{type:"area"},legend:{enabled:!1},tooltip:{headerFormat:""},credits:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return moment(gl.fillWeeksRangeArr(4,!0)[this.value]).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"},padding:0},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,lineWidth:0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},yAxis:{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""}},series:[],avgScore:avgScore,avgPerc:mTarget?100*avgScore/mTarget:0};return d.metricAvg.statsMetricAvg&&config.series.push(metric),mTarget&&config.series.push(target),config}},vm=this,make={"do":rightSide};ctrls.contractorMyTeamGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorSearchCtrl",["$scope","$routeParams","$location","AssignmentService",function($scope,$routeParams,$location,AssignmentService){function openProfile(){if(search.data.selectedContractor.id){var path="/profile/contractor-profile/"+search.data.selectedContractor.id;$location.path(path)}}function capitalizeFirstLetter(string){if(string){var strings=string.toLowerCase().split(" ");return strings.length>0?(strings=strings.map(function(string){return string.charAt(0).toUpperCase()+string.slice(1)}),strings.join(" ")):string.charAt(0).toUpperCase()+string.slice(1)}}function getLocation(){if("Unknown"===search.data.selectedContractor.location.country.name)return search.data.selectedContractor.location.country.name;var country=capitalizeFirstLetter(search.data.selectedContractor.location.country.name),city=capitalizeFirstLetter(search.data.selectedContractor.location.city);return city?country+", "+city:country}function getTime(){if(search.data.selectedContractor&&search.data.selectedContractor.location&&search.data.selectedContractor.location.timeZone&&search.data.selectedContractor.location.timeZone.hourlyOffset){var offset=search.data.selectedContractor.location.timeZone.hourlyOffset,time=moment().utcOffset(offset).format("LT");return time+" local time"}return"Unknown"}function handleContractorHover(event,contractor){if(!search.ui.isPageLoading){if(!event&&!contractor)return search.data.selectedContractor={},void(search.data.popup={x:null,y:null,show:!1});search.data.selectedContractor=contractor;var rd=angular.element("#contractor-search").offset();search.data.popup={x:event.pageX-rd.left-event.offsetX+event.currentTarget.clientWidth,y:event.pageY-rd.top-event.offsetY-157,show:!0}}}function sortTable(sortType){sortType===search.data.table.sortType&&(search.data.table.sortReverse=!search.data.table.sortReverse),search.data.table.sortType=sortType}function clearError(){search.data.error={}}function showError(err){err&&err.data&&(search.data.error=err.data,clearTimeout(search.data.errorTimeout),search.data.errorTimeout=setTimeout(function(){clearError()},1e4))}function update(){searchUser({page:search.data.page})}function query(){typewatch(search.data.query,function(){searchUser({query:search.data.query})},300)}function typewatch(string,cb,time){time=time||1e3,clearTimeout(search.data.typewatchTimer),search.data.typewatchTimer=setTimeout(function(){return cb()},time)}function searchUser(opt){function getPage(){return 0===Number(search.data.page)?0:Number(search.data.page)-1}opt.page||(search.data.page=0),opt.query||(opt.query=search.data.query),search.ui.isPageLoading=!0;var params={q:opt.query,page:getPage(),myCompany:$routeParams.myCompany||null};params.q||(params.q=null),AssignmentService.search(params).$promise.then(function(res){search.data.totalPages=res.totalPages,search.data.totalItems=res.totalElements,search.data.page=res.number+1,search.data.size=res.size,search.data.assignments=res.content.map(function(asg){var c=asg.selection.marketplaceMember.application.candidate,o={};return o.picture=c.photoUrl,o.email=c.email,o.firstName=c.firstName,o.lastName=c.lastName,o.jobTitle=asg.jobTitle,o.id=asg.id,o.team=asg.team.name,o.company=asg.team.company.name,o.location=c.location,angular.isDefined(c)||(o.team="Not in a team",o.company="Not in a company",o.location={country:{name:"Unknown"},city:"Unknown"}),o})})["catch"](showError)["finally"](function(){search.ui.isLoading=!1,search.ui.isPageLoading=!1})}var search=this;search.data={assignments:[],assignment:{},query:"",page:1,totalPages:0,totalItems:0,size:10,typewatchTimer:0,table:{sortType:"firstName",sortReverse:!1,searchQuery:"",headers:[{name:"Picture",id:"picture",hide:!0},{name:"First name",id:"firstName",hide:!1},{name:"Last name",id:"lastName",hide:!1},{name:"Email",id:"email",hide:!1},{name:"Title",id:"jobTitle",hide:!1},{name:"Team",id:"team",hide:!1},{name:"Company",id:"company",hide:!1}]},error:{errorCode:null,httpStatus:null,text:null,type:null},errorTimeout:0,selectedContractor:{},popup:{x:null,y:null,show:!1}},search.ui={isLoading:!0,isPageLoading:!1},search.fn={update:update,query:query,sortTable:sortTable,handleContractorHover:handleContractorHover,getTime:getTime,getLocation:getLocation,openProfile:openProfile},searchUser({query:$routeParams.id})}]),ctrls.controller("ContractorEarningsController",["$scope","EarningsService","$location","PaymentReportService",function($scope,EarningsService,$location,PaymentReportService){function closeModal(){earnings.data.modal=!1}function openLogbook(date){var monday=moment(date).startOf("week").format("YYYY-MM-DD");$location.search({date:monday,view:"dailyLogbook"}),earnings.data.modal=!0}function handleFromDatePickerChange(){loadEarnings(moment(earnings.data.earningsFromDate).format("YYYY-MM-DD"),moment(earnings.data.earningsToDate).format("YYYY-MM-DD"))}function showError(err){err&&err.data&&(earnings.data.error=err.data)}function clearError(){earnings.data.error={}}function capitalizeFirstLetter(string){return string=string.toLowerCase(),string.charAt(0).toUpperCase()+string.slice(1)}function loadEarnings(from,to){return earnings.ui.isEarningsLoading=!0,clearError(),from||(from=moment().add(-8,"weeks").format("YYYY-MM-DD")),to||(to=moment().format("YYYY-MM-DD")),EarningsService.list({from:from,to:to}).$promise.then(function(res){return earnings.data.earnings=res.map(function(earning){return earning.status=capitalizeFirstLetter(earning.status),earning.platform=capitalizeFirstLetter(earning.platform),earning.timeSheet&&(earning.logged_hours=earning.timeSheet.tracked_minutes/60,earning.manual=earning.timeSheet.approved_manual_minutes/60,earning.disputed=earning.timeSheet.disputed_minutes/60,earning.payment_hours=earning.timeSheet.billed_minutes/60),earning}),res})["catch"](showError)["finally"](function(){earnings.ui.isEarningsLoading=!1})}var earnings=this;earnings.data={assignment:{},earningsFromDate:moment().subtract(8,"weeks").format("YYYY-MM-DD"),
earningsToDate:moment().format("YYYY-MM-DD"),today:moment().format("YYYY-MM-DD"),isFromDatepicker:!1,isToDatepicker:!1,earnings:[],dateOptions:{showWeeks:!1,startingDay:1},table:{sortType:"start_date",sortReverse:!0,searchQuery:"",headers:[{name:"Team",id:"team.name"},{name:"Payment platform",id:"platform"},{name:"Logged hours",id:"logged_hours"},{name:"Manual",id:"manual"},{name:"Disputed",id:"disputed"},{name:"Payment hours",id:"payment_hours"},{name:"Weekly limit",id:"weeklyLimitHours"},{name:"Net payment",id:"amount"},{name:"Payment status",id:"start_date"}]},error:{errorCode:null,httpStatus:null,text:null,type:null},modal:!1},earnings.error={isError:!1,msg:"Failed to load earnings."},earnings.ui={isEarningsLoading:!0},earnings.fn={handleFromDatePickerChange:handleFromDatePickerChange,openLogbook:openLogbook,closeModal:closeModal},earnings.downloadPdf=function(){earnings.ui.isEarningsLoading=!0;var fileName="IncomeStatement.pdf",a=document.createElement("a");document.body.appendChild(a),a.style="display: none",PaymentReportService.downloadPdf(moment(earnings.data.earningsFromDate).format("YYYY-MM-DD"),moment(earnings.data.earningsToDate).format("YYYY-MM-DD")).then(function(result){var finalData=result.data,file=new Blob([finalData],{type:"application/pdf"}),fileURL=window.URL.createObjectURL(file);a.href=fileURL,a.download=fileName,a.click()})["catch"](showError)["finally"](function(){earnings.ui.isEarningsLoading=!1})},earnings.getCsv=function(){var report=earnings.data.earnings.sort(function(a,b){return moment(b.start_date).toDate().getTime()-moment(a.start_date).toDate().getTime()}).map(function(earning){var r={};return r.team_name=earning.team.name,r.payment_platform=earning.platform,r.logged_hours=earning.logged_hours,r.manual=earning.manual,r.disputed=earning.disputed,r.payment_hours=earning.payment_hours,r.weeklyLimitHours=earning.weeklyLimitHours,r.amount=earning.amount,r.payment_status=earning.status+" "+earning.start_date,r});return report},earnings.getCsvHeaders=function(){var headers=earnings.data.table.headers.map(function(header){return header.name});return headers},earnings.dateRangeFilter=function(property){return function(item){if(angular.isUndefined(item[property]))return!1;var dateChecked=moment(item[property]).format("x"),s=moment(earnings.data.earningsFromDate).format("x"),e=moment(earnings.data.earningsToDate).format("x");return dateChecked>=s&&dateChecked<=e}},earnings.sortEarningsTable=function(sortType){sortType===earnings.data.table.sortType&&(earnings.data.table.sortReverse=!earnings.data.table.sortReverse),earnings.data.table.sortType=sortType},loadEarnings()}]),ctrls.controller("ContractorAssignmentsController",["$scope","CurrentUser",function($scope,CurrentUser){$scope.data={assignments:[]},$scope.ui={isLoading:!0,error:null,table:{headers:[{name:"Date",id:"effectiveDateBegin"},{name:"Job",id:"jobTitle"},{name:"Company",id:"company"},{name:"Team",id:"team"},{name:"Manager",id:"manager"},{name:"Rate",id:"salary"},{name:"Contract Type",id:"salaryType"},{name:"Weekly Limit",id:"weeklyLimit"},{name:"Status",id:"status"}],sortType:"effectiveDateBegin",sortReverse:!0}},$scope.sortTable=function(sortType){sortType===$scope.ui.table.sortType&&($scope.ui.table.sortReverse=!$scope.ui.table.sortReverse),$scope.ui.table.sortType=sortType};var currentHistoryStatusList=["PENDING","CANDIDATE_ACCEPTED","MANAGER_SETUP","PAYMENT_APPROVED","ACTIVE"];CurrentUser.getAssignments().$promise.then(function(res){var assignments=[];res.forEach(function(a){a.assignmentHistories.forEach(function(history){var item=angular.copy(history);item.effectiveDateBegin=moment(history.effectiveDateBegin).toDate(),item.effectiveDateEnd=history.effectiveDateEnd?moment(history.effectiveDateEnd).toDate():null,history.team?(item.company=history.team.company.name,item.team=history.team.name):item.company=history.manager.company.name,item.manager=history.manager.printableName,item.jobTitle=a.jobTitle,item.isCurrent=a.currentAssignmentHistory.id===history.id&&currentHistoryStatusList.indexOf(history.status)>=0,item.isScheduled="SCHEDULED"===history.assignmentHistoryStatus,assignments.push(item)})}),$scope.data.assignments=assignments,$scope.ui.error=null})["catch"](function(err){$scope.ui.error=err.data})["finally"](function(){$scope.ui.isLoading=!1})}]),ctrls.contractorWidgetsGlobal={build:function(make,skipLinking,ctrl){if(make)for(var cat in make)if(this[cat]||(this[cat]=new Object),"object"==typeof make[cat])for(var item in make[cat])this[cat][item]=make[cat][item];else this[cat]=make[cat];if(make["do"]&&!skipLinking&&(this["do"].srv=this.srv,this["do"].data=this.data,this["do"].ui=this.ui),make.data)for(var d in make.data)"string"==typeof make.data[d]?this.data[d]=this["do"][make.data[d]]():this.data[d]=make.data[d];if(ctrl)for(var t in this)ctrl[t]=this[t]}},ctrls.controller("ContractorWidgetsCtrl",["$scope","TeamService","AssignmentService","$q","TimeUtils","$filter","ProductivityService","UtilsService","$location","$timeout",function($scope,TeamService,AssignmentService,$q,TimeUtils,$filter,ProductivityService,UtilsService,$location,$timeout){var home={loadWidgets:function(date){var gl=this;gl.ui.loading.weeklyTimeSheet=!0,gl.ui.loading.timeTracked=!0,gl.ui.loading.fourWeeksTimeSheet=!0,gl.ui.loading.lastTimeCard=!0,gl.ui.loading.applicationsUsed=!0,gl.ui.loading.activities=!0,gl.ui.loading.metrics=!0,gl.data.charts={},gl.data.activities={},gl.data.applicationsUsed={},gl.data.logbook={},gl.data.metrics=[],gl.data.timeTracked={},gl.srv.$timeout(function(){gl.getWeeklyTimeSheets(date),gl.getFourWeeksTimeSheets(date),gl.getApplicationsUsed(date),gl.getActivities(date),gl.getMetrics(date),gl.initTeamMembers()},10)},getAssignment:function(){var gl=this;return this.srv.asg.get({avatarType:"CANDIDATE",status:"ACTIVE"}).$promise.then(function(response){gl.ui.loading.asg=!1,gl.data.asg=response.content[0],gl.data.asg&&(gl.data.candidate=response.content[0].selection.marketplaceMember.application.candidate,gl.data.date.dateOptions.minDate=gl.data.asg.startDate,gl.loadWidgets(gl.data.date.dateSelected))})["finally"](function(){gl.ui.loading.info=!1})},getBarColor:function(hours,limit,lowValue){var colors={green:"#4caf50",yellow:"#ffd54f",red:"#f44336"};return hours>=limit?colors.green:hours<limit&&hours>lowValue?colors.yellow:colors.red},initSummary:function(){return{security:[{tooltip:"Take webcam photos every 10 minutes",image:"images/icons/d1408b03.webcam-icon.png",icon:"ciWebcam",setting:"WEBCAM_PICTURES",feature:"Webcam"},{tooltip:"Take screenshot every 10 minutes",image:"images/icons/22674b8c.screenshot-icon.png",icon:"ciScreenshots",setting:"SCREENSHOTS",feature:"Screenshots"},{tooltip:"Capture the name of the applications/website used",image:"images/icons/3050af25.application-icon.png",icon:"ciApplications",setting:"APPLICATION_TRACKING",feature:"Applications"},{tooltip:"Let Crossover's Productivity Team review the activity and dispute timecards",image:"images/icons/af5b12b5.enforcer-view-icon.png",icon:"ciReview",setting:"ENFORCER_REVIEW",feature:"Review"}]}},initDate:function(){var gl=this,date=gl.srv.$location.search().date;return{dateSelected:moment(date).format(),today:moment().format(),currentWeekformatted:gl.srv.utils.getWeekText(date),dateOptions:{showWeeks:!1,startingDay:1,maxDate:moment().format()}}},initTeamMembers:function(){var gl=this;gl.srv.asg.teamAssignments({teamId:gl.data.asg.team.id,status:"ACTIVE",avatarType:"CANDIDATE",fullTeam:!0,limit:1e3}).$promise.then(function(teamMembers){vm.data.teamMembers=teamMembers.content.filter(function(teamMember){var managerId=gl.data.asg.manager.id;if(managerId===teamMember.manager.id)return teamMember})})}},srv={scope:$scope,team:TeamService,asg:AssignmentService,$q:$q,TimeUtils:TimeUtils,$filter:$filter,prod:ProductivityService,utils:UtilsService,$location:$location,$timeout:$timeout},ui={loading:{team:!0,user:!0,assignment:!0,weeklyTimeSheet:!0,fourWeeksTimeSheet:!0,applicationsUsed:!0,metrics:!0,activities:!0,logbook:!0,info:!0,lastTimeCard:!0,timeTracked:!0,asg:!0,timeCards:!0},timecards:{scrolling:"horizontal"}},data={asg:"getAssignment",date:"initDate",summary:"initSummary"},vm=this,make={"do":home,srv:srv,ui:ui,data:data};ctrls.contractorWidgetsGlobal.build(make,!1,vm)}]),ctrls.controller("ContractorWidgetsApplicationsUsedCtrl",[function(){var applicationsUsed={getApplicationsUsed:function(d){var gl=this;return this.srv.asg.getMemberProductivity({id:gl.data.asg.id,type:"weekly",date:moment(d).format("YYYY-MM-DD")}).$promise.then(function(res){gl.data.applicationsUsed=res,gl.groupActivities(res)})["finally"](function(){gl.ui.loading.applicationsUsed=!1})},groupActivities:function(activitiesResponse){if(activitiesResponse.totalTime){var gl=this,unGroupedActivities=activitiesResponse.byCategory[0].applications,activities={};unGroupedActivities.forEach(function(activity){if(activity&&activity.xoApplication){var activityId=activity.xoApplication.id;return activities[activityId]?void(activities[activityId].xoApplication.id===activityId&&(activities[activityId].totalTime+=activity.totalTime)):void(activities[activityId]=activity)}}),activities=_.values(activities),activities=_.sortBy(activities,"totalTime").reverse().slice(0,6),gl.initApplicationsUsedChart(activities)}},initApplicationsUsedChart:function(activities){var d,gl=this,colors=["#66bb6a","#90a4ae","#ff9800","#9575cd","#f06292","#1855cb"];gl.data.applicationsUsed.formatted=d=activities.map(function(x,i){return{name:x.applicationName,y:x.totalTime,formatted:gl.srv.utils.convertToHoursAndMinutes(x.totalTime),color:colors[i]}}),this.data.charts.applicationsUsed={options:{legend:{align:"center",verticalAlign:"middle",layout:"vertical",useHTML:!0,labelFormatter:function(){return'<span class="legend-wrapper"><span class="text-ellipsis font9 legend-title">'+this.name+'</span> <span class="mute font9">('+this.formatted+")</span></span>"}},plotOptions:{pie:{showInLegend:!1,innerSize:"67%",dataLabels:{enabled:!1}}}},size:{height:200},title:{text:""},series:[{type:"pie",data:d,tooltip:{headerFormat:"",pointFormat:"{point.name} <b>{point.formatted}</b>"}}]}}},vm=this,make={"do":applicationsUsed};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsEarningsCtrl",[function(){var earnings={getEarnings:function(date){var gl=this,_date=moment(date).startOf("week"),to=moment().startOf("week").format("YYYY-MM-DD"),from=gl.earningsDateRangeFrom(_date,gl.data.asg.startDate);return gl.data.earnings||(gl.data.earnings={weeks:{},current:null,total:null}),gl.data.earnings.weeks&&gl.data.earnings.weeks[from]&&gl.data.earnings.weeks[to]?(gl.initEarnings(gl.data.earnings.weeks,_date,from,to),void(gl.ui.loading.earnings=!1)):void gl.srv.earnings.list({from:from,to:to}).$promise.then(function(res){gl.initEarnings(res,_date,from,to)})["finally"](function(){gl.ui.loading.earnings=!1})},earningsDateRangeFrom:function(date,startDate){var _date=moment(date),_startDate=moment(startDate),startOfYear=moment(date).startOf("year").format("YYYY-MM-DD"),isBeforeStartDate=_startDate.diff(_date,"days")>0,isSameYear=0===_startDate.endOf("year").diff(_date.endOf("year"),"years");return isSameYear&&isBeforeStartDate?_startDate.format("YYYY-MM-DD"):startOfYear},getThisYearsEarnings:function(earnings,date){return _.filter(earnings,function(x){if(x.start_date){var toDateYear=moment(date).format("YYYY"),year=moment(x.start_date).format("YYYY");if(toDateYear===year)return x}})},initEarnings:function(earnings,date,fromDate,toDate){var gl=this;gl.data.earnings.weeks||(gl.data.earnings.weeks={}),gl.data.earnings.weeks[fromDate]||(gl.data.earnings.weeks[fromDate]={}),gl.data.earnings.weeks[toDate]||(gl.data.earnings.weeks[toDate]={}),earnings=gl.getThisYearsEarnings(earnings,date);var f="YYYY-MM-DD",w="week",_earnings=_.sortBy(earnings,"start_date"),_date=moment(date),dateStartOfWeek=_date.startOf(w).format(f),total=0,current={earnedThisWeek:null,lastWeek:null,lastTwoWeeks:null,nextPayment:null,pendingPayment:null},pending={total:0,weeks:[]},processed=[];_earnings.forEach(function(earning){gl.data.earnings.weeks[earning.start_date]=earning;var isAfter=date.isAfter(moment(earning.start_date)),isSame=date.isSame(moment(earning.start_date));(isAfter||isSame)&&(total+=earning.amount),"PENDING"===earning.status&&(isAfter||isSame)&&(pending.total+=earning.amount,pending.weeks.push(earning)),"PROCESSED"===earning.status&&(isAfter||isSame)&&processed.push(earning)}),current.earnedThisWeek=gl.data.earnings.weeks[dateStartOfWeek],current.pendingPayment=pending,current.lastProcsessed=_.last(processed),gl.data.earnings.total=total,gl.data.earnings.current=current}},vm=this,make={"do":earnings};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsHeaderCtrl",[function(){var header={handleDatepickerChange:function(){var gl=this,dateSelected=moment(gl.data.date.dateSelected),minDate=moment(gl.data.date.dateOptions.minDate).startOf("week");gl.data.date.currentWeekformatted=gl.srv.utils.getWeekText(gl.data.date.dateSelected),gl.data.date.currentWeekformatted===gl.data.date.thisWeek?gl.ui.isThisWeek=!0:gl.ui.isThisWeek=!1,0===minDate.diff(dateSelected,"weeks")?gl.ui.isStartWeek=!0:gl.ui.isStartWeek=!1,gl.loadWidgets(gl.data.date.dateSelected)},handleChangeDate:function(inc){var newDate,gl=this,oldDate=moment(gl.data.date.dateSelected).startOf("isoweek").toDate();newDate=inc>0?moment(oldDate).add(7,"days"):moment(oldDate).subtract(7,"days"),moment(newDate).format("x")<moment().format("x")?gl.data.date.dateSelected=newDate.toDate():gl.data.date.dateSelected=gl.data.date.today,gl.handleDatepickerChange(newDate.toDate())}},vm=this,make={"do":header};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsLastTimecardCtrl",[function(){var logbook={getLastTimeCard:function(date){var lastDate,gl=this,f="YYYY-MM-DD",tcF="MMMM D, LT",offset=gl.data.candidate.location.timeZone.hourlyOffset,params={id:gl.data.asg.id,date:moment(date).startOf("day").format(f),timeZoneId:gl.data.candidate.location.timeZone.id};gl.srv.asg.workDiary(params).$promise.then(function(res){gl.ui.loading.lastTimeCard=!1,gl.data.logbook.lastTimeCard=lastDate=_.last(res),gl.data.logbook.lastTimeCard.formattedDate=moment(lastDate.date).utcOffset(offset).format(tcF),gl.data.logbook.lastTimeCard.activityMeter=gl.getActivityBars(lastDate),gl.data.logbook.lastTimeCard.formattedEvents=gl.mapEvents(lastDate.events)})},getActivityBars:function(tc){if(tc){tc.activityLevel>100&&(tc.activityLevel=100);for(var activeBars=Math.floor(tc.activityLevel/10),bars=[],i=0;i<10;i++)activeBars>i?bars.push(!0):bars.push(!1);return bars}},mapEvents:function(events){if(events)return events.map(function(e){return{date:moment(e.date).format("LT"),processName:e.processName}})}},vm=this,make={"do":logbook};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsMetricsCtrl",[function(){var metrics={getMetrics:function(d){var gl=this,f="YYYY-MM-DD",fromDate=moment(d).subtract(4,"weeks").startOf("week").format(f),toDate=moment(d).subtract(1,"weeks").endOf("week").format(f);gl.srv.team.getMetricValues({id:gl.data.asg.team.id,type:gl.data.asg.activeMetricType,managerId:gl.data.asg.manager.id,from:fromDate,to:toDate}).$promise.then(function(res){gl.data.metrics=res,gl.initMetrics(res)})["finally"](function(){gl.ui.loading.metrics=!1})},initMetrics:function(metrics){function getOwnMetrics(metrics){return _.findWhere(metrics,{assignmentId:gl.data.asg.id})}function getResolvedTickets(metrics){if(metrics&&metrics.stats)return metrics.stats.map(function(x){return x.ticketsResolved}).reverse()}if(metrics){var gl=this,ownMetrics=getOwnMetrics(metrics),resolvedTickets=getResolvedTickets(ownMetrics),now=moment();if(ownMetrics&&_.last(ownMetrics.stats)){var metricsEndDate=moment(_.last(ownMetrics.stats).startDate),diff=metricsEndDate.diff(now,"weeks");gl.data.charts.metrics=gl.getMetricsChart([{name:gl.data.asg.activeMetricName,data:resolvedTickets,startWeek:diff}])}}},getMetricsAvg:function(metrics){if(metrics){var m=metrics.map(function(x){for(var resolved=[],i=0;i<x.stats.length;i++)resolved.push(x.stats[i].ticketsResolved);var sum=resolved.reduce(function(a,b){return a+b},0);return sum/resolved.length}),sum=m.reduce(function(a,b){return a+b},0);return sum/m.length}},getMetricsChart:function(d){var gl=this,ownMetric={name:d[0]?d[0].name:"",data:d[0]?d[0].data:[],allowPointSelect:!0,fillOpacity:.1,dataLabels:{enabled:!0,backgroundColor:"#ffffff",borderRadius:10,padding:5,shadow:{color:"#000000",offsetX:0,offsetY:1,opacity:.2,width:2},align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},format:"{point.y:,.1f}",y:-6},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3",symbol:"circle"},states:{select:{enabled:!1}},color:"#02a8f3",zIndex:1},config={options:{chart:{type:"area"},legend:{enabled:!1},tooltip:{headerFormat:""},credits:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){var date=gl.srv.utils.fillWeeksRangeArr(d[0].data.length,!1,d[0].startWeek)[this.value],format="MMM DD",startDate=moment(date).startOf("week").format(format),endDate=moment(date).endOf("week").format(format);return"<div>"+startDate+"</div><br /><div>"+endDate+"</div>"},style:{"font-size":"10px",color:"#b2b4b6"},padding:0},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,lineWidth:0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},yAxis:{tickWidth:0,labels:{enabled:!1},gridLineWidth:0,gridLineColor:"#ececed",title:{text:""}},series:[]};return d[0]&&config.series.push(ownMetric),config}},vm=this,make={"do":metrics};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsSecurityCtrl",[function(){var security={isFeatureEnabled:function(assignment,feature){return assignment.disabledFeatures&&assignment.disabledFeatures.length>0&&assignment.disabledFeatures.indexOf(feature)>-1?"inactive-setting":"active-setting"}},vm=this,make={"do":security};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsSummaryCtrl",[function(){var summary={getStartDate:function(date){return moment(date).format("MMM DD, YYYY")},getDaysSinceStart:function(date){var a=moment(date),b=moment(),difference=b.diff(a,"days");return difference},getCurrentDate:function(offset){var timeFormat="MMM DD, YYYY";return offset?moment(this.srv.TimeUtils.getTimeByTimezoneOffset(offset)).format(timeFormat):moment(this.srv.TimeUtils.getUTCTime()).format(timeFormat)},getCurrentTime:function(offset){var timeFormat="LT";return offset?moment(this.srv.TimeUtils.getTimeByTimezoneOffset(offset)).format(timeFormat):moment(this.srv.TimeUtils.getUTCTime()).format(timeFormat)}},vm=this,make={"do":summary};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsActivitiesCtrl",[function(){var activites={getActivities:function(d){var gl=this,promises=[gl.srv.prod.readTeamPlannedActivities({teamId:gl.data.asg.team.id,assignmentId:gl.data.asg.id}).$promise,gl.srv.prod.readGroupedTeamActivities({assignmentId:gl.data.asg.id,date:moment(d).startOf("day").format("YYYY-MM-DD"),weekly:!0}).$promise];gl.srv.$q.all(promises).then(function(res){var teamPlannedActivitiesResponse=res[0],userActivities=res[1];gl.data.activities.plannedActivities=gl.plannedActivities(teamPlannedActivitiesResponse),userActivities[0]&&(gl.data.activities.userWeek=userActivities[0].grouping,gl.data.activities.scores=[{name:"Alignment",score:gl.data.activities.userWeek.alignmentScore,color:gl.srv.utils.progressbarColor(gl.data.activities.userWeek.alignmentScore),toolTip:"Shows how aligned is the worker to the manager's plan, by comparing the amount of hours spent on the activities compared to the plan's target."},{name:"Focus",score:gl.data.activities.userWeek.focusScore,color:gl.srv.utils.progressbarColor(gl.data.activities.userWeek.focusScore),toolTip:"Represents the amount of time spent on the same activity for long periods of time, as this is how meaningful work gets done."},{name:"Intensity",score:gl.data.activities.userWeek.intensityScore,color:gl.srv.utils.progressbarColor(gl.data.activities.userWeek.intensityScore),toolTip:"Represents the amount of keyboard strokes and mouse clicks that the worker did."}])})["finally"](function(){gl.ui.loading.activities=!1})},plannedActivities:function(activities){var groups={},acts={totalTrackedTime:0,advancedGroups:[]};activities.forEach(function(x){if(x.activity){if(!groups[x.activity.id])return void(groups[x.activity.id]=[x.activity]);groups[x.activity.id].push(x.activity)}});for(var key in groups)if(groups.hasOwnProperty(key)){var activityGroup=groups[key];activityGroup[0].spentTime=5*activityGroup.length,acts.totalTrackedTime+=activityGroup[0].spentTime,acts.advancedGroups.push(activityGroup[0])}return acts}},vm=this,make={"do":activites};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsTimeLoggedCtrl",[function(){var timeLogged={getWeeklyTimeSheets:function(d){var gl=this,date=moment(d).startOf("week").format("YYYY-MM-DD"),isCacheAccess=!1,asg=gl.data.asg,cu=gl.data.candidate;return this.srv.asg.getWeeklyTimeSheets({date:date,managerId:asg.manager.id,teamId:asg.team.id,userId:cu.id,isCacheAccess:isCacheAccess}).$promise.then(function(res){gl.data.weeklyTimeSheet=res,gl.initWeeklyBarChart(res),gl.getLogbook(gl.getWorkDays(res))})["finally"](function(){gl.ui.loading.weeklyTimeSheet=!1})},getHoursWorked:function(timelogged){if(timelogged&&timelogged[0]&&timelogged[0][0]){var minutesWorked=60*timelogged[0][0].totalHours,timeSettings={hour:"h",minute:"m",separator:" ",decimals:0};return vm.srv.utils.convertToHoursAndMinutes(minutesWorked,timeSettings)}return"0 h"},initWeeklyBarChart:function(data){if(data&&data[0]&&data[0][0]){var gl=this,longestWorkDay=gl.srv.$filter("number")(_.max(data[0][0].stats,function(x){return x.hours}).hours,0),d=data[0][0].stats.map(function(x,i){var hours=x.hours,h=hours-hours%1+"h ",m=gl.srv.$filter("number")(60*hours%60,0)+"m",hm=h+m;return{x:i,name:moment(x.date).format("ddd"),y:hours,formatted:hm,color:gl.getBarColor(x.hours,8,4)}});gl.data.charts.weeklyTimeSheet={options:{chart:{type:"column"},legend:{enabled:!1},plotOptions:{series:{minPointLength:0,pointInterval:1,pointPadding:-.1}}},title:{text:""},series:[{data:d,tooltip:{headerFormat:"",pointFormat:"<b>{point.formatted}</b>"}}],xAxis:{gridLineWidth:0,tickWidth:0,tickInterval:1,text:null,labels:{formatter:function(){return d[this.value].name},style:{"font-size":"10px",color:"#b2b4b6"}}},yAxis:{text:null,title:{text:!1},min:0,tickAmount:Number(longestWorkDay)+2,minTickInterval:1,gridLineWidth:1,tickInterval:1}}}}},vm=this,make={"do":timeLogged};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsTimeLoggedFourWeeksCtrl",[function(){var timeLoggedFourWeeks={getFourWeeksTimeSheets:function(d){var gl=this,date=moment(d).startOf("day").format("YYYY-MM-DD"),asg=gl.data.asg,cu=gl.data.candidate;return this.srv.asg.getMonthlyTimeSheets({date:date,managerId:asg.manager.id,teamId:asg.team.id,userId:cu.id}).$promise.then(function(res){gl.initFourWeeksChart(res);var lastWorkDay=gl.getLastWorkday(res);lastWorkDay?gl.getLastTimeCard(gl.getLastWorkday(res)):gl.ui.loading.lastTimeCard=!1})["catch"](function(){gl.ui.loading.lastTimeCard=!1})["finally"](function(){gl.ui.loading.fourWeeksTimeSheet=!1})},getDatePeriod:function(date){var endDate=moment(date).endOf("week").format("MMM Do"),startDate=moment(date).startOf("week").subtract(3,"weeks").format("MMM Do");return startDate+" - "+endDate},initFourWeeksChart:function(data){var gl=this,d=data.map(function(x,i){function getHoursFromWeek(week){return week?week.totalHours:0}var hours=getHoursFromWeek(x[0]),h=hours-hours%1+"h ",m=gl.srv.$filter("number")(60*hours%60,0)+"m",hm=h+m,f="MMM DD";return{x:i,startDate:moment(gl.srv.utils.getStartOfWeek(vm.data.date.dateSelected,i)).format(f),endDate:moment(gl.srv.utils.getEndOfWeek(vm.data.date.dateSelected,i)).format(f),y:hours,formatted:hm,color:gl.getBarColor(hours,40,20)}}),longestWorkWeek=gl.srv.$filter("number")(_.max(d,function(week){return week.y}).y,0),tickAmount=Math.ceil(Number(longestWorkWeek)/4+2);this.data.charts.fourWeeks={options:{chart:{type:"column"},legend:{enabled:!1},plotOptions:{series:{color:"#02a8f3",minPointLength:3,pointInterval:1}}},title:{text:""},series:[{data:d,tooltip:{headerFormat:"",pointFormat:"<b>{point.formatted}</b>"}}],xAxis:{tickWidth:0,tickInterval:1,text:null,useHTML:!0,reversed:!0,labels:{formatter:function(){return"<div>"+d[this.value].startDate+"</div><br /><div>"+d[this.value].endDate+"</div>"},style:{"font-size":"10px",color:"#b2b4b6"}},minPadding:0,maxPadding:0},yAxis:{text:null,min:0,tickAmount:tickAmount,minTickInterval:4,gridLineWidth:1,tickInterval:4,title:{text:!1}}}},getWorkDays:function(week){if(week&&week[0]&&week[0][0]&&week[0][0].stats){var stats=week[0][0].stats;return stats.map(function(x){if(x.hours)return x}).filter(Boolean)}},getLastWorkday:function(weeks){if(weeks=weeks.map(function(x){if(x[0]&&x[0].stats)return x[0].stats.map(function(x){if(x.hours>0)return x}).filter(Boolean)}).filter(Boolean),_.last(weeks[0])&&_.last(weeks[0]).date)var lastDate=_.last(weeks[0]).date,formattedDate=moment(lastDate).startOf("day").format();return formattedDate}},vm=this,make={"do":timeLoggedFourWeeks};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorWidgetsTimeTrackedCtrl",[function(){var timeTracked={getLogbook:function(dates){var gl=this;if(!dates||!_.isArray(dates)||0===dates.length)return gl.ui.loading.logbook=!1,gl.ui.loading.timeCards=!1,void(gl.ui.loading.timeTracked=!1);var f="YYYY-MM-DD",promises=[],params={id:gl.data.asg.id,timeZoneId:gl.data.asg.selection.marketplaceMember.application.candidate.location.timeZone.id};promises=dates.map(function(x){var date=moment(x.date).startOf("day").format(f),o=_.extend({},params,{date:date});return gl.srv.asg.workDiary(o).$promise}),gl.srv.$q.all(promises).then(function(res){gl.initTimeTracked(res)})["finally"](function(){gl.ui.loading.logbook=!1})},initTimeTracked:function(days){if(days){var gl=this,d={},timeTracked={autoTracked:0,idle:0,disputed:0,manual:0,overtime:0,total:0,low:0};days.forEach(function(timecards){timecards.forEach(function(tc){var aLvl=tc.activityLevel,low=aLvl<=10&&0!==aLvl&&tc.autoTracker,idle=aLvl<10&&tc.autoTracker,date=moment(tc.date).format("YYYY-MM-DD");d[date]||(d[date]={autoTracked:0,idle:0,disputed:0,manual:0,overtime:0,total:0,low:0,tc:[]}),tc.autoTracker&&(timeTracked.autoTracked+=10,d[date].autoTracked+=10),tc.autoTracker||(timeTracked.manual+=10,d[date].manual+=10),tc.rejected&&(timeTracked.disputed+=10,d[date].disputed+=10),tc.overtime&&(timeTracked.overtime+=10,d[date].overtime+=10),low&&(timeTracked.low+=10,d[date].low+=10),idle&&(timeTracked.idle+=10,d[date].idle+=10),timeTracked.total+=10,d[date].total+=10,d[date].tc.push(tc)})}),timeTracked.total=timeTracked.total-timeTracked.idle-timeTracked.disputed,gl.ui.loading.timeTracked=!1,gl.data.timeTracked=timeTracked}}},vm=this,make={"do":timeTracked};ctrls.contractorWidgetsGlobal.build(make,!0,vm)}]),ctrls.controller("ContractorSearchProfileCtrl",["$scope","AssignmentService","TimeUtils","$window","$routeParams","AdminUsersService","$location",function($scope,AssignmentService,TimeUtils,$window,$routeParams,AdminUsersService,$location){function truncate(string){if(!string)return"Title not specified";var strings=string.split(",");strings.length>0&&(string=strings[0]);var length=string.length;return length>40?string.substring(0,40)+"...":string}function goToUserProfile(id){profile.ui.isLoading=!0,AdminUsersService.searchUser({id:id}).$promise.then(function(res){var assignments=res.numberOfElements>0?res.content[0].userAssigments:null;assignments&&assignments.length>0?goToAssignmentProfile(assignments[0].id):showError({text:"Could not find selection ID"})})["catch"](showError)["finally"](function(){profile.ui.isLoading=!1})}function goToAssignmentProfile(id){$location.path("/profile/contractor-profile/"+id)}function capitalizeFirstLetter(string){if(string){var strings=string.toLowerCase().split(" ");return strings.length>0?(strings=strings.map(function(string){return string.charAt(0).toUpperCase()+string.slice(1)}),strings.join(" ")):string.charAt(0).toUpperCase()+string.slice(1)}}function getLocation(){if(profile.data.contractor&&profile.data.contractor.location&&profile.data.contractor.location.country&&profile.data.contractor.location.country.name){var country=capitalizeFirstLetter(profile.data.contractor.location.country.name),city=capitalizeFirstLetter(profile.data.contractor.location.city);return city?country+", "+city:country}return""}function getTime(){if(profile.data.contractor&&profile.data.contractor.location&&profile.data.contractor.location.timeZone&&profile.data.contractor.location.timeZone.hourlyOffset){var offset=profile.data.contractor.location.timeZone.hourlyOffset;return moment().utcOffset(offset).format("MMM DD, LT")}return""}function showError(err){err&&err.data&&(profile.data.error=err.data)}var profile=this;profile.data={errorTimeout:0,error:{errorCode:null,httpStatus:null,text:null,type:null},contractor:{picture:null,name:null,title:null,status:null,startDate:null,manager:{},team:{},location:{},email:null,skypeId:null,phoneNumber:null,summary:null,languages:[],skills:[]},manages:[]},profile.ui={isLoading:!0,showContractor:!1},profile.fn={getLocation:getLocation,getTime:getTime,goToUserProfile:goToUserProfile,goToAssignmentProfile:goToAssignmentProfile,truncate:truncate},function(id){profile.ui.isLoading=!0,AssignmentService.get({id:id,avatarType:"CANDIDATE"}).$promise.then(function(res){var contractorData=res.selection.marketplaceMember.application.candidate,contractor=profile.data.contractor;if(contractor.picture=contractorData.photoUrl,contractor.name=contractorData.printableName,contractor.title=res.jobTitle,contractor.status=res.status,contractor.startDate=res.startDate,contractor.manager=res.manager,contractor.team=res.team,contractor.location=contractorData.location,contractor.email=contractorData.email,contractor.skypeId=contractorData.skypeId,contractor.summary=contractorData.summary,contractor.avatarTypes=contractorData.avatarTypes,_.isArray(contractorData.skills)&&(contractor.skills=contractorData.skills.map(function(s){if(angular.isDefined(s.skill)){var skill=s.skill;return skill.name}})),_.isArray(contractorData.languages)&&(contractor.languages=contractorData.languages.map(function(l){if(angular.isDefined(l.language)){var language=l.language.name,proficiencies=["Basic","Conversational","Fluent","Native"],proficiency=proficiencies[l.proficiency];return{proficiency:proficiency,name:language}}})),contractor.avatarTypes.indexOf("MANAGER")>-1){var index=_.pluck(contractorData.userAvatars,"type").indexOf("MANAGER"),id=contractorData.userAvatars[index].id,criteria={managerId:id,status:"ACTIVE"},team=contractor.team;team.company.internal&&(criteria.fullTeam=!0),AssignmentService.teamAssignments(criteria).$promise.then(function(res){profile.data.manages=res.content.map(function(assignment){var candidate=assignment.selection.marketplaceMember.application.candidate;return candidate.assignmentId=assignment.id,candidate.jobTitle=assignment.jobTitle,candidate})})}}).then(function(){profile.ui.showContractor=!0})["catch"](showError)["finally"](function(){profile.ui.isLoading=!1})}($routeParams.id)}]),ctrls.controller("ContractorProfileCtrl",["$scope","JobApplicationService","$window",function($scope,JobApplicationService,$window){$scope.openFile=function(app,file){angular.isUndefined(app)||angular.isUndefined(file)||JobApplicationService.getFileUrl(app.id,file.id).then(function(res){$window.open(res.data,"_blank")})}}]),ctrls.controller("LegalDocumentsCtrl",["$scope","$routeParams","uploadedDocsUrl",function($scope,$routeParams,uploadedDocsUrl){
$scope.ui={isLoading:!0},$scope.documents={privacy:"privacy_policy.md","code-of-conduct":"independent_contractor_code_of_conduct.md","acceptable-use":"acceptable_use_policy.md","electronic-communications":"electronic_communications_agreement.md","internal-policy":"internal_policy.md"},$scope.setMessage=function(text,type){$scope.ui.isLoading=!1,$scope.message=text,$scope.messageClass="alert "+type,$scope.showMessage=!0};var documentName=$scope.documents[$routeParams.name];documentName?$scope.document=uploadedDocsUrl+"/documents/"+documentName:$scope.setMessage("Document wasn't found.","alert-danger")}]),ctrls.controller("GradingCtrl",["$scope","JobService","JobApplicationService","DownloadService","$uibModal","$sce","$location","RequestQueue","$rootScope","$window","UtilsService",function($scope,JobService,JobApplicationService,DownloadService,$uibModal,$sce,$location,RequestQueue,$rootScope,$window,UtilsService){function getPipelineById(id){return _.find($scope.data.jobs,function(job){return job.id===id})}function unsavedModal(){return $uibModal.open({templateUrl:"unsaved-changes.tpl.html",scope:$scope})}var vm=this;vm.init=function(){$scope.ui={page:0,busy:!1,totalPages:null,selectedApp:null,selectedQuestion:null,mdl:null,isUpdating:null,showLessScoringCandidates:!1},$scope.data={scoresArray:[],jobs:null,selectedJob:null,selectedTest:null,applications:null,fiveqResponses:null,queue:RequestQueue.queue},$scope.appService=JobApplicationService,vm.loading=JobService.crud.list({applicationType:"NATIVE"},function(res){res.forEach(function(j){j.fiveqTest=_.find(j.tests,function(t){return"FIVEQ"===t.test.type})}),$scope.data.jobs=res,$location.search().jobId?($scope.data.selectedJob=_.find($scope.data.jobs,function(j){return j.id===parseInt($location.search().jobId,10)}),JobService.crud.getAuthenticated({id:$scope.data.selectedJob.id},function(j){$scope.data.selectedJob.fiveqTest=_.find(j.tests,function(t){return"FIVEQ"===t.test.type}),$location.search().test&&($scope.data.selectedTest=$location.search().test,$scope.ui.page=0,vm.loadApplications())})):$rootScope.selectedGlobalPipelineId&&($scope.data.selectedJob=getPipelineById($rootScope.selectedGlobalPipelineId),vm.changeJob())}),$scope.$on("$locationChangeStart",routeChange)};var routeChange=function(event,newUrl){0!==$scope.data.scoresArray.length&&($scope.ui.mdl=unsavedModal(),$scope.ui.mdl.result.then(function(){vm.updateScores().then(function(){$location.path($location.url(newUrl).hash())})}),event.preventDefault())};vm.init(),vm.loadApplications=function(){$scope.ui.error=null,$location.search("test",$scope.data.selectedTest),$scope.ui.busy=!0,"LANGUAGE"===$scope.data.selectedTest?vm.loading=JobApplicationService.getLanguageReviews(function(res){$scope.data.applications=res.filter(function(app){var rkt=_.find(app.testScores,function(ts){return"RESUME_KEYWORD"===ts.test.type});return rkt&&(app.keywordScore=rkt.score,app.rkLowThreshold=rkt.test.lowThreshold),app.job.id===$scope.data.selectedJob.id}),$scope.ui.busy=!1,$rootScope.showFooter=!1}):vm.loading=JobApplicationService.list({avatarType:"RECRUITMENT_ANALYST",page:$scope.ui.page,orderBy:"score.RESUME_KEYWORD",sortDir:"DESC"},{tasks:["recruitmentAnalystGrades5QTest"],jobId:$scope.data.selectedJob.id,searchWord:$scope.data.searchWord},function(res){$scope.ui.totalPages=res.totalPages;var fiveqResponses=_.map(res.content,function(app){var fqe=_.find(app.testsEvaluations,function(te){return"FIVEQ_ANSWER"===te.type}),mat=_.find(app.testScores,function(ts){return"MANDATORY_ATTRIBUTES"===ts.test.type});mat&&(fqe.mandatoryScore=mat.score);var rkt=_.find(app.testScores,function(ts){return"RESUME_KEYWORD"===ts.test.type});return rkt&&(fqe.keywordScore=rkt.score),fqe.application=app,fqe=vm.updateTotal(fqe),fqe.validateScores=vm.validateScores(fqe),fqe});$scope.data.fiveqResponses=0===$scope.ui.page?[]:$scope.data.fiveqResponses,$scope.data.fiveqResponses.push.apply($scope.data.fiveqResponses,fiveqResponses||[]),$scope.ui.busy=!1,$rootScope.showFooter=!1})},vm.showMoreRecords=function(){$scope.ui.busy||$scope.ui.page+1!==$scope.ui.totalPages&&($scope.ui.busy=!0,$scope.ui.page=$scope.ui.page+1,vm.loadApplications())},vm.loadAudioUrl=function(app){var audioFile=_.find(app.files,function(f){return"Spoken English"===f.label});vm.loading=!0,JobApplicationService.getFileUrl(app.id,audioFile.id).success(function(url){DownloadService.downloadFile(url)})["finally"](function(){vm.loading=!1})},vm.submitLanguageScore=function(app){vm.loading=JobApplicationService.raReviewsSpokenTest({id:app.id,score:app.audioScore},"",function(){$scope.ui.page=0,vm.loadApplications()})},vm.openModal=function(app,question){$scope.ui.selectedApp=app,$scope.ui.selectedQuestion=question,$scope.ui.mdl=$uibModal.open({templateUrl:"fiveq-grading.tpl.html",scope:$scope,size:"lg"})},vm.addToScoreArray=function(fqr,answer){var score=parseInt(answer.score);if(isNaN(score)||score<0||score>5)return void(answer.score=null);var scoresArray=$scope.data.scoresArray,sindex=scoresArray.findIndex(function(item){return item.id===fqr.application.id});sindex===-1?scoresArray.push({id:fqr.application.id,testsEvaluations:[{id:fqr.id,type:fqr.type,answers:fqr.answers}]}):scoresArray[sindex].testsEvaluations[0].answers=fqr.answers,$scope.data.scoresArray=scoresArray,fqr=vm.updateTotal(fqr)},vm.updateScores=function(){return $scope.ui.error=null,RequestQueue.addTask(JobApplicationService.updateFiveqScoreBatch,$scope.data.scoresArray).then(function(){$scope.data.scoresArray=[],$scope.data.fiveqResponses.forEach(function(fqe){fqe.validateScores=vm.validateScores(fqe)})})["catch"](function(err){$scope.ui.error=err.data.text})},vm.validateScores=function(fqr){var graded=_.filter(fqr.answers,function(a){var score=parseInt(a.score);return!isNaN(score)&&score>=0&&score<=5||null===a.answer});return graded.length===fqr.answers.length},vm.submitFiveqReview=function(fqr){vm.loading=JobApplicationService.raReviewsWrittenEvaluation({id:fqr.application.id},function(){$scope.data.fiveqResponses=_.filter($scope.data.fiveqResponses,function(resp){return resp.application.id!==fqr.application.id})},function(err){$scope.ui.error=err.data.text})},vm.trustAsHtml=function(string){return $sce.trustAsHtml(string)},vm.changeJob=function(){function load(id){$scope.ui.error=null,$scope.ui.page=0,$scope.data.fiveqResponses=[],$scope.data.selectedTest="",$scope.data.selectedJob=_.find($scope.data.jobs,function(j){return j.id===id}),JobService.crud.getAuthenticated({id:$scope.data.selectedJob.id},function(j){$scope.data.selectedJob.fiveqTest=_.find(j.tests,function(t){return"FIVEQ"===t.test.type}),$location.search("jobId",$scope.data.selectedJob.id),$location.search("test",$scope.data.selectedTest)})}if($rootScope.selectedGlobalPipelineId=$scope.data.selectedJob.id,_.isEmpty($scope.data.scoresArray))load($scope.data.selectedJob.id);else{var newJobId=$scope.data.selectedJob.id,url=$window.location.href,jobId=parseInt(UtilsService.getUrlParam(url,"jobId"),10);$scope.data.selectedJob=_.find($scope.data.jobs,function(j){return j.id===jobId}),$scope.ui.mdl=unsavedModal(),$scope.ui.mdl.result.then(function(){vm.updateScores().then(function(){load(newJobId)})})}},vm.changeSearchWord=function(){$scope.ui.error=null,$scope.ui.page=0,$scope.data.fiveqResponses=[],vm.loadApplications()},vm.updateTotal=function(fqr){var total=0;return fqr.gradedCount=0,(fqr.answers||[]).forEach(function(a){var score=parseInt(a.score);isNaN(score)||(total+=score,fqr.gradedCount++)}),fqr.total=total/fqr.answers.length,fqr},vm.expand=function(){$scope.ui.showLessScoringCandidates=!$scope.ui.showLessScoringCandidates},$scope.blur=function($event){_.each($event.target.childNodes,function(child){$(child).blur()})},$scope.$watch("data.queue",function(updated){$scope.ui.isUpdating=updated.length>0},!0)}]),ctrls.controller("FiveqRubricCtrl",["JobService","$routeParams","$sce",function(JobService,$routeParams,$sce){var vm=this;vm.sce=$sce,JobService.crud.getAuthenticated({id:$routeParams.jobId},function(j){var jobTest=_.find(j.tests,function(t){return"FIVEQ"===t.test.type});jobTest&&(vm.test=jobTest.test)}),vm.expand=function(i){$($(".question")[i]).slideToggle(),$($(".fa")[i]).toggleClass("down")}}]),bandcampApp.menu={company:[{title:"Manage",href:"manager/team-dashboard",id:"manage-my-team",pattern:/^manager\/team-dashboard$/,subList:[{title:"Teams",href:"manager/team-dashboard",id:"team-dashboard",pattern:/^manager\/team-dashboard$/},{title:"Productivity",href:"manager/dashboard/team?module=Summary",id:"productivity",pattern:/^manager\/dashboard\/team(\?)*(module=[a-z]*)/},{title:"Organization",href:"manager/teams",id:"teams",pattern:/^manager\/teams$/},{title:"Goals",href:"manager/goals",id:"goals",pattern:/^manager\/goals$/},{title:"Hiring Managers",href:"company/setup-team",pattern:/^company\/(setup-team)$/,id:"hiring"},{title:"Invoice Report",href:"company/invoices",pattern:/^company\/(invoices)$/,id:"invoices"},{title:"Pipelines",href:"jobs-health",pattern:/^jobs-health$/,id:"health"},{title:"Reports",href:"reports",id:"reports",pattern:/^reports.*$/},{title:"Gemba Walk",href:"manager/gemba-walk",id:"gemba-walk",pattern:/^manager\/gemba-walk$/},{title:"Search Contractors",href:"contractor/search",id:"contractor-search",pattern:/^contractor\/search$/}]},{title:"Hire",href:"dashboard",id:"recruit",pattern:/^dashboard$/,subList:[{title:"Marketplace",href:"dashboard",id:"recruit",pattern:/^dashboard$/},{title:"Candidates",href:"manager/candidates",id:"candidates",pattern:/^manager\/candidates$/}]}],manager:[{title:"Manage",href:"manager/team-dashboard",id:"manage-my-team",pattern:/^manager\/team-dashboard$/,subList:[{title:"Teams",href:"manager/team-dashboard",id:"team-dashboard",pattern:/^manager\/team-dashboard$/},{title:"Productivity",href:"manager/dashboard/team?module=Summary",id:"productivity",pattern:/^manager\/dashboard\/team(\?)*(module=[a-z]*)/},{title:"Organization",href:"manager/teams",id:"teams",pattern:/^manager\/teams$/},{title:"Goals",href:"manager/goals",id:"goals",pattern:/^manager\/goals$/},{title:"Reports",href:"reports",id:"reports",pattern:/^reports.*$/},{title:"Gemba Walk",href:"manager/gemba-walk",id:"gemba-walk",pattern:/^manager\/gemba-walk$/},{title:"Search Contractors",href:"contractor/search",id:"contractor-search",pattern:/^contractor\/search$/}]},{title:"Hire",href:"dashboard",id:"recruit",pattern:/^dashboard$/,subList:[{title:"Marketplace",href:"dashboard",id:"recruit",pattern:/^dashboard$/},{title:"Candidates",href:"manager/candidates",id:"candidates",pattern:/^manager\/candidates$/}]}],teamManager:[{title:"My Teams",href:"manager/dashboard/team",pattern:/^manager\/dashboard\/team$/,id:"manage-my-team"}],contractor:[{title:"Productivity",href:"contractor/home",id:"candidate-dashboard",pattern:/^contractor\/home/},{title:"My Team",href:"contractor/my-team",id:"my-team",pattern:/^contractor\/my-team$/},{title:"Profile",href:"profile/user-profile",id:"profile",pattern:/^profile.*$/},{title:"Other",id:"other",href:"marketplace/available-jobs",pattern:/job.*/,subList:[{title:"My Jobs",href:"marketplace/my-jobs",pattern:/^marketplace\/my\-jobs$/},{title:"Earnings",href:"contractor/earnings",pattern:/^contractor\/earnings$/},{title:"Assignments",href:"contractor/assignments",pattern:/^contractor\/assignments$/},{title:"Applications",href:"candidate/dashboard/applications",pattern:/^candidate\/dashboard\/applications$/},{title:"Available Jobs",href:"marketplace/available-jobs",pattern:/^(marketplace\/available\-jobs|job\/[0-9]{1,9}\/details)/},{title:"Hiring",href:"candidate/dashboard/hiring",pattern:/^candidate\/dashboard\/hiring$/},{title:"Dashboard (Beta)",href:"contractor/new-dashboard",pattern:/^contractor\/new-dashboard$/}]}],contractorOpt:[{title:"You",href:"contractor/home",pattern:/^contractor\/home/,id:"manage-my",subList:[{title:"Productivity",href:"contractor/home",id:"candidate-dashboard",pattern:/^contractor\/home/},{title:"My Team",href:"contractor/my-team",id:"my-team",pattern:/^contractor\/my-team$/},{title:"Profile",href:"profile/user-profile",id:"profile",pattern:/^profile\/user-profile$/},{title:"Earnings",href:"contractor/earnings",pattern:/^contractor\/earnings$/},{title:"Assignments",href:"contractor/assignments",pattern:/^contractor\/assignments$/},{title:"Available Jobs",href:"marketplace/available-jobs",pattern:/^(marketplace\/available\-jobs|job\/[0-9]{1,9}\/details)/},{title:"Dashboard (Beta)",href:"contractor/new-dashboard",pattern:/^contractor\/new-dashboard$/}]}],accountManagerOpt:[{title:"Account manager",href:"jobs",pattern:/^jobs|^job\/[0-9]{1,9}\/edit$/,id:"account-manager",subList:[{title:"Jobs",href:"jobs",id:"manage-jobs",pattern:/^jobs|^job\/[0-9]{1,9}\/edit$/,subList:[{title:"Jobs",href:"jobs",id:"manage-jobs",pattern:/^jobs|^job\/[0-9]{1,9}\/edit$/},{title:"Jobs Demand",href:"account-manager/demand",id:"job-demand",pattern:/^account-manager\/demand$/}]},{title:"Tracker",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/,subList:[{title:"Applicant",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/},{title:"Pipeline",href:"pipelines/tracking",id:"pipelines-tracker",pattern:/^pipelines\/tracking.*$/},{title:"Sourcing",href:"pipelines/sourcing",id:"pipelines-sourcing",pattern:/^pipelines\/sourcing.*$/},{title:"Endorsement",href:"account-manager/applicants-endorsement",id:"applicants-endorsement",pattern:/^account-manager\/applicants-endorsement.*$/}]},{title:"Marketplace",href:"account-manager/custom-pipelines",id:"custom-pipelines",pattern:/^account-manager\/custom-pipelines$/},{title:"Hiring Managers",href:"account-manager/users",id:"users",pattern:/^account-manager\/users$/},{title:"Finance",href:"account-manager/invoices",pattern:/^account-manager\/(invoices)$/,id:"invoices"},{title:"Calibrations",href:"calibrations",pattern:/^calibrations.*$/,id:"calibrations"},{title:"Reports",href:"reports",id:"reports",pattern:/^reports.*$/}]}],applicant:[{title:"Application",href:"candidate/dashboard/applications",id:"job-applications",pattern:/^candidate\/dashboard\/applications$/},{title:"Profile",href:"profile/user-profile",id:"profile",pattern:/^profile.*$/},{title:"Other",href:"marketplace/available-jobs",id:"available-jobs",pattern:/^(marketplace\/available\-jobs|job\/[0-9]{1,9}\/details)/,subList:[{title:"Available Jobs",id:"available-jobs",href:"marketplace/available-jobs",pattern:/^(marketplace\/available\-jobs|job\/[0-9]{1,9}\/details)/},{title:"My Jobs",href:"marketplace/my-jobs",pattern:/^marketplace\/my\-jobs$/},{title:"Assignments",href:"contractor/assignments",pattern:/^contractor\/assignments$/},{title:"Hiring",href:"candidate/dashboard/hiring",pattern:/^candidate\/dashboard\/hiring$/}]}],admin:[{title:"Companies",href:"companies",id:"manage-companies",pattern:/^companies$/},{title:"Jobs",href:"jobs",id:"manage-jobs"},{title:"Trainings",href:"trainings",id:"manage-trainings",pattern:/^trainings/},{title:"Tracker",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/,subList:[{title:"Applicant",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/},{title:"Pipeline",href:"pipelines/tracking",id:"pipelines-tracker",pattern:/^pipelines\/tracking.*$/},{title:"Sourcing",href:"pipelines/sourcing",id:"pipelines-sourcing",pattern:/(^pipelines|^campaign)\/sourcing.*$/}]},{title:"Assignments",href:"admin/assignments",id:"assignments",pattern:/^admin\/assignments.*$/},{title:"Users",href:"admin/users",id:"users",pattern:/^admin\/users.*$/},{title:"Onboard",href:"admin/onboard",id:"onboard",pattern:/^admin\/onboard.*$/},{title:"Features",href:"admin/features",id:"features",pattern:/^admin\/features.*$/},{title:"Integrations",href:"admin/integrations",id:"integrations",pattern:/^admin\/integrations.*$/},{title:"Reports",href:"reports",id:"reports",pattern:/^reports.*$/},{title:"Audits",href:"audits",id:"audits",pattern:/^audits.*$/}],recruiter:[{title:"Jobs",href:"jobs",id:"manage-jobs",pattern:/^jobs.*$/},{title:"Marketplace Approval",href:"recruiter/pending-approvals",id:"recruiter-approval",pattern:/^recruiter\/pending-approvals.*$/},{title:"Tracker",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/,subList:[{title:"Applicant",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/},{title:"Pipeline",href:"pipelines/tracking",id:"pipelines-tracker",pattern:/^pipelines\/tracking.*$/},{title:"Sourcing",href:"pipelines/sourcing",id:"pipelines-sourcing",pattern:/(^pipelines|^campaign)\/sourcing.*$/}]},{title:"Onboard",href:"admin/onboard",id:"onboard",pattern:/^admin\/onboard.*$/},{title:"Reports",href:"reports",id:"reports",pattern:/^reports.*$/}],accountManager:[{title:"Jobs",href:"jobs",id:"manage-jobs",pattern:/^jobs|^job\/[0-9]{1,9}\/edit$/,subList:[{title:"Jobs",href:"jobs",id:"manage-jobs",pattern:/^jobs|^job\/[0-9]{1,9}\/edit$/},{title:"Jobs Demand",href:"account-manager/demand",id:"job-demand",pattern:/^account-manager\/demand$/}]},{title:"Tracker",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/,subList:[{title:"Applicant",href:"applicants/tracking",id:"applicants-tracker",pattern:/^applicants\/tracking.*$/},{title:"Pipeline",href:"pipelines/tracking",id:"pipelines-tracker",pattern:/^pipelines\/tracking.*$/},{title:"Sourcing",href:"pipelines/sourcing",id:"pipelines-sourcing",pattern:/(^pipelines|^campaign)\/sourcing.*$/},{title:"Endorsement",href:"account-manager/applicants-endorsement",id:"applicants-endorsement",pattern:/^account-manager\/applicants-endorsement.*$/}]},{title:"Manage",href:"account-manager/custom-pipelines",id:"manage-accountManager",pattern:/^account-manager\/custom-pipelines$/,subList:[{title:"Marketplace",href:"account-manager/custom-pipelines",id:"custom-pipelines",pattern:/^account-manager\/custom-pipelines$/},{title:"Hiring Managers",href:"account-manager/users",id:"users",pattern:/^account-manager\/users$/},{title:"Finance",href:"account-manager/invoices",pattern:/^account-manager\/(invoices)$/,id:"invoices"},{title:"Calibrations",href:"calibrations",pattern:/^calibrations.*$/,id:"calibrations"},{title:"Command Center",href:"command-center",pattern:/^command-center.*$/,id:"command-center"}]},{title:"Reports",href:"reports",id:"reports",pattern:/^reports.*$/}],recruitmentAnalyst:[{title:"Grading",href:"grading",pattern:/^grading.*$/},{title:"Endorsement",href:"account-manager/applicants-endorsement",id:"Ra-Endorsement",pattern:/^account-manager\/applicants-endorsement.*$/}],enforcer:[{title:"Enforcer",href:"enforcer",id:"enforcer-home",pattern:/^enforcer(\?)/,subList:[{title:"Logbook",href:"enforcer",id:"enforcer-logbook",pattern:/^enforcer$/},{title:"Report",id:"enforcer-report",href:"enforcer/report",pattern:/^enforcer\/report$/}]}],jobBoardPoster:[{title:"Sourcing",href:"pipelines/sourcing",id:"pipelines-sourcing",pattern:/(^pipelines|^campaign)\/sourcing.*$/}],outboundRecruiter:[{title:"Sourcing",href:"pipelines/sourcing",id:"pipelines-sourcing",pattern:/(^pipelines|^campaign)\/sourcing.*$/}],fallback:[]},ctrls.controller("HeaderCtrl",["$scope","$location","baseUrl","CurrentUser","Flash","$rootScope","$window","$uibModal","routePrefix","CrossoverTasksService","NotificationService","$timeout","$cookieStore","JobApplicationService","CountriesService","$http","$q","ENV","AssignmentService","$document",function($scope,$location,baseUrl,CurrentUser,Flash,$rootScope,$window,$uibModal,routePrefix,CrossoverTasksService,NotificationService,$timeout,$cookieStore,JobApplicationService,CountriesService,$http,$q,ENV,AssignmentService,$document){function removeMenuItem(){AssignmentService.get({avatarType:"CANDIDATE",status:"ACTIVE"}).$promise.then(function(assignment){if(!(assignment.content[0].team&&assignment.content[0].team.company&&assignment.content[0].team.company.internal)){var searchContractorMenuItems,itemLength;if(searchContractorMenuItems=document.getElementsByClassName("menu-search-contractors"),itemLength=searchContractorMenuItems.length,itemLength>0)for(;itemLength;)itemLength--,searchContractorMenuItems[itemLength].remove()}})}function groupOptionalSubmenu(type,menu,level){var groupName={OUTBOUND_RECRUITER:"Outbound Recruiter",JOB_BOARD_POSTER:"Job Board Poster",APPLICANT:"Applicant",MANAGER:"Manage",TEAM_MANAGER:"Team Manager",CANDIDATE:"You",COMPANY_ADMIN:"Manage",ENFORCER:"Enforcer",RECRUITMENT_ANALYST:"Recruitment Analyst",ACCOUNT_MANAGER:"Account Manager",RECRUITER:"Recruiter",ADMIN:"Admin"};return[{title:groupName[type],href:menu[0].href,pattern:menu[0].pattern,id:menu[0].id,level:level,subList:menu}]}function addHireTeamMenu(menu){var hasFeature=_.find($scope.user.userFeatures,function(f){return"TEAM_HIRING"===f.userFeature});if(hasFeature){var hireMenu=_.find(menu,function(menu){return"Hire"===menu.title}).subList,hireTeamMenu=_.find(hireMenu,function(menu){return"Hire a Team"===menu.title});hireTeamMenu||hireMenu.push({title:"Hire a Team",href:"manager/hire-team/categories",id:"hire-team",pattern:/^manager\/hire/})}}function addCancelApplicationMenu(menu){JobApplicationService.list(function(res){var inProgress=_.find(res.content,function(a){return"IN_PROGRESS"===a.status});if(inProgress){var otherMenu=_.find(menu,function(item){return"Other"===item.title||"You"===item.title}),cancelItem=_.find(otherMenu.subList,function(item){return"Cancel Application"===item.title});cancelItem||otherMenu.subList.push({title:"Cancel Application",href:"candidate/dashboard/applications?cancel=true",id:"cancel-application",pattern:/^candidate\/dashboard\/applications$/})}})}$scope.Flash=Flash,$scope.rootScope=$rootScope,$scope.isCollapsed=!0,$scope.isSubtitleBarVisible=!0,$scope.role=void 0,$scope.ui={settings:!1,notifications:!1},$scope.aVal=function(val){return"object"!=typeof val?val:0},$rootScope.setSubtitle=function(subtitle,innerScope){$scope.subtitle=subtitle,$scope.innerScope=innerScope},$scope.hideSubtitleBar=function(){$scope.isSubtitleBarVisible=!1},$scope.setDarkHeader=function(){$scope.isDarkHeader=!0,$scope.hideSubtitleBar()},$rootScope.scrollToTop=function(){$window.scrollTo(0,0)},$rootScope.$on("$locationChangeStart",function(){$scope.subtitle="",$scope.innerScope=null,$scope.isDarkHeader=!1,$scope.isSubtitleBarVisible=!0,$scope.path="#"+$location.path()}),$rootScope.$watch(function(){return $location.path()},function(){$scope.isCollapsed=!0,$scope.navList&&($scope.currentTabIndex=void 0,$scope.currentSubTabIndex=void 0,$scope.currentSubTabIndexLevel3=void 0,$scope.updateTabIndex())}),$scope.$on("$routeUpdate",function(){$scope.isCollapsed=!0,$scope.navList&&$scope.updateTabIndex()}),$scope.updateNotifications=function(){$rootScope.isUserLoggedIn()&&CrossoverTasksService.query(function(res){$scope.notifications=NotificationService.getList(res)})},$scope.isHome=function(path){if(angular.isUndefined(path))return!1;var pathArr=path.split("/");return"home"===pathArr[1]},$scope.getIdFromName=function(name){if(name){var id=name.split(" ");return id=id.map(function(part){return part=part.toLowerCase()}),id=id.join("-"),"menu-"+id}},$scope.$on("update:notifications",function(){$scope.updateNotifications()}),$rootScope.$watch("runAsId",function(newValue){angular.isDefined(newValue)&&(CurrentUser.clearCache(),$scope.updateUser(),$scope.updateNotifications())});var urlClicked=function($event){return"a"===$event.target.localName},modal=null;$scope.showNotification=function($event,notification){urlClicked($event)||($scope.selected=notification,modal=$uibModal.open({templateUrl:routePrefix+"notifications/details-modal.tpl.html",scope:$scope,backdrop:"static",windowClass:"modal-center"}))},$scope.clickNotification=function($event){urlClicked($event)&&$scope.closeModal()},$scope.closeModal=function(){modal.close()},$rootScope.$watch(function(){return $rootScope.menuRefresh},function(){$rootScope.isUserLoggedIn()&&(CurrentUser.clearCache(),$scope.updateUser())}),$rootScope.$watch(function(){return $rootScope.isUserLoggedIn()},function(isLogged){$scope.isLogged=isLogged,$rootScope.isUserLoggedIn()?(removeMenuItem(),$scope.updateUser(),$scope.updateNotifications()):($scope.currentTabIndex=void 0,$scope.currentSubTabIndex=void 0,$scope.currentSubTabIndexLevel3=void 0)}),$scope.navTabList=null,$scope.currentTabIndex=void 0,$scope.currentSubTabIndex=void 0,$scope.currentSubTabIndexLevel3=void 0,$scope.currentTabId=void 0,$scope.activeTab=null,$scope.updateTabIndex=function(){for(var path=$location.$$url.substr(1),tabs=$scope.navList,i=tabs.length;i--;){var tab=tabs[i];if(angular.isDefined(tab.pattern)&&tab.pattern.test(path)&&($scope.currentTabIndex=i),angular.isDefined(tab.subList))for(var j=tab.subList.length;j--;){var subTab=tab.subList[j];subTab.pattern&&subTab.pattern.test(path)&&($scope.currentTabIndex=i,$scope.currentSubTabIndex=j,$scope.currentSubTabIndexLevel3=void 0)}if(3===tab.level&&angular.isDefined(tab.subList))for(var k=tab.subList.length;k--;){var subTabL3=tab.subList[k];if(angular.isDefined(subTabL3.subList))for(var s=subTabL3.subList.length;s--;)subTabL3.subList[s].pattern&&subTabL3.subList[s].pattern.test(path)&&($scope.currentTabIndex=i,$scope.currentSubTabIndex=k,$scope.currentSubTabIndexLevel3=s)}}};var BadTimeZoneModalInstanceCtrl=function($rootScope,$scope,$uibModalInstance,$cookieStore,currentTimeZone,ipData,user){$scope.currentTimeZone=currentTimeZone,$scope.user=user,$scope.currentCountry=user.location.country,$scope.ipData=ipData,$scope.change=function(){if(angular.isObject($scope.ipData)){var l=angular.copy(user.location);l.timeZone={id:ipData.timeZone.id},l.country={id:ipData.country.id},l.latLong=ipData.latLong,l.city=ipData.city,CurrentUser.updateLocation(l),$uibModalInstance.close()}else $location.path("settings/location"),$uibModalInstance.close();$rootScope.badTimezoneModal=!1},$scope.cancel=function(){$uibModalInstance.close(),$rootScope.badTimezoneModal=!1}},showChangeTimeZoneModal=function(user){user=$scope.user,user&&user.avatarTypes&&user.avatarTypes.indexOf("CANDIDATE")!==-1&&!$rootScope.modalShown&&!angular.isDefined($cookieStore.get("timeChangeDismissed"))&&($rootScope.modalShown=!0,JobApplicationService.getApplications(function(applications){if(angular.isObject(applications)&&angular.isArray(applications.content)){$cookieStore.put("timeChangeDismissed",!0);var filtered=applications.content.filter(function(x){return"ACCEPTED"===x.status});if(angular.isArray(filtered)&&0!==filtered.length){var currentTimeZone=moment().format("Z");currentTimeZone!==user.location.timeZone.hourlyOffset&&CurrentUser.getLocation(function(ipData){$rootScope.badTimezoneModal=!0,$uibModal.open({templateUrl:"bad-timezone-modal.tpl.html",controller:BadTimeZoneModalInstanceCtrl,backdrop:"static",size:"sm",resolve:{ipData:function(){return ipData},user:function(){return user},currentTimeZone:function(){return currentTimeZone}}})})}}}))},buildMenu=function(avatar,data){for(var menu=[],i=avatar.length,sortOrder={OUTBOUND_RECRUITER:11,JOB_BOARD_POSTER:10,APPLICANT:9,MANAGER:8,TEAM_MANAGER:7,CANDIDATE:6,COMPANY_ADMIN:5,ENFORCER:4,RECRUITMENT_ANALYST:3,ACCOUNT_MANAGER:2,RECRUITER:1,ADMIN:0},avatarSorted=_.sortBy(avatar,function(s){return sortOrder[s]}),pushToMenu=function(menuArr){for(var j=-1;j++<menuArr.length-1;)menu.push(menuArr[j])};i--;)switch(avatarSorted[i]){case"ADMIN":avatarSorted.length>1?(avatarSorted.indexOf("ACCOUNT_MANAGER")>-1&&3===bandcampApp.menu.admin[3].subList.length&&bandcampApp.menu.admin[3].subList.push({title:"Endorsement",href:"account-manager/applicants-endorsement",id:"applicants-endorsement",pattern:/^account-manager\/applicants-endorsement.*$/}),pushToMenu(groupOptionalSubmenu(avatarSorted[i],bandcampApp.menu.admin,2))):pushToMenu(bandcampApp.menu.admin);break;case"COMPANY_ADMIN":addHireTeamMenu(bandcampApp.menu.company),pushToMenu(bandcampApp.menu.company);break;case"MANAGER":avatarSorted.indexOf("COMPANY_ADMIN")>-1||(addHireTeamMenu(bandcampApp.menu.manager),pushToMenu(bandcampApp.menu.manager));break;case"TEAM_MANAGER":pushToMenu(bandcampApp.menu.teamManager);break;case"RECRUITER":pushToMenu(avatarSorted.length>1?groupOptionalSubmenu(avatarSorted[i],bandcampApp.menu.recruiter,3):bandcampApp.menu.recruiter);break;case"ACCOUNT_MANAGER":pushToMenu(avatarSorted.length>1?groupOptionalSubmenu(avatarSorted[i],bandcampApp.menu.accountManager,3):bandcampApp.menu.accountManager);break;case"RECRUITMENT_ANALYST":pushToMenu(avatarSorted.length>1?groupOptionalSubmenu(avatarSorted[i],bandcampApp.menu.recruitmentAnalyst,3):bandcampApp.menu.recruitmentAnalyst);break;case"ENFORCER":pushToMenu(bandcampApp.menu.enforcer);break;case"JOB_BOARD_POSTER":pushToMenu(bandcampApp.menu.jobBoardPoster);break;case"OUTBOUND_RECRUITER":pushToMenu(bandcampApp.menu.outboundRecruiter);break;case"CANDIDATE":data.userSecurity.linkedInLogin&&checkAgreementAndLocation(),showChangeTimeZoneModal(data);var contractorMenu=bandcampApp.menu.contractor;avatarSorted.length>1&&(contractorMenu=bandcampApp.menu.contractorOpt),addCancelApplicationMenu(menu),pushToMenu(contractorMenu),loadAssignments().then(function(res){var assignmentsPage=res.content||[];if(assignmentsPage.length>0&&assignmentsPage[0].disabledFeatures&&assignmentsPage[0].disabledFeatures.indexOf("MARKETPLACE")>-1){for(var findWorkIndex=-1,i=0;i<$scope.navList.length;i++)$scope.navList[i]&&"find-work"===$scope.navList[i].id&&(findWorkIndex=i);findWorkIndex>-1&&delete $scope.navList[findWorkIndex]}});break;case"APPLICANT":addCancelApplicationMenu(bandcampApp.menu.applicant),pushToMenu(bandcampApp.menu.applicant);break;default:pushToMenu(bandcampApp.menu.fallback),$scope.settingsUrl=void 0}return menu},checkAgreementAndLocation=_.once(function(){CurrentUser.getAvatar({avatarType:"CANDIDATE"},function(cand){cand.agreementAccepted?cand.location.city||$location.path("/signup/location"):$location.path("/candidate/terms")})}),loadAssignments=function(){return AssignmentService.assignments({page:0,status:"ACTIVE",avatarType:"CANDIDATE"}).$promise},updateMenu=function(data){return!angular.isObject(data)||angular.isUndefined(data.avatarTypes)?($scope.navList=bandcampApp.menu.fallback,void($scope.settingsUrl=void 0)):void($scope.navList=buildMenu(data.avatarTypes,data))};$scope.updateUser=function(){$scope.settingsUrl="settings/account-info",CurrentUser.get(function(data){$scope.user=data,$scope.role=data.avatarTypes,1===data.avatarTypes.length&&"CANDIDATE"===data.avatarTypes[0]?loadAssignments().then(function(res){var hasBecomeAssignment=res.content.length>0;hasBecomeAssignment||($scope.user.avatarTypes[0]="APPLICANT"),updateMenu($scope.user),$scope.updateTabIndex()}):(updateMenu(data),$scope.updateTabIndex(),updateRaven(data),angular.isDefined($scope.user.type)&&angular.isDefined(ENV)&&"production"===ENV&&"ACCOUNT_MANAGER"===$scope.user.type&&!angular.isDefined($scope.jiraCreateIssue)&&($scope.jiraCreateIssue=!0,$.ajax({url:"https://issue-tracker.devfactory.com/s/193da0433122fa57f7d9c54dd375f01b-T/en_US-vekf97/6346/7/1.4.16/_/download/batch/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs/com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:issuecollector-embededjs.js?locale=en-US&collectorId=232707fc",type:"get",cache:!0,dataType:"script"})))})},$scope.closeDropdowns=function(){$scope.user&&$scope.user.avatarTypes.indexOf("ADMIN")!==-1||($scope.ui={settings:!1,notifications:!1})},$document.bind("click",function(event){!angular.element(".dropdownMenu").find(event.target).length>0&&($scope.ui={settings:!1,notifications:!1})});var updateRaven=function(user){angular.isObject(user)&&angular.isDefined(window.configuration)&&angular.isDefined(window.configuration.raven)&&angular.isDefined(Raven)&&window.configuration.raven.enabled&&Raven.setUserContext({email:user.email,id:user.id})};$rootScope.isUserLoggedIn()&&$scope.updateUser(),$rootScope.$on("$routeChangeSuccess",function(){$scope.flashMsg=Flash.getMessage();
}),$scope.$on("$idleStart",function(){}),$scope.$on("$idleTimeout",function(){$rootScope.isUserLoggedIn()&&($rootScope.logoutButDoNotRedirect(),$location.path("/logout/inactivity"))}),$scope.$on("$idleEnd",function(){}),$scope.$on("$keepalive",function(){})}]).run(function(Idle){Idle.watch()}),ctrls.controller("HomeCtrl",[function(){}]),ctrls.controller("InterviewBaseCtrl",["$scope","$routeParams","InterviewsService","TeamInterviewService","ManagerNotesService",function($scope,$routeParams,InterviewsService,TeamInterviewService,ManagerNotesService){var ctrl=this,InterviewClass=function(){this.mode=null};InterviewClass.prototype={setMode:function(mode){this.mode=mode},type:function(){return this.mode.type},id:function(){return this.mode.id},service:function(){return this.mode.service},managerNotesService:function(){return this.mode.managerNotesService},serviceMethods:function(){return this.mode.serviceMethods},loadData:function(data){return this.mode.loadData(data)},urlPath:function(){return this.mode.urlPath},setVideoConferenceSubtitle:function(){return this.mode.setVideoConferenceSubtitle()},getManagerNotes:function(param){return this.mode.getManagerNotes(param)}};var candidateInterviewClass=function(){var GL=this;this.type="candidate",this.id=$routeParams.interviewId,this.service=InterviewsService,this.managerNotesService=ManagerNotesService,this.serviceMethods={acceptSlot:function(param){return GL.service.acceptSlot({id:GL.id,status:"CANDIDATE_ACCEPTED"},param).$promise},rejectSlot:function(param){return GL.service.acceptSlot({id:GL.id,status:null},param).$promise},declineSlot:function(param){return GL.service.acceptSlot({id:GL.id,status:"CANDIDATE_REJECTED"},param).$promise},getManagerNotes:function(param){return GL.managerNotesService.query({id:param.selection.marketplaceMember.application.id}).$promise}},this.loadData=function(data){$scope.job=data.selection.marketplaceMember.application.job},this.urlPath="/interview/",this.setVideoConferenceSubtitle=function(){$scope.subtitle="Interview "+$scope.job.title},this.getManagerNotes=function(param){GL.serviceMethods.getManagerNotes(param).then(function(res){res=_.groupBy(_.sortBy(res,"createdOn"),function(n){return moment(n.createdOn).startOf("day")._d.getTime()}),_.isEmpty(res)||($scope.sharedNotes=res)})}},teamInterviewClass=function(){var GL=this;this.type="team",this.id=$routeParams.teamInterviewId,this.service=TeamInterviewService,this.serviceMethods={acceptSlot:function(param){return GL.service.acceptSlot({id:GL.id,startDateTime:param.startDateTime,endDateTime:param.endDateTime}).$promise},rejectSlot:function(param){return GL.service.declineSlot({id:GL.id,intervieweeNotes:param.intervieweeNotes,rejectionType:"REJECT_SLOTS"}).$promise},declineSlot:function(param){return GL.service.declineSlot({id:GL.id,intervieweeNotes:param.intervieweeNotes,rejectionType:"REJECT"}).$promise}},this.loadData=function(data){$scope.team=data.selection.team},this.urlPath="/teaminterview/",this.setVideoConferenceSubtitle=function(){$scope.subtitle="Interview Team: "+$scope.team.name},this.getManagerNotes=function(){$scope.sharedNotes=null}},interviewType=$routeParams.interviewId?new candidateInterviewClass:$routeParams.teamInterviewId?new teamInterviewClass:null;ctrl.GL_Interview=new InterviewClass,ctrl.GL_Interview.setMode(interviewType)}]),ctrls.controller("ScheduleBaseCtrl",["$scope","$routeParams","MarketplaceMembersService","TeamService","SelectionService","TeamSelectionsService",function($scope,$routeParams,MarketplaceMembersService,TeamService,SelectionService,TeamSelectionsService){var ctrl=this,ScheduleClass=function(){this.mode=null};ScheduleClass.prototype={setMode:function(mode){this.mode=mode},type:function(){return this.mode.type},id:function(){return this.mode.id},service:function(){return this.mode.service},serviceMethods:function(){return this.mode.serviceMethods},isCandidateAvailable:function(data){return this.mode.isCandidateAvailable(data)},getCandidate:function(data){return this.mode.getCandidate(data)},getDataForSave:function(selectedSlots){return this.mode.getDataForSave(selectedSlots)}};var candidateScheduleClass=function(){var GL=this;this.type="candidate",this.id=$routeParams.marketplaceMemberId,this.service=MarketplaceMembersService,this.selectionService=SelectionService,this.serviceMethods={save:function(param){return GL.selectionService.save(param).$promise}},this.isCandidateAvailable=function(data){return"AVAILABLE"===data.status},this.getCandidate=function(data){return data.application.candidate},this.getDataForSave=function(selectedSlots){var data={selection:{marketplaceMember:{id:GL.id}},interview:{interviewSlots:selectedSlots,durationInMinutes:$scope.interviewDurationInMinutes||30}};return $routeParams.teamId&&(data.selection.team={id:$routeParams.teamId}),data}},teamScheduleClass=function(){var GL=this;this.type="team",this.id=$routeParams.teamId,this.service=TeamService,this.selectionService=TeamSelectionsService,this.serviceMethods={save:function(param){return GL.selectionService.saveInterview(param).$promise}},this.isCandidateAvailable=function(){return!0},this.getCandidate=function(data){return data.teamOwner},this.getDataForSave=function(){return{durationInMinutes:$scope.interviewDurationInMinutes||30,selection:{category:{id:$routeParams.categoryId},team:{id:GL.id}}}}},interviewType=$routeParams.marketplaceMemberId||$routeParams.interviewId?new candidateScheduleClass:$routeParams.teamId?new teamScheduleClass:null;ctrl.GL_Schedule=new ScheduleClass,ctrl.GL_Schedule.setMode(interviewType)}]),ctrls.controller("InterviewAcceptDeclineCtrl",["$scope","$location","baseUrl","$uibModal","$controller",function($scope,$location,baseUrl,$uibModal,$controller){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function checkStatusAndAction(){var status=$scope.data.interview.status;if("INITIAL"===status){var action=$location.search().action;"accept"===action?$scope.accept():"decline"===action&&$scope.decline()}else $location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/view");var text={CANDIDATE_ACCEPTED:" Accepted",CANDIDATE_REJECTED:" Declined",INITIAL:"Candidate Informed",SCHEDULED:"Being scheduled",CONDUCTED:"Conducted",NOT_CONDUCTED:"Not conducted as per Schedule",OFFER:"Hired for job",NOT_HIRED:"Not hired for job"}[status];showMessage("alert-warning","The interview status is "+text+".")}var ctrl=this;angular.extend(ctrl,$controller("InterviewBaseCtrl",{$scope:$scope})),$scope.data={interview:null,interviewType:ctrl.GL_Interview.type()},$scope.job=null,$scope.ui={isLoading:!0},$scope.accept=function(){$location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/accept")},$scope.decline=function(){var modalInstance=$uibModal.open({templateUrl:"interview-decline.tpl.html",controller:"InterviewDeclineCtrl",backdrop:"static",resolve:{interview:function(){return $scope.data.interview},GL_Interview:function(){return ctrl.GL_Interview}}});modalInstance.result.then(function(declinedInterview){$scope.data.interview=declinedInterview,showMessage("alert-success","The interview declinature has been sent to the client."),$location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/view")})},ctrl.GL_Interview.service().get({id:ctrl.GL_Interview.id()}).$promise.then(function(data){$scope.data.interview=data,ctrl.GL_Interview.loadData($scope.data.interview),$scope.hiringManager=$scope.data.interview.selection.manager,$scope.candidate=$scope.data.interview.interviewee,checkStatusAndAction()})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}]),ctrls.controller("InterviewDeclineCtrl",["$scope","$uibModalInstance","baseUrl","interview","GL_Interview",function($scope,$uibModalInstance,baseUrl,interview,GL_Interview){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}$scope.data={interview:interview},$scope.ui={isLoading:!1},$scope.decline=function(){$scope.ui.isLoading=!0,interview.status="CANDIDATE_REJECTED",GL_Interview.serviceMethods().declineSlot(interview).then(function(data){$uibModalInstance.close(data)})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("InterviewAcceptCtrl",["$scope","baseUrl","$location","TimeUtils","LocationUtils","$controller",function($scope,baseUrl,$location,TimeUtils,LocationUtils,$controller){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function setDaySelected(day){$scope.slotDisplay=0,$scope.currentHour=0,day.className[0]+=" selected",$scope.selectedDay&&$scope.selectedDay.start!==day.start&&($scope.selectedDay.className[0]=$scope.selectedDay.className[0].replace(" selected","")),$scope.selectedDay=day}function setSlotsSelected(day){var slots=$scope.slots.filter(function(daySlots){return daySlots.day.getTime()===day.start.getTime()})[0];$scope.selectedSlots=slots,$scope.currentHour=0}function setCalendarEvents(i){var slots=i.interviewSlots,evts={};slots.forEach(function(slot){var date=moment(getInterViewSlotTime(i,slot.startDateTime)).toDate(),now=$scope.getNow().mine.getTime();date.getTime()<now+moment.duration(1,"h").asMilliseconds()||(date.setHours(0),date.setMinutes(0),evts[date]||(evts[date]=[]),evts[date].push(slot))}),$scope.slots=[];var calendarEvents=$scope.eventSources[0];for(var key in evts){calendarEvents.push({start:moment(key).toDate(),title:moment(key).toDate().getDate()+"",className:["available"],allDay:!0});for(var day={day:moment(key).toDate(),map:[]},k=0;k<evts[key].length;++k){var slot=evts[key][k],validSlot=!1;moment(slot.startDateTime)>moment()&&(validSlot=!0),day.map.push({id:slot.id,valid:validSlot,time:moment(slot.startDateTime).toDate(),candidateSlotTime:getInterViewSlotTime(i,slot.startDateTime),available:!0,selected:!1})}$scope.slots.push(day)}setDaySelected(calendarEvents[0]),setSlotsSelected(calendarEvents[0])}function selectEvent(evt){var day=$scope.eventSources[0].filter(function(day){return day.start===evt.start._i})[0];setDaySelected(day),setSlotsSelected(day)}function getStyle(){var urlBlueIcon=$scope.ui.urlBlueMarker.replace(/https:/,"http:"),urlGrayIcon=$scope.ui.urlGrayMarker.replace(/https:/,"http:"),url="https://maps.googleapis.com/maps/api/staticmap?center=0,10&zoom=0&size=260x240&scale=2&format=png&style=feature:administrative|visibility:off&style=style=feature:water|color:0xffffff&style=feature:landscape|visibility:on|color:0xe5f1f7&markers=scale:2|icon:"+urlGrayIcon+"|"+LocationUtils.getText($scope.candidate.location)+"&markers=scale:2|icon:"+urlBlueIcon+"|"+LocationUtils.getText($scope.manager.location);return $scope.url=url,{"background-image":"url("+encodeURI(url)+")"}}function checkIfInterviewStartTimeIsAvailable(tryRange){var mbs=$scope.data.interview.candidateViewOfManagerBusySlots||[],mbsL=mbs.length;if(mbsL>0)for(;mbsL--;)if(moment(tryRange.startDateTime).isBefore(moment(mbs[mbsL].endDateTime))&&moment(mbs[mbsL].startDateTime).isBefore(tryRange.endDateTime))return!1;return!0}function getInterViewSlotTime(i,startDateTime){if(angular.isObject(i)){var a=moment(startDateTime),b=i.interviewee.location.timeZone.offset,d=new Date(a.add(b,"ms"));return d.setTime(d.getTime()+6e4*d.getTimezoneOffset()),d}}function convertDateTimeToCandidateDateTime(datetime){var a=moment(datetime),b=$scope.candidate.location.timeZone.offset,d=new Date(a.add(b,"ms"));return d.setTime(d.getTime()+6e4*d.getTimezoneOffset()),d}function createDateTimeFromCandidateDateTime(datetime){var a=moment(datetime),b=$scope.candidate.location.timeZone.offset,d=new Date(a.subtract(b,"ms"));return d.setTime(d.getTime()-6e4*d.getTimezoneOffset()),d}function convertManagerBusySlotsToCandidateTimezone(){for(var mbs=angular.copy($scope.data.interview.managerBusySlots)||[],mbsL=mbs.length;mbsL--;)mbs[mbsL].startDateTime=convertDateTimeToCandidateDateTime(mbs[mbsL].startDateTime),mbs[mbsL].endDateTime=convertDateTimeToCandidateDateTime(mbs[mbsL].endDateTime);return mbs}function decorateInterviewSlots(i){var tryRange,checkRange;i.candidateViewOfManagerBusySlots=convertManagerBusySlotsToCandidateTimezone(),i.candidateInterviewSlots=[],i.interviewSlots.forEach(function(slot){if(moment(slot.startDateTime).toDate()>moment().toDate()){slot.valid=!0,tryRange={startDateTime:getInterViewSlotTime(i,slot.startDateTime)};var slotEndTime=getInterViewSlotTime(i,slot.endDateTime);for(tryRange.endDateTime=moment(tryRange.startDateTime).add(i.durationInMilliseconds).toDate();!moment(tryRange.endDateTime).isAfter(slotEndTime);)tryRange.endDateTime=moment(tryRange.startDateTime).add(i.durationInMilliseconds).toDate(),checkRange=angular.copy(tryRange),checkIfInterviewStartTimeIsAvailable(checkRange)&&i.candidateInterviewSlots.push(checkRange),tryRange.startDateTime=new Date(tryRange.startDateTime.getTime()+18e5),tryRange.endDateTime=moment(tryRange.startDateTime).add(i.durationInMilliseconds).toDate()}})}var ctrl=this;angular.extend(ctrl,$controller("InterviewBaseCtrl",{$scope:$scope})),$scope.data={interview:null,interviewType:ctrl.GL_Interview.type(),timezone:{mine:null,contact:null},hoursDiff:0,selectedTime:new Date,rejectTimes:{}},$scope.slotDisplay=0,$scope.eventSources=[[]],$scope.ui={isLoading:!0,isLocked:!1,style:null,urlBlueMarker:"http://goo.gl/bq7NMr",urlGrayMarker:"http://goo.gl/0y19sB",calendarConfig:null,slotNotSelected:!1,mapLoading:!0},$scope.mapReady=function(){$scope.ui.mapLoading=!1},$scope.msg={clazz:null,show:!1,message:""},$scope.currentHour=0,$scope.changeHour=function(hour){$scope.currentHour+hour<0||$scope.currentHour+hour>$scope.selectedSlots.map.length-1||($scope.currentHour+=hour)},$scope.scrollEvent=function($event,$delta){$scope.changeHour(-$delta),$event.preventDefault()},$scope.getSelectedTime=function(){var inv=$scope.data.interview;return inv&&inv.selectedSlot?inv.slots[inv.selectedSlot]:null},$scope.getNow=function(){var now=new Date,inv=$scope.data.interview;if(!inv)return{mine:now,contact:now};var myOffset=$scope.candidate.location.timeZone.offset,contactOffset=$scope.manager.location.timeZone.offset;return{mine:TimeUtils.getTimeByTimezoneOffset(myOffset),contact:TimeUtils.getTimeByTimezoneOffset(contactOffset)}},$scope.confirm=function(){if(!$scope.ui.isLocked){$scope.ui.slotNotSelected=!1;var interview=angular.copy($scope.data.interview);if(!interview.selectedSlot)return void showMessage("warning","Please select time slot for your interview");var sInt=_.filter(interview.candidateInterviewSlots,function(i){return i.isSelected===!0})[0];interview.status="CANDIDATE_ACCEPTED",interview.startDateTime=createDateTimeFromCandidateDateTime(sInt.startDateTime),interview.endDateTime=createDateTimeFromCandidateDateTime(sInt.endDateTime),interview.candidateResponseSent=!0,delete interview.jobApplication,$scope.ui.isLoading=!0,ctrl.GL_Interview.serviceMethods().acceptSlot(interview).then(function(){$scope.ui.isLocked=!0,$scope.msg.show=!1,$location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/view")})["catch"](function(err){showMessage("danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}},$scope.rejectTimes=function(message){var interview=angular.copy($scope.data.interview);message&&message.length>0&&($scope.ui.isLoading=!0,interview.intervieweeNotes=message,ctrl.GL_Interview.serviceMethods().rejectSlot(interview).then(function(){$location.path("/candidate/dashboard")})["catch"](function(err){showMessage("danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1}))},$scope.isSlotInSelectedDate=function(slot){var slotDate=moment(slot.startDateTime).toDate(),selectedDate=moment($scope.selectedDay.start).toDate();return slotDate.getFullYear()===selectedDate.getFullYear()&&slotDate.getMonth()===selectedDate.getMonth()&&slotDate.getDate()===selectedDate.getDate()},$scope.toggleSlot=function(slot){slot.isSelected?($scope.data.interview.selectedSlot=!0,$scope.data.interview.candidateInterviewSlots.forEach(function(x){x.startDateTime!==slot.startDateTime&&x.endDateTime!==slot.endDateTime&&(x.isSelected=!1)})):$scope.data.interview.selectedSlot=!1},$scope.ui.calendarConfig={editable:!1,titleFormat:"MMMM, YYYY",dayNamesShort:["Su","Mo","Tu","We","Th","Fr","Sa"],header:{left:"prev",center:"title",right:"next"},eventClick:selectEvent},ctrl.GL_Interview.service().get({id:ctrl.GL_Interview.id()}).$promise.then(function(data){$scope.data.interview=data,$scope.data.interview.durationInMilliseconds=moment.duration($scope.data.interview.durationInMinutes,"minutes").asMilliseconds(),$scope.candidate=$scope.data.interview.interviewee,$scope.manager=$scope.data.interview.selection.manager,decorateInterviewSlots($scope.data.interview);var status=$scope.data.interview.status;if("INITIAL"===status){delete $scope.data.interview.selectedSlot,setCalendarEvents($scope.data.interview),$scope.ui.style=getStyle();var oMine=$scope.candidate.location.timeZone.offset,oContact=$scope.manager.location.timeZone.offset;$scope.data.timezone.mine=TimeUtils.formatUtcOffset(oMine),$scope.data.timezone.contact=TimeUtils.formatUtcOffset(oContact),$scope.hoursDiff=TimeUtils.hoursDiffBetweenTimezones(oMine,oContact)}else{var url=ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/response";$location.path(url)}})["catch"](function(err){showMessage("danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}]),ctrls.controller("AvailabilityModalCtrl",["$scope","$uibModalInstance","$cookies","$location","SelectionService","marketplaceMember","type",function($scope,$uibModalInstance,$cookies,$location,SelectionService,marketplaceMember,type){$scope.exclude=!1,$scope.type=type,$scope.nextStep=function(){$uibModalInstance.close(),"HIRE"===type?SelectionService.advancePaymentModal(marketplaceMember.application.candidate,function(){$location.path("/hire/direct/"+marketplaceMember.id)}):$location.path("/interview/schedule/"+marketplaceMember.id)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.change=function(v){var excludes=angular.fromJson($cookies.availabilityWarningUsers)||[],candidateId=marketplaceMember.application.candidate.id;if(v)excludes.push(candidateId);else{var i=excludes.indexOf(candidateId);i>-1&&excludes.splice(i,1)}$cookies.availabilityWarningUsers=angular.toJson(excludes)}}]),ctrls.controller("InterviewScheduleCtrl",["$scope","baseUrl","SelectionService","TimeUtils","$routeParams","$location","CurrentUser","LocationUtils","InterviewsService","$compile","ManagerService","$controller","$timeout",function($scope,baseUrl,SelectionService,TimeUtils,$routeParams,$location,CurrentUser,LocationUtils,InterviewsService,$compile,ManagerService,$controller,$timeout){function setManagerAvailableSlots(availableSlots){return!!$scope.manager&&($scope.manager.availableSlots=availableSlots,!0)}function updateEventSource(event){var e=_.find($scope.events,function(e){return e._id===event._id});angular.extend(e,event)}function getSubSlotPosition(ev,cs){var diff=moment(cs.start).diff(ev.start),halfHour=18e5,style="top: ";return style+=diff>=halfHour?23*parseInt(diff/halfHour,10):0,style+"px"}function renderEventSubSlots(ev,el){var csHtml,cs=ev.candidateSlots||[],i=cs.length;if(i>0)for(angular.element(el).find(".fc-time").remove(),angular.element(el).find(".fc-title").remove();i--;)csHtml='<div class="candidate-slot '+cs[i].className+'" style="'+getSubSlotPosition(ev,cs[i])+'"><div class="content"><p>'+moment(cs[i].start).format("HH:mm")+" - "+moment(cs[i].end).format("HH:mm")+'</p><p class="text-ellipsis">'+cs[i].title+"</p></div><div>",angular.element(el).find(".fc-content").append(csHtml)}function calendarGoToNextPrevMonday(date){var today=new Date,m=moment(date),mToday=moment(today);if(m.isValid()){if(m.isAfter(today))return new Date(mToday.add(1,"weeks").startOf("isoWeek"));if(m.isBefore(today))return new Date(mToday.subtract(1,"weeks").endOf("isoWeek").add(1,"days"))}return date}function getTimeDiff(date1,date2){return Math.abs(moment(date1).diff(moment(date2)))}function determineAvailableSlotsRemainingSpace(){var csL,i,freeInterviewSlots,diffBetweenCs,events=$scope.events||[],evL=events.length,hour=36e5;if(evL>0)for(events=_(events).sortBy(function(ev){return ev.start});evL--;){if(events[evL].candidateSlots=_(events[evL].candidateSlots).sortBy(function(ev){return ev.start}),csL=(events[evL].candidateSlots||[]).length,i=0,csL>0){for(freeInterviewSlots=0;i<csL-1;)diffBetweenCs=getTimeDiff(events[evL].candidateSlots[i+1].start,events[evL].candidateSlots[i].end),diffBetweenCs>=hour&&(freeInterviewSlots+=parseInt(diffBetweenCs/hour,10)),i++;diffBetweenCs=getTimeDiff(events[evL].end,events[evL].candidateSlots[i].end),diffBetweenCs>=hour&&(freeInterviewSlots+=parseInt(diffBetweenCs/hour,10))}else diffBetweenCs=getTimeDiff(events[evL].end,events[evL].start),diffBetweenCs>=hour&&(freeInterviewSlots=parseInt(diffBetweenCs/hour,10)),events[evL].busy=!1;events[evL].freeInterviewSlots=freeInterviewSlots}}function checkIfCsInsideAvailableSlot(csStart,csEnd,evStart,evEnd){return!(!moment(csStart).isAfter(moment(evStart))&&!moment(csStart).isSame(moment(evStart))||!moment(csEnd).isBefore(moment(evEnd))&&!moment(csEnd).isSame(moment(evEnd)))}function isSame(csStart,csEnd,evStart,evEnd){return moment(csStart).isSame(evStart)&&moment(csEnd).isSame(evEnd)}function assignCandidateSlotsToManagerAvailableSlots(){if($scope.candidateSlots.length>0)for(var candidateSlots=$scope.candidateSlots,eventSlots=$scope.events,csL=candidateSlots.length,evL=0;csL--;)for(evL=eventSlots.length;evL--;)if(checkIfCsInsideAvailableSlot(candidateSlots[csL].start,candidateSlots[csL].end,eventSlots[evL].start,eventSlots[evL].end)){angular.isDefined(eventSlots[evL].candidateSlots)||(eventSlots[evL].candidateSlots=[]),eventSlots[evL].candidateSlots.push(candidateSlots[csL]),eventSlots[evL].editable=!1;break}determineAvailableSlotsRemainingSpace()}function removeCsRangeFromAvailableSlot(csStart,csEnd){for(var ev=$scope.events||[],evL=ev.length;evL--;)if(checkIfCsInsideAvailableSlot(csStart,csEnd,ev[evL].start,ev[evL].end)&&!isSame(csStart,csEnd,ev[evL].start,ev[evL].end)){moment(csStart).isSame(moment(ev[evL].start))?ev[evL].start=csEnd:moment(csEnd).isSame(moment(ev[evL].end))?ev[evL].end=csStart:moment(csStart).isAfter(moment(moment(ev[evL].start)))&&moment(csEnd).isBefore(moment(ev[evL].end))&&($scope.pushEvent(!0,csEnd,ev[evL].end,null,!0,"existEvent"),ev[evL].end=csStart),ev[evL].minLength=ev[evL].start-ev[evL].end;break}}function setManagerBusySlots(){$scope.ui.calendarLoading=!0,$scope.candidateSlots=[],CurrentUser.getAvatar({avatarType:"MANAGER"}).$promise.then(function(res){if($scope.manager=res,$scope.availableSlots=$scope.manager.availableSlots||[],$scope.availableSlots.length>0){var params={avatarType:"MANAGER",status:["INITIAL","CANDIDATE_ACCEPTED"],selectionStatus:"IN_PROGRESS",type:["CANDIDATE","TEAM"]};InterviewsService.list(params).$promise.then(function(r){if(r.content){var reintCA=r.content.filter(function(ev){return"CANDIDATE_ACCEPTED"===ev.status&&parseInt($routeParams.interviewId,10)===ev.id}),intCA=r.content.filter(function(ev){return"CANDIDATE_ACCEPTED"===ev.status&&parseInt($routeParams.interviewId,10)!==ev.id}),offset=$scope.currentUser.location.timeZone.offset+6e4*(new Date).getTimezoneOffset(),iTimeOffset=function(time){return moment(time).add(offset,"ms")};_.each($scope.availableSlots,function(ev){$scope.pushEvent(!0,iTimeOffset(ev.startDateTime),iTimeOffset(ev.endDateTime),null,!0,"existEvent")}),reintCA.length>0&&_.each(reintCA,function(ev){removeCsRangeFromAvailableSlot(iTimeOffset(ev.startDateTime),iTimeOffset(ev.endDateTime))}),intCA.length>0&&_.each(intCA,function(ev){$scope.pushCandidateSlot(iTimeOffset(ev.startDateTime),iTimeOffset(ev.endDateTime),ev.selection.marketplaceMember.application.candidate.printableName)}),assignCandidateSlotsToManagerAvailableSlots()}})["catch"](function(err){errHandler(err)})["finally"](function(){$scope.ui.calendarLoading=!1})}else $scope.ui.calendarLoading=!1})["catch"](function(err){errHandler(err),$scope.ui.calendarLoading=!1})}function getStyle(){var urlBlueIcon=$scope.ui.urlBlueMarker.replace(/https:/,"http:"),urlGrayIcon=$scope.ui.urlGrayMarker.replace(/https:/,"http:"),userLocation={str:LocationUtils.getText($scope.currentUser.location),country:$scope.currentUser.location.country.name,init:function(){return this.arr=this.str.split(","),this.lat=Number(this.arr[0]),this["long"]=Number(this.arr[1]),delete this.init,this}}.init(),candidateLocation={str:LocationUtils.getText($scope.candidate.location),country:$scope.candidate.location.country.name,init:function(){return this.arr=this.str.split(","),this.lat=Number(this.arr[0]),this["long"]=Number(this.arr[1]),delete this.init,this}}.init(),diff=0;userLocation.lat&&userLocation["long"]&&candidateLocation.lat&&candidateLocation["long"]?Math.abs(userLocation.lat-candidateLocation.lat)<5&&Math.abs(userLocation["long"]-candidateLocation["long"])<5&&(diff=5-Math.abs(userLocation["long"]-candidateLocation["long"]),candidateLocation["long"]<userLocation["long"]&&(diff*=-1),candidateLocation["long"]+=diff,candidateLocation.str=candidateLocation.lat+","+candidateLocation["long"]):candidateLocation.lat&&candidateLocation["long"]||!userLocation.lat||!userLocation["long"]||userLocation.country===candidateLocation.country&&(candidateLocation.lat=userLocation.lat,candidateLocation["long"]=userLocation["long"]+5,candidateLocation.str=candidateLocation.lat+","+candidateLocation["long"]);var url="https://maps.googleapis.com/maps/api/staticmap?center=0,10&zoom=0&size=260x240&scale=2&format=png&style=feature:administrative|visibility:off&style=style=feature:water|color:0xffffff&style=feature:landscape|visibility:on|color:0xe5f1f7&markers=scale:2|icon:"+urlGrayIcon+"|"+userLocation.str+"&markers=scale:2|icon:"+urlBlueIcon+"|"+candidateLocation.str;return $scope.url=url,{"background-image":"url("+encodeURI(url)+")"}}function initMarketplaceMember(m){return ctrl.GL_Schedule.isCandidateAvailable(m)?($scope.candidate=ctrl.GL_Schedule.getCandidate(m),CurrentUser.clearCache(),void CurrentUser.get(function(user){$scope.currentUser=user,$scope.init();var oContact=$scope.candidate.location.timeZone.offset,oMine=$scope.currentUser.location.timeZone.offset;$scope.timezone={},$scope.timezone.mine=$scope.currentUser.location.timeZone.hourlyOffset,$scope.timezone.contact=TimeUtils.formatUtcOffset(oContact),$scope.hoursDiff=TimeUtils.hoursDiffBetweenTimezones(oMine,oContact),$scope.ui.style=getStyle();var busySlots=[];user.busySlots&&user.busySlots.forEach(function(slot){busySlots.push(slot)}),$scope.candidate.busySlots&&$scope.candidate.busySlots.forEach(function(slot){busySlots.push(slot)})})):($scope.toggleMessage(!0,"danger","Sorry this candidate is not available anymore in the marketplace"),void($scope.ui.hideForm=!0))}function canPostponeInterview(invw){return!("INITIAL"!==invw.status&&"CANDIDATE_ACCEPTED"!==invw.status||"IN_PROGRESS"!==invw.selection.status)}function init(){$routeParams.interviewId?InterviewsService.get({id:$routeParams.interviewId}).$promise.then(function(result){$scope.existInterview=result,$location.path().indexOf("postpone")>-1&&!canPostponeInterview(result)?($scope.toggleMessage(!0,"danger","Invalid interview status to postpone!"),$scope.ui.isLoading=!1,$scope.ui.hideForm=!0):initMarketplaceMember($scope.existInterview.selection.marketplaceMember)})["catch"](function(err){$scope.toggleMessage(!0,"danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1}):ctrl.GL_Schedule.service().get({id:ctrl.GL_Schedule.id()}).$promise.then(function(result){initMarketplaceMember(result)})["catch"](function(err){$scope.toggleMessage(!0,"danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}function errHandler(err){$scope.toggleMessage(!0,"danger",err.data.text),$scope.ui.isLoading=!1}function checkExist(){$routeParams.interviewId?init():$routeParams.marketplaceMemberId?SelectionService.query({status:"IN_PROGRESS",avatarType:"MANAGER",marketplaceMemberId:$routeParams.marketplaceMemberId}).$promise.then(function(result){var selections=result.content;_.isEmpty(selections)?init():InterviewsService.list({avatartType:"MANAGER",selectionId:_.first(selections).id,status:["INITIAL","CANDIDATE_ACCEPTED","CONDUCTED"]}).$promise.then(function(res){_.isEmpty(res.content)?init():($scope.toggleMessage(!0,"danger","Duplicate interview creation attempt!"),$scope.ui.hideForm=!0),$scope.ui.isLoading=!1})["catch"](errHandler)})["catch"](errHandler):$routeParams.categoryId&&$routeParams.teamId&&init()}function redirect(){$routeParams.teamId&&$location.path("manager/team-dashboard").search({teamId:$routeParams.teamId,hiring:!0})}var ctrl=this;angular.extend(ctrl,$controller("ScheduleBaseCtrl",{$scope:$scope})),$scope.ui={isLoading:!0,busySlotsLoaded:!1,style:null,urlBlueMarker:"https://goo.gl/bq7NMr",urlGrayMarker:"https://goo.gl/0y19sB",isLocked:!1,mapLoading:!0,calendarLoading:!0,calendarFirstTimeLoad:!1,calendarFirstDayChanged:!1,calendarGoToDate:null},$scope.slotDisplay=0,$scope.toggleMessage=function(show,type,text){$scope.message={show:show,type:type,text:text}},$scope.mapReady=function(){$scope.ui.mapLoading=!1},$scope.lockEvents=function(){_.each($scope.events,function(ev){ev.drag=!1,ev.editable=!1}),$scope.ui.calendarConfig.editable=!1,angular.element(".notice").slideToggle()},$scope.validateEventSubmit=function(){var events,i,freeInterviewSlots=0;if(events=$scope.events||[],i=events.length,i>=3)for(;i--;)if(events[i].busy?freeInterviewSlots+=events[i].freeInterviewSlots:$scope.checkEventLength(events[i])&&freeInterviewSlots++,freeInterviewSlots>=3)return!0;return!1},$scope.save=function(){if(!$scope.ui.isLocked){var selectedSlots=[],offset=$scope.currentUser.location.timeZone.offset+6e4*(new Date).getTimezoneOffset(),iTimeOffset=function(time){return new Date(moment(time).subtract(offset,"ms").format())};if($scope.events.forEach(function(ev){selectedSlots.push({startDateTime:iTimeOffset(ev.start),endDateTime:iTimeOffset(ev.end)})}),$scope.validateEventSubmit()){var data=ctrl.GL_Schedule.getDataForSave(selectedSlots);$scope.ui.isLoading=!0,$scope.toggleMessage(!1,"",""),setManagerAvailableSlots(selectedSlots)&&($scope.existInterview?SelectionService.mdos({id:$scope.existInterview.selection.id,status:"REINTERVIEW"},data.interview,function(){$scope.ui.isLocked=!0,$scope.lockEvents(),ManagerService.update($scope.manager).$promise.then(function(){$scope.ui.isLocked=!0,$scope.lockEvents(),redirect()})["catch"](function(err){$scope.toggleMessage(!0,"danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})},function(e){$scope.ui.isLoading=!1,$scope.toggleMessage(!0,"danger",e.data.text)}):ManagerService.update($scope.manager,function(){ctrl.GL_Schedule.serviceMethods().save(data).then(function(){$scope.ui.isLocked=!0,$scope.lockEvents(),redirect()})["catch"](function(err){$scope.toggleMessage(!0,"danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})},function(e){$scope.ui.isLoading=!1,$scope.toggleMessage(!0,"danger",e.data.text)}))}}},$scope.pushEvent=function(busy,start,end,title,editable,cls){var params={start:start,end:end,editable:editable,allDay:!1,stick:!0,title:title,className:cls,busy:busy,minLength:start-end};$scope.events.push(params)},$scope.pushCandidateSlot=function(start,end,title){var params={start:start,end:end,title:title,className:"size-"+moment(end).diff(start)/18e5};$scope.candidateSlots.push(params)},$scope.toCandidates=function(){$location.path("/manager/candidates")},$scope.checkAvalable=function(start){var dayEnd=moment($scope.getNow().mine).endOf("day").toDate();return dayEnd>start.toDate()},$scope.addEvent=function(start,end){$scope.ui.isLocked||(angular.element(".calendar #m60")[0].checked&&start-end>-36e5&&(end=end.add(30,"minutes")),$scope.checkAvalable(start)||$scope.pushEvent(!1,start,end,$scope.candidate.printableName,!0))},$scope.dropEvent=function(event,delta,revertFunc){
$scope.checkAvalable(event.start)||event.busy?revertFunc():updateEventSource(event)},$scope.removeEvent=function(event,el){if(event.editable&&angular.element(el.target).hasClass("glyphicon-remove-sign")){var index=$scope.events.indexOf($scope.events.filter(function(e){return e._id===event._id}).pop());$scope.events.splice(index,1)}},$scope.eventRender=function(event,element){var tooltip=event.start.format("HH:mm")+" - "+event.end.format("HH:mm"),actions="<div class='remove'><i class='glyphicon glyphicon-remove-sign'></i></div>",e=angular.element(element);e.attr("tooltip-enable",!1),e.attr("tooltip-is-open",!1),e.attr("tooltip-placement","top"),e.attr("uib-tooltip",tooltip),$compile(e)($scope),event.editable&&!event.busy&&e.append(actions);var formattedTime=event.start.format("HH:mm")+" - "+event.end.format("HH:mm");0===angular.element(element).find(".fc-title").length&&angular.element(element).find(".fc-time").text(formattedTime),renderEventSubSlots(event,element)},$scope.viewRender=function(view){if(1!==$scope.ui.calendarConfig.firstDay)$scope.ui.calendarFirstTimeLoad&&!$scope.ui.calendarFirstDayChanged&&($scope.ui.calendarGoToDate=calendarGoToNextPrevMonday(view.start),$scope.ui.calendarFirstDayChanged=!0,$scope.ui.calendarConfig.firstDay=1),$scope.ui.calendarFirstTimeLoad=!0,angular.element(".calendar").find(".fc-content tbody .fc-sun").addClass("week-boundary");else if($scope.ui.calendarGoToDate){var calendarGoToDate=angular.copy($scope.ui.calendarGoToDate);$scope.ui.calendarGoToDate=null,view.calendar.gotoDate(calendarGoToDate)}view.calendar.removeEvents(),view.calendar.addEventSource($scope.events),angular.element(".calendar .fc-toolbar").find(".fc-right").empty().append("<div class='switch'><input class='switch-input' name='intLength' value='30'id='m30' "+$scope.ui.eventRange30+" type='radio'><label for='m30' class='switch-label switch-label-off'>30 mins</label><input "+$scope.ui.eventRange60+" class='switch-input' value='60' name='intLength' click=\"eventRChange()\" id='m60' type='radio'><label for='m60' class='switch-label switch-label-on'>60 mins</label><span class='switch-selection'></span></div><span>Interview length</span>"),angular.element("thead .fc-axis").empty().append('<p class="tzTable">'+$scope.timezone.mine+"<br/><span>"+$scope.timezone.contact+"</span></p>");var diff=$scope.hoursDiff,h=[0,"00"];diff<0?h[0]=24-Math.ceil(Math.abs(diff)):h[0]=Math.floor(diff),diff%1!==0&&(h[1]=60*(Math.abs(diff)%1)),angular.forEach(angular.element("tbody .fc-minor .fc-axis"),function(item){angular.element(item).empty().append("<span>"+(h[0]<=9?"0"+h[0]+":"+h[1]:h[0]+":"+h[1])+"</span>"),h[0]=23===parseInt(h[0],10)?0:parseInt(h[0],10)+1}),angular.element("#m30").click(function(){$timeout(function(){$scope.ui.eventRange30="checked",$scope.ui.eventRange60="",$scope.interviewDurationInMinutes=30})}),angular.element("#m60").click(function(){$timeout(function(){$scope.ui.eventRange30="",$scope.ui.eventRange60="checked",$scope.interviewDurationInMinutes=60})})},$scope.checkEventLength=function(event){var eventTimeDiff=event.start-event.end;return!($scope.ui.eventRange30&&eventTimeDiff>-18e5)&&(!($scope.ui.eventRange60&&eventTimeDiff>-36e5)&&!(event.busy&&eventTimeDiff>event.minLength))},$scope.eventResize=function(event,delta,revertFunc){return $scope.checkEventLength(event)?void updateEventSource(event):revertFunc()},$scope.init=function(){$scope.events=[],setManagerBusySlots(),$scope.eventSources=[$scope.events],$scope.ui.eventRange30="checked",$scope.ui.eventRange60="",$scope.interviewDurationInMinutes=30,$scope.ui.calendarConfig={firstDay:(new Date).getDay(),editable:!0,selectable:!0,dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],axisFormat:"HH:mm",header:{left:"prev,title,next,today",right:"Interview length:"},views:{agenda:{titleFormat:"MMM D, YYYY",timeFormat:"H:mm"}},buttonText:{prev:"",next:"",today:"This Week"},defaultView:"agendaWeek",allDaySlot:!1,timezone:"local",eventOverlap:!1,viewRender:$scope.viewRender,eventClick:$scope.removeEvent,select:$scope.addEvent,eventDrop:$scope.dropEvent,eventRender:$scope.eventRender,eventResize:$scope.eventResize,selectHelper:!1,eventMouseover:function(){var e=angular.element(this);e.attr("tooltip-enable",!0),e.attr("tooltip-is-open",!0),$compile(e)($scope)},eventDestroy:function(){angular.element(".fc-event-container").find(".tooltip").remove()}}},$scope.getNow=function(){var now=new Date;if(!$scope.candidate||!$scope.currentUser)return{mine:now,contact:now};var contactOffset=$scope.candidate.location.timeZone.offset,myOffset=$scope.currentUser.location.timeZone.offset;return{mine:TimeUtils.getTimeByTimezoneOffset(myOffset),contact:TimeUtils.getTimeByTimezoneOffset(contactOffset)}},checkExist()}]);var BJN_CLIENT={content:"myclient",embed:!0,height:"500px",version:1};ctrls.controller("VideoConferenceCtrl",["$scope","$location","CurrentUser","$window","$controller",function($scope,$location,CurrentUser,$window,$controller){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function checkStatusAndAction(){_.intersection(["INITIAL","NOT_CONDUCTED","CANDIDATE_REJECTED","SCHEDULED","CONDUCTED"],[$scope.data.interview.status]).length>0&&$location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/view")}var ctrl=this;angular.extend(ctrl,$controller("InterviewBaseCtrl",{$scope:$scope})),$scope.data={interview:null,interviewType:ctrl.GL_Interview.type()},$scope.job=null,$scope.ui={interviewLoaded:!1,isLoading:!0,isChrome:/chrome/i.test(navigator.userAgent)},CurrentUser.get(function(user){$scope.currentUser=user}),$scope.invites=[];var start=function(){$scope.ui.isLoading=!0,ctrl.GL_Interview.service().get({id:ctrl.GL_Interview.id()}).$promise.then(function(data){data.marketplaceMemberNote={type:"MP_HM",shared:!0},$scope.data.interview=data,$scope.notConducted="NOT_CONDUCTED"===data.status,BJN_CLIENT.meetingId=$scope.data.interview.blueJeansURL,BJN_CLIENT.name=$scope.currentUser.printableName,BJN_CLIENT.email=$scope.currentUser.email,ctrl.GL_Interview.loadData($scope.data.interview),$scope.hiringManager=$scope.data.interview.selection.manager,$scope.candidate=$scope.data.interview.interviewee;var invite={invite_type:"EMAIL"};$scope.candidate.userId===$scope.currentUser.id&&$scope.currentUser.avatarTypes.indexOf("CANDIDATE")>-1?(invite.id=$scope.hiringManager.email,$scope.userType="candidate",$scope.subtitle="Interview with "+$scope.hiringManager.printableName+" from "+$scope.hiringManager.company.name):$scope.hiringManager.userId===$scope.currentUser.id&&($scope.currentUser.avatarTypes.indexOf("MANAGER")>-1||$scope.currentUser.avatarTypes.indexOf("COMPANY_ADMIN")>-1)?(invite.id=$scope.candidate.email,$scope.userType="hiringManager",$scope.currentManager=$scope.hiringManager,ctrl.GL_Interview.setVideoConferenceSubtitle(),ctrl.GL_Interview.getManagerNotes($scope.data.interview)):$scope.userType="other",$scope.invites.push(invite),checkStatusAndAction(),$scope.ui.isLoading=!1,$scope.ui.interviewLoaded=!0,$scope.ui.blueJeansURL=$scope.data.interview.blueJeansURL,$scope.ui.zoomJoinUrl=$scope.data.interview.zoomJoinUrl,$scope.ui.zoomStartUrl=$scope.data.interview.zoomStartUrl})["catch"](function(e){showMessage("alert-danger",e.data.text)})["finally"](function(){$scope.ui.isLoading=!1})};$scope.launchZoom=function(){$scope.hiringManager.userId===$scope.currentUser.id?$window.open($scope.ui.zoomStartUrl,"_blank"):$window.open($scope.ui.zoomJoinUrl,"_blank")},$scope.submit=function(){var interview=angular.copy($scope.data.interview);interview.status="CONDUCTED",$scope.data.notHappened&&(interview.status="NOT_CONDUCTED"),delete interview.jobApplication,$scope.ui.isLoading=!0,ctrl.GL_Interview.service().update({id:ctrl.GL_Interview.id()},interview).$promise.then(function(){$location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/view")})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})},start()}]),ctrls.controller("InterviewViewCtrl",["$scope","$location","CurrentUser","baseUrl","ProfileUtils","SelectionService","Flash","$uibModal","$controller",function($scope,$location,CurrentUser,baseUrl,ProfileUtils,SelectionService,Flash,$uibModal,$controller){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function checkStatusAndAction(){var status=$scope.data.interview.status,text={CANDIDATE_ACCEPTED:" Accepted",CANDIDATE_REJECTED:" Declined",INITIAL:"Candidate Informed",SCHEDULED:"Being scheduled",CONDUCTED:"Condcuted",NOT_CONDUCTED:"Not Conducted as per Schedule",OFFER:"Offer processed",REJECT:"Not hired"}[status];showMessage("alert-warning","The interview status is "+text+".")}var ctrl=this;angular.extend(ctrl,$controller("InterviewBaseCtrl",{$scope:$scope})),$scope.data={interview:null,interviewType:ctrl.GL_Interview.type()},$scope.job=null,CurrentUser.get(function(user){$scope.currentUser=user,loadInterview(),$scope.email=user.email,$scope.name=user.firstName+" "+user.lastName}),$scope.ui={isLoading:!0},$scope.decline=function(){$location.search("action","decline").path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/response")},$scope.accept=function(){$location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/accept")},$scope.launchVideoConference=function(){$location.path(ctrl.GL_Interview.urlPath()+ctrl.GL_Interview.id()+"/video-conference")},$scope.hire=function(){var modalInstance=$uibModal.open({templateUrl:"candidate-hire-confirm.tpl.html",controller:"JobCandidatesHireConfirmCtrl",backdrop:"static"});modalInstance.result.then(function(){var doHire=function(){var slct=angular.copy($scope.data.interview.selection);$scope.ui.isLoading=!0,SelectionService.mdos({id:slct.id,status:"OFFERED"},{}).$promise.then(function(){Flash.addSuccess("Offer has been made to candidate.","/dashboard")})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})};SelectionService.advancePaymentModal($scope.data.interview.selection.marketplaceMember.application.candidate,doHire)})},$scope.reject=function(){var modalInstance=$uibModal.open({templateUrl:"candidate-reject-confirm.tpl.html",controller:"JobCandidatesRejectConfirmCtrl",backdrop:"static"});modalInstance.result.then(function(){var invw=angular.copy($scope.data.interview),slct=invw.selection;delete invw.jobApplication,$scope.ui.isLoading=!0,SelectionService.mdos({id:slct.id,status:"REJECTED"},{}).$promise.then(function(){Flash.addSuccess("Candidate has been rejected.","/dashboard")})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})})},$scope.invokeCancelInterview=function(interviewToCancel){var modalInstance=$uibModal.open({templateUrl:"cancel-interview-confirm.tpl.html",controller:ConfirmModalInstanceCtrl,resolve:{interview:function(){return interviewToCancel}},backdrop:"static"});modalInstance.result.then(function(){cancelInterview(interviewToCancel)})};var cancelInterview=function(interview){angular.isObject(interview)&&angular.isObject(interview.selection)&&($scope.isAcceptedInterviewsLoading=!0,SelectionService.cancel({id:interview.selection.id},{},function(){Flash.addSuccess("Interview canceled.","/dashboard")},function(e){showMessage("alert-danger",e.data.text)}))},ConfirmModalInstanceCtrl=function($scope,$uibModalInstance,interview){$scope.interview=interview,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},loadInterview=function(){ctrl.GL_Interview.service().get({id:ctrl.GL_Interview.id()}).$promise.then(function(data){$scope.data.interview=data,ctrl.GL_Interview.loadData($scope.data.interview),$scope.hiringManager=$scope.data.interview.selection.manager,$scope.candidate=$scope.data.interview.interviewee,$scope.data.candidatePhoto=ProfileUtils.profilePhotoUrl($scope.candidate),$scope.hiringManager.userId===$scope.currentUser.id&&($scope.currentUser.avatarTypes.indexOf("MANAGER")>-1||$scope.currentUser.avatarTypes.indexOf("COMPANY_ADMIN")>-1)?$scope.userType="hiringManager":$scope.candidate.userId===$scope.currentUser.id&&$scope.currentUser.avatarTypes.indexOf("CANDIDATE")>-1?($scope.userType="candidate",CurrentUser.getAvatar({avatarType:"CANDIDATE"},function(cand){angular.extend($scope.currentUser,cand)})):$scope.userType="other",$scope.data.interviewStartTime=getInterViewTime(),checkStatusAndAction()})["catch"](function(err){showMessage("alert-danger","Error: "+err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})},getInterViewTime=function(){var i=$scope.data.interview;if("candidate"===$scope.userType||"hiringManager"===$scope.userType){if(angular.isObject(i)){var a=moment(i.startDateTime),b=0;b=$scope.currentUser.location.timeZone.offset;var d=new Date(a.add(b,"ms"));return d.setTime(d.getTime()+6e4*d.getTimezoneOffset()),d}return i.startDateTime}}}]),ctrls.controller("JobAppliedCtrl",["$scope","$routeParams","JobService","$location",function($scope,$routeParams,JobService,$location){var id=parseInt($routeParams.id,10);!isNaN(id)&&id>0?JobService.crud.get({id:id},function(data){$scope.job=data}):$location.path("/")}]),ctrls.controller("JobDetailsCtrl",["$scope","JobService","$routeParams","CurrentUser","ProfileUtils","$location","$sce","$rootScope","JobApplicationService",function($scope,JobService,$routeParams,CurrentUser,ProfileUtils,$location,$sce,$rootScope,JobApplicationService){var id=parseInt($routeParams.id,10);(angular.isUndefined(id)||isNaN(id)||id<1)&&$location.path("/"),$scope.detailsPage=!0,$scope.application=!1,$scope.cannotApply="",$scope.applyPage=!0,$scope.isCandidate=!1,JobService.crud.get({id:id},function(data){data.candidateDescription=$sce.trustAsHtml(data.candidateDescription),data.managerDescription=$sce.trustAsHtml(data.managerDescription),$scope.job=data,$rootScope.setSubtitle(data.title),loadUser()});var loadUser=function(){CurrentUser.get(function(data){$scope.user=data,$scope.isExistCandidate="CANDIDATE"===data.type,$scope.isExistCandidate&&($scope.isCandidate=!0,JobApplicationService.checkCanApply({jobId:id},function(){},function(data){if(angular.isObject(data)){$scope.hasApplication=!0,$scope.cannotApplyError=data.data.text;var title=$scope.job.title;data.data.text.indexOf(title)!==-1&&($scope.duplicateApplication=!0)}}))})};$scope.isAvailable=JobService.isAvailable,$scope.getTimeByOffset=ProfileUtils.getTimeByOffset,$scope.isClosed=function(job){return void 0!==job&&("CANCELLED"===job.status||"COMPLETE"===job.status)}}]),ctrls.controller("JobProfileEditCtrl",["$scope","$routeParams",function($scope,$routeParams){$scope.jobId=$routeParams.jobId}]),ctrls.controller("JobFunnelCtrl",["$scope","$rootScope","JobService","$routeParams","JobApplicationService","$sce","TestsService","$location","ManagerNotesService","$uibModal","$filter","$q","CurrentUser","TimeUtils","$window","clientUrl",function($scope,$rootScope,JobService,$routeParams,JobApplicationService,$sce,TestsService,$location,ManagerNotesService,$uibModal,$filter,$q,CurrentUser,TimeUtils,$window,clientUrl){function loadJob(){JobService.crud.get({id:$scope.job.id,avatarType:"MANAGER"},function(job){if($scope.job=job,_.each($scope.job.tests,function(t){t.takenRatio=(t.numberOfAcceptedCandidates+t.numberOfRejectedCandidates)/t.numberOfCandidates,$scope.job[t.test.type]=t}),"CUSTOM"===$scope.job.type&&($scope.job.calibration?($scope.job.daysOpen=moment().diff(moment($scope.job.calibration.activatedOn),"days"),"APPROVED"===$scope.job.calibration.descriptionApprovalStatus?$scope.ui.blockStates.JD="finished":$scope.ui.blockStates.JD="broken","APPROVED"===$scope.job.calibration.testApprovalStatus?$scope.ui.blockStates.Tests="finished":$scope.job.calibration.testApprovalStatus?$scope.ui.blockStates.Tests="insufficient":$scope.ui.blockStates.Tests="broken"):($scope.ui.blockStates.JD="broken",$scope.job.tests?$scope.ui.blockStates.Tests="insufficient":$scope.ui.blockStates.Tests="broken"),$scope.job.demand?$scope.job.numberOfApplicants<70*$scope.job.demand?($scope.ui.blockStates.CandidatesPerDay="broken",$scope.ui.blockStates.TotalApplicants="broken",$scope.ui.blockStates.Resume="broken"):$scope.job.numberOfApplicants>=70*$scope.job.demand&&$scope.job.numberOfApplicants<100*$scope.job.demand?($scope.ui.blockStates.CandidatesPerDay="insufficient",$scope.ui.blockStates.TotalApplicants="insufficient",$scope.ui.blockStates.Resume="insufficient"):($scope.ui.blockStates.CandidatesPerDay="finished",$scope.ui.blockStates.TotalApplicants="finished",$scope.ui.blockStates.Resume="finished"):($scope.ui.blockStates.CandidatesPerDay="broken",$scope.ui.blockStates.TotalApplicants="broken",$scope.ui.blockStates.Resume="broken"),vm.setStateForTest("HACKER_RANK","HackerRank"),$scope.job.flowType.indexOf("FIVEQ")===-1?vm.setStateForTest("ASSIGNMENT","Trial5Q"):vm.setStateForTest("FIVEQ","Trial5Q"),$scope.job.jobSla&&$scope.job.jobSla.step1Schedule)){var sla=$scope.job.jobSla;fillSla(sla),vm.updateCurrentCalibrationChart(),$scope.ui.blockStates.JD=getStatusByColor(sla,1),$scope.ui.blockStates.Tests=getStatusByColor(sla,3),$scope.ui.blockStates.Resume=getStatusByColor(sla,4)}})}function fillSla(jobSla){var sla=jobSla.sla,days=getSlaDaysArray(sla),stepCounter=1;jobSla.timeline=[],_.each(vm.todoTemplate,function(title,step){processStep(jobSla,step,stepCounter++,days)}),jobSla.timeline=[].concat.apply([],jobSla.timeline),jobSla.timelineMaxSize=jobSla.timeline.length+5,setSlaLocation(jobSla),addDelayedDays(jobSla),jobSla.completeDate=_.last(jobSla.timeline).date}function processStep(jobSla,step,stepCounter,allDays){var schedule=getSlaDate(jobSla,step,"Schedule"),actual=getSlaDate(jobSla,step,"Actual"),color=null;if(actual)actual.getTime()>schedule.getTime()?(setStepDelayed(jobSla,step),color="red"):(setStepCompleted(jobSla,step),color="green");else{var isPast=now.getTime()>schedule.getTime();setStepNotCompleted(jobSla,step,isPast),color=isPast?"red":null}var stepDays=getStepDaysArray(step,schedule,color,allDays),lastDay=_.last(stepDays);lastDay.schedule=schedule,lastDay.actual=actual,lastDay.title=vm.todoTemplate[step],lastDay.step=stepCounter,jobSla.timeline.push(stepDays),jobSla["step"+step+"ScheduleUtc"]=schedule,jobSla["step"+step+"ActualUtc"]=actual}function setStepNotCompleted(jobSla,step,isPast){jobSla["step"+step+"Color"]="RED",jobSla["step"+step+"NotCompleted"]=!0,jobSla["step"+step+"Past"]=isPast,jobSla.nextStep=jobSla.nextStep||step}function setStepDelayed(jobSla,step){jobSla["step"+step+"Color"]="RED",jobSla["step"+step+"Delayed"]=!0}function setStepCompleted(jobSla,step){jobSla["step"+step+"Color"]="GREEN",jobSla["step"+step+"Completed"]=!0}function getSlaDate(jobSla,step,type){var date=jobSla["step"+step+type];return date?TimeUtils.convertToUtc(moment(date)._d):null}function getSlaDaysArray(sla){for(var days=[sla.daysList[0]+1],i=1;i<sla.daysList.length;++i)days.push(sla.daysList[i]-sla.daysList[i-1]);return days[2]+=days[1],days}function getStepDaysArray(step,schedule,color,allDays){var i,j,days=[];for(j=allDays[step-1],i=0;j>0;j--){do var d=moment(schedule).subtract(i++,"days")._d;while(6===d.getDay()||0===d.getDay());days.unshift({date:d,color:color})}return days}function setSlaLocation(jobSla){var currentBlock,plannedBlock,list=jobSla.timeline,i=_.findIndex(list,function(curr){return curr.schedule&&!curr.actual}),curr=list[i];if(curr&&(now.getTime()>curr.schedule.getTime()||isToday(curr.schedule))){if(currentBlock=i-1,list[currentBlock].current=!0,now.getTime()>curr.schedule.getTime()){for(var j=i+1;j<list.length;++j)if(list[j].color="red",isToday(list[j].date)){list[j].planned=!0,plannedBlock=j;break}angular.isUndefined(plannedBlock)&&(plannedBlock=list.length-1,_.last(list).planned=!0)}}else if(curr)for(j=i;j>=0;j--){var inner=list[j];if(inner&&(isToday(inner.date)||inner.actual)){inner.current=!0,currentBlock=j;break}}angular.isDefined(currentBlock)||(_.last(list).current=!0,jobSla.finished=!0),jobSla.currentBlock=currentBlock,jobSla.plannedBlock=plannedBlock}function addDelayedDays(jobSla){var list=jobSla.timeline,currentBlock=jobSla.currentBlock,plannedBlock=jobSla.plannedBlock;if(angular.isDefined(currentBlock)&&angular.isDefined(plannedBlock)){var diff=plannedBlock-currentBlock;if(diff>0){for(var lastDate=_.last(list).date,lastIndex=list.length,i=0;i<diff;i++)list.push({color:"red",date:moment(lastDate).add(i+1,"d")._d,index:lastIndex+i+1});jobSla.daysLate=diff}}}function isToday(date){var currentDay=(new Date).getDay(),now=moment();return 6!==currentDay&&0!==currentDay||(now=now.endOf("isoweek").subtract(2,"d")),moment(date).startOf("day")._d.getTime()===now.startOf("day")._d.getTime()}function getStatusByColor(sla,step){return sla["step"+step+"Completed"]?"finished":sla["step"+step+"Delayed"]?"delayed":sla["step"+step+"NotCompleted"]&&sla["step"+step+"Past"]?"broken":void 0}function openJobDescription(notDefault){$scope.selectedApplication=void 0,$scope.selectedTestAnswers=void 0,$scope.ui.selectedStep=void 0,$scope.ui.description=!0,notDefault?$scope.job.HACKER_RANK&&$scope.job.flowType.indexOf("HACKERRANK")>=0?(vm.getTest($scope.job.HACKER_RANK),vm.setActiveBlock("HackerRankTest")):$scope.job.ASSIGNMENT&&$scope.job.flowType.indexOf("ASSIGNMENT")>=0?(vm.getTest($scope.job.ASSIGNMENT),vm.setActiveBlock("HackerRankTest")):(vm.getTest($scope.job.FIVEQ),vm.setActiveBlock("FiveQTest")):vm.setActiveBlock("JD"),vm.displayPanel(!0)}function openStep(title,previewToHiringManager,noSelectedTest){switch($scope.selectedApplication=void 0,$scope.selectedTestAnswers=void 0,$scope.ui.selectedDateIsOpen=!1,vm.setActiveBlock(title),$location.search("display",null),vm.displayPanel(!0),$rootScope.scrollToTop(),title){case"CandidatesPerDay":$scope.selectedTest=null,$scope.ui.selectedStep="Statistics",vm.setChartObjectForApplicants();break;case"TotalApplicants":$scope.selectedTest=null,$scope.ui.selectedStep="Statistics",vm.setChartObjectForApplicants();break;case"Resume":$scope.chartProgressCircleArrow=null,noSelectedTest&&($scope.selectedTest=null),$scope.selectedTest?"HACKER_RANK"===$scope.selectedTest.test.type?($scope.ui.selectedStep="First Screening",vm.setActiveBlock("HackerRankApplicants")):$scope.job.flowType&&$scope.job.flowType.indexOf("FIVEQ")===-1?($scope.ui.selectedStep="Project Evaluation",vm.setActiveBlock("Trial5QApplicants")):($scope.ui.selectedStep="Written Evaluation",vm.setChartProgressCircleArrow(5,$scope.job.calibratedPassersCount,"passers reviewed"),vm.setActiveBlock("Trial5QApplicants")):($scope.ui.selectedStep="Resume",vm.setChartProgressCircleArrow(10,$scope.job.calibratedResumeCount,"resumes reviewed")),$scope.ui.page=1;var preview=previewToHiringManager;void 0===preview&&(preview=!0),vm.getApplications(preview).then(function(res){var apps=res.content||[];_.isEmpty(apps)&&void 0===previewToHiringManager&&vm.openStep("Resume",!1)});break;case"HackerRank":$scope.ui.selectedStep="First Screening",$scope.selectedTest=vm.getRequiredTest("HACKER_RANK"),vm.setChartObjectForTest();break;case"Trial5Q":$scope.job.flowType&&$scope.job.flowType.indexOf("FIVEQ")===-1?($scope.ui.selectedStep="Project Evaluation",$scope.selectedTest=vm.getRequiredTest("ASSIGNMENT")):($scope.ui.selectedStep="Written Evaluation",$scope.selectedTest=vm.getRequiredTest("FIVEQ")),vm.setChartObjectForTest()}}function setChartObjectForTestCustomTooltip(score,applicants){return'<div class="test-custom-tooltip"><div class="t-row score"><p>SCORE</p><p>'+score+'%</p></div><div class="t-row applicants"><p><span aria-hidden="true" class="glyphicon glyphicon-user"></span>Applicants</p><p>'+applicants+"</p></div></div>"}function getChartTemplate(date){for(var rows=[],i=0;i<moment(date).daysInMonth();++i)rows.push({c:[{v:moment(date).startOf("month").add(i,"d")._d}]});return rows}function getLastIndex(rows){var lastIndex=_.findIndex(rows,function(row){return row.c[0].v});return rows[lastIndex-1]?lastIndex-1:lastIndex+1}function offset(){var local=6e4*moment().utcOffset();return local>0?-local:local}function momentTimeOffset(time){return moment(time).add(offset,"ms")}function close(){$scope.job=void 0}var testsSet=["RESUME_KEYWORD","RESUME_RUBRIC","HACKER_RANK","ASSIGNMENT","FIVEQ"],eventTemplates=[{type:"descriptionApprovedOn",title:"JD Approved"},{type:"testApprovedOn",title:"Testing Approved"},{type:"activatedOn",title:"Role Launched"}],RED="#f65d5d",BLACK="#000",vm=this,now=TimeUtils.convertToUtc(new Date);vm.openJobDescription=openJobDescription,vm.openStep=openStep,vm.close=close,vm.todoTemplate={1:"Approve JD",3:"Approve Testing",4:"Review Resumes",5:"Review Passers",6:"Setup Interviews",7:"Decide",8:"Setup More Interviews<br/><small>(if needed)</small>",9:"Decide"},vm.todoCallbacks={1:openJobDescription,3:openJobDescription.bind(this,!0),4:openStep.bind(this,"Resume",!0,!0),5:openStep.bind(this,"Trial5Q"),6:close,7:open.bind($window,clientUrl+"/manager/candidates","_blank"),8:close,9:open.bind($window,clientUrl+"/manager/candidates","_blank")},vm.dateOptions={formatYear:"yyyy",startingDay:1,showWeeks:!1,showButtonBar:!1,minMode:"month",formatMonth:"MMM",maxDate:new Date},vm.openCal=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.ui.selectedDateIsOpen=!$scope.ui.selectedDateIsOpen},vm.init=function(){vm.isNaN=isNaN,vm.editorMenu=[["bold","italic","underline","strikethrough","subscript","superscript"],["format-block"],["font-size"],["font-color","hilite-color"],["remove-format"],["ordered-list","unordered-list","outdent","indent"],["left-justify","center-justify","right-justify"],["code","quote","paragraph"],["link","image"]],$scope.ui={page:1,pageSize:9,activateDefaultTabInner:0,selectedStep:"",activeBlock:{JD:!1,HackerRankTest:!1,AssignmentTest:!1,FiveQTest:!1,Statistics:!1,CandidatesPerDay:!1,TotalApplicants:!1,Applicants:!1,Resume:!1,HackerRank:!1,HackerRankApplicants:!1,Trial5Q:!1,Trial5QApplicants:!1,Final:!1},blockStates:{JD:null,Tests:null,Statistics:null,CandidatesPerDay:null,TotalApplicants:null,Resume:null,HackerRank:null,Trial5Q:null,Final:null},displayApplicantsTabs:!0},$scope.ui.calendarConfig={header:{left:"title",center:"",right:""},weekMode:"variable"},$scope.eventSource=[],$scope.graphCalendar={today:new Date,dailyGraphDate:new Date,cummulativeGraphDate:new Date},$scope.message={text:"",show:!1},vm.initCalendar();var title='<span style="color: #00b0ff;">'+("GENERIC"===$scope.job.type?" High Flow Role":" Custom Role")+"</span>";$scope.subtitle=$scope.job.title+title,$rootScope.setSubtitle($scope.subtitle),loadJob()},vm.setStateForTest=function(test,blockType){$scope.job[test]&&"HACKER_RANK"===test?$scope.job[test].takenRatio<.5?$scope.ui.blockStates[blockType]="broken":$scope.job[test].takenRatio>=.5&&$scope.job[test].takenRatio<.75?$scope.ui.blockStates[blockType]="insufficient":$scope.job[test].takenRatio>=.75&&($scope.ui.blockStates[blockType]="finished"):!$scope.job[test]||"FIVEQ"!==test&&"ASSIGNMENT"!==test?$scope.ui.blockStates[blockType]="broken":$scope.job[test].takenRatio<.25?$scope.ui.blockStates[blockType]="broken":$scope.job[test].takenRatio>=.25&&($scope.ui.blockStates[blockType]="finished")},$scope.$on("$locationChangeStart",function(){$scope.subtitle&&$rootScope.setSubtitle($scope.subtitle)}),vm.setMessage=function(text,show){$scope.message.text=text,$scope.message.show=show},vm.initCalendar=function(){var event,calibration=$scope.job.calibration,events=[];if(calibration){eventTemplates.forEach(function(tpl){calibration[tpl.type]&&events.push({title:tpl.title,start:new Date(calibration[tpl.type]),type:tpl.type})}),(calibration.items||[]).forEach(function(item){item.targetDate&&events.push({title:item.name+" Target",start:moment(item.targetDate).add(1,"s")._d}),item.actualDate&&(event={title:item.name+" Actual",start:moment(item.actualDate).add(2,"s")._d},item.targetDate<item.actualDate&&(event.textColor=RED),events.push(event))}),$scope.ui.calendarConfig.eventRender=function(event,element){var tplExists=_.find(eventTemplates,function(tpl){return tpl.type===event.type});tplExists&&(element.css("font-weight","500"),element.css("color",BLACK))};var months={};events.forEach(function(e){months[e.start.getMonth()]=""}),Object.keys(months).length>1&&($scope.ui.calendarConfig.header.right="prev,next"),$scope.eventSource.push(events)}},vm.setActiveBlock=function(block){for(var prop in $scope.ui.activeBlock)prop===block?$scope.ui.activeBlock[prop]=!0:$scope.ui.activeBlock[prop]=!1,["CandidatesPerDay","TotalApplicants","HackerRank","Trial5Q"].indexOf(block)>-1?($scope.ui.activeBlock.Statistics=!0,$scope.ui.activeBlock.Applicants=!1):["Resume","HackerRankApplicants","Trial5QApplicants"].indexOf(block)>-1?($scope.ui.activeBlock.Statistics=!1,$scope.ui.activeBlock.Applicants=!0):($scope.ui.activeBlock.Statistics=!1,$scope.ui.activeBlock.Applicants=!1);"HACKERRANK"===$scope.job.flowType&&($scope.ui.activeBlock.HackerRank||$scope.ui.activeBlock.HackerRankApplicants)||"HACKERRANK_ASSIGNMENT"===$scope.job.flowType&&($scope.ui.activeBlock.Trial5Q||$scope.ui.activeBlock.Trial5QApplicants)?$scope.ui.displayApplicantsTabs=!1:$scope.ui.displayApplicantsTabs=!0},vm.getRequiredTest=function(testType){for(var jobTest=null,length=$scope.job.tests?$scope.job.tests.length:0,i=0;i<length;i++)if($scope.job.tests[i].test.type===testType){jobTest=$scope.job.tests[i];break}return jobTest},vm.setChartProgressCircleArrow=function(maxValue,value,title){$scope.job.jobSla&&($scope.chartProgressCircleArrow={maxValue:maxValue,value:value,title:title})},vm.updateCurrentCalibrationChart=function(){$scope.chartProgressCircleArrow&&angular.isDefined($scope.chartProgressCircleArrow.value)&&($scope.chartProgressCircleArrow.title.indexOf("resumes")!==-1?$scope.chartProgressCircleArrow.value=$scope.job.calibratedResumeCount:$scope.chartProgressCircleArrow.title.indexOf("passers")!==-1&&($scope.chartProgressCircleArrow.value=$scope.job.calibratedPassersCount))},vm.getApplications=function(previewToHiringManager){$scope.ui.previewToHiringManager=previewToHiringManager,$scope.ui.activateDefaultTabInner=previewToHiringManager?0:1;var params={page:$scope.ui.page-1,avatarType:"MANAGER",orderBy:$scope.ui.orderBy||null,sortDir:$scope.ui.sortDir||null},filter={jobId:$scope.job.id};return $scope.selectedTest&&(filter.testId=$scope.selectedTest.test.id),"Written Evaluation"===$scope.ui.selectedStep&&previewToHiringManager?filter.previewTestPassers=!0:filter.previewToHM=previewToHiringManager||null,vm.loading=JobApplicationService.list(params,filter),vm.loading.$promise.then(function(res){$scope.applications=res.content||[],_.each($scope.applications,function(app){_.each(app.testScores,function(ts){ts.percentile=Math.round(ts.percentile)})}),$scope.ui.total=res.totalElements,$scope.ui.first=res.first,$scope.ui.last=res.last,$rootScope.scrollToTop()}),vm.loading.$promise},vm.changeSortOrder=function(orderBy){$scope.ui.orderBy!==orderBy?($scope.ui.orderBy=orderBy,$scope.ui.sortDir="ASC"):$scope.ui.sortDir="ASC"===$scope.ui.sortDir?"DESC":"ASC";var preview=0===$scope.ui.activateDefaultTabInner;vm.getApplications(preview)},vm.setChartObjectForTest=function(){$scope.chartObjectForTest={},vm.loading=JobApplicationService.getScores({jobId:$scope.job.id,testId:$scope.selectedTest?$scope.selectedTest.test.id:null}),vm.loading.$promise.then(function(res){var row,rows=[];(res||[]).forEach(function(item){Math.round(item.percentage)>2&&(row={c:[{v:Math.round(item.percentage)},{v:item.numberOfCandidates},{v:setChartObjectForTestCustomTooltip(Math.round(item.percentage),item.numberOfCandidates)}]},rows.push(row))});var chart=vm.createChartObject("LineChart","","",rows,!1);chart.options.hAxis.viewWindow={min:0,max:100},chart.options.hAxis.format="#'%'",chart.options.hAxis.baselineColor="#e8e8e8",chart.options.vAxis.baselineColor="#e8e8e8",chart.options.hAxis.gridlines={color:"#e8e8e8",count:4},chart.options.vAxis.gridlines=chart.options.hAxis.gridlines,chart.options.chartArea={left:10,top:10,width:"90%",height:350},chart.options.tooltip={
isHtml:!0},$scope.chartObjectForTest=chart,vm.setMessage("",!1)},function(err){$scope.chartObjectForTest=null,vm.setMessage(err.data.text,!0)})},vm.setChartObjectForApplicants=function(){$scope.ui.activeBlock.Statistics===!1&&vm.setActiveBlock("CandidatesPerDay"),$scope.chartObjectForApplicants={},vm.getDailyGraphData(),vm.getCummulativeGraphData()},vm.getDailyGraphData=function(){var selectedDate=$scope.graphCalendar.dailyGraphDate;vm.loadingGraph1=JobApplicationService.getApplicantsPerDay({jobId:$scope.job.id,type:"DAILY",endDate:$filter("date")(selectedDate,"yyyy-M-d")}),vm.loadingGraph1.$promise.then(function(res){var rows=getChartTemplate(selectedDate);(res||[]).forEach(function(item){var i=momentTimeOffset(item.date).date()-1;angular.isDefined(rows[i])&&rows[i].c.push({v:item.numberOfCandidates})}),1===res.length&&rows[getLastIndex(rows)].c.push({v:0});var chart=vm.createChartObject("ColumnChart","Date","Number of Applicants",rows,!1);chart.options.vAxis.viewWindow={min:0},$scope.chartObjectForApplicants.daily=chart,vm.setMessage("",!1)},function(err){$scope.chartObjectForApplicants.daily=null,vm.setMessage(err.data.text,!0)})},vm.getCummulativeGraphData=function(){vm.loadingGraph2=JobApplicationService.getApplicantsPerDay({jobId:$scope.job.id,type:"CUMMULATIVE",endDate:$filter("date")($scope.graphCalendar.cummulativeGraphDate,"yyyy-M-d")}),vm.loadingGraph2.$promise.then(function(res){var row,rows=getChartTemplate($scope.graphCalendar.cummulativeGraphDate),demand=100*$scope.job.demand,lastValue=0;if((res||[]).forEach(function(item){var i=momentTimeOffset(item.date).date()-1;row={c:[{v:moment(item.date).toDate()},{v:item.numberOfCandidates},{v:demand}]},rows[i]=row,lastValue=item.numberOfCandidates}),1===res.length){var lastIndex=getLastIndex(rows);rows[lastIndex].c.push({v:lastValue}),rows[lastIndex].c.push({v:demand})}$scope.chartObjectForApplicants.cummulative=vm.createChartObject("LineChart","Date","Number of Applicants",rows,!0),vm.setMessage("",!1)},function(err){$scope.chartObjectForApplicants.cummulative=null,vm.setMessage(err.data.text,!0)})},vm.createChartObject=function(chartType,xAxisTitle,yAxisTitle,rows,limit){var chartObject={type:chartType,data:{cols:[{id:xAxisTitle.replace(" ","").toLowerCase(),label:xAxisTitle,type:"Date"===xAxisTitle?"date":"number"},{id:yAxisTitle.replace(" ","").toLowerCase(),label:yAxisTitle,type:"number"}],rows:rows},options:{colors:["#1eb9ff","#ff0000"],legend:{position:"none"},vAxis:{title:yAxisTitle},hAxis:{title:xAxisTitle},width:"100%",height:400,chartArea:{width:"85%",height:300,top:"10%"}}};return"Date"===xAxisTitle?(chartObject.options.hAxis.gridlines={count:30},chartObject.options.hAxis.format="dd",chartObject.options.series={1:{lineDashStyle:[4,4]}}):chartObject.data.cols.push({role:"tooltip",type:"string",p:{html:!0}}),limit&&chartObject.data.cols.push({id:"demand",label:"100XDemand",type:"number"}),chartObject},vm.init(),vm.approveModal=function(){vm.modal=$uibModal.open({templateUrl:"approve-description.tpl.html",scope:$scope,backdrop:"static",windowClass:"jobs funnel"})},vm.submitApproval=function(){vm.modal.dismiss(),vm.loading=JobService.crud.update({id:$scope.job.id},$scope.job),vm.loading.$promise.then(function(res){$scope.job.candidateDescription=res.candidateDescription,$scope.ui.blockStates.JD="finished",vm.loading=JobService.crud.requestApprovalHM({id:$scope.job.id,type:"description"},"",function(res){$scope.job.calibration=res.calibration,res.jobSla&&(fillSla(res.jobSla),$scope.job.jobSla=res.jobSla)})})},vm.approveTests=function(){function approve(){vm.loading=JobService.crud.requestApprovalHM({id:$scope.job.id,type:"test"},"",function(res){$scope.job.calibration=res.calibration,res.jobSla&&(fillSla(res.jobSla),$scope.job.jobSla=res.jobSla)})}$scope.job.flowType.indexOf("FIVEQ")>-1&&$scope.job.FIVEQ?vm.loading=TestsService.update5QTest({id:$scope.job.FIVEQ.test.id},$scope.job.FIVEQ.test,function(res){$scope.job.FIVEQ.test=res,approve()}):approve()},vm.getTest=function(jobTest){jobTest&&jobTest.test.testDetails||(vm.loading=TestsService.get({id:jobTest.test.id}),vm.loading.$promise.then(function(test){jobTest.test=test}))},vm.openResume=function(app){$scope.selectedApplication=app},vm.switchApplication=function(dir){var i,deferred=$q.defer(),curr=$scope.selectedApplication;return _.each($scope.applications,function(a,index){a.id===curr.id&&(i=index)}),$scope.applications[i+dir]?($scope.selectedApplication=$scope.applications[i+dir],deferred.resolve()):i===$scope.applications.length-1&&$scope.ui.last===!1?($scope.ui.page++,vm.getApplications().then(function(){$scope.selectedApplication=_.first($scope.applications),deferred.resolve()})):0===i&&$scope.ui.first===!1?($scope.ui.page--,vm.getApplications().then(function(){$scope.selectedApplication=_.last($scope.applications),deferred.resolve()})):deferred.resolve(),deferred.promise},vm.displayPanel=function(display){vm.showPanel=display},vm.closeList=function(){$scope.applications=null,$scope.ui.selectedStep=void 0,vm.displayPanel(!1),$location.search("display",null),loadJob()},vm.closeResume=function(){$scope.selectedApplication=void 0,$scope.selectedTestAnswers=void 0,$scope.job.jobSla&&loadJob()},vm.changeDate=function(d,type){var dt=null;$scope.ui.selectedDateIsOpen=!1,dt="DAILY"===type?new Date($scope.graphCalendar.dailyGraphDate):new Date($scope.graphCalendar.cummulativeGraphDate);var month=dt.getMonth()+d;dt.setMonth(month),"DAILY"===type?($scope.graphCalendar.dailyGraphDate=dt,vm.getDailyGraphData()):($scope.graphCalendar.cummulativeGraphDate=dt,vm.getCummulativeGraphData())},vm.trustAsHtml=function(t){return $sce.trustAsHtml(t)},$scope.isAllowedTestType=function(testType){return testsSet.indexOf(testType)>-1},$scope.dropOffCount=function(){var attempted=$scope.selectedTest.numberOfAcceptedCandidates+$scope.selectedTest.numberOfRejectedCandidates,invited=$scope.selectedTest.numberOfCandidates;return invited-attempted},CurrentUser.get(function(u){vm.cu=u,vm.cu.managerAvatar=_.find(u.userAvatars,function(a){return"MANAGER"===a.type})});var display=$location.search().display;"description"===display&&vm.openJobDescription(),"test"===display&&vm.openJobDescription(!0),$scope.$watch("selectedApplication",function(value){value&&$scope.job.jobSla&&(value.job.jobSla=$scope.job.jobSla)})}]),bandcampApp.directive("slaCalendar",["routePrefix","$timeout","TimeUtils",function(routePrefix,$timeout,TimeUtils){var tplUrl=(routePrefix||"")+"job/funnel-view/sla-calendar.tpl.html";return{restrict:"E",templateUrl:tplUrl,scope:{job:"="},controllerAs:"vm",controller:function($scope){function init(){var tl=job.jobSla.timeline,now=TimeUtils.convertToUtc(new Date),events=[];_.each(tl,function(d,i){events.push({title:"day "+(i+1),start:d.date}),d.title&&d.schedule&&events.push({title:d.title,start:d.date,schedule:d.schedule,actual:d.actual})}),$scope.minDate=_.first(events).start,$scope.maxDate=_.last(events).start,vm.config={header:{left:"",center:"",right:""},weekMode:"variable",eventRender:function(event,element){if(event.title.indexOf("day")>-1)element.addClass("day-number");else{element.addClass("sla-title"),element.css("background","#c2c2c2"),element.find(".fc-event-title").html(event.title),!event.actual&&now.getTime()>event.schedule.getTime()?(element.css("background","#f44336"),element.find(".fc-event-title").html('<i class="fa fa-close"></i>'+event.title)):event.actual.getTime()>event.schedule.getTime()?(element.css("background","#f44336"),element.find(".fc-event-title").html('<i class="fa fa-check"></i>'+event.title)):(element.css("background","#32b268"),element.find(".fc-event-title").html('<i class="fa fa-check"></i>'+event.title));var width=element.width()+10;element.css("width",width+"px")}event.start.getMonth()!==$scope.dt.getMonth()&&element.css("opacity","0.5")},viewRender:function(view){view.calendar.removeEvents(),view.calendar.addEventSource(events)},disableResizing:!0}}var vm=this,job=$scope.job;vm.init=init,vm.events=[],$scope.format="MMMM, yyyy",$scope.dt=new Date,$scope.$watch("dt",function(d){d&&$scope.updateCalendarDate(d)})},link:function(s,e,a,c){var cal=$($(".calendar")[0]);c.init(),$timeout(function(){cal.fullCalendar("render")}),s.updateCalendarDate=function(date){cal.fullCalendar("gotoDate",date)}}}}]),ctrls.controller("JobMarketplaceMembersCtrl",["$scope","JobService","CurrentUser","$location","$routeParams","ProfileUtils","ManagerService","$uibModal","TimeUtils","ManagerNotesService","MarketplaceMembersService","$rootScope","highlight","InterviewsService","$q",function($scope,JobService,CurrentUser,$location,$routeParams,ProfileUtils,ManagerService,$uibModal,TimeUtils,ManagerNotesService,MarketplaceMembersService,$rootScope,highlight,InterviewsService,$q){function getQuery(){var q=$location.search().query;return angular.isDefined(q)?q:""}function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function getManagerEmail(obj){try{return obj.manager.email}catch(e){return""}}function markNewMemebres(list){var momentNow=moment(new Date),weekAgo=momentNow-6048e5;list.forEach(function(m){var createdMoment=moment(m.marketplaceMember.createdOn);m.marketplaceMember.isNew=createdMoment>weekAgo})}function checkAssignmentsAndInterviews(list){var currentAssignmentStatusList="PENDING|CANDIDATE_ACCEPTED|MANAGER_SETUP|ACTIVE|PAUSED",currentInterviewSelectionStatusList="IN_PROGRESS|OFFERED|REINTERVIEW",cu=$scope.data.currentUser;list.forEach(function(x){if(x.assignments&&x.assignments.length>0)for(var i=0;i<x.assignments.length;++i){var a=x.assignments[i];if(currentAssignmentStatusList.indexOf(a.status)>=0&&getManagerEmail(a)===cu.email){x.currentAssignment=a;break}}if(x.interviews&&x.interviews.length>0)for(var j=0;j<x.interviews.length;++j){var intv=x.interviews[j];if(currentInterviewSelectionStatusList.indexOf(intv.selection.status)>=0&&getManagerEmail(intv)===cu.email){x.currentInterview=intv;break}}})}function processMarketplaceMembers(data,job){var q=$scope.data.query;if(!job){var grouped=[];$scope.data.matched.forEach(function(m){var job=m.marketplaceMember.application.job,exists=_.find(grouped,function(g){return g.job.id===job.id});exists?exists.matched.push(m):grouped.push({job:angular.copy(job),matched:[m]})}),$scope.data.grouped=grouped}q&&q.length>0&&(0===$scope.data.matched.length?$scope.ui.noResults=!0:$scope.data.matched.forEach(function(mm){mm=highlight(mm,q)})),$scope.avatarPromise.then(function(mgr){_.isEmpty(data.content)&&job&&"CUSTOM"===job.type&&job.flowType&&_.isEmpty($scope.data.query)&&job.primaryManager.id===mgr.id&&($scope.data.funnelJob=job)}),$scope.ui.pagination.current=data.number+1,$scope.ui.pagination.total=data.totalPages,$scope.ui.pagination.totalElements=data.totalElements,$scope.avatarPromise.then(function(){checkAssignmentsAndInterviews($scope.data.matched),checkMatchedWithSaved($scope.data.matched),markNewMemebres($scope.data.matched)})}function fetchJob(){$scope.jobPromise=JobService.crud.getAuthenticated({id:$routeParams.id,avatarType:"MANAGER"},function(data){setJob(data)},function(err){showMessage("alert-danger",err.data.text)}).$promise}function checkMatchedWithSaved(list){$scope.ui.isLoading=!0;var cu=$scope.data.currentUser;list.forEach(function(x){var saved=cu.savedCandidates||[];x.marketplaceMember.isSaved=saved.reduce(function(ret,sc){return ret||sc.id===x.marketplaceMember.id},!1);var candidate=x.marketplaceMember.application.candidate;candidate.realPhotoUrl=ProfileUtils.profilePhotoUrl(candidate)}),$scope.ui.isLoading=!1}function setJob(job){var j=angular.copy(job);j.plural=_.pluralize(j.title);var id=angular.isNumber,app=id(job.numberOfApplicants)?job.numberOfApplicants:0,getCount=function(type){var t=_.find(job.tests,function(t){return t.test.type===type});return t?t.numberOfAcceptedCandidates:0},test1=getCount("HACKER_RANK"),test2=getCount("ASSIGNMENT");j.numberOfTest1Success=test1;var process=function(number){var n=Math.round(100*number);return n<1?"1%":n+"%"};j.test1result=process(test1/app),j.test2result=process(test2/app),delete j.skills,$scope.data.job=j;var rate="";job.salary&&job.salary>0&&(rate=" - $"+job.salary+"/",rate+="WEEKLY"===job.salaryType?"hr":"month");var display=$location.search().display;if(display)return $scope.data.funnelJob=$scope.data.job,0;var title=job.title+rate+'&nbsp;&nbsp;<span class="url" ng-click="displayJobDescriptionModal()">  Job Description</span>';$rootScope.setSubtitle(title,$scope)}$scope.data={jobId:$routeParams.id,teamId:$routeParams.teamId,job:null,currentUser:null},$scope.ui={isLoading:!0,pagination:{current:1,total:0,totalElements:0}},$scope.data.query=getQuery(),$scope.$on("$routeUpdate",function(){$scope.data.query=getQuery(),$scope.changePage()}),$scope.search=function(){_.isEmpty($scope.data.query)&&void 0===$routeParams.id&&$location.path("/dashboard"),$location.search("query",$scope.data.query)},$scope.getLocalTime=function(candidate){var offset=candidate.location.timeZone.offset;return TimeUtils.getTimeByTimezoneOffset(offset)},$scope.displayJobDescriptionModal=function(){$uibModal.open({templateUrl:"job-candidates-job-description.tpl.html",controller:"JobDescriptionCtrl",size:"lg",resolve:{job:function(){return $scope.data.job}}})},$scope.displayJobMoreInfo=function(text){text&&0!==text.length&&$uibModal.open({templateUrl:"job-more-info.tpl.html",controller:"JobMoreInformationCtrl",size:"lg",resolve:{title:function(){return $scope.data.job.title},text:function(){return text}}})},$scope.interview=function(marketplaceMember){InterviewsService.checkAvailable(marketplaceMember.application.candidate)?$location.path("/interview/schedule/"+marketplaceMember.id):availabilityModal(marketplaceMember,"INTERVIEW")},$scope.hire=MarketplaceMembersService.hire;var availabilityModal=MarketplaceMembersService.availabilityModal;$scope.viewProfile=function(marketplaceMember){$rootScope.previousLocation=$location.url(),$location.path("/profile/user-profile/"+marketplaceMember.id)},$scope.toggleSavedStatus=function(matchedMarketplaceMember){CurrentUser.getAvatar({avatarType:"MANAGER"},function(res){$scope.data.currentUser=res;var mm=matchedMarketplaceMember.marketplaceMember,cu=$scope.data.currentUser;if(mm.isSaved){for(var idx=0,i=0;i<cu.savedCandidates.length;++i)if(cu.savedCandidates[i].id===mm.id){idx=i;break}cu.savedCandidates.splice(idx,1)}else cu.savedCandidates=cu.savedCandidates||[],cu.savedCandidates.push(mm);$scope.ui.isLoading=!0,cu.type="MANAGER",ManagerService.update({id:cu.id},cu).$promise.then(function(res){$scope.data.currentUser=res,CurrentUser.clearCache(),mm.isSaved=!mm.isSaved})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}),CurrentUser.clearCache()},$scope.reject=function(matchedMarketplaceMember){var modalInstance=$uibModal.open({templateUrl:"job-candidates-reject-confirm.tpl.html",controller:"JobCandidatesRejectConfirmCtrl",backdrop:"static"});modalInstance.result.then(function(){CurrentUser.getAvatar({avatarType:"MANAGER"},function(res){$scope.data.currentUser=res;var mm=matchedMarketplaceMember.marketplaceMember,cu=$scope.data.currentUser;if(mm.isSaved){for(var idx=0,i=0;i<cu.savedCandidates.length;++i)if(cu.savedCandidates[i].id===mm.id){idx=i;break}cu.savedCandidates.splice(idx,1)}cu.type="MANAGER",cu.rejectedCandidates=cu.rejectedCandidates||[],cu.rejectedCandidates.push(mm),$scope.ui.isLoading=!0,ManagerService.update({id:cu.id},cu).$promise.then(function(res){CurrentUser.clearCache(),$scope.data.currentUser=res;var idx=$scope.data.matched.indexOf(matchedMarketplaceMember);$scope.data.matched.splice(idx,1)})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}),CurrentUser.clearCache()})},$scope.isPipelineAvailable=function(){return $scope.data.job&&$scope.data.currentUser&&"CUSTOM"===$scope.data.job.type&&(!$scope.data.job.jobSla||$scope.data.job.jobSla&&$scope.data.job.primaryManager.id===$scope.data.currentUser.id)},$scope.changePage=function(){$scope.ui.noResults=!1,$scope.ui.isLoading=!0;var req={jobId:$routeParams.id,query:$scope.data.query,page:$scope.ui.pagination.current-1},promise=MarketplaceMembersService.simpleMatches(req).$promise;return promise.then(function(data){$scope.data.matched=data.content||[],$scope.jobPromise?$scope.jobPromise.then(function(job){processMarketplaceMembers(data,job)}):processMarketplaceMembers(data)})["catch"](function(err){showMessage("alert-danger",err.data.text),$scope.ui.isLoading=!1}),promise},$scope.editCandidateNotes=function(marketplaceMember){$scope.ui.isLoading=!0,ManagerNotesService.query({id:marketplaceMember.id},function(res){$uibModal.open({templateUrl:"candidate-notes.tpl.html",controller:"CandidateNotesCtrl",backdrop:"static",resolve:{marketplaceMember:function(){return marketplaceMember},manager:function(){return $scope.data.currentUser},notes:function(){return res}}})}).$promise["finally"](function(){$scope.ui.isLoading=!1})},$scope.subscribe=function(toSubscribe){$scope.ui.isLoading=!0;var f=toSubscribe?JobService.crud.subscribe:JobService.crud.unsubscribe;f({id:$routeParams.id},function(){$scope.data.subscribed=toSubscribe}).$promise["finally"](function(){$scope.ui.isLoading=!1})},void 0!==$routeParams.id?fetchJob():_.isEmpty($scope.data.query)&&$location.path("/dashboard"),$scope.avatarPromise=CurrentUser.getAvatar({avatarType:"MANAGER"},function(res){CurrentUser.clearCache(),$scope.data.currentUser=res,$scope.data.subscribed=_.find(res.subscriptionJobs,function(j){return j.id===parseInt($routeParams.id,10)})}).$promise,$scope.changePage(),$scope.mpmApplicationView={open:function(m){$scope.selectedMarketplaceMember=m},close:function(){$scope.selectedMarketplaceMember=void 0},switchMpm:function(dir){var i,deferred=$q.defer(),curr=$scope.selectedMarketplaceMember;return _.each($scope.data.matched,function(mpm,index){mpm.marketplaceMember.id===curr.id&&(i=index)}),$scope.data.matched[i+dir]?($scope.selectedMarketplaceMember=$scope.data.matched[i+dir].marketplaceMember,deferred.resolve()):i===$scope.data.matched.length-1&&$scope.ui.pagination.current!==$scope.ui.pagination.total?($scope.ui.pagination.current++,$scope.changePage().then(function(){$scope.selectedMarketplaceMember=_.first($scope.data.matched).marketplaceMember,deferred.resolve()})):0===i&&1!==$scope.ui.pagination.current&&dir===-1?($scope.ui.pagination.current--,$scope.changePage().then(function(){$scope.selectedMarketplaceMember=_.last($scope.data.matched).marketplaceMember,deferred.resolve()})):deferred.resolve(),deferred.promise},reject:function(){var idx=_.findIndex($scope.data.matched,function(mc){return mc.marketplaceMember.id===$scope.selectedMarketplaceMember.id});$scope.data.matched.splice(idx,1)}}}]),ctrls.controller("CandidateNotesCtrl",["$scope","$uibModalInstance","ManagerNotesService","marketplaceMember","manager","notes",function($scope,$uibModalInstance,ManagerNotesService,marketplaceMember,manager,notes){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function groupNotes(notes){var grouped=_.groupBy(_.sortBy(notes,"createdOn"),function(n){return moment(n.createdOn).startOf("day")._d.getTime()});_.isEmpty(grouped)||($scope.data.sharedNotes=grouped)}function addNote(note){note.sender=manager,note.sender.id=$scope.currentManager.id,note.createdOn=new Date,notes.push(note),groupNotes(notes)}function saveNote(noteType){var noteToSave=angular.copy($scope.data.note);noteToSave.type=noteType,ManagerNotesService.save({id:marketplaceMember.id},noteToSave).$promise["catch"](function(err){showMessage("alert-danger",err.data.text)})}$scope.data={marketplaceMember:marketplaceMember,candidate:marketplaceMember.application.candidate,note:{}},$scope.ui={isLoading:!1},$scope.currentManager=_.find(manager.userAvatars,function(a){return"MANAGER"===a.type}),groupNotes(notes),$scope.submit=function(noteForm){var txt=$scope.data.note.content;angular.isDefined(txt)&&(saveNote("MP_HM"),$scope.data.note.shared&&saveNote("AM_HM"),addNote(angular.copy($scope.data.note)),$scope.data.note={},noteForm.$submitted=!1)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("JobDescriptionCtrl",["$scope","$uibModalInstance","job",function($scope,$uibModalInstance,job){$scope.data={job:job},$scope.close=function(){$uibModalInstance.dismiss("close")}}]),ctrls.controller("JobMoreInformationCtrl",["$scope","$uibModalInstance","title","text",function($scope,$uibModalInstance,title,text){$scope.data={title:title,text:text},$scope.close=function(){$uibModalInstance.dismiss("close")}}]),ctrls.controller("JobCandidatesRejectConfirmCtrl",["$scope","$uibModalInstance",function($scope,$uibModalInstance){$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("JobPostingCtrl",["$scope","JobService","$location",function($scope,JobService,$location){$scope.customJobs=[],$scope.genericJobs=[],$scope.message=!1,$scope.UI={loading:!0},JobService.crud.query({avatarType:"MANAGER"},function(data){$scope.UI.loading=!1,$scope.genericJobs=_.filter(data,function(job){return"GENERIC"===job.type}),$scope.customJobs=_.filter(data,function(job){return"CUSTOM"===job.type})},function(e){$scope.UI.loading=!1,$scope.message=e.data.text}),$scope.removeOverflowAllh=function(){angular.element("body").removeClass("overflowAllh")},$scope.search=function(){_.isEmpty($scope.query)||$location.path("/job/marketplace-members").search({query:$scope.query})}}]),ctrls.controller("JobSummaryCtrl",["$scope","JobService",function($scope,JobService){$scope.loading=JobService.crud.query({statistics:!0},function(res){$scope.jobs=res,$scope.hasCustom=null!==_.find(res,function(j){return"CUSTOM"===j.type})})}]),bandcampApp.directive("applicationView",["routePrefix",function(routePrefix){var tplUrl="job/application-view/application-view.tpl.html";return{restrict:"E",replace:!0,scope:{application:"=",next:"&",previous:"&",close:"&"},templateUrl:routePrefix?routePrefix+tplUrl:tplUrl,controllerAs:"vm",controller:function($scope,$sce,JobApplicationService,ManagerNotesService,DownloadService){var vm=this;vm.expand=function(index){$($(".answer")[index]).slideToggle(),$($(".collapse-switch")[index]).toggleClass("expand")},vm.closeView=function(){$scope.close()},vm["switch"]=function(f){vm.isLoading||(vm.isLoading=!0,f()["finally"](function(){vm.isLoading=!1}))},vm.loadResume=function(app){var fileId=app.resumeFile.id;JobApplicationService.getFileUrl(app.id,fileId).then(function(res){var url=JobApplicationService.getGoogleDocUrl(res.data);$("#resume-frame").attr("src",url)})},vm.resumeOnload=function(){vm.resumeReady=!0},vm.load5Qs=function(app){JobApplicationService.getWrittenEvaluationReview({id:app.id},function(res){app.FIVEQ=res})},vm.loadAssignment=function(app,file){JobApplicationService.getFileUrl(app.id,file.id).then(function(res){app.ASSIGNMENT=$sce.trustAsResourceUrl(res.data),DownloadService.downloadFile(res)})},vm.loadNotes=function(app){ManagerNotesService.query({id:app.id},function(res){var notes=_.groupBy(res,function(n){return moment(n.createdOn).startOf("day")._d.getTime()});_.isEmpty(notes)||($scope.application.notes=notes)})},vm.loadRating=function(app){JobApplicationService.getRating({id:app.id},function(res){app.rating=res})},vm.updateRating=function(app,rt){JobApplicationService.updateRating({id:app.id,rating:rt.rating})},vm.addNote=function(){if(!_.isEmpty(vm.note)){vm.isLoading=!0;var note={content:vm.note,type:"AM_HM"},promise=ManagerNotesService.save({id:$scope.application.id},note).$promise;promise.then(function(){vm.note=void 0,vm.loadNotes($scope.application)})["finally"](function(){vm.isLoading=!1})}},vm.print5Q=function(){var fiveQs=_.find($scope.application.files,function(f){return"5Qs"===f.label});fiveQs&&JobApplicationService.getFileUrl($scope.application.id,fiveQs.id).success(function(url){DownloadService.download5QFile(url).success(function(data){JobApplicationService.printDocument((new TextDecoder).decode(new DataView(data)))})})}},link:function(scope,element,attrs,vm){element.focus(),element.on("keyup",function(e){e.preventDefault(),37===e.keyCode?vm["switch"](scope.previous):39===e.keyCode&&vm["switch"](scope.next)}),scope.$watch("application",function(app){app&&(vm.resumeReady=!1,vm.loadResume(app),vm.loadNotes(app),vm.loadRating(app),_.each(app.files,function(f){"5Qs"===f.label?vm.load5Qs(app):"Assignment & Evaluation"===f.label&&vm.loadAssignment(app,f)}))}),scope.$watch("application.rating",function(r){r&&r.rating&&vm.updateRating(scope.application,r)},!0)}}}]),bandcampApp.directive("mpmApplicationView",["routePrefix","TechTrialApplicationService","$sce","$filter","CurrentUser","ManagerService","AssignmentService","InterviewsService","$location","$uibModal","SelectionService","$q",function(routePrefix,TechTrialApplicationService,$sce,$filter,CurrentUser,ManagerService,AssignmentService,InterviewsService,$location,$uibModal,SelectionService,$q){var tplUrl="job/mpm-application-view/mpm-application-view.tpl.html";return{restrict:"E",replace:!0,scope:{mpm:"=",next:"&",previous:"&",close:"&",reject:"&",showButtons:"=",container:"="},templateUrl:routePrefix?routePrefix+tplUrl:tplUrl,controllerAs:"vm",controller:function($scope,$sce,JobApplicationService,ManagerNotesService,DownloadService){var vm=this;vm.UI={leftSideTabs:"profile",showButtons:!angular.isDefined($scope.showButtons)||$scope.showButtons,applicationNotesCount:0},vm.data={};var container=$scope.container||"body";angular.element(container).addClass("overflowAllh");var loading={start:function(){vm.isLoading=!0},stop:function(){vm.isLoading=!1}};vm.expand=function(index){$($(".answer")[index]).slideToggle(),$($(".collapse-switch")[index]).toggleClass("expand")},vm.closeView=function(){$scope.close(),angular.element(container).removeClass("overflowAllh")},vm["switch"]=function(f){vm.isLoading||(vm.isLoading=!0,f()["finally"](function(){vm.isLoading=!1}))},vm.resumeOnload=function(){vm.resumeReady=!0},vm.load5Qs=function(app){vm.shouldLoad5Qs&&JobApplicationService.getWrittenEvaluationReview({id:app.id},function(res){app.FIVEQ=res})},vm.loadAssignment=function(app){vm.shouldLoadAssignment&&TechTrialApplicationService.getAssignmentDetails(app.id).success(function(assignmentDetails){app.ASSIGNMENT=assignmentDetails,app.ASSIGNMENT.assignmentData=$sce.trustAsHtml(app.ASSIGNMENT.assignmentData)})},vm.loadNotes=function(app){ManagerNotesService.query({id:app.id},function(res){vm.UI.applicationNotesCount=res.length||0;var notes=_.groupBy(res,function(n){return moment(n.createdOn).startOf("day")._d.getTime()});_.isEmpty(notes)||($scope.application.notes=notes)})},vm.addNote=function(){if(!_.isEmpty(vm.note)){vm.isLoading=!0;var note={content:vm.note,type:"AM_HM"},promise=ManagerNotesService.save({id:$scope.application.id},note).$promise;promise.then(function(){vm.note=void 0,vm.loadNotes($scope.application)})["finally"](function(){vm.isLoading=!1})}},vm.print5Q=function(){var fiveQs=_.find($scope.application.files,function(f){return"5Qs"===f.label});fiveQs&&JobApplicationService.getFileUrl($scope.application.id,fiveQs.id).success(function(url){DownloadService.download5QFile(url).success(function(data){JobApplicationService.printDocument((new TextDecoder).decode(new DataView(data)))})})},vm.checkMatchedWithSaved=function(mpm){loading.start();var saved=vm.data.myAvatar.savedCandidates||[];mpm.isSaved=saved.reduce(function(ret,sc){return ret||sc.id===mpm.id},!1),loading.stop()},vm.toggleSavedStatus=function(){vm.UI.saving=!0,CurrentUser.get(function(data){if(vm.data.cu=data,$scope.mpm.isSaved){for(var idx=0,i=0;i<vm.data.myAvatar.savedCandidates.length;++i)if(vm.data.myAvatar.savedCandidates[i].id===$scope.mpm.id){idx=i;break}vm.data.myAvatar.savedCandidates.splice(idx,1)}else{vm.data.myAvatar.savedCandidates=vm.data.myAvatar.savedCandidates||[];var mmCopy={id:$scope.mpm.id};vm.data.myAvatar.savedCandidates.push(mmCopy)}ManagerService.update({id:vm.data.myAvatar.id},vm.data.myAvatar).$promise.then(function(data){vm.data.cu=data,CurrentUser.clearCache(),$scope.mpm.isSaved=!$scope.mpm.isSaved})["finally"](function(){vm.UI.saving=!1})}),CurrentUser.clearCache()},vm.isRejectedCandidate=function(){var member=vm.data.myAvatar.rejectedCandidates.filter(function(c){return c.id===$scope.mpm.id}).pop();return member},vm.getInterviewBlockerMessage=function(){return $scope.mpm.currentAssignment?"This candidate already has an active or pending offer from you for this position.":$scope.mpm.currentInterview&&!$scope.mpm.currentAssignment?"This candidate already has an interview invitation from you for this position.":vm.isRejectedCandidate()?"This candidate is in your rejected candidates list.":$scope.mpm.alreadyHired&&!$scope.mpm.currentAssignment?"This candidate already accepted another job offer.":null},vm.getHiringBlockerMessage=function(){return $scope.mpm.currentAssignment?"This candidate already has an active or pending offer from you for this position.":$scope.mpm.currentAssignment||$scope.mpm.alreadyHired||!$scope.mpm.currentInterview?vm.isRejectedCandidate()?"This candidate is in your rejected candidates list.":$scope.mpm.alreadyHired&&!$scope.mpm.currentAssignment?"This candidate already accepted another job offer.":null:"You cannot hire this candidate as you are already in process of interviewing this candidate."},vm.getRejectBlockerMessage=function(){return $scope.mpm.currentAssignment?"This candidate already has an active or pending offer from you for this position.":$scope.mpm.currentInterview&&!$scope.mpm.currentAssignment?"This candidate already has an interview invitation from you for this position.":vm.isRejectedCandidate()&&!$scope.mpm.currentAssignment?"This candidate is already in your rejected list.":void 0},vm.checkIsInterviewStatus=function(pageIndex){InterviewsService.list({avatarType:"MANAGER",candidateId:$scope.mpm.application.candidate.id,page:pageIndex},function(res){var interviews=res.content;if(interviews&&interviews.length>0){for(var currentInterviewSelectionStatusList="IN_PROGRESS|OFFERED|REINTERVIEW",j=0;j<interviews.length;++j)if(interviews[j].selection.marketplaceMember.id===$scope.mpm.id&&currentInterviewSelectionStatusList.indexOf(interviews[j].selection.status)>=0)return void($scope.mpm.currentInterview=!0);vm.checkIsInterviewStatus(pageIndex+1)}})};var availabilityModal=function(mm,type){$uibModal.open({templateUrl:"availability-warning.tpl.html",controller:"AvailabilityModalCtrl",backdrop:"static",resolve:{marketplaceMember:function(){return mm},type:function(){return type}}})};vm.interview=function(){InterviewsService.checkAvailable($scope.mpm.application.candidate)?$location.path("/interview/schedule/"+$scope.mpm.id):availabilityModal($scope.mpm,"INTERVIEW")},vm.hire=function(){if(InterviewsService.checkAvailable($scope.mpm.application.candidate)){var redirect=function(){$location.path("/hire/direct/"+$scope.mpm.id)},modalInstance=$uibModal.open({templateUrl:"job-candidates-hire-confirm.tpl.html",controller:"JobCandidatesHireConfirmCtrl",backdrop:"static"});modalInstance.result.then(function(){SelectionService.advancePaymentModal($scope.mpm.application.candidate,redirect),vm.closeView()})}else availabilityModal($scope.mpm,"HIRE")},vm.reject=function(){var modalInstance=$uibModal.open({templateUrl:"job-candidates-reject-confirm.tpl.html",controller:"JobCandidatesRejectConfirmCtrl",backdrop:"static"});modalInstance.result.then(function(){CurrentUser.getAvatar({avatarType:"MANAGER"},function(res){vm.data.myAvatar=res;var mm=$scope.mpm,cu=vm.data.myAvatar;if(mm.isSaved){for(var idx=0,i=0;i<cu.savedCandidates.length;++i)if(cu.savedCandidates[i].id===mm.id){idx=i;break}cu.savedCandidates.splice(idx,1)}cu.type="MANAGER",cu.rejectedCandidates=cu.rejectedCandidates||[],cu.rejectedCandidates.push(mm),loading.start(),ManagerService.update({id:cu.id},cu).$promise.then(function(res){CurrentUser.clearCache(),vm.data.cu=res,$scope.reject(),vm.closeView();
})["finally"](loading.stop)}),CurrentUser.clearCache()})},vm.init=function(app){var promises=[];if(loading.start(),vm.checkIsInterviewStatus(0),vm.loadNotes(app),vm.loadAssignment(app),vm.load5Qs(app),promises.push(CurrentUser.get().$promise,CurrentUser.getAvatar({avatarType:"MANAGER"}).$promise,AssignmentService.get({marketplaceMemberId:$scope.mpm.id}).$promise),app.resumeFile){var fileId=app.resumeFile.id;promises.push(JobApplicationService.getFileUrl(app.id,fileId))}vm.shouldLoadAssignment&&promises.push(TechTrialApplicationService.getAssignmentAnswerLink(app.id)),$q.all(promises).then(function(data){var dI=0;vm.data.cu=data[dI],vm.data.myAvatar=data[++dI],vm.checkMatchedWithSaved($scope.mpm);var assignments=data[++dI].content;if(assignments&&assignments.length>0)for(var i=0;i<assignments.length;++i)"PENDING"!==assignments[i].status&&"CANDIDATE_ACCEPTED"!==assignments[i].status&&"MANAGER_SETUP"!==assignments[i].status&&"PAYMENT_APPROVED"!==assignments[i].status&&"ACTIVE"!==assignments[i].status||($scope.mpm.currentAssignment=!0);if($scope.mpm.currentAssignment||"ASSIGNED"!==$scope.mpm.status||($scope.mpm.alreadyHired=!0),app.resumeFile){var url=JobApplicationService.getGoogleDocUrl(data[++dI].data);$("#resume-frame").attr("src",url)}vm.shouldLoadAssignment?$scope.answerLink=$sce.trustAsResourceUrl(data[++dI].data):$scope.answerLink=void 0})}},link:function(scope,element,attrs,vm){element.focus(),element.on("keyup",function(e){e.preventDefault(),37===e.keyCode?vm["switch"](scope.previous):39===e.keyCode&&vm["switch"](scope.next)}),vm.UI.hasControls=!(!attrs.next||!attrs.previous),scope.$on("$routeChangeStart",function(){vm.closeView()}),scope.$watch("mpm",function(mpm){var app=mpm.application;app&&(scope.application=app,vm.resumeReady=!1,vm.shouldLoadAssignment=$filter("jobApplicationTest")(app,"ASSIGNMENT","score"),vm.shouldLoad5Qs=app.job.flowType.indexOf("FIVEQ")!==-1,vm.init(app))})}}}]),bandcampApp.directive("funnelView",["routePrefix",function(routePrefix){var tplUrl=(routePrefix||"")+"job/funnel-view/funnel-view.tpl.html";return{restrict:"E",replace:!0,templateUrl:tplUrl,controller:"JobFunnelCtrl",controllerAs:"vm",scope:{job:"="},link:function(scope){scope.$watch("job",function(job){job?angular.element("body").addClass("overflowAllh"):angular.element("body").removeClass("overflowAllh")})}}}]),ctrls.controller("AuthenticationCtrl",["$scope","AuthenticationFactory","$location","$rootScope","CurrentUser","LinkedInService","CrossoverTasksService","AssignmentService","JobApplicationService","$cacheFactory",function($scope,AuthenticationFactory,$location,$rootScope,CurrentUser,LinkedInService,CrossoverTasksService,AssignmentService,JobApplicationService,$cacheFactory){function afterLogin(){$scope.ui.isLoading=!0,$cacheFactory.get("$http").removeAll(),CurrentUser.get(function(user){$scope.userType=user.avatarTypes,user.avatarTypes.indexOf("CANDIDATE")>-1&&(1===user.avatarTypes.length||2===user.avatarTypes.length&&user.avatarTypes.indexOf("MIGRATED_CANDIDATE")>-1)?AssignmentService.assignments({page:0,avatarType:"CANDIDATE"}).$promise.then(function(res){$scope.data.assignments=res.content||[],JobApplicationService.list({avatarType:"CANDIDATE"}).$promise.then(function(apps){$scope.data.applications=apps.content||[]})})["finally"](function(){redirect(user)}):redirect(user)},function(){$rootScope.logout()})}function hasSecuritySetup(user){return angular.isDefined(user.userSecurity.securityQuestion)}function redirect(currentUser){var switcher=currentUser.avatarTypes.length>1&&"CANDIDATE"===currentUser.avatarTypes[0]?currentUser.avatarTypes[1]:currentUser.avatarTypes[0];switch(switcher){case"CANDIDATE":defaultAfterLoginPath=AssignmentService.getCandidateAfterLoginPath($scope.data.assignments,$scope.data.applications);break;case"ADMIN":defaultAfterLoginPath="/companies";break;case"RECRUITER":defaultAfterLoginPath="/recruiter/pending-approvals";break;case"ACCOUNT_MANAGER":defaultAfterLoginPath="/jobs";break;case"COMPANY_ADMIN":defaultAfterLoginPath=hasSecuritySetup(currentUser)?"/manager/team-dashboard":"/signup/security-question";break;case"MANAGER":var bitMask6Avatars=function(avatar){return"MANAGER"===avatar||"COMPANY_ADMIN"===avatar},isBitMask6=_.every(currentUser.avatarTypes,bitMask6Avatars),noSecurityQuestion=!hasSecuritySetup(currentUser);defaultAfterLoginPath=isBitMask6&&noSecurityQuestion?"/signup/security-question":"/manager/team-dashboard";break;case"TEAM_MANAGER":defaultAfterLoginPath="/manager/team-dashboard";break;case"RECRUITMENT_ANALYST":defaultAfterLoginPath="/grading";break;case"ENFORCER":defaultAfterLoginPath="/enforcer";break;case"JOB_BOARD_POSTER":case"OUTBOUND_RECRUITER":defaultAfterLoginPath="/pipelines/sourcing";break;case"MIGRATED_CANDIDATE":case"MIGRATED_MANAGER":defaultAfterLoginPath="/migrated/password";break;default:defaultAfterLoginPath="/contractor/home"}var redirectPath=angular.isDefined($rootScope.redirectPath)?$rootScope.redirectPath:defaultAfterLoginPath;delete $rootScope.redirectPath,$location.path(redirectPath)}$scope.user={email:null,password:null},$scope.ui={isLoading:!1,unauthorized:!1,accountDisabled:!1,unknownError:!1},$scope.data={applications:[]};var defaultAfterLoginPath="/dashboard";$rootScope.redirectPath&&LinkedInService.setRedirectUrl($rootScope.redirectPath),$rootScope.getAuthToken()&&afterLogin(),$scope.userLogin=function(form){if($scope.ui.accountDisabled=!1,$scope.ui.unknownError=!1,$scope.ui.unauthorized=form.$invalid,!form.$invalid){$scope.ui.isLoading=!0;var bb1,bb2,u=$scope.user.email,p=$scope.user.password;try{bb1=fpGetBlackbox()}catch(e){bb1=null}try{bb2=ioGetBlackbox()}catch(e){bb2=null}AuthenticationFactory.login(u,p,bb1,bb2).then(function(res){var authToken=res.data.token;$rootScope.setAuthToken(authToken),afterLogin()})["catch"](function(err){if(401===err.status){var disabled=err.data.indexOf("User is disabled")>=0;disabled?$scope.ui.accountDisabled=!0:$scope.ui.unauthorized=!0}else $scope.ui.unknownError=!0;$scope.ui.isLoading=!1})}},$scope.goToLinkedInAuthorization=function(){window.location=LinkedInService.generateAuthorizationUrl()}}]),ctrls.controller("LinkedInLoginCtrl",["$scope","$rootScope","$routeParams","$location","LinkedInService","CurrentUser","CandidatesService","AssignmentService","JobApplicationService",function($scope,$rootScope,$routeParams,$location,LinkedInService,CurrentUser,CandidatesService,AssignmentService,JobApplicationService){$scope.ui={isLoading:!0,error:!1,userNotFound:!1,hiringManagerAccount:!1,unknownError:!1};var jobApplicationData=LinkedInService.getJobApplicationData(),linkedinRedirect=LinkedInService.getRedirectUrl(),redirectUrl="/candidate/dashboard/home";if(angular.isDefined(jobApplicationData)&&null!==jobApplicationData?($scope.applicationUrl=jobApplicationData.url,redirectUrl="/job/"+jobApplicationData.jobId+"/apply"):linkedinRedirect&&(redirectUrl=linkedinRedirect,LinkedInService.setRedirectUrl(null)),$routeParams.state.indexOf("profileImportApplication")!==-1){var applicationId=LinkedInService.getApplicationId();redirectUrl="/candidate/application/complete-profile/"+applicationId+"?profileEdit=true",$location.path(redirectUrl)}else if($routeParams.state.indexOf("profileImport")!==-1){var showContractDashBoard=LinkedInService.getShowContractDashboard();if(showContractDashBoard)redirectUrl="/candidate/dashboard/contract";else{var jobId=LinkedInService.getJobId();redirectUrl=jobId?"/edit-profile/"+jobId:"/profile/user-profile"}CurrentUser.get(function(data){CandidatesService.importProfile({id:data.id},{token:$routeParams.code}).$promise.then(function(){$location.path(redirectUrl),$scope.ui.isLoading=!1},function(err){$scope.ui.error=err.data.text,$scope.ui.isLoading=!1})})}else $rootScope.isUserLoggedIn()?$location.path(redirectUrl):LinkedInService.authenticate($routeParams.code,function(res){res.agreementNotAccepted?$location.path("/candidate/terms"):CurrentUser.get(function(data){data.location.city?"/candidate/dashboard/home"===redirectUrl?AssignmentService.assignments({avatarType:"CANDIDATE"}).$promise.then(function(res){var assignments=res.content||[];JobApplicationService.list({avatarType:"CANDIDATE"}).$promise.then(function(apps){var applications=apps.content||[];redirectUrl=AssignmentService.getCandidateAfterLoginPath(assignments,applications),$location.path(redirectUrl)})}):$location.path(redirectUrl):$location.path("/signup/location")})},function(res){"CROS-0001"===res.errorCode?$scope.ui.userNotFound=!0:"CROS-0003"===res.errorCode?$scope.ui.hiringManagerAccount=!0:$scope.ui.unknownError=!0,$scope.ui.error=!0,$scope.ui.isLoading=!1})}]),services.factory("CandidateDashboardHelper",function(){return{msg:{clazz:"",show:!1,message:""},update:function(clazz,message){this.msg.clazz=clazz,this.msg.message=message,this.msg.show=!0},clean:function(){this.msg.clazz="",this.msg.message="",this.msg.show=!1}}}),ctrls.controller("ManagerCandidatesCtrl",["$scope","CandidateDashboardHelper",function($scope,CandidateDashboardHelper){$scope.msg=CandidateDashboardHelper.msg}]),ctrls.controller("HiringManagerSavedCandidatesCtrl",["$scope","CurrentUser","ManagerService","CandidateDashboardHelper",function($scope,CurrentUser,ManagerService,CandidateDashboardHelper){CurrentUser.getAndSetAvatar(CurrentUser,$scope,"MANAGER"),CandidateDashboardHelper.clean(),$scope.unSaved=function(mm){$scope.isLoading=!0;for(var cu=$scope.currentUser,idx=0,i=0;i<cu.savedCandidates.length;++i)if(cu.savedCandidates[i].id===mm.id){idx=i;break}cu.savedCandidates.splice(idx,1),ManagerService.update({id:cu.id},cu).$promise.then(function(res){$scope.currentUser=res,CurrentUser.clearCache(),$scope.candidateLeftMargin>0&&($scope.candidateLeftMargin=$scope.candidateLeftMargin-1)})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text)})["finally"](function(){$scope.isLoading=!1})},$scope.candidatesImagesPerPage=6,$scope.candidateLeftMargin=0,$scope.moveToLeft=function(){$scope.currentUser.savedCandidates.length-$scope.candidatesImagesPerPage>$scope.candidateLeftMargin&&($scope.candidateLeftMargin=$scope.candidateLeftMargin+1)},$scope.moveToRight=function(){$scope.candidateLeftMargin>0&&($scope.candidateLeftMargin=$scope.candidateLeftMargin-1)}}]),ctrls.controller("HiringManagerUpcomingInterviewsCtrl",["$scope","$location","CurrentUser","$uibModal","InterviewsService","SelectionService","CandidateDashboardHelper","$routeParams","DownloadService",function($scope,$location,CurrentUser,$uibModal,InterviewsService,SelectionService,CandidateDashboardHelper,$routeParams,DownloadService){CurrentUser.getAndSetAvatar(CurrentUser,$scope,"MANAGER"),$scope.upcomingInterviews=[],$scope.invokeCancelInterview=function(interviewToCancel){var modalInstance=$uibModal.open({templateUrl:"cancel-interview-confirm.tpl.html",controller:ConfirmModalInstanceCtrl,windowClass:"manager-candidates",resolve:{interview:function(){return interviewToCancel},action:null},backdrop:"static"});modalInstance.result.then(function(){cancelInterview(interviewToCancel)})};var ConfirmModalInstanceCtrl=function($scope,$uibModalInstance,interview,action){$scope.interview=interview,$scope.action=action,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},cancelInterview=function(interview){angular.isObject(interview)&&angular.isObject(interview.selection)&&($scope.isAcceptedInterviewsLoading=!0,SelectionService.cancel({id:interview.selection.id},{},function(){loadInitialInterviews(),loadAcceptedInterviews(),CandidateDashboardHelper.update("alert-success","Interview cancelled")},function(e){$scope.isAcceptedInterviewsLoading=!1,CandidateDashboardHelper.update("alert-danger",e.data.text)}))},loadAcceptedInterviews=function(){$scope.isAcceptedInterviewsLoading=!0;var params={avatarType:"MANAGER",status:"CANDIDATE_ACCEPTED",selectionStatus:"IN_PROGRESS",teamId:$routeParams.id};$scope.upcomingInterviews=InterviewsService.list(params,function(r){$scope.upcomingInterviews=r.content||[],$scope.isAcceptedInterviewsLoading=!1},function(err){CandidateDashboardHelper.update("alert-error",err.data.text),$scope.isAcceptedInterviewsLoading=!1})},loadInitialInterviews=function(){$scope.isInitialInterviewsLoading=!0,InterviewsService.list({avatarType:"MANAGER",status:"INITIAL",selectionStatus:"IN_PROGRESS",teamId:$routeParams.id}).$promise.then(function(res){$scope.newInterviews=res.content||[]})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text)})["finally"](function(){$scope.isInitialInterviewsLoading=!1})};loadAcceptedInterviews(),loadInitialInterviews(),$scope.downloadIcsFile=function(interview){var params={format:"ICS"};DownloadService.download("/interviews/"+interview.id,params,!1)}}]),ctrls.controller("HiringManagerRejectedCandidatesCtrl",["$scope","$location","CurrentUser","ManagerService","CandidateDashboardHelper",function($scope,$location,CurrentUser,ManagerService,CandidateDashboardHelper){CurrentUser.getAndSetAvatar(CurrentUser,$scope,"MANAGER"),$scope.unReject=function(mm){$scope.isLoading=!0;for(var cu=$scope.currentUser,idx=0,i=0;i<cu.rejectedCandidates.length;++i)if(cu.rejectedCandidates[i].id===mm.id){idx=i;break}cu.rejectedCandidates.splice(idx,1),ManagerService.update({id:cu.id},cu).$promise.then(function(res){$scope.currentUser=res,CurrentUser.clearCache(),$scope.rejectedCandidateLeftMargin>0&&($scope.rejectedCandidateLeftMargin=$scope.rejectedCandidateLeftMargin-1)})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text)})["finally"](function(){$scope.isLoading=!1})},$scope.rejectedCandidateLeftMargin=0,$scope.candidatesImagesPerPage=6,$scope.moveRejectedToLeft=function(){$scope.currentUser.rejectedCandidates.length-$scope.candidatesImagesPerPage>$scope.rejectedCandidateLeftMargin&&($scope.rejectedCandidateLeftMargin=$scope.rejectedCandidateLeftMargin+1)},$scope.moveRejectedToRight=function(){$scope.rejectedCandidateLeftMargin>0&&($scope.rejectedCandidateLeftMargin=$scope.rejectedCandidateLeftMargin-1)}}]),ctrls.controller("HiringManagerCandidatesCtrl",["$scope","$location","CurrentUser","ManagerService","TeamService","$uibModal","InterviewsService","SelectionService","AssignmentService","CandidateDashboardHelper","$routeParams",function($scope,$location,CurrentUser,ManagerService,TeamService,$uibModal,InterviewsService,SelectionService,AssignmentService,CandidateDashboardHelper,$routeParams){function loadPendingAssignmentsOnCandidate(pageIndex,status){AssignmentService.assignments({status:status,page:pageIndex,teamId:$routeParams.id}).$promise.then(function(res){res&&res.totalElements>0?($scope.pendingAssignmentsOnCandidates=$scope.pendingAssignmentsOnCandidates.concat(res.content||[]),res.totalPages>pageIndex+1?loadPendingAssignmentsOnCandidate(pageIndex+1,status):$scope.pendingAssignmentsOnCandidate=!1):$scope.pendingAssignmentsOnCandidate=!1})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text),$scope.pendingAssignmentsOnCandidate=!1})["finally"](function(){})}function loadPendingAssignmentsOnManager(pageIndex,status){AssignmentService.assignments({status:status,page:pageIndex,teamId:$routeParams.id}).$promise.then(function(res){res&&res.totalElements>0?(angular.forEach(res.content,function(item){SelectionService.tasks({id:item.id},function(tasks){var candidateTasks=tasks.filter(function(task){return 0===task.taskType.indexOf("candidate")});candidateTasks.length>0&&(item.candidateTaskType=candidateTasks[0].taskType)})}),$scope.pendingAssignmentsOnManager=$scope.pendingAssignmentsOnManager.concat(res.content||[]),res.totalPages>pageIndex+1?loadPendingAssignmentsOnManager(pageIndex+1,status):$scope.pendingAssignmentsOnManagerCount--):$scope.pendingAssignmentsOnManagerCount--})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text),$scope.pendingAssignmentsOnManager=!1}),TeamService.query({avatarType:"MANAGER"},function(teams){$scope.teams=teams,$scope.team=teams[0]})}function finalCallback(){$scope.pendingAssignmentsOnCandidate=!1}function errorCallback(err){CandidateDashboardHelper.update("alert-danger",err.data.text),$scope.pendingAssignmentsOnCandidate=!1}$scope.happenedInterviews=[],CurrentUser.getAndSetAvatar(CurrentUser,$scope,"MANAGER"),$scope.invokeRevokeOffer=function(assignmentOfferToRevoke){var modalInstance=$uibModal.open({templateUrl:"revoke-offer-confirm.tpl.html",controller:ConfirmRevokeModalInstanceCtrl,windowClass:"manager-candidates",resolve:{asg:function(){return assignmentOfferToRevoke}},backdrop:"static"});modalInstance.result.then(function(){revokeOffer(assignmentOfferToRevoke)})};var revokeOffer=function(asg){angular.isObject(asg)&&angular.isObject(asg.selection)&&($scope.revokingOffer=!0,SelectionService.cancel({id:asg.selection.id},{},function(){$scope.revokingOffer=!1,loadPendingOffers(),CandidateDashboardHelper.update("alert-success","Offer revoked.")},function(e){CandidateDashboardHelper.update("alert-danger",e.data.text),$scope.revokingOffer=!1}))};$scope.invokeRejectSelection=function(selection){angular.isObject(selection)&&($scope.isHappenedInterviewsLoading=!0,SelectionService.mdos({id:selection.id,status:"REJECTED"},{},function(){loadPastInterviews(),CurrentUser.clearCache(),CurrentUser.getAndSetAvatar(CurrentUser,$scope,"MANAGER")},function(e){$scope.isHappenedInterviewsLoading=!1,CandidateDashboardHelper.update("alert-danger",e.data.text)}))};var loadPastInterviews=function(){$scope.isHappenedInterviewsLoading=!0,$scope.happenedInterviews=[],InterviewsService.list({avatarType:"MANAGER",status:"CONDUCTED,NOT_CONDUCTED",selectionStatus:"IN_PROGRESS",teamId:$routeParams.id}).$promise.then(function(res){var interviews=res.content||[];$scope.happenedInterviews=_.uniq(interviews,function(i){return""+i.selection.manager.id+i.selection.marketplaceMember.id})})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text)})["finally"](function(){$scope.isHappenedInterviewsLoading=!1})},loadPendingOffers=function(){$scope.pendingAssignmentsOnCandidate=!0,$scope.pendingAssignmentsOnManagerCount=3,$scope.pendingAssignmentsOnCandidates=[],$scope.pendingAssignmentsOnManager=[],loadPendingAssignmentsOnCandidate(0,"PENDING"),loadPendingAssignmentsOnManager(0,"CANDIDATE_ACCEPTED"),loadPendingAssignmentsOnManager(0,"MANAGER_SETUP"),loadPendingAssignmentsOnManager(0,"PAYMENT_APPROVED")};loadPastInterviews(),loadPendingOffers(),$scope.viewManagerNotes=function(interviewToView){var modalInstance=$uibModal.open({templateUrl:"interview-feedback.tpl.html",controller:ViewInterViewNotesCtrl,backdrop:"static",windowClass:"manager-candidates",resolve:{interview:function(){return interviewToView.marketplaceMemberNote||(interviewToView.marketplaceMemberNote={type:"MP_HM"}),interviewToView}}});modalInstance.result.then(function(){CandidateDashboardHelper.update("alert-success","The interview feedback has been sent.")})},$scope.invokeHire=function(interviewToHire){var modalInstance=$uibModal.open({templateUrl:"job-candidates-reject-or-hire-confirm.tpl.html",windowClass:"manager-candidates",controller:ConfirmModalInstanceCtrl,resolve:{interview:function(){return interviewToHire},action:function(){return"HIRE"}},backdrop:"static"});modalInstance.result.then(function(){SelectionService.advancePaymentModal(interviewToHire.selection.marketplaceMember.application.candidate,function(){hire(interviewToHire)})})};var hire=function(interview){interview.status="OFFER",$scope.isLoading=!0,$scope.isHappenedInterviewsLoading=!0,SelectionService.mdos({id:interview.selection.id,status:"OFFERED"},{}).$promise.then(function(){$scope.pendingAssignmentsOnCandidates=[],loadPastInterviews(),$scope.pendingAssignmentsOnCandidate=!0,loadPendingAssignmentsOnCandidate(0,"PENDING")})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text)})["finally"](function(){$scope.isLoading=!1,$scope.isHappenedInterviewsLoading=!1})};$scope.invokeReject=function(interviewToReject){var modalInstance=$uibModal.open({templateUrl:"job-candidates-reject-or-hire-confirm.tpl.html",windowClass:"manager-candidates",controller:ConfirmModalInstanceCtrl,resolve:{interview:function(){return interviewToReject},action:function(){return"REJECT"}},backdrop:"static"});modalInstance.result.then(function(){$scope.invokeRejectSelection(interviewToReject.selection)})};var ViewInterViewNotesCtrl=function($scope,$uibModalInstance,InterviewsService,interview,CandidateDashboardHelper){$scope.data={interview:interview},$scope.ui={isLoading:!1},$scope.submit=function(){var interview=angular.copy($scope.data.interview);interview.marketplaceMemberNote=interview.marketplaceMemberNote||{},interview.marketplaceMemberNote.type="MP_HM",delete interview.jobApplication,$scope.ui.isLoading=!0,InterviewsService.update({id:interview.id},interview).$promise.then(function(data){$uibModalInstance.close(data)})["catch"](function(err){CandidateDashboardHelper.update("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},ConfirmModalInstanceCtrl=function($scope,$uibModalInstance,interview,action){$scope.interview=interview,$scope.action=action,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}},ConfirmRevokeModalInstanceCtrl=function($scope,$uibModalInstance,asg){$scope.asg=asg,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}};$scope.teamModal=function(asgn){var modalInstance=$uibModal.open({templateUrl:"team-setup-modal.tpl.html",windowClass:"hire-status modal-center",controller:ConfirmTeamSetupCtrl,resolve:{assignment:function(){return asgn},teams:function(){return $scope.teams},sTeam:function(){return $scope.team}},backdrop:"static"});modalInstance.result.then(function(){AssignmentService.managerSetupTeam({id:asgn.id},asgn.team,function(){},errorCallback).$promise["finally"](finalCallback)})};var ConfirmTeamSetupCtrl=function($scope,$uibModalInstance,assignment,teams,sTeam){$scope.assignment=assignment,$scope.teams=teams,$scope.team=sTeam,$scope.confirm=function(){assignment.team=$scope.team,$scope.pendingAssignmentsOnCandidate=!0,$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}}]),ctrls.managerDashboardHelper=function(){return{getWeekOutOfRange:function(date){var d=moment().startOf("isoweek").week()-moment(date).startOf("isoweek").week();return d<0&&(d=52),d},fillWeeksRangeArr:function(countOfWeeks){for(var weeksRange=[],sun=moment().endOf("isoWeek").toDate();countOfWeeks--;)weeksRange.push(sun),sun=moment(sun).subtract(7,"days").toDate();return weeksRange},uiDefaults:function(cookies){return{isNoTeams:!1,isCurrentWeek:!0,weekText:"",datePickerOptions:{startingDay:1,showWeeks:!1,maxDate:moment().toDate()},assignmentsLoading:!1,isTeamSummaryLoading:!1,isDirectReportsLoading:!1,isDatePickerVisible:!1,isJiraMetricsLoading:!0,memoLoading:!1,isPerformingAction:!1,selectedPlanSlots:[],t4w:cookies.summary_t4w,currentShowedWeek:cookies.summary_currentShowedWeek||null,teamTableSort:"prod.metricsStats[0]",teamTableSortReverse:!0}},dataDefaults:function(routeParams,scope){return{teams:[],otherTeams:[],team:null,teamIds:[],assignments:[],applications:[],productivity:[],categories:[],maxApplicationsPercentage:100,publicTeam:{name:"publicTeam_",isPublic:!0},teamId:parseInt(routeParams.team,10)||null,managerId:parseInt(routeParams.managerId,10)||null,fullTeam:routeParams.fullTeam===!0||!1,isOtherTeamSelected:routeParams.otherTeam,viewModule:routeParams.module||null,date:routeParams.date,today:moment().toDate(),currentWeekDay:moment().day(),jiraStatsWeeks:8,defaultHours:Array.apply(null,Array(7)).map(function(){return{hours:0}}),popup:{x:0,y:0,show:!1},trendChartConfig:{options:{chart:{type:"area"},legend:{enabled:!1},tooltip:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return moment(scope.data.currentDates[this.value]).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"},padding:0},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,lineWidth:0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},yAxis:{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""}},series:[{name:"Trend",data:[],allowPointSelect:!0,dataLabels:{enabled:!0,align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},format:"{point.y:,.0f}"},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3",states:{select:{fillColor:"#02a8f3",radius:4,lineWidth:0}}},color:"#e5f6fe"}]}}},drChartConfig:function(scope,splice){var productivityScoreSeries=function(name){return{name:name,type:"column",data:[],tooltip:{pointFormatter:function(){return this.series.name+Math.round(this.y)+"%"}},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3"},pointWidth:20,borderWidth:0,color:"rgba(2, 168, 243, 0.5)",yAxis:0,zIndex:0}};return{options:{chart:{type:"line"},legend:{enabled:!1},tooltip:{headerFormat:""},credits:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return moment(scope.data.currentDates[this.value+splice]).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"},padding:0},reversed:!0,lineWidth:0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},yAxis:[{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""},max:130},{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""},opposite:!0}],series:[{name:"Tickets Resolved",type:"line",data:[],tooltip:{pointFormatter:function(){return"Avg. "+this.series.name}},dataLabels:{enabled:!0,backgroundColor:"#ffffff",borderRadius:8,padding:4,shadow:{color:"#000000",offsetX:0,offsetY:1,opacity:.2,width:2},align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},format:"{point.y:,.1f}",y:-6},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,symbol:"circle",lineColor:"#02a8f3"},color:"#e5f6fe",yAxis:1,zIndex:1},productivityScoreSeries("Avg. Alignment Score: "),productivityScoreSeries("Avg. Focus Score: "),productivityScoreSeries("Avg. Intensity Score: ")]}},resetData:function($scope){$scope.data.assignments=[],$scope.data.applications=[],$scope.data.productivity=[],$scope.data.categories=[],$scope.data.maxApplicationsPercentage=1},hideMessage:function($timeout,$scope){$timeout(function(){$scope.msg.show=!1},1500)},addLatestWorkDiaryToAssignments:function(asgns,diaries){for(var i=diaries.length;i--;){var d=diaries[i];(asgns||[]).forEach(function(a){a.selection.marketplaceMember.application.candidate.id===d.candidateId&&(a.lastWorkDiary=d)})}},addProdToAssignments:function(a,p,scope,addToSummary){for(var i=a.length,maxMetric=0,maxHours=0,maxAct=0,baseProd={metricsStats:[0,0,0,0,0],recordedHours:[0,0,0,0,0],activityMetrics:[0,0,0,0,0],focusScores:[0,0,0,0,0],intensityScores:[0,0,0,0,0]};i--;)a[i].prod=baseProd,p.assignments.filter(function(m){a[i].id===m.id&&(maxHours=Math.max(maxHours,Math.max.apply(Math,m.recordedHours)),maxMetric=Math.max(maxMetric,Math.max.apply(Math,m.metricsStats)),maxAct=Math.max(maxAct,Math.max.apply(Math,m.activityMetrics)),m.maxHours=Math.max(a[i].weeklyLimit,Math.max.apply(Math,m.recordedHours)),a[i].prod=m,!addToSummary)});return scope.data.maxMetric=maxMetric,addToSummary&&(scope.data.maxHours=maxHours,scope.data.maxMetricAvg=maxMetric),a},get4WeeksAvg:function(list){return(list.reduce(function(a,b){return a+b})-list[0])/4},calcTopAndLowRates:function(scope){for(var a=scope.data.assignments,w=scope.ui.currentShowedWeek,i=scope.data.assignments.length,topRate={asg:null,rates:[0,0,0,0,0]},lowRate={asg:null,rates:[0,0,0,0,0]};i--;){var prod=a[i].prod;if(prod){var pDimensions=[];if(scope.ui.t4w){var avgMetricCalc=this.get4WeeksAvg(prod.metricsStats),avgHoursCalc=this.get4WeeksAvg(prod.recordedHours),avgActivityCalc=this.get4WeeksAvg(prod.activityMetrics),avgFocusCalc=this.get4WeeksAvg(prod.focusScores),avgIntensityCalc=this.get4WeeksAvg(prod.intensityScores);prod.fourWeeksAvg=[avgHoursCalc,avgMetricCalc,avgActivityCalc,avgFocusCalc,avgIntensityCalc],pDimensions=prod.fourWeeksAvg}else pDimensions=[prod.recordedHours[w],prod.metricsStats[w],prod.activityMetrics[w],prod.focusScores[w],prod.intensityScores[w]];var calcProd=pDimensions[2]/100+pDimensions[1];calcProd>=topRate.rates[2]/100+topRate.rates[1]&&(topRate.asg=a[i],topRate.rates=pDimensions),(!lowRate.asg||calcProd<=lowRate.rates[2]/100+lowRate.rates[1])&&(lowRate.asg=a[i],lowRate.rates=pDimensions)}}if(scope.data.topRate=topRate,scope.data.lowRate=lowRate,scope.ui.t4w){var t4wAvgMetric=this.get4WeeksAvg(scope.data.prodSummary.metricsStatsAvg),t4wAvgHours=this.get4WeeksAvg(scope.data.prodSummary.weeklyHoursAvg),t4wAvgActivity=this.get4WeeksAvg(scope.data.prodSummary.activityMetricsAvg),t4wAvgFocus=this.get4WeeksAvg(scope.data.prodSummary.focusScoreAvg),t4wAvgIntensity=this.get4WeeksAvg(scope.data.prodSummary.intensityScoreAvg);scope.data.prodSummary.fourWeeksAvg=[t4wAvgHours,t4wAvgMetric,t4wAvgActivity,t4wAvgFocus,t4wAvgIntensity]}},addColorsToAlign:function(a){for(var i=a.length,r=new Array(i);i--;)Math.ceil(a[i])>=70&&(r[i]={y:a[i],color:"#4CAF50"}),Math.ceil(a[i])>=30&&Math.ceil(a[i])<70&&(r[i]={y:a[i],color:"#FFCA28"}),Math.ceil(a[i])<30&&(r[i]={y:a[i],color:"#ED5053"});return r},addTeamToDirectReports:function(dr,teams,scope){for(var i=dr.length,res=[];i--;)dr[i].metricsStatsAvg.splice(0,1),dr[i].activityMetricsAvg.splice(0,1),dr[i].focusScoreAvg.splice(0,1),dr[i].intensityScoreAvg.splice(0,1),dr[i].chartConfig=this.drChartConfig(scope,1),dr[i].chartConfig.series[0].data=dr[i].metricsStatsAvg,dr[i].chartConfig.series[1].data=this.addColorsToAlign(dr[i].activityMetricsAvg),dr[i].chartConfig.series[2].data=this.addColorsToAlign(dr[i].focusScoreAvg),dr[i].chartConfig.series[3].data=this.addColorsToAlign(dr[i].intensityScoreAvg),dr[i].metricName&&(dr[i].chartConfig.series[0].name=dr[i].metricName),teams.filter(function(t){dr[i].id===t.id&&(dr[i].team=t)}),res.push(dr[i]);return res},getRouteDate:function(date,weeksBack){return date=moment(date).isValid()?moment().subtract(weeksBack?weeksBack:1,"week"):moment(parseInt(date,10)).isValid()?moment(parseInt(date,10)):moment().subtract(weeksBack?weeksBack:1,"week"),date.toDate()}}},ctrls.controller("ManagerDashboardTeamCtrl",["$scope","AssignmentService","ManagerService","ProfileUtils","UtilsService","$filter","$timeout","TeamService","$location","$routeParams","$q","CurrentUser","$rootScope","$document","TimeUtils","$cookies",function($scope,AssignmentService,ManagerService,ProfileUtils,UtilsService,$filter,$timeout,TeamService,$location,$routeParams,$q,CurrentUser,$rootScope,$document,TimeUtils,$cookies){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:""!==msg,message:msg}}function getUser(){return CurrentUser.get(function(u){return u})}function highlightCurrentWeekInChart(elem){setTimeout(function(){for(var i=angular.element(elem).length,weekNum={0:4,1:3,2:2,3:1,4:0};i--;){var selector=angular.element(angular.element(elem)[i])[0].style;i!==weekNum[$scope.ui.currentShowedWeek]||$scope.ui.outOfWeek||$scope.ui.t4w?selector.fill="#ffffff":selector.fill="#02a8f3"}},0)}function highlightCurrentWeekLabelInChart(elem){setTimeout(function(){for(var i=angular.element(elem).length,c=$scope.ui.currentShowedWeek,weekNum={0:0,1:0,2:1,3:2,4:3};i--;){var selector=angular.element(angular.element(elem)[i])[0].style;i!==weekNum[c]||$scope.ui.outOfWeek||$scope.ui.t4w?selector["font-weight"]="normal":selector["font-weight"]=900}},0)}function clearAssignmentsProd(){for(var i=$scope.data.assignments.length;i--;)$scope.data.assignments[i].prod=null}function spliceCurrentWeek(){if(0!==$scope.ui.currentShowedWeek||$scope.ui.outOfWeek){var ps=angular.copy($scope.data.prodSummary);
if(!ps)return;ps.metricsStatsAvg.splice(0,1),ps.activityMetricsAvg.splice(0,1),ps.focusScoreAvg.splice(0,1),ps.intensityScoreAvg.splice(0,1),5===$scope.data.currentDates.length&&$scope.data.currentDates.splice(0,1),$scope.data.prodSummary.chartConfig.series[0].data=ps.metricsStatsAvg,$scope.data.prodSummary.chartConfig.series[1].data=helper.addColorsToAlign(ps.activityMetricsAvg),$scope.data.prodSummary.chartConfig.series[2].data=helper.addColorsToAlign(ps.focusScoreAvg),$scope.data.prodSummary.chartConfig.series[3].data=helper.addColorsToAlign(ps.intensityScoreAvg)}else $scope.data.currentDates=helper.fillWeeksRangeArr(5),$scope.data.prodSummary.chartConfig.series[0].data=$scope.data.prodSummary.metricsStatsAvg,$scope.data.prodSummary.chartConfig.series[1].data=helper.addColorsToAlign($scope.data.prodSummary.activityMetricsAvg),$scope.data.prodSummary.chartConfig.series[2].data=helper.addColorsToAlign($scope.data.prodSummary.focusScoreAvg),$scope.data.prodSummary.chartConfig.series[3].data=helper.addColorsToAlign($scope.data.prodSummary.intensityScoreAvg)}function loadTeamSummary(load5Weeks){$scope.ui.isTeamSummaryLoading=!0;var prodSummary,params={},promises=[];if($scope.data.currentDates=helper.fillWeeksRangeArr(5),$scope.data.show)params={id:$scope.data.show.id,managerId:$scope.data.managerId,fullTeam:$scope.data.fullTeam,date:load5Weeks?moment().format("YYYY-MM-DD"):moment($scope.data.date).format("YYYY-MM-DD")},!$scope.data.prodSummary||helper.getWeekOutOfRange(params.date)>=5||load5Weeks?(params.weeksCount=helper.getWeekOutOfRange(params.date)>=5&&!load5Weeks?1:5,$scope.data.prodSummary||(params.date=moment().format("YYYY-MM-DD")),load5Weeks||clearAssignmentsProd(),TeamService.teamProductivitySummary(params,function(data){5===params.weeksCount?(load5Weeks?helper.addProdToAssignments($scope.data.assignments,data,$scope,!0):($scope.ui.outOfWeek=!1,$scope.data.assignments=helper.addProdToAssignments($scope.data.assignments,data,$scope,!0)),prodSummary=data,prodSummary.chartConfig=helper.drChartConfig($scope,0),prodSummary.chartConfig.series[0].data=data.metricsStatsAvg,prodSummary.chartConfig.series[1].data=helper.addColorsToAlign(data.activityMetricsAvg),prodSummary.chartConfig.series[2].data=helper.addColorsToAlign(data.focusScoreAvg),prodSummary.chartConfig.series[3].data=helper.addColorsToAlign(data.intensityScoreAvg),prodSummary.chartConfig.series[0].name=data.metricName,prodSummary.chartConfig.currentDates=$scope.data.currentDates,prodSummary.maxHours=Math.max.apply(Math,data.weeklyHoursAvg),$scope.data.prodSummary=prodSummary,$scope.ui.isCurrentWeek||spliceCurrentWeek(),$scope.ui.outOfWeek&&loadTeamSummary(!1)):($scope.ui.outOfWeek=!0,$scope.data.assignments=helper.addProdToAssignments($scope.data.assignments,data,$scope),$scope.data.cuWeekProd=data,$scope.data.prodSummary||loadTeamSummary(!0)),$scope.ui.currentShowedWeek=$scope.ui.outOfWeek?0:helper.getWeekOutOfRange($scope.data.date),$scope.ui.teamTableSort=$scope.ui.teamTableSort.replace(/\[?.\]/i,"["+$scope.ui.currentShowedWeek+"]"),highlightCurrentWeekInChart("#chartHighLevel svg g.highcharts-markers path"),highlightCurrentWeekLabelInChart("#chartHighLevel svg g.highcharts-axis-labels text"),helper.calcTopAndLowRates($scope),$scope.ui.isTeamSummaryLoading=!1})):($scope.ui.outOfWeek&&($scope.ui.outOfWeek=!1),$scope.data.assignments=helper.addProdToAssignments($scope.data.assignments,$scope.data.prodSummary,$scope),$scope.ui.currentShowedWeek=helper.getWeekOutOfRange(params.date),$scope.ui.teamTableSort=$scope.ui.teamTableSort.replace(/\[?.\]/i,"["+$scope.ui.currentShowedWeek+"]"),helper.calcTopAndLowRates($scope),$scope.ui.isTeamSummaryLoading=!1);else{for(var tl=$scope.data.teams.length;tl--;)params={id:$scope.data.teams[tl].id,managerId:$scope.data.teams[tl].reportingManagers.filter(function(m){return m.userId===$scope.currentUser.id}).pop().id,fullTeam:!1,date:moment().format("YYYY-MM-DD"),weeksCount:5},promises.push(TeamService.teamProductivitySummary(params).$promise);$q.all(promises).then(function(result){$scope.data.directReports=helper.addTeamToDirectReports(result,$scope.data.teams,$scope),$scope.ui.isTeamSummaryLoading=!1,$scope.ui.isDirectReportsLoading=!1,$scope.ui.isTeamSummaryLoading=!1})}}function getLatestWorkDiaries(){var req={teamId:$scope.data.show?$scope.data.show.id:null,managerId:$scope.data.managerId,fullTeam:$scope.data.fullTeam&&!$scope.data.managerId};AssignmentService.getLatestWorkDiaries(req,function(res){helper.addLatestWorkDiaryToAssignments($scope.data.assignments,res)})}function getAssignments(page,team,callbacks){var limit=50,p=page||0,cbLen=callbacks.length;if(0!==p||!$scope.ui.assignmentsLoading){0===p&&($scope.ui.assignmentsLoading=!0);var timeRange={from:moment($scope.data.date).weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),to:moment($scope.data.date).weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)};$scope.ui.t4w&&(timeRange={from:moment().subtract(4,"week").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),to:moment().subtract(1,"week").weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)});var req={page:p,status:"ACTIVE",managerId:$scope.data.managerId,fullTeam:$scope.data.fullTeam&&!$scope.data.managerId,limit:limit,from:timeRange.from,to:timeRange.to};angular.isObject(team)&&(req.teamId=team.id),AssignmentService.teamAssignments(req,function(data){if($scope.data.assignments=_.map(data.content,function(a){var assignment=_.find($scope.data.assignments,function(assignment){return assignment.id===a.id});return assignment=assignment||a,assignment.realPhotoUrl=ProfileUtils.profilePhotoUrl(assignment.selection.marketplaceMember.application.candidate),assignment.left=assignment.isLeft({teamId:req.teamId}),assignment.lastDay=assignment.getLastDay({teamId:req.teamId}),assignment}),(p+1)*limit<=data.totalElements)getAssignments(p+1,team,callbacks);else{for(;cbLen--;)callbacks[cbLen]();$scope.ui.assignmentsLoading=!1}},function(err){showMessage("alert-danger",err.data.text),$scope.ui.assignmentsLoading=!1})}}function loadAssignmentsAndUpdate(team){$scope.ui.weekText=getWeekText($scope.data.date),$scope.data.prodSummary=null,"Metrics"===$scope.data.viewModule?getAssignments(0,team,[]):getAssignments(0,team,[loadTeamSummary,getLatestWorkDiaries])}function updateTeam(){if(0!==$scope.data.teams.length||0!==$scope.data.otherTeams.length)if(helper.hideMessage($timeout,$scope),isDefined($scope.data.show)&&null!==$scope.data.show){var allTeams=$scope.data.teams.concat($scope.data.otherTeams),found=allTeams.filter(function(team){return team.id===$scope.data.show.id});found.length>0&&(helper.resetData($scope),loadAssignmentsAndUpdate(found[0]))}else $scope.ui.isDirectReportsLoading=!0,helper.resetData($scope),$scope.data.teamId||loadAssignmentsAndUpdate()}function getOne(array,f){if(array&&null!==array)return f=f||_.identity,1===array.length?f(array[0]):null}function loadTeams(){helper.resetData($scope),$scope.currentUser=getUser(),$scope.cu=$scope.currentUser,$scope.data.teams=[],$scope.ui.isLoading=!0,TeamService.teamsManagersMap(function(teamsManagersMap){$scope.data.teamIds=[];for(var i=0;i<teamsManagersMap.length;i++){var t=teamsManagersMap[i],me=void 0;t&&t.reportingManagers&&(me=t.reportingManagers.filter(function(m){return m.userId===$scope.currentUser.id}).pop()),me?($scope.data.teams.push(t),$scope.data.teamIds.push(t.id)):t.reportingManagers&&$scope.data.otherTeams.push(t)}if($scope.data.teams=$scope.data.teams.sort(function(t1,t2){return t1.id-t2.id}),$scope.data.otherTeams=$scope.data.otherTeams.sort(function(t1,t2){return t1.id-t2.id}),1!==$scope.data.teams.length||isDefined($scope.data.teamId)&&$scope.data.teamId)isDefined($scope.data.teamId)?($scope.data.show=$scope.data.teams.filter(function(t){return t.id===$scope.data.teamId}).pop(),$scope.data.show?($scope.data.isOtherTeamSelected=!1,$location.search("otherTeam",!1)):($scope.data.show=$scope.data.otherTeams.filter(function(t){return t.id===$scope.data.teamId}).pop(),$scope.data.show?($scope.data.isOtherTeamSelected=!0,$location.search("otherTeam",!0)):delete $scope.data.show)):delete $scope.data.show;else{var selectedTeam=$scope.data.teams[0];$scope.selectTeam(selectedTeam),$scope.data.show=selectedTeam}$scope.data.show&&!$scope.data.fullTeam&&$scope.data.show.reportingManagers&&($scope.data.managerId?$scope.data.selectedManager=$scope.data.show.reportingManagers.filter(function(m){return m.id===$scope.data.managerId}).pop():($scope.data.selectedManager=$scope.data.show.reportingManagers.filter(function(m){return m.userId===$scope.currentUser.id}).pop(),$scope.data.selectedManager?$scope.data.managerId=$scope.data.selectedManager.id:$scope.data.managerId=getOne($scope.data.show.reportingManagers,function(manager){return manager.id}))),$scope.data.selectedManager||($scope.data.fullTeam=!!$scope.data.show,delete $scope.data.managerId),$scope.ui.isLoading=!1,updateTeam()},function(err){showMessage("alert-danger",err.data.text),$scope.ui.isLoading=!1})}function getWeekText(date){var week=UtilsService.getWeekOfDate(date,!1);return $filter("date")(week.firstDate,"MMM d")+" - "+$filter("date")(week.lastDate,"MMM d, yyyy")}function changeDate(d){var dt=new Date($scope.data.date);dt.setDate($scope.data.date.getDate()+7*d),$scope.data.date=dt}function updateRoute(){var data=$scope.data;if(!data.show||!data.managerId||data.show.reportingManagers){if((!isDefined(data.show)||null===data.show)&&"Metrics"===data.viewModule){var allTeams=$scope.data.teams.concat($scope.data.otherTeams);data.show=allTeams[0],angular.isDefined(data.show)&&data.show.reportingManagers&&data.show.reportingManagers[0].userId===$scope.currentUser.id?data.selectedManager=data.show.reportingManagers[0]:(data.selectedManager=null,data.managerId=null,data.fullTeam=!0)}if(isDefined(data.show)&&null!==data.show){var i=parseInt(data.show.id,10),tCheck=function(d){if(!isNaN(d))return d};angular.isNumber(tCheck(i))&&isDefined($scope.data.teams)?(allTeams=$scope.data.teams.concat($scope.data.otherTeams),$scope.data.show=_.filter(allTeams,function(t){return t.id===i})[0],$location.search("team",data.show.id),$scope.data.team=data.show):delete $scope.data.show}if(isObject(data.date)?$location.search("date",data.date.getTime()):$location.search("date",null),isObject($scope.data.selectedManager))$location.search("managerId",$scope.data.selectedManager.id),$scope.data.managerId=$scope.data.selectedManager.id;else if($scope.data.managerId&&$scope.data.team&&$scope.data.team.reportingManagers){var mgr=$scope.data.team.reportingManagers.filter(function(m){return m.id===$scope.data.managerId}).pop();mgr?($location.search("managerId",$scope.data.managerId),$scope.data.selectedManager=mgr):($location.search("managerId",null),$scope.data.team&&($scope.data.managerId=getOne($scope.data.team.reportingManagers,function(manager){return manager.id})))}else{var allManagers=null;$location.search("managerId",allManagers),$scope.data.managerId=allManagers}$location.search("fullTeam",$scope.data.fullTeam),updateTeam()}}var helper=ctrls.managerDashboardHelper(),isDefined=angular.isDefined,isObject=angular.isObject;$routeParams.date=helper.getRouteDate($routeParams.date,$cookies.summary_currentShowedWeek),$scope.data=helper.dataDefaults($routeParams,$scope),$scope.ui=helper.uiDefaults($cookies);var onlineStatusInterval=setInterval(function(){getLatestWorkDiaries()},3e5);$scope.$on("$destroy",function(){clearInterval(onlineStatusInterval)}),this.updateRoute=updateRoute,$scope.selectTeam=function(team,isOtherTeamSelected){if($scope.data.show=team,$scope.data.teamId=isDefined(team)?team.id:null,$scope.data.isOtherTeamSelected=isOtherTeamSelected,$location.search("otherTeam",$scope.data.isOtherTeamSelected),isOtherTeamSelected)delete $scope.data.selectedManager,delete $scope.data.managerId,$scope.data.fullTeam=!0;else{if(delete $scope.data.isOtherTeamSelected,team&&team.reportingManagers){var me=team.reportingManagers.filter(function(m){return m.userId===$scope.currentUser.id}).pop();$scope.data.selectedManager=me,$scope.data.managerId=me.id}else delete $scope.data.selectedManager,delete $scope.data.managerId;$scope.data.fullTeam=!1}angular.isUndefined(team)&&$location.search("team",null),updateRoute(),$scope.data.teamDropdown=!1},$scope.prevWeek=function(){changeDate(-1)},$scope.nextWeek=function(){changeDate(1)},$scope.getAssignmentRole=function(asgnId){var filtered=$scope.data.assignments.filter(function(a){return a.id===asgnId});if(filtered.length>0)return filtered[0].jobTitle},$scope.openTimesheetCal=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.ui.isDatePickerVisible=!$scope.ui.isDatePickerVisible},$scope.setPopup=function(e,asg,kind){if($scope.data.prodSummary){var data=angular.copy("recordedHours, metricsStats, activityMetrics, focusScores, intensityScores".indexOf(kind)>-1?$scope.data.prodSummary.assignments.filter(function(p){return p.id===asg}).pop():$scope.data.prodSummary),rd=angular.element(".summaryTeam.relative").offset();if("cDetails"===kind&&($scope.data.popup={x:e.pageX-rd.left-e.offsetX+e.currentTarget.clientWidth-260,y:e.pageY-rd.top-e.offsetY-260,show:!0},$scope.data.trend=null,$scope.data.showUserDetails=asg),kind&&"cDetails"!==kind){if(!data)return;var maxChartV="activityMetrics, activityMetricsAvg,focusScores, focusScoreAvg,intensityScores, intensityScoreAvg".indexOf(kind)>-1?100:"metricsStats, metricsStatsAvg".indexOf(kind)>-1?$scope.data.maxMetricAvg:"recordedHours, weeklyHoursAvg".indexOf(kind)>-1?data.maxHours:60,xOffset="focusScores, focusScoreAvg,intensityScores, intensityScoreAvgactivityMetricsAvg, activityMetrics".indexOf(kind)>-1?200:25;$scope.data.popup={x:e.pageX-rd.left-e.offsetX-xOffset,y:e.pageY-rd.top-e.offsetY-250,show:!0},$scope.ui.outOfWeek||$scope.ui.t4w||(data[kind][$scope.ui.currentShowedWeek]={y:data[kind][$scope.ui.currentShowedWeek],selected:!0}),0!==$scope.ui.currentShowedWeek||$scope.ui.outOfWeek?(data[kind].splice(0,1),5===$scope.data.currentDates.length&&$scope.data.currentDates.splice(0,1)):$scope.data.currentDates=helper.fillWeeksRangeArr(5),$scope.data.trend=kind,$scope.data.showUserDetails=null,$scope.data.trendChartConfig.series[0].data=data[kind],$scope.data.trendChartConfig.series[0].name=kind,$scope.data.trendChartConfig.series[0].dataLabels.format="metricsStats, metricsStatsAvg".indexOf(kind)>-1?"{point.y:,.1f}":"{point.y:,.0f}",$scope.data.trendChartConfig.yAxis.max=Math.ceil(maxChartV)}kind||($scope.data.popup.show=!1,$scope.data.trend=null,$scope.data.showUserDetails=null,$scope.data.trendChartConfig.series[0].data=null)}},$scope.getCurrentTime=function(){if(angular.isDefined($scope.data.showUserDetails)){var offset=$scope.data.showUserDetails.selection.marketplaceMember.application.candidate.location.timeZone.offset;return offset?TimeUtils.getTimeByTimezoneOffset(offset):TimeUtils.getUTCTime()}},$document.bind("keyup",function(e){27!==e.keyCode||angular.element("body").hasClass("modal-open")||$scope.openContractorPage(!0)}),$scope.openContractorPage=function(hide,asgId,activeView,date){return hide?(delete $scope.teamMemberShow,delete $routeParams.id,void $timeout(function(){$scope.teamProductivityShow?$scope.$emit("secondModal",!1):angular.element("body").removeClass("overflowAllh")})):($scope.teamProductivityShow&&$scope.$emit("secondModal",!0),$scope.teamMemberShow=asgId,angular.element("body").addClass("overflowAllh"),$routeParams.id=asgId,$routeParams.activeView=activeView,void($routeParams.date=date?TimeUtils.convertToUtc(new Date(date)):TimeUtils.getUTCTime()))},$scope.goToTab=function(tab,team){$scope.data.viewModule=tab,$scope.selectTeam(team,!1)},$scope.jumpToWeek=function(week,t4w){$scope.ui.t4w=t4w,week?$scope.data.date=moment().subtract(1,"week").toDate():$scope.data.date=moment().toDate()},$scope.get4WeekText=function(from,to){return"from "+moment(from).subtract(1,"week").add(1,"day").format("MMMM DD")+" to "+moment(to).format("MMMM DD")},$scope.getCurrentWeekText=function(){return $scope.ui.t4w?$scope.get4WeekText($scope.data.currentDates[$scope.data.currentDates.length-1],$scope.data.currentDates[4!==$scope.data.currentDates.length?1:0]):"for week of "+$scope.ui.weekText},$scope.getCalendare4WeeksText=function(){var week1=UtilsService.getWeekOfDate(moment(new Date).subtract(1,"week").toDate(),!1),week4=UtilsService.getWeekOfDate(moment(new Date).subtract(4,"week").toDate(),!1);return $filter("date")(week4.firstDate,"MMMM d, yyyy")+" - "+$filter("date")(week1.lastDate,"MMMM d, yyyy")},$scope.sortTable=function(sortableColumn){$scope.ui.t4w?"recordedHours"===sortableColumn?$scope.ui.teamTableSort="prod.fourWeeksAvg[0]":"activityMetrics"===sortableColumn?$scope.ui.teamTableSort="prod.fourWeeksAvg[2]":"focusScores"===sortableColumn?$scope.ui.teamTableSort="prod.fourWeeksAvg[3]":"intensityScores"===sortableColumn?$scope.ui.teamTableSort="prod.fourWeeksAvg[4]":$scope.ui.teamTableSort="prod.fourWeeksAvg[1]":$scope.ui.teamTableSort="prod."+sortableColumn+"["+$scope.ui.currentShowedWeek+"]",$scope.ui.teamTableSortReverse=!$scope.ui.teamTableSortReverse},$scope.getLastOnlineAgo=function(asgn){var diff=(new Date).getTime()-asgn.lastWorkDiary.date;return diff/=6e4},$scope.getOnlineStatusClass=function(asgn){if(asgn.lastWorkDiary){var diff=$scope.getLastOnlineAgo(asgn),clazz="offline";return diff<=29?clazz="online":diff<69&&(clazz="noActivity"),clazz}},$scope.getOnlineStatusText=function(asgn){if(asgn.lastWorkDiary){var diff=$scope.getLastOnlineAgo(asgn),status="";if(diff<=29)status="Online";else if(diff<69)status="Last online: <1 hour ago";else{var offlineHorus=Math.floor(diff/60);status=offlineHorus>24?"Last online: "+Math.floor(offlineHorus/24)+" day(s) ago":"Last online: "+offlineHorus+" hour(s) ago"}return status}},$scope.getSelectedManagerPrintable=function(){var selectedManager=$scope.data.selectedManager;if(selectedManager){var printableName=selectedManager.printableName;return $scope.currentUser.id===selectedManager.userId?"Me ("+printableName+")":printableName}return"All Managers"},$scope.getMetricsClass=function(value){return{more70:value>=70,more30:value>=30&&value<70,less30:value<30}},$scope.getAverageMetricsClass=function(metric){return null===$scope.data.prodSummary?null:$scope.data.cuWeekProd||$scope.data.prodSummary?$scope.ui.outOfWeek?$scope.getMetricsClass($scope.data.cuWeekProd[metric][0]):$scope.getMetricsClass($scope.data.prodSummary[metric][$scope.ui.currentShowedWeek]):void 0},$scope.getFourWeeksAverageMetricsClass=function(metric){if($scope.data.prodSummary)return $scope.getMetricsClass($scope.data.prodSummary.fourWeeksAvg[metric])},$scope.getSummaryMetricsClass=function(assignment,metric,c){if(assignment.prod)return $scope.getMetricsClass($scope.ui.t4w?assignment.prod.fourWeeksAvg[c]:assignment.prod[metric][$scope.ui.currentShowedWeek])},$scope.getTrendChartProperties=function(){var trendCharts={"recordedHours, weeklyHoursAvg":{title:"Hours Logged Trend","class":"ciCalTime"},"metricsStats, metricsStatsAvg":{title:$scope.data.prodSummary.metricName?$scope.data.prodSummary.metricName+" Trend":"Stories Resolved Trend","class":"ciCheck"},"activityMetrics, activityMetricsAvg":{title:"Alignment Score Trend","class":"ciBars"},"intensityScores, intensityScoreAvg":{title:"Intensity Score Trend","class":"ciBars"},"focusScores, focusScoreAvg":{title:"Focus Score Trend","class":"ciBars"},"null":{title:"","class":""}},result=[];return angular.forEach(trendCharts,function(value,key){key.indexOf($scope.data.trend)>-1&&this.push(value)},result),result.length>0?result[0]:trendCharts[null]},$scope.lockTeamAndManagerSwitcher=function(disable){return disable?$scope.ui.assignmentsLoading||$scope.ui.isTimesheetLoading||$scope.ui.isLoading||$scope.ui.isDirectReportsLoading||$scope.ui.isTeamSummaryLoading||$scope.isLoading.status:!($scope.ui.assignmentsLoading||$scope.ui.isTimesheetLoading||$scope.ui.isLoading||$scope.ui.isDirectReportsLoading||$scope.ui.isTeamSummaryLoading||$scope.isLoading.status)},$scope.pullData=function(){$scope.ui.weekText=getWeekText($scope.data.date),getAssignments(0,$scope.data.show,[loadTeamSummary])},$scope.$watch("data.show",function(nv){angular.isDefined(nv)&&($scope.data.maxMetric=null,updateRoute()),$scope.data.managersDropdown=!1,$scope.data.teamDropdown=!1}),$scope.$watch("data.selectedManager",function(nv,ov){return nv===ov?($scope.data.managersDropdown=!1,void($scope.data.teamDropdown=!1)):(angular.isDefined(nv)&&nv?($scope.data.managerId=$scope.data.selectedManager.id,$scope.data.fullTeam=!1,delete $routeParams.fullTeam):($scope.data.managerId=null,$scope.data.fullTeam=!0),$scope.data.maxMetric=null,$scope.data.managersDropdown=!1,$scope.data.teamDropdown=!1,void updateRoute())}),$scope.$watch("data.viewModule",function(nv){$scope.isLoading.status=!1,$scope.data.viewModule=nv,"Metrics"===nv&&updateRoute(),$location.search("module",nv),highlightCurrentWeekInChart("#chartHighLevel svg g.highcharts-markers path"),highlightCurrentWeekLabelInChart("#chartHighLevel svg g.highcharts-axis-labels text")}),$scope.$watch("data.date",function(nv,ov){$scope.ui.isDatePickerVisible=!1,$scope.ui.isCurrentWeek=UtilsService.isInSameWeek(new Date,nv),UtilsService.isInSameWeek(nv,ov)||$scope.pullData()}),$scope.$watch("ui.t4w",function(){$scope.ui.t4w?($cookies.summary_t4w=$scope.ui.t4w,delete $cookies.summary_currentShowedWeek):delete $cookies.summary_t4w,$scope.data.prodSummary&&(helper.calcTopAndLowRates($scope),highlightCurrentWeekInChart("#chartHighLevel svg g.highcharts-markers path"),highlightCurrentWeekLabelInChart("#chartHighLevel svg g.highcharts-axis-labels text")),$scope.pullData()}),$scope.$watch("ui.currentShowedWeek",function(){$scope.ui.currentShowedWeek<2&&!$scope.ui.outOfWeek?$cookies.summary_currentShowedWeek=$scope.ui.currentShowedWeek:delete $cookies.summary_currentShowedWeek}),$scope.$watch("ui.teamTableSort",function(nv,ov){nv.replace(/\[?.\]/i,"")!==ov.replace(/\[?.\]/i,"")&&($scope.ui.teamTableSortReverse||($scope.ui.teamTableSortReverse=!0))}),$document.bind("click",function(event){var isDropdown=angular.element(".dropdown").find(event.target).length>0;isDropdown||($scope.data.teamDropdown=!1,$scope.data.managersDropdown=!1,$scope.$apply())}),$rootScope.$on("$locationChangeStart",function(){$scope.path.indexOf("manager/dashboard")>-1&&$scope.hideSubtitleBar()}),loadTeams(),showMessage("",""),$scope.isLoading={status:!1}}]),ctrls.controller("ManagerDashboardActivitiesCtrl",["$scope","UtilsService","$filter","$location","$routeParams","ProductivityService","AssignmentService","$cacheFactory","DownloadService","$cookies","$q","$timeout",function($scope,UtilsService,$filter,$location,$routeParams,ProductivityService,AssignmentService,$cacheFactory,DownloadService,$cookies,$q,$timeout){function checkLastCacheUpdate(){angular.isUndefined($cookies.lastCacheUpdate)?$cookies.lastCacheUpdate=(new Date).getTime():(new Date).getTime()-$cookies.lastCacheUpdate>=cacheUpdateTime&&($cookies.lastCacheUpdate=(new Date).getTime(),$scope.f.clearCashedTeamActivities())}function addNotWorkedMemebers(list,isPerc){if($scope.assignments)for(var i=$scope.assignments.length;i--;){for(var j=list.length,founded=!1;j--;)$scope.assignments[i].id===list[j].assignmentId&&(list[j].assignment=$scope.assignments[i],list[j].contractor=$scope.assignments[i].selection.marketplaceMember.application.candidate,list[j].effectiveDateEndInTeam=AssignmentService.getAssignmentEndDateInTeam($scope.assignments[i],$scope.data.teamId,$scope.data.managerId),founded=!0);if(!founded){var model=isPerc?{grouping:{advancedGroups:[],periodLong:0,totalTrackedTime:0,alignmentScore:0,simpleMetrics:0,simpleGroups:[]}}:{contractorTimeSlots:new Array(144),managerTimeSlots:new Array(144)};model.assignmentId=$scope.assignments[i].id,model.assignment=$scope.assignments[i],model.contractor=$scope.assignments[i].selection.marketplaceMember.application.candidate,model.effectiveDateEndInTeam=AssignmentService.getAssignmentEndDateInTeam($scope.assignments[i],$scope.data.teamId,$scope.data.managerId),list.push(model)}}}function sortBySpendTimeAndGroup(arr){for(var l=arr.length,r=[];l--;){var g=arr[l].grouping;r[l]={assignmentId:arr[l].assignmentId,contractor:arr[l].contractor,assignment:arr[l].assignment,effectiveDateEndInTeam:arr[l].effectiveDateEndInTeam,grouping:{advancedGroups:angular.isArray(arr[l].grouping.advancedGroups)?$filter("orderBy")(arr[l].grouping.advancedGroups||[],"spentTime",!0):[],periodLong:g.periodLong,totalTrackedTime:g.totalTrackedTime||0,alignmentScore:g.alignmentScore||0,simpleMetrics:g.simpleMetrics||0,simpleGroups:[]}};for(var gl=void 0!==g.simpleGroups?g.simpleGroups.length:0;gl--;)r[l].grouping.simpleGroups.push(g.simpleGroups[gl])}return r}function getTeamActivities(load,silentUpdate,refresh){var deferred=$q.defer();if($scope.ui.isTeamActivitiesLoading&&load===-1||!$scope.d.activitiesSelectedDate)return deferred.resolve(),deferred.promise;var type="Percentage"===$scope.d.viewType,peroid="Weekly"===$scope.d.periodType,fullTeam=$scope.data.fullTeam,dataDate=$scope.d.activitiesSelectedDate,dataPeriodType=$scope.d.periodType,data={teamId:$scope.data.show?$scope.data.show.id:null,date:"Weekly"===$scope.d.periodType?$filter("date")(UtilsService.getWeekOfDate($scope.d.activitiesSelectedDate,!1).firstDate,"yyyy-MM-dd"):$filter("date")($scope.d.activitiesSelectedDate,"yyyy-MM-dd"),weekly:peroid,fullTeam:fullTeam,managerId:$scope.data.managerId?$scope.data.managerId:null,groups:"groups",refresh:refresh===!0},jump=peroid?-7:-1,dt=new Date($scope.d.activitiesSelectedDate);switch(load){case"time":delete data.groups;break;case"percentage":data.groups="groups";break;case"download":break;case"background":case"background2":dt.setDate($scope.d.activitiesSelectedDate.getDate()+jump),"background2"===load&&(dt.setDate($scope.d.activitiesSelectedDate.getDate()+2*jump),$scope.d.team.background=!1),data.date=peroid?$filter("date")(UtilsService.getWeekOfDate(dt,!1).firstDate,"yyyy-MM-dd"):$filter("date")(dt,"yyyy-MM-dd");break;case"switch":return $scope.ui.isTeamActivitiesLoading=!1,$scope.f.calMaxActTime(peroid),type||peroid?($scope.d.team.cur=$scope.d.team.perc,deferred.resolve(),deferred.promise):($scope.d.team.cur=$scope.d.team.time,deferred.resolve(),deferred.promise);default:$scope.ui.isTeamActivitiesLoading=!silentUpdate,checkLastCacheUpdate(),$scope.d.team.cur=[],$scope.d.team.time=[],$scope.d.team.perc=[],$scope.d.team.background=!0,type||delete data.groups}if("download"===load)return DownloadService.download("/tracker/activity/groups",data),deferred.resolve(),deferred.promise;var selectedDateText="Weekly"===$scope.d.periodType?$filter("date")(UtilsService.getWeekOfDate($scope.d.activitiesSelectedDate,!1).firstDate,"yyyy-MM-dd"):$filter("date")($scope.d.activitiesSelectedDate,"yyyy-MM-dd"),updateActivities=!silentUpdate&&!$scope.ui.isTeamActivitiesLoading&&data.date===selectedDateText&&("Percentage"===$scope.d.viewType&&data.groups||"Time"===$scope.d.viewType&&!data.groups);updateActivities&&($scope.ui.updateActivitiesData=$scope.ui.updateActivitiesData?$scope.ui.updateActivitiesData:0,$scope.ui.updateActivitiesData+=1);var promise;return promise="groups"===data.groups?ProductivityService.readGroupedTeamActivities(data).$promise:ProductivityService.readTeamActivities(data).$promise,promise.then(function(response){var lastRefreshedAt=new Date;if("groups"===data.groups&&response.data?(lastRefreshedAt=response.lastRefreshedAt,response=response.data):(response=response||[],response.length>0&&(response[0].lastRefreshedAt||(response[0].lastRefreshedAt=new Date),lastRefreshedAt=response[0].lastRefreshedAt)),!silentUpdate||!(data.teamId&&!$scope.data.show||!data.teamId&&$scope.data.show||data.teamId&&$scope.data.show&&data.teamId!==$scope.data.show.id||data.managerId&&$scope.data.managerId&&data.managerId!==$scope.data.managerId||dataDate.getTime()!==$scope.d.activitiesSelectedDate.getTime()||dataPeriodType&&$scope.d.periodType&&dataPeriodType!==$scope.d.periodType)){if(updateActivities&&($scope.ui.updateActivitiesData-=1),angular.isDefined(response)&&0===response.length)return $scope.f.showMessage("alert-danger","No team activities available"),$scope.d.team.background=!1,silentUpdate||($scope.ui.isTeamActivitiesLoading=!1),$scope.f.calMaxActTime(peroid),deferred.resolve(),deferred.promise;var calcAdvancedAverPercentage=function(teamPercentages){var team={totalPercentage:0,totalMember:0};return team=_.reduce(teamPercentages,function(team,member){return team.totalPercentage+=member.grouping.alignmentScore,team.totalMember++,team},team),team.totalMember=Math.max(team.totalMember,1),Math.round(team.totalPercentage/team.totalMember)};switch(load){case"time":addNotWorkedMemebers(response,!1),$scope.d.team.time=$filter("orderBy")(response||[],"contractor.printableName"),$scope.d.timeLastRefreshedAt=lastRefreshedAt,$scope.d.timeLastCalledDate=data.date;break;case"percentage":addNotWorkedMemebers(response,!0),$scope.d.team.perc=$filter("orderBy")(response||[],"contractor.printableName"),$scope.d.percLastRefreshedAt=lastRefreshedAt,$scope.d.team.perc=sortBySpendTimeAndGroup($scope.d.team.perc),$scope.d.team.advancedAverage=calcAdvancedAverPercentage($scope.d.team.perc),$scope.d.team.periodMax=_.max($scope.d.team.perc,function(dl){return dl.grouping.totalTrackedTime}).grouping.totalTrackedTime;break;case"background":$scope.d.team.loading=["background2"];break;case"background2":$scope.d.team.background=!1;break;default:type?(addNotWorkedMemebers(response,!0),$scope.d.team.perc=$filter("orderBy")(response||[],"contractor.printableName"),$scope.d.percLastRefreshedAt=lastRefreshedAt,$scope.d.team.perc=sortBySpendTimeAndGroup($scope.d.team.perc),$scope.d.team.advancedAverage=calcAdvancedAverPercentage($scope.d.team.perc),$scope.d.team.periodMax=_.max($scope.d.team.perc,function(dl){return dl.grouping.totalTrackedTime}).grouping.totalTrackedTime,$scope.d.team.loading=["time","switch","background"]):(addNotWorkedMemebers(response,!1),$scope.d.team.time=$filter("orderBy")(response||[],"contractor.printableName"),$scope.d.timeLastRefreshedAt=lastRefreshedAt,$scope.d.team.loading=["percentage","switch","background"])}(silentUpdate||refresh)&&getTeamActivities("switch"),deferred.resolve()}},function(err){updateActivities&&($scope.ui.updateActivitiesData-=1),silentUpdate||$scope.f.productivityErrorHandler(err),deferred.reject(err)}),deferred.promise}function getTimeStringFromIndex(index,end){var hmArr=$scope.f.getHoursMins(index,end),shortHours=hmArr[0]%12===0?12:hmArr[0]%12,ampm=hmArr[0]<12?" am":" pm",timeStr=(1===shortHours.toString().length?"0"+shortHours:shortHours)+":"+(1===hmArr[1].toString().length?"0"+hmArr[1]:hmArr[1])+ampm;return timeStr}function generateOtherActivity(member){var otherActivity={},otherActivities=member.grouping.advancedGroups.filter(function(group){if($scope.d.plan.percentage){var searchedActivity=$scope.d.plan.percentage.find(function(plannedActivity){return plannedActivity.name===group.sectionName});return void 0===searchedActivity||"Other"===searchedActivity.name}});if(otherActivities.length>0){var otherActivitiesSpentTime=otherActivities.map(function(otherActivity){return otherActivity.spentTime});otherActivity.spentTime=otherActivitiesSpentTime.reduce(function(a,b){return a+b})}else otherActivity.spentTime=0;return otherActivity}function loadAssignmentsAndActivities(){$scope.ui.isTeamActivitiesLoading=!0;var from=moment($scope.d.activitiesSelectedDate),to=moment($scope.d.activitiesSelectedDate);"Weekly"===$scope.d.periodType&&(from=moment($scope.d.activitiesSelectedDate).weekday(moment.DAY_OF_WEEK.MONDAY),to=moment($scope.d.activitiesSelectedDate).weekday(moment.DAY_OF_WEEK.SUNDAY));var req={from:from.format(moment.DateFormat.ISO_8601),to:to.format(moment.DateFormat.ISO_8601),managerId:$scope.data.managerId,teamId:$scope.data.teamId,page:0,limit:1e3},l=$scope.d.lastAssignmentReq;return l&&l.teamId===req.teamId&&l.managerId===req.managerId&&l.from===req.from&&l.to===req.to?void($scope.d.team.loading=["all"]):void AssignmentService.assignments(req,function(res){
$scope.assignments=res.content,$scope.d.team.loading=["all"],$scope.d.plan.popup.open=!1,$scope.d.lastAssignmentReq=req})}$scope.d={activityViewMode:$cookies.act_activityViewMode?$cookies.act_activityViewMode:"bar",dateOptions:{formatYear:"yyyy",startingDay:1,showWeeks:!1,showButtonBar:!1,maxDate:moment().startOf("day").toDate()},team:{cur:[],time:[],perc:[],loading:["All"],background:!0},simpleColors:{PRODUCTIVE:"#3fa9fe",COMMUNICATION:"#ffd54f",UNPRODUCTIVE:"#ef5350"},plan:{set:{range:"",man:!1,open:!1},popup:{},loading:!0},appSuggestion:[],tz:"contractorTimeSlots",viewMode:$cookies.act_viewMode?$cookies.act_viewMode:"Advanced",viewType:$cookies.act_viewType?$cookies.act_viewType:"Percentage",periodType:$cookies.act_periodType?$cookies.act_periodType:"Weekly",today:moment().startOf("day").toDate(),activitiesSelectedDate:isNaN(parseInt($routeParams.actDate,10))?new Date:new Date(parseInt($routeParams.actDate,10)),startOfCurrentWeek:moment().utc().startOf("isoweek").toDate()},$scope.ui={isTeamActivitiesLoading:!0,blockActivitiesChange:!1},$scope.msg={clazz:"",show:!1,message:""},$scope.dragControlListeners={containment:"#sortableActivities",containerPositioning:"relative",allowDuplicates:!1,itemMoved:function(eventObj){eventObj.dest.sortableScope.g.act[eventObj.dest.index].category=eventObj.dest.sortableScope.g.name,$scope.$broadcast("dropUpdate",eventObj.dest.sortableScope.g.act[eventObj.dest.index])}},$scope.simpleTable={};var apiAccessErrMsg="Please try again after some time.",cacheUpdateTime=6e5,NUMBER_OF_SLOTS_PER_HOUR=6,activitiesInterval=setInterval(function(){$scope.d.team.loading&&0!==$scope.d.team.loading.length||UtilsService.getWeekOfDate(new Date).weekNumber!==UtilsService.getWeekOfDate($scope.d.activitiesSelectedDate).weekNumber||($scope.f.clearCashedTeamActivities(),getTeamActivities("time",!0,!1),getTeamActivities("percentage",!0,!1))},6e5);$scope.$on("$destroy",function(){clearInterval(activitiesInterval)}),$scope.f={refresh:function(){$scope.f.clearCashedTeamActivities(),getTeamActivities("time",!1,!0),getTeamActivities("percentage",!1,!0),$scope.d.isRefreshDisabled=!0,$scope.d.lastRefreshed=moment(),$timeout(function(){$scope.d.isRefreshDisabled=!1},6e5)},refreshButtonToolTip:function(){var tip="Last update: "+$filter("date")("Percentage"===$scope.d.viewType?$scope.d.percLastRefreshedAt:$scope.d.timeLastRefreshedAt,"dd MMM, yyyy HH:mm");return $scope.d.isRefreshDisabled?tip=tip+"\n You can refresh again in "+(10-moment().diff($scope.d.lastRefreshed,"minutes"))+" minutes":tip+="\n You can refresh once every 10 minutes.",tip},productivityErrorHandler:function(err){if($scope.ui.isTeamActivitiesLoading=!1,$scope.ui.blockActivitiesCategoryChange=!1,$scope.ui.isTeamPlanLoading=!1,$scope.d.team.background=!1,err.data){var msg=""!==err.data.text?err.data.text:apiAccessErrMsg;$scope.f.showMessage("alert-danger",msg)}},showMessage:function(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}},clearCashedTeamActivities:function(){$cacheFactory.get("productivityCache").removeAll()},openCal:function($event){$event.preventDefault(),$event.stopPropagation(),$scope.ui.selectedDateIsOpen=!$scope.ui.selectedDateIsOpen},getHoursMins:function(index,end,mer,ap){var h=Math.floor(index/NUMBER_OF_SLOTS_PER_HOUR),m=index%NUMBER_OF_SLOTS_PER_HOUR*10;return end&&(m>=50?(h+=1,m=0):m+=10),mer?(angular.isDefined(ap)?(ap=h>=12&&"AM"===ap?"PM":ap,ap=h<12&&"PM"===ap?"AM":ap,ap=h>=24&&"PM"===ap?"AM":ap,h=h>12&&"PM"===ap?h-12:h,h=h>=24&&"AM"===ap?12:h):(ap=h>=12?"PM":"AM",h=h>12&&"PM"===ap?h-12:h,h=h>=24&&"AM"===ap?12:h),[h,m,ap]):[h,m]},getContractorTimezone:function(contractor){var str="",conOffset=contractor.location.timeZone.offset,manOffset=$scope.user.location.timeZone.offset;return str=manOffset<=conOffset?"ahead ":"behind ",str=Math.abs((conOffset-manOffset)/36e5).toString()+" h "+str+"you"},contractorTimeSlotString:function(){return getTimeStringFromIndex($scope.ui.selectedSlot,!1)+" - "+getTimeStringFromIndex($scope.ui.selectedSlot,!0)},changeDate:function(d){if(0!==d){"Weekly"===$scope.d.periodType&&(d=7*d);var dt=new Date($scope.d.activitiesSelectedDate),date=$scope.d.activitiesSelectedDate.getDate()+d;dt.setDate(date),$scope.d.activitiesSelectedDate=dt}$location.search("actDate",$scope.d.activitiesSelectedDate.getTime()),loadAssignmentsAndActivities()},dblScroll:function(l,r,set){function setter(){$scope.d.plan.popup.open=!1,$scope.d.plan.popup.locked=!1;var u=angular.element("#planColumn .selected-slot"),ul=u.length,s=angular.element(".planSetter"),t=[];if(ul>0){for(;ul--;){var p=angular.element(u[ul]).offset().top-left.offset().top;p>0&&p<540&&t.push(ul)}if(t.length>0){var modalCorrection=$scope.teamProductivityShow?angular.element(".manager-activities-dashboard > .relative").offset().top-230:0;$scope.d.plan.set.open=!0,s[0].style.top=angular.element(u[t[Math.floor(t.length/2)]]).offset().top-376-modalCorrection+"px",s[0].style.left=angular.element(u[t[Math.floor(t.length/2)]]).width()+133+"px"}else $scope.d.plan.set.open=!1}}var left=angular.element(".planScroll"),right=angular.element("#teamColumn > div > .wrapper");set&&setter(),l&&!r&&(left.bind("scroll",function(el){right.scrollTop(angular.element(el.target).scrollTop()),setter()}),right.unbind("scroll")),!l&&r&&(right.bind("scroll",function(el){left.scrollTop(angular.element(el.target).scrollTop()),setter()}),left.unbind("scroll")),l||r||(left.unbind("scroll"),right.unbind("scroll"))},getWeekText:function(date){var week=UtilsService.getWeekOfDate(date,!1),lastDate=$filter("date")(week.lastDate,"MMM d, yyyy");return $filter("date")(week.firstDate,"MMM d")+" - "+lastDate},showHelper:function(b,e,t,locked){if(!$scope.d.plan.popup.locked||b){if(!b)return $scope.d.selectedGroup=null,$scope.ui.selectedSlot=null,$scope.d.planSelectedGroup=null,$scope.d.plan.popup.open=!1,void($scope.d.plan.popup.percentageEdit=!1);var c=0,l=66,iHeight=locked?25:20,prodDiv=angular.element(".manager-activities-dashboard > .relative").offset();if(angular.isNumber(t)&&(c=190,l=78),angular.isDefined(t.groupItems)){var itemsHeight=t.groupItems.length>10?10:t.groupItems.length;c=170+itemsHeight*iHeight}angular.isDefined(t.time)&&(c=100),$scope.d.plan.popup={x:e.pageX-prodDiv.left-e.offsetX-l,y:e.pageY-prodDiv.top-e.offsetY-c,open:!0,corner:45},locked&&(e.pageX+560-e.view.innerWidth>330&&(e.pageX=e.view.innerWidth-365,e.offsetX=0,$scope.d.plan.popup.corner=100*(e.pageX+560-e.view.innerWidth)/e.view.innerWidth+60),e.view.innerWidth<1520&&e.pageX<213&&(e.pageX=213,e.offsetX=0,$scope.d.plan.popup.corner=100*(e.pageX+560-e.view.innerWidth)/e.view.innerWidth+60),$scope.d.plan.popup.locked=!0,$scope.d.plan.popup.percentageEdit=!0,$scope.d.plan.popup.x=e.pageX-prodDiv.left-e.offsetX-213,$scope.d.plan.popup.y=e.pageY-prodDiv.top-e.offsetY-c+25)}},quickChangeApplication:function(cd,appNewA,appName){$scope.$broadcast("changeApplicationActivity",cd,appNewA,appName)},getIndexesOfSelectedPerc:function(group){group=$filter("orderBy")(group.groupItems||[],"spentTime",!0);for(var j=group.length>10?10:group.length,r=[];j--;){var i=$scope.d.plan.activities.length;for(r.push(-1);i--;){var search=_.find($scope.d.plan.activities[i].productivityApplications,function(pa){return pa.name===group[j].applicationName});angular.isDefined(search)&&(r[j]=i)}}return r},getIsOthersTeamSelected:function(){return $routeParams.otherTeam||!$scope.data.selectedManager||$scope.data.selectedManager.userId!==$scope.user.id},changeActivityViewMode:function(activityViewMode){$scope.d.activityViewMode=activityViewMode.toLowerCase()},searchPlannedTimeForActivity:function(particularGroup){return $scope.d.plan.percentage.find(function(plannedActivity){return plannedActivity.name===particularGroup.name})},searchGroupInContractorGroups:function(searchedGroupName,contractorGroups){if(contractorGroups instanceof Array)return contractorGroups.find(function(contractorGroup){return contractorGroup.sectionName===searchedGroupName})},calculateTeamAverage:function(plannedActivityName){var members=$scope.d.team.perc,timeSum=0;if("Other"!==plannedActivityName){var allSpentTime=members.map(function(member){if(member.grouping&&member.grouping.advancedGroups&&member.grouping.advancedGroups instanceof Array){var memberActivity=member.grouping.advancedGroups.find(function(group){return group.sectionName===plannedActivityName});return void 0!==memberActivity?memberActivity.spentTime:0}return 0});allSpentTime.length>0&&(timeSum=allSpentTime.reduce(function(a,b){return a+b}))}else{var memberOtherActivities=members.map(function(member){return member&&member.grouping&&member.grouping.advancedGroups&&member.grouping.advancedGroups instanceof Array?generateOtherActivity(member).spentTime:0});memberOtherActivities.length>0&&(timeSum=memberOtherActivities.reduce(function(a,b){return a+b}))}return members.length>0?timeSum/members.length:0},calculateSectionTeamAverage:function(sectionName){var members=$scope.d.team.perc,timeSum=0,allSpentTime=members.map(function(member){if(member.grouping&&member.grouping.simpleGroups&&member.grouping.simpleGroups instanceof Array){var memberActivity=member.grouping.simpleGroups.find(function(group){return group.sectionName===sectionName});return void 0!==memberActivity?memberActivity.spentTime:0}return 0});return allSpentTime.length>0&&(timeSum=allSpentTime.reduce(function(a,b){return a+b})),members.length>0?timeSum/members.length:0},searchPlannedGroupInContractorsGroup:function(plannedActivityName,index){var memberActivity,member=$scope.d.team.perc[index];return member&&member.grouping&&member.grouping.advancedGroups&&member.grouping.advancedGroups instanceof Array&&(memberActivity="Other"!==plannedActivityName?member.grouping.advancedGroups.find(function(group){return group.sectionName===plannedActivityName}):generateOtherActivity(member)),void 0!==memberActivity?memberActivity:void 0},sortPlannedActivities:function(){$scope.d.plan.percentage&&($scope.d.plan.percentage=$scope.d.plan.percentage.sort(function(a,b){return b.time-a.time})||[])},downloadCsv:function(){function downloadTable(table,fileName){var downloadLink=angular.element("<a></a>");table.generate(),downloadLink.attr("href",table.link()),downloadLink.attr("download",fileName+".csv"),downloadLink[0].click()}if($scope.d.team.loading.length>0||$scope.ui.isTeamActivitiesLoading||$scope.ui.isTeamPlanLoading||"bar"!==$scope.d.activityViewMode){if("table"===$scope.d.activityViewMode)if("Advanced"===$scope.d.viewMode){var advancedTable=angular.element("#advancedTable").scope().advancedTable;downloadTable(advancedTable,"advancedTable")}else if("Simple"===$scope.d.viewMode){var simpleTable=angular.element("#simpleTable").scope().simpleTable;downloadTable(simpleTable,"simpleTable")}}else $scope.d.team.loading=["download"]},calMaxActTime:function(weekly){angular.isDefined($scope.d.team.periodMax)?(angular.isUndefined($scope.d.plan.totalTime)&&($scope.d.plan.totalTime=0),$scope.d.maxActTime=Math.max($scope.d.team.periodMax,weekly?5*$scope.d.plan.totalTime:1*$scope.d.plan.totalTime),$scope.d.maxActTime<480&&($scope.d.maxActTime=480)):$scope.d.maxActTime=weekly?5*$scope.d.plan.totalTime:1*$scope.d.plan.totalTime}},$scope.$watch("d.viewType",function(nv,ov){var chk=0===$scope.d.team.time.length&&0===$scope.d.team.perc.length&&angular.isDefined(nv)&&0!==$scope.d.team.loading.length||"Weekly"===$scope.d.periodType&&"Time"===nv;return chk?void($scope.d.viewType=ov):($cookies.act_viewType=nv,void(0===$scope.d.team.time.length&&0!==$scope.d.team.perc.length||0!==$scope.d.team.time.length&&0===$scope.d.team.perc.length||($scope.d.team.loading=["switch"],$scope.ui.selectedPlanSlots=[],$scope.d.plan.popup.open=!1,$scope.$broadcast("RemoveSelectClass"),"Time"===nv&&setTimeout(function(){angular.element(".planScroll").scrollTop(430),angular.element("#teamColumn > div > .wrapper").scrollTop(430)},150))))}),$scope.$watch("d.viewMode",function(nv,ov){return 0===$scope.d.team.time.length&&0===$scope.d.team.perc.length&&angular.isDefined(nv)&&0!==$scope.d.team.loading.length&&$scope.d.team.background?void($scope.d.viewMode=ov):($cookies.act_viewMode=nv,void(0===$scope.d.team.time.length&&0!==$scope.d.team.perc.length||0!==$scope.d.team.time.length&&0===$scope.d.team.perc.length||($scope.d.team.loading=["switch"],$scope.ui.selectedPlanSlots=[],$scope.d.plan.popup.open=!1,$scope.$broadcast("RemoveSelectClass"))))}),$scope.$watch("d.periodType",function(nv){$cookies.act_periodType=nv,("Weekly"!==nv&&$scope.d.timeLastCalledDate!==$filter("date")($scope.d.activitiesSelectedDate,"yyyy-MM-dd")||!(0!==$scope.d.team.loading.length||$scope.d.team.background||$scope.ui.isTeamActivitiesLoading||$scope.ui.isTeamPlanLoading))&&("Weekly"===nv?$scope.d.viewType="Percentage":$scope.d.activitiesSelectedDate=$scope.d.activitiesSelectedDate>$scope.d.today?$scope.d.today:$scope.d.activitiesSelectedDate,$scope.d.team.loading=["All"],$scope.ui.selectedPlanSlots=[],$scope.d.plan.popup.open=!1,$scope.$broadcast("RemoveSelectClass"))}),$scope.$watch("d.activityViewMode",function(nv){$cookies.act_activityViewMode=nv}),$scope.$watch("d.team.loading",function(nv){nv&&0!==nv.length&&(getTeamActivities(nv[0]),$scope.d.team.loading.splice(0,1))},!0),$scope.$watch("$parent.data.show",function(nv,ov){nv?($location.search("team",nv.id),$scope.data.teamId=nv.id):($location.search("team",null),$scope.data.teamId=null),nv!==ov&&loadAssignmentsAndActivities()},!0),$scope.$watch("$parent.data.managerId",function(newValue,oldValue){newValue!==oldValue&&($scope.data.managerId=newValue?newValue:null,loadAssignmentsAndActivities())}),loadAssignmentsAndActivities()}]),ctrls.groupProductivityDashboardHelper=function(){return{addToProductivity:function(a,scope){angular.isObject(a)&&scope.data.productivity.push(a)},processApplications:function(categories,scope){var arr=[],resArr=[],total=(categories||[]).reduce(function(ret,x){return angular.isObject(x)&&angular.isDefined(x.totalTime)?(resArr=resArr.concat(x.applications),ret+x.totalTime):ret},0),max=0;(resArr||[]).forEach(function(app){if(angular.isObject(app)&&angular.isDefined(app.applicationName)){var mainAppName=app.applicationName;angular.isDefined(app.xoApplication)&&(mainAppName=app.xoApplication.name);var accApplication=arr[mainAppName];(null===accApplication||angular.isUndefined(accApplication))&&(accApplication={name:mainAppName,time:0},angular.isDefined(app.xoActivity)&&(accApplication.category=app.xoActivity,arr[mainAppName]=accApplication)),angular.isDefined(accApplication.category)&&(accApplication.time=accApplication.time+app.totalTime)}});var apps=[];for(var key in arr)apps.push(arr[key]);return(apps||[]).forEach(function(a){var percentage=a.time/total;max=max<percentage?percentage:max,a.percentage=percentage}),scope.data.maxApplicationsPercentage=max,apps.sort(function(a,b){return b.time-a.time})}}},ctrls.controller("GroupProductivityCtrl",["$scope","$filter","TeamService","UtilsService","$routeParams",function($scope,$filter,TeamService,UtilsService,$routeParams){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:""!==msg,message:msg}}function productivityCallback(result){if(angular.isArray(result)){var categories=[];result.map(function(res){helper.addToProductivity(res,$scope),categories=categories.concat(res.byCategory)}),$scope.data.applications=helper.processApplications(categories,$scope)}$scope.ui.isProductivityLoading=!1}function fetchFailureCallback(err){$scope.ui.isProductivityLoading=!1,$scope.ui.isTimesheetLoading=!1,showMessage("alert-danger",err.data.text)}function loadProductivity(teamIds){var date=isNaN(parseInt($routeParams.actDate,10))?new Date:new Date(parseInt($routeParams.actDate,10));return TeamService.getTeamsProductivity({teamId:teamIds,type:"weekly",date:$filter("date")(UtilsService.getWeekOfDate(date,!1).firstDate,"yyyy-MM-dd"),managerId:$scope.data.managerId}).$promise}function getProductivity(team){$scope.ui.isProductivityLoading=!0;var teamIds="";teamIds=angular.isDefined(team)?team.id:$scope.data.teamIds.join(),loadProductivity(teamIds).then(productivityCallback,fetchFailureCallback)}var helper=ctrls.groupProductivityDashboardHelper();$scope.rParams=$routeParams,$scope.$watch("rParams.actDate",function(){angular.isObject($scope.data.show)?getProductivity($scope.data.show):getProductivity()}),getProductivity($scope.data.show)}]),services.factory("ProductivityWeeklyTimesheet",[function(){var rateTimesheet=function(timesheet){var timesheetRatingRules={high:function(timesheet){return timesheet.hours>=6},average:function(timesheet){return timesheet.hours>=4&&timesheet.hours<6},low:function(timesheet){var isToday=moment().isSame(timesheet.date,"day"),isInPast=moment().isAfter(timesheet.date,"day");return(isToday||isInPast)&&timesheet.hours>=0&&timesheet.hours<4},"not-available":function(timesheet){return moment(timesheet.date).isAfter(moment(),"day")}};return _.chain(timesheetRatingRules).keys().find(function(ruleName){return timesheetRatingRules[ruleName](timesheet)}).value()},WeeklyTimesheet=function(serverSummary){var _this=this;_this.totalHours=serverSummary.totalHours,_.each(serverSummary.stats,function(dailySheet){var date=moment(dailySheet.date).format(moment.DateFormat.ISO_8601),weekend=moment(date).weekday()===moment.DAY_OF_WEEK.SATURDAY||moment(date).weekday()===moment.DAY_OF_WEEK.SUNDAY;_this[date]={date:date,hours:dailySheet.hours,weekend:weekend},_this[date].rate=rateTimesheet(_this[date])})};return WeeklyTimesheet.createEmptySheet=function(monday){var emptySummary={totalHours:0,stats:[]},ALL_WEEK_DAYS=7;return emptySummary.stats=_.chain(ALL_WEEK_DAYS).range().map(function(day){return{date:moment(monday).add(day,"days").format(moment.DateFormat.ISO_8601),hours:0}}).value(),new WeeklyTimesheet(emptySummary)},WeeklyTimesheet}]),services.factory("ProductivityParamResolver",[function(){var resolve=function(teamId,managerId,currentUser){var getManagerId=function(user){var managerAvatar=_.find(user.userAvatars,function(avatar){return"MANAGER"===avatar.type});return managerAvatar.id},DIRECT_REPORT={managerId:getManagerId(currentUser),teamId:null,fullTeam:!1},ALL_MANAGERS={managerId:null,teamId:teamId,fullTeam:!0},TEAM_WITH_MANAGER={managerId:managerId,teamId:teamId,fullTeam:!1};return null===teamId||void 0===teamId?DIRECT_REPORT:null===managerId||void 0===managerId?ALL_MANAGERS:TEAM_WITH_MANAGER};return{resolve:resolve}}]),bandcampApp.directive("productivityTimesheet",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/timesheet/productivity-timesheet.tpl.html",controller:"ProductivityTimesheetCtrl",scope:{selectedTeam:"=",teamId:"=",managerId:"=",currentUser:"=",openDashboard:"=",summaryDate:"="}}}]),ctrls.controller("ProductivityTimesheetCtrl",["$scope","ProductivityWeeklyTimesheet","ProductivityParamResolver","AssignmentService","TeamService","ProfileUtils",function($scope,WeeklyTimesheet,ParamResolver,AssignmentService,TeamService,ProfileUtils){$scope.isLoading=!0;var getAssignments=function(teamId,managerId,timeRange,currentUser){var resolvedParams=ParamResolver.resolve(teamId,managerId,currentUser),req={status:"ACTIVE",managerId:resolvedParams.managerId,fullTeam:resolvedParams.fullTeam,teamId:resolvedParams.teamId,from:timeRange.from,to:timeRange.to};return AssignmentService.teamAssignments(req).$promise.then(function(response){return response.content})},getTimesheets=function(assignments,managerId,timeRange){var teamIds=_.chain(assignments).map(function(assignment){return assignment.team.id}).uniq().value(),fullTeam=!managerId;return TeamService.getWeeklyTimeSheets({teamId:teamIds,managerId:managerId,fullTeam:fullTeam,date:timeRange.from}).$promise.then(function(teams){var summaries=_.chain(teams).map(function(team){return _.values(team)}).flatten().value();return _.map(assignments,function(assignment){var assignmentTimesheet=_.find(summaries,function(summary){return assignment.selection.marketplaceMember.application.candidate.id===summary.user.id}),weeklyTimesheet=assignmentTimesheet?new WeeklyTimesheet(assignmentTimesheet):WeeklyTimesheet.createEmptySheet(timeRange.from);return{id:assignment.id,name:assignment.selection.marketplaceMember.application.candidate.printableName,country:assignment.selection.marketplaceMember.application.candidate.location.country.name,photoUrl:ProfileUtils.profilePhotoUrl(assignment.selection.marketplaceMember.application.candidate),weeklyTimesheet:weeklyTimesheet,left:assignment.isLeft({teamId:$scope.teamId}),lastDay:assignment.getLastDay({teamId:$scope.teamId})}})})},refresh=function(){$scope.isLoading=!0,$scope.error=null,getAssignments($scope.teamId,$scope.managerId,$scope.timeRange,$scope.currentUser).then(function(assignments){return getTimesheets(assignments,$scope.managerId,$scope.timeRange)}).then(function(assignmentsWithTimesheets){$scope.assignments=assignmentsWithTimesheets;var SEVEN_DAYS=7;$scope.dates=_.chain(SEVEN_DAYS).range().map(function(day){return moment($scope.timeRange.from).add(day,"day").format(moment.DateFormat.ISO_8601)}).value()})["catch"](function(error){$scope.error=error})["finally"](function(){$scope.isLoading=!1})};$scope.$watch("pickedDate",function(newPickedDate){moment(newPickedDate).isSame($scope.summaryDate,"day")||($scope.summaryDate=moment(newPickedDate).toDate()),$scope.timeRange={from:moment(newPickedDate).weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),to:moment(newPickedDate).weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)}}),$scope.$watch("summaryDate",function(newSelectedDate){$scope.pickedDate=moment(newSelectedDate).format(moment.DateFormat.ISO_8601)});var throttledRefresh=_.debounce(refresh,20);$scope.$watch("timeRange",throttledRefresh,!0),$scope.$watch("teamId",throttledRefresh),$scope.$watch("managerId",throttledRefresh)}]),ctrls.controller("ManagerDashboardActivitiesPlanCtrl",["$scope","$filter","$uibModal","ProductivityService","$document","$routeParams",function($scope,$filter,$uibModal,ProductivityService,$document,$routeParams){function activitySuccessHandler(){$scope.ui.blockActivitiesChange=!1,$scope.ui.activityDetails=!1,$scope.ui.editActivity=!1,$scope.ui.selectedActivity={},$scope.moveConflictApplication=!1,$scope.msg=null,selectedActivityIndex=-1}function getApplicationByName(appName){for(var i=0;i<managerApplications.length;i++)if(managerApplications[i].name===appName)return managerApplications[i]}function getStartEndSlotIndex(){var startI=$scope.ui.selectedPlanSlots[0],endI=$scope.ui.selectedPlanSlots[$scope.ui.selectedPlanSlots.length-1];return[startI,endI]}function getApplicationActivity(activityApp){for(var i=$scope.d.plan.activities.length;i--;)if(void 0!==$scope.d.plan.activities[i].productivityApplications&&null!==$scope.d.plan.activities[i].productivityApplications&&$filter("indexOfObjectArray")($scope.d.plan.activities[i].productivityApplications,activityApp,["name"])>-1)return $scope.d.plan.activities[i];return null}function setSelectedActivity(){var activityName=$scope.d.plan.actInPlan[$scope.ui.selectedPlanSlots[0]].activity?$scope.d.plan.actInPlan[$scope.ui.selectedPlanSlots[0]].activity.name:"";if(""!==activityName){var activityListIndex=$filter("indexOfObjectArray")($scope.d.plan.activities,activityName,["name"]);$scope.ui.selectedActivity=$scope.d.plan.activities[activityListIndex]}else $scope.ui.selectedActivity={},$scope.ui.activityDetails=!1,$scope.ui.editActivity=!1}function upActCats(n){for(var tl=$scope.d.team.time.length;tl--;)for(var ct=$scope.d.team.time[tl].contractorTimeSlots,mt=$scope.d.team.time[tl].managerTimeSlots,il=$scope.d.team.time[tl].managerTimeSlots.length;il--;)ct[il]&&ct[il].actName===n.name&&(ct[il].catColor=n.catColor),mt[il]&&mt[il].actName===n.name&&(mt[il].catColor=n.catColor);$scope.d.team.loading=["percentage"];var param={managerId:$routeParams.managerId};ProductivityService.readActivities(param,function(rsp){$scope.d.plan.actGrouped=groupActivities(rsp||[]),$scope.d.plan.loading=!1},function(err){$scope.d.plan.loading=!1,$scope.f.productivityErrorHandler(err)})}function addActivity(inputData){return angular.isUndefined(inputData.productivityApplications)?($scope.ui.selectedActivity.errPopup=!0,void setTimeout(function(){$scope.ui.selectedActivity.errPopup=!1},700)):void(angular.isUndefined(inputData.name)||""===inputData.name||ProductivityService.addActivity({swapAliasesIfExist:$scope.moveConflictApplication},inputData,function(response){ProductivityService.readActivities(function(rsp){$scope.d.plan.activities=_.sortBy(rsp||[],"name"),$scope.d.plan.actGrouped=groupActivities($scope.d.plan.activities),$scope.plan.f.setPlan(response),$scope.d.team.loading=["time","percentage"]},function(err){$scope.f.productivityErrorHandler(err)}),activitySuccessHandler()},function(err){$scope.f.productivityErrorHandler(err)}))}function updateActivity(inputData,swapAliasesIfExist){var param={swapAliasesIfExist:$scope.moveConflictApplication||swapAliasesIfExist};ProductivityService.updateActivity(param,inputData,function(){ProductivityService.readActivities(function(rsp){$scope.d.plan.activities=_.sortBy(rsp||[],"name"),$scope.d.plan.actGrouped=groupActivities($scope.d.plan.activities),$scope.plan.f.setPlan($scope.ui.selectedActivity),activitySuccessHandler(),$scope.d.team.loading=["time","percentage"]},function(err){$scope.f.productivityErrorHandler(err)})},function(err){$scope.f.productivityErrorHandler(err)})}function setSetter(){var f12=$scope.f.getHoursMins($scope.ui.selectedPlanSlots[0],!1,!0,$scope.d.plan.set.fp),t12=$scope.f.getHoursMins($scope.ui.selectedPlanSlots[$scope.ui.selectedPlanSlots.length-1],!0,!0,$scope.d.plan.set.tp),f24=$scope.f.getHoursMins($scope.ui.selectedPlanSlots[0]),t24=$scope.f.getHoursMins($scope.ui.selectedPlanSlots[$scope.ui.selectedPlanSlots.length-1],!0);$scope.d.plan.set={time12:{fh:f12[0],fm:f12[1],fp:f12[2],th:t12[0],tm:t12[1],tp:t12[2]},time24:{fh:f24[0],fm:f24[1],th:t24[0],tm:t24[1]}},$scope.f.dblScroll(!0,!1,!0)}function confirmApplicationReplacement(conflictApp,appOwner,appDist){$scope.conflictAppName=conflictApp,$scope.appOwnerAcivityName=appOwner,$scope.appDistAcivityName=appDist,$scope.replaceModal=$uibModal.open({templateUrl:"activity-applications-replace",scope:$scope,backdrop:"static"})}function groupPlannedActivitiesPercent(i){for(var perGrouped=[],tmp={},c=0,planTotalTime=0;i--;)if(angular.isDefined($scope.d.plan.actInPlan[i])&&angular.isDefined($scope.d.plan.actInPlan[i].activity)&&null!==$scope.d.plan.actInPlan[i].activity){var a=$scope.d.plan.actInPlan[i].activity;tmp[a.name]?(perGrouped[tmp[a.name][0]].time=perGrouped[tmp[a.name][0]].time+10,tmp[a.name].push([]),planTotalTime+=10):(tmp[a.name]=[],tmp[a.name].push(c),a.time=10,planTotalTime+=10,perGrouped[c]=a,c++)}return $scope.d.plan.totalTime=planTotalTime<480?480:planTotalTime,$scope.d.maxActTime=Math.max($scope.d.team.periodMax,"Weekly"===$scope.d.periodType?5*$scope.d.plan.totalTime:1*$scope.d.plan.totalTime),$scope.d.maxActTime<480&&($scope.d.maxActTime=480),$filter("orderBy")(perGrouped||[],"time",!0)}function groupActivities(arr){for(var i=arr.length,j=3,actGrouped=[{name:"PRODUCTIVE",color:"#3fa9fe",act:[]},{name:"COMMUNICATION",color:"#ffd54f",act:[]},{name:"UNPRODUCTIVE",color:"#ef5350",act:[]}],sortOrder={PRODUCTIVE:0,COMMUNICATION:1,UNPRODUCTIVE:2};i--;)if(angular.isDefined(arr[i]))if(arr[i].teamsActivitiesCategories&&$scope.data.show){for(var actTeam=arr[i].teamsActivitiesCategories.length,found=!1;actTeam--;)arr[i].teamsActivitiesCategories[actTeam].team.id===$scope.data.show.id&&(actGrouped[sortOrder[arr[i].teamsActivitiesCategories[actTeam].category]].act.push(arr[i]),found=!0);if(found)continue;actGrouped[sortOrder[arr[i].category]].act.push(arr[i])}else actGrouped[sortOrder[arr[i].category]].act.push(arr[i]);for(;j--;)actGrouped[j].act=$filter("orderBy")(actGrouped[j].act||[],"name");return actGrouped}function getApplications(){ProductivityService.readApplications(function(response){$scope.ui.isTeamPlanLoading=!1,0===response.length?$scope.f.showMessage("alert-danger","No applications available"):(managerApplications=response,$scope.d.appSuggestion=response)},function(err){$scope.f.productivityErrorHandler(err)})}function getActivityList(){$scope.ui.isTeamPlanLoading=!0,ProductivityService.readActivities(function(response){$scope.d.plan.activities=_.sortBy(response||[],"name"),$scope.d.plan.actGrouped=groupActivities($scope.d.plan.activities),$scope.ui.isTeamPlanLoading=!1,0===response.length&&$scope.f.showMessage("alert-danger","No activities available"),getApplications()},function(err){$scope.f.productivityErrorHandler(err)})}function getTeamPlannedActivities(){return $scope.data.show&&void 0!==$scope.data.show.id&&$scope.data.show.id?void ProductivityService.readTeamPlannedActivities({teamId:$scope.data.show.id,managerId:$scope.data.managerId},function(response){return 0===response.length?void $scope.f.showMessage("alert-danger","No planned activities available"):($scope.d.plan.actInPlan=$filter("orderBy")(response||[],"startTime"),$scope.d.plan.percentage=groupPlannedActivitiesPercent(response.length),void($scope.d.plan.loading=!1))},function(err){$scope.f.productivityErrorHandler(err),$scope.d.plan.loading=!1}):void($scope.d.plan.loading=!1)}function getIndex(h,m){return Math.round(6*h)+Math.round(m/10)}function chkSetTime(nv){return nv.time12.fh=nv.time12.fm<0&&0!==nv.time12.fh?nv.time12.fh-1:nv.time12.fh,nv.time12.th=nv.time12.tm<0&&0!==nv.time12.th?nv.time12.th-1:nv.time12.th,nv.time12.fm=nv.time12.fm<0&&0!==nv.time12.fh?50:nv.time12.fm,nv.time12.tm=nv.time12.tm<0&&0!==nv.time12.th?50:nv.time12.tm,nv.time12.fh=nv.time12.fm>50?parseInt(nv.time12.fh,10)+1:nv.time12.fh,nv.time12.th=nv.time12.tm>50?parseInt(nv.time12.th,10)+1:nv.time12.th,nv.time12.fm=nv.time12.fm>50?0:nv.time12.fm,nv.time12.tm=nv.time12.tm>50?0:nv.time12.tm,nv.time12.fh=nv.time12.fh<0?0:nv.time12.fh,nv.time12.th=nv.time12.th<0?0:nv.time12.th,nv.time12.fm=nv.time12.fm<0?0:nv.time12.fm,nv.time12.tm=nv.time12.tm<0?0:nv.time12.tm,nv.time12.fh>=nv.time12.th&&nv.time12.fp===nv.time12.tp&&(nv.time12.fh=nv.time12.th,nv.time12.fm=nv.time12.fm>nv.time12.tm?parseInt(nv.time12.tm,10)-10:nv.time12.fm,nv.time12.th=nv.time12.fh),nv.time24.fm=nv.time12.fm,nv.time24.tm=nv.time12.tm,"AM"===nv.time12.fp?nv.time24.fh=nv.time12.fh<12?nv.time12.fh:nv.time24.fh:(nv.time24.fh=nv.time12.fh<13?parseInt(nv.time12.fh,10)+12:nv.time24.fh,nv.time12.fm=12===nv.time12.fh?0:nv.time12.fm,nv.time24.fm=12===nv.time12.fh?0:nv.time24.fm),"AM"===nv.time12.tp?nv.time24.th=nv.time12.th<12?nv.time12.th:nv.time24.th:(nv.time24.th=nv.time12.th<13?parseInt(nv.time12.th,10)+12:nv.time24.th,nv.time12.tm=12===nv.time12.th?0:nv.time12.tm,nv.time24.tm=12===nv.time12.th?0:nv.time24.tm),nv.time12.tp=nv.time24.th>=12?"PM":"AM",nv.time12.fp=nv.time24.fh>=12?"PM":"AM",nv}function normalize(){setTimeout(function(){var wrapper=angular.element("#teamColumn > div > .wrapper"),table=angular.element("#teamColumn > table"),actBlock=angular.element("#teamColumn .wrapper .activity-block"),planScroll=angular.element(".planScroll"),fet=angular.isDefined(actBlock.offset())&&angular.isDefined(wrapper.offset())?actBlock.offset().top-wrapper.offset().top+wrapper.scrollTop():"";wrapper.width(table.width()).scrollTop(fet),planScroll.scrollTop(fet),angular.element(".planScroll").scrollTop(430),wrapper.scrollTop(430)},100),$document.bind("click",function(event){var isPlan=angular.element(".planSetter").find(event.target).length>0||angular.element(".advancedPlan").find(event.target).length>0||angular.element(".modal").find(event.target).length>0||angular.element(event.target).hasClass("planSetter")||angular.element(event.target).hasClass("delActItem")||angular.element(event.target).hasClass("sItem"),isDropdown=angular.element(".changeActivity").find(event.target).length>0,isHelper=angular.element(".popupHelper").find(event.target).length>0||angular.element(event.target).hasClass("popupHelper")||angular.element(event.target).hasClass("activity-block")||angular.element(".pBlock").find(event.target).length>0||angular.element(event.target).hasClass("pBlock")||angular.element(".dropdown-menu li a").find(event.target).length>0;
isPlan||($scope.plan.f.cancelSetPlan(),$scope.d.actSetDropdown=!1),isHelper||($scope.ui.selectedSlot=null,$scope.d.selectedGroup=null,$scope.d.planSelectedGroup=null,$scope.d.selectedGroupMember=null,$scope.d.plan.popup.open=!1,$scope.d.plan.popup.locked=!1),!isDropdown&&angular.isDefined($scope.d.changeData)&&($scope.d.changeData.cDropdown=[])})}var managerApplications=[],NUMBER_OF_SLOTS_PER_HOUR=6,selectedActivityIndex=-1;$scope.plan={f:{getPlanColumnTimeString:function(index){var time=Math.floor(index/NUMBER_OF_SLOTS_PER_HOUR);return time>=0&&time<12?(time=0===time?12:time,time+":00 AM"):(time=12===time?12:time-12,time+":00 PM")},setPlan:function(a){if(null!==$scope.data.show&&null!==$scope.data.team){$scope.f.clearCashedTeamActivities();for(var i=getStartEndSlotIndex()[0],inputData={teamId:$scope.data.show.id};i<=getStartEndSlotIndex()[1];)$scope.d.plan.actInPlan[i].activity=angular.copy(a),i++;ProductivityService.updateTeamActivity(inputData,$scope.d.plan.actInPlan,function(){$scope.d.team.loading=["percentage"],$scope.d.plan.percentage=groupPlannedActivitiesPercent(144),$scope.d.actSetDropdown=!1,$scope.plan.f.cancelSetPlan()},function(err){$scope.f.productivityErrorHandler(err)})}},cancelSetPlan:function(){$scope.ui.selectedPlanSlots=[],$scope.$broadcast("RemoveSelectClass")},goToActivityDetails:function($index){$scope.d.actSetDropdown=!1,$scope.msg=null,$scope.ui.activityDetails=!0,void 0!==$index?($scope.ui.selectedActivity=angular.copy($scope.d.plan.activities[$index]),selectedActivityIndex=$index,$scope.ui.editActivity=!0):($scope.ui.selectedActivity={},selectedActivityIndex=-1)},saveActivity:function(){$scope.f.clearCashedTeamActivities();var inputData=$scope.ui.selectedActivity;$scope.ui.selectedActivity.id?updateActivity(inputData):addActivity(inputData)},cancelEditActivity:function(isEdit){isEdit?($scope.ui.editActivity=!$scope.ui.editActivity,$scope.ui.editActivity||($scope.ui.selectedActivity=angular.copy($scope.d.plan.actInPlan[selectedActivityIndex]),$scope.ui.activityDetails=!1,$scope.d.plan.activityApp="")):($scope.ui.activityDetails=!1,$scope.d.plan.activityApp="",$scope.ui.selectedActivity={})},deleteActivity:function(a){if(angular.isUndefined(a.id))return void activitySuccessHandler();for(var i=144;i--;)angular.isUndefined($scope.d.plan.actInPlan[i].activity)||null===$scope.d.plan.actInPlan[i].activity||$scope.d.plan.actInPlan[i].activity.id===a.id&&delete $scope.d.plan.actInPlan[i].activity;$scope.f.clearCashedTeamActivities(),ProductivityService.updateTeamActivity({teamId:$scope.data.show.id},$scope.d.plan.actInPlan).$promise.then(function(){ProductivityService.deleteActivity({id:$scope.ui.selectedActivity.id}).$promise.then(function(){$scope.ui.selectedActivity={},$scope.ui.activityDetails=!1,$scope.d.plan.activityApp="",$scope.ui.editActivity=!1,$scope.moveConflictApplication=!1,selectedActivityIndex=-1,ProductivityService.readActivities().$promise.then(function(rsp){$scope.d.plan.activities=_.sortBy(rsp||[],"name"),$scope.d.plan.actGrouped=groupActivities($scope.d.plan.activities),$scope.d.plan.percentage=groupPlannedActivitiesPercent(144),$scope.d.team.loading=["time","percentage"]})})})["catch"](function(err){$scope.f.productivityErrorHandler(err)})},addApplication:function(a,replace){var pa=angular.isDefined($scope.ui.selectedActivity.productivityApplications)?$scope.ui.selectedActivity.productivityApplications:[],indexOfAppIActivityAppList=$filter("indexOfObjectArray")(pa,a,["name"]),indexOfAppInManagerAppList=$filter("indexOfObjectArray")(managerApplications,a,["name"]);if(indexOfAppIActivityAppList===-1){var currentApplicationActivity=getApplicationActivity(a);null===currentApplicationActivity||replace?(angular.isUndefined($scope.ui.selectedActivity.productivityApplications)&&($scope.ui.selectedActivity.productivityApplications=[]),$scope.ui.selectedActivity.productivityApplications.push(managerApplications[indexOfAppInManagerAppList]),$scope.d.plan.activityApp=null,$scope.msg=null,null!==currentApplicationActivity&&replace&&($scope.moveConflictApplication=!0)):confirmApplicationReplacement(managerApplications[indexOfAppInManagerAppList].name,currentApplicationActivity.name,$scope.ui.selectedActivity.name)}},removeApplication:function($index){$scope.ui.selectedActivity.productivityApplications.splice($index,1),$scope.msg=null},chSetTime:function(s){s=chkSetTime(s);var sIdx=getIndex(s.time24.fh,s.time24.fm),tIdx=getIndex(s.time24.th,s.time24.tm);sIdx>=tIdx||($scope.ui.selectedPlanSlots=_.range(sIdx,tIdx))}}},$scope.$watch("d.plan.set",function(nv){angular.isDefined(nv)&&angular.isDefined(nv.man)&&nv.man&&$scope.plan.f.chSetTime(nv)},!0),$scope.$on("changeApplicationActivity",function(event,cd,appNewA,appName){$scope.ui.blockActivitiesChange=!0,$scope.f.clearCashedTeamActivities();var app=getApplicationByName(appName);app&&appNewA&&(appNewA.productivityApplications=appNewA.productivityApplications||[],appNewA.productivityApplications.push(app),updateActivity(appNewA,!0),cd.currentActivity=appNewA.name,cd.cDropdown=!1)}),$scope.$on("dropUpdate",function(event,activity){$scope.f.clearCashedTeamActivities(),$scope.d.plan.loading=!0;var param={teamId:$scope.data.show.id,simpleTeamCategory:activity.category};ProductivityService.updateActivity(param,activity,function(d){upActCats(d)},function(err){$scope.d.plan.loading=!1,$scope.f.productivityErrorHandler(err)})}),$scope.$watch("data.show",function(){getActivityList(),getTeamPlannedActivities()},!0),$scope.$watch("data.managerId",function(nv,ov){nv!==ov&&(getActivityList(),getTeamPlannedActivities())}),$scope.$on("SlotsSelectionStart",function(){$scope.d.plan.set.man=!1,$scope.d.plan.popup.open=!1,$scope.ui.activityDetails=!1,$scope.d.plan.activityApp=""}),$scope.$watch("ui.selectedPlanSlots",function(nv){nv&&nv.length>0&&(setSelectedActivity(),setSetter(),$scope.d.plan.set.range=Math.floor(10*nv.length/60)+"h "+10*nv.length%60+"m")}),$scope.$watch("ui.isTeamPlanLoading",function(v){v||normalize()})}]),ctrls.controller("ManagerDashboardTicketsCtrl",["$scope","$timeout","$uibModal","$interval","MetricSettingAuthorization","AssignmentService","TeamService","CurrentUser","DownloadService","routePrefix",function($scope,$timeout,$uibModal,$interval,MetricSettingAuthorization,AssignmentService,TeamService,CurrentUser,DownloadService,routePrefix){function formatLastUpdated(lastUpdated){return lastUpdated?"Updated on "+moment(lastUpdated).format("MMM D")+" at "+moment(lastUpdated).format("h:mm a"):""}function basicConditionsNotMet(){var isDataFine=angular.isDefined($scope.params.teamId)&&$scope.lastWeeks;return!isDataFine||!$scope.activeSetup}$scope.metricDisplay={metricTarget:null,assignments:[],metricsStats:[],weeks:[]},$scope.loadAssignments=function(){$scope.isDataLoading=!0;var timeWindow=TeamService.getTimeWindow(26),req={from:timeWindow.from,to:timeWindow.to,managerId:$scope.params.managerId,teamId:$scope.params.teamId,page:0,limit:1e3};return AssignmentService.assignments(req).$promise.then(function(res){$scope.assignments=res.content})};var loadTeamMetricSetups=function(isSetupUpdated){$scope.error=null,angular.isDefined($scope.params.teamId)&&($scope.isDataLoading=!0,TeamService.get({id:$scope.params.teamId}).$promise.then(function(team){$scope.metricSetups=team.metricsSetups,$scope.team=team,$scope.permission=MetricSettingAuthorization.authorize($scope.cu,$scope.team,$scope.assignments),$scope.activeSetup=_.find(team.metricsSetups,function(setup){return setup.activedMetric&&setup.active}),$scope.hasMetricSetting=!!$scope.activeSetup,$scope.isDataLoading=!1,isSetupUpdated=!!_.isUndefined(isSetupUpdated)||isSetupUpdated,isSetupUpdated&&"MANUAL"!==$scope.activeSetup.type?$scope.refreshMetric():getMetrics()}))};$scope.openMetricSetting=function(){var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:routePrefix+"manager/dashboard/metrics/setting/metric-setting.tpl.html",controller:"MetricSettingCtrl",resolve:{params:function(){return{currentUser:$scope.cu,managerId:$scope.params.managerId,team:$scope.team}}}}),save=function(){loadTeamMetricSetups(!0)};modalInstance.result.then(save)},$scope.lastWeeks=4,$scope.hasMetricSetting=!!$scope.activeSetup,$scope.params={teamId:$scope.$parent.data.show.id,managerId:$scope.$parent.data.managerId},$scope.refreshMetric=function(){$scope.error=null,$scope.waitingTime=0,$scope.progress=0,$scope.isMetricImported=!0;var isTimeout=!1,MAX_TIMEOUT=54,moveProgress=$interval(function(){$scope.waitingTime+=3;var progress=Math.round($scope.waitingTime/MAX_TIMEOUT*100);progress>100?($interval.cancel(moveProgress),isTimeout=!0,$timeout(function(){$scope.isMetricImported=!1,getMetrics()},1500)):$scope.progress=progress},3e3);TeamService.refreshMetric({id:$scope.params.teamId,setupId:$scope.activeSetup.id}).$promise.then(function(refreshedSetup){$interval.cancel(moveProgress),$scope.progress=100,$scope.activeSetup=refreshedSetup,$timeout(function(){$scope.isMetricImported=!1,getMetrics()},1500)})["catch"](function(error){$scope.isMetricImported=!1,$scope.error=isTimeout?null:error})},$scope.downloadReport=function(){var timeWindow=TeamService.getTimeWindow(26),params={managerId:$scope.params.managerId,from:timeWindow.from,to:timeWindow.to,type:$scope.activeSetup.type};DownloadService.download("/teams/"+$scope.params.teamId+"/metric/values",params)};var getMetrics=function(){if(!basicConditionsNotMet()){var timeWindow=TeamService.getTimeWindow($scope.lastWeeks),isRefresh="MANUAL"===$scope.activeSetup.type,req={id:$scope.params.teamId,type:$scope.activeSetup.type,managerId:$scope.params.managerId,from:timeWindow.from,to:timeWindow.to,refresh:isRefresh,costInclusive:!0};$scope.isDataLoading=!0,$scope.lastUpdatedDesc=formatLastUpdated($scope.activeSetup.metricUpdatedOn),$scope.error=null;var promise=TeamService.getMetricValues(req).$promise;promise.then(function(statsPerAssignments){function findAllMondaysBetween(from,to){for(var weeks=[],monday=moment(from).weekday(moment.DAY_OF_WEEK.MONDAY);monday.isBefore(moment(to));)weeks.push(monday.format(moment.DateFormat.ISO_8601)),monday.add(1,"weeks");return weeks}$scope.permission=MetricSettingAuthorization.authorize($scope.cu,$scope.team,$scope.assignments),$scope.metricDisplay.metricTarget=$scope.activeSetup?$scope.activeSetup.metricTarget:null,$scope.metricDisplay.assignments=_.map(statsPerAssignments,function(statsPerAssignment){var assignment=_.chain($scope.assignments).find(function(assignment){return statsPerAssignment.assignmentId===assignment.id}).value();return{id:statsPerAssignment.assignmentId.toString(),name:statsPerAssignment.name,photoUrl:assignment?assignment.realPhotoUrl:null,assignmentHistories:assignment?assignment.assignmentHistories:[],effectiveDateEndInTeam:assignment?AssignmentService.getAssignmentEndDateInTeam(assignment,$scope.params.teamId,$scope.params.managerId):null}}),$scope.metricDisplay.weeks=findAllMondaysBetween(timeWindow.from,timeWindow.to),$scope.metricDisplay.metricsStats=_.chain(statsPerAssignments).map(function(assignment){return _.chain(assignment.stats).map(function(stat){return stat.assignmentId=assignment.assignmentId,stat}).value()}).flatten().value()}),promise["catch"](function(error){$scope.error=error}),promise["finally"](function(){$scope.isDataLoading=!1})}};$scope.$watch("$parent.data.show",function(newTeam,oldTeam){!newTeam||oldTeam===newTeam&&$scope.params.teamId||($scope.params.teamId=newTeam.id,$scope.activeSetup=null,$scope.loadAssignments().then(function(){loadTeamMetricSetups(!1)}))}),$scope.$watch("lastWeeks",function(){getMetrics()}),$scope.$watch("$parent.data.managerId",function(newValue,oldValue){newValue!==oldValue&&($scope.params.managerId=newValue,$scope.loadAssignments().then(getMetrics))}),CurrentUser.get(function(u){$scope.cu=angular.copy(u);var mgr=$scope.cu.userAvatars.filter(function(a){return"MANAGER"===a.type||"COMPANY_ADMIN"===a.type}).pop();mgr&&($scope.cu.managerId=mgr.id),$scope.cu.cAdmin=$scope.cu.avatarTypes.indexOf("COMPANY_ADMIN")>-1,$scope.loadAssignments().then(function(){loadTeamMetricSetups(!1)})})}]),ctrls.controller("ManagerGoalsCtrl",["$scope","$timeout","$q","TeamService","BusinessGoalService","AssignmentService","ManagerService","ManagerGoalsChartsService","ManagerGoalsService","$filter","$uibModal","$routeParams",function($scope,$timeout,$q,TeamService,BusinessGoalService,AssignmentService,ManagerService,ManagerGoalsChartsService,ManagerGoalsService,$filter,$uibModal,$routeParams){function clearError(){managerGoals.data.error={}}function showError(err){err&&err.data&&(managerGoals.data.error=err.data,clearTimeout(managerGoals.data.errorTimeout),managerGoals.data.errorTimeout=setTimeout(function(){clearError()},1e4))}function getStateClasses(){var states=[];for(var key in managerGoals.ui)managerGoals.ui.hasOwnProperty(key)&&managerGoals.ui[key]&&!angular.isArray(managerGoals.ui[key])&&states.push(key);return states}function checkIfTeamOwner(user,owners,teamCompany){var teamownerIds=_.pluck(owners,"id"),userAvatarIds=_.pluck(user.userAvatars,"id"),intersection=_.intersection(teamownerIds,userAvatarIds),isOwner=intersection.length>0,isCompanyAdmin=_.pluck(user.userAvatars,"type").indexOf("COMPANY_ADMIN")>-1&&$scope.userAsManager.company.id===teamCompany.id;return!!isCompanyAdmin||(!!isOwner||void 0)}function getCurrentWeeksStatus(statuses){var lastStatus=_.last(statuses),selectedWeekStart=moment(managerGoals.data.date.dateSelected).startOf("isoweek").format("YYYY-MM-DD");return lastStatus.weekStart===selectedWeekStart?lastStatus:{comments:[],weekStart:selectedWeekStart}}function loadGoals(team,fromDate,toDate){if(!team||!fromDate||!toDate)return $q.reject("loadNewGoals arguments missing");managerGoals.data.selectedGoal={};var format="YYYY-MM-DD",from=fromDate.format(format),to=moment(toDate).format(format),goals=[],statuses=[],requests=[BusinessGoalService.list({teamId:team.id}).$promise,BusinessGoalService.listStatuses({teamId:team.id,from:from,to:to}).$promise];return $q.all(requests).then(function(result){goals=result[0]||[],statuses=result[1]||[],managerGoals.ui.isTeamOwner=checkIfTeamOwner($scope.user,[team.teamOwner],team.company),goals.forEach(function(goal){goal.state={},goal.spreadsheetUrl&&goal.state.isGsheet,goal.totalProgresses=goal.progresses,goal.owners=ManagerGoalsService.getTeamOwners(team),goal.progress=ManagerGoalsService.getCurrentProgress(goal,managerGoals.data.date.dateSelected),goal.progressPercent=ManagerGoalsService.calculateProgressPercent(goal.progress,goal.baseline,goal.target)}),0===statuses.length&&(statuses=[{weekStart:moment(managerGoals.data.date.dateSelected).startOf("isoweek").format("YYYY-MM-DD"),status:null}]),statuses=_.sortBy(statuses,function(s){return moment(s.weekStart)});var status=getCurrentWeeksStatus(statuses),lastUpdated=ManagerGoalsService.getCurrentWeeksLastUpdate(status,goals,managerGoals.data.date.dateSelected);return{goals:goals,status:status,statuses:statuses,formatedStatuses:ManagerGoalsService.formatStatusUpdates(status),minDate:moment(statuses[0].weekStart).startOf("isoweek").toDate(),comments:status.comments,lastUpdated:lastUpdated}})["catch"](function(err){showError(err)})}function fourWeeksBack(date){for(var fromDate=date?moment(date).toDate():moment().toDate(),dates=[],i=1;i<5;i++)dates.push(moment(fromDate).startOf("isoweek").subtract(i,"weeks").format("YYYY-MM-DD").toString());return dates}function fourWeeksAhead(){for(var dates=[],i=0;i<4;i++){var date=moment().startOf("isoweek").add(i,"weeks").toDate();dates.push(date)}return dates}function filterComments(comments){managerGoals.data.comments.ss=[],managerGoals.data.comments.pp=[],managerGoals.data.comments.ae=[],comments&&comments.forEach(function(comment){comment.state={update:!1},"STAFF_FOR_STARS"===comment.category&&managerGoals.data.comments.ss.push(comment),"POUND_THE_PRODUCTIVITY"===comment.category&&managerGoals.data.comments.pp.push(comment),"AUTOMATE_TO_ELIMINATE"===comment.category&&managerGoals.data.comments.ae.push(comment)})}function redrawProgressChart(){managerGoals.data.progressChart=!1,setTimeout(function(){managerGoals.data.progressChart=!0},1)}function redrawCharts(){managerGoals.data.PP.viewMode="table",managerGoals.data.AE.viewMode="table",setTimeout(function(){managerGoals.data.PP.viewMode="chart",managerGoals.data.AE.viewMode="chart"},1)}function handleSelectTeam(team){managerGoals.data.activeTeam=team,managerGoals.ui.isGoalLoading=!0,loadTeam(team,managerGoals.data.date.dateSelected),loadGoals(team,managerGoals.data.date.minDate,managerGoals.data.date.dateSelected).then(function(data){managerGoals.data.goals=data.goals,managerGoals.data.status=data.status,managerGoals.data.formatedStatuses=data.formatedStatuses,managerGoals.data.statuses=data.statuses,managerGoals.data.lastUpdated=data.lastUpdated,filterComments(data.status.comments)})["catch"](function(err){showError(err)})["finally"](function(){managerGoals.ui.isGoalLoading=!1})}function handleTeamsDropdown(){managerGoals.ui.isTeamDropdownOpen=!managerGoals.ui.isTeamDropdownOpen}function getTeamProductivityPromise(team,date){team.teamOwner||(team.teamOwner={id:null});var promise=TeamService.teamProductivitySummary({id:team.id,managerId:team.teamOwner.id,fullTeam:!0,date:moment(date).add(1,"week").format("YYYY-MM-DD"),weeksCount:5}).$promise;return promise}function getTeamAssignmentPromise(team){var from=moment(managerGoals.data.date.dateSelected).subtract(4,"week").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),to=moment(managerGoals.data.date.dateSelected).subtract(1,"week").weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601),promise=AssignmentService.teamAssignments({status:"ACTIVE",fullTeam:!0,teamId:team.id,page:0,limit:1e3,from:from,to:to}).$promise;return promise}function getTeamActivityPromise(team,date){var promise=TeamService.teamAvg({id:team.id,managerId:team.teamOwner.id,fullTeam:!0,date:moment(date).format("YYYY-MM-DD"),weeksCount:1,refresh:!0}).$promise;return promise}function setTeamMetricData(teamMetricsData,teamActivityData){return teamMetricsData?(managerGoals.data.teamMetricData=teamMetricsData,managerGoals.data.teamActivityData=teamActivityData,managerGoals.data.charts.PPChart=ManagerGoalsChartsService.getPPChart(teamMetricsData.ppaeData.ppData,teamActivityData.metricAvg.metricTarget),managerGoals.data.charts.AEChart=ManagerGoalsChartsService.getAEChart(teamMetricsData.ppaeData.aeData),void redrawCharts()):(managerGoals.data.charts.PPChart=ManagerGoalsChartsService.getPPChart(),managerGoals.data.charts.AEChart=ManagerGoalsChartsService.getAEChart(),managerGoals.data.teamMetricData=null)}function loadTeam(team,fromDate){var requests=[getTeamProductivityPromise(team,fourWeeksBack(fromDate)[0]),getTeamAssignmentPromise(team),getTeamActivityPromise(team,fourWeeksBack(fromDate)[0])];managerGoals.ui.isTeamLoading=!0,managerGoals.ui.isGoalSelected=!1,redrawProgressChart(),managerGoals.data.charts.progressChart=ManagerGoalsChartsService.emptyProgressChart(managerGoals.data.date.fourWeeksAhead),$q.all(requests).then(function(res){var teamMetricsData=res[0],teamAssignments=_.map(res[1].content,function(assignment){return assignment.left=assignment.isLeft({teamId:team.id}),assignment.lastDay=assignment.getLastDay({teamId:team.id}),assignment});if(teamMetricsData&&(teamMetricsData.metricsStatsAvg.shift(),teamMetricsData.activityMetricsAvg.shift(),teamMetricsData.weeklyHoursAvg.shift(),teamMetricsData.assignments.length))for(var i=teamMetricsData.assignments.length;i--;)teamMetricsData.assignments[i].metricsStats.shift(),teamMetricsData.assignments[i].weeklyCost.shift(),teamMetricsData.assignments[i].activityMetrics.shift(),teamMetricsData.assignments[i].recordedHours.shift();managerGoals.data.teamAssignments=teamAssignments;var performers=ManagerGoalsService.getTopBottomPerfomer(teamMetricsData.assignments);performers&&(teamMetricsData=_.extend(teamMetricsData,performers));var extendedTeamMetrics=ManagerGoalsService.extendTeamMetricsDataWithTeamAssignments(teamMetricsData,teamAssignments);extendedTeamMetrics.metricsStatsAvg4Weeks=_.reduce(extendedTeamMetrics.metricsStatsAvg,function(memo,num){return memo+num},0)/extendedTeamMetrics.metricsStatsAvg.length,extendedTeamMetrics.ppaeData=ManagerGoalsService.getPPAEData(extendedTeamMetrics,fourWeeksBack(fromDate)),setTeamMetricData(extendedTeamMetrics,res[2])})["catch"](function(err){managerGoals.fn.showError(err)})["finally"](function(){managerGoals.ui.isTeamLoading=!1})}function openGoalsArchiveModal(){var modal=$uibModal.open({size:"lg",templateUrl:"goals-archive-modal.tpl.html",controller:"ManagerGoalsArchiveModalCtrl as vm",windowClass:"manager-goals archive-modal",resolve:{managerGoals:function(){return managerGoals}}});modal.result.then(function(){})}function init(){var promises=[ManagerService.getManager({id:$scope.user.userAvatars.filter(function(a){return"MANAGER"===a.type||"COMPANY_ADMIN"===a.type}).pop().id}).$promise,TeamService.teamsManagersMap({related:!0}).$promise];$q.all(promises).then(function(result){$scope.userAsManager=result[0];var teamsWithOwners=result[1].map(function(team){if(team.teamOwner)return team}).filter(Boolean);teamsWithOwners=$filter("orderBy")(teamsWithOwners||[],"name",!1),managerGoals.data.teams=teamsWithOwners,managerGoals.data.activeTeam=$routeParams.team?teamsWithOwners.filter(function(team){return $routeParams.team===team.id}).pop():teamsWithOwners[0],managerGoals.data.activeTeam?managerGoals.team.handleSelectTeam(managerGoals.data.activeTeam):managerGoals.ui.isGoalLoading=!1})["catch"](function(err){showError(err)})["finally"](function(){managerGoals.ui.isLoading=!1})}var managerGoals=this;managerGoals.data={activeTeam:"",teams:[],date:{dateSelected:moment().toDate(),today:moment().toDate(),currentWeek:ManagerGoalsService.getWeekText(),minDate:moment().startOf("isoweek").add(-12,"weeks"),fourWeeksAhead:fourWeeksAhead()},dateOptions:{showWeeks:!1,startingDay:1},updateBtnText:"Update",goals:[],charts:{progressChart:{},PPChart:{},AEChart:{}},PP:{viewMode:"chart"},AE:{viewMode:"chart"},typewatchTimer:0,comments:{ss:[],pp:[],ae:[]},comment:{ss:null,pp:null,ae:null},selectedGoal:{},error:{errorCode:null,httpStatus:null,text:null,type:null},errorTimeout:0},managerGoals.ui={isLoading:!0,isTeamsLoading:!0,isTeamDropdownOpen:!1,isDatepickerOpen:!1,isThisWeek:!0,isEmptyState:!1,teamLoading:!0,isGoalLoading:!0,isSSUpdate:!1,isPPUpdate:!1,isAEUpdate:!1,isSSComment:!1,isPPComment:!1,isAEComment:!1,isSSLoading:!1,isPPLoading:!1,isAELoading:!1,isGoalSelected:!1,isTeamOwner:!1},managerGoals.team={handleSelectTeam:handleSelectTeam,handleTeamsDropdown:handleTeamsDropdown},managerGoals.fn={getStateClasses:getStateClasses,clearError:clearError,showError:showError,openGoalsArchive:openGoalsArchiveModal,init:init}}]),ctrls.controller("ManagerGoalsLearnMoreModalCtrl",["$scope","$uibModalInstance","content",function($scope,$uibModalInstance,content){$scope.content=content,$scope.close=function(){$uibModalInstance.close()}}]),ctrls.controller("ManagerGoalsActivitiesModalCtrl",["$scope","$uibModalInstance","ProductivityService","managerGoals","$q","ManagerGoalsService",function($scope,$uibModalInstance,ProductivityService,managerGoals,$q,ManagerGoalsService){function makeActivityMatrix(data){if(!data.average.activitiAvg)return data.matrix=null,void($scope.loading=!1);data.team.sort(function(a,b){return a.contractor.printableName-b.contractor.printableName});var res=[{name:"Other",color:"#ef5350",activity:new Array(data.team.length+2).fill(0)}],tmp=["Other"];res=res.concat(data.average.activitiAvg.overWeekPlannedActs.map(function(plan){var d={name:plan.activity.name,color:plan.activity.catColor,activity:new Array(data.team.length+2).fill(0)};return d.activity[0]=plan.actTimeLong,tmp.push(plan.activity.name),d})),data.average.activitiAvg.groupsSummaryAvg.filter(function(avg){tmp.indexOf(avg.sectionName)!==-1?res[tmp.indexOf(avg.sectionName)].activity[1]=avg.spentTime:res[0].activity[1]+=avg.spentTime}),data.team.filter(function(avg,idx){avg.grouping.advancedGroups.filter(function(a){tmp.indexOf(a.sectionName)!==-1?res[tmp.indexOf(a.sectionName)].activity[idx+2]=a.spentTime:res[0].activity[idx+2]+=a.spentTime})}),data.matrix=res,$scope.loading=!1}function getTeamActivityPromise(){var promise=ProductivityService.readGroupedTeamActivities({teamId:managerGoals.data.activeTeam.id,date:moment(managerGoals.data.date.dateSelected).subtract(1,"week").format("YYYY-MM-DD"),weekly:!0,fullTeam:!0,groups:"groups"}).$promise;return promise}function loadActivities(){getTeamActivityPromise().then(function(activityStats){$scope.activities.team=_.map(activityStats,function(stat){var assignment=_.find(managerGoals.data.teamAssignments,function(assignment){return assignment.id===stat.assignmentId});return assignment&&(stat.left=assignment.left,stat.lastDay=assignment.lastDay),stat}),makeActivityMatrix($scope.activities)})}$scope.loading=!0,$scope.activities={team:{},average:managerGoals.data.teamActivityData},$scope.getScoreColor=ManagerGoalsService.getScoreColor,$scope.getScore=function(activity,idx){return 0===idx?100*activity/$scope.activities.average.activitiAvg.weekPlanedTotalLong:1===idx?100*activity/$scope.activities.average.activitiAvg.totalTrackedTimeAvg:100*activity/$scope.activities.team[idx-2].grouping.totalTrackedTime},loadActivities(),$scope.close=function(){$uibModalInstance.close()}}]),ctrls.controller("ManagerGoalsMetricModalCtrl",["$scope","$uibModalInstance","managerGoals","Assignment","MetricsDisplayService",function($scope,$uibModalInstance,managerGoals,Assignment,MetricsDisplayService){var previousMonday=moment(managerGoals.data.date.dateSelected).subtract(1,"week").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),PAST_4_WEEKS=4,weeks=_.map(_.range(PAST_4_WEEKS),function(weekNumber){return moment(previousMonday).subtract(weekNumber,"week").format(moment.DateFormat.ISO_8601)});$scope.metric=managerGoals.data.teamMetricData,$scope.metric.assignments=_.map($scope.metric.assignments,function(assignment){var proxy=new Assignment(assignment);return proxy.refinedMetricsStats=_.map(assignment.metricsStats,function(value,i){var workingCriteria={teamId:managerGoals.data.teamMetricData.id,week:weeks[i]},isActive=proxy.isActive(workingCriteria);return isActive?value:null}),proxy}),$scope.target=managerGoals.data.teamActivityData.metricAvg.metricTarget,$scope.close=function(){$uibModalInstance.close()},$scope.sortOrder={column:"metricsStatsAvg",index:0,reverse:!0},$scope.sortTable=MetricsDisplayService.sortTable}]),ctrls.controller("ManagerGoalsArchiveModalCtrl",["$scope","$uibModalInstance","BusinessGoalService","managerGoals","$document",function($scope,$uibModalInstance,BusinessGoalService,managerGoals,$document){var vm=this;vm.data=managerGoals.data,vm.team=managerGoals.team,vm.ui={showArchived:!0,isTeamDropdownOpen:!1},vm.fn={handleGoalOptions:function(goal,closeAll){if(goal&&goal.isMoreOptionsDropdownOpen)return void(goal.isMoreOptionsDropdownOpen=!1);for(var i=vm.data.goals.length;i--;)vm.data.goals[i].isMoreOptionsDropdownOpen=!1,goal&&goal.id===vm.data.goals[i].id&&!closeAll&&(goal.isMoreOptionsDropdownOpen=!0)},handleArchiveGoal:function(goal){if(goal){goal.state.loading=!0;var params={id:goal.id,team:{id:goal.team.id},owner:{id:goal.owner.id,type:goal.owner.type},name:goal.name,metric:goal.metric,baseline:goal.baseline,target:goal.target,dueDate:goal.dueDate,active:!goal.active,progresses:goal.progresses,spreadsheetUrl:goal.spreadsheetUrl,worksheet:goal.worksheet};BusinessGoalService.update(params).$promise.then(function(archived){managerGoals.data.goals.filter(function(goal){goal.id===archived.id&&(goal.active=!goal.active)}),goal.state.loading=!1})["catch"](function(err){managerGoals.fn.showError(err)})}},getProgressBarColor:function(val){return val<30?"red":val>=30&&val<60?"yellow":""},closeModal:function(){$uibModalInstance.close()}},$document.bind("click",function(event){if(event.target.className.split){var isDropdown=event.target.className.split(" ").indexOf("dropdown")>0;isDropdown||$scope.$apply(function(){vm.ui.isTeamDropdownOpen=!1,vm.fn.handleGoalOptions(null,!0)})}})}]),ctrls.controller("ManagerGoalsTableCtrl",["$scope","$document","$timeout","$uibModal","$q","BusinessGoalService","ManagerGoalsService","ManagerGoalsChartsService",function($scope,$document,$timeout,$uibModal,$q,BusinessGoalService,ManagerGoalsService,ManagerGoalsChartsService){function handleDatepickerClick(goal){goal.isGoalDatepickerOpen=!0}function handleEditGoalClick(goal){goal&&(goal.state.loading=!1,goal.state.edit=!0,goal.edit=angular.copy(goal),goal.edit.dueDate=new Date(goal.edit.dueDate),goal.edit.defaultOwner=_.findWhere(goal.edit.owners,{id:goal.edit.owner.id}),goal.edit.defaultOwner||(goal.edit.defaultOwner=goal.edit.owner),goal.edit.metricSources=[{id:"gsheet",name:"Google Speadsheet"},{id:"manual",name:"Manual"}],goal.edit.spreadsheetUrl?goal.edit.metricSource=goal.edit.metricSources[0]:goal.edit.metricSource=goal.edit.metricSources[1])}function handleCheckinGoalClick(event,goal,force){if(goal&&!goal.state.edit&&!goal.spreadsheetUrl&&$scope.managerGoals.ui.isTeamOwner){var isDropdown=event.target.className.split(" ").indexOf("dropdown")>-1,isButton=event.target.className.split(" ").indexOf("btn")>-1,isParentButton=event.target.parentElement.className.split(" ").indexOf("btn")>-1;(isDropdown||isButton||isParentButton)&&!force||goal.state.checkin||goal.state.edit||(goal.state.checkin=!0,goal.checkinProgress=goal.progress)}}function handleCancelCheckinGoalClick(goal){goal&&(goal.state.checkin=!1)}function handleSaveCheckinGoalClick(goal){function replaceCurrentWeekCheckin(newProgress,progresses){if(!angular.isUndefined(newProgress)){if(angular.isUndefined(progresses))return progresses=[],progresses.push(newProgress),progresses;var weekStarts=_.pluck(progresses,"weekStart"),checkinExists=weekStarts.indexOf(newProgress.weekStart);return checkinExists>-1&&progresses.splice(checkinExists,1),progresses.push(newProgress),progresses}}if(goal){goal.state.loading=!0;var newProgress={weekStart:moment(managerGoals.data.date.dateSelected).startOf("isoweek").format("YYYY-MM-DD"),progress:goal.checkinProgress};goal.progress=goal.checkinProgress,goal.totalProgresses=replaceCurrentWeekCheckin(newProgress,goal.totalProgresses);var checkin={id:goal.id,team:{id:managerGoals.data.activeTeam.id},owner:{id:goal.owner.id,type:goal.owner.type},name:goal.name,metric:goal.metric,baseline:goal.baseline,target:goal.target,dueDate:goal.dueDate,active:goal.active,progresses:goal.totalProgresses,spreadsheetUrl:goal.spreadsheetUrl,worksheet:goal.worksheet};BusinessGoalService.update(checkin).$promise.then(function(res){goal.progressPercent=ManagerGoalsService.calculateProgressPercent(goal.checkinProgress,goal.baseline,goal.target),goal.progress=goal.checkinProgress,goal.progresses=_.sortBy(res.progresses,function(p){return moment(p.weekStart)}),goal.state.isNew=!1,goal.state.checkin=!1,managerGoals.data.lastUpdated=ManagerGoalsService.getCurrentWeeksLastUpdate(managerGoals.data.status,managerGoals.data.goals,managerGoals.data.date.dateSelected),getProgressChart(goal)})["catch"](function(err){managerGoals.fn.showError(err)})["finally"](function(){goal.state.loading=!1,goal.isMoreOptionsDropdownOpen=!1})}}function handleRefreshGoalClick(goal){goal&&(goal.state.loading=!0,BusinessGoalService.update(goal).$promise.then(function(res){goal=_.extend(goal,res),goal.progress=ManagerGoalsService.getCurrentProgress(res,managerGoals.data.date.dateSelected),goal.progressPercent=ManagerGoalsService.calculateProgressPercent(goal.progress,goal.baseline,goal.target)})["catch"](function(err){managerGoals.fn.showError(err)})["finally"](function(){goal.state.loading=!1}))}function handleCancelEditGoalClick(goal){goal&&(goal.state.edit=!1,goal.state.isNew&&(managerGoals.data.goals=_.filter(managerGoals.data.goals,function(x){return x.id!==goal.id})))}function handleSaveEditGoalClick(goal){
if(goal){goal.state.loading=!0;var promise,updatedGoal={},newGoal={},offset=moment(goal.edit.dueDate).utcOffset();goal.edit.dueDate=moment(goal.edit.dueDate).utcOffset(offset).format("YYYY-MM-DD"),goal.state.isNew?(newGoal={team:{id:managerGoals.data.activeTeam.id},owner:{id:goal.edit.defaultOwner.id,type:goal.edit.defaultOwner.type},name:goal.edit.name,metric:goal.edit.metric,baseline:goal.edit.baseline,target:goal.edit.target,dueDate:goal.edit.dueDate,active:goal.edit.active,spreadsheetUrl:goal.edit.spreadsheetUrl,worksheet:goal.edit.worksheet},"manual"===goal.edit.metricSource.id&&(newGoal.spreadsheetUrl=null,newGoal.worksheet=null,newGoal.code=null,newGoal.password=null,newGoal.accessMethod=null,newGoal.gsheetOAuth=null),promise=BusinessGoalService.create(newGoal).$promise):(updatedGoal={id:goal.edit.id,team:{id:managerGoals.data.activeTeam.id},owner:{id:goal.owner.id,type:goal.owner.type},name:goal.edit.name,metric:goal.edit.metric,baseline:goal.edit.baseline,target:goal.edit.target,dueDate:goal.edit.dueDate,active:goal.edit.active,spreadsheetUrl:goal.edit.spreadsheetUrl,worksheet:goal.edit.worksheet,progresses:goal.edit.progresses,code:goal.edit.code,password:goal.edit.password,accessMethod:goal.edit.accessMethod,gsheetOAuth:goal.edit.gsheetOAuth},"manual"===goal.edit.metricSource.id&&(updatedGoal.spreadsheetUrl=null,updatedGoal.worksheet=null,updatedGoal.code=null,updatedGoal.password=null,updatedGoal.accessMethod=null,updatedGoal.gsheetOAuth=null),promise=BusinessGoalService.update(updatedGoal).$promise),promise.then(function(res){goal=_.extend(goal,res),res.spreadsheetUrl||(goal.spreadsheetUrl=null),res.worksheet||(goal.worksheet=null),goal.progress=ManagerGoalsService.getCurrentProgress(goal,managerGoals.data.date.dateSelected),goal.progressPercent=ManagerGoalsService.calculateProgressPercent(goal.progress,goal.baseline,goal.target),goal.checkinProgress=goal.progress||goal.baseline,goal.state.isNew=!1,goal.state.edit=!1,goal.spreadsheetUrl?goal.state.isGsheet=!0:goal.state.isGsheet=!1})["catch"](function(err){managerGoals.fn.showError(err)})["finally"](function(){goal.state.loading=!1,goal.isMoreOptionsDropdownOpen=!1})}}function handleMetricSourceSelect(goal){goal&&"gsheet"===goal.edit.metricSource.id&&gsheetSettings(goal)}function handleArchiveGoalClick(goal){if(goal){goal.state.loading=!0;var params={id:goal.id,team:{id:goal.team.id},owner:{id:goal.owner.id,type:goal.owner.type},name:goal.name,metric:goal.metric,baseline:goal.baseline,target:goal.target,dueDate:goal.dueDate,active:!1,progresses:goal.progresses,spreadsheetUrl:goal.spreadsheetUrl,worksheet:goal.worksheet};BusinessGoalService.update(params).$promise.then(function(archived){managerGoals.data.goals.filter(function(goal){goal.id===archived.id&&(goal.active=!1)}),goal.state.loading=!1})["catch"](function(err){managerGoals.fn.showError(err)})}}function handleSelectedGoal(goal,goals){goal&&goals&&!goal.state.loading&&!goal.state.isNew&&goal.id!==managerGoals.data.selectedGoal.id&&(managerGoals.data.selectedGoal=goal,goals.forEach(function(goal){goal.state.selected=!1}),goal.state.selected=!0,managerGoals.ui.isGoalSelected=!0,getProgressChart(goal))}function getProgressBarColor(percentage){return percentage<30?"red-bar":percentage>=30&&percentage<60?"yellow-bar":"green-bar"}function handleMoreOptionsClick(goal){managerGoals.data.goals=closeMoreOptionsDropdown(managerGoals.data.goals,goal)}function handleRowStateClasses(goal){if(goal){var classes=[];for(var key in goal.state)goal.state.hasOwnProperty(key)&&goal.state[key]&&classes.push(key);if(goal.state.loading&&classes.push("lock-overlay"),goal.spreadsheetUrl&&classes.push("isGsheet"),goal.dueDate){var dueDate=moment(goal.dueDate),now=moment(),hasDatePassed=dueDate.diff(now)<0;hasDatePassed&&100!==goal.progressPercent&&classes.push("targetNotMet"),hasDatePassed&&goal.progressPercent>=100&&classes.push("targetMet")}return classes}}function closeMoreOptionsDropdown(goals,currentGoal){return goals.forEach(function(goal){return currentGoal&&goal.id===currentGoal.id?goal.isMoreOptionsDropdownOpen=!0:void(goal.isMoreOptionsDropdownOpen=!1)}),goals}function mapProgressPercentAndDate(goal){var passedDate=moment(goal.dueDate).diff(moment(goal.createdOn)),dueDate=passedDate>1?moment(goal.dueDate).valueOf():moment(goal.createdOn).valueOf();if(!goal.progresses||0===goal.progresses.length)return{progressAndDate:[{x:moment(goal.createdOn).valueOf(),y:0}],dueDate:dueDate,startDate:moment(goal.createdOn).valueOf()};var progressAndDate=goal.progresses.map(function(progress){var percent=ManagerGoalsService.calculateProgressPercent(progress.progress,goal.baseline,goal.target),date=moment(progress.weekStart).valueOf();return percent=percent>=100?100:percent,{x:date,y:percent}}),createdOn=moment(goal.createdOn),firstUpdate=moment(goal.progresses[0].weekStart),diff=createdOn.diff(firstUpdate,"milliseconds"),startDate=createdOn;return diff>=0&&(startDate=firstUpdate),{progressAndDate:progressAndDate,dueDate:dueDate,startDate:moment(startDate).valueOf()}}function gsheetSettings(goal){var modal=$uibModal.open({size:"lg",templateUrl:"gsheetSettings.tpl.html",controller:"ManagerGoalSpreadsheetCtrl",resolve:{team:function(){return managerGoals.data.activeTeam},goal:function(){return goal}}});modal.result.then(function(gSheetSettings){goal.edit=_.extend(goal.edit,gSheetSettings)})}function redrawProgressChart(){managerGoals.data.progressChart=!1,$timeout(function(){managerGoals.data.progressChart=!0},100)}function getProgressChart(goal){redrawProgressChart();var opt=mapProgressPercentAndDate(goal),tickInterval=ManagerGoalsChartsService.getTickInterval(opt.startDate,opt.dueDate),options=ManagerGoalsChartsService.getProgressChart(opt,tickInterval);managerGoals.data.charts.progressChart=options}var goals=this,managerGoals=$scope.managerGoals;goals.fn={handleNewGoalClick:ManagerGoalsService.handleNewGoalClick,handleArchiveGoalClick:handleArchiveGoalClick,handleRowStateClasses:handleRowStateClasses,handleEditGoalClick:handleEditGoalClick,handleSaveEditGoalClick:handleSaveEditGoalClick,handleCancelEditGoalClick:handleCancelEditGoalClick,handleMetricSourceSelect:handleMetricSourceSelect,getProgressBarColor:getProgressBarColor,handleMoreOptionsClick:handleMoreOptionsClick,handleCheckinGoalClick:handleCheckinGoalClick,handleCancelCheckinGoalClick:handleCancelCheckinGoalClick,handleSaveCheckinGoalClick:handleSaveCheckinGoalClick,handleRefreshGoalClick:handleRefreshGoalClick,handleSelectedGoal:handleSelectedGoal,handleDatepickerClick:handleDatepickerClick},function(){$document.bind("click",function(event){if(event.target.className.split){var isDropdown=event.target.className.split(" ").indexOf("dropdown")>0;isDropdown||$scope.$apply(function(){managerGoals.ui.isTeamDropdownOpen=!1,managerGoals.data.goals=closeMoreOptionsDropdown(managerGoals.data.goals)})}})}()}]),services.factory("ManagerGoalsService",function(){function getTeamOwners(team){return _.isArray(team.teamOwner)?team.teamOwner:[team.teamOwner]}function handleNewGoalClick(goals,team){goals||(goals=[]);var id=Math.floor(1e4*Math.random()),newGoal={state:{edit:!0,isNew:!0},edit:{owners:getTeamOwners(team),defaultOwner:getTeamOwners(team)[0],metricSources:[{id:"gsheet",name:"Google Speadsheet"},{id:"manual",name:"Manual"}]},active:!0,id:id};newGoal.edit.metricSource=newGoal.edit.metricSources[1],goals.unshift(newGoal)}function getCurrentWeeksLastUpdate(status,goals,dateSelected){var goalsLastUpdate=_.pluck(goals,"updatedOn"),statusLastUpdate=[status.updatedOn],lastUpdate=_.last(_.sortBy(_.union(goalsLastUpdate,statusLastUpdate).filter(Boolean),function(date){return date})),weekStart=moment(dateSelected).startOf("isoweek"),thisDate=moment(lastUpdate),difference=thisDate.diff(weekStart);if(difference>=0)return lastUpdate}function getWeekText(dateSelected){var m=moment(dateSelected).startOf("isoweek"),format="MMM DD";return m.format(format)+" - "+m.add(6,"days").format("MMM DD, YYYY")}function getCurrentProgress(goal,dateSelected){var progress=goal.baseline;if(goal.progresses.length>0){goal.progresses=_.sortBy(goal.progresses,function(p){return moment(p.weekStart)}),goal.progresses=goal.progresses.map(function(p){if(p.progress>0)return p}).filter(Boolean),goal.progresses=_.filter(goal.progresses,function(p){var toDate=moment(dateSelected).startOf("isoweek"),thisDate=moment(p.weekStart);if(toDate.diff(thisDate)>=0)return moment(p.weekStart)});var lastProgress=_.last(goal.progresses);progress=lastProgress?lastProgress.progress:goal.baseline}return progress}function extendTeamMetricsDataWithTeamAssignments(teamMetricsData,teamAssignmentsData){var teamMemberData=teamMetricsData.assignments.slice();return teamMetricsData.assignments=_.map(teamAssignmentsData,function(assignment){var assignmentMetric=_.find(teamMemberData,function(assignmentMetric){return assignmentMetric.id===assignment.id});return assignmentMetric=assignmentMetric||{},_.extend(assignmentMetric,assignment)}),teamMetricsData}function calculateProgressPercent(current,baseline,target){var progressProcent=Math.round((current-baseline)/(target-baseline)*100);return progressProcent<0&&(progressProcent=0),progressProcent}function urlify(text){var urlRegex=/(((https?:\/\/)|(www\.))[^\s]+)/g;return text.replace(urlRegex,function(url,b,c){var url2="www."===c?"http://"+url:url;return'<a href="'+url2+'" target="_blank">'+url+"</a>"})}function getListView(arr){for(var rem=0,tmp=[],i=0;i<arr.length;i++)arr[i+1]&&"-"===arr[i+1][0]&&(arr[i]=urlify(arr[i]),arr[i+1]=urlify(arr[i+1]),"-"!==arr[i][0]&&(rem=i,arr[i]="<p>"+arr[i]+"</p>"),arr[rem]+="<li>"+arr[i+1].slice(1)+"</li>",tmp.push(i+1));return arr.filter(function(item,idx){if(tmp.indexOf(idx)===-1)return item})}function formatStatusUpdates(statuses){var formatedStatuses={poundTheProductivity:[],automateToEliminate:[],staffForStars:[]},arr=["staffForStars","poundTheProductivity","automateToEliminate"];for(var variable in statuses)statuses.hasOwnProperty(variable)&&arr.indexOf(variable)>-1&&(formatedStatuses[variable]=statuses[variable].split("\n").map(function(item){if(item.length>0)return item}).filter(Boolean),formatedStatuses[variable]=getListView(formatedStatuses[variable]));return formatedStatuses}function getTopBottomPerfomer(team){var newTeam=team.slice(),teamWithTeammemberAvg=newTeam.map(function(member){return member.metricsStats&&(member.metricsStatsAvg=_.reduce(member.metricsStats,function(memo,num){return memo+num},0)/member.metricsStats.length),member}),highPerformer=_.max(teamWithTeammemberAvg,function(member){return member.metricsStatsAvg}),lowPerformer=_.min(teamWithTeammemberAvg,function(member){return member.metricsStatsAvg});if(highPerformer&&lowPerformer)return{highPerformer:highPerformer,lowPerformer:lowPerformer,assignments:newTeam}}function getTeamCostAvg(teamCost){return _.reduce(teamCost,function(memo,num){return memo+num},0)/teamCost.length}function getTeamCost(teamMetrics){for(var teamCost=teamMetrics.assignments.map(function(member){return member.weeklyCost}),arr=[],i=0;i<teamCost.length;i++)for(var x=0;x<teamCost[i].length;x++)_.isArray(arr[x])?arr[x].push(teamCost[i][x]):arr[x]=[teamCost[i][x]];return teamCost=arr.map(function(metric){return _.reduce(metric,function(memo,num){return memo+num},0)}),0===teamCost.length&&(teamCost=[0,0,0,0]),teamCost}function getCostPerUnit(teamCost,totalMetrics){var costPerUnit=teamCost;return totalMetrics&&(costPerUnit=teamCost/totalMetrics),costPerUnit}function getTotalMetrics(teamMetrics){for(var totalMetrics=teamMetrics.assignments.map(function(member){return member.metricsStats}),arr=[],i=0;i<totalMetrics.length;i++)for(var x=0;x<totalMetrics[i].length;x++)_.isArray(arr[x])?arr[x].push(totalMetrics[i][x]):arr[x]=[totalMetrics[i][x]];return totalMetrics=arr.map(function(metric){return _.reduce(metric,function(memo,num){return memo+num},0)}),0===totalMetrics.length&&(totalMetrics=[0,0,0,0]),totalMetrics}function getPPAEData(teamMetrics,dates){var metricsStatsAvg=teamMetrics.metricsStatsAvg,activityMetricsAvg=teamMetrics.activityMetricsAvg,teamMembers=teamMetrics.assignments,weeklyHoursAvg=teamMetrics.weeklyHoursAvg,totalMetrics=getTotalMetrics(teamMetrics),teamCost=getTeamCost(teamMetrics),teamCostAvg=getTeamCostAvg(teamCost),ppData=dates.map(function(date,i){return{date:date,dateEnd:moment(date).endOf("isoweek").format("YYYY-MM-DD"),metricsStatsAvg:metricsStatsAvg[i],activityMetricsAvg:activityMetricsAvg[i],teamMembers:teamMembers.length,weeklyHoursAvg:weeklyHoursAvg[i],totalMetrics:totalMetrics[i]}}),aeData=dates.map(function(date,i){return{date:date,dateEnd:moment(date).endOf("isoweek").format("YYYY-MM-DD"),metricsStatsAvg:metricsStatsAvg[i],activityMetricsAvg:activityMetricsAvg[i],teamMembers:teamMembers.length,weeklyHoursAvg:weeklyHoursAvg[i],teamCost:teamCost[i],totalUnits:totalMetrics[i],costPerUnit:getCostPerUnit(teamCost[i],totalMetrics[i])}}),ssData={teamCostAvg:teamCostAvg,metricTarget:0|teamMetrics.metricTarget};return{ssData:ssData,ppData:ppData,aeData:aeData}}function getScoreColor(score){return score<30?"red":score>=30&&score<70?"yellow":""}return{getPPAEData:getPPAEData,getTopBottomPerfomer:getTopBottomPerfomer,formatStatusUpdates:formatStatusUpdates,calculateProgressPercent:calculateProgressPercent,extendTeamMetricsDataWithTeamAssignments:extendTeamMetricsDataWithTeamAssignments,getCurrentProgress:getCurrentProgress,getWeekText:getWeekText,getCurrentWeeksLastUpdate:getCurrentWeeksLastUpdate,handleNewGoalClick:handleNewGoalClick,getTeamOwners:getTeamOwners,getScoreColor:getScoreColor,urlify:urlify}}),ctrls.controller("ManagerGoalSpreadsheetCtrl",["$scope","$uibModalInstance","BusinessGoalService","team","goal",function($scope,$uibModalInstance,BusinessGoalService,team,goal){var AUTH_CODE_PLACEHOLDER="XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX";$scope.ui={authUrl:null,isLoading:!1,err:null},BusinessGoalService.getSpreadsheetAuthUrl().then(function(res){$scope.ui.authUrl=res.data}),$scope.data={goal:goal||{team:{id:team.id},worksheet:"Crossover Business Goals",gsheetOAuth:!1}},$scope.data.goal.accessMethod=$scope.data.goal.gsheetOAuth?"oauth":"share",$scope.data.goal.code=$scope.data.goal.gsheetOAuth?AUTH_CODE_PLACEHOLDER:null,$scope.cancel=function(){$uibModalInstance.dismiss()},$scope.submit=function(){if($scope.form.$valid){var data={spreadsheetUrl:$scope.data.goal.spreadsheetUrl,accessMethod:$scope.data.goal.accessMethod,worksheet:$scope.data.goal.worksheet,code:$scope.data.goal.code,active:!0};"oauth"===data.accessMethod&&(data.password=data.code),$uibModalInstance.close(data)}}}]),services.factory("ManagerGoalsChartsService",function(){function getTickInterval(startDate,dueDate){var start=moment.unix(startDate/1e3),end=moment.unix(dueDate/1e3),difference=end.diff(start,"milliseconds"),differenceDivBy4=difference/4;return differenceDivBy4}function getProgressChart(opt,tickInterval){return{options:{chart:{type:"area"},legend:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return moment(this.value).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"}},minPadding:0,maxPadding:0,startOnTick:!1,endOnTick:!1,reversed:!1,lineWidth:0,tickWidth:0,tickInterval:tickInterval,gridLineWidth:0,gridLineColor:"#ececed",offset:5},yAxis:{tickWidth:0,gridLineWidth:0,offset:10,labels:{enabled:!0,style:{"font-size":"10px",color:"#b2b4b6"}},min:0,max:100,tickInterval:10,gridLineColor:"#ececed",title:{text:""}},series:[{type:"line",data:[{x:opt.startDate,y:0},{x:opt.dueDate,y:100}],zIndex:1,dashStyle:"ShortDash",lineColor:"#dddddd",marker:{enabled:!1},enableMouseTracking:!1},{type:"area",tooltip:{pointFormatter:function(){var percent=this.y+"%";this.category=percent+", "+moment.unix(this.x/1e3).format("MMM DD")}},zIndex:3,lineColor:"#22aae4",fillColor:"rgba(34, 170, 228,0.1)",marker:{fillColor:"rgb(34, 170, 228)",symbol:"circle"},data:opt.progressAndDate},{enableMouseTracking:!1,zIndex:2,data:[{x:opt.startDate,y:0,id:"flag",marker:{height:20,width:20,symbol:"url(/images/80bd758d.flag.png)"}}]}]}}function emptyProgressChart(fourWeeksAhead){var options={options:{chart:{type:"area"},legend:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",offset:15,tickInterval:1,startOnTick:!0,lineWidth:0,tickWidth:0,gridLineWidth:0,tickAmount:3,labels:{enabled:!0,formatter:function(){return moment(fourWeeksAhead[this.value]).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"},padding:0}},yAxis:{tickWidth:0,gridLineWidth:0,labels:{enabled:!0,style:{"font-size":"10px",color:"#b2b4b6"}},min:0,max:100,tickInterval:10,gridLineColor:"#ececed",title:{text:""}},series:[{type:"line",data:[[0,0],[3,100]],zIndex:1,dashStyle:"ShortDash",lineColor:"#dddddd",marker:{enabled:!1},enableMouseTracking:!1},{enableMouseTracking:!1,zIndex:2,data:[{x:0,y:0,id:"flag",marker:{height:20,width:20,symbol:"url(/images/80bd758d.flag.png)"}}]},{enableMouseTracking:!1,zIndex:2,data:[{x:3,y:100,id:"flag",marker:{height:7,width:7,symbol:"url(/images/0e472bfe.circle.png)"}}]}]};return options}function getPPChart(dateRange,target){if(dateRange){var dataSet=dateRange.map(function(data){return data.metricsStatsAvg}),dates=dateRange.map(function(data){if(data.date)return moment(data.dateEnd).format("MMM DD")}),maxYValue=_.max(dataSet,function(value){return value})+3,average=dateRange.map(function(data,i){var avg=_.reduce(dataSet,function(a,b){return a+b},0)/dataSet.length;return[i,avg]}),chart={options:{chart:{type:"area"},legend:{enabled:!1}},title:{text:""},subtitle:{text:""},yAxis:{labels:{enabled:!1},gridLineWidth:0,min:0,max:maxYValue,title:{text:""},offset:10},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return dates[this.value]},style:{"font-size":"10px",color:"#b2b4b6"}},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,lineWidth:1,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},series:[{fillColor:"rgba(34, 170, 228,0.1)",data:dataSet,zIndex:2,lineColor:"#22aae4",enableMouseTracking:!1,marker:{fillColor:"rgb(34, 170, 228)"},dataLabels:{enabled:!0,style:{color:"#22aae4",textShadow:"0px",fontSize:"14px"},format:"{point.y:,.1f}"}},{type:"line",data:[target,target,target,target],zIndex:1,dashStyle:"ShortDot",lineColor:"#dddddd",marker:{enabled:!1},enableMouseTracking:!1},{enableMouseTracking:!1,zIndex:2,visible:!!target,data:[{x:average.length-1,y:target,id:"target",marker:{height:20,width:20,symbol:"url(/images/5dcb4203.target-goal.png)"}}]}]};return chart}}function getAEChart(dateRange){if(dateRange){var dataSet=dateRange.map(function(data){return data.costPerUnit}),dates=dateRange.map(function(data){if(data.date)return moment(data.dateEnd).format("MMM DD")}),maxYValue=_.max(dataSet,function(value){return value})+200,chart={options:{chart:{type:"area"},legend:{enabled:!1}},title:{text:""},subtitle:{text:""},yAxis:{labels:{enabled:!1},gridLineWidth:0,min:0,max:maxYValue,title:{text:""}},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return dates[this.value]},style:{"font-size":"10px",color:"#b2b4b6"}},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,lineWidth:1,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},series:[{fillColor:"rgba(34, 170, 228,0.1)",data:dataSet,lineColor:"#22aae4",enableMouseTracking:!1,marker:{fillColor:"rgb(34, 170, 228)"},dataLabels:{enabled:!0,style:{color:"#22aae4",textShadow:"0px",fontSize:"14px"},format:"{point.y:,.1f}"}}]};return chart}}return{getAEChart:getAEChart,getPPChart:getPPChart,emptyProgressChart:emptyProgressChart,getProgressChart:getProgressChart,getTickInterval:getTickInterval}}),ctrls.controller("ManagerGoalsHeaderCtrl",["$scope","$timeout","ManagerGoalsService",function($scope,$timeout,ManagerGoalsService){function handleDatepickerChange(){managerGoals.team.handleSelectTeam(managerGoals.data.activeTeam),managerGoals.data.date.currentWeek=ManagerGoalsService.getWeekText(managerGoals.data.date.dateSelected),managerGoals.data.date.currentWeek===managerGoals.data.date.thisWeek?managerGoals.ui.isThisWeek=!0:managerGoals.ui.isThisWeek=!1}function handleChangeDate(inc){var newDate,oldDate=moment(managerGoals.data.date.dateSelected).startOf("isoweek").toDate();newDate=inc>0?moment(oldDate).add(7,"d"):moment(oldDate).subtract(7,"days"),moment(newDate).format("x")<moment().format("x")?managerGoals.data.date.dateSelected=newDate.toDate():managerGoals.data.date.dateSelected=managerGoals.data.date.today,handleDatepickerChange(newDate.toDate())}var header=this,managerGoals=$scope.managerGoals;header.fn={handleDatepickerChange:handleDatepickerChange,handleChangeDate:handleChangeDate,handleNewGoalClick:ManagerGoalsService.handleNewGoalClick}}]),ctrls.controller("ManagerGoalsStatusCtrl",["$scope","$timeout","BusinessGoalService","ManagerGoalsService","$uibModal",function($scope,$timeout,BusinessGoalService,ManagerGoalsService,$uibModal){function typewatch(string,cb,time){time=time||1e3,clearTimeout(managerGoals.data.typewatchTimer),managerGoals.data.typewatchTimer=setTimeout(function(){if(string)return cb()},time)}function openLearnMoreModal(type){if(type){var modal=$uibModal.open({size:"md",templateUrl:"learn-more-modal.tpl.html",controller:"ManagerGoalsLearnMoreModalCtrl",windowClass:"manager-goals",resolve:{content:function(){return status.data.learnMore[type]}}});modal.result.then(function(){})}}function openActivitiesModal(){var modal=$uibModal.open({size:"lg",templateUrl:"activities-modal.tpl.html",controller:"ManagerGoalsActivitiesModalCtrl",windowClass:"manager-goals activities-modal",resolve:{managerGoals:function(){return managerGoals}}});modal.result.then(function(){})}function openMetricModal(){var modal=$uibModal.open({size:"lg",templateUrl:"metric-modal.tpl.html",controller:"ManagerGoalsMetricModalCtrl",windowClass:"manager-goals activities-modal",resolve:{managerGoals:function(){return managerGoals}}});modal.result.then(function(){})}function getTime(time){return moment(time).format("LT")}function handleUpdateStatusClick(type,event){managerGoals.ui.isTeamOwner&&"a"!==event.target.tagName.toLowerCase()&&("ss"===type&&(managerGoals.ui.isSSUpdate=!0),"pp"===type&&(managerGoals.ui.isPPUpdate=!0),"ae"===type&&(managerGoals.ui.isAEUpdate=!0))}function handleViewModeClick(viewMode,type){viewMode&&type&&(managerGoals.data[type].viewMode=viewMode)}function handleStatusUpdateClick(){updateStatus().then(function(res){managerGoals.data.status.updatedOn=res.updatedOn,managerGoals.data.formatedStatuses=ManagerGoalsService.formatStatusUpdates(managerGoals.data.status),managerGoals.data.lastUpdated=ManagerGoalsService.getCurrentWeeksLastUpdate(managerGoals.data.status,managerGoals.data.goals)})["catch"](function(err){managerGoals.fn.showError(err)})}function handleStatusUpdateKeypress(update){typewatch(update,function(){updateStatus().then(function(res){managerGoals.data.status.updatedOn=res.updatedOn,managerGoals.data.formatedStatuses=ManagerGoalsService.formatStatusUpdates(managerGoals.data.status),managerGoals.data.lastUpdated=ManagerGoalsService.getCurrentWeeksLastUpdate(managerGoals.data.status,managerGoals.data.goals)})["catch"](function(err){managerGoals.fn.showError(err)})},1e3)}function getIndicatorColor(target,metric){if(!angular.isUndefined(target)&&!angular.isUndefined(metric)){var newMetric=angular.copy(metric);return newMetric=Math.round(newMetric),newMetric>target?"green":newMetric===target?"yellow":newMetric<target?"red":void 0}}function handleAddCommentClick(type){"ss"===type&&(managerGoals.ui.isSSComment=!0),"pp"===type&&(managerGoals.ui.isPPComment=!0),"ae"===type&&(managerGoals.ui.isAEComment=!0)}function handleCancelCommentClick(type){"ss"===type&&(managerGoals.ui.isSSComment=!1,managerGoals.data.comment.ss=null),"pp"===type&&(managerGoals.ui.isPPComment=!1,managerGoals.data.comment.pp=null),"ae"===type&&(managerGoals.ui.isAEComment=!1,managerGoals.data.comment.ae=null)}function handlePostCommentClick(type){managerGoals.fn.clearError();var params={status:{team:{id:managerGoals.data.activeTeam.id},weekStart:moment(managerGoals.data.date.dateSelected).startOf("isoweek").format("YYYY-MM-DD")},category:null,content:null};"ss"===type&&(params.category="STAFF_FOR_STARS",params.content=managerGoals.data.comment.ss,managerGoals.ui.isSSLoading=!0),"pp"===type&&(params.category="POUND_THE_PRODUCTIVITY",params.content=managerGoals.data.comment.pp,managerGoals.ui.isPPLoading=!0),"ae"===type&&(params.category="AUTOMATE_TO_ELIMINATE",params.content=managerGoals.data.comment.ae,managerGoals.ui.isAELoading=!0),BusinessGoalService.postComment(params).$promise.then(function(res){res.state={},"ss"===type&&(managerGoals.data.comments.ss.push(res),managerGoals.data.comment.ss=null,managerGoals.ui.isSSComment=!1),"pp"===type&&(managerGoals.data.comments.pp.push(res),managerGoals.data.comment.pp=null,managerGoals.ui.isPPComment=!1),"ae"===type&&(managerGoals.data.comments.ae.push(res),managerGoals.data.comment.ae=null,managerGoals.ui.isAEComment=!1)})["catch"](function(err){managerGoals.fn.showError(err),"ss"===type&&(managerGoals.ui.isSSComment=!0,managerGoals.ui.isSSLoading=!1),"pp"===type&&(managerGoals.ui.isPPComment=!0,managerGoals.ui.isPPLoading=!1),"ae"===type&&(managerGoals.ui.isAEComment=!0,managerGoals.ui.isAELoading=!1)})["finally"](function(){"ss"===type&&(managerGoals.ui.isSSLoading=!1),"pp"===type&&(managerGoals.ui.isPPLoading=!1),"ae"===type&&(managerGoals.ui.isAELoading=!1)})}function handlePostEditCommentClick(comment){comment.state.isLoading=!0;var weekStart=moment(managerGoals.data.date.dateSelected).startOf("isoweek").format("YYYY-MM-DD"),params={id:comment.id,status:{team:{id:managerGoals.data.activeTeam.id},weekStart:weekStart},category:comment.category,content:comment.edit.content};BusinessGoalService.updateComment(params).$promise.then(function(res){comment.content=res.content,comment.state.update=!1,comment.edit=null})["catch"](function(err){managerGoals.fn.showError(err)})["finally"](function(){comment.state.isLoading=!1})}function handleCancelEditCommentClick(comment){comment.state.update=!1,comment.edit=null}function handleUpdateCommentClick(comment){$scope.user.id===comment.manager.userId&&(comment.edit=angular.copy(comment),comment.state.update=!0)}function handleStateClasses(comment){var userIds=_.pluck($scope.user.userAvatars,"id"),managerId=comment.manager.id;if(userIds.indexOf(managerId)>-1)return"isOwner"}function updateStatus(){return BusinessGoalService.saveStatus({team:{id:managerGoals.data.activeTeam.id},weekStart:moment(managerGoals.data.date.dateSelected).format("YYYY-MM-DD"),poundTheProductivity:managerGoals.data.status.poundTheProductivity,staffForStars:managerGoals.data.status.staffForStars,automateToEliminate:managerGoals.data.status.automateToEliminate}).$promise}var status=this,managerGoals=$scope.managerGoals;status.data={learnMore:{ss:{title:"Staff for Stars",content:["Good Crossteams are relentless about only hiring the best of the best and maintaining clear standards for performance. ","How do you recognize top performers and disseminate their learnings across the team?","How do you identify and address low performance?","Can you add to or topgrade your team through a Crossover Pipeline?"]},pp:{title:"Pound the Productivity",content:["Good Crossteams realize a trajectory of continuous improvement byconstantly experimenting with new methods, structures, andworkflows that will increase the teams weekly metric.","What processes can your team simplify?","What standards will increase the efficiency of their work?","What practices could instill a greater incentive in each individual contributor?"]},ae:{title:"Automate to Eliminate",content:["Good Crossteams are always considering what manual tasks can be automated in order to increase the productivity of the team and decrease their operating cost.","Where is your team wasting their time on menial work that automated software could execute?","What processes could you eliminate from their agenda by applying the right tools?"]}}},status.fn={handleViewModeClick:handleViewModeClick,handleStatusUpdateKeypress:handleStatusUpdateKeypress,handleStatusUpdateClick:handleStatusUpdateClick,getIndicatorColor:getIndicatorColor,handleAddCommentClick:handleAddCommentClick,handleCancelCommentClick:handleCancelCommentClick,handlePostCommentClick:handlePostCommentClick,handleUpdateCommentClick:handleUpdateCommentClick,handleUpdateStatusClick:handleUpdateStatusClick,handleCancelEditCommentClick:handleCancelEditCommentClick,handlePostEditCommentClick:handlePostEditCommentClick,handleStateClasses:handleStateClasses,getTime:getTime,openLearnMoreModal:openLearnMoreModal,openActivitiesModal:openActivitiesModal,openMetricModal:openMetricModal,urlify:ManagerGoalsService.urlify}}]),ctrls.controller("ManagerGembaWalkCtrl",["$scope","CurrentUser","TeamService","AssignmentService","$q","UtilsService","$location","ProductivityService","$uibModal","$document","$timeout",function($scope,CurrentUser,TeamService,AssignmentService,$q,UtilsService,$location,ProductivityService,$uibModal,$document,$timeout){function initDate(){var date=$location.search().date;vm.data.date={dateSelected:moment(date).format(),today:moment().format(),thisWeek:moment().startOf("week").format(),lastWeek:moment().startOf("week").subtract(1,"week").format(),currentWeekformatted:UtilsService.getWeekText(date),dateOptions:{showWeeks:!1,startingDay:1,maxDate:moment().format()}}}function getAssignment(){return AssignmentService.get({avatarType:"CANDIDATE",status:"ACTIVE"}).$promise.then(function(assignment){vm.ui.loading.assignment=!1,vm.data.assignment=assignment.content[0],vm.data.candidate=assignment.content[0].selection.marketplaceMember.application.candidate})}function getCurrentUser(){return CurrentUser.get().$promise.then(function(currentUser){vm.ui.loading.currentUser=!1,vm.data.currentUser=currentUser})}function getTeamAssignmentsPromise(teamId,managerId,page){var params={page:page||0,status:"ACTIVE,MANAGER_SETUP",teamId:teamId,managerId:managerId,fullTeam:!1,limit:1e3};return AssignmentService.teamAssignments(params).$promise}function getListOfAssignment(){var teamPromises=[],managerId=_.findWhere(vm.data.currentUser.userAvatars,{type:"MANAGER"}).id;return vm.data.teams.forEach(function(team){teamPromises.push(vm.fn.getTeamAssignmentsPromise(team.id,managerId))}),$q.all(teamPromises).then(function(teams){var assignments=[];teams.forEach(function(team){assignments.push(team.content)}),assignments=_.flatten(assignments),vm.ui.loading.assignments=!1,vm.data.assignments=assignments,vm.data.workers=_.groupBy(assignments,function(assignment){return assignment.team.name}),vm.data.workers=_.map(vm.data.workers,function(value,key){return{teamName:key,teamMembers:value}})})}function getListOfRelatedTeams(){return TeamService.teamsManagersMap({related:!0}).$promise.then(function(listOfTeams){var listOfTeamsThatAssignmentIsManager=listOfTeams.filter(function(team){if(team.teamOwner&&team.teamOwner.userId&&team.teamOwner.userId===vm.data.currentUser.id)return team;var teams=[];return team.reportingManagers&&(teams=team.reportingManagers.filter(function(manager){if(manager.userId===vm.data.currentUser.id)return manager}),teams.length>0)?team:void 0});vm.ui.loading.teams=!1,vm.data.teams=listOfTeamsThatAssignmentIsManager})}function init(){vm.fn.getAssignment(),vm.fn.initDate(),vm.fn.getCurrentUser().then(function(){vm.fn.getListOfRelatedTeams().then(function(){vm.fn.getListOfAssignment()})})}var vm=this;vm.data={assignment:null,assignments:null,currentUser:null,timecards:null,selectedAssignment:null,teams:null,candidate:null},vm.ui={loading:{teams:!0,assignment:!0,assignments:!0,currentUser:!0,selectedAssignment:!1,timecards:!1,scores:!1},start:!0,showFlagged:!1,error:{message:null},showTime:{minute:" min",hour:" hrs",separator:" ",showZeroMinute:!1}},vm.srv={UtilsService:UtilsService,$q:$q,AssignmentService:AssignmentService,ProductivityService:ProductivityService,$uibModal:$uibModal,$document:$document,$timeout:$timeout
},vm.fn={init:init,getAssignment:getAssignment,getCurrentUser:getCurrentUser,getListOfRelatedTeams:getListOfRelatedTeams,getTeamAssignmentsPromise:getTeamAssignmentsPromise,getListOfAssignment:getListOfAssignment,initDate:initDate},vm.fn.init()}]),ctrls.controller("ManagerGembaWalkHeaderCtrl",["$scope",function($scope){function handleSelectWorker(worker,date){vm.data.selectedAssignment=worker,vm.fn.loadWorkDiary(date,worker.id,worker.team.id)}function handleDatepickerChange(date){date&&(vm.data.date.dateSelected=date),vm.data.date.currentWeekformatted=vm.srv.UtilsService.getWeekText(vm.data.date.dateSelected),vm.data.date.currentWeekformatted===vm.data.date.thisWeek?vm.ui.isThisWeek=!0:vm.ui.isThisWeek=!1,vm.data.date.dateSelected&&vm.data.selectedAssignment&&vm.fn.loadWorkDiary(vm.data.date.dateSelected,vm.data.selectedAssignment.id,vm.data.selectedAssignment.team.id)}function handleChangeDate(inc){var newDate,oldDate=moment(vm.data.date.dateSelected).startOf("isoweek").toDate();newDate=inc>0?moment(oldDate).add(7,"days"):moment(oldDate).subtract(7,"days"),moment(newDate).format("x")<moment().format("x")?vm.data.date.dateSelected=newDate.toDate():vm.data.date.dateSelected=vm.data.date.today,vm.fn.handleDatepickerChange(newDate.format("YYYY-MM-DD"))}function isThisWeek(date,compareDate){return vm.srv.UtilsService.isThisWeek(date,compareDate)}function toggleFlaggedTimecards(){for(var key in vm.data.timecards)vm.data.timecards.hasOwnProperty(key)&&(vm.data.timecards[key].tc=vm.fn.findTimeGaps(vm.data.timecards[key].raw,vm.ui.showFlagged))}function fixHeader(){var w=angular.element(vm.srv.$document);w.scrollTop()>70?angular.element(".gemba-header").addClass("fixed"):angular.element(".gemba-header").removeClass("fixed")}var vm=$scope.vm;vm.fn=_.extend({},vm.fn,{handleSelectWorker:handleSelectWorker,handleDatepickerChange:handleDatepickerChange,handleChangeDate:handleChangeDate,isThisWeek:isThisWeek,toggleFlaggedTimecards:toggleFlaggedTimecards,fixHeader:fixHeader}),vm.srv.$document.on("scroll",vm.fn.fixHeader)}]),ctrls.controller("ManagerGembaWalkModuleCtrl",["timecard","$scope","$uibModalInstance",function(timecard,$scope,$uibModalInstance){function handleFlagClick(){vm.data.module.timecard.flagged=!vm.data.module.timecard.flagged,vm.fn.handleUpdateTimecard()}function typewatch(string,cb,time){time=time||1e3,clearTimeout(vm.ui.timer),vm.ui.timer=setTimeout(function(){if(string)return cb()},time)}function closeModule(){$uibModalInstance.dismiss()}function handleAddNote(){vm.data.module.timecard.flagged=!0,vm.data.module.managerCommentForm.$setPristine(),vm.fn.handleUpdateTimecard()}function handleCancelNote(){vm.data.module.timecard.note=vm.data.module.timecard.noteCopy,vm.data.module.managerCommentForm.$setPristine()}function updateWorkDiaryPromise(body,timecard){return vm.ui.loading.timecardUpdate=!0,vm.srv.AssignmentService.updateWorkDiary({workdiaryId:timecard.id,id:vm.data.selectedAssignment.id},body).$promise.then(function(){vm.ui.loading.timecardUpdate=!1,vm.data.module.timecard.noteCopy=body.note,body.noteCopy=body.note,_.map(vm.data.timecards,function(day){day.raw=day.raw.map(function(tc){return timecard.id===tc.id&&(tc=_.extend({},tc,body)),tc})})})}function handleUpdateTimecard(){var body=_.extend({},{note:vm.data.module.timecard.note,flagged:vm.data.module.timecard.flagged});vm.fn.updateWorkDiaryPromise(body,vm.data.module.timecard)}function initModal(){vm.ui.module.isManual=!vm.data.module.timecard.autoTracker,vm.ui.module.isLastScreenshotInTimecard=!0,vm.ui.module.isFirstScreenshotInTimecard=!0,vm.ui.module.isManual||(vm.data.module.timecard.screenshotIndex=_.findIndex(vm.data.module.timecard.screenshots,function(screenshot){if(screenshot.id===vm.data.module.timecard.activeScreenshot.id)return screenshot}),vm.ui.module.isLastScreenshotInTimecard=vm.data.module.timecard.screenshotIndex===vm.data.module.timecard.screenshots.length-1,vm.ui.module.isFirstScreenshotInTimecard=0===vm.data.module.timecard.screenshotIndex),vm.ui.module.isFirstTimecard=0===vm.data.module.index,vm.ui.module.isLastTimecard=vm.data.module.index===vm.data.module.timecards.length-1}function fullScreenSize(){vm.ui.module.fullScren=!vm.ui.module.fullScren,vm.ui.module.fullScren?vm.ui.module.showRightSide=!1:vm.srv.$timeout(function(){vm.ui.module.showRightSide=!0},300)}function changeTimecard(inc){vm.fn.initModal();var direction=inc>0?"next":"previous",prev="previous"===direction,next="next"===direction,isLastScreenshotInTimecard=vm.ui.module.isLastScreenshotInTimecard,isFirstScreenshotInTimecard=vm.ui.module.isFirstScreenshotInTimecard,isFirstTimecard=vm.ui.module.isFirstTimecard,isLastTimecard=vm.ui.module.isLastTimecard,isManual=!vm.data.module.timecard.autoTracker,navigateNextTimecard=isLastScreenshotInTimecard||vm.ui.module.showDetails||isManual,navigatePrevTimecard=isFirstScreenshotInTimecard||vm.ui.module.showDetails||isManual;navigateNextTimecard&&next&&!isLastTimecard?(vm.data.module.index+=inc,vm.data.module.timecard=vm.data.module.timecards[vm.data.module.index],vm.fn.handleCancelNote()):navigatePrevTimecard&&prev&&!isFirstTimecard?(vm.data.module.index+=inc,vm.data.module.timecard=vm.data.module.timecards[vm.data.module.index],vm.fn.handleCancelNote()):isFirstScreenshotInTimecard&&isFirstTimecard&&"previous"===direction||isLastScreenshotInTimecard&&isLastTimecard&&"next"===direction||vm.fn.selectScreenshot(vm.data.module.timecard.screenshots[vm.data.module.timecard.screenshotIndex+inc])}function selectScreenshot(screenshot){vm.ui.module.showDetails=!1,vm.data.module.timecard.activeScreenshot=screenshot,vm.data.module.timecard.screenshots.forEach(function(screenshot){screenshot.active=!1}),vm.data.module.timecard.activeScreenshot.active=!0,vm.data.module.timecard.screenshotIndex=_.findIndex(vm.data.module.timecard.screenshots,function(screenshot){if(screenshot.id===vm.data.module.timecard.activeScreenshot.id)return screenshot}),vm.fn.initModal()}var vm=$scope.vm;vm.data.module={detailsTableHeaders:[{name:"Time","class":"time"},{name:"Keyboard","class":"keyboard"},{name:"Mouse","class":"mouse"},{name:"Application","class":"application"},{name:"Window Title","class":"window-title"}],timer:null},vm.ui.module={showDetails:!1,fullScreen:!1,showRightSide:!0},vm.fn=_.extend({},vm.fn,{changeTimecard:changeTimecard,selectScreenshot:selectScreenshot,initModal:initModal,fullScreenSize:fullScreenSize,handleUpdateTimecard:handleUpdateTimecard,updateWorkDiaryPromise:updateWorkDiaryPromise,handleAddNote:handleAddNote,handleCancelNote:handleCancelNote,typewatch:typewatch,handleFlagClick:handleFlagClick,closeModule:closeModule}),vm.data.module.timecard=timecard,vm.data.module.timecards=_.flatten(_.map(vm.data.timecards,function(day){return day.tc})).filter(function(tc){if(!tc.gapBlock)return tc}),vm.data.module.index=_.findIndex(vm.data.module.timecards,function(tc){if(tc.id===timecard.id)return tc}),vm.fn.initModal(),vm.srv.$document.on("click",function(){vm.ui.module.showReport&&!angular.element(event.target).closest(".report-el")[0]&&(vm.ui.module.showReport=null),$scope.$apply()}),vm.srv.$document.on("keydown",function(evt){vm.data.module.keycode=evt.which,vm.data.module.keycode&&39===vm.data.module.keycode?vm.fn.changeTimecard(1):vm.data.module.keycode&&37===vm.data.module.keycode&&vm.fn.changeTimecard(-1),$scope.$apply()})}]),ctrls.controller("ManagerGembaWalkTimecardsCtrl",["$scope",function($scope){function getWorkDays(date){if(date){var startDay,workDays=[],weekday=7;vm.srv.UtilsService.isThisWeek(date)?(weekday=moment().isoWeekday(),startDay=moment(),workDays.push(moment().format("YYYY-MM-DD"))):(startDay=moment(date).endOf("week"),workDays.push(moment(date).endOf("week").format("YYYY-MM-DD")));for(var i=1;i<weekday;i++)workDays.push(startDay.subtract(1,"days").format("YYYY-MM-DD"));return workDays}}function loadWorkDiary(date,workerId){vm.ui.loading.timecards=!0,vm.ui.start=!1,vm.data.timecards=null;var workdays=vm.fn.getWorkDays(date),workDiaryPromises=vm.fn.getWorkDiaryPromises(workdays,workerId);return vm.srv.$q.all(workDiaryPromises).then(function(workDiariesResponse){var days=vm.fn.mapTimecards(workDiariesResponse);vm.fn.initTimeTracked(days)})}function addFocusScoreToTimecard(timecard,timecards){function getFocusedApplication(events){var eventNames=events.map(function(event){return event.processName}),mostUsedApplication=_.chain(eventNames).countBy().pairs().max(_.last).head().value();return focusedApplication||(focusedApplication=mostUsedApplication),[mostUsedApplication]}for(var focusedApplication,timecardIndex=_.findIndex(timecards,{id:timecard.id}),applicationsUsedInFirstTimecard=getFocusedApplication(timecard.events),timeCardsWithSameApplications=[],totalFocusedTime=0,firstInblock=!0,i=timecardIndex;i<timecards.length;i++){var applicationUsed=getFocusedApplication(timecards[i].events),sameApplicationsUsedAsFirstTimecard=!1,isConsequtive=!0;if(0===i||firstInblock||(isConsequtive=10===moment(timecards[i].date).diff(moment(timecards[i-1].date),"minutes")),firstInblock=!1,applicationUsed.forEach(function(application){applicationsUsedInFirstTimecard.indexOf(application)!==-1&&(sameApplicationsUsedAsFirstTimecard=!0)}),!sameApplicationsUsedAsFirstTimecard||!isConsequtive)break;totalFocusedTime+=timecards[i].events.length,timeCardsWithSameApplications.push(timecards[i])}var focused=timeCardsWithSameApplications.length>=3;return timeCardsWithSameApplications.forEach(function(tc){var index=_.findIndex(timecards,{id:tc.id});timecards[index].focusedApplication=focusedApplication,timecards[index].focusedTime=totalFocusedTime,timecards[index].focused=focused}),timecards}function mapTimecards(days){return days.map(function(day){return day.map(function(timecard){return"null"===timecard.note&&(timecard.note=null),timecard.noteCopy=timecard.note,timecard.events=_.sortBy(timecard.events,"date"),_.isUndefined(timecard.focused)&&vm.fn.addFocusScoreToTimecard(timecard,day),timecard.screenshots=timecard.images.filter(function(image){if("SCREENSHOT"===image.type)return image.id=Math.round(1e6*Math.random()),image}),timecard.screenshots=_.sortBy(timecard.screenshots,"createdAt"),timecard.webcamShots=timecard.images.filter(function(image){if("WEBCAMSHOT"===image.type)return image.id=Math.round(1e6*Math.random()),image}),timecard.webcamShots=_.sortBy(timecard.webcamShots,"createdAt"),timecard.screenshots[0]?timecard.screenshots[0].active=!0:null,timecard.activeScreenshot=timecard.screenshots[0],timecard.activeWebcamShot=timecard.webcamShots[0],timecard})})}function getActivitesPromise(){return vm.srv.ProductivityService.readGroupedTeamActivities({assignmentId:vm.data.selectedAssignment.id,date:moment(vm.data.date.dateSelected).startOf("week").format("YYYY-MM-DD"),weekly:!0}).$promise}function getWorkDiaryPromise(date,workerId){var params={id:workerId,date:date};return vm.srv.AssignmentService.workDiary(params).$promise}function getWorkDiaryPromises(workdays,workerId){var promises=[];return workdays.forEach(function(workday){promises.push(vm.fn.getWorkDiaryPromise(workday,workerId))}),promises}function initTimeTracked(days){if(!days||!_.isArray(days))return vm.ui.loading.timecards=!1,void(vm.data.timecards=null);var allTimecards=_.flatten(days).length;if(0===allTimecards)return vm.ui.loading.timecards=!1,void(vm.data.timecards=null);days.reverse();var d={},timeTracked={autoTracked:0,idle:0,disputed:0,manual:0,overtime:0,total:0,low:0};days.forEach(function(timecards){timecards.forEach(function(tc){var aLvl=tc.activityLevel,low=aLvl<=10&&0!==aLvl&&tc.autoTracker,idle=0===aLvl&&tc.autoTracker,date=moment(tc.date).utc().format("YYYY-MM-DD");d[date]||(d[date]={autoTracked:0,idle:0,disputed:0,manual:0,overtime:0,total:0,low:0,tc:[]}),tc.autoTracker&&(timeTracked.autoTracked+=10,d[date].autoTracked+=10),tc.autoTracker||(timeTracked.manual+=10,d[date].manual+=10),tc.rejected&&(timeTracked.disputed+=10,d[date].disputed+=10),tc.overtime&&(timeTracked.overtime+=10,d[date].overtime+=10),low&&(timeTracked.low+=10,d[date].low+=10),idle&&(timeTracked.idle+=10,d[date].idle+=10),timeTracked.total+=10,d[date].total+=10,d[date].tc.push(tc)})}),vm.fn.initTimecards(d),timeTracked.total=timeTracked.total-timeTracked.idle-timeTracked.disputed,vm.data.timeTracked=timeTracked}function initTimecards(timecards){if(!timecards)return void(vm.ui.loading.timecards=!1);for(var key in timecards)if(timecards.hasOwnProperty(key)){timecards[key].total=timecards[key].total-timecards[key].idle-timecards[key].disputed;var day=timecards[key];for(var k in day)timecards[key].hasOwnProperty(k)&&"tc"===k&&(timecards[key].raw=day.tc.slice(),timecards[key][k]=vm.fn.findTimeGaps(day.tc,vm.ui.showFlagged))}vm.fn.initScores(timecards)}function findTimeGaps(timecards,onlyFlagged){onlyFlagged&&(timecards=timecards.filter(function(timecard){if(timecard.flagged)return timecard}));for(var timecardsWithoutGaps=timecards.map(function(timecard,i){if(0===i)return timecard.isFirst=!0,timecard;var lastTimeCardTime=moment(timecards[i-1].date),currentTimeCardTime=moment(timecard.date),differenceInMinutes=currentTimeCardTime.diff(lastTimeCardTime,"minutes");return differenceInMinutes>10&&(timecard.isGap=!0),timecard}),numberOfTimecards=timecardsWithoutGaps.length,timeCardsWithGaps=[],i=0;i<numberOfTimecards;i++){if(timecardsWithoutGaps[i].isGap||0===i){var withGap=_.extend({},timecardsWithoutGaps[i],{gapBlock:!0});timeCardsWithGaps.push(withGap)}timeCardsWithGaps.push(timecardsWithoutGaps[i])}return timeCardsWithGaps}function getHourOfDay(t){if(t){t+=":00";var p=moment(t,"H:mm").format("hh a");return p}}function getAssignmentTime(date,format){return moment(date).utc().format(format)}function getTimeCardHoursAndMinutes(time){var hours=time.split(":")[0],minutes=time.split(":")[1];return hours+" hrs "+minutes+" min"}function initScores(timecards){var dates=[];for(var date in timecards)timecards.hasOwnProperty(date)&&dates.push(date);var workerId=vm.data.selectedAssignment.id,teamId=vm.data.selectedAssignment.team.id,scoresPromises=vm.fn.getScoresPromises(dates,workerId,teamId);return vm.srv.$q.all(scoresPromises).then(function(scoresResponse){var index=[];_.map(timecards,function(timecard,key){if(0===scoresResponse[index.length].length)timecards[key].scores={alignmentScore:0,focusScore:0,intensityScore:0};else{var grouping=scoresResponse[index.length][0].grouping;timecards[key].scores={alignmentScore:grouping.alignmentScore,focusScore:grouping.focusScore,intensityScore:grouping.intensityScore}}index.push(1)}),vm.data.timecards=timecards,vm.ui.loading.timecards=!1})}function getScoresPromises(workdays,workerId,teamId){var promises=[];return workdays.forEach(function(workday){promises.push(vm.fn.getScoresPromise(workday,workerId,teamId))}),promises}function getScoresPromise(date,workerId,teamId){return vm.srv.ProductivityService.readGroupedTeamActivities({assignmentId:workerId,date:date,team:teamId}).$promise}function handleScreenShotClick(tc){if(!tc.gapBlock){var modal=vm.srv.$uibModal.open({templateUrl:"gembaScreenshotModule.tpl.html",controller:"ManagerGembaWalkModuleCtrl",backdrop:"true",windowClass:"gemba-walk-popup",scope:$scope,resolve:{timecard:function(){return tc}},size:"lg"});modal.result.then(function(){},function(){vm.srv.$document.off("keydown")})}}function getScoreColor(score){return score>80?"green":score>=50?"yellow":"red"}var vm=$scope.vm;vm.fn=_.extend({},vm.fn,{getWorkDays:getWorkDays,loadWorkDiary:loadWorkDiary,mapTimecards:mapTimecards,getWorkDiaryPromise:getWorkDiaryPromise,getWorkDiaryPromises:getWorkDiaryPromises,initTimeTracked:initTimeTracked,initTimecards:initTimecards,getHourOfDay:getHourOfDay,getAssignmentTime:getAssignmentTime,getTimeCardHoursAndMinutes:getTimeCardHoursAndMinutes,initScores:initScores,getScoresPromise:getScoresPromise,getScoresPromises:getScoresPromises,handleScreenShotClick:handleScreenShotClick,getScoreColor:getScoreColor,findTimeGaps:findTimeGaps,getActivitesPromise:getActivitesPromise,addFocusScoreToTimecard:addFocusScoreToTimecard})}]),services.factory("MetricSettingAuthorization",[function(){var Authorization={};return Authorization.authorize=function(currentUser,team,assignments){var isCompanyAdmin=_.some(currentUser.userAvatars,function(avatar){return"COMPANY_ADMIN"===avatar.type}),isTeamOwner=_.some(currentUser.userAvatars,function(avatar){var isManager="MANAGER"===avatar.type,isTeamOnwer=!1;return team.teamOwner&&(isTeamOnwer=avatar.id===team.teamOwner.id),isManager&&isTeamOnwer}),teamMembers=_.chain(assignments).filter(function(assignment){return _.some(currentUser.userAvatars,function(avatar){return"MANAGER"===avatar.type&&avatar.id===assignment.manager.id})}).map("id").value();return{canEdit:isCompanyAdmin||isTeamOwner,canSave:isCompanyAdmin||isTeamOwner||teamMembers.length>0,teamMembers:teamMembers,tooltip:isCompanyAdmin||isTeamOwner?"":"Only team owner and company admin can configure this team metrics"}},Authorization}]),bandcampApp.directive("metricControlPanel",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/metric-control-panel.tpl.html",controller:"MetricControlPanelCtrl",scope:{isDisabled:"=",viewMode:"=",measurementMode:"=",statsMode:"=",lastWeeks:"=",activeSetup:"=",permission:"=",refreshMetric:"&",downloadReport:"&",openMetricSetting:"&"}}}]),ctrls.controller("MetricControlPanelCtrl",["$scope","$cookies","$timeout",function($scope,$cookies,$timeout){var MetricRefreshButton=function(){};MetricRefreshButton.prototype.disable=function(lastUpdated,minutes){this.disabled=!0,this.tooltip="You'll be able to refresh the metrics again at "+moment(lastUpdated).add(minutes,"minutes").format("hh:mm a");var enabledMoment=moment(lastUpdated).add(minutes,"minutes").second(0),now=moment(),timeLeft=1e3*enabledMoment.diff(now,"seconds"),_this=this;$timeout(function(){_this.enable()},timeLeft)},MetricRefreshButton.prototype.enable=function(){this.disabled=!1,this.tooltip="Refresh the metrics. You can do this once every 10 minutes."},$scope.btnRefresh=new MetricRefreshButton,$scope.ViewMode={CHART:"CHART",TABLE:"TABLE"},$scope.MeasurementMode={UNIT:"UNIT",COST:"COST"},$scope.StatsMode={INDIVIDUAL:"INDIVIDUAL",TEAM:"TEAM"},$scope.viewMode=$cookies.metricDisplay_viewMode||$scope.ViewMode.CHART,$scope.measurementMode=$cookies.metricDisplay_measurementMode||$scope.MeasurementMode.UNIT,$scope.statsMode=$cookies.metricDisplay_statsMode||$scope.StatsMode.INDIVIDUAL,$scope.$watch("measurementMode",function(nv){$cookies.metricDisplay_measurementMode=nv}),$scope.$watch("statsMode",function(nv){$cookies.metricDisplay_statsMode=nv}),$scope.$watch("viewMode",function(nv){$cookies.metricDisplay_viewMode=nv}),$scope.$watch("activeSetup.metricUpdatedOn",function(lastUpdated){var WAITING_TIME=10,isStillWaiting=lastUpdated&&moment().diff(lastUpdated,"minutes")<WAITING_TIME;isStillWaiting?$scope.btnRefresh.disable(lastUpdated,WAITING_TIME):$scope.btnRefresh.enable()})}]),bandcampApp.directive("metricsDisplay",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/display/metrics-display.tpl.html",scope:{assignments:"=",metricsStats:"=",weeks:"=",metricTarget:"@",measurementMode:"@",statsMode:"@",viewMode:"@"},controller:"MetricsDisplayCtrl"}}]),ctrls.controller("MetricsDisplayCtrl",["$scope","$timeout","$cookies","MetricsDisplayService",function($scope,$timeout,$cookies,MetricsDisplayService){$scope.chartToggledItems={assignments:[],currentWeek:"true"===$cookies.get("metricsDisplay_currentWeek"),average:!0,normalize:"true"===$cookies.get("metricsDisplay_normalize")};var destroyCurrentDisplay=function(){$scope.display={unitTable:!1,costTable:!1,individualCostChart:!1,individualUnitChart:!1,teamCostChart:!1,teamUnitChart:!1}},toggleDisplayOption=function(){destroyCurrentDisplay();var displayOption=MetricsDisplayService.findDisplayOption($scope.viewMode,$scope.statsMode,$scope.measurementMode);$scope.display[displayOption]=!0};$scope.$watch("chartToggledItems.currentWeek",function(showCurrentWeek){$cookies.put("metricsDisplay_currentWeek",showCurrentWeek)}),$scope.$watch("chartToggledItems.normalize",function(normalize){$cookies.put("metricsDisplay_normalize",normalize)}),$scope.$watch("viewMode",toggleDisplayOption),$scope.$watch("statsMode",toggleDisplayOption),$scope.$watch("measurementMode",toggleDisplayOption),$scope.$watch("weeks.length",function(){destroyCurrentDisplay(),$timeout(toggleDisplayOption,0)})}]),services.factory("MetricsDisplayService",function(AssignmentService,$routeParams){var metricsDisplayService={},VIEW_MODE={CHART:"CHART",TABLE:"TABLE"},MEASUREMENT_MODE={COST:"COST",UNIT:"UNIT"},STATS_MODE={TEAM:"TEAM",INDIVIDUAL:"INDIVIDUAL"},AVERAGE={ID:"-1"},METRIC_TARGET={ID:"-2"};return metricsDisplayService.VIEW_MODE=VIEW_MODE,metricsDisplayService.MEASUREMENT_MODE=MEASUREMENT_MODE,metricsDisplayService.STATS_MODE=STATS_MODE,metricsDisplayService.AVERAGE=AVERAGE,metricsDisplayService.METRIC_TARGET=METRIC_TARGET,metricsDisplayService.findDisplayOption=function(viewMode,statsMode,measurementMode){if(viewMode===VIEW_MODE.TABLE)return measurementMode===MEASUREMENT_MODE.COST?"costTable":"unitTable";var INDEX={STATS_MODE:0,MEASUREMENT_MODE:1,DISPLAYED_CHART:2},displayOptions=[[STATS_MODE.INDIVIDUAL,MEASUREMENT_MODE.COST,"individualCostChart"],[STATS_MODE.INDIVIDUAL,MEASUREMENT_MODE.UNIT,"individualUnitChart"],[STATS_MODE.TEAM,MEASUREMENT_MODE.COST,"teamCostChart"],[STATS_MODE.TEAM,MEASUREMENT_MODE.UNIT,"teamUnitChart"]],option=_.find(displayOptions,function(option){return option[INDEX.STATS_MODE]===statsMode&&option[INDEX.MEASUREMENT_MODE]===measurementMode});if(null===option)throw new Error("Please define a display option, statsMode: "+statsMode+", measurementMode: "+measurementMode);return option[INDEX.DISPLAYED_CHART]},metricsDisplayService.calIndividualAverage=function(assignmentStats){var total={unit:0,week:0,cost:0};return total=_.chain(assignmentStats).reduce(function(total,stat){return total.unit=total.unit+stat.unit,total.cost=total.cost+stat.cost,total.week++,total},total).value(),{costPerUnit:0===total.unit?total.cost:total.cost/total.unit,unitPerWeek:0===total.week?total.unit:total.unit/total.week}},metricsDisplayService.calWeeklyTeamMetrics=function(assignments,individualStats){var combineTeamStats=function(individualStat,startDate){var teamStat={unit:0,cost:0,teamSize:0};return teamStat=_.chain(individualStat).reduce(function(week,stat){return week.unit+=stat.ticketsResolved,week.cost+=stat.weekSalary,week},teamStat).value(),teamStat.teamSize=AssignmentService.filterActiveAssignmentsInRange(assignments,moment(startDate).startOf("isoweek"),moment(startDate).endOf("isoweek"),"ACTIVE",Number($routeParams.team),$routeParams.managerId).length,teamStat.unitPerAssignment=teamStat.unit/teamStat.teamSize,teamStat.costPerUnit=0===teamStat.unit?teamStat.cost:teamStat.cost/teamStat.unit,teamStat.startDate=startDate,teamStat};return _.chain(individualStats).groupBy("startDate").map(combineTeamStats).sortBy("startDate").value()},metricsDisplayService.calTeamAverage=function(weeklyTeamMetrics){var total={cost:0,unit:0};total=_.chain(weeklyTeamMetrics).reduce(function(total,week){return total.cost=total.cost+week.cost,total.unit=total.unit+week.unit,total},total).value();var teamSize=_.chain(weeklyTeamMetrics).map("teamSize").max().value(),allWeeks=weeklyTeamMetrics.length;return{costPerUnit:0===total.unit?total.cost:total.cost/total.unit,unitPerWeek:0===allWeeks?total.unit:total.unit/(allWeeks*teamSize)}},metricsDisplayService.calculateWeeklyAverageUnit=function(weeklyTeamMetrics){var totalUnit=_.chain(weeklyTeamMetrics).map("unit").reduce(function(allUnit,value){return allUnit+value},0).value(),allWeeks=weeklyTeamMetrics.length;return 0===allWeeks?totalUnit:totalUnit/allWeeks},metricsDisplayService.calculateStatsPerAssignments=function(assignments,individualStats){var statsPerAssignments=_.chain(individualStats).groupBy("assignmentId").map(function(assignmentStats,assignmentId){var refinedStats=_.chain(assignmentStats).map(function(stat){return{startDate:stat.startDate,unit:stat.ticketsResolved,cost:stat.weekSalary,costPerUnit:0===stat.ticketsResolved?stat.weekSalary:stat.weekSalary/stat.ticketsResolved}}).value();return{id:assignmentId,stats:refinedStats}}).value();return _.each(statsPerAssignments,function(statsPerAssignment){var assignment=_.find(assignments,function(assignment){return assignment.id===statsPerAssignment.id});statsPerAssignment.name=assignment.name,statsPerAssignment.photoUrl=assignment.photoUrl,statsPerAssignment.effectiveDateEndInTeam=assignment.effectiveDateEndInTeam}),statsPerAssignments},metricsDisplayService.statsToChartData=function(field){return function(stat){var HIDDEN=null,thisMonday=moment().weekday(moment.DAY_OF_WEEK.MONDAY),isCurrentWeek=moment(stat.startDate).diff(thisMonday,"days")>=0;return isCurrentWeek&&0===stat.unit?HIDDEN:stat[field]}},metricsDisplayService.isBeforeCurrentWeek=function(stat){var thisMonday=moment().weekday(moment.DAY_OF_WEEK.MONDAY);return moment(stat.startDate).diff(thisMonday,"days")<0},metricsDisplayService.isValidMetricTarget=function(metricTarget){return _.isNumber(metricTarget)&&metricTarget>0},metricsDisplayService.findAccountedPeriod=function(weeks){var actualAccountedWeeks=_.filter(weeks,function(week){var thisMonday=moment().weekday(moment.DAY_OF_WEEK.MONDAY);return moment(week).diff(thisMonday,"days")<0}),accountedPeriod={weeks:actualAccountedWeeks,start:actualAccountedWeeks[0],end:moment(actualAccountedWeeks[actualAccountedWeeks.length-1]).weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)};return accountedPeriod},metricsDisplayService.findPercentageColor=function(percentage){return percentage>=75?"target-green":percentage>=50?"target-yellow":"target-red"},metricsDisplayService.refineDataPoints=function(showCurrentWeek,weeks,dataPoints){var cloneDataPoints=dataPoints.slice(),isDataComplete=weeks.length===cloneDataPoints.length;if(!showCurrentWeek&&isDataComplete){var last=cloneDataPoints.length-1,hidden=null;cloneDataPoints[last]=hidden}return cloneDataPoints},metricsDisplayService.normalize=function(){var MAX_WIDTH=2e3;angular.element(".metric-table").scrollLeft(MAX_WIDTH)},metricsDisplayService.sortOrderDefaults=function(){return{column:"average[value]",index:0,reverse:!1}},metricsDisplayService.sortTable=function(sortBy,index,obj){return angular.isDefined(index)?(obj.index===index&&(obj.reverse=!obj.reverse),obj.index=index,obj.column=function(contractor){return contractor.weeks?"string"==typeof contractor.weeks[index].value?parseFloat(contractor.weeks[index].value.replace(/,|\$/gi,"")):contractor.weeks[index].value:contractor.metricsStats.slice().reverse()[index]}):(obj.column===sortBy?obj.reverse=!obj.reverse:obj.reverse="name"!==sortBy,obj.column=sortBy),obj},metricsDisplayService.updateIndividualChartData=function(scopeMetricsStats,scopeAssignments,normalize,callBackRefreshEfficiencyChart,callBackRefreshChartLegend){var metricsStats=[];normalize?_.chain(scopeMetricsStats).each(function(stat){var s=_.clone(stat);s.ticketsResolved=s.hoursWorked>0?Math.round(s.ticketsResolved/s.hoursWorked*40):s.ticketsResolved,metricsStats.push(s)}):metricsStats=scopeMetricsStats;var weeklyTeamMetrics=metricsDisplayService.calWeeklyTeamMetrics(scopeAssignments,metricsStats),statsPerAssignments=metricsDisplayService.calculateStatsPerAssignments(scopeAssignments,metricsStats);callBackRefreshEfficiencyChart(weeklyTeamMetrics,statsPerAssignments),callBackRefreshChartLegend(weeklyTeamMetrics,statsPerAssignments)},metricsDisplayService}),bandcampApp.directive("costMetricTable",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/table/metric-table.tpl.html",restrict:"E",scope:{weeks:"=",assignments:"=",metricsStats:"=",measurementMode:"@"},controller:"CostMetricTableCtrl"}}]),ctrls.controller("CostMetricTableCtrl",["$scope","$interpolate","MetricsDisplayService","AssignmentService","ProductivityMetricTableSetting","$routeParams",function($scope,$interpolate,MetricsDisplayService,AssignmentService,TableSetting,$routeParams){var fillEmptyMetric=function(metricWeeks,totalWeek){var isMetricComplete=metricWeeks.length===totalWeek;if(!isMetricComplete)for(var EMPTY_WEEK=null;metricWeeks.length<totalWeek;)metricWeeks.push(EMPTY_WEEK)},weeklyTeamMetrics=MetricsDisplayService.calWeeklyTeamMetrics($scope.assignments,$scope.metricsStats),teamAverage=MetricsDisplayService.calTeamAverage(_.filter(weeklyTeamMetrics,MetricsDisplayService.isBeforeCurrentWeek)),statsPerAssignments=MetricsDisplayService.calculateStatsPerAssignments($scope.assignments,$scope.metricsStats);_.each(statsPerAssignments,function(assignment){var currWeekExcludedStats=_.filter(assignment.stats,MetricsDisplayService.isBeforeCurrentWeek);assignment.average=MetricsDisplayService.calIndividualAverage(currWeekExcludedStats)}),statsPerAssignments.sort(function(asgn1,asgn2){return asgn1.average.costPerUnit-asgn2.average.costPerUnit}),$scope.header={average:$interpolate("Avg. Cost per Unit")($scope.weeks),weeks:_.map($scope.weeks,function(week){var monday=moment(week).format("MMM DD"),sunday=moment(week).add(6,"days").format("MMM DD");return{from:monday,to:sunday}})},$scope.team={average:{value:$interpolate("${{costPerUnit | number: 1}}")(teamAverage),tooltip:$interpolate("Units per Week: {{unitPerWeek | number: 2}}")(teamAverage)},weeks:_.map(weeklyTeamMetrics,function(week){return{value:$interpolate("${{costPerUnit | number: 1}}")(week),tooltip:$interpolate("Total Units: {{unit}}")(week)}})},$scope.tableSetting=TableSetting.of($scope.weeks.length),fillEmptyMetric($scope.team.weeks,$scope.weeks.length),$scope.contractors=_.map(statsPerAssignments,function(assignment){var assignmentObj=$scope.assignments.filter(function(a){return""+a.id===assignment.id}).pop(),contractor={name:assignment.name,photoUrl:assignment.photoUrl,effectiveDateEndInTeam:assignment.effectiveDateEndInTeam,average:{value:$interpolate("${{costPerUnit | number: 1}}")(assignment.average),tooltip:$interpolate("Units Per Week: {{unitPerWeek | number: 2}}")(assignment.average)},weeks:_.map(assignment.stats,function(week){return{value:$interpolate("${{costPerUnit | number: 1}}")(week),tooltip:$interpolate("Total Units: {{unit}} <br/> Salary: ${{cost}}")(week),activeAssignmentInWeek:AssignmentService.isAssignmentActiveInTeamForDate(assignmentObj,$routeParams.team,moment(week.startDate))}})};return fillEmptyMetric(contractor.weeks,$scope.weeks.length),contractor}),$scope.$evalAsync(function(){MetricsDisplayService.normalize()}),$scope.sortOrder=MetricsDisplayService.sortOrderDefaults(),$scope.sortTable=MetricsDisplayService.sortTable}]),bandcampApp.directive("unitMetricTable",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/table/metric-table.tpl.html",restrict:"E",scope:{weeks:"=",assignments:"=",metricsStats:"=",metricTarget:"@",measurementMode:"@"},controller:"UnitMetricTable"}}]),ctrls.controller("UnitMetricTable",["$scope","$interpolate","MetricsDisplayService","AssignmentService","ProductivityMetricTableSetting","$routeParams",function($scope,$interpolate,MetricsDisplayService,AssignmentService,TableSetting,$routeParams){var fillEmptyMetric=function(metricWeeks,totalWeek){var isMetricComplete=metricWeeks.length===totalWeek;if(!isMetricComplete)for(var EMPTY_WEEK=null;metricWeeks.length<totalWeek;)metricWeeks.push(EMPTY_WEEK)},weeklyTeamMetrics=MetricsDisplayService.calWeeklyTeamMetrics($scope.assignments,$scope.metricsStats),teamAverage=MetricsDisplayService.calTeamAverage(_.filter(weeklyTeamMetrics,MetricsDisplayService.isBeforeCurrentWeek)),statsPerAssignments=MetricsDisplayService.calculateStatsPerAssignments($scope.assignments,$scope.metricsStats);if(_.each(statsPerAssignments,function(assignment){var currWeekExcludedStats=_.filter(assignment.stats,MetricsDisplayService.isBeforeCurrentWeek);assignment.average=MetricsDisplayService.calIndividualAverage(currWeekExcludedStats);
}),statsPerAssignments.sort(function(asgn1,asgn2){return asgn2.average.unitPerWeek-asgn1.average.unitPerWeek}),$scope.header={average:$interpolate("Avg. Units")($scope.weeks),weeks:_.map($scope.weeks,function(week){var monday=moment(week).format("MMM DD"),sunday=moment(week).add(6,"days").format("MMM DD");return{from:monday,to:sunday}})},$scope.team={average:{value:$interpolate("{{unitPerWeek | number: 1}}")(teamAverage),tooltip:$interpolate("Cost per Unit: ${{costPerUnit | number: 1}}")(teamAverage)},weeks:_.map(weeklyTeamMetrics,function(week){return{value:week.unit,tooltip:$interpolate("Cost per Unit: ${{costPerUnit | number: 1}}")(week)}})},$scope.tableSetting=TableSetting.of($scope.weeks.length),fillEmptyMetric($scope.team.weeks,$scope.weeks.length),$scope.contractors=_.map(statsPerAssignments,function(assignment){var assignmentObj=$scope.assignments.filter(function(a){return a.id.toString()===assignment.id.toString()}).pop(),contractor={name:assignment.name,photoUrl:assignment.photoUrl,effectiveDateEndInTeam:assignment.effectiveDateEndInTeam,average:{value:$interpolate("{{unitPerWeek | number: 2}}")(assignment.average),tooltip:$interpolate("Cost per Unit: ${{costPerUnit | number: 1}}")(assignment.average)},weeks:_.map(assignment.stats,function(week){return{value:week.unit,tooltip:$interpolate("Cost per Unit: ${{costPerUnit | number: 1}}")(week),activeAssignmentInWeek:AssignmentService.isAssignmentActiveInTeamForDate(assignmentObj,$routeParams.team,moment(week.startDate))}})};return fillEmptyMetric(contractor.weeks,$scope.weeks.length),contractor}),$scope.metricTarget){var teamPercentage=Math.round(100*eval($scope.team.average.value)/$scope.metricTarget);$scope.team.average.percentage={value:teamPercentage,color:MetricsDisplayService.findPercentageColor(teamPercentage),tooltip:$scope.metricTarget},_.each($scope.contractors,function(contractor){var contractorPercentage=Math.round(100*eval(contractor.average.value)/$scope.metricTarget);contractor.average.percentage={value:contractorPercentage,color:MetricsDisplayService.findPercentageColor(contractorPercentage),tooltip:$scope.metricTarget}})}$scope.$evalAsync(function(){MetricsDisplayService.normalize()}),$scope.sortOrder=MetricsDisplayService.sortOrderDefaults(),$scope.sortTable=MetricsDisplayService.sortTable}]),services.factory("ProductivityMetricTableSetting",[function(){var HeaderFormatter={OneLine:function(week){return week.from+"-"+week.to},TwoLines:function(week){return week.from+"<br/>"+week.to}},Setting={FOUR_WEEKS:{tableClass:"",headerFormatter:HeaderFormatter.OneLine,weeks:[4,5]},EIGHT_WEEKS:{tableClass:"compact",headerFormatter:HeaderFormatter.TwoLines,weeks:[8,9]},TWELVE_WEEKS:{tableClass:"compact scroll-bar",headerFormatter:HeaderFormatter.TwoLines,weeks:[12,13]},SIX_MONTHS:{tableClass:"compact scroll-bar",headerFormatter:HeaderFormatter.TwoLines,weeks:[26,27]}};return Setting.of=function(numberOfWeeks){return _.chain(Setting).values().find(function(setting){return _.contains(setting.weeks,numberOfWeeks)}).value()},Setting}]),bandcampApp.directive("individualCostChart",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/individual-cost-chart.tpl.html",restrict:"E",scope:{weeks:"=",metricsStats:"=",assignments:"=",toggledItems:"="},controller:"IndividualCostChartCtrl"}}]),ctrls.controller("IndividualCostChartCtrl",["$scope","$interpolate","MetricsDisplayService","UtilsService",function($scope,$interpolate,MetricsDisplayService,UtilsService){function refreshEfficiencyChart(weeklyTeamMetrics,statsPerAssignments){$scope.efficiencyChart.formatter.averageTooltip=function(point){var htmlContent="Cost per Unit: <b>${{costPerUnit | number: 1}}</b><br/>Total Units: <b>{{unit | number: 2}}</b><br/>Per Team Memeber: <b>{{unitPerAssignment | number: 2}}</b><br/>Team size: <b>{{teamSize}}</b>",week=_.find(weeklyTeamMetrics,function(week){return week.startDate===point.id});return $interpolate(htmlContent)(week)},$scope.efficiencyChart.average.value=_.map(weeklyTeamMetrics,"costPerUnit"),$scope.efficiencyChart.lines=_.map(statsPerAssignments,function(assignment){return{id:assignment.id,name:assignment.name,value:_.map(assignment.stats,"costPerUnit"),color:UtilsService.getHexColor(assignment.id)}}),$scope.efficiencyChart.formatter.individualTooltip=function(point){var htmlContent="<b>{{assignment.name}}</b><br/><b>Cost Per Unit: ${{stat.costPerUnit | number: 1}}</b><br/>Units: <b>{{stat.unit}}</b><br/>Week Salary: ${{stat.cost | number: 1}}",assignment=_.find(statsPerAssignments,function(assignment){return assignment.id===point.lineId}),stat=_.find(assignment.stats,function(stat){return stat.startDate===point.id});return $interpolate(htmlContent)({assignment:assignment,stat:stat})}}function refreshChartLegend(weeklyTeamMetrics,statsPerAssignments,weeks){var accountedPeriod=MetricsDisplayService.findAccountedPeriod(weeks),tooltip="Weekly average from "+moment(accountedPeriod.start).format("MMMM DD")+" until "+moment(accountedPeriod.end).format("MMMM DD");$scope.selectableMetricsLegend.header.value="Avg. Cost per Unit ("+accountedPeriod.weeks.length+" Weeks)",$scope.selectableMetricsLegend.header.tooltip=tooltip,$scope.selectableMetricsLegend.rows=_.chain(statsPerAssignments).map(function(assignment){var currWeekExcludedStats=_.filter(assignment.stats,MetricsDisplayService.isBeforeCurrentWeek),average=MetricsDisplayService.calIndividualAverage(currWeekExcludedStats);return{id:assignment.id,description:assignment.name,effectiveDateEndInTeam:assignment.effectiveDateEndInTeam,color:UtilsService.getHexColor(assignment.id),value:average.costPerUnit,tooltip:tooltip}}).sortBy("value").value(),_.each($scope.selectableMetricsLegend.rows,function(row){row.sortValue=parseFloat(row.value),row.value="$"+row.value.toFixed(1)});var teamAverage=MetricsDisplayService.calTeamAverage(_.filter(weeklyTeamMetrics,MetricsDisplayService.isBeforeCurrentWeek));$scope.selectableMetricsLegend.average.value="$"+teamAverage.costPerUnit.toFixed(1),$scope.selectableMetricsLegend.average.tooltip=tooltip}$scope.broadcaster={},$scope.broadcaster.mouseEnter=function(assignment){$scope.$broadcast("metrics-chart-mouse-enter-assignment",{assignment:assignment})},$scope.broadcaster.mouseLeave=function(assignment){$scope.$broadcast("metrics-chart-mouse-leave-assignment",{assignment:assignment})},$scope.efficiencyChart={average:{id:MetricsDisplayService.AVERAGE.ID,value:[]},lines:[],formatter:{yAxisLabel:"${value}",individualTooltip:null}},$scope.selectableMetricsLegend={header:{description:"Team Member"},average:{id:MetricsDisplayService.AVERAGE.ID,description:"Team Average",color:"#02A8F3"},rows:[]},MetricsDisplayService.updateIndividualChartData($scope.metricsStats,$scope.assignments,$scope.toggledItems.normalize,refreshEfficiencyChart,refreshChartLegend),$scope.$watch("toggledItems.normalize",function(newValue){MetricsDisplayService.updateIndividualChartData($scope.metricsStats,$scope.assignments,newValue,refreshEfficiencyChart,refreshChartLegend)})}]),bandcampApp.directive("individualUnitChart",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/individual-unit-chart.tpl.html",restrict:"E",scope:{weeks:"=",metricTarget:"@",metricsStats:"=",assignments:"=",toggledItems:"="},controller:"IndividualUnitChartCtrl"}}]),ctrls.controller("IndividualUnitChartCtrl",["$scope","$interpolate","MetricsDisplayService","UtilsService",function($scope,$interpolate,MetricsDisplayService,UtilsService){function refreshEfficiencyChart(weeklyTeamMetrics,statsPerAssignments){var metricTarget=$scope.metricTarget;$scope.efficiencyChart.target.value=Number(metricTarget),$scope.efficiencyChart.formatter.averageTooltip=function(point){var htmlContent="Per Team Member: <b>{{unitPerAssignment | number: 1}}</b><br/>Team Size: <b>{{teamSize}}</b><br/>Total Units: <b>{{unit | number: 2}}</b><br/>",week=_.find(weeklyTeamMetrics,function(week){return week.startDate===point.id});return $interpolate(htmlContent)(week)},$scope.efficiencyChart.average.value=_.map(weeklyTeamMetrics,"unitPerAssignment"),$scope.efficiencyChart.lines=_.map(statsPerAssignments,function(assignment){return{id:assignment.id,name:assignment.name,value:_.map(assignment.stats,"unit"),color:UtilsService.getHexColor(assignment.id)}}),$scope.efficiencyChart.formatter.individualTooltip=function(point){var htmlContent="<b>{{assignment.name}}</b><br/>Units: <b>{{stat.unit}}</b><br/>",assignment=_.find(statsPerAssignments,function(assignment){return assignment.id===point.lineId}),stat=_.find(assignment.stats,function(stat){return stat.startDate===point.id});return $interpolate(htmlContent)({assignment:assignment,stat:stat})}}function refreshChartLegend(weeklyTeamMetrics,statsPerAssignments){var metricTarget=$scope.metricTarget,weeks=$scope.weeks;$scope.selectableMetricsLegend.target.value=Number(metricTarget);var accountedPeriod=MetricsDisplayService.findAccountedPeriod(weeks),tooltip="Weekly average from "+moment(accountedPeriod.start).format("MMMM DD")+" until "+moment(accountedPeriod.end).format("MMMM DD");$scope.selectableMetricsLegend.header.value="Avg. Units ("+accountedPeriod.weeks.length+" Weeks)",$scope.selectableMetricsLegend.header.tooltip=tooltip,$scope.selectableMetricsLegend.rows=_.chain(statsPerAssignments).map(function(assignment){var currWeekExcludedStats=_.filter(assignment.stats,MetricsDisplayService.isBeforeCurrentWeek),average=MetricsDisplayService.calIndividualAverage(currWeekExcludedStats),percentage=Math.round(average.unitPerWeek/metricTarget*100);return{id:assignment.id,description:assignment.name,effectiveDateEndInTeam:assignment.effectiveDateEndInTeam,color:UtilsService.getHexColor(assignment.id),value:average.unitPerWeek.toFixed(2),tooltip:tooltip,percentage:{value:"("+percentage+"%)",color:MetricsDisplayService.findPercentageColor(percentage)}}}).value(),$scope.selectableMetricsLegend.rows.sort(function(row1,row2){return Number(row2.value)-Number(row1.value)});var teamAverage=MetricsDisplayService.calTeamAverage(_.filter(weeklyTeamMetrics,MetricsDisplayService.isBeforeCurrentWeek));$scope.selectableMetricsLegend.average.value=teamAverage.unitPerWeek.toFixed(1),$scope.selectableMetricsLegend.average.tooltip=tooltip;var teamAveragePercentage=Math.round(teamAverage.unitPerWeek.toFixed(1)/metricTarget*100);$scope.selectableMetricsLegend.average.percentage={value:"("+teamAveragePercentage+"%)",color:MetricsDisplayService.findPercentageColor(teamAveragePercentage)}}$scope.broadcaster={},$scope.broadcaster.mouseEnter=function(assignment){$scope.$broadcast("metrics-chart-mouse-enter-assignment",{assignment:assignment})},$scope.broadcaster.mouseLeave=function(assignment){$scope.$broadcast("metrics-chart-mouse-leave-assignment",{assignment:assignment})},$scope.efficiencyChart={average:{id:MetricsDisplayService.AVERAGE.ID,value:[]},target:{id:MetricsDisplayService.METRIC_TARGET.ID,value:0,tooltipFormat:"Metric Target"},lines:[],formatter:{individualTooltip:null}},$scope.selectableMetricsLegend={header:{description:"Team Member"},average:{id:MetricsDisplayService.AVERAGE.ID,description:"Team Average",color:"#02A8F3"},target:{id:MetricsDisplayService.METRIC_TARGET.ID,description:"Metric Target",value:0},rows:[]},MetricsDisplayService.updateIndividualChartData($scope.metricsStats,$scope.assignments,$scope.toggledItems.normalize,refreshEfficiencyChart,refreshChartLegend),$scope.$watch("toggledItems.normalize",function(newValue){MetricsDisplayService.updateIndividualChartData($scope.metricsStats,$scope.assignments,newValue,refreshEfficiencyChart,refreshChartLegend)})}]),bandcampApp.directive("teamUnitChart",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/team-unit-chart.tpl.html",restrict:"E",scope:{weeks:"=",metricsStats:"=",metricTarget:"@",showCurrentWeek:"=",assignments:"="},link:function(){},controller:"TeamUnitChartCtrl"}}]),ctrls.controller("TeamUnitChartCtrl",["$scope","$interpolate","MetricsDisplayService",function($scope,$interpolate,MetricsDisplayService){function refreshVelocityChart(teamMetrics,target){var lastTeamSize=weeklyTeamMetrics[weeklyTeamMetrics.length-1].teamSize;$scope.velocityChart.target.value=target*lastTeamSize,$scope.velocityChart.columns=_.map(teamMetrics,function(week){return{id:week.startDate,value:week.unit}}),$scope.velocityChart.tooltipFormatter=function(column){var columnMetrics=_.find(teamMetrics,function(week){return week.startDate===column.id}),htmlContent="Total Units: <b>{{unit | number: 2}}</b><br/>Per Team Member: <b>{{unitPerAssignment | number: 1}}</b><br/>Team Size: <b>{{teamSize}}</b><br/>Cost Per Unit: <b>${{costPerUnit | number: 1}}</b>";return $interpolate(htmlContent)(columnMetrics)}}function refreshChartLegend(teamMetrics,target){var lastTeamSize=weeklyTeamMetrics[weeklyTeamMetrics.length-1].teamSize;$scope.metricsLegend.target.value=target*lastTeamSize,$scope.metricsLegend.rows=_.chain(teamMetrics).filter(MetricsDisplayService.isBeforeCurrentWeek).map(function(week){var monday=moment(week.startDate).format("MMM DD"),sunday=moment(week.startDate).add(6,"days").format("MMM DD"),value=week.unit.toFixed(2),percentage=Math.round(100*value/(target*lastTeamSize));return{id:week.startDate,description:monday+" - "+sunday,value:value,percentage:{value:"("+percentage+"%)",color:MetricsDisplayService.findPercentageColor(percentage)}}}).value().reverse();var teamAverageUnit=MetricsDisplayService.calculateWeeklyAverageUnit(_.filter(teamMetrics,MetricsDisplayService.isBeforeCurrentWeek));$scope.metricsLegend.average.value=teamAverageUnit.toFixed(1),$scope.metricsLegend.average.tooltip="The average does not include the week in progress";var averagePercentage=Math.round(100*$scope.metricsLegend.average.value/(target*lastTeamSize));$scope.metricsLegend.average.percentage={value:"("+averagePercentage+"%)",color:MetricsDisplayService.findPercentageColor(averagePercentage)}}$scope.broadcaster={},$scope.broadcaster.mouseEnter=function(week){$scope.$broadcast("metrics-chart-mouse-enter-week",{week:week})},$scope.broadcaster.mouseLeave=function(week){$scope.$broadcast("metrics-chart-mouse-leave-week",{week:week})},$scope.metricsLegend={header:{description:"Week",value:"Total Units"},average:{description:"Weekly Average",value:0},target:{description:"Metric Target",value:0},rows:[]},$scope.velocityChart={columns:[],target:{id:MetricsDisplayService.METRIC_TARGET.ID,tooltipFormat:"Metric Target"},tooltipFormatter:null};var weeklyTeamMetrics=MetricsDisplayService.calWeeklyTeamMetrics($scope.assignments,$scope.metricsStats);refreshVelocityChart(weeklyTeamMetrics,$scope.metricTarget),refreshChartLegend(weeklyTeamMetrics,$scope.metricTarget)}]),bandcampApp.directive("teamCostChart",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/team-cost-chart.tpl.html",restrict:"E",scope:{weeks:"=",metricsStats:"=",showCurrentWeek:"=",assignments:"="},link:function(){},controller:"TeamCostChartCtrl"}}]),ctrls.controller("TeamCostChartCtrl",["$scope","$interpolate","MetricsDisplayService",function($scope,$interpolate,MetricsDisplayService){function refreshVelocityChart(teamMetrics){$scope.velocityChart.columns=_.map(teamMetrics,function(week){var thisMonday=moment().weekday(moment.DAY_OF_WEEK.MONDAY),isCurrentWeek=0===moment(week.startDate).diff(thisMonday,"days"),HIDDEN=0;return isCurrentWeek&&0===week.unit?{id:week.startDate,value:HIDDEN}:{id:week.startDate,value:week.costPerUnit}}),$scope.velocityChart.tooltipFormatter=function(column){var columnMetrics=_.find(teamMetrics,function(week){return week.startDate===column.id}),htmlContent="Cost Per Unit: <b>${{costPerUnit | number: 1}}</b><br/>Total Units: <b>{{unit | number: 2}}</b><br/>Per Team Member: <b>{{unitPerAssignment | number: 1}}</b><br/>Team Size: <b>{{teamSize}}</b>";return $interpolate(htmlContent)(columnMetrics)}}function refreshChartLegend(teamMetrics,weeks){$scope.metricsLegend.rows=_.chain(teamMetrics).filter(MetricsDisplayService.isBeforeCurrentWeek).map(function(week){var monday=moment(week.startDate).format("MMM DD"),sunday=moment(week.startDate).add(6,"days").format("MMM DD");return{id:week.startDate,description:monday+" - "+sunday,value:"$"+week.costPerUnit.toFixed(1),tooltip:"The cost per unit is total number of units divided by the amount paid to the team members"}}).value().reverse();var teamAverage=MetricsDisplayService.calTeamAverage(_.filter(teamMetrics,MetricsDisplayService.isBeforeCurrentWeek));$scope.metricsLegend.average.value="$"+teamAverage.costPerUnit.toFixed(1);var accountedPeriod=MetricsDisplayService.findAccountedPeriod(weeks);$scope.metricsLegend.average.tooltip="The average is total number of units from "+moment(accountedPeriod.start).format("MMMM DD")+" until "+moment(accountedPeriod.end).format("MMMM DD")+", divided by the amount paid to the team members in the same period"}$scope.broadcaster={},$scope.broadcaster.mouseEnter=function(week){$scope.$broadcast("metrics-chart-mouse-enter-week",{week:week})},$scope.broadcaster.mouseLeave=function(week){$scope.$broadcast("metrics-chart-mouse-leave-week",{week:week})},$scope.metricsLegend={header:{description:"Week",value:"Cost per Unit"},average:{description:"Weekly Average",value:0},rows:[]},$scope.velocityChart={columns:[],yAxisLabelFormat:"${value}",tooltipFormatter:null};var weeklyTeamMetrics=MetricsDisplayService.calWeeklyTeamMetrics($scope.assignments,$scope.metricsStats);refreshVelocityChart(weeklyTeamMetrics),refreshChartLegend(weeklyTeamMetrics,$scope.weeks)}]),services.factory("ProductivityMetricChartSetting",[function(){var specificWeekFormatter=function(startDate){var week={from:moment(startDate).format("MMM DD"),to:moment(startDate).weekday(moment.DAY_OF_WEEK.SUNDAY).format("MMM DD")};return"Week: <b>"+week.from+" - "+week.to+"<b/>"},keepOriginalFormatter=function(originalFormatter){return function(data){return originalFormatter(data)}},defaultValues={xAxisStep:1,velocityColumnWidth:28,extendPointFormatter:keepOriginalFormatter,extendColumnFormatter:keepOriginalFormatter},Setting={FOUR_WEEKS:{xAxisStep:defaultValues.xAxisStep,velocityColumnWidth:defaultValues.velocityColumnWidth,extendPointFormatter:defaultValues.extendPointFormatter,extendColumnFormatter:defaultValues.extendColumnFormatter,weeks:[4,5]},EIGHT_WEEKS:{xAxisStep:defaultValues.xAxisStep,velocityColumnWidth:defaultValues.velocityColumnWidth,extendPointFormatter:defaultValues.extendPointFormatter,extendColumnFormatter:defaultValues.extendColumnFormatter,weeks:[8,9]},TWELVE_WEEKS:{xAxisStep:defaultValues.xAxisStep,velocityColumnWidth:defaultValues.velocityColumnWidth,extendPointFormatter:defaultValues.extendPointFormatter,extendColumnFormatter:defaultValues.extendColumnFormatter,weeks:[12,13]},SIX_MONTHS:{xAxisStep:2,velocityColumnWidth:12,extendPointFormatter:function(formatter){return function(pointWrapper){return formatter(pointWrapper)+"<br/>"+specificWeekFormatter(pointWrapper.point.id)}},extendColumnFormatter:function(formatter){return function(columnWrapper){return formatter(columnWrapper)+"<br/>"+specificWeekFormatter(columnWrapper.column.id)}},weeks:[26,27]}};return Setting.of=function(numberOfWeeks){return _.chain(Setting).values().find(function(setting){return _.contains(setting.weeks,numberOfWeeks)}).value()},Setting}]),bandcampApp.directive("velocityMetricsChart",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/component/velocity-metrics-chart.tpl.html",restrict:"E",scope:{weeks:"=",columns:"=",target:"=",showCurrentWeek:"=",yAxisLabelFormat:"@",tooltipFormatter:"&",broadcastMouseEnter:"&",broadcastMouseLeave:"&"},controller:"VelocityMetricsChartCtrl"}}]),ctrls.controller("VelocityMetricsChartCtrl",["$scope","MetricsDisplayService","ProductivityMetricChartSetting",function($scope,MetricsDisplayService,ChartSetting){function configureTargetLine(target,weeks){var firstPoint={y:target.value,marker:{enabled:!0,symbol:"url(images/icons/5b20372c.metric-target-icon.png)"}},otherPoints=_.map(weeks,function(){return target.value});return{id:target.id,type:"line",dashStyle:"Dot",color:"grey",pointStart:-.5,stickyTracking:!1,data:[firstPoint].concat(otherPoints),marker:{enabled:!1},tooltip:{useHTML:!0,headerFormat:"",delay:200,pointFormatter:function(){return target.tooltipFormat}},states:{hover:{enabled:!1}}}}function initializeChart(){var series=[columnsConfiguration($scope.weeks,$scope.columns,$scope.showCurrentWeek)],isValidTarget=$scope.target&&MetricsDisplayService.isValidMetricTarget($scope.target.value);isValidTarget&&series.push(configureTargetLine($scope.target,$scope.weeks)),$scope.config={series:series,options:{title:"",chart:{type:"column",events:{redraw:function(){$scope.config.getHighcharts().reflow()}}},legend:{enabled:!1},credits:{enabled:!1},yAxis:{title:{text:""},min:0,minRange:1,labels:{format:$scope.yAxisLabelFormat?$scope.yAxisLabelFormat:"{value}"}},tooltip:{useHTML:!0,headerFormat:"",pointFormatter:columnTooltipFormatter},xAxis:configureXAxis($scope.weeks)},func:postConstruction}}var X_AXIS="xAxis",chartSetting=ChartSetting.of($scope.weeks.length),TEAM_METRICS_ID="team-metrics-series",postConstruction=function(){$scope.$watch("showCurrentWeek",function(showCurrentWeek){var isMetricSeries=function(series){return series.options.id===TEAM_METRICS_ID};_.chain($scope.config.getHighcharts().series).filter(isMetricSeries).each(function(series){var dataPoints=_.map($scope.columns,"value"),refinedDataPoints=MetricsDisplayService.refineDataPoints(showCurrentWeek,$scope.weeks,dataPoints);series.update({data:refinedDataPoints})});var xAxis=$scope.config.getHighcharts().get(X_AXIS);if(showCurrentWeek)xAxis.update({max:$scope.weeks.length-1});else{var CURRENT_WEEK=1;xAxis.update({max:$scope.weeks.length-CURRENT_WEEK-1})}}),$scope.$on("metrics-chart-mouse-enter-week",function(event,data){var columnIndex=_.findIndex($scope.columns,function(column){return column.id===data.week});if(columnIndex>-1){var highchart=$scope.config.getHighcharts(),point=highchart.get(TEAM_METRICS_ID).data[columnIndex];point.setState("hover"),highchart.tooltip.refresh(point);var xLabel=highchart.xAxis[0].labelGroup.element.childNodes[columnIndex];$(xLabel).css("fill","black")}}),$scope.$on("metrics-chart-mouse-leave-week",function(event,data){var columnIndex=_.findIndex($scope.columns,function(column){return column.id===data.week});if(columnIndex>-1){var highchart=$scope.config.getHighcharts(),point=highchart.get(TEAM_METRICS_ID).data[columnIndex];point.setState(),highchart.tooltip.refresh(point);var xLabel=highchart.xAxis[0].labelGroup.element.childNodes[columnIndex];$(xLabel).css("fill","#999")}})},configureXAxis=function(weeks){return{id:X_AXIS,max:weeks.length-1,gridLineWidth:1,tickInterval:1,min:0,labels:{step:chartSetting.xAxisStep,formatter:xAxisLabelFormatter,style:{color:"#999","font-size":9,textOverflow:"none"}}}},xAxisLabelFormatter=function(){var week=$scope.weeks[this.value],monday=moment(week).format("MMM DD"),sunday=moment(week).add(6,"days").format("MMM DD");return monday+"<br/>"+sunday},columnTooltipFormatter=function(){var extendedColumnFormatter=chartSetting.extendColumnFormatter($scope.tooltipFormatter);return extendedColumnFormatter({column:$scope.columns[this.index]})},columnsConfiguration=function(weeks,columns,showCurrentWeek){var dataPoints=_.map($scope.columns,"value");return{id:TEAM_METRICS_ID,data:MetricsDisplayService.refineDataPoints(showCurrentWeek,weeks,dataPoints),pointWidth:chartSetting.velocityColumnWidth,color:"#6EBAF7",softThreshold:!1,point:{events:{mouseOver:function(){$scope.broadcastMouseEnter({week:$scope.columns[this.index].id})},mouseOut:function(){$scope.broadcastMouseLeave({week:$scope.columns[this.index].id})}}}}};$scope.config={options:{title:null}},initializeChart()}]),bandcampApp.directive("efficiencyMetricsChart",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/component/efficiency-metrics-chart.tpl.html",restrict:"E",scope:{weeks:"=",lines:"=",average:"=",target:"=",toggledItems:"=",yAxisLabelFormat:"@",averageTooltipFormatter:"&",individualTooltipFormatter:"&"},controller:"EfficiencyMetricsChartCtrl"}}]),ctrls.controller("EfficiencyMetricsChartCtrl",["$scope","MetricsDisplayService","ProductivityMetricChartSetting",function($scope,MetricsDisplayService,ChartSetting){function configureTargetLine(target,weeks){var FIRST_POINT=0,dataPoints=_.map(weeks,function(){return target.value});dataPoints[FIRST_POINT]={y:target.value,marker:{enabled:!0,symbol:"url(images/icons/5b20372c.metric-target-icon.png)"}};var ALWAYS_BOTTOM=-1e3;return{id:target.id,type:"line",dashStyle:"Dot",color:"grey",visible:!0,data:dataPoints,stickyTracking:!1,zIndex:ALWAYS_BOTTOM,marker:{enabled:!1},tooltip:{useHTML:!0,headerFormat:"",delay:200,pointFormatter:function(){return target.tooltipFormat}},states:{hover:{enabled:!1}}}}function initializeChart(){var series=configureIndividualLines($scope.weeks,$scope.lines,$scope.toggledItems,chartSetting.extendPointFormatter($scope.individualTooltipFormatter)).concat([configureAverageLine($scope.weeks,$scope.average,$scope.toggledItems,chartSetting.extendPointFormatter($scope.averageTooltipFormatter))]),isValidTarget=$scope.target&&MetricsDisplayService.isValidMetricTarget($scope.target.value);isValidTarget&&series.push(configureTargetLine($scope.target,$scope.weeks)),$scope.config={series:series,options:{title:"",chart:{spacingRight:20,events:{redraw:function(){$scope.config.getHighcharts().reflow()}}},legend:{enabled:!1},credits:{enabled:!1},yAxis:{title:{text:""},min:0,minRange:1,gridLineDashStyle:"Dot",labels:{format:$scope.yAxisLabelFormat?$scope.yAxisLabelFormat:"{value}"}},xAxis:configureXAxis($scope.weeks)},func:postConstruction}}function reloadChart(values){if($scope.config.getHighcharts){var chart=$scope.config.getHighcharts(),allValues=[$scope.average].concat(values);_.chain(allValues).each(function(val){var line=chart.get(val.id);line&&line.update({data:val.value})})}}var chartSetting=ChartSetting.of($scope.weeks.length),X_AXIS="xAxis",toggleCurrentWeek=function(line,showCurrentWeek,weeks){var allLineValues=[$scope.average].concat($scope.lines),dataPointLine=_.find(allLineValues,function(dataPointLine){return dataPointLine.id===line.options.id}),refinedDataPoints=MetricsDisplayService.refineDataPoints(showCurrentWeek,weeks,dataPointLine.value);line.update({data:refinedDataPoints})},pointEventHandlers={mouseOver:function(){var xLabel=this.series.chart.xAxis[0].labelGroup.element.childNodes[this.x];$(xLabel).css("fill","black")},mouseOut:function(){var xLabel=this.series.chart.xAxis[0].labelGroup.element.childNodes[this.x];$(xLabel).css("fill","#999")}},configureXAxis=function(weeks){var xAxisLabelFormatter=function(){var week=weeks[this.value],monday=moment(week).format("MMM DD"),sunday=moment(week).add(6,"days").format("MMM DD");return monday+"<br/>"+sunday};return{id:X_AXIS,max:weeks.length-1,gridLineWidth:1,tickInterval:1,labels:{step:chartSetting.xAxisStep,formatter:xAxisLabelFormatter,style:{color:"#999",textOverflow:"none","font-size":9}}}},configureAverageLine=function(weeks,average,toggledItems,tooltipFormatter){var pointFormatter=function(){return tooltipFormatter({point:{id:weeks[this.index],lineId:this.series.options.id}})};return{id:average.id,data:MetricsDisplayService.refineDataPoints(toggledItems.currentWeek,weeks,average.value),type:"line",color:"#02A8F3",lineWidth:4,stickyTracking:!1,softThreshold:!1,visible:toggledItems.average,marker:{symbol:"circle",fillColor:"#FFFFFF",lineWidth:2,lineColor:null},tooltip:{useHTML:!0,headerFormat:"",pointFormatter:pointFormatter},point:{events:pointEventHandlers},events:{show:function(){toggleCurrentWeek(this,$scope.toggledItems.currentWeek,weeks)}}}},configureIndividualLines=function(weeks,lines,toggledItems,tooltipFormatter){var pointFormatter=function(){return tooltipFormatter({point:{id:weeks[this.index],lineId:this.series.options.id}})},configureSingleLine=function(line){return{id:line.id,data:MetricsDisplayService.refineDataPoints(toggledItems.currentWeek,weeks,line.value),color:line.color,type:"area",stickyTracking:!1,softThreshold:!1,visible:_.contains(toggledItems.assignments,line.id),tooltip:{useHTML:!0,headerFormat:"",pointFormatter:pointFormatter},marker:{symbol:"circle",fillColor:"#FFFFFF",lineWidth:2,lineColor:null},fillColor:"transparent",connectNulls:!1,point:{events:pointEventHandlers},events:{show:function(){toggleCurrentWeek(this,$scope.toggledItems.currentWeek,weeks)}}}};return _.map(lines,configureSingleLine)},postConstruction=function(){$scope.$on("metrics-chart-mouse-enter-assignment",function(event,data){$scope.config.getHighcharts().get(data.assignment).update({fillColor:"rgba(2,168,243,0.1)"})}),$scope.$on("metrics-chart-mouse-leave-assignment",function(event,data){$scope.config.getHighcharts().get(data.assignment).update({fillColor:"transparent"})}),$scope.$watch("toggledItems.assignments.length",function(){var isAssignmentLine=function(line){return _.chain($scope.lines).map("id").contains(line.options.id).value()};_.chain($scope.config.getHighcharts().series).filter(isAssignmentLine).each(function(assignmentLine){var isVisible=_.contains($scope.toggledItems.assignments,assignmentLine.options.id);isVisible?assignmentLine.show():assignmentLine.hide()})}),$scope.$watch("toggledItems.average",function(isVisible){var isAverageLine=function(line){return $scope.average.id===line.options.id};_.chain($scope.config.getHighcharts().series).filter(isAverageLine).each(function(averageLine){isVisible?averageLine.show():averageLine.hide()})}),$scope.$watch("toggledItems",function(item){_.chain($scope.config.getHighcharts().series).filter(function(line){var isTargetLine=$scope.target&&$scope.target.id===line.options.id;return!isTargetLine&&line.visible}).each(function(line){toggleCurrentWeek(line,item.currentWeek,$scope.weeks)});var xAxis=$scope.config.getHighcharts().get(X_AXIS);if(item.currentWeek)xAxis.update({max:$scope.weeks.length-1});else{var CURRENT_WEEK=1;xAxis.update({max:$scope.weeks.length-CURRENT_WEEK-1})}},!0)};$scope.config={options:{title:null}},initializeChart(),$scope.$watch("lines",function(newValue){reloadChart(newValue)})}]),bandcampApp.directive("metricsLegend",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/component/metrics-legend.tpl.html",restrict:"E",scope:{header:"=",rows:"=",average:"=",target:"=",showCurrentWeek:"=",broadcastMouseEnter:"&",broadcastMouseLeave:"&"},controller:"MetricsLegendCtrl"}}]),ctrls.controller("MetricsLegendCtrl",["$scope","MetricsDisplayService",function($scope,MetricsDisplayService){$scope.hasScrollBar=$scope.rows.length>8,$scope.isValidTarget=function(target){return target&&MetricsDisplayService.isValidMetricTarget(target.value)},$scope.mouseEnter=function(rowId){$scope.broadcastMouseEnter({week:rowId})},$scope.mouseLeave=function(rowId){$scope.broadcastMouseLeave({week:rowId})},$scope.$on("metrics-chart-mouse-enter-week",function(event,data){var row=_.find($scope.rows,function(row){return row.id===data.week});row&&(row.hovered=!0)}),$scope.$on("metrics-chart-mouse-leave-week",function(event,data){var row=_.find($scope.rows,function(row){return row.id===data.week});row&&(row.hovered=!1)})}]),bandcampApp.directive("selectableMetricsLegend",["routePrefix",function(routePrefix){return{templateUrl:routePrefix+"manager/dashboard/metrics/display/chart/component/selectable-metrics-legend.tpl.html",restrict:"E",scope:{header:"=",rows:"=",target:"=",average:"=",toggledItems:"=",broadcastMouseEnter:"&",broadcastMouseLeave:"&"},controller:"SelectableMetricsLegendCtrl"}}]),ctrls.controller("SelectableMetricsLegendCtrl",["$scope","MetricsDisplayService",function($scope,MetricsDisplayService){$scope.hasScrollBar=$scope.rows.length>8,$scope.clickCheckbox=function($event){
var checkbox=$event.target;checkbox.checked?$scope.selectAllSelections():$scope.clearAllSelections()},$scope.isValidTarget=function(target){return target&&MetricsDisplayService.isValidMetricTarget(target.value)},$scope.selectAllSelections=function(){$scope.isAllSelected=!0;var allRows=_.map($scope.rows,"id");_.each(allRows,function(id){_.contains($scope.toggledItems.assignments,id)||$scope.toggledItems.assignments.push(id)})},$scope.clearAllSelections=function(){for(;$scope.toggledItems.assignments.length>0;)$scope.toggledItems.assignments.pop()},$scope.isSelected=function(rowId){return $scope.toggledItems.assignments.indexOf(rowId)>-1},$scope.toggle=function(rowId){var index=$scope.toggledItems.assignments.indexOf(rowId);index>-1?$scope.toggledItems.assignments.splice(index,1):$scope.toggledItems.assignments.push(rowId)},$scope.mouseEnter=function(rowId){$scope.broadcastMouseEnter({assignment:rowId})},$scope.mouseLeave=function(rowId){$scope.broadcastMouseLeave({assignment:rowId})},$scope.sortOrder={column:$scope.isValidTarget($scope.target)?"value":"sortValue",reverse:$scope.isValidTarget($scope.target)},$scope.sortTable=function(sortBy){$scope.sortOrder.column===sortBy?$scope.sortOrder.reverse=!$scope.sortOrder.reverse:$scope.sortOrder.reverse="description"!==sortBy,$scope.sortOrder.column=sortBy},$scope.$on("metrics-chart-mouse-enter-assignment",function(event,data){var row=_.find($scope.rows,function(row){return row.id===data.assignment});row&&(row.hovered=!0)}),$scope.$on("metrics-chart-mouse-leave-assignment",function(event,data){var row=_.find($scope.rows,function(row){return row.id===data.assignment});row&&(row.hovered=!1)}),$scope.$watch("toggledItems.assignments.length",function(){var allRows=_.map($scope.rows,"id");$scope.isAllSelected=$scope.toggledItems.assignments.length===allRows.length})}]),ctrls.controller("MetricSettingCtrl",["$scope","$q","$uibModalInstance","TeamService","MetricSettingAuthorization","AssignmentService","IntegrationsService","params",function($scope,$q,$uibModalInstance,TeamService,MetricSettingAuthorization,AssignmentService,IntegrationsService,params){$scope.modal=$uibModalInstance,$scope.params=params,$scope.visibility={JIRA:!1,ZENDESK:!1,MANUAL:!1,DESK:!1,SPREADSHEET:!1,SALESFORCE:!1,MENU:!1},$scope.showModal=function(modal){$scope.visibility={JIRA:!1,ZENDESK:!1,MANUAL:!1,DESK:!1,SPREADSHEET:!1,SALESFORCE:!1,MENU:!1},$scope.visibility[modal]=$scope.isPermittedMetric(modal)},$scope.showMenu=function(){$scope.showModal("MENU")},$scope.isPermittedMetric=function(metric){return"MANUAL"===metric||"MENU"===metric||$scope.permittedMetrics.indexOf(metric)>-1},$scope.isLoading=!0;var setupRequest=TeamService.getAllMetricSetups({id:params.team.id}).$promise.then(function(setups){$scope.metricSetups=setups}),integrationsRequest=IntegrationsService.metrics().$promise.then(function(_metrics){$scope.permittedMetrics=_metrics}),getFullTeam=!params.managerId,assignmentRequest=AssignmentService.list({fullTeam:getFullTeam,managerId:params.managerId,teamId:params.team.id,limit:1e3,status:"ACTIVE"}).$promise.then(function(resp){var assignments=resp.content;$scope.settingPermission=MetricSettingAuthorization.authorize(params.currentUser,params.team,assignments);var isAssignmentEditable=function(settingPermission,assignmentId){var isAssignmentManager=_.contains(settingPermission.teamMembers,assignmentId);return settingPermission.canEdit||isAssignmentManager};$scope.assignments=_.map(assignments,function(assignment){return{id:assignment.id,canEdit:isAssignmentEditable($scope.settingPermission,assignment.id),name:assignment.selection.marketplaceMember.application.candidate.printableName,jiraId:assignment.jiraId,jiraSetupId:assignment.jiraSetup?assignment.jiraSetup.id:null,deskId:assignment.deskId,deskSetupId:assignment.deskSetup?assignment.deskSetup.id:null,zendeskId:assignment.zendeskId,zendeskSetupId:assignment.zendeskSetup?assignment.zendeskSetup.id:null,salesforceId:assignment.salesforceId,salesforceSetupId:assignment.salesforceSetup?assignment.salesforceSetup.id:null}})});$q.all([setupRequest,assignmentRequest,integrationsRequest]).then(function(){var activeSetup=_.find($scope.metricSetups,function(setup){return setup.active&&setup.activedMetric}),modal="MENU";activeSetup&&(modal=activeSetup.type),$scope.showModal(modal),$scope.isLoading=!1})}]),bandcampApp.directive("metricSettingMenu",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/metric-setting-menu.tpl.html",scope:{modal:"=",showModal:"&"}}}]),bandcampApp.directive("checkServerButton",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/component/check-server-button.tpl.html",scope:{setting:"=",error:"="},controller:"CheckServerButtonCtrl"}}]),ctrls.controller("CheckServerButtonCtrl",["$scope","$interval","$interpolate","MetricProgressButton",function($scope,$interval,$interpolate,MetricProgressButton){$scope.btnProgress=new MetricProgressButton,$scope.btnProgress.click=function(){if(!$scope.btnProgress.isLoading()){$scope.btnProgress.load();var percentage=0,moveProgress=$interval(function(){percentage+=5,$scope.btnProgress.progress(percentage)},300);$scope.setting.checkServers().then(function(){$interval.cancel(moveProgress),$scope.btnProgress.succeed(),$scope.error=null})["catch"](function(failure){$interval.cancel(moveProgress),$scope.btnProgress.fail(),failure.error.data.text=$interpolate("[{{server}}] {{error}}")({server:failure.server.name,error:failure.error.data.text}),$scope.error=failure.error})}}}]),services.factory("MetricProgressButton",["$timeout",function($timeout){var STATE={INITIAL:"initial",LOADING:"loading",SUCCESS:"success",ERROR:"error"},MetricProgressButton=function(){this.state=STATE.INITIAL};return MetricProgressButton.prototype.isLoading=function(){return this.state===STATE.LOADING},MetricProgressButton.prototype.load=function(){this.state=STATE.LOADING,this.progress(0)},MetricProgressButton.prototype.succeed=function(){this.state=STATE.SUCCESS;var _this=this;$timeout(function(){_this.state=STATE.INITIAL},2e3)},MetricProgressButton.prototype.fail=function(){this.state=STATE.ERROR;var _this=this;$timeout(function(){_this.state=STATE.INITIAL},2e3)},MetricProgressButton.prototype.progress=function(percentage){var STARTING=205;this.offset=STARTING-Math.round(STARTING*percentage/100)},MetricProgressButton}]),bandcampApp.directive("metricServerInput",["routePrefix",function(routePrefix){return{restrict:"E",transclude:!0,templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/component/metric-server-input.tpl.html",scope:{setting:"=",focusedServer:"=",issueTracker:"@"},controller:"MetricServerInputCtrl"}}]),ctrls.controller("MetricServerInputCtrl",["$scope","$timeout","$uibModal","routePrefix",function($scope,$timeout,$uibModal,routePrefix){function getActiveTab(servers){var serverOfActiveTab=_.find(servers,function(server,index){var isLast=index===servers.length-1;return server.active&&isLast}),DEFAULT_ACTIVE=0;return serverOfActiveTab?servers.indexOf(serverOfActiveTab):DEFAULT_ACTIVE}$scope.openModal=function(server){var modalInstance=$uibModal.open({size:"sm",backdrop:"static",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/component/delete-setting-modal.tpl.html"}),yes=function(){$scope.setting.deleteServer(server)},no=function(){$scope.setting.disableServer(server)};modalInstance.result.then(yes,no)},$scope.addNewServer=function(){$scope.btnAddServer.disabled||$scope.setting.addNewServer()},$scope.toggle=function(server){if(server.active){var isLastServer=1===$scope.setting.servers.length;isLastServer?$scope.setting.disableServer(server):$scope.openModal(server)}else $scope.setting.enableServer(server)},$scope.$watch("setting.servers.length",function(){var servers=$scope.setting.servers;$timeout(function(){$scope.activeTab=getActiveTab(servers)});var MAXIMUM_SERVER=3;servers.length!==MAXIMUM_SERVER&&$scope.setting.permission.canEdit?$scope.btnAddServer={disabled:!1}:$scope.btnAddServer={disabled:!0}}),$scope.focus=function(server){$scope.focusedServer=server}}]),bandcampApp.directive("metricUserInput",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/component/metric-user-input.tpl.html",scope:{setting:"=",placeholder:"@"},controller:"MetricUserInputCtrl"}}]),ctrls.controller("MetricUserInputCtrl",["$scope",function($scope){$scope.$watch("setting.numOfCheckedServers",function(){$scope.metricUsers=_.chain($scope.setting.servers).map("users").flatten().uniq("id").value()}),$scope.listSuggestions=function(metricUserId){return _.chain($scope.metricUsers).filter(function(metricUser){var matchId=metricUser.id.indexOf(metricUserId)>-1,matchName=metricUser.name.indexOf(metricUserId)>-1;return matchId||matchName}).sortBy("name").value()},$scope.checkEscapeKey=function(config,keyCode){var TAB=9;keyCode===TAB&&(config.isEditing=!1)}}]),services.factory("AssignmentMetricConfig",["AssignmentService",function(AssignmentService){var AssignmentMetricConfig=function(assignment,metricServer,metricUserId,metricType){this.assignment=assignment,this.metricServer=metricServer,this.metricUserId=metricUserId,this.metricType=metricType};return AssignmentMetricConfig.prototype.clear=function(){this.metricServer=null},AssignmentMetricConfig.prototype.save=function(){var metricSetup=this.metricServer?{id:this.metricServer.id}:null,requestBody={metricSetup:metricSetup,metricUserId:this.metricUserId,metricType:this.metricType};return AssignmentService.updateMetricConfig({id:this.assignment.id},requestBody).$promise},AssignmentMetricConfig}]),services.factory("MetricServer",["$q","TeamService",function($q,TeamService){var MetricServer=function(setup){setup=setup||{active:!0},this.id=setup.id,this.host=setup.host,this.username=setup.username,this.password=setup.password,this.active=setup.active||!0,this.deleted=!1,this.checked=!1,this.projects=[],this.users=[]};return MetricServer.prototype.disable=function(){this.active=!1,this.checked=!1},MetricServer.prototype.enable=function(){this.active=!0},MetricServer.prototype["delete"]=function(teamId){this.deleted=!0;var requestDone=$q.defer();return this.id?TeamService.deleteSetup({id:teamId,setupId:this.id}).$promise.then(function(){requestDone.resolve()}):requestDone.resolve(),requestDone.promise},MetricServer.prototype.isDisabled=function(){return!this.active},MetricServer.prototype.isDeleted=function(){return this.deleted},MetricServer.prototype.check=function(teamId,metricType){var _this=this,requestDone=$q.defer(),server={id:this.id,type:metricType,host:this.host,username:this.username,password:this.password};return TeamService.getMetricServer({id:teamId},server).$promise.then(function(issueTracker){_this.projects=issueTracker.projects||[],_this.users=issueTracker.users||[],_this.checked=!0,requestDone.resolve()},function(error){requestDone.reject(error)}),requestDone.promise},MetricServer.prototype.save=function(teamId,setupInformation){var setupRequest,metricSetup=_.extend(setupInformation,{id:this.id,host:this.host,username:this.username,password:this.password,active:this.active}),_this=this,requestDone=$q.defer();return setupRequest=this.id?TeamService.updateSetup({id:teamId,setupId:this.id},metricSetup).$promise:TeamService.createSetup({id:teamId},metricSetup).$promise,setupRequest.then(function(savedSetup){_this.id=savedSetup.id,requestDone.resolve(savedSetup)},function(error){requestDone.reject(error)}),requestDone.promise},MetricServer}]),services.factory("MultipleServerSetting",["$q","MetricServer",function($q,MetricServer){var MultipleServerSetting=function(){this.permission={},this.numOfCheckedServers=0,this.teamId=null,this.metricName=null,this.metricTarget=null,this.servers=[],this.asgnConfigs=[]};return MultipleServerSetting.prototype.convertToServers=function(metricSetups){return _.map(metricSetups,function(setup,index){var server=new MetricServer(setup);return server.name="Server "+(index+1),server.active=setup.active||!0,server})},MultipleServerSetting.prototype.findActiveSetup=function(metricSetups){var activeSetup=_.find(metricSetups,function(setup){return setup.active});return activeSetup||{}},MultipleServerSetting.prototype.addNewServer=function(){var MAXIMUM_SERVERS=3;if(this.servers.length<MAXIMUM_SERVERS){var server=new MetricServer({});server.name="Server "+(this.servers.length+1),this.servers.push(server)}},MultipleServerSetting.prototype.deleteServer=function(server){var _this=this,success=function(){_this.disableServer(server),_this.servers=_.chain(_this.servers).filter(function(s){return!s.isDeleted()}).map(function(server,index){return server.name="Server "+(index+1),server}).value()};return server["delete"]().then(success)},MultipleServerSetting.prototype.disableServer=function(server){server.disable(),_.each(this.asgnConfigs,function(asgnConfig){asgnConfig.metricServer&&asgnConfig.metricServer.isDisabled()&&asgnConfig.clear()})},MultipleServerSetting.prototype.enableServer=function(server){server.enable()},MultipleServerSetting.prototype.save=function(){var _this=this,allRequestDone=$q.defer(),setupRequests=[];return this.permission.canEdit&&(setupRequests=_.map(this.servers,function(server){return server.save(_this.teamId,_this.toSetupInfo())})),$q.all(setupRequests).then(function(savedSetups){var isConfigEditable=function(asgnConfig){return asgnConfig.assignment.canEdit},asgnRequests=_.chain(_this.asgnConfigs).filter(isConfigEditable).map(function(asgnConfig){return asgnConfig.save()}).value();$q.all(asgnRequests).then(function(){allRequestDone.resolve(savedSetups)})},function(error){var errors=_.isArray(error)?error:[error];allRequestDone.reject(errors)}),allRequestDone.promise},MultipleServerSetting.prototype.isAllServerChecked=function(){return _.every(this.servers,function(server){return server.checked||!server.active})},MultipleServerSetting.prototype.checkServers=function(){var _this=this,allRequestDone=$q.defer(),checkRequests=_.map(this.servers,function(server){return server.check(_this.teamId,_this.type)});return $q.all(checkRequests).then(function(){_this.numOfCheckedServers=_.filter(_this.servers,"checked").length,allRequestDone.resolve(_this.numOfCheckedServers)},function(error){var failedServer=_.find(_this.servers,function(server){return server.active&&server.host===error.config.data.host});allRequestDone.reject({server:failedServer,error:error})}),allRequestDone.promise},MultipleServerSetting}]),services.factory("JiraSetting",["$q","JiraMetricServer","MultipleServerSetting","AssignmentMetricConfig","IntegrationsService",function($q,JiraMetricServer,MultipleServerSetting,AssignmentMetricConfig,IntegrationsService){var convertToServers=function(metricSetups){return _.map(metricSetups,function(setup,index){var server=new JiraMetricServer(setup);return server.name="Server "+(index+1),server.active=setup.active||!0,server})},JiraSetting=function(permission,metricSetups,assignments,teamId){var DEFAULT_SETUPS=[{}];metricSetups=metricSetups.length>0?metricSetups:DEFAULT_SETUPS;var activeSetup=this.findActiveSetup(metricSetups),_this=this;this.permission=permission,this.type="JIRA",this.numOfCheckedServers=0,this.teamId=teamId,this.metricName=activeSetup.metricName,this.metricTarget=activeSetup.metricTarget,this.servers=convertToServers(metricSetups),this.integration=IntegrationsService.get({type:"JIRA"}).$promise,this.asgnConfigs=_.map(assignments,function(assignment){var metricServer=_.find(_this.servers,function(server){return server.id===assignment.jiraSetupId});return new AssignmentMetricConfig(assignment,metricServer,assignment.jiraId,_this.type)})};return _.extend(JiraSetting.prototype,MultipleServerSetting.prototype),JiraSetting.prototype.addNewServer=function(){var MAXIMUM_SERVERS=3;if(this.servers.length<MAXIMUM_SERVERS){var server=new JiraMetricServer({});server.name="Server "+(this.servers.length+1),this.servers.push(server)}},JiraSetting.prototype.toSetupInfo=function(){return{type:this.type,activedMetric:!0,metricName:this.metricName,metricTarget:this.metricTarget}},JiraSetting}]),services.factory("JiraMetricServer",["$q","MetricServer","TeamService",function($q,MetricServer,TeamService){var QueryType={PROJECTS:"PROJECTS",CUSTOM:"CUSTOM",ADVANCED:"ADVANCED"},convertQuery=function(setup){if(setup.customQuery)return{type:QueryType.CUSTOM,customQuery:setup.customQuery};if(setup.advancedQuery)return{type:QueryType.ADVANCED,advancedQuery:setup.advancedQuery};var projects;if(setup.projects){var SEPARATOR=",";projects=_.chain(setup.projects.split(SEPARATOR)).map(function(project){return{id:project.trim()}}).filter(function(project){return!_.isEmpty(project.id)}).value()}var DEFAULT_PROJECTS=[{}];return{type:QueryType.PROJECTS,projects:projects||DEFAULT_PROJECTS}},JiraMetricServer=function(setup){MetricServer.call(this,setup),this.query=convertQuery(setup)};return JiraMetricServer.prototype=Object.create(MetricServer.prototype),JiraMetricServer.prototype.constructor=JiraMetricServer,JiraMetricServer.prototype.changeQueryType=function(queryType){if(queryType===QueryType.PROJECTS&&_.isEmpty(this.query.projects)){var DEFAULT_PROJECTS=[{}];this.query.projects=DEFAULT_PROJECTS}this.query.type=queryType},JiraMetricServer.prototype.addNewProject=function(){var NEW_PROJECT={};this.query.projects.push(NEW_PROJECT)},JiraMetricServer.prototype.removeProject=function(project){project.removed=!0,this.query.projects=_.filter(this.query.projects,function(p){return!p.removed})},JiraMetricServer.prototype.save=function(teamId,setupInformation){var setupRequest,projectString=_.map(this.query.projects||[],"id").toString(),metricSetup=_.extend(setupInformation,{id:this.id,host:this.host,username:this.username,password:this.password,active:this.active,projects:this.query.type===QueryType.PROJECTS?projectString:null,customQuery:this.query.type===QueryType.CUSTOM?this.query.customQuery:null,advancedQuery:this.query.type===QueryType.ADVANCED?this.query.advancedQuery:null}),_this=this,requestDone=$q.defer();return setupRequest=this.id?TeamService.updateSetup({id:teamId,setupId:this.id},metricSetup).$promise:TeamService.createSetup({id:teamId},metricSetup).$promise,setupRequest.then(function(savedSetup){_this.id=savedSetup.id,requestDone.resolve(savedSetup)},function(error){requestDone.reject(error)}),requestDone.promise},JiraMetricServer}]),bandcampApp.directive("jiraMetricInfo",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/jira/jira-metric-info.tpl.html",scope:{metricName:"=",metricTarget:"=",permission:"=",form:"=",server:"="},controller:"JiraMetricInfoCtrl"}}]),ctrls.controller("JiraMetricInfoCtrl",["$scope",function($scope){$scope.QueryType={PROJECTS:"PROJECTS",CUSTOM:"CUSTOM",ADVANCED:"ADVANCED"},$scope.switchQueryType=function(queryType){$scope.setting.query.type=queryType},$scope.listSuggestions=function(projectId){return _.chain($scope.server.projects).filter(function(suggestion){return suggestion.indexOf(projectId)>-1}).sortBy().value()}}]),bandcampApp.directive("jiraAdvancedQuery",function(){return{require:"ngModel",link:function(scope,elm,attrs,ctrl){ctrl.$parsers.unshift(function(viewValue){var hasContractor=viewValue.indexOf("[c]")>-1,hasWeekStart=viewValue.indexOf("[ws]")>-1,hasWeekEnd=viewValue.indexOf("[we]")>-1;return hasContractor&&hasWeekStart&&hasWeekEnd?(ctrl.$setValidity("query",!0),viewValue.replace("'[c]'","[c]").replace("'[ws]'","[ws]").replace("'[ws]'","[we]")):void ctrl.$setValidity("query",!1)})}}}),bandcampApp.directive("jiraSettingModal",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/jira/jira-setting-modal.tpl.html",scope:{modal:"=",showMenu:"&",settingPermission:"=",teamId:"=",metricSetups:"=",assignments:"="},controller:"JiraSettingModalCtrl"}}]),ctrls.controller("JiraSettingModalCtrl",["$scope","JiraSetting",function($scope,JiraSetting){var jiraSetups=_.filter($scope.metricSetups,function(setup){return"JIRA"===setup.type});$scope.setting=new JiraSetting($scope.settingPermission,jiraSetups,$scope.assignments,$scope.teamId),$scope.setting.integration.then(function(integration){integration.enabled||($scope.error={text:"Jira service is not enabled in your system. Please contact the administrator."},Object.assign($scope.setting.permission,{canEdit:!1,canSave:!1}))}),$scope.submit=function(){var failure=function(errors){$scope.isLoading=!1,$scope.error=errors[0]},success=function(savedSetup){$scope.modal.close(savedSetup)};$scope.setting.save().then(success,failure),$scope.isLoading=!0}}]),services.factory("DeskSetting",["$q","MetricServer","MultipleServerSetting","AssignmentMetricConfig","IntegrationsService",function($q,MetricServer,MultipleServerSetting,AssignmentMetricConfig,IntegrationsService){var DeskSetting=function(permission,metricSetups,assignments,teamId){var DEFAULT_SETUPS=[{}];metricSetups=metricSetups.length>0?metricSetups:DEFAULT_SETUPS;var activeSetup=this.findActiveSetup(metricSetups),_this=this;this.permission=permission,this.type="DESK",this.numOfCheckedServers=0,this.teamId=teamId,this.metricName=activeSetup.metricName,this.metricTarget=activeSetup.metricTarget,this.doneCriteria=activeSetup.doneCriteria,this.customQuery=activeSetup.customQuery,this.servers=this.convertToServers(metricSetups),this.integration=IntegrationsService.get({type:"DESK"}).$promise,this.asgnConfigs=_.map(assignments,function(assignment){var metricServer=_.find(_this.servers,function(server){return server.id===assignment.deskSetupId});return new AssignmentMetricConfig(assignment,metricServer,assignment.deskId,_this.type)})};return DeskSetting.prototype.toSetupInfo=function(){return{type:this.type,activedMetric:!0,metricName:this.metricName,metricTarget:this.metricTarget,doneCriteria:this.doneCriteria,customQuery:this.customQuery}},_.extend(DeskSetting.prototype,MultipleServerSetting.prototype),DeskSetting}]),bandcampApp.directive("deskMetricInfo",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/desk/desk-metric-info.tpl.html",scope:{setting:"="},controller:function($scope){$scope.DoneCriteria={RESOLVED:"resolved",CLOSED:"closed"}}}}]),bandcampApp.directive("deskSettingModal",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/desk/desk-setting-modal.tpl.html",scope:{modal:"=",showMenu:"&",settingPermission:"=",teamId:"=",metricSetups:"=",assignments:"="},controller:"DeskSettingModalCtrl"}}]),ctrls.controller("DeskSettingModalCtrl",["$scope","DeskSetting",function($scope,DeskSetting){var deskSetups=_.filter($scope.metricSetups,function(setup){return"DESK"===setup.type});$scope.setting=new DeskSetting($scope.settingPermission,deskSetups,$scope.assignments,$scope.teamId),$scope.setting.integration.then(function(integration){integration.enabled||($scope.error={text:"Desk service is not enabled in your system. Please contact the administrator."},Object.assign($scope.setting.permission,{canEdit:!1,canSave:!1}))}),$scope.submit=function(){var failure=function(errors){$scope.isLoading=!1,$scope.error=errors[0]},success=function(savedSetup){$scope.modal.close(savedSetup)};$scope.setting.save().then(success,failure),$scope.isLoading=!0}}]),services.factory("ZendeskSetting",["$q","MetricServer","MultipleServerSetting","AssignmentMetricConfig","IntegrationsService",function($q,MetricServer,MultipleServerSetting,AssignmentMetricConfig,IntegrationsService){var ZendeskSetting=function(permission,metricSetups,assignments,teamId){var DEFAULT_SETUPS=[{}];metricSetups=metricSetups.length>0?metricSetups:DEFAULT_SETUPS;var activeSetup=this.findActiveSetup(metricSetups),_this=this;this.permission=permission,this.type="ZENDESK",this.numOfCheckedServers=0,this.teamId=teamId,this.metricName=activeSetup.metricName,this.metricTarget=activeSetup.metricTarget,this.doneCriteria=activeSetup.doneCriteria,this.customQuery=activeSetup.customQuery,this.servers=this.convertToServers(metricSetups),this.integration=IntegrationsService.get({type:"ZENDESK"}).$promise,this.asgnConfigs=_.map(assignments,function(assignment){var metricServer=_.find(_this.servers,function(server){return server.id===assignment.zendeskSetupId});return new AssignmentMetricConfig(assignment,metricServer,assignment.zendeskId,_this.type)})};return ZendeskSetting.prototype.toSetupInfo=function(){return{type:this.type,activedMetric:!0,metricName:this.metricName,metricTarget:this.metricTarget,doneCriteria:this.doneCriteria,customQuery:this.customQuery}},_.extend(ZendeskSetting.prototype,MultipleServerSetting.prototype),ZendeskSetting}]),bandcampApp.directive("zendeskMetricInfo",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/zendesk/zendesk-metric-info.tpl.html",scope:{setting:"="},controller:function($scope){$scope.DoneCriteria={CLOSED:"closed",SOLVED:"solved"}}}}]),bandcampApp.directive("zendeskSettingModal",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/zendesk/zendesk-setting-modal.tpl.html",scope:{modal:"=",showMenu:"&",settingPermission:"=",teamId:"=",metricSetups:"=",assignments:"="},controller:"ZendeskSettingModalCtrl"}}]),ctrls.controller("ZendeskSettingModalCtrl",["$scope","ZendeskSetting",function($scope,ZendeskSetting){var zendeskSetups=_.filter($scope.metricSetups,function(setup){return"ZENDESK"===setup.type});$scope.DoneCriteria=ZendeskSetting.DoneCriteria,$scope.setting=new ZendeskSetting($scope.settingPermission,zendeskSetups,$scope.assignments,$scope.teamId),$scope.setting.integration.then(function(integration){integration.enabled||($scope.error={text:"Zendesk service is not enabled in your system. Please contact the administrator."},Object.assign($scope.setting.permission,{canEdit:!1,canSave:!1}))}),$scope.submit=function(){var failure=function(errors){$scope.isLoading=!1,$scope.error=errors[0]},success=function(savedSetup){$scope.modal.close(savedSetup)};$scope.setting.save().then(success,failure),$scope.isLoading=!0}}]),services.factory("ManualSetting",["$q","TeamService","AssignmentService",function($q,TeamService,AssignmentService){function getWeekPeriods(numberOfPastWeeks){for(var periods=[],week=numberOfPastWeeks;week>=0;week--)periods.push({from:moment().subtract(week,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).format(),to:moment().subtract(week,"weeks").weekday(moment.DAY_OF_WEEK.SUNDAY).format()});return periods}function getManualMetricValues(numberOfPastWeeks,teamId){var timeWindow=TeamService.getTimeWindow(numberOfPastWeeks),req={id:teamId,type:"MANUAL",from:timeWindow.from,to:timeWindow.to,refresh:!0},transform=function(response){return _.map(response,function(assignment){return _.each(assignment.stats,function(stat){stat.type="MANUAL"}),{assignmentId:assignment.assignmentId,metricValues:assignment.stats}})};return TeamService.getMetricValues(req).$promise.then(transform)}var ManualSetting=function(permission,manualSetup,assignments,teamId){var LAST_12_WEEKS=12;manualSetup=manualSetup||{},this.id=manualSetup.id,this.teamId=teamId,this.metricName=manualSetup.metricName,this.metricTarget=manualSetup.metricTarget,this.weeks=getWeekPeriods(LAST_12_WEEKS),this.type="MANUAL",this.permission=permission;var _this=this;getManualMetricValues(LAST_12_WEEKS,teamId).then(function(metricPerAssignments){_this.assignments=_.map(metricPerAssignments,function(metricPerAssignment){var assignment=_.find(assignments,function(assignment){return assignment.id===metricPerAssignment.assignmentId}),mapped=null;return assignment&&(mapped={id:assignment.id,name:assignment.name,canEdit:assignment.canEdit,metricValues:metricPerAssignment.metricValues}),mapped}),_this.assignments=_this.assignments.filter(function(assignment){return assignment&&assignment.id}),_this.assignments.resolved=!0})};return ManualSetting.prototype.save=function(){var setupRequest,manualSetup={id:this.id,type:this.type,active:!0,activedMetric:!0,metricName:this.metricName,metricTarget:this.metricTarget};this.permission.canEdit&&(setupRequest=manualSetup.id?TeamService.updateSetup({id:this.teamId,setupId:this.id},manualSetup).$promise:TeamService.createSetup({id:this.teamId},manualSetup).$promise);var _this=this,allRequestsDone=$q.defer();return $q.when(setupRequest).then(function(savedSetup){var metricValueRequests=_.chain(_this.assignments).filter(function(assignment){return assignment.canEdit}).map(function(assignment){return AssignmentService.updateMetricValues({id:assignment.id},assignment.metricValues).$promise});$q.all(metricValueRequests).then(function(){allRequestsDone.resolve(savedSetup)})}),allRequestsDone.promise},ManualSetting}]),bandcampApp.directive("manualMetricInput",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/manual/manual-metric-input.tpl.html",scope:{weeks:"=",assignments:"="},controller:"ManualMetricInputCtrl"}}]),ctrls.controller("ManualMetricInputCtrl",["$scope",function($scope){$scope.WINDOWS=[{from:0,to:3},{from:4,to:7},{from:8,to:13}],$scope.windowIndex=2,$scope.isLast=function(){return $scope.windowIndex===$scope.WINDOWS.length-1},$scope.isFirst=function(){return 0===$scope.windowIndex},$scope.next=function(){$scope.isLast()||$scope.windowIndex++},$scope.back=function(){$scope.isFirst()||$scope.windowIndex--},$scope.window=function(fullWeeks){for(var weeksInWindow=[],i=0;i<fullWeeks.length;i++){var window=$scope.WINDOWS[$scope.windowIndex];i>=window.from&&i<=window.to&&weeksInWindow.push(fullWeeks[i])}return weeksInWindow},$scope.startEditing=function(metricValue){metricValue.isEditing=!0},$scope.stopEditing=function(metricValue,event){event.target.checkValidity()&&(metricValue.isEditing=!1)}}]),bandcampApp.directive("manualSettingModal",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/manual/manual-setting-modal.tpl.html",scope:{modal:"=",showMenu:"&",settingPermission:"=",assignments:"=",metricSetups:"=",teamId:"=",managerId:"="},controller:"ManualSettingModalCtrl"}}]),ctrls.controller("ManualSettingModalCtrl",["$scope","ManualSetting",function($scope,ManualSetting){var manualSetups=_.filter($scope.metricSetups,function(setup){return"MANUAL"===setup.type});if(manualSetups.length>1)throw new Error("User has more than one manual setup!");var manualSetup=manualSetups.length>0?manualSetups[0]:{};$scope.setting=new ManualSetting($scope.settingPermission,manualSetup,$scope.assignments,$scope.teamId),$scope.submit=function(){var failure=function(error){$scope.isLoading=!1,$scope.error=error},success=function(savedSetup){$scope.modal.close(savedSetup)};$scope.isLoading=!0,$scope.setting.save().then(success,failure)},$scope.isLoading=!0,$scope.$watch("setting.assignments.resolved",function(isResolved){isResolved&&($scope.isLoading=!1)})}]),services.factory("SalesforceSetting",["$q","TeamService","AssignmentService","IntegrationsService",function($q,TeamService,AssignmentService,IntegrationsService){var SalesforceSetting=function(permission,salesforceSetup,assignments,teamId){this.teamId=teamId,this.id=salesforceSetup.id,this.metricName=salesforceSetup.metricName,this.metricTarget=salesforceSetup.metricTarget,this.assignments=assignments,this.type="SALESFORCE",this.permission=permission,this.integration=IntegrationsService.get({type:"SALESFORCE"}).$promise};return SalesforceSetting.prototype.save=function(){var setupReq,salesforceSetup={id:this.id,type:this.type,active:!0,activedMetric:!0,metricName:this.metricName,metricTarget:this.metricTarget};this.permission.canEdit&&(setupReq=salesforceSetup.id?TeamService.updateSetup({id:this.teamId,setupId:this.id},salesforceSetup).$promise:TeamService.createSetup({
id:this.teamId},salesforceSetup).$promise);var _this=this,allRequestsDone=$q.defer();return $q.when(setupReq).then(function(savedSetup){var assignmentRequests=_.chain(_this.assignments).filter(function(assignment){return assignment.canEdit}).map(function(assignment){var metricConfig={metricSetup:savedSetup,metricUserId:assignment.salesforceId,metricType:_this.type};return AssignmentService.updateMetricConfig({id:assignment.id},metricConfig).$promise}).value();$q.all(assignmentRequests).then(function(){allRequestsDone.resolve(savedSetup)})}),allRequestsDone.promise},SalesforceSetting}]),bandcampApp.directive("salesforceSettingModal",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/salesforce/salesforce-setting-modal.tpl.html",scope:{modal:"=",showMenu:"&",settingPermission:"=",teamId:"=",metricSetups:"=",assignments:"="},controller:"SalesforceSettingModalCtrl"}}]),ctrls.controller("SalesforceSettingModalCtrl",["$scope","SalesforceSetting",function($scope,SalesforceSetting){var salesforceSetups=_.filter($scope.metricSetups,function(setup){return"SALESFORCE"===setup.type});if(salesforceSetups.length>1)throw new Error("Team "+$scope.teamId+" must have only one salesforce setup! ");var salesforceSetup=salesforceSetups.length>0?salesforceSetups[0]:{};$scope.setting=new SalesforceSetting($scope.settingPermission,salesforceSetup,$scope.assignments,$scope.teamId),$scope.setting.integration.then(function(integration){integration.enabled||($scope.error={text:"Salesforce service is not enabled in your system. Please contact the administrator."},Object.assign($scope.setting.permission,{canEdit:!1,canSave:!1}))}),$scope.submit=function(){var success=function(savedSetup){$scope.modal.close(savedSetup)},failure=function(error){$scope.error=error,$scope.isLoading=!1};$scope.setting.save().then(success,failure),$scope.isLoading=!0}}]),services.factory("SpreadsheetSetting",["$q","TeamService","IntegrationsService",function($q,TeamService,IntegrationsService){var SpreadsheetSetting=function(spreadsheetSetup,teamId){this.type="SPREADSHEET",this.teamId=teamId,this.id=spreadsheetSetup.id,this.metricName=spreadsheetSetup.metricName,this.metricTarget=spreadsheetSetup.metricTarget,this.host=spreadsheetSetup.host,this.spreadsheetAccess=spreadsheetSetup.spreadsheetAccess,this.worksheetName=spreadsheetSetup.worksheetName,this.integration=IntegrationsService.get({type:"GOOGLESS"}).$promise;var _this=this;TeamService.getSpreadsheetAuthUrl(teamId).then(function(res){_this.authUrl=res.data})};return SpreadsheetSetting.prototype.save=function(){var spreadsheetSetup={id:this.id,host:this.host,password:this.code,type:this.type,active:!0,activedMetric:!0,metricName:this.metricName,metricTarget:this.metricTarget,worksheetName:this.worksheetName,spreadsheetAccess:this.spreadsheetAccess};return this.id?TeamService.updateSetup({id:this.teamId,setupId:this.id},spreadsheetSetup).$promise:TeamService.createSetup({id:this.teamId},spreadsheetSetup).$promise},SpreadsheetSetting}]),bandcampApp.directive("spreadsheetSettingModal",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/dashboard/metrics/setting/type/spreadsheet/spreadsheet-setting-modal.tpl.html",scope:{modal:"=",showMenu:"&",settingPermission:"=",teamId:"=",metricSetups:"="},controller:"SpreadsheetSettingModalCtrl"}}]),ctrls.controller("SpreadsheetSettingModalCtrl",["$scope","SpreadsheetSetting",function($scope,SpreadsheetSetting){var spreadsheetSetups=_.filter($scope.metricSetups,function(setup){return"SPREADSHEET"===setup.type});if(spreadsheetSetups.length>1)throw new Error("Team "+$scope.teamId+" must have only one spreadsheet setup! ");var spreadsheetSetup=spreadsheetSetups.length>0?spreadsheetSetups[0]:{spreadsheetAccess:"SHARED"};$scope.setting=new SpreadsheetSetting(spreadsheetSetup,$scope.teamId),$scope.setting.integration.then(function(integration){integration.enabled||($scope.error={text:"Google Spreadsheet service is not enabled in your system. Please contact the administrator."},$scope.settingPermission.canEdit=!1)}),$scope.submit=function(){var success=function(savedSetup){$scope.modal.close(savedSetup)},failure=function(response){$scope.isLoading=!1,$scope.error=response};$scope.setting.save().then(success,failure),$scope.isLoading=!0}}]),ctrls.controller("CheckinCtrl",["$scope","AssignmentService","CheckinManager","$routeParams","CurrentUser",function($scope,AssignmentService,CheckinManager,$routeParams,CurrentUser){$scope.teamId=$routeParams.team,$scope.managerId=$routeParams.managerId,$scope.isLoading=!0,CurrentUser.get(function(u){$scope.user=u});var req={status:"ACTIVE",limit:1e3,teamId:$scope.teamId,managerId:$scope.managerId,fullTeam:!$scope.managerId};AssignmentService.teamAssignments(req).$promise.then(function(data){$scope.assignments=data.content,$scope.checkinManager=new CheckinManager($scope.teamId,$scope.managerId,_.map($scope.assignments,"id"))})["catch"](function(error){$scope.error=error})["finally"](function(){$scope.isLoading=!1}),$scope.broadcastCheckinSaved=function(checkin){$scope.$broadcast("checkin-checkin-saved",{checkin:checkin})},$scope.broadcastSwitchView=function(view){$scope.$broadcast("checkin-summary-switch-view",view)}}]),services.factory("CheckinControlPanelPeriod",["CheckinSpecificTimeRange",function(TimeRange){var Period={};return Period.DAILY={key:"DAILY",specificTimeRanges:[TimeRange.TODAY,TimeRange.YESTERDAY],toTimeRange:function(date){return{from:moment(date).format(moment.DateFormat.ISO_8601),to:moment(date).format(moment.DateFormat.ISO_8601)}},format:function(date){return moment(date).format("dddd, MMM D, YYYY")}},Period.WEEKLY={key:"WEEKLY",specificTimeRanges:[TimeRange.THIS_WEEK,TimeRange.LAST_WEEK],toTimeRange:function(date){return{from:moment(date).weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),to:moment(date).weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)}},format:function(date){var timeRange=this.toTimeRange(date);return moment(timeRange.from).format("ddd D")+" - "+moment(timeRange.to).format("ddd D, MMM")}},Period.MONTHLY={key:"MONTHLY",specificTimeRanges:[TimeRange.THIS_MONTH,TimeRange.LAST_MONTH],toTimeRange:function(date){return{from:moment(date).startOf("month").format(moment.DateFormat.ISO_8601),to:moment(date).endOf("month").format(moment.DateFormat.ISO_8601)}},format:function(date){return moment(date).format("MMMM, YYYY")}},Period.valueOf=function(periodMode){return Period[periodMode]},Period}]),services.factory("CheckinSpecificTimeRange",[function(){var TODAY={inRange:function(date){var startDate=moment(this.getStartDate()).subtract(1,"days"),endDate=moment(this.getStartDate()).add(1,"days");return moment(date).isBetween(startDate,endDate)},getStartDate:function(){return moment().format(moment.DateFormat.ISO_8601)}},YESTERDAY={inRange:function(date){var startDate=moment(this.getStartDate()).subtract(1,"days"),endDate=moment(this.getStartDate()).add(1,"days");return moment(date).isBetween(startDate,endDate)},getStartDate:function(){return moment().subtract(1,"days").format(moment.DateFormat.ISO_8601)}},THIS_WEEK={inRange:function(date){var startDate=moment(this.getStartDate()).subtract(1,"days"),endDate=moment(this.getStartDate()).add(1,"weeks");return moment(date).isBetween(startDate,endDate)},getStartDate:function(){return moment().weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601)}},LAST_WEEK={inRange:function(date){var startDate=moment(this.getStartDate()).subtract(1,"days"),endDate=moment(this.getStartDate()).add(1,"weeks");return moment(date).isBetween(startDate,endDate)},getStartDate:function(){return moment().subtract(1,"weeks").weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601)}},THIS_MONTH={inRange:function(date){var startDate=moment(this.getStartDate()).subtract(1,"days"),endDate=moment(this.getStartDate()).add(1,"months");return moment(date).isBetween(startDate,endDate)},getStartDate:function(){return moment().startOf("month").format(moment.DateFormat.ISO_8601)}},LAST_MONTH={inRange:function(date){var startDate=moment(this.getStartDate()).subtract(1,"days"),endDate=moment(this.getStartDate()).add(1,"months");return moment(date).isBetween(startDate,endDate)},getStartDate:function(){return moment().subtract(1,"months").startOf("month").format(moment.DateFormat.ISO_8601)}};return{TODAY:TODAY,YESTERDAY:YESTERDAY,THIS_WEEK:THIS_WEEK,LAST_WEEK:LAST_WEEK,THIS_MONTH:THIS_MONTH,LAST_MONTH:LAST_MONTH}}]),bandcampApp.directive("checkinDropdown",["routePrefix",function(routePrefix){return{restrict:"E",transclude:!0,templateUrl:routePrefix+"manager/checkin/control-panel/checkin-dropdown.tpl.html",controller:"CheckinDropdownCtrl",scope:{description:"@",selectedItem:"=",items:"="}}}]),ctrls.controller("CheckinDropdownCtrl",["$scope",function($scope){$scope.isOpen=!1,$scope.select=function(selectedItem){$scope.selectedItem=selectedItem},$scope.$watch("items",function(items){$scope.selectedItem=$scope.selectedItem||_.first(items)})}]),bandcampApp.directive("checkinControlPanel",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/control-panel/checkin-control-panel.tpl.html",controller:"CheckinControlPanelCtrl",scope:{periodMode:"=",timeRange:"=",selectedAssignment:"=",assignments:"="}}}]),ctrls.controller("CheckinControlPanelCtrl",["$scope","CheckinControlPanelPeriod","CheckinSpecificTimeRange",function($scope,Period,SpecificTimeRange){$scope.Period=Period,$scope.SpecificTimeRange=SpecificTimeRange,$scope.periodMode=$scope.Period.DAILY.key,$scope.period=Period.valueOf($scope.periodMode),$scope.specifyTimeRange=function(specificTimeRange){$scope.specificTimeRange=specificTimeRange,$scope.pickedDate=specificTimeRange.getStartDate(),$scope.timeRange=$scope.period.toTimeRange($scope.pickedDate)},$scope.updateTimeRange=function(period,pickedDate){$scope.timeRange=period.toTimeRange(pickedDate),$scope.specificTimeRange=_.find(period.specificTimeRanges,function(specificTimeRange){return specificTimeRange.inRange(pickedDate)})},$scope.$on("checkin-summary-switch-view",function(event,data){$scope.periodMode=data.periodMode,$scope.pickedDate=data.pickedDate}),$scope.$watch("periodMode",function(newPeriodMode){$scope.period=Period.valueOf(newPeriodMode),$scope.updateTimeRange($scope.period,$scope.pickedDate)}),$scope.$watch("pickedDate",function(newPickedDate){$scope.timeRange=$scope.period.toTimeRange(newPickedDate),$scope.updateTimeRange($scope.period,$scope.pickedDate)}),$scope.$watch("assignments",function(assignments){$scope.items=_.chain(assignments).map(function(assignment){return{id:assignment.id,name:assignment.selection.marketplaceMember.application.candidate.printableName}}).sortBy("name").value();var DEFAULT_OPTION={id:-1,name:"All Members"};$scope.items=[DEFAULT_OPTION].concat($scope.items)}),$scope.$watch("selectedItem",function(selectedItem){$scope.selectedAssignment=_.find($scope.assignments,function(assignment){return assignment.id===selectedItem.id})})}]),services.factory("CheckinSummaryPeriod",[function(){var Period={};return Period.DAILY={key:"DAILY",toSummaryTimeRange:function(timeRange){return{from:moment(timeRange.from).weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),to:moment(timeRange.from).weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)}},toDateBlocks:function(from,to){for(var startDate=moment(from),endDate=moment(to).add(1,"days"),dateBlocks=[];startDate.isBefore(endDate);){var isWeekDay=startDate.weekday()!==moment.DAY_OF_WEEK.SATURDAY&&startDate.weekday()!==moment.DAY_OF_WEEK.SUNDAY;if(isWeekDay){var block={from:startDate.format(moment.DateFormat.ISO_8601),to:startDate.format(moment.DateFormat.ISO_8601)};dateBlocks.push(block)}startDate.add(1,"days")}return dateBlocks},viewDateBlock:function(dateBlock){return{periodMode:Period.DAILY.key,pickedDate:dateBlock.from}},format:function(dateBlock){return moment(dateBlock.from).format("dddd D")}},Period.WEEKLY={key:"WEEKLY",toSummaryTimeRange:function(timeRange){return timeRange},toDateBlocks:function(from,to){for(var startDate=moment(from),endDate=moment(to).add(1,"days"),dateBlocks=[];startDate.isBefore(endDate);){var isWeekDay=startDate.weekday()!==moment.DAY_OF_WEEK.SATURDAY&&startDate.weekday()!==moment.DAY_OF_WEEK.SUNDAY;if(isWeekDay){var block={from:startDate.format(moment.DateFormat.ISO_8601),to:startDate.format(moment.DateFormat.ISO_8601)};dateBlocks.push(block)}startDate.add(1,"days")}return dateBlocks},viewDateBlock:function(dateBlock){return{periodMode:Period.DAILY.key,pickedDate:dateBlock.from}},format:function(dateBlock){return moment(dateBlock.from).format("dddd D")}},Period.MONTHLY={key:"MONTHLY",toSummaryTimeRange:function(timeRange){return{from:moment(timeRange.from).weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),to:moment(timeRange.to).weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)}},toDateBlocks:function(from,to){for(var startDate=moment(from).weekday(moment.DAY_OF_WEEK.MONDAY),endDate=moment(to).add(1,"days"),dateBlocks=[];startDate.isBefore(endDate);){var block={from:startDate.format(moment.DateFormat.ISO_8601),to:moment(startDate.toDate()).weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)};dateBlocks.push(block),startDate.add(1,"weeks")}return dateBlocks},viewDateBlock:function(dateBlock){return{periodMode:Period.WEEKLY.key,pickedDate:dateBlock.from}},format:function(dateBlock){return moment(dateBlock.from).format("MMM D")+" - "+moment(dateBlock.to).format("MMM D")}},Period.valueOf=function(key){return Period[key]},Period}]),bandcampApp.directive("checkinSummary",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/summary/checkin-summary.tpl.html",controller:"CheckinSummaryCtrl",scope:{switchViewCallback:"&",periodMode:"@",controlPanelTimeRange:"=",checkinManager:"=",selectedAssignment:"="}}}]),ctrls.controller("CheckinSummaryCtrl",["$scope","CheckinStatus","CheckinSummaryPeriod",function($scope,CheckinStatus,Period){$scope.isLoading=!0,$scope.switchView=function(dateBlock){var view=$scope.period.viewDateBlock(dateBlock);$scope.switchViewCallback({view:view})};var refreshSummary=function(){var assignmentId=$scope.selectedAssignment?$scope.selectedAssignment.id:null;$scope.period=Period.valueOf($scope.periodMode),$scope.timeRange=$scope.period.toSummaryTimeRange($scope.controlPanelTimeRange),$scope.checkinManager.findCheckins($scope.timeRange.from,$scope.timeRange.to,assignmentId).then(function(checkins){$scope.tableCheckins=checkins,$scope.chartCheckins=checkins;var NOT_AVAILABLE=null;$scope.specificDate=NOT_AVAILABLE,$scope.period===Period.DAILY&&($scope.specificDate=$scope.controlPanelTimeRange.from,$scope.chartCheckins=_.filter(checkins,function(checkin){return checkin.date===$scope.specificDate}))})["catch"](function(error){$scope.error=error})["finally"](function(){$scope.isLoading=!1})},throttledRefreshSummary=_.debounce(refreshSummary,50);$scope.$watch("controlPanelTimeRange",throttledRefreshSummary),$scope.$watch("selectedAssignment",throttledRefreshSummary),$scope.$on("checkin-checkin-saved",throttledRefreshSummary)}]),bandcampApp.directive("checkinSummaryChart",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/summary/checkin-summary-chart.tpl.html",controller:"CheckinSummaryChartCtrl",scope:{checkins:"="}}}]),ctrls.controller("CheckinSummaryChartCtrl",["$scope","$interpolate","CheckinStatus",function($scope,$interpolate,CheckinStatus){$scope.$watch("checkins",function(){if(!_.isEmpty($scope.checkins)){var countStatus=function(status,checkins){return _.chain(checkins).filter(function(checkin){return checkin.status===status}).size().value()},calculatePercentage=function(status,checkins){var count=countStatus(status,checkins),total=checkins.length;return Math.round(100*count/total)},onTrackPercentage=calculatePercentage(CheckinStatus.ON_TRACK,$scope.checkins);$scope.chartConfig.title.text=buildChartTitle(onTrackPercentage,CheckinStatus.ON_TRACK.name),$scope.chartConfig.series[0].data=_.map(CheckinStatus.values(),function(status){return{name:status.name,color:status.color,y:countStatus(status,$scope.checkins)}})}});var buildChartTitle=function(percentage,statusName){var padSpace=function(str,length){for(;str.length<length;)str=" "+str;return str},MAX_LETTER=3,data={percentage:padSpace(percentage.toString(),MAX_LETTER),status:statusName.toUpperCase()},html='<div style="color:#52616B;font-size:30px;white-space:pre;">{{percentage}}<sup>%</sup></div>';return html+='<span style="color:#A7A8AC;font-size:13px;">{{status}}</span>',$interpolate(html)(data)},chartConfiguration=function(){return{options:{chart:{type:"pie",margin:[20,0,0,0],spacingTop:0,spacingBottom:0,spacingLeft:0,spacingRight:0},legend:{enabled:!1}},title:{y:155,floating:!0,useHTML:!0,text:""},series:[{id:"checkin",data:[],size:"100%",innerSize:"60%",showInLegend:!0,dataLabels:{enabled:!1},tooltip:{headerFormat:"",pointFormatter:function(){return"<b>"+this.name+"</b>: "+this.y}}}]}};$scope.chartConfig=chartConfiguration()}]),bandcampApp.directive("checkinSummaryTable",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/summary/table/checkin-summary-table.tpl.html",controller:"CheckinSummaryTableCtrl",scope:{isLoading:"=",switchView:"&",checkins:"=",timeRange:"=",period:"=",specificDate:"="}}}]),ctrls.controller("CheckinSummaryTableCtrl",["$scope","uiGridConstants","CheckinStatus","routePrefix",function($scope,uiGridConstants,CheckinStatus,routePrefix){$scope.$watch("checkins",function(){if(!_.isEmpty($scope.checkins)){var dateBlocks=$scope.period.toDateBlocks($scope.timeRange.from,$scope.timeRange.to),dateColumnDefs=_.map(dateBlocks,function(dateBlock,key){return{name:$scope.period.format(dateBlock),field:key.toString(),sortDirectionCycle:[],headerCellTemplate:routePrefix+"manager/checkin/summary/table/checkin-summary-table-clickable-header.tpl.html",cellTemplate:routePrefix+"manager/checkin/summary/table/checkin-summary-table-checkin-count-cell.tpl.html",dateBlock:dateBlock,isCheckinAvailable:moment().isAfter(dateBlock.from),isHighlighted:$scope.specificDate===dateBlock.from}});$scope.gridOptions.columnDefs=[{name:"",field:"status",minWidth:"135",headerCellTemplate:routePrefix+"manager/checkin/summary/table/checkin-summary-table-nonclickable-header.tpl.html",cellTemplate:routePrefix+"manager/checkin/summary/table/checkin-summary-table-status-cell.tpl.html"},{name:"total",field:"total",sortDirectionCycle:[uiGridConstants.ASC,uiGridConstants.DESC]}],$scope.gridOptions.columnDefs=$scope.gridOptions.columnDefs.concat(dateColumnDefs),$scope.gridOptions.data=_.chain(CheckinStatus.values()).map(function(status){var checkinsOfStatus=_.filter($scope.checkins,function(checkin){return checkin.status===status}),statusRow={status:status,total:checkinsOfStatus.length};return _.each(dateBlocks,function(dateBlock,key){var from=moment(dateBlock.from).subtract(1,"days"),to=moment(dateBlock.to).add(1,"days"),inBlock=function(date){return moment(date).isBetween(from,to)};statusRow[key.toString()]=_.chain(checkinsOfStatus).map("date").filter(inBlock).size().value()}),statusRow}).filter(function(row){return row.total>0}).value()}}),$scope.gridOptions={rowTemplate:routePrefix+"manager/checkin/summary/table/checkin-summary-table-row.tpl.html",enableColumnMenus:!1,enableHorizontalScrollbar:0,enableVerticalScrollbar:0}}]),bandcampApp.directive("checkinTrendChart",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/member/checkin-trend-chart.tpl.html",scope:{weeks:"=",values:"="},controller:function($scope){function chartConfiguration(weeks,values){function xAxisConfiguration(weeks){return{type:"datetime",labels:{enabled:!0,formatter:function(){return moment(weeks[this.value]).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"},padding:0},reversed:!0,tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,lineWidth:0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"}}function yAxisConfiguration(){return{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""}}}function trendSeriesConfiguration(values){return{name:"Trend",data:values,animation:!1,allowPointSelect:!0,dataLabels:{enabled:!0,align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},format:"{point.y:,.0f}"},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3",states:{select:{fillColor:"#02a8f3",radius:4,lineWidth:0}}},color:"#e5f6fe"}}return{options:{chart:{type:"area"},legend:{enabled:!1},tooltip:{enabled:!1}},title:{text:""},subtitle:{text:""},size:{width:348,height:190},xAxis:xAxisConfiguration(weeks),yAxis:yAxisConfiguration(),series:[trendSeriesConfiguration(values)]}}$scope.chartConfig=chartConfiguration($scope.weeks,$scope.values)}}}]),bandcampApp.directive("checkinMetricTrendPopup",["$compile","PopupPositioner","routePrefix",function($compile,PopupPositioner,routePrefix){return{restrict:"E",transclude:!0,templateUrl:routePrefix+"manager/checkin/member/checkin-metric-trend-popup.tpl.html",scope:{weeks:"=",values:"=",width:"@",height:"@"},link:function($scope,element){$scope.metricName="Tickets Resolved",$scope.visible=!1,element.parent().on("mouseenter",function(){$scope.visible=!0,$scope.$digest()}).on("mouseleave",function(){$scope.visible=!1,$scope.$digest()}),$scope.$watch("visible",function(){if($scope.visible){var tooltipElement=angular.element(element[0].querySelector(".popup")),position=PopupPositioner.position(element.parent(),tooltipElement),prodDiv=angular.element(".manager-checkin").offset();position.top=position.top-prodDiv.top,position.top+="px",position.left+="px",tooltipElement.css(position)}})}}}]),services.factory("PopupPositioner",["$window","$document",function($window,$document){var offset=function(element){var boundingClientRect=element[0].getBoundingClientRect();return{width:boundingClientRect.width||element.prop("offsetWidth"),height:boundingClientRect.height||element.prop("offsetHeight"),top:boundingClientRect.top+($window.pageYOffset||$document[0].documentElement.scrollTop),left:boundingClientRect.left+($window.pageXOffset||$document[0].documentElement.scrollLeft)}},position=function(hostEl,targetEl){var targetElPos,pos0="top",pos1="center",hostElPos=offset(hostEl),targetElWidth=targetEl.prop("offsetWidth"),targetElHeight=targetEl.prop("offsetHeight"),shiftWidth={center:function(){return hostElPos.left+hostElPos.width/2-targetElWidth/2},left:function(){return hostElPos.left},right:function(){return hostElPos.left+hostElPos.width}},shiftHeight={center:function(){return hostElPos.top+hostElPos.height/2-targetElHeight/2},top:function(){return hostElPos.top},bottom:function(){return hostElPos.top+hostElPos.height}};switch(pos0){case"right":targetElPos={top:shiftHeight[pos1](),left:shiftWidth[pos0]()};break;case"left":targetElPos={top:shiftHeight[pos1](),left:hostElPos.left-targetElWidth};break;case"bottom":targetElPos={top:shiftHeight[pos0](),left:shiftWidth[pos1]()};break;default:targetElPos={top:hostElPos.top-hostElPos.height-targetElHeight,left:shiftWidth[pos1]()}}return targetElPos};return{position:position}}]),bandcampApp.directive("checkinMemberTable",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/member/checkin-member-table.tpl.html",scope:{broadcastCheckinSaved:"&",periodMode:"=",checkinManager:"=",teamId:"=",managerId:"=",assignments:"=",selectedAssignment:"=",timeRange:"="},controller:"CheckinMemberTableCtrl"}}]),ctrls.controller("CheckinMemberTableCtrl",["$scope","TimeUtils","MemberOnlineStatusService","MemberProductivityService","MemberBlockStreakService","CheckinControlPanelPeriod","Checkin","CheckinStatus","routePrefix","$filter","$uibModal","$document",function($scope,TimeUtils,MemberOnlineStatusService,MemberProductivityService,MemberBlockStreakService,CheckinControlPanelPeriod,Checkin,CheckinStatus,routePrefix,$filter,$uibModal,$document){var PAST_4_WEEKS=[0,1,2,3];$scope.metricWeeks=_.chain(PAST_4_WEEKS).map(function(pastWeek){return moment().subtract(pastWeek,"weeks").weekday(moment.DAY_OF_WEEK.SUNDAY).format(moment.DateFormat.ISO_8601)}).value(),$scope.openCheckinModal=function(asgn,checkin){if(checkin){var modalInstance=$uibModal.open({templateUrl:routePrefix+"manager/checkin/component/checkin-checkin-modal.tpl.html",controller:"CheckinCheckinModalCtrl",windowClass:"manager-checkin",resolve:{params:function(){return{checkin:checkin,assignment:{name:asgn.selection.marketplaceMember.application.candidate.printableName,photoUrl:asgn.realPhotoUrl||"images/1f34682a.user.png"}}}}}),onSave=function(savedCheckin){$scope.broadcastCheckinSaved(savedCheckin),_.extend(checkin,savedCheckin),$scope.f.getBlockSteaks()};modalInstance.result.then(onSave)}},$scope.teamTableSort="selection.marketplaceMember.application.candidate.printableName",$scope.data={weekMode:"Avg",date:$scope.timeRange.from},$scope.f={getProductivitySummary:function(){MemberProductivityService.getProductivitySummary($scope.assignments,$scope.managerId,!$scope.managerId)},getBlockSteaks:function(){MemberBlockStreakService.getBlockStreak($scope.assignments,$scope.managerId)},getLatestWorkDiaries:function(){MemberOnlineStatusService.getLatestWorkDiaries($scope.teamId,$scope.managerId,$scope.teamId&&!$scope.managerId,$scope.assignments)},getLastOnlineAgo:function(asgn){return MemberOnlineStatusService.getLastOnlineAgo(asgn)},getOnlineStatusClass:function(asgn){return MemberOnlineStatusService.getOnlineStatusClass(asgn)},getLocalTime:function(a){var offset=a.selection.marketplaceMember.application.candidate.location.timeZone.offset;return offset?TimeUtils.getTimeByTimezoneOffset(offset):TimeUtils.getUTCTime()},sortTable:function(propertyName,orderByProductivityColumn){propertyName===$scope.teamTableSort?$scope.teamTableSortReverse=!$scope.teamTableSortReverse:$scope.teamTableSortReverse=!1,$scope.teamTableSort=propertyName,$scope.orderByProductivityColumn=orderByProductivityColumn},showSkypePopup:function(e,asgn){var prodDiv=angular.element(".manager-checkin").offset();$scope.skypePopupCandidate=asgn.selection.marketplaceMember.application.candidate,$scope.skypePopupX=e.pageX-e.offsetX-50,$scope.skypePopupY=e.pageY-prodDiv.top-e.offsetY-90,$scope.showSkypePopup=!0}};var onlineStatusInterval=setInterval(function(){$scope.f.getLatestWorkDiaries()},3e5);$scope.$on("$destroy",function(){clearInterval(onlineStatusInterval)}),$scope.$watch("assignments",function(){$scope.f.getLatestWorkDiaries(),$scope.f.getProductivitySummary(),$scope.f.getBlockSteaks()}),$scope.$watch("timeRange",function(newTimeRange){$scope.isLoading=!0,$scope.checkinManager.findCheckins(newTimeRange.from,newTimeRange.to).then(function(checkins){var assignmentCheckins=_.groupBy(checkins,"assignmentId");_.each($scope.assignments,function(assignment){assignment.checkins={},_.each(assignmentCheckins[assignment.id],function(checkin){assignment.checkins[checkin.date]=checkin})}),$scope.isLoading=!1})}),$document.on("click",function(event){$scope.showSkypePopup&&!angular.element(event.target).hasClass("skypeCall")&&($scope.showSkypePopup=!1,$scope.$digest())})}]),bandcampApp.directive("checkinDailyMemberTable",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/member/checkin-daily-member-table.tpl.html",scope:{metricWeeks:"=",assignments:"=",selectedAssignment:"=",weekMode:"=",date:"=",openCheckinModal:"="},controller:"CheckinDailyMemberTableCtrl"}}]),ctrls.controller("CheckinDailyMemberTableCtrl",["$scope",function($scope){$scope.bloackageStatusOrder={Unknown:1,Blocked:2,Unblocked:3,None:4},$scope.f={getLocalTime:function(a){return $scope.$parent.f.getLocalTime(a)},showSkypePopup:function(e,asgn){$scope.$parent.f.showSkypePopup(e,asgn)},orderCheckins:function(a){var value=null;switch($scope.$parent.teamTableSort){case"printableName":value=a.selection.marketplaceMember.application.candidate.printableName;break;case"offset":value=a.selection.marketplaceMember.application.candidate.location.timeZone.offset;break;case"metricsStats":case"recordedHours":value=a.productivity[$scope.$parent.teamTableSort+$scope.weekMode];break;case"status":value=a.checkins[$scope.date]?a.checkins[$scope.date].status.name:null;break;case"blockageStatus":value=a.checkins[$scope.date]?$scope.bloackageStatusOrder[a.checkins[$scope.date].blockageStatus.name]:null;break;case"comment":value=a.checkins[$scope.date]?a.checkins[$scope.date].comment||"-1":null}return value||a[$scope.$parent.teamTableSort]}}}]),bandcampApp.directive("checkinWeeklyMemberTable",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/member/checkin-weekly-member-table.tpl.html",scope:{metricWeeks:"=",assignments:"=",selectedAssignment:"=",weekMode:"=",timeRange:"=",openCheckinModal:"="},controller:"CheckinWeeklyMemberTableCtrl"}}]),ctrls.controller("CheckinWeeklyMemberTableCtrl",["$scope","CheckinStatus",function($scope,CheckinStatus){$scope.CheckinStatus=CheckinStatus,$scope.$watch("timeRange",function(timeRange){var monday=moment(timeRange.from).weekday(moment.DAY_OF_WEEK.MONDAY).format(moment.DateFormat.ISO_8601),WEEKDAYS=[0,1,2,3,4];$scope.weekdays=_.map(WEEKDAYS,function(day){return moment(monday).add(day,"days").format(moment.DateFormat.ISO_8601)})}),$scope.f={getLocalTime:function(a){return $scope.$parent.f.getLocalTime(a)},showSkypePopup:function(e,asgn){$scope.$parent.f.showSkypePopup(e,asgn)}}}]),bandcampApp.directive("checkinMonthlyMemberTable",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/checkin/member/checkin-monthly-member-table.tpl.html",scope:{metricWeeks:"=",assignments:"=",selectedAssignment:"=",weekMode:"=",timeRange:"=",openCheckinModal:"="},controller:"CheckinMonthlyMemberTableCtrl"}}]),ctrls.controller("CheckinMonthlyMemberTableCtrl",["$scope",function($scope){var monthStart=moment($scope.timeRange.from).startOf("month"),monthEnd=moment($scope.timeRange.to).endOf("month");for($scope.monthDates=[];monthStart.isBefore(monthEnd,"day")||monthStart.isSame(monthEnd,"day");)$scope.monthDates.push(monthStart.format(moment.DateFormat.ISO_8601)),monthStart.add(1,"day");$scope.f={getLocalTime:function(a){return $scope.$parent.f.getLocalTime(a)},showSkypePopup:function(e,asgn){$scope.$parent.f.showSkypePopup(e,asgn)}}}]),services.factory("CheckinManager",["$q","CheckinService","Checkin",function($q,CheckinService,Checkin){var fillNotDoneCheckins=function(incompleteCheckins,from,to,assignmentIds){var getDatesBetween=function(from,to){var allDays=[],today=moment(),start=moment(from),end=moment(to).isBefore(today)?moment(to):today;for(end.add(1,"days");start.isBefore(end,"day");){var isWeekDay=start.weekday()!==moment.DAY_OF_WEEK.SATURDAY&&start.weekday()!==moment.DAY_OF_WEEK.SUNDAY;isWeekDay&&allDays.push(start.format(moment.DateFormat.ISO_8601)),start.add(1,"days")}return allDays},dates=getDatesBetween(from,to),completeCheckins=_.chain(dates).map(function(date){var availableCheckins=_.filter(incompleteCheckins,function(checkin){return checkin.date===date}),assignmentWithCheckins=_.map(availableCheckins,"assignmentId"),assignmentWithNoCheckins=_.difference(assignmentIds,assignmentWithCheckins),missingCheckins=_.map(assignmentWithNoCheckins,function(assignmentId){return Checkin.createNotDone(assignmentId,date)});return availableCheckins.concat(missingCheckins)}).flatten().value();return completeCheckins},checkinManager=function(teamId,managerId,assignmentIds){this.teamId=teamId,this.managerId=managerId,this.assingmentIds=assignmentIds};return checkinManager.prototype.findCheckins=function(from,to,assignmentId){var _this=this,requestDone=$q.defer();return CheckinService.list({from:from,to:to,teamId:this.teamId,
managerId:this.managerId}).$promise.then(function(checkinResp){var incompleteCheckins=_.map(checkinResp,function(checkin){return new Checkin(checkin.id,checkin.assignmentId,checkin.date,checkin.status,checkin.unblocked,checkin.comment,checkin.blockageStatus)}),completeCheckins=fillNotDoneCheckins(incompleteCheckins,from,to,_this.assingmentIds);if(assignmentId){var assignmentCheckins=_.filter(completeCheckins,function(checkin){return assignmentId===checkin.assignmentId});requestDone.resolve(assignmentCheckins)}else requestDone.resolve(completeCheckins)}),requestDone.promise},checkinManager}]),services.factory("Checkin",["$q","$timeout","CheckinStatus","CheckinService",function($q,$timeout,CheckinStatus,CheckinService){var Checkin=function(id,assignmentId,date,status,unblocked,comment){this.id=id,this.assignmentId=assignmentId,this.date=date,this.status=CheckinStatus.valueOf(status),this.unblocked=unblocked,this.comment=comment};return Object.defineProperty(Checkin.prototype,"blockageStatus",{get:function(){return this.status.toBlockageStatus(this.unblocked)}}),Checkin.createNotDone=function(assignmentId,date){return new Checkin(null,assignmentId,date,CheckinStatus.NOT_DONE.key,(!0),null)},Checkin.prototype.isNew=function(){return!this.id},Checkin.prototype.save=function(){var _this=this,requestDone=$q.defer(),checkin={id:_this.id,assignmentId:_this.assignmentId,date:_this.date,status:_this.status.key,unblocked:_this.unblocked,comment:_this.comment};return this.isNew()?CheckinService.create({assignmentId:_this.assignmentId},checkin,function(res){_this.id=res.id,requestDone.resolve(_this)}):CheckinService.update({id:_this.id},checkin,function(){requestDone.resolve(_this)}),requestDone.promise},Checkin}]),services.factory("CheckinStatus",["CheckinBlockageStatus",function(BlockageStatus){var Status=function(order,key,name,color,description){this.key=key,this.name=name,this.order=order,this.color=color,this.description=description},StatusEnum={ON_TRACK:new Status(1,"ON_TRACK","On Track","#66BB6A","Individual is on track to hit metric goal."),WRONG_THING:new Status(2,"WRONG_THING","Wrong Thing","#EF5350","Individual is working, but working on something that doesn't effect the metric. Manager can correct immediately by specifying clearly what to work on instead."),WRONG_PROCESS:new Status(3,"WRONG_PROCESS","Wrong Process","#FF9800","Individual is working with the wrong process. Examples: using software incorrectly, not marking the right fields, not using automated systems, not escalating when blocked. Manager can correct immediately by explaining the correct process to follow."),NEEDS_ACTION:new Status(4,"NEEDS_ACTION","Needs Action","#9575CD","Individual stuck needing action or decision from another team or person. Manager can correct immediately by making an assumption or default decision to get work progressing, and then follow up with appropriate person to verify or countermand the decision."),TOO_HARD:new Status(5,"TOO_HARD","Too Hard","#FDD835","Individual can't think of a way to proceed, or has tried ways to proceed but they haven't yielded results. Manager can correct immediately by brainstorming and applying management expertise and identifying next steps."),WORK_NOT_DEFINED:new Status(6,"WORK_NOT_DEFINED","Work Not Defined","#BA68C8","Individual cannot work 8 hours per day because management has not defined the work to be done. Manager can define enough work immediately so that individual can work."),NOT_WORKING:new Status(7,"NOT_WORKING","Not Working","#CDD3D5","Individual is not currently working."),NOT_DONE:new Status(8,"NOT_DONE","Not Done","#90A4AE","Manager did not complete check-in-chat.")};Status.prototype.toBlockageStatus=function(unblocked){return unblocked?BlockageStatus.UNBLOCKED:BlockageStatus.BLOCKED},Status.prototype.isBlockage=function(){return!0},StatusEnum.ON_TRACK.toBlockageStatus=function(){return BlockageStatus.NONE},StatusEnum.ON_TRACK.isBlockage=function(){return!1},StatusEnum.NOT_DONE.toBlockageStatus=function(){return BlockageStatus.UNKNOWN},StatusEnum.NOT_DONE.isBlockage=function(){return!1};var allStatuses=_.values(StatusEnum);return StatusEnum.values=function(){return[].concat(allStatuses)},StatusEnum.valueOf=function(key){return StatusEnum[key]},StatusEnum}]),services.factory("CheckinBlockageStatus",[function(){var BlockageStatus=function(key,name,cssClass){this.key=key,this.name=name,this.cssClass=cssClass};return{NONE:new BlockageStatus("NONE","None","none"),BLOCKED:new BlockageStatus("BLOCKED","Blocked","blocked"),UNBLOCKED:new BlockageStatus("UNBLOCKED","Unblocked","unblocked"),UNKNOWN:new BlockageStatus("UNKNOWN","Unknown","unknown")}}]),ctrls.controller("CheckinCheckinModalCtrl",["$scope","$uibModalInstance","CheckinStatus","params","CurrentUser","$routeParams",function($scope,$uibModalInstance,CheckinStatus,params,CurrentUser,$routeParams){var cloneCheckin=function(checkin){var clone=angular.copy(checkin);return clone.status=checkin.status,clone};$scope.assignment=params.assignment,$scope.checkin=cloneCheckin(params.checkin),$scope.CheckinStatus=CheckinStatus,$scope.cancel=function(){$uibModalInstance.dismiss()},CurrentUser.get(function(u){var managerId=_.chain(u.userAvatars).filter(function(avatar){return"MANAGER"===avatar.type||"COMPANY_ADMIN"===avatar.type}).first().value().id;$scope.isDirectManager=$routeParams.managerId===managerId}),$scope.submit=function(){$scope.isLoading=!0,$scope.checkin.save().then(function(saved){$uibModalInstance.close(saved)})["catch"](function(error){$scope.err=error})["finally"](function(){$scope.isLoading=!1})},$scope.$watch("checkin.status",function(newStatus){var isUnblockReset=newStatus===CheckinStatus.ON_TRACK||newStatus===CheckinStatus.NOT_DONE;isUnblockReset&&($scope.checkin.unblocked=!0)})}]),services.factory("MemberOnlineStatusService",["AssignmentService",function(AssignmentService){var f={addLatestWorkDiaryToAssignments:function(asgns,diaries){for(var i=diaries.length;i--;){var d=diaries[i];(asgns||[]).forEach(function(a){a.selection.marketplaceMember.application.candidate.id===d.candidateId&&(a.lastWorkDiary=d)})}},getLatestWorkDiaries:function(teamId,managerId,fullTeam,assignments){var req={teamId:teamId,managerId:managerId,fullTeam:fullTeam};AssignmentService.getLatestWorkDiaries(req,function(res){f.addLatestWorkDiaryToAssignments(assignments,res)})},getLastOnlineAgo:function(asgn){var diff=(new Date).getTime()-asgn.lastWorkDiary.date.millis;return diff/=6e4},getOnlineStatusClass:function(asgn){if(asgn.lastWorkDiary){var diff=f.getLastOnlineAgo(asgn),clazz="offline";return diff<=29?clazz="online":diff<69&&(clazz="noActivity"),clazz}}};return f}]),services.factory("MemberProductivityService",["AssignmentService","TeamService",function(AssignmentService,TeamService){var f={addProductivityToAssignments:function(asgns,prodSummary){for(var i=prodSummary.assignments.length;i--;){var asgnP=prodSummary.assignments[i];(asgns||[]).forEach(function(a){a.id===asgnP.id&&(a.productivity={metricName:prodSummary.metricName,metricTarget:prodSummary.metricTarget,metricsStats:_.last(asgnP.metricsStats,4),recordedHours:_.last(asgnP.recordedHours,4),metricsStatsCurrent:asgnP.metricsStats[0],recordedHoursCurrent:asgnP.recordedHours[0],metricsStatsAvg:(asgnP.metricsStats.reduce(function(a,b){return a+b})-asgnP.metricsStats[0])/4,recordedHoursAvg:(asgnP.recordedHours.reduce(function(a,b){return a+b})-asgnP.recordedHours[0])/4})})}},loadProductivitySummary:function(teamId,managerId,fullTeam,assignments){var req={weeksCount:5,id:teamId,managerId:managerId,fullTeam:fullTeam};TeamService.teamProductivitySummary(req,function(res){f.addProductivityToAssignments(assignments,res)})},getProductivitySummary:function(assignments,managerId,fullTeam){if(assignments){var teamSet=[];assignments.forEach(function(a){teamSet.push(a.team.id),a.productivity={}}),teamSet.forEach(function(teamId){f.loadProductivitySummary(teamId,managerId,fullTeam,assignments)})}}};return f}]),services.factory("MemberBlockStreakService",["CheckinService",function(CheckinService){var f={addBlockStreakToAssignments:function(asgns,blockStreakList){for(var i=blockStreakList.length;i--;){var blockStreak=blockStreakList[i];(asgns||[]).forEach(function(a){a.id===blockStreak.assignmentId&&(a.blockStreakCount=blockStreak.streakCount)})}},loadBlockStreak:function(teamId,managerId,assignments){var req={teamId:teamId,managerId:managerId};CheckinService.getBlockStreak(req,function(res){f.addBlockStreakToAssignments(assignments,res)})},getBlockStreak:function(assignments,managerId){if(assignments){var teamSet=[];assignments.forEach(function(a){teamSet.push(a.team.id),a.blockStreakCount=0}),teamSet.forEach(function(teamId){f.loadBlockStreak(teamId,managerId,assignments)})}}};return f}]),ctrls.controller("managerEditTeamsCtrl",["$scope","TeamService","ManagerService","AssignmentService","$cacheFactory","$uibModalInstance","$routeParams","CurrentUser","$q",function($scope,TeamService,ManagerService,AssignmentService,$cacheFactory,$uibModalInstance,$routeParams,CurrentUser,$q){function getCurrentManager(){var deferred=$q.defer();return CurrentUser.getAvatar({avatarType:"MANAGER"}).$promise.then(function(data){deferred.resolve({manager:data})}),deferred.promise}$scope.isError=!1,$scope.ui={isLoading:!0,existTeam:!1},$scope.data={managerIsTeamOwner:!0},$scope.setError=function(msg){$scope.isError=!0,$scope.errorMessage=msg},$scope.init=function(){$scope.managers=[],$scope.assignment=null;var promises=[];promises[0]=getCurrentManager(),promises[1]=AssignmentService.get({id:$routeParams.id}).$promise,promises[2]=ManagerService.get({avatarType:"MANAGER"}).$promise,$q.all(promises).then(function(res){$scope.data.currentManager=res[0].manager,$scope.assignment=res[1],$scope.data.managers=res[2].filter(function(m){return m&&m.userId!==$scope.assignment.selection.marketplaceMember.application.candidate.userId});var hasCurrentManager=$scope.data.managers.filter(function(m){return m.id===$scope.data.currentManager.id}).length>0;hasCurrentManager||$scope.data.managers.push($scope.data.currentManager),$scope.data.managers=$scope.data.managers.sort(function(a,b){return a.id===$scope.data.currentManager.id?($scope.data.teamOwner=a,$scope.data.manager=a,-1e3):b.id===$scope.data.currentManager.id?($scope.data.teamOwner=b,$scope.data.manager=b,1e3):a.printableName<b.printableName?-1:a.printableName>b.printableName?1:0}),$scope.ui.isLoading=!1})["catch"](function(err){$scope.setError(err.data.text),$scope.ui.isLoading=!1})},$scope.init(),$scope.loadTeams=function(){$scope.isError=!1,$scope.ui.isLoading=!0,TeamService.list({teamsMap:!0}).$promise.then(function(res){$scope.data.teams=res,$scope.ui.isLoading=!1})["catch"](function(err){$scope.ui.isLoading=!1,$scope.setError(err.data.text)})},$scope.switchNewTeamType=function(existTeam){var managers=$scope.data.managers,currentManager=$scope.data.currentManager;$scope.data={managers:managers,currentManager:currentManager},$scope.ui.existTeam=existTeam,$scope.ui.isLoading=!1,$scope.isError=!1,existTeam&&!$scope.data.teams&&$scope.loadTeams()},$scope.isValidForm=function(){return $scope.ui.existTeam?$scope.data.manager&&$scope.data.team:(!$scope.data.managerIsTeamOwner&&$scope.data.teamOwner||$scope.data.managerIsTeamOwner)&&$scope.data.manager&&$scope.data.teamName},$scope.save=function(){if($scope.ui.isLoading=!0,$scope.isError=!1,$scope.ui.existTeam){if(!$scope.data.team||!$scope.data.manager)return $scope.ui.isLoading=!1,void $scope.setError("Please fill the required feilds");AssignmentService.changeTeam({id:$scope.assignment.id,teamId:$scope.data.team.id,managerId:$scope.data.manager.id}).$promise.then(function(res){$scope.assignment=res,$cacheFactory.get("$http").removeAll(),$cacheFactory.get("teamCache").removeAll(),$scope.isSuccess=!0,$scope.ui.isLoading=!1,$uibModalInstance.dismiss()})["catch"](function(err){$scope.setError(err.data.text),$scope.ui.isLoading=!1})}else{var team={name:$scope.data.teamName,teamOwner:$scope.data.managerIsTeamOwner?$scope.data.manager:$scope.data.teamOwner};AssignmentService.changeToNewTeam({id:$scope.assignment.id,managerId:$scope.data.manager.id},team).$promise.then(function(res){$scope.assignment=res,$cacheFactory.get("$http").removeAll(),$cacheFactory.get("teamCache").removeAll(),$scope.isSuccess=!0,$scope.ui.isLoading=!1,$uibModalInstance.dismiss()})["catch"](function(err){$scope.setError(err.data.text),$scope.ui.isLoading=!1})}},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("TeamsOwnerMetricsCtrl",["$scope","TeamService","ManagerService","$uibModal","CurrentUser","AssignmentService","IntegrationsService","$q","$routeParams","routePrefix",function($scope,TeamService,ManagerService,$uibModal,CurrentUser,AssignmentService,IntegrationsService,$q,$routeParams,routePrefix){$scope.data={},$scope.loadSettings=function(teamId,reload){if(!$scope.data.metricsSetups||reload||teamId!==$scope.data.team.id){$scope.metricsLoading=!reload,$scope.data.currentMetric=null;var promises=[];promises[0]=TeamService.getTeam({id:teamId}).$promise,promises[1]=AssignmentService.list({fullTeam:!0,teamId:teamId,limit:1e3,status:"ACTIVE"}).$promise,promises[2]=IntegrationsService.metrics().$promise,$q.all(promises).then(function(result){$scope.data.metricsSetups=result[0].metricsSetups||[],$scope.data.currentMetric=_.find($scope.data.metricsSetups,function(setup){return setup.activedMetric}),$scope.data.currentMetric&&$scope.data.currentMetric.type&&result[2].indexOf($scope.data.currentMetric.type)===-1&&($scope.data.currentMetric.metricName+=" (disabled)"),$scope.data.assignments=result[1].content,$scope.data.team=result[0]})["catch"](function(err){$scope.metricsSetupError=err.data.text})["finally"](function(){$scope.metricsLoading=!1})}},$scope.viewMetricsSettings=function(){$scope.metricsLoading=!0;var modalInstance=$uibModal.open({size:"lg",backdrop:"static",templateUrl:routePrefix+"manager/dashboard/metrics/setting/metric-setting.tpl.html",controller:"MetricSettingCtrl",resolve:{params:function(){return{currentUser:CurrentUser.get(),team:$scope.data.team}}}}),save=function(){$scope.metricsLoading=!1,$scope.loadSettings($scope.data.team.id,!0)},cancel=function(){$scope.metricsLoading=!1};return modalInstance.result.then(save,cancel),modalInstance},$scope.getAssignments=function(){return $scope.data.assignments?$scope.data.assignments:void AssignmentService.list({fullTeam:!1,teamId:$scope.data.team.id,limit:1e3,status:"ACTIVE"}).$promise.then(function(res){return $scope.data.assignments=res.content,$scope.data.assignments})},$scope.getUser=function(scope){return CurrentUser.clearCache(function(){return CurrentUser.get().$promise.then(function(u){scope&&(scope.cu=angular.copy(u))})})},$scope.routeParams=$routeParams,$scope.$watch("routeParams.team",function(){var teamId=$routeParams.team;teamId&&$scope.loadSettings(teamId)})}]),ctrls.controller("managerTeamsCtrl",["$scope","$uibModal","$document","CurrentUser","UserService","AssignmentService","TeamService","ManagerService","$window","$filter","$q","$routeParams","$cacheFactory","$location","ManagerCommonService",function($scope,$uibModal,$document,CurrentUser,UserService,AssignmentService,TeamService,ManagerService,$window,$filter,$q,$routeParams,$cacheFactory,$location,ManagerCommonService){function initAllFeaturesToggleSwitchProperties(){$scope.allFeaturesToggle={webcamPictures:{value:!1,isDirty:!1},screenShots:{value:!1,isDirty:!1},applicationTracking:{value:!1,isDirty:!1},enforcerReview:{value:!1,isDirty:!1}}}function checkAllFeaturesTogglePropertyChange(properties){for(var trueFound,falseFound,allProperyStates=[],propL=properties.length;propL--;){for(var nodeL=$scope.d.teamDetails.team.nodes.length;nodeL--;)if(angular.isDefined($scope.d.teamDetails.team.nodes[nodeL].features)){var features=$scope.d.teamDetails.team.nodes[nodeL].features,screenShotSelect=$scope.d.teamDetails.team.nodes[nodeL].data.screenshootFrequency,isScreenshotEnabled="Disabled"!==screenShotSelect.name;features.screenShots=isScreenshotEnabled,allProperyStates.push(features[properties[propL]])}trueFound=allProperyStates.indexOf(!0)!==-1,falseFound=allProperyStates.indexOf(!1)!==-1,trueFound&&falseFound?($scope.allFeaturesToggle[properties[propL]].value=!0,$scope.allFeaturesToggle[properties[propL]].isDirty=!0):(trueFound&&$scope.allFeaturesToggle[properties[propL]].value!==!0?$scope.allFeaturesToggle[properties[propL]].value=!0:falseFound&&$scope.allFeaturesToggle[properties[propL]].value!==!1&&($scope.allFeaturesToggle[properties[propL]].value=!1),$scope.allFeaturesToggle[properties[propL]].isDirty=!1),allProperyStates=[]}}function isFeatureEnabled(assignment,feature){return assignment.disabledFeatures.indexOf(feature)===-1}function getAssignmentFeatures(a){var screenShotsEnabled=isFeatureEnabled(a,"SCREENSHOTS"),featureValues=_.findWhere(a.screenshootFrequencies,{id:a.featureValues.screenshotFrequency});return a.screenshootFrequency=screenShotsEnabled?featureValues:a.screenshootFrequencies[0],{webcamPictures:isFeatureEnabled(a,"WEBCAM_PICTURES"),screenShots:screenShotsEnabled,applicationTracking:isFeatureEnabled(a,"APPLICATION_TRACKING"),enforcerReview:isFeatureEnabled(a,"ENFORCER_REVIEW")}}function isRole(user,type){return user.avatarTypes.indexOf(type)>-1}function getManagerId(assignment){return assignment.userAvatars.filter(function(a){return"MANAGER"===a.type||"COMPANY_ADMIN"===a.type}).pop().id}function getTeams(user,teams){var res=[];for(var property in teams)teams.hasOwnProperty(property)&&res.push({id:teams[property][0].team.id,name:property,role:"team",managerId:getManagerId(user),owner:user.printableName,collapsed:!0,nodes:getNodes(teams[property])});return res=res.sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0})}function getManagersNodes(mgr,data){var node={id:mgr.id,name:mgr.printableName,role:data.jobTitle,type:isRole(mgr,"COMPANY_ADMIN")?"Admin":isRole(mgr,"MANAGER")?"Manager":"Contractor",owner:mgr.printableName,ownerId:getManagerId(mgr),data:data,collapsed:!0,nodes:[0],features:getAssignmentFeatures(data)};return 0===levelsToLoad?node:(AssignmentService.list({fullTeam:!1,managerId:$filter("filter")(mgr.userAvatars,{type:"MANAGER"},!0)[0].id,limit:1e3,status:"ACTIVE"}).$promise.then(function(asgn){var teams=_.groupBy(asgn.content,function(elem){return elem.team.name});Object.keys(teams).length>0?(node.nodes=getTeams(mgr,teams),levelsToLoad--):node.nodes=[]}),node)}function setFrequency(a){var webcamDisabled=a.data.disabledFeatures.indexOf("WEBCAM_PICTURES")>-1;a.data.screenshootFrequency||(a.data.screenshootFrequency={id:0,name:"Disabled"}),a.data.featureValues={screenshotFrequency:a.data.screenshootFrequency.id,webcamshotFrequency:webcamDisabled?0:1}}function getNodes(team,isFlatView){for(var res=[],tl=team.length;tl--;){var user=team[tl].selection.marketplaceMember.application.candidate,hisManager=$scope.currentUser.id===user.userId;if(team[tl]=ManagerCommonService.addFrequencyToAssingment(team[tl]),hisManager&&(user.printableName="You"),!isRole(user,"MANAGER")||isFlatView||hisManager){var node={id:user.id,name:user.printableName,role:team[tl].jobTitle,type:isRole(user,"COMPANY_ADMIN")?"Admin":isRole(user,"MANAGER")?"Manager":"Contractor",nodes:[],data:team[tl],features:getAssignmentFeatures(team[tl])};res.push(node)}else res.push(getManagersNodes(user,team[tl]))}return res=res.sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0})}function setDisabledFeatures(a){a.data.disabledFeatures=[],a.features.webcamPictures||a.data.disabledFeatures.push("WEBCAM_PICTURES"),a.features.screenShots||a.data.disabledFeatures.push("SCREENSHOTS"),a.features.applicationTracking||a.data.disabledFeatures.push("APPLICATION_TRACKING"),a.features.enforcerReview||a.data.disabledFeatures.push("ENFORCER_REVIEW")}function moveContractor(contractor,manager,team){return $uibModal.open({windowClass:"manager-add-team",templateUrl:"contractor-confirmation.tpl.html",controller:"MoveContractorCtrl",backdrop:"static",resolve:{contractor:function(){return contractor},team:function(){return team},manager:function(){return manager}}})}function moveTeam(manager,team){return $uibModal.open({windowClass:"manager-add-team",templateUrl:"team-confirmation.tpl.html",controller:"MoveTeamCtrl",backdrop:"static",resolve:{team:function(){return team},manager:function(){return manager}}})}function moveTeamNodes(arr,managerId){arr.managerId&&(arr.managerId=managerId),arr.ownerId&&(arr.ownerId=managerId),angular.forEach(arr.nodes,function(elem){"team"!==elem.role&&AssignmentService.changeTeam({id:elem.data.id,managerId:managerId,teamId:arr.id}).$promise.then(function(a){elem.data=a})["catch"](function(err){showError(err.data.text)})})}function changeTeamNameInTree(nodes,id,newTeamName){if(nodes&&0!==nodes.length)for(var i=nodes.length;i--;)if("team"!==nodes[i].role)for(var j=nodes[i].nodes.length;j--;)"team"===nodes[i].nodes[j].role&&nodes[i].nodes[j].id===id&&(nodes[i].nodes[j].name=newTeamName),changeTeamNameInTree(nodes[i].nodes[j].nodes,id,newTeamName);else changeTeamNameInTree(nodes[i].nodes,id,newTeamName)}function removeAssignmentFromTree(nodes,userNode,oldTeamId){for(var i=nodes.length;i--;){var removed=!1;if("team"!==nodes[i].role&&nodes[i].nodes)for(var j=nodes[i].nodes.length;j--;)"team"===nodes[i].nodes[j].role&&nodes[i].nodes[j].id===oldTeamId&&(nodes[i].nodes[j].nodes=nodes[i].nodes[j].nodes.filter(function(obj){return obj.data.id===userNode.data.id&&(removed=!0),obj.data.id!==userNode.data.id}),nodes[i].nodes[j].nodes&&0!==nodes[i].nodes[j].nodes.length||(nodes[i].nodes=nodes[i].nodes.filter(function(obj){return"team"!==obj.role||obj.id!==oldTeamId})));!removed&&nodes[i].nodes&&nodes[i].nodes.length>0&&removeAssignmentFromTree(nodes[i].nodes,userNode,oldTeamId)}}function updateManager(nodes,userNode,oldTeamId){removeAssignmentFromTree(nodes,userNode,oldTeamId);for(var teamFound=!1,managerId=userNode.data.manager.userId,i=nodes.length;i--;)if("team"!==nodes[i].role&&nodes[i].id===managerId){for(var j=nodes[i].nodes.length;j--;)"team"===nodes[i].nodes[j].role&&nodes[i].nodes[j].name===userNode.data.team.name&&(teamFound=!0,nodes[i].nodes[j].nodes.push(userNode));if(!teamFound){var user=userNode.data.selection.marketplaceMember.application.candidate;nodes[i].nodes.push({id:userNode.data.team.id,name:userNode.data.team.name,role:"team",managerId:managerId,owner:user.printableName,collapsed:!0,nodes:[userNode]})}}else updateManager(nodes[i].nodes,userNode,oldTeamId)}function isSameBranch(src,dest){var srcArr=src.nodesScope.$modelValue,destArr=dest.nodesScope.$modelValue,i=srcArr.length;if(i!==destArr.length)return!1;for(;i--;){if(srcArr[i].id!==destArr[i].id)return!1;if(srcArr[i].managerId&&destArr[i].id&&srcArr[i].managerId!==destArr[i].managerId)return!1}return!0}function showError(msg){$scope.isError=!0,$scope.errorMessage=msg,setTimeout(function(){$scope.isError=!1},6e3)}function init(){function getAssignments(managerId,data){var deferred=$q.defer();return AssignmentService.list({fullTeam:!1,managerId:managerId,limit:1e3,status:"ACTIVE"}).$promise.then(function(res){var gp=_.groupBy(res.content,function(elem){return elem.team.name});$scope.d.teamTree=$scope.f.getTeamTree(data,gp,!1,!1),isDefined($scope.d.teamTree[0].nodes[0])&&($scope.d.teamDetails.team=$scope.d.teamTree[0].nodes[0]),$scope.d.teamTreeLoading=!1,deferred.resolve(res)}),deferred.promise}function setCompanyAdmin(data){isRole(data,"COMPANY_ADMIN")&&($scope.isCompanyAdmin=!0)}function getUser(){function extractUserId(data){$scope.currentUser=data;var id;return id=isRole(data,"MANAGER")?data.userAvatars.filter(function(a){return"MANAGER"===a.type||"COMPANY_ADMIN"===a.type}).pop().id:data.id}var deferred=$q.defer();return CurrentUser.get().$promise.then(function(data){var id=extractUserId(data);deferred.resolve({user:data,userId:id})}),deferred.promise}function getManager(){var deferred=$q.defer();return ManagerService.get({avatarType:"MANAGER",allSameCompanyManagers:!0},function(res){$scope.d.managers=res;var isCandidateAvatar=function(avatar){return"CANDIDATE"===avatar.type},userCandidate=_.chain($scope.currentUser.userAvatars).filter(isCandidateAvatar).first().value(),hasCurrentManager=_.chain($scope.d.managers).map("userAvatars").flatten().filter(isCandidateAvatar).some(function(managerCandidate){return managerCandidate.id===userCandidate.id}).value();hasCurrentManager||$scope.d.managers.push($scope.currentUser),deferred.resolve(res)}),deferred.promise}function loadOtherTeams(user){var deferred=$q.defer(),otherTeams=[],nodes=[];return TeamService.teamsManagersMap().$promise.then(function(res){for(var i=res.length;i--;){var existingTeam=_.find($scope.d.teamTree[0].nodes,function(elem){return elem.id===res[i].id});if(!existingTeam){var existing=_.find(otherTeams,function(elem){return elem.id===res[i].id});!existing&&res[i].reportingManagers&&(otherTeams.push(res[i]),nodes.push({id:res[i].id,name:res[i].name,role:"team",managerId:getManagerId(user),owner:user.printableName,collapsed:!0,isOtherTeam:!0}))}}$scope.d.otherTeamsTree=nodes.sort(function(a,b){return a.name<b.name?-1:a.name>b.name?1:0}),$scope.d.otherTeamTreeLoading=!1,deferred.resolve("All teams retrieved")}),deferred.promise}function fixIt(){w.scrollTop()>145?(angular.element(".dropzoneWrapper").addClass("fixed"),angular.element(".newTeamDropzone").addClass("col-md-5")):(angular.element(".dropzoneWrapper").removeClass("fixed"),angular.element(".newTeamDropzone").removeClass("col-md-5"))}getUser().then(function(userData){return setCompanyAdmin($scope.currentUser),getManager(),getAssignments(userData.userId,$scope.currentUser)}).then(function(){return loadOtherTeams($scope.currentUser)});var w=angular.element($window);w.bind("scroll",fixIt)}var levelsToLoad=0,isDefined=angular.isDefined;$scope.d={teamTreeOptions:{beforeDrop:function(event){var modalInstance,node=event.source.nodeScope.$modelValue,isTeam="team"===node.role;if(isDefined(event.dest.nodesScope.$element[0].attributes.dropzone))return $scope.f.newTeam(node),!1;if(!event.dest.nodesScope.$parent||!event.dest.nodesScope.$parent.$modelValue||isTeam&&event.source.nodesScope.$parent.$modelValue.id===event.dest.nodesScope.$parent.$modelValue.id||event.dest.nodesScope.$parent.$modelValue.isOtherTeam)return!1;if(isSameBranch(event.source,event.dest))return!1;var destTeam=event.dest.nodesScope.$parent.$modelValue;if(isTeam){var sourceManagerId=node.ownerId||node.managerId,destManagerId=destTeam.managerId||destTeam.ownerId||destTeam.id;if(sourceManagerId===destManagerId||"team"===destTeam.role||"Contractor"===destTeam.type)return!1;modalInstance=moveTeam(destTeam.owner,node.name),modalInstance.result.then(function(res){return"cancel"===res?(event.dest.nodesScope.$modelValue.splice(event.dest.index,1),event.source.nodesScope.$modelValue.splice(event.source.index,0,node),!1):void moveTeamNodes(node,destManagerId)})}else{if(!destTeam||"team"!==destTeam.role)return!1;var contractor=event.source.nodeScope.$modelValue;modalInstance=moveContractor(contractor.name,destTeam.owner,destTeam.name),modalInstance.result.then(function(res){return"cancel"===res?(event.dest.nodesScope.$modelValue.splice(event.dest.index,1),event.source.nodesScope.$modelValue.splice(event.source.index,0,node),!1):void AssignmentService.changeTeam({id:contractor.data.selection.id,managerId:destTeam.ownerId||destTeam.managerId,teamId:destTeam.id}).$promise.then(function(a){contractor.data=a})["catch"](function(err){showError(err.data.text)})})}},dropped:function(event){isDefined(event.dest.nodesScope.$parent.$modelValue.name)&&(event.dest.nodesScope.$modelValue[event.dest.index].owner=event.dest.nodesScope.$parent.$modelValue.name)}},teamTreeNewObj:[],teamTreeLoading:!0,otherTeamTreeLoading:!0,teamDetails:{view:"Members",team:null,editContractor:{id:-1,action:null}},rolesOptions:["Contractor","Manager","Admin"],loadedTeamMap:{}},$scope.f={getTeamTree:function(user,teams,loadManager){var topLevelNode=[];return loadManager?void AssignmentService.list({fullTeam:!1,managerId:$filter("filter")(user.data.selection.marketplaceMember.application.candidate.userAvatars,{type:"MANAGER"},!0)[0].id,limit:1e3,status:"ACTIVE"}).$promise.then(function(asgn){var teams=_.groupBy(asgn.content,function(elem){return angular.isUndefined(elem.team)&&(elem.team={name:"Undistributed"}),elem.team.name});Object.keys(teams).length>0?user.nodes=getTeams(user.data.selection.marketplaceMember.application.candidate,teams):user.nodes=[]}):((isRole(user,"COMPANY_ADMIN")?"ADMIN":"MANAGER")&&topLevelNode.push({id:user.id,managerId:getManagerId(user),name:user.printableName,role:isRole(user,"COMPANY_ADMIN")?"ADMIN":"MANAGER",type:isRole(user,"COMPANY_ADMIN")?"Admin":isRole(user,"MANAGER")?"Manager":"Contractor",owner:user.printableName,nodes:getTeams(user,teams)}),topLevelNode)},loadTeamMembersNodes:function(teamNode){teamNode.loadingAssingments=!0;var param={teamId:teamNode.id,fullTeam:!0,limit:1e3,status:"ACTIVE"};AssignmentService.list(param).$promise.then(function(res){var teamAssignments=res.content;angular.forEach(teamAssignments,function(asgn){asgn.isOtherTeamAsgn=!0}),teamNode.nodes=getNodes(teamAssignments,!0),teamNode.loadingAssingments=!1})},newTeam:function(node){if(node.data){var oldTeamId=node.data.team.id;$routeParams.id=node.data.id,$scope.newTeamModal=$uibModal.open({windowClass:"manager-add-team",templateUrl:"manager-add-new-team.tpl.html",controller:"managerEditTeamsCtrl"}),$scope.newTeamModal.result["finally"](function(){AssignmentService.get({id:node.data.id}).$promise.then(function(asgn){var changed=!1;node.data.manager.id===asgn.manager.id&&node.data.team.id===asgn.team.id||(changed=!0),node.data=asgn,changed&&updateManager($scope.d.teamTree,node,oldTeamId)})["catch"](function(err){403===err.status&&removeAssignmentFromTree($scope.d.teamTree,node,oldTeamId)})})}},updateContractorsJobTitle:function(contractor){if(contractor.role&&!(contractor.role.length<2)){var assign=contractor.data;assign.jobTitle=contractor.role,AssignmentService.edit({id:assign.id},assign).$promise.then(function(res){contractor.role=res.jobTitle,$scope.d.teamDetails.editContractor.id=null})["catch"](function(err){showError(err.data.text)})}},updateTeamName:function(newTeamName){if(newTeamName&&null!==newTeamName&&newTeamName!==$scope.d.teamDetails.team.teamData.name){var team=angular.copy($scope.d.teamDetails.team.teamData);team.name=newTeamName,TeamService.update({id:team.id},team).$promise.then(function(){$scope.d.teamDetails.team.name=newTeamName,$scope.d.teamDetails.team.teamData.name=newTeamName,$cacheFactory.get("$http").removeAll(),changeTeamNameInTree($scope.d.teamTree,team.id,newTeamName),changeTeamNameInTree($scope.d.otherTeamsTree,team.id,newTeamName)})["catch"](function(error){showError(error.data.text)})}},updateAllAssignmentsFeatures:function(assignments){for(var promises=[],i=assignments.length;i--;)setDisabledFeatures(assignments[i]),setFrequency(assignments[i]),promises.push(AssignmentService.edit({id:assignments[i].data.id},assignments[i].data).$promise);$q.all(promises)["catch"](function(error){showError(error.data.text)})["finally"](function(){})},updateSingleAssignmentFeatures:function(assignment,property){checkAllFeaturesTogglePropertyChange([property]),this.updateAllAssignmentsFeatures([assignment])},toggleSwitchAll:function(property){var i=$scope.d.teamDetails.team.nodes.length;for($scope.allFeaturesToggle[property].isDirty=!1;i--;)$scope.d.teamDetails.team.nodes[i].features[property]=$scope.allFeaturesToggle[property].value,"screenShots"===property&&($scope.d.teamDetails.team.nodes[i].data.screenshootFrequency=$scope.allFeaturesToggle[property].value===!0?$scope.d.teamDetails.team.nodes[i].data.screenshootFrequencies[4]:$scope.d.teamDetails.team.nodes[i].data.screenshootFrequencies[0]);this.updateAllAssignmentsFeatures($scope.d.teamDetails.team.nodes)},notAWatcher:function(manager){var team=$scope.d.teamDetails.team.teamData,allWatchers=[];if(allWatchers=allWatchers.concat($scope.d.teamDetails.team.logicalManagers),
allWatchers=allWatchers.concat(team.watchers),allWatchers&&manager){var watcher=allWatchers.filter(function(w){return w&&w.id===manager.id}).pop();if(watcher)return!1}return!0},addWatcher:function(team,newWatcher){team.watchers||(team.watchers=[]),newWatcher&&newWatcher.id&&(team.watchers.push(newWatcher),$scope.f.updateTeam(team))},removeWatcher:function(team,watcherId){team.watchers=team.watchers.filter(function(w){return w.id!==watcherId})},updateTeam:function(team){TeamService.update({id:team.id},team).$promise.then(function(result){angular.copy(result,team)})["catch"](function(response){$scope.errorMessage=response.data.text})},editManager:function(assignment){for(var i=$scope.d.managers.length;i--;)assignment.manager.id===$scope.d.managers[i].id&&(assignment.manager=$scope.d.managers[i])},removeAvatar:function(avatarTypes,avatar){var index=avatarTypes.indexOf(avatar);index>-1&&avatarTypes.splice(index,1)},roleSelected:function(userNode,role){if(userNode.type===role||$scope.currentUser.avatarTypes.indexOf("COMPANY_ADMIN")<0)return $scope.d.teamDetails.editContractor.id=null,void($scope.d.teamDetails.editContractor.action=null);var candidate=userNode.data.selection.marketplaceMember.application.candidate,avatarTypes=candidate.avatarTypes;$scope.f.removeAvatar(avatarTypes,"MANAGER"),$scope.f.removeAvatar(avatarTypes,"COMPANY_ADMIN"),"Manager"===role?avatarTypes.push("MANAGER"):"Admin"===role&&(avatarTypes.push("MANAGER"),avatarTypes.push("COMPANY_ADMIN")),UserService.userRoles.updateUserRoles({id:candidate.userId,avatars:avatarTypes}).$promise.then(function(){$scope.d.teamDetails.editContractor.id=null,$scope.d.teamDetails.editContractor.action=null,userNode.type=role})["catch"](function(err){showError(err.data.text)})},managerSelected:function(userNode){var assignment=userNode.data,modalInstance=moveContractor(assignment.selection.marketplaceMember.application.candidate.printableName,assignment.manager.printableName,assignment.team.name);modalInstance.result.then(function(res){if("cancel"===res)AssignmentService.get({id:assignment.id}).$promise.then(function(a){for(var i=$scope.d.managers.length;i--;)if($scope.d.managers[i].id===a.manager.id){userNode.data.manager=$scope.d.managers[i];break}$scope.d.teamDetails.editContractor=null})["catch"](function(err){showError(err.data.text)});else{var oldTeamId=assignment.team.id;AssignmentService.changeTeam({id:assignment.id,teamId:assignment.team.id,managerId:assignment.manager.id}).$promise.then(function(res){assignment=res,$scope.d.teamDetails.editContractor=null,updateManager($scope.d.teamTree,userNode,oldTeamId)})["catch"](function(err){showError(err.data.text)})}})},editOwner:function(){if($scope.d.editingOwner=!0,$scope.d.teamDetails.team.teamData.teamOwner)for(var i=$scope.d.managers.length;i--;)$scope.d.teamDetails.team.teamData.teamOwner.id===$scope.d.managers[i].id&&($scope.d.newOwner=$scope.d.managers[i])},teamOwnerSelected:function(owner){var teamId=$scope.d.teamDetails.team.id;TeamService.get({id:teamId}).$promise.then(function(team){team.teamOwner&&owner.id===team.teamOwner.id||(team.teamOwner=owner,$scope.d.teamDetails.team.teamData.teamOwner=owner,TeamService.update({id:team.id},team).$promise["catch"](function(){showError("There was an error while changing the team owner. Please refresh the page and try again")}))})["catch"](function(){showError("There was an error while changing the team owner. Please refresh the page and try again")})["finally"](function(){$scope.d.editingOwner=!1})},addCompeleteTeamData:function(data){$scope.d.teamDetails.team.teamData=data;var mgr=$scope.currentUser.userAvatars.filter(function(a){return"MANAGER"===a.type||"COMPANY_ADMIN"===a.type}).pop();$scope.currentUser.avatarTypes.indexOf("COMPANY_ADMIN")>-1||data.teamOwner&&data.teamOwner.id===mgr.id?($scope.d.isTeamOwner=!0,ManagerService.listTeamLogicalManagers({teamId:data.id},function(logicalManagers){$scope.d.teamDetails.team.logicalManagers=logicalManagers})):($scope.d.teamDetails.view="Members",$scope.d.isTeamOwner=!1),$scope.d.teamDetails.team.isTeamOwner=$scope.d.isTeamOwner},onKeydown:function(item,$event){var e=$event;27===e.keyCode&&"new-watcher"===item&&($scope.d.newWatcher=null)},openSettings:function(){return $uibModal.open({windowClass:"teamSetup",templateUrl:"settings.tpl.html",controller:"managerTeamsSettingsCtrl",resolve:{data:function(){return $scope}}})}},$scope.openContractorOrProd=function(hide,asgId,teamId){return $scope.$on("$routeChangeStart",function(){$scope.teamMemberShow&&(delete $scope.teamMemberShow,delete $routeParams.id,angular.element("body").removeClass("overflowAllh"))}),hide?(delete $scope.teamMemberShow,delete $scope.teamProductivityShow,delete $routeParams.id,delete $routeParams.team,delete $routeParams.managerId,$scope.secondModal=!1,void angular.element("body").removeClass("overflowAllh")):($document.bind("keyup",function(e){27!==e.keyCode||$scope.secondModal||angular.element("body").hasClass("modal-open")||$scope.openContractorOrProd(!0)}),asgId&&($scope.teamMemberShow=asgId,$routeParams.id=asgId),teamId&&($scope.teamProductivityShow=teamId,$routeParams.team=teamId,$routeParams.managerId=$scope.d.teamDetails.team.managerId),void angular.element("body").addClass("overflowAllh"))},$scope.$watch("d.teamDetails.team.nodes",function(newValue,oldValue){isDefined(newValue)&&newValue!==oldValue&&(initAllFeaturesToggleSwitchProperties(),checkAllFeaturesTogglePropertyChange(["webcamPictures","screenShots","applicationTracking","enforcerReview"]))}),$document.bind("click",function(event){var editField=angular.element(event.target).hasClass("editField")||angular.element(event.target).hasClass("ciEdit")||angular.element(event.target).hasClass("form-control");editField||($scope.d.teamDetails.editContractor.id=null,$scope.d.editingOwner=!1)}),$scope.$watch("d.teamDetails.team",function(){$scope.d.teamDetails.team&&!$scope.d.teamDetails.team.teamData?$scope.d.loadedTeamMap[$scope.d.teamDetails.team.id]?$scope.f.addCompeleteTeamData($scope.d.loadedTeamMap[$scope.d.teamDetails.team.id]):TeamService.get({id:$scope.d.teamDetails.team.id},function(data){$scope.d.loadedTeamMap[data.id]=data,$scope.f.addCompeleteTeamData(data)}):$scope.d.teamDetails.team&&($scope.d.isTeamOwner=$scope.d.teamDetails.team.isTeamOwner,$scope.d.isTeamOwner||($scope.d.teamDetails.view="Members")),$scope.d.teamDetails.team&&$location.search("team",$scope.d.teamDetails.team.id),$scope.d.editingOwner=!1}),init(),$scope.$on("secondModal",function(e,hide){$scope.secondModal=hide})}]),ctrls.controller("MoveContractorCtrl",["$scope","$uibModalInstance","contractor","team","manager",function($scope,$uibModalInstance,contractor,team,manager){$scope.contractor=contractor,$scope.team=team,$scope.manager=manager,$scope.move=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.close("cancel")}}]),ctrls.controller("MoveTeamCtrl",["$scope","$uibModalInstance","team","manager",function($scope,$uibModalInstance,team,manager){$scope.team=team,$scope.manager=manager,$scope.move=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.close("cancel")}}]),ctrls.controller("managerTeamsSettingsCtrl",["$scope","$uibModalInstance","data",function($scope,$uibModalInstance,data){$scope.d=data.d,$scope.f=data.f,$scope.allFeaturesToggle=data.allFeaturesToggle,$scope.cancel=function(){$uibModalInstance.close("cancel")}}]),ctrls.teamDashboardGlobal={build:function(make,skipLinking,ctrl){if(make)for(var cat in make)if(this[cat]||(this[cat]=new Object),"object"==typeof make[cat])for(var item in make[cat])this[cat][item]=make[cat][item];else this[cat]=make[cat];if(make["do"]&&!skipLinking&&(this["do"].srv=this.srv,this["do"].data=this.data,this["do"].ui=this.ui),make.data)for(var d in make.data)"string"==typeof make.data[d]?this.data[d]=this["do"][make.data[d]]():this.data[d]=make.data[d];if(ctrl)for(var t in this)ctrl[t]=this[t]}},ctrls.controller("TeamDashboardCtrl",["CurrentUser","TeamService","ReviewService","AssignmentService","SelectionService","ProductivityService","$document","TimeUtils","$uibModal","localStorageService","$routeParams","routePrefix","$scope","$cacheFactory","$q","$location","CheckinService","BusinessGoalService","ManagerGoalsService","MessagesService",function(CurrentUser,TeamService,ReviewService,AssignmentService,SelectionService,ProductivityService,$document,TimeUtils,$uibModal,localStorageService,$routeParams,routePrefix,$scope,$cacheFactory,$q,$location,CheckinService,BusinessGoalService,ManagerGoalsService,MessagesService){$cacheFactory.get("teamCache").removeAll();var fn={localOffset:function(){var offset=6e4*moment().utcOffset();return offset>0?-offset:offset},popupDefault:function(){return{data:null,kind:null,x:0,y:0,show:!1}},widgetsControlDefaults:function(){return{goals:!1,communication:!1,checkins:!1,rankAndReview:!1,timezone:!1}},uiDefaults:function(features){return{viewTeam:"my",viewManagers:!1,loading:{user:!0,teams:!0,asg:!0,rip:!1},popup:this.popupDefault(),teamDropdown:{my:!1,other:!1},selection:{team:null,cat:"my",manager:null,fullTeam:!1},features:features?features:{goals:{},communication:!1,rankAndReview:{},timezone:{},checkins:!1,control:this.widgetsControlDefaults()},modal:null}},directDefaults:function(){return{my:[{asg:[],isSelected:!1,demands:[]}],other:[{asg:[],isSelected:!1}]}},getFormattedDate:function(millis,offset,format){return moment(millis+offset).utc().format(format)},setPopup:function(e,data,kind){switch(data||kind?this.ui.popup={data:data,kind:kind,show:!0}:this.ui.popup=this.popupDefault(),kind){case"cDetails":this.ui.popup.x=e.pageX-e.offsetX+100,this.ui.popup.y=e.pageY-e.offsetY-150;break;case"skype":this.ui.popup.x=e.pageX-e.offsetX,this.ui.popup.y=e.pageY-e.offsetY-38;break;case"screenshot":var mask=angular.element(e.target).offset();this.ui.popup.x=mask.left+130,this.ui.popup.y=mask.top-140;break;case"activity":case"plannedProductivity":case"t4wAvgProductivity":this.ui.popup.x=e.pageX-e.offsetX-77,this.ui.popup.y=e.pageY-e.offsetY-200}},openTeamSettings:function(){return this.srv.modal.open({windowClass:"teamSetup",templateUrl:this.srv.pref+"manager/teams/_settings.tpl.html",controller:"TeamSettingsModalCtrl as vm",resolve:{team:function(){return vm.ui.selection.team}}})},openTools:function(){return this.srv.modal.open({windowClass:"team-tools-modal",templateUrl:this.srv.pref+"manager/team-dashboard/_modalTeamTools.tpl.html",controller:"TeamToolsModalCtrl as vm"})},openRR:function(){return this.srv.modal.open({windowClass:"rank-and-review-modal",templateUrl:this.srv.pref+"manager/team-dashboard/_modalRankAndReview.tpl.html",controller:"RankAndReviewModalCtrl as vm"})},openScreenshot:function(usr){return this.srv.modal.open({windowClass:"screenshot-modal",templateUrl:this.srv.pref+"manager/team-dashboard/_modalScreenshot.tpl.html",controller:"ScreenshotModalCtrl as vm",resolve:{usr:function(){return usr}}})},openGlobalModal:function(params){params?angular.element("body").addClass("overflowAllh"):angular.element("body").removeClass("overflowAllh"),vm["do"].setPopup(),params||"Metrics"!==this.srv.route.module||($cacheFactory.get("teamCache").removeAll(),this.getStats()),params||"checkins"!==this.srv.route.module&&"goals"!==this.srv.route.module||(this.data.widgets.checkins=this.loadWidgets());var gl=this;this.ui.modal=params,this.srv.route.module=params?params.module:null,this.srv.route.id=params?params.id:null,this.srv.route.team=this.ui.selection.team?this.ui.selection.team.id:null,this.srv.route.managerId=this.ui.selection.manager?this.ui.selection.manager.id:null,this.srv.route.fullTeam=this.ui.selection.fullTeam,this.srv.route.otherTeam="other"===this.ui.selection.cat,this.srv.scope.$on("$routeChangeStart",function(){angular.element("body").removeClass("overflowAllh")}),this.srv.scope.teamProductivityShow=!!params,this.srv.scope.$on("secondModal",function(e,hide){gl.ui.modal.secondModal=hide})},getCurrentTime:function(){if(angular.isDefined(this.ui.popup.data)){var offset=this.ui.popup.data.location.timeZone.offset;return offset?this.srv.time.getTimeByTimezoneOffset(offset):this.srv.time.getUTCTime()}},isMyTeam:function(team,isOneManager){var gl=this;if(team)return team.reportingManagers?isOneManager?1===team.reportingManagers.length?team.reportingManagers[0]:null:team.reportingManagers.filter(function(m){return m.userId===gl.data.currentUser.id}).pop():team.teamOwner?team.teamOwner.userId===this.data.currentUser.id&&team.teamOwner:void 0},canChangeTeamSettings:function(team){if(!team)return!1;var gl=this,user=gl.data.currentUser;return!!(user.avatarTypes.indexOf("COMPANY_ADMIN")>-1||team.teamOwner&&team.teamOwner.userId===user.id)||void 0},getUserRole:function(user){function isRole(type){return user.avatarTypes.indexOf(type)>-1}return isRole("COMPANY_ADMIN")?"Admin":isRole("MANAGER")?"Manager":"Contractor"},getCurrentUser:function(){var gl=this;return this.srv.user.get().$promise.then(function(u){gl.data.currentUser=u,gl.user=u,gl.data.currentUser.role=gl.getUserRole(u),gl.ui.loading.user=!1;var hireModeFeature=_.find(u.userFeatures,function(f){return"TEAM_HIRING"===f.userFeature});gl.data.currentUser.hireModeFeature=!!hireModeFeature})},loadDirectReportingAssignments:function(){var gl=this;gl.data.direct=gl.directDefaults(),gl.getAssignments(null,gl.data.direct.my[0],!0)},getTeams:function(){var gl=this;return this.srv.teams.teamsManagersMap().$promise.then(function(t){if(gl.data.teams={my:[],other:[]},0===t.length)return gl.ui.loading.teams=!1,gl.ui.loading.asg=!1,void(gl.ui.viewTeam="noTeams");for(var i=t.length,otherTeamIds=[];i--;)t[i].isSelected=!1,gl.isMyTeam(t[i])?(t[i].reportingManagers?(gl.getAssignments(0,t[i],!0,gl.data.direct.my[0]),gl.getStats(t[i],gl.isMyTeam(t[i]).id)):(t[i].asg=[],t[i].chartConfig=!1,t[i].activity=!1),gl.data.teams.my.push(t[i])):(t[i].asg=[],gl.data.teams.other.push(t[i]),parseInt(gl.srv.loc.search().teamId,10)!==t[i].id&&otherTeamIds.push(t[i].id));if(gl.data.teams.my.length<1&&gl.data.teams.other.length>0)for(i=gl.data.teams.other.length,gl.ui.selection.fullTeam=!0;i--;)gl.getStats(gl.data.teams.other[i]);gl.data.teams.my=gl.data.teams.my.sort(function(t1,t2){return t1.id-t2.id}),gl.data.teams.other=gl.data.teams.other.sort(function(t1,t2){return t1.id-t2.id}),gl.getSimpleAssignments(otherTeamIds),gl.isManagerAndTeamSelected(),gl.ui.loading.teams=!1;var id=gl.srv.loc.search().teamId,hiring=gl.srv.loc.search().hiring;if(angular.isDefined(id)){var team=_.find(t,function(tm){return tm.id===parseInt(id)});gl.isMyTeam(team)?gl.switchTeam(team,!0,!0):(gl.switchView(!1,!1,!1),gl.switchTeam(team,!0)),gl.hiringMode(hiring)}else gl.hiringMode(!1),gl.getReviewStats()})},getOnline:function(tc,isToday){if(tc){if(isToday)return moment(tc.date).isSame(moment().toDate(),"day");var diff=moment().valueOf()-tc.date;return diff/=6e4,diff<=29||!(diff<69)&&void 0}},setError:function(msg){vm.ui.msg=msg,setTimeout(function(){vm.ui.msg=""},2e3)}},vm=this,srv={user:CurrentUser,teams:TeamService,asg:AssignmentService,sel:SelectionService,prod:ProductivityService,review:ReviewService,time:TimeUtils,modal:$uibModal,store:localStorageService,doc:$document,route:$routeParams,pref:routePrefix,scope:$scope,q:$q,loc:$location,checkin:CheckinService,goals:BusinessGoalService,mgrGoals:ManagerGoalsService,msg:MessagesService},ui=fn.uiDefaults(localStorageService.get("features")),data={currentUser:"getCurrentUser"},make={"do":fn,srv:srv,ui:ui,data:data};ctrls.teamDashboardGlobal.build(make,!1,vm),vm["do"].loadDirectReportingAssignments(),vm.data.teams=vm["do"].getTeams(),setInterval(function(){$cacheFactory.get("teamCache").removeAll()},18e5),$document.bind("click",function(event){vm.ui.popup.show&&!angular.element(event.target).hasClass("skypeCall")&&(vm.ui.popup.data=null),vm.ui.features.control=vm["do"].widgetsControlDefaults(),$scope.$apply()})}]),ctrls.controller("TeamDashboardDropdownCtrl",[function(){var fn={switchView:function(isMy,viewManagers,close){if(close)return vm.ui.viewManagers=!1,vm.ui.teamDropdown={my:!1,other:!1},void angular.element("body").removeClass("overflowAllh");if(angular.element("body").addClass("overflowAllh"),viewManagers||this.ui.teamDropdown.my||this.ui.teamDropdown.other){if(viewManagers===this.ui.viewManagers)return this.ui.viewManagers=!1,this.ui.teamDropdown={my:!1,other:!1},void angular.element("body").removeClass("overflowAllh");this.ui.viewManagers=viewManagers,this.ui.viewTeam=this.ui.selection.cat,this.ui.teamDropdown.my=isMy,this.ui.teamDropdown.other=!isMy}else this.ui.viewManagers=viewManagers,isMy?(this.ui.teamDropdown.my=!this.ui.teamDropdown.my,this.ui.teamDropdown.other=!1,this.ui.viewTeam="my"):(this.ui.teamDropdown.other=!this.ui.teamDropdown.other,this.ui.teamDropdown.my=!1,this.ui.viewTeam="other")},switchTeam:function(team,closeMenu,skipDataLoad){if(this.ui.selection.team&&(this.ui.selection.team.isSelected=!1),team){if(team.isSelected=!0,this.ui.selection={team:team,cat:this.ui.viewTeam,manager:this.isMyTeam(team)?this.isMyTeam(team):this.isMyTeam(team,!0)},this.ui.selection.manager&&(this.ui.selection.manager.type=this.getUserRole(this.ui.selection.manager)),this.ui.selection.fullTeam=!this.ui.selection.manager,this.srv.loc.search("teamId",team.id),skipDataLoad)return;team.reportingManagers&&(this.getAssignments(0,team,!0),this.getStats(team,this.ui.selection.manager?this.ui.selection.manager.id:null))}else{this.ui.selection={team:null,cat:this.ui.viewTeam,manager:"my"===this.ui.viewTeam?this.isMyTeam(this.data.teams.my[0]):null,fullTeam:"other"===this.ui.viewTeam};var i=this.data.teams[this.ui.viewTeam].length,gl=this;if(0===i)return void(vm.ui.loading.asg=!1);for(this.data.direct=this.directDefaults(),"my"===this.ui.viewTeam&&this.getAssignments(0,this.data.direct.my[0],!0);i--;)"other"===this.ui.viewTeam&&this.data.teams[this.ui.viewTeam][i].asg.map(function(a){gl.data.direct.other[0].asg.push(a)}),this.getStats(this.data.teams[this.ui.viewTeam][i],this.isMyTeam(this.data.teams[this.ui.viewTeam][i])?this.isMyTeam(this.data.teams[this.ui.viewTeam][i]).id:null);this.srv.loc.search("teamId",null),this.hiringMode(!1)}closeMenu&&this.switchView(!1,!1,!0),this.getReviewStats()},hiringMode:function(open,reloadDemands){open?this.srv.loc.search("hiring",!0):(this.srv.loc.search("hiring",null),reloadDemands&&this.reloadTeamDemands(this.ui.selection.team)),this.ui.hiringMode=open},switchManager:function(manager,team,closeMenu){if(manager){if(manager.id===(this.ui.selection.manager?this.ui.selection.manager.id:null))return;this.ui.loading.asg=!0,this.ui.selection.manager=manager,this.ui.selection.manager.type=this.getUserRole(manager),this.ui.selection.fullTeam=!1,this.getAssignments(0,team,!0),this.getStats(team,manager.id)}else{var i=this.data.teams[this.ui.viewTeam].length;for(this.ui.loading.asg=!0,this.ui.selection.manager=null,this.ui.selection.fullTeam=!0,this.data.direct=this.directDefaults();i--;)this.getAssignments(0,this.data.teams[this.ui.viewTeam][i],0===i);this.getStats()}closeMenu&&this.switchView(!1,!1,!0),this.hiringMode(!1),this.loadWidgets(this.ui.selection)}},vm=this,make={"do":fn};ctrls.teamDashboardGlobal.build(make,!0,vm)}]),ctrls.controller("TeamDashboardLeftCtrl",[function(){var leftSide={getWorkerImg:function(idx){return idx>5?this.getWorkerImg(idx-5):idx},getLatestWorkDiaries:function(team,asg,final,refresh){var gl=this,params={teamId:team?team.id:this.ui.selection.team,managerId:this.ui.selection.manager?this.ui.selection.manager.id:this.isMyTeam(team)?this.isMyTeam(team).id:0,fullTeam:this.ui.selection.team?null===this.ui.selection.manager:!this.isMyTeam(team)},i=asg.length;clearInterval(refresh),this.srv.asg.getLatestWorkDiaries(params).$promise.then(function(o){for(;i--;)"ACTIVE"===asg[i].status&&(asg[i].user.details.lastWorkDiary=o.filter(function(c){return c.candidateId===asg[i].user.id}).pop(),asg[i].user.details.lastWorkDiary&&(asg[i].user.details.lastWorkDiary.time=moment(asg[i].user.details.lastWorkDiary.date+asg[i].user.location.timeZone.offset).utc().format("hh:mm a")));refresh=setInterval(function(){gl.getLatestWorkDiaries(team,asg,final,refresh)},3e5),final&&(gl.ui.loading.asg=!final)})},addAssignmentsToTeam:function(assignments,team){for(var i=assignments.length,gl=this;i--;)assignments[i].user=assignments[i].selection.marketplaceMember.application.candidate,assignments[i].user.details={jobTitle:assignments[i].jobTitle,manager:assignments[i].manager,salary:assignments[i].salary,salaryUnit:assignments[i].salaryUnit,weeklyLimit:assignments[i].weeklyLimit},team.asg.push(assignments[i]),team.id&&!gl.isMyTeam(team)&&gl.data.direct.other[0].asg.push(assignments[i]);gl.loadWidgets&&gl.loadWidgets(gl.ui.selection)},fetchAssignmentsFromApi:function(params,team,final){var gl=this;this.srv.asg.teamAssignments(params).$promise.then(function(a){gl.addAssignmentsToTeam(a.content,team),gl.getLatestWorkDiaries(team,team.asg,final),(params.page+1)*params.limit<=a.totalElements?(params.page=params.page+1,gl.fetchAssignmentsFromApi(params,team,final)):(team.isAssignmentsLoaded=!0,gl.ui.loading.asg=!1)})},getAssignments:function(page,team,final,sourceTeam){if(sourceTeam&&sourceTeam.isAssignmentsLoaded)return team.id||sourceTeam.id?team.asg=sourceTeam.asg.filter(function(a){return team.id&&a.team.id===team.id}):team.asg=sourceTeam,team;var gl=this;page||(team.asg=[]);var params={page:page||0,status:"ACTIVE,MANAGER_SETUP",teamId:team.id,managerId:this.ui.selection.manager?this.ui.selection.manager.id:this.isMyTeam(team)?this.isMyTeam(team).id:null,fullTeam:team.id&&(this.ui.selection.team?null===this.ui.selection.manager:!this.isMyTeam(team)),limit:20};return gl.ui.loading.asg=!0,gl.fetchAssignmentsFromApi(params,team,final),this.getRolesInProgress(team),team},getRolesInProgress:function(team){var gl=this,i=team.demands.length,params={teamId:team.id,status:"OFFERED,IN_PROGRESS"};return i>0?this.srv.sel.get(params).$promise.then(function(res){for(var j,index,pO=res.content||[],newAsg={},uniqueDemands=[],ids=[];i--;)if(index=ids.indexOf(team.demands[i].job.id),index===-1){for(newAsg={demandJobId:team.demands[i].job.id,jobTitle:team.demands[i].job.title,otherOffers:[],noDemands:1},ids.push(team.demands[i].job.id),j=pO.length;j--;)newAsg.demandJobId===pO[j].marketplaceMember.application.job.id&&(pO[j].user=pO[j].marketplaceMember.application.candidate,newAsg.user?newAsg.otherOffers.push(pO[j]):_.extend(newAsg,pO[j]));uniqueDemands.push(newAsg)}else uniqueDemands[index].noDemands++;team.asg=team.asg.concat(uniqueDemands),gl.ui.loading.rip=!1}):gl.ui.loading.rip=!1,team},reloadRolesInProgress:function(team){var asg=team.asg||[],i=asg.length;if(i>0){for(;i--;)angular.isDefined(asg[i].demandJobId)&&asg.splice(i,1);this.getRolesInProgress(team)}else this.ui.loading.rip=!1},reloadTeamDemands:function(team){var gl=this;team&&(this.ui.loading.rip=!0,this.srv.teams.get({id:team.id}).$promise.then(function(t){team.demands=t.demands,gl.reloadRolesInProgress(team)}))},isManagerAndTeamSelected:function(){return this.data.teams.my.length>1?(this.ui.selection.manager=this.isMyTeam(this.data.teams.my[0]),void(this.ui.selection.manager.type=this.getUserRole(this.ui.selection.manager))):void(this.ui.selection.manager||(this.data.teams.my.length>0?(this.ui.selection.manager=this.isMyTeam(this.data.teams.my[0]),this.ui.selection.manager.type=this.getUserRole(this.ui.selection.manager),this.ui.selection.team=this.data.teams.my[0],this.data.teams.my[0].isSelected=!0,this.getStats(),this.srv.loc.search("teamId",this.ui.selection.team.id)):this.data.teams.other.length>0&&(this.ui.selection.manager=null,this.ui.selection.cat="other",this.ui.viewTeam="other",this.ui.selection.team=null)))},getSkypeTest:function(skypeEnabled){return skypeEnabled?"":"Please ask this person to enter their Skype ID in their profile."},getReviewStats:function(){if(this.ui.selection.team&&vm.ui.features.rankAndReview[vm.ui.selection.team.id]){var gl=this;this.srv.review.status({teamId:gl.ui.selection.team.id},function(data){gl.ui.reviewStats=data})}}},vm=this,make={"do":leftSide};ctrls.teamDashboardGlobal.build(make,!0,vm)}]),ctrls.controller("TeamDashboardRightCtrl",[function(){var rightSide={fillWeeksRangeArr:function(countOfWeeks,delFirst){var weeksRange=[],sun=moment().endOf("isoWeek").toDate();for(delFirst&&(sun=moment(sun).subtract(7,"days").toDate());countOfWeeks--;)weeksRange.push(sun),sun=moment(sun).subtract(7,"days").toDate();return weeksRange},getSimpleAssignments:function(teamIds){var gl=this;this.srv.asg.listSimpleAssigments({teamIds:teamIds}).$promise.then(function(a){var group=_.groupBy(a,"teamId");for(var id in group)gl.data.teams.other.filter(function(team){return team.id===parseInt(id,10)}).pop().asg=group[id];vm.ui.loading.asg=!1})},getChart:function(d){var gl=this,mTarget=d.metricAvg.metricTarget?d.metricAvg.metricTarget:0,avgScore=d.metricAvg.statsMetricAvg?d.metricAvg.statsMetricAvg.reduce(function(a,b){return a+b})/4:0,metric={name:d.metricAvg.metricName?d.metricAvg.metricName:"No metric",data:d.metricAvg.statsMetricAvg?d.metricAvg.statsMetricAvg:[],allowPointSelect:!0,dataLabels:{enabled:!0,backgroundColor:"#ffffff",borderRadius:10,padding:5,shadow:{color:"#000000",offsetX:0,offsetY:1,opacity:.2,width:2},align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},format:"{point.y:,.1f}",y:-6},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3",symbol:"circle"},states:{select:{enabled:!1}},color:"#e5f6fe",zIndex:1},target={id:1,type:"line",dashStyle:"Dot",color:"#02a8f3",cursor:"pointer",visible:0!==mTarget,data:[mTarget,mTarget,mTarget,{y:mTarget,marker:{enabled:!0,symbol:"url(images/icons/5b20372c.metric-target-icon.png)"}}],stickyTracking:!1,marker:{enabled:!1},tooltip:{pointFormatter:function(){return"Metric Target: <b>"+this.y+"</b>"}},states:{hover:{enabled:!1}},zIndex:2},config={options:{chart:{type:"area"},legend:{enabled:!1},tooltip:{headerFormat:""},credits:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return moment(gl.fillWeeksRangeArr(4,!0)[this.value]).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"},padding:0},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,lineWidth:0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},yAxis:{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""}},series:[],avgScore:avgScore,avgPerc:mTarget?100*avgScore/mTarget:0};return d.metricAvg.statsMetricAvg&&config.series.push(metric),mTarget&&config.series.push(target),config},getStats:function(team,managerId){var gl=this;team?(team.chartConfig=null,team.activity=null):(this.ui.selection.team.chartConfig=null,this.ui.selection.team.activity=null);var params={id:team?team.id:this.ui.selection.team.id,managerId:managerId?managerId:this.ui.selection.manager?this.ui.selection.manager.id:null,fullTeam:this.ui.selection.fullTeam};this.srv.teams.teamAvg(params).$promise.then(function(d){team?(team.chartConfig=!!d.metricAvg.hasMetricsSetup&&gl.getChart(d),team.activity=!!d.activitiAvg&&d.activitiAvg):(gl.ui.selection.team.chartConfig=gl.getChart(d),gl.ui.selection.team.activity=d.activitiAvg)})},getMessage:function(msg){return this.srv.msg[msg]}},vm=this,make={"do":rightSide};ctrls.teamDashboardGlobal.build(make,!0,vm)}]),ctrls.controller("TeamDashboardWidgetsCtrl",[function(){var fn={getGoals:function(){if(this.ui.selection.team){var gl=this;return this.srv.goals.list({teamId:gl.ui.selection.team.id,active:!0}).$promise.then(function(goals){for(var i=goals.length,lastUpdate="";i--;)goals[i].progress=gl.srv.mgrGoals.getCurrentProgress(goals[i],moment().format("YYYY-MM-DD")),goals[i].progressPercent=gl.srv.mgrGoals.calculateProgressPercent(goals[i].progress,goals[i].baseline,goals[i].target),moment(goals[i].updatedOn).toDate()>=lastUpdate&&(lastUpdate=moment(goals[i].updatedOn).toDate());gl.data.widgets.goals=goals,gl.data.widgets.goalsLastUpdate=lastUpdate})["catch"](function(err){gl.setError(err.data)})}},getCheckinsChartConfig:function(data){function getChartColor(params){var perc=params.checkins/params.asgCount*100;return perc<30?"#f34336":perc>30&&perc<70?"#fed452":"#4aae52"}return{options:{chart:{type:"pie",backgroundColor:"",spacing:0},legend:{enabled:!1},tooltip:{enabled:!1},credits:{enabled:!1}},title:{align:"center",verticalAlign:"middle",margin:0,y:-4,style:{fontSize:"34px"},text:data.checkins+""},subtitle:{text:data.subtitle,align:"center",verticalAlign:"middle",margin:0,y:19,style:{fontSize:"11px",color:"#a7a8ac"}},series:[{dataLabels:{enabled:!1},name:name,data:[{y:data.checkins,color:getChartColor(data)},{y:data.asgCount-data.checkins,color:"#eceff1"}],innerSize:"75%",borderWidth:0,states:{hover:{enabled:!1}}}]}},getCheckins:function(selection){var gl=this;if(selection||(selection=this.ui.selection),selection.team)return this.srv.checkin.list({teamId:selection.team.id,managerId:selection.manager?selection.manager.id:null,from:moment().startOf("week").format("YYYY-MM-DD"),to:moment().format("YYYY-MM-DD")}).$promise.then(function(res){var asg=gl.ui.selection.team.asg.filter(function(a){return!!a.user}).length,today={checkins:res.filter(function(checkin){return checkin.date===moment().format("YYYY-MM-DD")&&"NOT_DONE"!==checkin.status}).length,asgCount:asg,subtitle:"out of "+asg+" done"},week={checkins:_.chain(res).filter(function(checkin){return"NOT_DONE"!==checkin.status}).map("assignmentId").uniq().size().value(),asgCount:asg,subtitle:"out of "+asg+" workers"};gl.data.widgets.checkins={today:gl.getCheckinsChartConfig(today),week:gl.getCheckinsChartConfig(week)}})["catch"](function(err){gl.setError(err.data)})},loadWidgets:function(){return vm["do"].getReviewStats(),this.data.widgets={checkins:this.getCheckins(),goals:this.getGoals()}},setFeatures:function(){this.srv.store.set("features",vm.ui.features),vm.ui.features.rankAndReview[vm.ui.selection.team.id]&&vm["do"].getReviewStats()},openRemoveToolWindow:function(widget){return this.ui.features.control[widget]?void(this.ui.features.control[widget]=!1):(this.ui.features.control=this.widgetsControlDefaults(),void(this.ui.features.control[widget]=!0))},handleWidget:function(widget){return"rankAndReview"===widget?(this.ui.features.rankAndReview[this.ui.selection.team.id]=!this.ui.features.rankAndReview[this.ui.selection.team.id],this.ui.features.control[widget]=!1,void this.setFeatures()):(this.ui.features[widget]=!this.ui.features[widget],this.ui.features.control[widget]=!1,void this.setFeatures())}},vm=this,data={widgets:{}},make={"do":fn,data:data};ctrls.teamDashboardGlobal.build(make,!0,vm)}]),ctrls.controller("TeamSettingsModalCtrl",["$uibModalInstance","team","$scope","ManagerService","$q","ManagerCommonService",function($uibModalInstance,team,$scope,ManagerService,$q,ManagerCommonService){function setDisabledFeatures(a){a.data.disabledFeatures=[],a.features.webcamPictures||a.data.disabledFeatures.push("WEBCAM_PICTURES"),a.features.screenShots||a.data.disabledFeatures.push("SCREENSHOTS"),a.features.applicationTracking||a.data.disabledFeatures.push("APPLICATION_TRACKING"),a.features.enforcerReview||a.data.disabledFeatures.push("ENFORCER_REVIEW")}function addFrequency(a){var webcamDisabled=a.data.disabledFeatures.indexOf("WEBCAM_PICTURES")>-1;a.data.featureValues={screenshotFrequency:a.data.screenshootFrequency.id,webcamshotFrequency:webcamDisabled?0:1}}function checkAllFeaturesTogglePropertyChange(properties){for(var trueFound,falseFound,allProperyStates=[],propL=properties.length;propL--;){for(var nodeL=$scope.d.teamDetails.team.nodes.length;nodeL--;)if(angular.isDefined($scope.d.teamDetails.team.nodes[nodeL].features)){var features=$scope.d.teamDetails.team.nodes[nodeL].features,screenShotSelect=$scope.d.teamDetails.team.nodes[nodeL].data.screenshootFrequency,isScreenshotEnabled="Disabled"!==screenShotSelect.name;features.screenShots=isScreenshotEnabled,allProperyStates.push(features[properties[propL]]);
}trueFound=allProperyStates.indexOf(!0)!==-1,falseFound=allProperyStates.indexOf(!1)!==-1,trueFound&&falseFound?($scope.allFeaturesToggle[properties[propL]].value=!0,$scope.allFeaturesToggle[properties[propL]].isDirty=!0):(trueFound&&$scope.allFeaturesToggle[properties[propL]].value!==!0?$scope.allFeaturesToggle[properties[propL]].value=!0:falseFound&&$scope.allFeaturesToggle[properties[propL]].value!==!1&&($scope.allFeaturesToggle[properties[propL]].value=!1),$scope.allFeaturesToggle[properties[propL]].isDirty=!1),allProperyStates=[]}}function getAssignmentFeatures(a){function isFeatureEnabled(assignment,feature){if(assignment.disabledFeatures)return assignment.disabledFeatures.indexOf(feature)===-1}var screenShotsEnabled=isFeatureEnabled(a,"SCREENSHOTS"),featureValues=_.findWhere(a.screenshootFrequencies,{id:a.featureValues.screenshotFrequency});a.screenshootFrequency=screenShotsEnabled?featureValues:a.screenshootFrequencies[0];var o={webcamPictures:isFeatureEnabled(a,"WEBCAM_PICTURES"),screenShots:screenShotsEnabled,applicationTracking:isFeatureEnabled(a,"APPLICATION_TRACKING"),enforcerReview:isFeatureEnabled(a,"ENFORCER_REVIEW")};return o}function getManager(){var deferred=$q.defer();return ManagerService.get({avatarType:"MANAGER",allSameCompanyManagers:!0},function(res){$scope.d.managers=res;var isCandidateAvatar=function(avatar){return"CANDIDATE"===avatar.type},userCandidate=_.chain(vm.data.currentUser.userAvatars).filter(isCandidateAvatar).first().value(),hasCurrentManager=_.chain($scope.d.managers).map("userAvatars").flatten().filter(isCandidateAvatar).some(function(managerCandidate){return managerCandidate.id===userCandidate.id}).value();hasCurrentManager||$scope.d.managers.push(vm.data.currentUser),deferred.resolve(res)}),deferred.promise}var vm=this,nodes=[],n=team.asg.length;for(ctrls.teamDashboardGlobal.build(!1,!0,vm),vm.srv.route.team=team.id;n--;)team.asg[n]=ManagerCommonService.addFrequencyToAssingment(team.asg[n]),nodes.push({data:team.asg[n],features:getAssignmentFeatures(team.asg[n])});$scope.modal=$uibModalInstance,$scope.d={showInModal:!0,isTeamOwner:vm["do"].canChangeTeamSettings(team),teamDetails:{team:{teamData:team,nodes:nodes}}},$scope.cancel=function(){$uibModalInstance.close("cancel")},$scope.allFeaturesToggle={webcamPictures:{value:!1,isDirty:!1},screenShots:{value:!1,isDirty:!1},applicationTracking:{value:!1,isDirty:!1},enforcerReview:{value:!1,isDirty:!1}},ManagerService.listTeamLogicalManagers({teamId:team.id},function(logicalManagers){$scope.d.teamDetails.team.logicalManagers=logicalManagers}),$scope.f={updateAllAssignmentsFeatures:function(assignments){for(var promises=[],i=assignments.length;i--;)setDisabledFeatures(assignments[i]),addFrequency(assignments[i]),promises.push(vm.srv.asg.edit({id:assignments[i].data.id},assignments[i].data).$promise);$q.all(promises)["catch"]()["finally"]()},updateSingleAssignmentFeatures:function(assignment,property){checkAllFeaturesTogglePropertyChange([property]),this.updateAllAssignmentsFeatures([assignment])},toggleSwitchAll:function(property){var i=$scope.d.teamDetails.team.nodes.length;for($scope.allFeaturesToggle[property].isDirty=!1;i--;)$scope.d.teamDetails.team.nodes[i].features[property]=$scope.allFeaturesToggle[property].value,"screenShots"===property&&($scope.d.teamDetails.team.nodes[i].data.screenshootFrequency=$scope.allFeaturesToggle[property].value===!0?$scope.d.teamDetails.team.nodes[i].data.screenshootFrequencies[4]:$scope.d.teamDetails.team.nodes[i].data.screenshootFrequencies[0]);this.updateAllAssignmentsFeatures($scope.d.teamDetails.team.nodes)},notAWatcher:function(manager){var team=$scope.d.teamDetails.team.teamData,allWatchers=[];if(allWatchers=allWatchers.concat($scope.d.teamDetails.team.logicalManagers),allWatchers=allWatchers.concat(team.watchers),allWatchers&&manager){var watcher=allWatchers.filter(function(w){return w&&w.id===manager.id}).pop();if(watcher)return!1}return!0},addWatcher:function(team,newWatcher){team.watchers||(team.watchers=[]),newWatcher&&newWatcher.id&&(team.watchers.push(newWatcher),$scope.f.updateTeam(team))},removeWatcher:function(team,watcherId){team.watchers=team.watchers.filter(function(w){return w.id!==watcherId})},updateTeam:function(team){vm.srv.teams.update({id:team.id},team)}},checkAllFeaturesTogglePropertyChange(["webcamPictures","screenShots","applicationTracking","enforcerReview"]),getManager()}]),ctrls.controller("TeamToolsModalCtrl",["$uibModalInstance",function($uibModalInstance){var tools={closeTools:function(){$uibModalInstance.close("cancel")}},vm=this,make={"do":tools};ctrls.teamDashboardGlobal.build(make,!0,vm)}]),ctrls.controller("RankAndReviewModalCtrl",["$uibModalInstance","ReviewService","$scope","$sce","$timeout","UtilsService","$filter","ProductivityService","TeamService","ProfileUtils",function($uibModalInstance,ReviewService,$scope,$sce,$timeout,UtilsService,$filter,ProductivityService,TeamService,ProfileUtils){function calculateMetrics(date){for(date=moment(date).subtract(4,"week").toDate(),vm.ui.performersInfo=vm.ui.metricsInfo.map(function(value){value.metricValue=0,value.prevMetricValue=0;var metricCounter=0,prevMetricCounter=0;if(angular.forEach(value.stats,function(v){moment(v.startDate).toDate().getTime()>date.getTime()?(value.metricValue+=v.ticketsResolved,metricCounter++):(value.prevMetricValue+=v.ticketsResolved,prevMetricCounter++)}),value.metricValue=metricCounter>0?value.metricValue/metricCounter:value.metricValue,value.prevMetricValue=prevMetricCounter>0?value.prevMetricValue/prevMetricCounter:value.prevMetricValue,0===value.metricValue)return null;if(value.metricValue>0&&value.prevMetricValue>0&&(value.change=value.metricValue/value.prevMetricValue-1),vm.ui.activitiesInfo){var activityInfo=vm.ui.activitiesInfo.find(function(a){return a.assignmentId===value.assignmentId});value.activityInfo=activityInfo}var assignment=vm.ui.selection.team.asg.find(function(a){return a.id===value.assignmentId});return assignment&&(value.assignment=assignment,value.realPhotoUrl=ProfileUtils.profilePhotoUrl(assignment.user)),value});vm.ui.performersInfo.indexOf(null)!==-1;)vm.ui.performersInfo.splice(vm.ui.performersInfo.indexOf(null),1);vm.ui.performersInfoChange=[],angular.forEach(vm.ui.performersInfo,function(v){v.change&&vm.ui.performersInfoChange.push(v)}),vm.ui.performersInfo.sort(function(a,b){return a.metricValue<b.metricValue?1:a.metricValue>b.metricValue?-1:0}),vm.ui.performersInfoChange.sort(function(a,b){return a.change<b.change?1:a.change>b.change?-1:0})}var vm=this,make={"do":{},ui:{reviewDetails:{},currentDate:new Date,isDatePickerVisible:!1,weekText:"",currentShowedWeek:0,datePickerOptions:{startingDay:1,showWeeks:!1},closeRankAndReview:function(){$uibModalInstance.close("cancel")},renderHtml:function(code){return $sce.trustAsHtml(code)},editReviewDetail:function(reviewDetail){var uiReviewDetail=vm.ui.reviewDetails[reviewDetail.id];uiReviewDetail&&uiReviewDetail.edit||(uiReviewDetail||(uiReviewDetail=vm.ui.reviewDetails[reviewDetail.id]={}),$timeout(function(){$("#review-detail-"+reviewDetail.id).focus()},10),uiReviewDetail.edit=!0,uiReviewDetail.newAnswer=reviewDetail.answer)},updateReviewDetail:function(review,reviewDetail){var uiReviewDetail=vm.ui.reviewDetails[reviewDetail.id];uiReviewDetail.updating=!0;var updateWidget=reviewDetail.answer.length&&!uiReviewDetail.newAnswer.length||!reviewDetail.answer.length&&uiReviewDetail.newAnswer.length;reviewDetail.answer=uiReviewDetail.newAnswer,ReviewService.update(review,function(data){vm.ui.currentReview=data,updateWidget&&vm["do"].getReviewStats(),delete vm.ui.reviewDetails[reviewDetail.id]},function(err){uiReviewDetail.updating=!1,uiReviewDetail.message=err.data.text})},changeDate:function(d){var dt=new Date(vm.ui.currentDate);dt.setDate(vm.ui.currentDate.getDate()+7*d),dt.getTime()<=vm.ui.maxDate.getTime()&&(vm.ui.currentDate=dt)},prevWeek:function(){this.changeDate(-1)},nextWeek:function(){this.changeDate(1)},openTimesheetCal:function($event){$event.preventDefault(),$event.stopPropagation(),vm.ui.isDatePickerVisible=!vm.ui.isDatePickerVisible},jumpToWeek:function(week){week?vm.ui.currentDate=moment().subtract(1,"week").toDate():vm.ui.currentDate=moment().toDate(),vm.ui.weekText=vm.ui.getWeekText(vm.ui.currentDate)},getWeekText:function(date){var week=UtilsService.getWeekOfDate(date,!1);return $filter("date")(week.firstDate,"MMM d")+" - "+$filter("date")(week.lastDate,"MMM d, yyyy")},loadMetrics:function(team,managerId,date){var totalMetrics=[],processedMetricsCount=0,fullTeam=null===vm.data.teams.my.find(function(t){return t.id===team.id});angular.forEach(team.metricsSetups,function(metricSetup){TeamService.getMetricValues({id:team.id,managerId:fullTeam?null:managerId,fullTeam:fullTeam,type:metricSetup.type,from:$filter("date")(moment(date).subtract(8,"week").toDate(),"yyyy-MM-dd"),to:$filter("date")(date,"yyyy-MM-dd")},function(data){angular.forEach(data,function(val){var existingValue=totalMetrics.find(function(v){return v.assignmentId===val.assignmentId});existingValue?angular.forEach(val.stats,function(s){var existingStat=existingValue.stats.find(function(es){return es.startDate===s.startDate});existingStat?existingStat.ticketsResolved+=s.ticketsResolved:existingValue.stats.push(s)}):totalMetrics.push(val)}),processedMetricsCount++,processedMetricsCount===vm.ui.selection.team.metricsSetups.length&&(vm.ui.metricsInfo=totalMetrics,calculateMetrics(date))})})},loadActivities:function(team,managerId,date,previousWeekDate){date.getTime()>(new Date).getTime()&&(date=new Date);var fullTeam=null===vm.data.teams.my.find(function(t){return t.id===team.id});ProductivityService.readGroupedTeamActivities({teamId:team.id,managerId:fullTeam?null:managerId,date:$filter("date")(date,"yyyy-MM-dd"),fullTeam:fullTeam,weekly:!0},function(data){vm.ui.activitiesInfo=data,vm.ui.metricsInfo&&calculateMetrics(previousWeekDate)})},loadMetricsAndActivities:function(){var week=UtilsService.getWeekOfDate(moment(vm.ui.currentDate),!1),previousWeek=UtilsService.getWeekOfDate(moment(vm.ui.currentDate).subtract(1,"week"),!1),managerId=vm.data.currentUser.userAvatars.find(function(avatar){return"MANAGER"===avatar.type}).id;delete vm.ui.metricsInfo,delete vm.ui.activitiesInfo,vm.ui.loadActivities(vm.ui.selection.team,managerId,week.lastDate,previousWeek.lastDate),vm.ui.loadMetrics(vm.ui.selection.team,managerId,previousWeek.lastDate)},getIconType:function(value,maxValue){var v=value/maxValue;return v>.8?"green":v<.5?"red":"yellow"},textEditorButtons:[["bold","underline","unordered-list","link"]]}};ctrls.teamDashboardGlobal.build(make,!0,vm),$scope.$watch("vm.ui.currentDate",function(nv,ov){if(nv!==ov){vm.ui.isDatePickerVisible=!1,vm.ui.weekText=vm.ui.getWeekText(vm.ui.currentDate);var previousWeekDt=new Date;if(previousWeekDt.setDate(previousWeekDt.getDate()-7),vm.ui.weekText===vm.ui.getWeekText(new Date)?(vm.ui.currentShowedWeek=0,vm.ui.outOfWeek=!1):vm.ui.weekText===vm.ui.getWeekText(previousWeekDt)?(vm.ui.currentShowedWeek=1,vm.ui.outOfWeek=!1):vm.ui.outOfWeek=!0,vm.ui.getWeekText(ov)!==vm.ui.getWeekText(nv)){var dateString=$filter("date")(vm.ui.currentDate,"yyyy-MM-dd");ReviewService.get({teamId:vm.ui.selection.team.id,date:dateString},function(data){dateString===$filter("date")(vm.ui.currentDate,"yyyy-MM-dd")&&(delete vm.ui.message,vm.ui.currentReview=data,vm.ui.currentDate=UtilsService.getUtc(moment(data.weekEndDate).toDate()))},function(err){"CROS-0001"===err.data.errorCode?vm.ui.message="There is no data available for provided week: "+vm.ui.getWeekText(vm.ui.currentDate):vm.ui.message=err.data.text}),vm.ui.loadMetricsAndActivities()}}}),ReviewService.create({teamId:vm.ui.selection.team.id},function(data){delete vm.ui.message,vm.ui.currentReview=data,vm.ui.currentDate=UtilsService.getUtc(moment(data.weekEndDate).toDate()),vm.ui.maxDate=UtilsService.getUtc(moment(data.weekEndDate).toDate())},function(err){vm.ui.message=err.data.text}),vm.ui.loadMetricsAndActivities()}]),ctrls.controller("ScreenshotModalCtrl",["$uibModalInstance","usr",function($uibModalInstance,usr){var screenshot={scrUiDefaults:function(){var gl=this,date=null;return{date:date?moment(date).utc().toDate():moment().utc().toDate(),today:moment().toDate(),options:{formatYear:"yyyy",startingDay:1,showWeeks:!1,showButtonBar:!1},isCalendarOpen:!1,isScreenshot:!0,showSubImage:!0,loading:!0,isToday:function(){return moment(this.date).format("YYYY-MM-DD")===moment(this.today).format("YYYY-MM-DD")},scrOpenCalendar:function(e){e.preventDefault(),e.stopPropagation(),this.isCalendarOpen=!this.isCalendarOpen},changeDate:function(days){this.date=moment(this.date).add(days,"days").utc().toDate(),gl.getLogbook(!1,!0)},switchSlot:function(slot){slot&&(gl.data.logbook.contractorTimeSlots.filter(function(c){c&&c.selected&&(c.selected=!1)}),slot.selected=!0,gl.data.selected=slot)},nextPreviousSlot:function(isNext,doSwitch){var founded,idx=gl.data.logbook.contractorTimeSlots.indexOf(gl.data.selected);for(isNext?idx+=1:idx-=1;isNext?idx<=144:idx>=0;isNext?idx++:idx--)if(gl.data.logbook.contractorTimeSlots[idx]){founded=gl.data.logbook.contractorTimeSlots[idx];break}return doSwitch?void this.switchSlot(founded):founded},switchOnKey:function(e){37===e.keyCode&&this.nextPreviousSlot(!1,!0),39===e.keyCode&&this.nextPreviousSlot(!0,!0)},fitScreenShot:function(){var dialog=angular.element(".modal-dialog");dialog.hasClass("fit")?dialog.removeClass("fit"):dialog.addClass("fit")},closeModal:function(){$uibModalInstance.close("cancel")},selectScreenshot:function(ss){vm.data.selected.card.activeScreenshot=ss,vm.data.selected.card.screenshots.forEach(function(x){x.active=!1}),ss.active=!0}}},getIndexOfTime:function(millis){var date=moment(millis).utc();return Math.round(6*date.hours())+Math.round(date.minutes()/10)},getLogbook:function(today,firstTc){for(var vm=this,sv=this.data,asg=this.data.asg,promises=[],params={assignmentId:asg.id,teamId:asg.team.id,managerId:asg.selection.manager.id,date:moment(sv.modal.date).format("YYYY-MM-DD")};promises.length<2;)1===promises.length&&(params.groups="groups"),promises.push(this.srv.prod.readTeamActivities(params).$promise);return today&&(sv.modal.date=sv.modal.today),sv.modal.loading=!0,sv.logbook=new Array(1),sv.selected=null,angular.element(".activity .timeline").scrollLeft(0),this.srv.q.all(promises).then(function(p){return p[0].length?(p[0][0].grouping=p[1][0].grouping,sv.logbook=p[0][0],void vm.srv.asg.workDiary({id:asg.id,date:moment(sv.modal.date).format("YYYY-MM-DD"),timeZoneId:asg.user.location.timeZone.id}).$promise.then(function(t){t.map(function(timecard){return timecard.screenshots=timecard.images.filter(function(image){if("SCREENSHOT"===image.type)return image}),timecard.screenshots.length>0&&(timecard.activeScreenshot=timecard.screenshots[0],timecard.activeScreenshot.active=!0),timecard});for(var i=t.length,l=firstTc?0:144;i--;){var idx=vm.getIndexOfTime(t[i].date+asg.user.location.timeZone.offset),slot=sv.logbook.contractorTimeSlots[idx]?sv.logbook.contractorTimeSlots[idx]:null;slot&&(slot.card=t[i],slot.card.time=vm.getFormattedDate(t[i].date,asg.user.location.timeZone.offset,"hh:mm a"),slot.selected=!1)}if(sv.logbook){for(;firstTc?l<=144:l>=0;firstTc?l++:l--)if(sv.logbook.contractorTimeSlots[l]){sv.logbook.contractorTimeSlots[l].selected=!0,sv.selected=sv.logbook.contractorTimeSlots[l];break}setTimeout(function(){var selected=angular.element(".ruler .item .selected").offset().left-angular.element(".activity .timeline").offset().left-(firstTc?30:650);angular.element(".activity .timeline").scrollLeft(selected),vm.srv.scope.$apply()},0)}angular.element(".modal-body").focus(),sv.modal.loading=!1})):(sv.logbook.grouping={alignmentScore:0,focusScore:0,intensityScore:0},void(sv.modal.loading=!1))}),sv.logbook}},vm=this,data={asg:usr,modal:"scrUiDefaults",logbook:"getLogbook"},make={"do":screenshot,data:data};ctrls.teamDashboardGlobal.build(make,!0,vm)}]),ctrls.controller("HireStatusCtrl",["$scope","$routeParams","AssignmentService","SelectionService","TeamService","$uibModal","$location","CurrentUser","$q","$rootScope",function($scope,$routeParams,AssignmentService,SelectionService,TeamService,$uibModal,$location,CurrentUser,$q,$rootScope){function init(){$rootScope.scrollToTop();var promises=[];promises.push(CurrentUser.get(function(user){$scope.ui.external=!user.company.internal}).$promise),promises.push(AssignmentService.get({id:id},function(asgn){"CANDIDATE_REJECTED"===asgn.status&&$location.path("/manager/candidates"),$scope.assignment=asgn,$scope.candidate=asgn.selection.marketplaceMember.application.candidate}).$promise),promises.push(SelectionService.tasks({id:id},processTasks).$promise),$q.all(promises)["catch"](errorCallback)["finally"](finalCallback),TeamService.query({avatarType:"MANAGER"},function(teams){$scope.data.teams=teams,$scope.data.team=teams[0]})}function processTasks(tasks){$scope.data.currentStep=$scope.candidateSteps.slice(-1)[0].id+1;var candidateTasks=tasks.filter(function(task){return 0===task.taskType.indexOf("candidate")});if(candidateTasks.length>0){var taskName=candidateTasks[0].taskType,steps=$scope.candidateSteps.filter(function(step){return step.name===taskName});steps.length>0&&($scope.data.currentStep=steps[0].id)}}function finalCallback(){$rootScope.scrollToTop(),$scope.ui.isLoading=!1}function errorCallback(err){$rootScope.scrollToTop(),$scope.ui.err=angular.isObject(err.data)?err.data.text:err.text}var id=$routeParams.assignmentId;$scope.ui={isLoading:!0,modal:null,external:!1},$scope.candidateSteps=[{id:1,name:"candidateProvidesTrackerPassword",title:"Setup tracker"},{id:2,name:"candidateSetsUpPayoneer",title:"Setup payoneer"},{id:3,name:"candidateAcceptsAgreements",title:"Accept terms and conditions"}],$scope.data={},init(),$scope.isCandidateFinished=function(){return $scope.data.currentStep>$scope.candidateSteps.slice(-1)[0].id},$scope.teamModal=function(){$scope.assignment.team||($scope.ui.modal=$uibModal.open({templateUrl:"team-setup-modal.tpl.html",scope:$scope,backdrop:"static",windowClass:"hire-status modal-center"}))},$scope.revokeModal=function(){$scope.ui.modal=$uibModal.open({templateUrl:"revoke-offer-confirm.tpl.html",scope:$scope,backdrop:"static"})},$scope.setupTeam=function(){$scope.closeModal(),$scope.assignment.team||($scope.ui.isLoading=!0,AssignmentService.managerSetupTeam({id:id},$scope.data.team,function(asgn){$scope.assignment=asgn},errorCallback).$promise["finally"](finalCallback))},$scope.revokeOffer=function(){$scope.closeModal(),$scope.ui.isLoading=!0,SelectionService.cancel({id:$scope.assignment.selection.id},{},function(){$location.path("/manager/candidate")},errorCallback).$promise["finally"](finalCallback)},$scope.closeModal=function(){$scope.ui.modal&&$scope.ui.modal.close()}}]),bandcampApp.directive("hireTeam",["routePrefix",function(routePrefix){return{restrict:"E",scope:{close:"&"},templateUrl:routePrefix+"manager/hire-team/team.html",controller:"HireTeamCtrl",controllerAs:"vm"}}]),ctrls.controller("HireTeamCtrl",["$uibModal","TeamService","CurrentUser","AssignmentService","ManagerService","CacheService","$routeParams","baseUrl","$q","$window","$location","routePrefix","SelectionService","$document","$scope","TimeUtils",function($uibModal,TeamService,CurrentUser,AssignmentService,ManagerService,CacheService,$routeParams,baseUrl,$q,$window,$location,routePrefix,SelectionService,$document,$scope,TimeUtils){function init(){loadManager();var teamId=$location.search().teamId;if(teamId){var promises=[];vm.UI.isLoading=!0,promises.push(TeamService.get({id:teamId}).$promise),promises.push(AssignmentService.list({teamId:teamId,status:"ACTIVE,MANAGER_SETUP"}).$promise),promises.push(SelectionService.get({teamId:teamId,status:"OFFERED,IN_PROGRESS"}).$promise),$q.all(promises).then(function(res){vm.team=res[0];var assignments=res[1].content||[];assignments.forEach(function(a){a.description=a.jobTitle}),vm.assignments=_.sortBy(assignments,function(a){return[a.status,a.selection.marketplaceMember.application.candidate.printableName].join("_")}),vm.pendingOffers=res[2].content||[],vm.pendingOffers=_.sortBy(vm.pendingOffers,"createdOn"),updateDemands(),vm.UI.isLoading=!1})}}function loadManager(){return CurrentUser.getAvatar({avatarType:"MANAGER"}).$promise.then(function(res){vm.manager=res})}function groupDemandsByRoleAndCount(demands){var index,uniqueDemands=[],ids=[];return demands.forEach(function(d){index=ids.indexOf(d.job.id),index===-1?(d.noDemands=1,ids.push(d.job.id),uniqueDemands.push(d)):uniqueDemands[index].noDemands++}),uniqueDemands}function updateDemands(){var demands=vm.team.demands||[],pendingOffers=angular.copy(vm.pendingOffers)||[];vm.team.seats=vm.assignments,demands.length&&(demands=groupDemandsByRoleAndCount(demands),demands.forEach(function(d){d.otherOffers=[],d.allOffers=[],pendingOffers.forEach(function(pO){d.job.id===pO.marketplaceMember.application.job.id&&(d.selection?d.otherOffers.push(pO):d.selection=pO,d.allOffers.push(pO))})}),demands=_.sortBy(demands,function(d){return d.selection}),vm.team.seats=vm.team.seats.concat(angular.copy(demands)))}function selectSeat(seat){vm.selectedJob=seat.job,vm.showSidebar=!0,vm.UI.showSeatOptions=null}function removeSeat(seat){openChangeRemoveRoleModal(seat,function(){vm.team.demands=vm.team.demands.filter(function(d){return d.id!==seat.id}),updateTeam(vm.team)})}function updateTeam(team){var promise=TeamService.update({id:team.id},team).$promise;return promise.then(function(res){vm.team=res,updateDemands()}),promise}function openChangeRemoveRoleModal(seat,callbackAction){seat.allOffers&&0!==seat.allOffers.length?$uibModal.open({templateUrl:"change-remove-confirmation.tpl.html",windowClass:"center-modal",controller:"ChangeRemoveSeatCtrl",resolve:{callback:function(){return callbackAction}}}):callbackAction()}function changeSeat(seat){openChangeRemoveRoleModal(seat,function(){vm.addSeatModal(seat),vm.UI.showSeatOptions=null})}function addSeatModal(selectedSeat){$uibModal.open({templateUrl:routePrefix+"manager/hire-team/seat-modal/seat-modal.tpl.html",backdrop:!1,windowClass:"hire-team-modal wide",controller:"SeatModalCtrl",keyboard:!1,resolve:{team:function(){return vm.team},selectedSeat:function(){return selectedSeat},updateTeam:function(){return updateTeam}}})}function candidateProfileModal(profileId){vm.showCandidateProfile?(vm.showCandidateProfile=!1,angular.element("body").removeClass("overflowAllh")):profileId&&($routeParams.id=profileId,vm.showCandidateProfile=!0,angular.element("body").addClass("overflowAllh"))}function pendingOffersModalCtrl($scope,$uibModalInstance,pendingOffers){$scope.pendingOffers=pendingOffers,$scope.getCandidateCurrentTime=function(cand){return TimeUtils.getTimeByTimezoneOffset(cand.location.timeZone.offset)},$scope.close=function(){$uibModalInstance.dismiss("cancel")}}function pendingOffersModal(seat){seat.allOffers&&seat.allOffers.length&&$uibModal.open({templateUrl:"pending-offers-modal.tpl.html",backdrop:!1,windowClass:"pending-offers-modal modal-light-background",controller:pendingOffersModalCtrl,resolve:{pendingOffers:function(){return seat.allOffers}}})}var vm=this;vm.pagination={current:1},vm.selectSeat=selectSeat,vm.changeSeat=changeSeat,vm.removeSeat=removeSeat,vm.updateTeam=updateTeam,vm.addSeatModal=addSeatModal,vm.candidateProfileModal=candidateProfileModal,vm.pendingOffersModal=pendingOffersModal,vm.UI={isLoading:!1,showSeatOptions:null},$routeParams.fromHireTeam=!0,init(),$document.bind("click",function(event){var isDropdown=angular.element(".seat-person").find(event.target).length>0;isDropdown||(vm.UI.showSeatOptions=null,$scope.$apply())}),$scope.location=$location,$scope.$watch("location.search().teamId",function(value,old){value&&value!==old&&init()})}]),ctrls.controller("ChangeRemoveSeatCtrl",["$scope","$uibModalInstance","callback",function($scope,$uibModalInstance,callback){$scope.confirm=function(){$uibModalInstance.close(),callback()},$scope.cancel=function(){$uibModalInstance.close()}}]),ctrls.controller("SeatModalCtrl",["$scope","JobService","team","selectedSeat","updateTeam","$uibModalInstance",function($scope,JobService,team,selectedSeat,updateTeam,$uibModalInstance){function loadJobs(){vm.UI.isLoading=!0,JobService.crud.query({avatarType:"MANAGER"},function(data){vm.data.roles=data,vm.UI.isLoading=!1})}function initSeat(){vm.data.estimatedCost=vm.team.totalCost,selectedSeat&&(vm.data.selectedRole=selectedSeat.job,vm.data.currentSeatName=selectedSeat.description,vm.data.estimatedCost-=getRoleWeeklyCost(selectedSeat.job))}function getRoleWeeklyCost(role){return"WEEKLY"===role.salaryType?role.salary*role.workingHoursPerWeek:12*role.salary/50}function selectThisRole(role){vm.data.selectedRole=role}function saveSeat(){var job=vm.data.selectedRole;if(vm.selectedJob&&(job=vm.selectedJob),selectedSeat){var seat=_.find(team.demands,function(d){return d.id===selectedSeat.id});seat.job=job}else team.demands.push({job:job});vm.UI.isLoading=!0,vm.updateTeam(team).then(function(){vm.data.estimatedCost+=getRoleWeeklyCost(vm.data.selectedRole),selectedSeat=void 0,vm.data.selectedRole=void 0})["finally"](function(){vm.UI.isLoading=!1})}function done(){$uibModalInstance.dismiss()}function expandDescription(job,event){var target=angular.element(event.target),parent=target.parents("li"),description=parent.find(".description"),items=target.parents("ul").find("li"),isNotEmpty=!_.isEmpty(description.html());items.each(function(){var e=angular.element(this),desc=e.find(".description");e.removeClass("opened"),desc.removeClass("lock-overlay"),desc.removeAttr("style"),desc.html("")}),isNotEmpty||(description.addClass("lock-overlay"),parent[0].scrollIntoView(),parent.addClass("opened"),JobService.crud.getAuthenticated({id:job.id}).$promise.then(function(res){description.css("margin","15px 0").css("padding","15px").css("border","1px solid lightgray"),description.html(res.managerDescription)})["finally"](function(){description.removeClass("lock-overlay")}))}var vm=this;$scope.vm=vm,vm.team=team,vm.data={},vm.UI={},vm.done=done,vm.updateTeam=updateTeam,vm.getRoleWeeklyCost=getRoleWeeklyCost,vm.selectThisRole=selectThisRole,vm.saveSeat=saveSeat,vm.expandDescription=expandDescription,loadJobs(),initSeat()}]),ctrls.controller("HireTeamLandingCtrl",["$uibModal","CurrentUser","TeamService","TeamTemplateService","$location","$q","CacheService",function($uibModal,CurrentUser,TeamService,TeamTemplateService,$location,$q,CacheService){function init(){vm.UI.isLoading=!0;var promises=[CurrentUser.getAvatar({avatarType:"MANAGER"}).$promise,TeamService.teamsManagersMap().$promise,TeamTemplateService.list().$promise];$q.all(promises).then(function(data){vm.manager=data[0],vm.data.existingTeams=data[1],vm.data.teamTemplates=data[2],vm.UI.isLoading=!1})}function redirectToTeamEdit(teamId){teamId&&$location.path("/manager/hire-team/"+teamId)}function createEditTemplateCtrl($scope,$uibModalInstance){$scope.existingTeams=vm.data.existingTeams,$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.team={teamOwner:vm.manager},$scope.error=void 0,$scope.createTeam=function(){$scope.isLoading=TeamService.create({avatarType:"MANAGER"},$scope.team),$scope.isLoading.$promise.then(function(res){$scope.error=void 0,CacheService.remove("/teams?related=true"),$uibModalInstance.close(res)})["catch"](function(err){$scope.error=err.data.text})},$scope.selected={},$scope.editTeam=function(){$uibModalInstance.close($scope.selected.team)}}var vm=this;vm.data={editTeam:null,existingTeams:[],teamTemplates:[]},vm.UI={isLoading:!1},init(),vm.createNewTeam=function(){$location.path("manager/hire-team")},vm.editTeamModal=function(){$uibModal.open({templateUrl:"edit-template-modal.tpl.html",backdrop:!1,windowClass:"hire-team-modal",controller:createEditTemplateCtrl}).result.then(function(editTeam){redirectToTeamEdit(editTeam.id)})},vm.whyModal=function(){$uibModal.open({templateUrl:"why.tpl.html",backdrop:"static",controller:createEditTemplateCtrl})}}]),bandcampApp.directive("teamCost",["routePrefix",function(routePrefix){function teamCostController($scope){function setCost(){vm.demandCost=0,vm.assignmentCost=0;var team=$scope.team,assignments=$scope.assignments;angular.isDefined(team)&&_.each(team.demands,function(d){vm.demandCost+=getWeeklyCost(d.job.salary,d.job.salaryType,d.job.workingHoursPerWeek)}),angular.isDefined(assignments)&&_.each(assignments,function(a){vm.assignmentCost+=getWeeklyCost(a.salary,a.salaryType,a.weeklyLimit)}),vm.totalCost=vm.demandCost+vm.assignmentCost,$scope.team.totalCost=vm.totalCost}function getWeeklyCost(salary,salaryType,weeklyLimit){return"WEEKLY"===salaryType?salary*weeklyLimit:12*salary/50}var vm=this;setCost(),$scope.$watch("team",setCost)}var TEMPLATE_PATH="manager/hire-team/team-cost/team-cost.tpl.html";return{restrict:"E",scope:{team:"=",assignments:"="},controller:teamCostController,controllerAs:"vm",templateUrl:routePrefix+TEMPLATE_PATH}}]),bandcampApp.directive("teamTimezone",["routePrefix","CurrentUser","TimeUtils","$uibModal",function(routePrefix,CurrentUser,TimeUtils,$uibModal){function teamTimezoneController($scope){function init(){var assignments=$scope.assignments;angular.isDefined(assignments)&&!_.isEmpty(assignments)&&CurrentUser.get(function(u){vm.currentUser=u,vm.currentUser.name="You",vm.currentUser.utcDifference=getUtcDiff(vm.currentUser.location.timeZone.offset);var users=_.map(assignments,function(a){return a.selection.marketplaceMember.application.candidate});users=_.sortBy(users,function(c){var offset=c.location.timeZone.offset;return c.name=c.firstName,c.utcDifference=getUtcDiff(offset),offset}).reverse(),users.unshift(vm.currentUser),vm.users=users})}function getUtcDiff(offset){var diff="UTC";if(0!==offset){var cp=Math.abs(offset)/1e3/60/60,hours=Math.floor(cp);diff+=offset>0?"+":"-",diff+=hours,cp>hours&&(diff+="."+10*(cp-hours))}return diff}function getCurrentTime(timezone,toDecimal){if(timezone){var time,offset=timezone.offset;if(time=offset?TimeUtils.getTimeByTimezoneOffset(offset):TimeUtils.getUTCTime(),toDecimal){var timeStr=time.getHours()+"."+Math.floor(time.getMinutes()/60*100);return Number(timeStr)}return time}}function openModal(){$scope.modal=$uibModal.open({templateUrl:"current-time-modal.tpl.html",backdrop:"static",scope:$scope})}function closeModal(){$scope.modal.dismiss()}var vm=this;$scope.getCurrentTime=getCurrentTime,$scope.openModal=openModal,$scope.closeModal=closeModal,init(),$scope.$watch("assignments",init,!0)}var TEMPLATE_PATH="manager/hire-team/team-timezone/team-timezone.tpl.html";return{restrict:"E",scope:{assignments:"="},replace:!0,controller:teamTimezoneController,controllerAs:"vm",templateUrl:routePrefix+TEMPLATE_PATH}}]),ctrls.controller("HireTeamCategoriesCtrl",["TeamCategoryService","$location","$uibModal","CurrentUser",function(TeamCategoryService,$location,$uibModal,CurrentUser){function loadCategories(){TeamCategoryService.query({extended:!0}).$promise.then(function(res){vm.categories=res})}function createTeamModal(){$uibModal.open({templateUrl:"create-team-modal.tpl.html",backdrop:!1,windowClass:"hire-team-modal",controller:"CategoriesCreateTeamCtrl",resolve:{manager:function(){return vm.manager}}}).result.then(function(res){$location.path("manager/team-dashboard").search({teamId:res.id})})}var vm=this;vm.loading=!0,vm.createTeamModal=createTeamModal,loadCategories(),CurrentUser.getAvatar({avatarType:"MANAGER"}).$promise.then(function(res){vm.manager=res})["finally"](function(){vm.loading=!1}),vm.openCategory=function(catId){$location.path("manager/hire-team/category/"+catId)}}]),ctrls.controller("HireTeamCategoryCtrl",["TeamCategoryService","$routeParams",function(TeamCategoryService,$routeParams){var vm=this;vm.DATA={teams:[],categoryId:$routeParams.id},vm.UI={loading:!1},vm.init=function(){vm.UI.loading=!0,TeamCategoryService.getTeams({id:$routeParams.id}).$promise.then(function(res){vm.DATA.categoryName=res.name||null,vm.DATA.teams=res.teams||[],vm.DATA.teams.forEach(function(team){team.chartConfig=!team.productivtyAvg.metricAvg.hasMetricsSetup||vm.getChartConfig(team.productivtyAvg.metricAvg);
})})["finally"](function(){vm.UI.loading=!1})}(),vm.getChartConfig=function(metricAvg){var mTarget=metricAvg.metricTarget?metricAvg.metricTarget:0,avgScore=metricAvg.statsMetricAvg?metricAvg.statsMetricAvg.reduce(function(a,b){return a+b})/4:0,metric={name:metricAvg.metricName?metricAvg.metricName:"No metric",data:metricAvg.statsMetricAvg?metricAvg.statsMetricAvg.map(function(num){return parseFloat(Math.round(num+"e+1")+"e-1")}):[],allowPointSelect:!0,dataLabels:{enabled:!0,backgroundColor:"#ffffff",borderRadius:10,padding:2,shadow:{color:"#999999",offsetX:0,offsetY:1,opacity:.2,width:2},align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},formatter:function(){var i=this.y.toString().length,extraStr="";if(3===i)extraStr='<span style="color: white">.</span>';else for(;i<3;)extraStr+='<span style="color: white">.</span>',i++;return extraStr+"<span>"+this.y+"</span>"},y:-6,crop:!1,overflow:"none"},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3",symbol:"circle"},states:{select:{enabled:!1}},color:"#e5f6fe",zIndex:1},target={id:1,type:"line",dashStyle:"Dot",lineWidth:1,color:"#c1c8cd",cursor:"pointer",visible:0!==mTarget,data:[mTarget,mTarget,mTarget,{y:mTarget,marker:{enabled:!0,symbol:"url(images/icons/5b20372c.metric-target-icon.png)"}}],stickyTracking:!1,marker:{enabled:!1},tooltip:{pointFormatter:function(){return"Metric Target: <b>"+this.y+"</b>"}},states:{hover:{enabled:!1}},zIndex:2},config={options:{chart:{type:"area",margin:[0,0,0,0]},legend:{enabled:!1},tooltip:{headerFormat:""},credits:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{labels:{enabled:!1},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},yAxis:{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""}},series:[],avgScore:avgScore,avgPerc:mTarget?100*avgScore/mTarget:0};return metricAvg.statsMetricAvg&&config.series.push(metric),mTarget&&config.series.push(target),config}}]),ctrls.controller("CategoriesCreateTeamCtrl",["$scope","$uibModalInstance","TeamService","CacheService","manager",function($scope,$uibModalInstance,TeamService,CacheService,manager){$scope.team={teamOwner:manager},$scope.back=function(){$uibModalInstance.dismiss()},$scope.submit=function(){$scope.error=void 0,$scope.loading=!0,TeamService.create({avatarType:"MANAGER"},$scope.team).$promise.then(function(res){$uibModalInstance.close(res),CacheService.remove("/teams?related=true","teamCache")})["catch"](function(err){$scope.loading=!1,$scope.error=err.data.text})}}]),ctrls.controller("HireTeamPreviewCtrl",["TeamService","$routeParams","$uibModal","$location",function(TeamService,$routeParams,$uibModal,$location){function meetTheLeaderModalCtrl($scope,$uibModalInstance){$scope.team=vm.team,$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.ok=function(){$uibModalInstance.close()}}var vm=this;vm.loading=!0,vm.categoryId=$routeParams.id,TeamService.get({id:$routeParams.teamId,extended:!0}).$promise.then(function(res){vm.team=res})["finally"](function(){vm.loading=!1}),vm.meetTheLeaderModal=function(){$uibModal.open({templateUrl:"meet-the-leader-modal.tpl.html",backdrop:!1,windowClass:"meet-the-leader-modal",controller:meetTheLeaderModalCtrl}).result.then(function(){$location.path("interview/schedule/category/"+$routeParams.id+"/team/"+$routeParams.teamId)})}}]),bandcampApp.directive("teamTable",["routePrefix","$document",function(routePrefix,$document){function teamTableController($scope,TimeUtils,$q){var vm=this;vm.assignments=$scope.assignments,vm.UI={showSeatOptions:null},vm.mpmApplicationView={open:function(assignment){$scope.selectedMember=assignment.selection.marketplaceMember},close:function(){$scope.selectedMember=null},switchMpm:function(dir){var i,deferred=$q.defer(),curr=$scope.selectedMember;return _.each(vm.assignments,function(assignment,index){assignment.selection.marketplaceMember.id===curr.id&&(i=index)}),vm.assignments[i+dir]?($scope.selectedMember=vm.assignments[i+dir].selection.marketplaceMember,deferred.resolve()):deferred.resolve(),deferred.promise},reject:function(){var idx=_.find(vm.assignments,function(assignment){return assignment.selection.marketplaceMember.id===$scope.selectedMember.id});vm.assignments.splice(idx,1)}},vm.getCurrentTime=function(location){if(location){var offset=location.timeZone.offset;return offset?TimeUtils.getTimeByTimezoneOffset(offset):TimeUtils.getUTCTime()}},$document.bind("click",function(event){var isDropdown=angular.element(".seat-person").find(event.target).length>0;isDropdown||(vm.UI.showSeatOptions=null,$scope.$apply())})}var TEMPLATE_PATH="manager/hire-team/team-table/team-table.tpl.html";return{restrict:"E",scope:{assignments:"=",seatControls:"@"},replace:!0,controller:teamTableController,controllerAs:"vm",templateUrl:routePrefix+TEMPLATE_PATH}}]),bandcampApp.directive("teamCostLeader",["routePrefix",function(routePrefix){function TeamCostLeaderCtrl($uibModal){var vm=this;vm.openVideo=function(){$uibModal.open({templateUrl:"leader-video.tpl.html",windowClass:"leader-video",controller:function($scope,$uibModalInstance){$scope.modal=$uibModalInstance}})}}var TEMPLATE_PATH="manager/hire-team/team-cost-leader/team-cost-leader.tpl.html";return{restrict:"E",scope:{team:"="},replace:!0,controller:TeamCostLeaderCtrl,controllerAs:"vm",templateUrl:routePrefix+TEMPLATE_PATH}}]),bandcampApp.directive("teamProductivity",["routePrefix","MessagesService",function(routePrefix,MessagesService){function TeamProductivityController($scope){function getChartConfig(productivity){var mTarget=productivity.metricAvg.metricTarget?productivity.metricAvg.metricTarget:0,avgScore=productivity.metricAvg.statsMetricAvg?productivity.metricAvg.statsMetricAvg.reduce(function(sum,next){return sum+next})/4:0,metric={name:productivity.metricAvg.metricName?productivity.metricAvg.metricName:"No metric",data:productivity.metricAvg.statsMetricAvg?productivity.metricAvg.statsMetricAvg:[],allowPointSelect:!0,dataLabels:{enabled:!0,backgroundColor:"#ffffff",borderRadius:10,padding:5,shadow:{color:"#000000",offsetX:0,offsetY:1,opacity:.2,width:2},align:"center",allowOverlap:!0,color:"#02a8f3",style:{textShadow:""},format:"{point.y:,.1f}",y:-6},lineColor:"#02a8f3",marker:{fillColor:"#FFFFFF",lineWidth:2,radius:3,lineColor:"#02a8f3",symbol:"circle"},states:{select:{enabled:!1}},color:"#e5f6fe",zIndex:1},target={id:1,type:"line",dashStyle:"Dot",color:"#02a8f3",cursor:"pointer",visible:0!==mTarget,data:[mTarget,mTarget,mTarget,{y:mTarget,marker:{enabled:!0,symbol:"url(images/icons/5b20372c.metric-target-icon.png)"}}],stickyTracking:!1,marker:{enabled:!1},tooltip:{pointFormatter:function(){return"Metric Target: <b>"+this.y+"</b>"}},states:{hover:{enabled:!1}},zIndex:2},config={options:{chart:{type:"area"},legend:{enabled:!1},tooltip:{headerFormat:""},credits:{enabled:!1}},title:{text:""},subtitle:{text:""},xAxis:{type:"datetime",labels:{enabled:!0,formatter:function(){return moment(fillWeeksRangeArr(4,!0)[this.value]).format("MMM DD")},style:{"font-size":"10px",color:"#b2b4b6"},padding:0},tickInterval:1,minPadding:0,maxPadding:0,startOnTick:!0,endOnTick:!0,reversed:!0,lineWidth:0,tickWidth:0,gridLineWidth:1,gridLineColor:"#ececed"},yAxis:{tickWidth:0,labels:{enabled:!1},gridLineWidth:1,gridLineColor:"#ececed",title:{text:""}},series:[],avgScore:avgScore,avgPerc:mTarget?100*avgScore/mTarget:0};return productivity.metricAvg.statsMetricAvg&&config.series.push(metric),mTarget&&config.series.push(target),config}function fillWeeksRangeArr(countOfWeeks,delFirst){var weeksRange=[],sun=moment().endOf("isoWeek").toDate();for(delFirst&&(sun=moment(sun).subtract(7,"days").toDate());countOfWeeks--;)weeksRange.push(sun),sun=moment(sun).subtract(7,"days").toDate();return weeksRange}var vm=this;vm.chartConfig=getChartConfig($scope.productivity),vm.getMessage=function(msg){return MessagesService[msg]}}var TEMPLATE_PATH="manager/hire-team/team-productivity/team-productivity.tpl.html";return{restrict:"E",scope:{productivity:"="},controller:TeamProductivityController,controllerAs:"vm",replace:!0,templateUrl:routePrefix+TEMPLATE_PATH}}]),bandcampApp.directive("teamCandidates",["routePrefix",function(routePrefix){function TeamCandidatesCtrl($scope,$location,MarketplaceMembersService,InterviewsService,TimeUtils,CurrentUser,$q){function reset(){vm.candidates=[],vm.pagination={current:1},load()}function load(){if(!vm.loading&&!vm.pagination.last){vm.loading=!0;var promise=MarketplaceMembersService.simpleMatches({jobId:vm.job.id,page:vm.pagination.current-1,sortBy:vm.sortBy}).$promise;return promise.then(function(res){_.isEmpty(res.content)||(vm.candidates=vm.candidates.concat(res.content),vm.pagination.current++),vm.pagination.last=res.last,vm.pagination.total=res.totalElements})["finally"](function(){vm.loading=!1}),promise}}function interview(marketplaceMember){InterviewsService.checkAvailable(marketplaceMember.application.candidate)?$location.path("/interview/schedule/"+marketplaceMember.id):MarketplaceMembersService.availabilityModal(marketplaceMember,"INTERVIEW")}var vm=this;vm.load=load,vm.interview=interview,vm.reset=reset,vm.formatOffset=TimeUtils.formatUtcOffset,vm.sortBy="AVERAGE_SCORE",CurrentUser.get().$promise.then(function(user){vm.currentUser=user}),$scope.$watch("job",function(value,old){void 0!==value&&value!==old&&(vm.job=value,reset())}),vm.mpmApplicationView={open:function(marketplaceMember){$scope.selectedMember=marketplaceMember},switchMpm:function(dir){var deferred=$q.defer(),curr=$scope.selectedMember,i=_.findIndex(vm.candidates,function(cand){return cand.marketplaceMember.id===curr.id}),select=function(){$scope.selectedMember=vm.candidates[i+dir].marketplaceMember,deferred.resolve()};return vm.candidates[i+dir]?select():!vm.pagination.last&&dir>0&&load().then(select),deferred.promise},reject:function(){var id=_.findIndex(vm.candidates,function(c){return c.marketplaceMember.id===$scope.selectedMember.id});vm.candidates.splice(id,1),vm.pagination.total--}}}var TEMPLATE_PATH="manager/hire-team/team-candidates/team-candidates.tpl.html";return{restrict:"E",scope:{job:"="},templateUrl:routePrefix+TEMPLATE_PATH,controllerAs:"vm",controller:TeamCandidatesCtrl}}]),bandcampApp.directive("teamSidebar",["routePrefix","$timeout",function(routePrefix,$timeout){var TEMPLATE_PATH="manager/hire-team/team-sidebar/team-sidebar.tpl.html";return{restrict:"E",transclude:!0,scope:{show:"="},templateUrl:routePrefix+TEMPLATE_PATH,link:function(scope,element){var body=angular.element("body"),content=element.find(".sidebar-content");scope.hide=function(){scope.show=!1},content.click(function(event){event.stopPropagation()}),element.click(scope.hide),scope.$on("$routeChangeStart",scope.hide),angular.element(document).keyup(function(e){27===e.keyCode&&$timeout(scope.hide,0)}),scope.$watch("show",function(value){value===!0?body.addClass("overflowAllh"):body.removeClass("overflowAllh")})}}}]),bandcampApp.directive("launchWorkflow",["WorkflowsService",function(WorkflowsService){return{restrict:"AE",scope:{},controller:function(){this.init=function(){WorkflowsService.openModal("manager/workflows/workflow-project-setup.tpl.html","WorkflowProjectSetupCtrl")}},link:function(scope,element,attrs,ctrl){element.click(ctrl.init)}}}]),ctrls.controller("WorkflowServerSetupCtrl",["$uibModalInstance","WorkflowServerService","WorkflowsService",function($uibModalInstance,WorkflowServerService,WorkflowsService){function submit(){vm.error=null,vm.loading=!0,vm.workflowServer.name=vm.workflowServer.url,WorkflowServerService.save(vm.workflowServer).$promise.then(function(res){vm.modalInstance.close(),WorkflowsService.openModal("manager/workflows/workflow-project-setup.tpl.html","WorkflowProjectSetupCtrl",{workflowJiraServer:function(){return res}})})["catch"](function(err){vm.error=err.data,vm.loading=!1})}var vm=this;vm.modalInstance=$uibModalInstance,vm.workflowServer={},vm.submit=submit}]),ctrls.controller("WorkflowProjectSetupCtrl",["$uibModalInstance","WorkflowServerService","WorkflowProjectService","WorkflowsService","TeamService","$location",function($uibModalInstance,WorkflowServerService,WorkflowProjectService,WorkflowsService,TeamService,$location){function loadProjects(workflowJiraServer){vm.workflowProject.data={workflowJiraServer:{id:workflowJiraServer.id}},WorkflowProjectService.query({workflowServerId:workflowJiraServer.id}).$promise.then(function(res){vm.workflowProject.projects=res})["catch"](function(err){vm.error=err.data})["finally"](function(){vm.loading=!1})}var vm=this;vm.modalInstance=$uibModalInstance,vm.workflowProject={type:"new",data:{}},vm.init=function(){vm.loading=!0,WorkflowServerService.query().$promise.then(function(res){loadProjects(_.first(res))})},vm.init(),vm.valid=function(){switch(vm.workflowProject.type){case"new":return vm.workflowProject.data.jiraName;case"existing":return vm.workflowProject.data.jiraId}},vm.submit=function(){vm.error=null,vm.loading=!0;var data=angular.copy(vm.workflowProject.data);switch(vm.workflowProject.type){case"new":delete data.jiraId;break;case"existing":delete data.jiraName}TeamService.setWorkflowProject({id:$location.search().teamId},data).$promise.then(function(){vm.modalInstance.close(),WorkflowsService.openModal("manager/workflows/workflow-users-setup.tpl.html","WorkflowUsersSetupCtrl",{workflowProject:function(){return vm.workflowProject}})})["catch"](function(err){vm.error=err.data,vm.loading=!1})}}]),ctrls.controller("WorkflowUsersSetupCtrl",["$uibModalInstance","AssignmentService","WorkflowUserService","$location","$q","workflowProject","WorkflowsService",function($uibModalInstance,AssignmentService,WorkflowUserService,$location,$q,workflowProject,WorkflowsService){function removeAlreadyMappedUsers(jiraUsers,assignment){return vm.workflowUsers.team.assignments.forEach(function(asg){jiraUsers.forEach(function(u,i){asg.jira.selected&&asg.jira.selected.userName&&u.userName===asg.jira.selected.userName&&asg.id!==assignment.id&&jiraUsers.splice(i,1)})}),jiraUsers}var vm=this;vm.modalInstance=$uibModalInstance,vm.workflowProject=workflowProject||{},vm.workflowUsers={team:{id:$location.search().teamId,assignments:[],newAccounts:0}},vm.init=function(){vm.workflowUsers.team.id&&(vm.loading=!0,AssignmentService.list({teamId:vm.workflowUsers.team.id,status:"ACTIVE,MANAGER_SETUP"}).$promise.then(function(res){vm.workflowUsers.team.assignments=res.content||[]})["catch"](function(err){vm.error=err.data})["finally"](function(){vm.loading=!1}))},vm.init(),vm.getJiraUsersDebounce=_.debounce(function(search,asg){vm.error=null,search&&(search=search.replace(/^[0-9]+|[^a-zA-Z0-9\.]/g,""),WorkflowUserService.query({search:search,teamId:vm.workflowUsers.team.id}).$promise.then(function(res){asg.jira.alreadyMapped=!1,asg.jira.users=res||[];var exists=asg.jira.users.some(function(u){return u.userName===search});exists||asg.jira.users.unshift({userName:search,isNew:!0}),asg.jira.users=removeAlreadyMappedUsers(asg.jira.users,asg),asg.jira.users.length||(asg.jira.alreadyMapped=!0)})["catch"](function(err){vm.error=err.data})["finally"](function(){vm.loading=!1}))},400),vm.getJiraUsers=function(search,asg){asg.jira.users=[],asg.jira.alreadyMapped=!1,vm.getJiraUsersDebounce(search,asg)},vm.countNewUsers=function(){vm.workflowUsers.team.newAccounts=0,vm.workflowUsers.team.assignments.forEach(function(asg){asg.jira.selected&&asg.jira.selected.isNew&&vm.workflowUsers.team.newAccounts++})},vm.valid=function(){return vm.workflowUsers.team.assignments.some(function(asg){return angular.isUndefined(asg.jira.selected)})},vm.submit=function(){var promises=[];vm.error=null,vm.loading=!0,vm.workflowUsers.team.assignments.forEach(function(asg){promises.push(WorkflowUserService.save({username:asg.jira.selected.userName,assignmentId:asg.id},{}).$promise)}),$q.all(promises).then(function(){vm.modalInstance.close(),"new"===vm.workflowProject.type?WorkflowsService.openModal("manager/workflows/workflow-scheme-setup.tpl.html","WorkflowSchemeSetupCtrl"):WorkflowsService.openFinishModal()})["catch"](function(err){vm.error=err.data})["finally"](function(){vm.loading=!1})}}]),ctrls.controller("WorkflowSchemeSetupCtrl",["$location","$uibModalInstance","WorkflowSchemeService","WorkflowsService",function($location,$uibModalInstance,WorkflowSchemeService,WorkflowsService){function next(){vm.modalInstance.close(),WorkflowsService.openFinishModal()}var vm=this;vm.loading=!0,vm.modalInstance=$uibModalInstance,vm.next=next,WorkflowSchemeService.setup({teamId:$location.search().teamId}).$promise.then(function(res){vm.url=res.url})["finally"](function(){vm.loading=!1})}]),ctrls.controller("WorkflowWizardFinishCtrl",["$uibModalInstance",function($uibModalInstance){var vm=this;vm.modalInstance=$uibModalInstance}]),bandcampApp.directive("jiraUsersUiSelect",function($timeout,$window){return{require:"uiSelect",link:function(scope,element,attrs,$select){function close(){$select.open&&$timeout(function(){$select.close()})}var parent=element.parents("fieldset");parent.bind("scroll",close),angular.element($window).bind("resize",close)}}}),bandcampApp.directive("workflowSetupStatus",["routePrefix",function(routePrefix){return{restrict:"AE",replace:!0,templateUrl:routePrefix+"manager/workflows/workflow-setup-status/workflow-setup-status.tpl.html",scope:{step:"="},controllerAs:"vm",controller:function(){this.steps=["Select your Project","Create or map JIRA accounts","Import JIRA Workflow for your team"]}}}]),bandcampApp.directive("workflowModalWrapper",["routePrefix",function(routePrefix){return{restrict:"AE",transclude:!0,scope:{modalInstance:"=",step:"@"},templateUrl:routePrefix+"manager/workflows/workflow-modal-wrapper/workflow-modal-wrapper.tpl.html"}}]),bandcampApp.directive("launchWorkflowApp",["$compile",function($compile){return{restrict:"AE",scope:{},link:function(scope,element){var body=angular.element("body"),modal='<workflow-app-modal show="show"></workflow-app-modal>';body.append($compile(modal)(scope)),element.click(function(){scope.show=!0})}}}]),bandcampApp.directive("workflowAppModal",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"manager/workflows/workflow-app-modal/workflow-app-modal.tpl.html",scope:{show:"="}}}]),bandcampApp.directive("workflowAppContainer",["$q","routePrefix","$location","$filter","CurrentUser","TeamService","WorkflowTeamGoalsService","$window",function($q,routePrefix,$location,$filter,CurrentUser,TeamService,WorkflowTeamGoalsService,$window){return{restrict:"E",templateUrl:routePrefix+"manager/workflows/workflow-app-container/workflow-app-container.tpl.html",controllerAs:"vm",controller:function($uibModal){function init(){CurrentUser.get().$promise.then(function(user){vm.data.cu=user;var manager=_.find(user.userAvatars,function(a){return"MANAGER"===a.type});manager&&(vm.data.team.managerId=manager.id),$q.all([serviceGetXOStatusMappings(),serviceGetWorkflowStatistics(),serviceGetWipGoal()]).then(function(){createUiColumns()})["catch"](function(err){vm.error=err.data})["finally"](function(){vm.UI.loading=!1})})}function serviceGetXOStatusMappings(){return TeamService.getXOStatusMappings({id:vm.data.team.id}).$promise.then(function(data){return createHeaderUiColumns(data),data})}function serviceGetWorkflowStatistics(){return TeamService.getWorkflowStatistics({id:vm.data.team.id,managerId:vm.data.team.managerId}).$promise.then(function(data){return vm.data.team.statistics=data?data.workflowAssignmentStatistics:[],data})}function serviceGetWipGoal(){return WorkflowTeamGoalsService.get({id:vm.data.team.id}).$promise.then(function(data){return vm.data.team.wipGoal=data.wipPerPerson||0,data})}function createHeaderUiColumns(data){var workingCols=$filter("filter")(data,{workflowState:{name:"Working"}});workingCols.forEach(function(col){vm.data.team.workingColumns.push(col.jiraStatusName),vm.data.team.headerUiColumns.push({name:col.jiraStatusName,count:0})})}function createUiColumns(){vm.data.team.statistics.forEach(function(statistic){var preWorkCount=0,preWorkJiraUrl=null;statistic.uiColumns=[],statistic.wipMarkerValue=0,statistic.workflowStatusGroupStatistics.forEach(function(groupStat){"Pre-Work"===groupStat.status?(preWorkCount=groupStat.count,preWorkJiraUrl=groupStat.jiraUrl||null):statistic.wipMarkerValue=groupStat.count}),vm.data.team.headerUiColumns.forEach(function(hCol){var newColumn={name:hCol.name,count:0,jiraUrl:null};if(vm.data.team.workingColumns.indexOf(hCol.name)!==-1){var asgCol=_.find(statistic.workflowStatusStatistics,function(stat){return stat.status===hCol.name});asgCol&&(newColumn.count=asgCol.count,newColumn.jiraUrl=asgCol.jiraUrl,hCol.count+=asgCol.count)}else newColumn.count=preWorkCount,newColumn.jiraUrl=preWorkJiraUrl,hCol.count+=preWorkCount;statistic.uiColumns.push(newColumn)})})}function getWipMarkerClass(value){return value>=vm.data.team.wipGoal+vm.data.team.wipGoalLimit?"up":value<=vm.data.team.wipGoal-vm.data.team.wipGoalLimit?"down":"ok"}function sort(index){vm.data.sortByIndex!==index?(vm.data.sortByIndex=index,vm.data.sortBy=function(statistic){return statistic.uiColumns[index].count},vm.data.sortDir=!0):vm.data.sortDir=!vm.data.sortDir}function openSettingsModal(){$uibModal.open({templateUrl:routePrefix+"manager/workflows/workflow-settings/workflow-settings.tpl.html",controller:"WorkflowSettingsCtrl",controllerAs:"vm",windowClass:"workflow-settings-modal",backdrop:!1})}function openUrl(url){$window.open(url,"_blank")}var vm=this;vm.openSettingsModal=openSettingsModal,vm.getWipMarkerClass=getWipMarkerClass,vm.sort=sort,vm.openUrl=openUrl,vm.data={team:{id:$location.search().teamId,managerId:null,wipGoal:0,wipGoalLimit:2,statistics:[],workingColumns:[],headerUiColumns:[{name:"Pre-Work",count:0}]},sortBy:"assignment.selection.marketplaceMember.application.candidate.printableName",sortByIndex:null,sortDir:!1},vm.UI={loading:!0},init()}}}]),ctrls.controller("WorkflowSettingsCtrl",["$q","$routeParams","$uibModalInstance","TeamService","WorkflowStatusService","WorkflowTeamGoalsService","TimeUtils",function($q,$routeParams,$uibModalInstance,TeamService,WorkflowStatusService,WorkflowTeamGoalsService,TimeUtils){function init(){$q.all([getAvailableStates(),getXoStates(),getXoMappedStates(),getTeamGoals()]).then(function(){vm.states.preWork.forEach(function(stName){removeMappedStateFromAvailableStates(stName)}),vm.states.working.forEach(function(stName){removeMappedStateFromAvailableStates(stName)}),vm.states.done.forEach(function(stName){removeMappedStateFromAvailableStates(stName)})})["catch"](function(err){vm.UI.error=err.data})["finally"](function(){vm.UI.loading=!1})}function getAvailableStates(){return TeamService.get({id:$routeParams.teamId}).$promise.then(function(team){return WorkflowStatusService.query({id:team.workflowJiraProject.id}).$promise.then(function(data){return vm.states.available=data,data})})}function getXoStates(){return WorkflowStatusService.getXOStatuses().$promise.then(function(data){return vm.xoStates=data,data})}function getXoMappedStates(){return TeamService.getXOStatusMappings({id:$routeParams.teamId}).$promise.then(function(data){return data.forEach(function(mapping){"Pre-Work"===mapping.workflowState.name?vm.states.preWork.push(mapping.jiraStatusName):"Working"===mapping.workflowState.name?vm.states.working.push(mapping.jiraStatusName):"Done"===mapping.workflowState.name&&vm.states.done.push(mapping.jiraStatusName)}),data})}function getTeamGoals(){return WorkflowTeamGoalsService.get({id:$routeParams.teamId}).$promise.then(function(data){vm.goals={leadTime:TimeUtils.convertToDays(data.leadTime),maxTimeInState:TimeUtils.convertToDays(data.maxTimeInState),expectedOutput:data.expectedOutput||0,wipPerPerson:data.wipPerPerson||0}})}function removeMappedStateFromAvailableStates(stName){vm.states.available.splice(vm.states.available.indexOf(stName),1)}function validateMappedStates(){var error=[];return vm.UI.error=null,vm.states.preWork.length||error.push("PreWork"),vm.states.working.length||error.push("WIP"),vm.states.done.length||error.push("Done"),!error.length||(vm.UI.error={text:"Please select at least one jira state under ["+error.join("/")+"] state."},!1)}function save(){if(validateMappedStates()){var params=[],populateParams=function(stName,stOrder,xoState){params.push({jiraStatusName:stName,sequenceNumber:stOrder+1,workflowState:{id:xoState.id,name:xoState.name}})},goals={leadTime:TimeUtils.convertToHours(vm.goals.leadTime),maxTimeInState:TimeUtils.convertToHours(vm.goals.maxTimeInState),expectedOutput:vm.goals.expectedOutput,wipPerPerson:vm.goals.wipPerPerson,team:{id:$routeParams.teamId}};vm.xoStates.forEach(function(xoState){"Pre-Work"===xoState.name?vm.states.preWork.forEach(function(stName,stOrder){populateParams(stName,stOrder,xoState)}):"Working"===xoState.name?vm.states.working.forEach(function(stName,stOrder){populateParams(stName,stOrder,xoState)}):"Done"===xoState.name&&vm.states.done.forEach(function(stName,stOrder){populateParams(stName,stOrder,xoState)})}),$q.all([TeamService.setXOStatusMappings({id:$routeParams.teamId},params).$promise,WorkflowTeamGoalsService.update({id:$routeParams.teamId},goals).$promise]).then(function(){vm.modalInstance.dismiss()})["catch"](function(err){vm.UI.error=err.data})}}var vm=this;vm.modalInstance=$uibModalInstance,vm.save=save,vm.states={available:[],preWork:[],working:[],done:[]},vm.UI={loading:!0},init(),vm.dragSettings={accept:function(sourceHandle,sortableScope){return sourceHandle.sortableScope.element[0]!==sortableScope.element[0]}}}]),bandcampApp.filter("jiraStatusName",function(){return function(input){var parts=input.toUpperCase().split(" ");return parts.length>1?parts.map(_.first).join(""):parts[0].substr(0,3)}}),ctrls.controller("ManagerTrainingCtrl",["$scope","TeamService","AssignmentService","$routeParams","Flash",function($scope,TeamService,AssignmentService,$routeParams,Flash){$scope.started=!1,$scope.assignment=!1,$scope.data={},AssignmentService.get({id:$routeParams.assignmentId},function(a){$scope.data.id=$routeParams.assignmentId,$scope.assignment={contract:a,selection:a.selection,job:a.selection.marketplaceMember.application.job,member:a.selection.marketplaceMember,user:a.selection.marketplaceMember.application.candidate}},function(){}),$scope.teams=TeamService.query({avatarType:"MANAGER"});var getUI=function(){return{current:1}};$scope.UI=getUI(),$scope.finish=function(){var x=angular.copy($scope.data);x.status="MANAGER_SETUP",$scope.started=!0,AssignmentService.managerSetupTeam({id:x.id},x.team,function(){var uri="/manager/dashboard/team",jobName=$scope.assignment.job.title;Flash.addSuccess("Onboarding finished for "+jobName,uri)},function(e){$scope.UI.message="Error, "+e.data.text,$scope.UI.clazz="warning",$scope.started=!1})};var sel=function(x){var u=$scope.UI,n=x+u.current;n<1||n>2||($scope.UI.current=n)};sel(0),$scope.inc=function(){sel(1)},$scope.dec=function(){sel(-1)}}]),ctrls.controller("ContractorFindWorkCtrl",["$scope","JobService","$rootScope","CurrentUser",function($scope,JobService,$rootScope,CurrentUser){$scope.started=!1,JobService.crud.query({avatarType:"CANDIDATE"},function(data){$scope.jobs=data,$scope.started=!0}),$rootScope.isUserLoggedIn()&&($scope.userLoggedIn=!0,CurrentUser.get(function(data){$scope.isCandidateLoggedIn=data.avatarTypes.indexOf("CANDIDATE")>-1})),$scope.getJobUrl=function(job){return $scope.userLoggedIn&&!$scope.isCandidateLoggedIn?"job/"+job.id+"/details":"redirect/job/"+job.id}}]),ctrls.controller("MyJobsCtrl",["$scope","AssignmentService",function($scope,AssignmentService){$scope.page=0,$scope.UI={clicked:!1,noJobs:!1,jobs:!1},$scope.playVideo=function(){$scope.UI.clicked=!0};var update=function(){AssignmentService.get({page:$scope.page,avatarType:"CANDIDATE"},function(data){if(!angular.isObject(data)||!angular.isDefined(data.content))return void($scope.UI.noJobs=!0);var j=data.content.map(function(e){return e.user=e.selection.marketplaceMember,e.application=e.user.application,e.job=e.application.job,e.active="ACTIVE"===e.status,e.order=e.active?0:e.id,e}).filter(function(job){return"CANCELLED"===job.status||"COMPLETED"===job.status||"ACTIVE"===job.status||"TERMINATED"===job.status}).sort(function(a,b){return a.order-b.order});$scope.jobs=j,angular.isArray(j)&&j.length>0?$scope.UI.jobs=!0:$scope.UI.noJobs=!0})};update()}]),ctrls.controller("AvailableJobsCtrl",["$scope","JobService","$rootScope","CurrentUser","$location","$routeParams","$q","$filter",function($scope,JobService,$rootScope,CurrentUser,$location,$routeParams,$q,$filter){var vm=this;$scope.vm={},$scope.data={jobs:[],jobLabels:null,selectedJobLabel:null,searchTxt:null,currentFilter:{page:0},userCriteriaResults:[],visitor:!0},$scope.UI={isLoading:!0,showMoreRecords:!0},vm.init=function(){JobService.crud.labels().$promise.then(function(data){$scope.data.jobLabels=data,$routeParams.label&&($scope.data.selectedJobLabel=$scope.getJobLabelById($routeParams.label)),$routeParams.title&&($scope.data.searchTxt=$routeParams.title),$rootScope.showFooter=$rootScope.isUserLoggedIn()}),$rootScope.isUserLoggedIn()&&($scope.userLoggedIn=!0,CurrentUser.get().$promise.then(function(data){$scope.isCandidateLoggedIn=data.avatarTypes.indexOf("CANDIDATE")>-1}))},vm.init(),$scope.getJobLabelById=function(id){return _.find($scope.data.jobLabels,function(label){return label.id===parseInt(id)})},vm.loadJobs=function(){var secondFilter,promises=[];$scope.UI.isLoading=!0,promises.push(JobService.crud.findMatchingJobs($scope.data.currentFilter).$promise),$scope.data.currentFilter.label&&(secondFilter=angular.copy($scope.data.currentFilter),delete secondFilter.label,promises.push(JobService.crud.findMatchingJobs(secondFilter).$promise)),$q.all(promises).then(function(data){$scope.data.userCriteriaResults=$scope.data.userCriteriaResults.concat(data[0]);var allData=$filter("unique")(data[0].concat(data[1]||[]),"id");$scope.data.jobs=$filter("unique")($scope.data.jobs.concat(allData),"id"),$scope.UI.showMoreRecords=allData.length>=25,$scope.UI.isLoading=!1})},$scope.applyFilter=function(){$scope.data.searchTxt?$scope.data.currentFilter.title=angular.copy($scope.data.searchTxt):delete $scope.data.currentFilter.title,$scope.data.selectedJobLabel&&""!==$scope.data.selectedJobLabel.id?$scope.data.currentFilter.label=$scope.data.selectedJobLabel.id:delete $scope.data.currentFilter.label,$scope.data.currentFilter.page=0,$location.search("title",$scope.data.currentFilter.title),$location.search("label",$scope.data.currentFilter.label),$scope.data.userCriteriaResults=$scope.data.jobs=[],vm.loadJobs()},$scope.filterReset=function(){$scope.data.searchTxt=$scope.data.selectedJobLabel=null,$scope.UI.showMoreRecords=!0,$scope.applyFilter()},$scope.filterResetKeyword=function(){$scope.data.searchTxt=null,$scope.UI.showMoreRecords=!0,$scope.applyFilter()},$scope.checkIfJobIsNew=function(timestamp){if(timestamp){var timeDiff=Math.abs((new Date).getTime()-new Date(timestamp).getTime()),diffDays=Math.ceil(timeDiff/864e5);return diffDays<=7}return!1},$scope.vm.showMoreRecords=function(){!$scope.UI.isLoading&&$scope.UI.showMoreRecords&&($scope.data.currentFilter.page+=1,vm.loadJobs())},$scope.allowSearch=function(){return!!$scope.data.searchTxt&&$scope.data.searchTxt.length>=2},$scope.getJobUrl=function(job){return $scope.userLoggedIn&&!$scope.isCandidateLoggedIn?"job/"+job.id+"/details":"redirect/job/"+job.id}}]),ctrls.controller("MigratedJobCtrl",["$scope","CurrentUser","MigratedUserService","$location","AssignmentService",function($scope,CurrentUser,MigratedUserService,$location,AssignmentService){$scope.msg={},CurrentUser.clearCache(),CurrentUser.get(function(e){$scope.user=e,$location.path(MigratedUserService.nextStep(e))}),$scope.loading=!1,AssignmentService.get(function(e){if($scope.assignments=e,angular.isArray(e.content)&&e.content.length>0){var d=e.content[0];$scope.selection=d.selection,$scope.job=d.selection.marketplaceMember.application.job,delete d.selection,
$scope.assignment=d}else $scope.msg={klass:"alert alert-warning",show:!0,text:"No assignments found."}},function(e){$scope.msg={klass:"alert alert-warning",show:!0,text:e.data.text}}),$scope.apply=function(){$scope.loading=!0,MigratedUserService.users.edit({id:$scope.user.id,type:"MIGRATED_CANDIDATE",status:"JOB_OFFER_ACCEPTED"},function(){$location.path("/migrated/outline")},function(e){$scope.loading=!1,$scope.msg={klass:"alert alert-warning",show:!0,text:e.data.text}})}}]),ctrls.controller("MigratedExpectationsCtrl",["$scope","MigratedUserService","AssignmentService","CurrentUser","$location",function($scope,MigratedUserService,AssignmentService,CurrentUser,$location){CurrentUser.clearCache(),CurrentUser.get(function(e){$scope.user=e}),AssignmentService.get(function(e){if($scope.assignments=e,angular.isArray(e.content)&&e.content.length>0){var d=e.content[0];$scope.selection=d.selection,$scope.job=d.selection.marketplaceMember.application.job;var img=$scope.job.imageUrl;img?img="https://s3.amazonaws.com/"+img:$scope.job.imageUrl="images/jobs/85edd4df.sample.jpg"}else $scope.msg={klass:"alert alert-warning",show:!0,text:"No assignments found."}},function(e){$scope.msg={klass:"alert alert-warning",show:!0,text:e.data.text}}),$scope.next=function(){$location.path("/migrated/terms")}}]),ctrls.controller("MigratedPasswordCtrl",["$scope","CurrentUser","MigratedUserService","$location","AuthenticationFactory","$rootScope","$window","EnumsService",function($scope,CurrentUser,MigratedUserService,$location,AuthenticationFactory,$rootScope,$window,EnumsService){$scope.msg={},CurrentUser.clearCache(),$scope.data={},$scope.loading=!0,EnumsService.get(function(data){$scope.enums=data,CurrentUser.get(function(e){$scope.user=e,$location.path(MigratedUserService.nextStep(e)),$scope.loading=!1})}),$scope.data={password:{},question:{oldAnswer:"notreallyimportanthere"}},$scope.submit=function(){angular.isObject($scope.data)&&($scope.loading=!0,CurrentUser.updateSecurityQuestion($scope.data.question,function(){CurrentUser.updatePassword($scope.data.password,function(){AuthenticationFactory.login($scope.user.email,$scope.data.password.newPassword).then(function(res){var authToken=res.data.token,i=$scope.user.avatarTypes;for($rootScope.setAuthToken(authToken);i--;)switch($scope.user.avatarTypes[i]){case"MIGRATED_CANDIDATE":MigratedUserService.users.edit({id:$scope.user.id,status:"PASSWORD_CHANGED",type:"MIGRATED_CANDIDATE"},function(user){$location.path(MigratedUserService.nextStep(user))},function(cannotEditContractor){$scope.msg={show:!0,klass:"alert alert-warning",text:cannotEditContractor.data.text}});break;case"MIGRATED_MANAGER":MigratedUserService.managers.edit({id:$scope.user.id,status:"PASSWORD_CHANGED",type:"MIGRATED_MANAGER"},function(user){$location.path(MigratedUserService.nextStep(user))},function(cannotEditManager){$scope.msg={show:!0,klass:"alert alert-warning",text:cannotEditManager.data.text}})}})},function(cannotUpdatePassword){$scope.loading=!1,$scope.msg={show:!0,klass:"alert alert-warning",text:cannotUpdatePassword.data.text}})},function(cannotUpdateQuestion){$scope.loading=!1,$scope.msg={show:!0,klass:"alert alert-warning",text:cannotUpdateQuestion.data.text}}))}}]),ctrls.controller("MigratedPayoneerCtrl",["$scope","PaymentDestinationsService","$window","$location","$timeout","CurrentUser","MigratedUserService","$uibModal",function($scope,PaymentDestinationsService,$window,$location,$timeout,CurrentUser,MigratedUserService,$uibModal){$scope.data={payoneerUrl:null},$scope.ui={isLoading:!0},$scope.msg={show:!1,klass:"alert",text:""};var modalInstance=null,setMessage=function(klass,message){$scope.msg={show:!0,klass:"alert "+klass,text:message}};$scope.createRequest=function(){PaymentDestinationsService.save({type:"PAYONEER"},function(data){$scope.ui.isLoading=!1,$scope.data.payoneerUrl=data.redirect,$timeout(function(){window.location=data.redirect})},function(response){$scope.ui.isLoading=!1;var message="Could not initiate connection to Payoneer."+response.data.text;setMessage("alert-warning",message)})},$scope.skipModal=function(){modalInstance=$uibModal.open({templateUrl:"skip-payoneer.tpl.html",scope:$scope})},$scope.closeModal=function(){modalInstance&&modalInstance.dismiss("close")},$scope.next=function(){$scope.closeModal(),$scope.ui.isLoading=!0,MigratedUserService.users.edit({id:$scope.user.id,type:"MIGRATED_CANDIDATE",status:"PAYONEER_SETUP"},function(){CurrentUser.clearCache(),$scope.updateUser(),$location.path("migrated/worksmart")},function(e){setMessage("alert-warning",e.data.text),$scope.ui.isLoading=!1})},$scope.updateStatus=function(){$scope.ui.isLoading=!0,CurrentUser.clearCache(),CurrentUser.get(function(e){$scope.user=e,$location.path(MigratedUserService.nextStep(e)),PaymentDestinationsService.query({},function(data){var payoneerActive=data.reduce(function(ret,x){return ret||"PAYONEER"===x.kind&&"ACTIVE"===x.status},!1),payoneerPresent=data.reduce(function(ret,x){return ret||"PAYONEER"===x.kind},!1);payoneerActive?$scope.next():payoneerPresent&&!payoneerActive?setMessage("alert-info","You must finish payoneer registration first."):$scope.ui.isLoading=!1},function(response){setMessage("alert-warning",response.data.text),$scope.ui.isLoading=!1})})},$scope.updateStatus()}]),ctrls.controller("MigratedProductivityCtrl",["$scope","$uibModal",function($scope,$uibModal){var modalInstance=null;$scope.openModal=function(){modalInstance=$uibModal.open({templateUrl:"tracker-info.tpl.html",scope:$scope})},$scope.closeModal=function(){modalInstance&&modalInstance.dismiss("close")}}]),ctrls.controller("MigratedSuccessCtrl",["$scope","CurrentUser","MigratedUserService","$location",function($scope,CurrentUser,MigratedUserService,$location){CurrentUser.clearCache(),CurrentUser.get(function(e){$scope.user=e,$location.path(MigratedUserService.nextStep(e))})}]),ctrls.controller("MigratedTermsCtrl",["$scope","$location","baseUrl","uploadedDocsUrl","CurrentUser","MigratedUserService",function($scope,$location,baseUrl,uploadedDocsUrl,CurrentUser,MigratedUserService){$scope.ui={isLoading:!0},$scope.agreement=uploadedDocsUrl+"/documents/agreement.md",$scope.companyTermsUrl="",CurrentUser.clearCache(),CurrentUser.get(function(e){$scope.user=e,$location.path(MigratedUserService.nextStep(e))}),$scope.finishLoading=function(){$scope.ui.isLoading=!1},$scope.next=function(){$scope.showMessage=!0,$scope.accepted?($scope.ui.isLoading=!0,MigratedUserService.users.edit({id:$scope.user.id,status:"AGREEMENT_ACCEPTED",type:"MIGRATED_CANDIDATE"},function(user){$scope.ui.isLoading=!1,$location.path(MigratedUserService.nextStep(user))})):($scope.message="You have to accept the agreement before you can continue.",$scope.messageClass="alert alert-danger")}}]),ctrls.controller("NotificationListCtrl",[function(){}]),ctrls.controller("OnboardAgreementCtrl",["$scope","$location","uploadedDocsUrl",function($scope,$location,uploadedDocsUrl){$scope.ui={isLoading:!0},$scope.agreement=uploadedDocsUrl+"/documents/agreement.md",$scope.next=function(){$scope.accepted&&($scope.ui.isLoading=!0,$location.path("/worksmart"))}}]),ctrls.controller("OnboardPayoneerCtrl",["$scope","PaymentDestinationsService","$window","$location","$timeout",function($scope,PaymentDestinationsService,$window,$location,$timeout){$scope.data={payoneerUrl:null},$scope.ui={isLoading:!0},$scope.msg={show:!1,klass:"alert",text:""};var setMessage=function(klass,message){$scope.msg={show:!0,klass:"alert "+klass,text:message}};$scope.createRequest=function(){$scope.ui.isLoading=!0,PaymentDestinationsService.save({type:"PAYONEER"},function(data){$scope.ui.isLoading=!1,$scope.data.payoneerUrl=data.redirect,$timeout(function(){window.location=data.redirect})},function(response){$scope.ui.isLoading=!1,setMessage("alert-warning",response.data.text)})},$scope.updateStatus=function(){$scope.ui.isLoading=!0,PaymentDestinationsService.query({},function(data){var payoneerActive=data.reduce(function(ret,x){return ret||"PAYONEER"===x.kind&&"ACTIVE"===x.status},!1),payoneerPresent=data.reduce(function(ret,x){return ret||"PAYONEER"===x.kind},!1);if(payoneerActive){var urlNext="/candidate/dashboard/hiring";$location.path(urlNext)}else payoneerPresent&&!payoneerActive?(setMessage("alert-info","You must finish payoneer registration first."),$scope.ui.isLoading=!1):$scope.ui.isLoading=!1},function(response){setMessage("alert-warning",response.data.text),$scope.ui.isLoading=!1})},$scope.updateStatus()}]),ctrls.controller("OnboardTrainingCtrl",["$scope","TrainingService",function($scope,TrainingService){TrainingService.query(function(data){function chunk(array,chunkSize){return[].concat.apply([],array.map(function(elem,i){return i%chunkSize?[]:[array.slice(i,i+chunkSize)]}))}$scope.videoIds=data,$scope.featured=null;for(var i=0;i<data.length;i++)if(data[i].featured){$scope.featured=data[i];break}null===$scope.featured&&data.length>0&&($scope.featured=data[0]),$scope.slides=chunk($scope.videoIds,4)})}]),ctrls.controller("PasswordCtrl",["$scope","$routeParams","PasswordResetFactory","$location",function($scope,$routeParams,PasswordResetFactory,$location){this.token=$routeParams.token,$scope.invalidRequest=!1,$scope.ui={isLoading:!1},$scope.retrievePasswordToken=function(email){email&&($scope.invalidRequest=!1,$scope.ui.isLoading=!0,PasswordResetFactory.assignToken({email:email},function(){$location.path("/reset/confirm-password")},function(data){$scope.reason=data.data.text,$scope.invalidRequest=!0}).$promise["finally"](function(){$scope.ui.isLoading=!1}))}}]),ctrls.controller("PasswordUpdateCtrl",["$scope","$routeParams","PasswordResetUpdateFactory","$location","Flash","$timeout","EnumsService",function($scope,$routeParams,PasswordResetUpdateFactory,$location,Flash,$timeout,EnumsService){$scope.data={},$scope.PASSWORD_REGEXP=/^(?=.*[^a-zA-Z])(?=.*[a-zA-Z]).{8,64}$/,$scope.invalidRequest=!1,$scope.user={passwordResetToken:$routeParams.passwordResetToken},$scope.enums=EnumsService.get(),$scope.errorMessage="",$scope.showForm=!0,$scope.updatePassword=function(userSecurity){if($scope.passwordUpdateForm.$valid){if(userSecurity.confirmPassword!==userSecurity.rawPassword)return $scope.invalidRequest=!0,void($scope.errorMessage="Passwords aren't equal");$scope.invalidRequest=!1;var updated={passwordResetToken:$routeParams.passwordResetToken,rawPassword:userSecurity.rawPassword};$scope.data.userSecurity&&($scope.data.customQuestion?updated.securityQuestion=$scope.data.customQuestion:updated.securityQuestion=$scope.data.userSecurity.securityQuestion,updated.securityQuestionAnswer=$scope.data.userSecurity.securityQuestionAnswer),PasswordResetUpdateFactory.update(updated,function(){$scope.showForm=!1,Flash.addSuccess("Password changed successfully!"),$scope.success=!0,$timeout(function(){$location.path("/login")},3e3)},function(err){$scope.invalidRequest=!0,$scope.errorMessage=err.data.text})}},PasswordResetUpdateFactory.show({passwordResetToken:$routeParams.passwordResetToken},function(userSecurity){$scope.userSecurity=userSecurity},function(err){$scope.invalidRequest=!0,$scope.errorMessage=err.data.text})}]),ctrls.controller("ProfileCtrl",["$scope","CandidatesService","CurrentUser","$uibModal","baseUrl","ProfileUtils","$upload","$routeParams","SelectionService","CountriesService","IndustriesService","MarketplaceMembersService","JobApplicationService","DownloadService","TechTrialApplicationService","ManagerService","GoogleLocationService","$location","InterviewsService","AssignmentService","$rootScope","highlight","ManagerNotesService","EnumsService","$sce","$q","skypeIdRegex",function($scope,CandidatesService,CurrentUser,$uibModal,baseUrl,ProfileUtils,$upload,$routeParams,SelectionService,CountriesService,IndustriesService,MarketplaceMembersService,JobApplicationService,DownloadService,TechTrialApplicationService,ManagerService,GoogleLocationService,$location,InterviewsService,AssignmentService,$rootScope,highlight,ManagerNotesService,EnumsService,$sce,$q,skypeIdRegex){function checkIsInterviewStatus(pageIndex){InterviewsService.list({avatarType:"MANAGER",candidateId:$scope.marketplaceMember.application.candidate.id,page:pageIndex},function(res){var interviews=res.content;if(interviews&&interviews.length>0){for(var currentInterviewSelectionStatusList="IN_PROGRESS|OFFERED|REINTERVIEW",j=0;j<interviews.length;++j)if(interviews[j].selection.marketplaceMember.id===$scope.marketplaceMember.id&&currentInterviewSelectionStatusList.indexOf(interviews[j].selection.status)>=0)return void($scope.marketplaceMember.currentInterview=!0);checkIsInterviewStatus(pageIndex+1)}})}function checkFileType(file){var fileExtension=/(?:\.([^.]+))?$/.exec(file.name)[1];return acceptableFileTypes.indexOf(fileExtension)>-1}function checkMatchedWithSaved(marketplaceMember){$scope.ui.isLoading=!0;var saved=$scope.myAvatar.savedCandidates||[];marketplaceMember.isSaved=saved.reduce(function(ret,sc){return ret||sc.id===marketplaceMember.id},!1);var candidate=marketplaceMember.application.candidate;candidate.realPhotoUrl=ProfileUtils.profilePhotoUrl(candidate),$scope.ui.isLoading=!1}var vm=this;$scope.data={countries:CountriesService.query(),industries:IndustriesService.query(),enums:EnumsService.get(),skypeIdRegex:new RegExp(skypeIdRegex,"i")},$scope.ui={startDatePicker:!1,endDatePicker:!1,isLoading:!0,resume:!1,coverLetter:!1,fromHireTeam:$location.search().hiring},$scope.today=new Date,$scope.parsePositions=function(){if($scope.currentPositions="",$scope.previousPositions="",$scope.profile.employments)for(var i=0;i<$scope.profile.employments.length;i++)$scope.profile.employments[i].current?$scope.currentPositions+=$scope.profile.employments[i].company+", ":$scope.previousPositions+=$scope.profile.employments[i].company+", ";$scope.currentPositions=$scope.currentPositions.substring(0,$scope.currentPositions.length-2),$scope.previousPositions=$scope.previousPositions.substring(0,$scope.previousPositions.length-2),$scope.getMainEducation()},$scope.getMainEducation=function(){$scope.profile.educations&&$scope.profile.educations.length>0?$scope.mainEducation=$scope.profile.educations[0]:$scope.mainEducation=""},$scope.downloadResume=function(url){DownloadService.downloadFile(url)},$rootScope.scrollToTop(),this.updateProfile=function(profile){$scope.profile=profile,$scope.profilePhotoUrl=ProfileUtils.profilePhotoUrl(profile),$scope.photoExists="/images/1f34682a.user.png"!==$scope.profilePhotoUrl,$scope.profile.languages&&angular.forEach($scope.profile.languages,function(language){angular.isDefined(language.proficiency)&&(language.proficiency=language.proficiency+"")})};var loadData=function(cb){angular.isDefined($routeParams.id)?MarketplaceMembersService.get({id:$routeParams.id},function(data){var q=$location.search().query;angular.isDefined(q)&&q.length>0&&(data=highlight(data,q)),$scope.marketplaceMember=data,AssignmentService.get({marketplaceMemberId:$scope.marketplaceMember.id},function(res){var assignments=res.content;if(assignments&&assignments.length>0)for(var i=0;i<assignments.length;++i)"PENDING"!==assignments[i].status&&"CANDIDATE_ACCEPTED"!==assignments[i].status&&"MANAGER_SETUP"!==assignments[i].status&&"PAYMENT_APPROVED"!==assignments[i].status&&"ACTIVE"!==assignments[i].status||($scope.marketplaceMember.currentAssignment=!0);$scope.marketplaceMember.currentAssignment||"ASSIGNED"!==$scope.marketplaceMember.status||($scope.marketplaceMember.alreadyHired=!0),cb&&cb($scope.marketplaceMember.currentAssignment)}),checkIsInterviewStatus(0),checkMatchedWithSaved($scope.marketplaceMember),$scope.application=data.application,updateDocuments(data.application),vm.updateProfile(data.application.candidate)}).$promise["finally"](function(){$scope.ui.isLoading=!1}):!angular.isDefined($routeParams.id)&&angular.isDefined($routeParams.appId)?JobApplicationService.get({id:$routeParams.appId,avatarType:$scope.avatarType}).$promise.then(function(data){$scope.application=data,updateDocuments(data),vm.updateProfile(data.candidate)})["finally"](function(){$scope.ui.isLoading=!1}):$scope.data.enums.$promise["finally"](function(){CurrentUser.clearCache(function(){$scope.myProfile=!0;var promises=[];$scope.editingProfile=angular.copy($scope.myAvatar),vm.updateProfile($scope.myAvatar),$scope.parsePositions(),promises.push(JobApplicationService.list({avatarType:$scope.avatarType},function(res){res.content&&($scope.data.editingApplications=[],res.content.forEach(function(app){app.resumeFile&&JobApplicationService.getFileUrl(app.id,app.resumeFile.id).success(function(url){app.resumeFile.signedUrl=url,$scope.data.editingApplications.push(angular.copy(app))})}),$scope.data.applications=res.content)}).$promise),$q.all(promises)["finally"](function(){$scope.ui.isLoading=!1;var c=$scope.data.countries.filter(function(x){return x.id===$scope.editingProfile.location.country.id})[0];$scope.data.filteredTimezones=c.timezones})})})};CurrentUser.get(function(data){$scope.me=data,angular.isDefined($routeParams.appId)||angular.isDefined($routeParams.id)?angular.isDefined($routeParams.id)&&(data.avatarTypes.indexOf("MANAGER")>=0||data.avatarTypes.indexOf("COMPANY_ADMIN")>=0)?($scope.isManagerUser=!0,$scope.avatarType="MANAGER"):(data.avatarTypes.indexOf("RECRUITER")>=0&&($scope.avatarType="RECRUITER"),data.avatarTypes.indexOf("RECRUITMENT_ANALYST")>=0&&($scope.avatarType="RECRUITMENT_ANALYST"),data.avatarTypes.indexOf("ACCOUNT_MANAGER")>=0&&($scope.avatarType="ACCOUNT_MANAGER"),data.avatarTypes.indexOf("ADMIN")>=0&&($scope.avatarType="ADMIN")):$scope.avatarType="CANDIDATE",CurrentUser.getAvatar({avatarType:$scope.avatarType},function(data){$scope.myAvatar=data,loadData()})}),$scope.isRejectedCandidate=function(mmId){if($scope.isManagerUser){var member=$scope.myAvatar.rejectedCandidates.filter(function(c){return c.id===mmId}).pop();return!!member}},$scope.getInterviewBlockerMessage=function(marketplaceMember){return marketplaceMember.currentAssignment?"This candidate already has an active or pending offer from you for this position.":marketplaceMember.currentInterview&&!marketplaceMember.currentAssignment?"This candidate already has an interview invitation from you for this position.":$scope.isRejectedCandidate(marketplaceMember.id)?"This candidate is in your rejected candidates list.":marketplaceMember.alreadyHired&&!marketplaceMember.currentAssignment?"This candidate already accepted another job offer.":null},$scope.getHiringBlockerMessage=function(marketplaceMember){return marketplaceMember.currentAssignment?"This candidate already has an active or pending offer from you for this position.":marketplaceMember.currentAssignment||marketplaceMember.alreadyHired||!marketplaceMember.currentInterview?$scope.isRejectedCandidate(marketplaceMember.id)?"This candidate is in your rejected candidates list.":marketplaceMember.alreadyHired&&!marketplaceMember.currentAssignment?"This candidate already accepted another job offer.":null:"You cannot hire this candidate as you are already in process of interviewing this candidate."},$scope.loadAssignmentAnswerLink=function(){var app=$scope.application;if(app||(app=$scope.marketplaceMember.application),app.rmtResult){$scope.ui.isLoading=!0;var applicationId=app.id;TechTrialApplicationService.getAssignmentAnswerLink(applicationId).success(function(answerlink){$scope.answerLink=$sce.trustAsResourceUrl(answerlink),$scope.ui.isLoading=!1})["finally"](function(){$scope.ui.isLoading=!1})}};var loadAssignmentDetails=function(){var app=$scope.application;if(angular.isDefined($scope.application))app=$scope.application;else{if(!angular.isDefined($scope.marketplaceMember.application))return;app=$scope.marketplaceMember.application}$scope.ui.isLoading=!0,TechTrialApplicationService.getAssignmentDetails(app.id).success(function(assignmentDetails){$scope.assignmentDetails=assignmentDetails,$scope.assignmentDetails.assignmentData=$sce.trustAsHtml($scope.assignmentDetails.assignmentData)})["finally"](function(){$scope.ui.isLoading=!1})},setFirstByLabel=function(arr,label){for(var i=0;i<arr.length;i++)if(arr[i].label===label){var elem=arr[i];arr.splice(i,1),arr.unshift(elem)}},updateDocuments=function(application){application.resumeFile&&JobApplicationService.getFileUrl(application.id,application.resumeFile.id).success(function(url){application.resumeFile.signedUrl=url}),application.files&&application.files.length>0&&(setFirstByLabel(application.files,"Covering Letter"),setFirstByLabel(application.files,"Resume")),angular.forEach(application.files||[],function(file){JobApplicationService.getFileUrl(application.id,file.id).success(function(url){file.signedUrl=url})}),application.evaluation=_.find(application.files,function(f){return"Assignment & Evaluation"===f.label}),application.evaluationAnswer=_.find(application.files,function(f){return"5Qs"===f.label}),application.files=_.without(application.files,application.evaluation,application.evaluationAnswer)},acceptableFileTypes=["pdf","md","doc","docx","xml","txt"];$scope.changeFile=function(file,app){file&&file[0]&&($scope.fileError="",checkFileType(file[0])?file[0].size>1048576?$scope.fileError="Resume file size exceeds 1 MB":(app.resumeFile.content=file,app.resumeFile.name=file[0].name,app.resumeFile.signedUrl=void 0,app.resumeFile.changed=!0):$scope.fileError="Resume file type is unsupported")},$scope.uploadFiles=function(){var promises=[];$scope.data.editingApplications.forEach(function(app){if(app.resumeFile.changed){$scope.ui.isFilesLoading=!0;var url=baseUrl+"/applications/"+app.id+"/files/"+app.resumeFile.id;promises.push($upload.upload({url:url,file:app.resumeFile.content,fileFormDataName:"file"}).success(function(res){app.resumeFile=res,_.find($scope.data.applications,function(appl){return appl.id===app.id}).resumeFile=angular.copy(res)}))}}),$q.all(promises)["finally"](function(){$scope.ui.isFilesLoading=!1,$scope.ui.showCandidateFiles=!1,$scope.fileError=""})},$scope.cancelFileUpdate=function(){$scope.data.editingApplications=angular.copy($scope.data.applications),$scope.fileError=""},$scope.evaluationModal=function(evaluationModalFile){DownloadService.download5QFile(evaluationModalFile.signedUrl).success(function(data){$scope.safeHtml=$sce.trustAsHtml((new TextDecoder).decode(new DataView(data))),$scope.Fiveq=!0,$scope.evalModal=$uibModal.open({templateUrl:"evaluation-modal.tpl.html",scope:$scope,backdrop:"static",windowClass:"modal-full-width"})})},$scope.assignmentModal=function(){$scope.assignmentDetails=loadAssignmentDetails(),$scope.evalModal=$uibModal.open({templateUrl:"assignment-modal.tpl.html",scope:$scope,backdrop:"static",windowClass:"modal-full-width"})},$scope.print=function(content){JobApplicationService.printDocument(content)},$scope.closeModal=function(modal){modal&&modal.dismiss()},$scope.updateProfile=function(data,callback){data.type="CANDIDATE",CandidatesService.update({id:$scope.profile.id},data).$promise.then(function(data){delete $scope.err,$scope.editingProfile=angular.copy(data),vm.updateProfile(data),CurrentUser.clearCache(),angular.isDefined(callback)&&callback()},function(err){$scope.err=err.data.text})},$scope.dateOptions={"year-format":'"yy"',"starting-day":1,"datepicker-mode":'"month"',"min-mode":"month"},$scope.openDatePicker=function($event,type,min,max){$event.preventDefault(),$event.stopPropagation(),"start"===type?$scope.ui.startDatePicker=!0:"end"===type&&($scope.ui.endDatePicker=!0),$scope.dateOptions.minDate=min,$scope.dateOptions.maxDate=max},$scope.updateAvailability=function(){$scope.editingProfile.availability&&$scope.updateProfile($scope.editingProfile)},$scope.update=function(form,cb){form.$valid&&($scope.updateProfile($scope.editingProfile),cb(),$scope.editing=!1)},$scope.cancel=function(cb){cb(),$scope.editing=!1,$scope.editingProfile=angular.copy($scope.profile)},$scope.addPhoto=function(profile){var modalInstance=$uibModal.open({templateUrl:"add-photo-modal.tpl.html",controller:"AddProfilePhotoCtrl",size:"lg",backdrop:"static",resolve:{profile:function(){return profile}}});modalInstance.result.then(function(photoUrl){$scope.profilePhotoUrl=photoUrl,$scope.photoExists=!0,$scope.profile.photoUrl=photoUrl})},$scope.deletePhoto=function(profile){var modalInstance=$uibModal.open({templateUrl:"photo-delete-confirmation.tpl.html",controller:"DeleteProfilePhotoCtrl",windowClass:"center-modal",resolve:{profile:function(){return profile}}});modalInstance.result.then(function(){profile.photoUrl||($scope.photoExists=!1,$scope.profilePhotoUrl="/images/1f34682a.user.png")})},$scope.updateSummary=function(){$scope.updateProfile($scope.editingProfile),$scope.data.isEditingSummary=!1},$scope.cancelSummary=function(){$scope.data.isEditingSummary=!1,$scope.editingProfile=angular.copy($scope.profile)},$scope.toggleSavedStatus=function(marketplaceMember){$scope.ui.isLoading=!0,CurrentUser.get(function(res){if($scope.me=res,marketplaceMember.isSaved){for(var idx=0,i=0;i<$scope.myAvatar.savedCandidates.length;++i)if($scope.myAvatar.savedCandidates[i].id===marketplaceMember.id){idx=i;break}$scope.myAvatar.savedCandidates.splice(idx,1)}else{$scope.myAvatar.savedCandidates=$scope.myAvatar.savedCandidates||[];var mmCopy={id:marketplaceMember.id};$scope.myAvatar.savedCandidates.push(mmCopy)}ManagerService.update({id:$scope.myAvatar.id},$scope.myAvatar).$promise.then(function(res){$scope.data.currentUser=res,CurrentUser.clearCache(),marketplaceMember.isSaved=!marketplaceMember.isSaved})["finally"](function(){$scope.ui.isLoading=!1})}),CurrentUser.clearCache()},$scope.interview=function(marketplaceMember){InterviewsService.checkAvailable(marketplaceMember.application.candidate)?$location.path("/interview/schedule/"+marketplaceMember.id):availabilityModal(marketplaceMember,"INTERVIEW")},$scope.hire=function(marketplaceMember){if(InterviewsService.checkAvailable(marketplaceMember.application.candidate)){var redirect=function(){$location.path("/hire/direct/"+marketplaceMember.id)},modalInstance=$uibModal.open({templateUrl:"job-candidates-hire-confirm.tpl.html",controller:"JobCandidatesHireConfirmCtrl",backdrop:"static"});modalInstance.result.then(function(){SelectionService.advancePaymentModal(marketplaceMember.application.candidate,redirect)})}else availabilityModal(marketplaceMember,"HIRE")};var availabilityModal=function(mm,type){$uibModal.open({templateUrl:"availability-warning.tpl.html",controller:"AvailabilityModalCtrl",backdrop:"static",resolve:{marketplaceMember:function(){return mm},type:function(){return type}}})};$scope.reject=function(marketplaceMember){loadData(function(currAssignment){currAssignment||(CurrentUser.get(function(res){if($scope.me=res,marketplaceMember.isSaved){for(var idx=0,i=0;i<$scope.myAvatar.savedCandidates.length;++i)if($scope.myAvatar.savedCandidates[i].id===marketplaceMember.id){idx=i;break}$scope.myAvatar.savedCandidates.splice(idx,1)}$scope.myAvatar.rejectedCandidates=$scope.myAvatar.rejectedCandidates||[];var mm={id:marketplaceMember.id};$scope.myAvatar.rejectedCandidates.push(mm),$scope.ui.isLoading=!0,ManagerService.update({id:$scope.myAvatar.id},$scope.myAvatar).$promise.then(function(res){CurrentUser.clearCache(),$scope.me=res,$rootScope.previousLocation?$location.path($rootScope.previousLocation):$location.path("/manager/candidates")})["finally"](function(){$scope.ui.isLoading=!1})}),CurrentUser.clearCache())})},$scope.editCandidateNotes=function(marketplaceMember){$scope.ui.isLoading=!0,ManagerNotesService.query({id:marketplaceMember.id},function(res){$uibModal.open({templateUrl:"candidate-notes.tpl.html",controller:"CandidateNotesCtrl",backdrop:"static",resolve:{marketplaceMember:function(){return marketplaceMember},manager:function(){return $scope.me},notes:function(){return res}}})}).$promise["finally"](function(){$scope.ui.isLoading=!1})},$scope.getProficiencyLabel=function(num){switch(num){case"0":return"Basic";case"1":return"Conversational";case"2":return"Fluent";case"3":return"Native"}},$scope.importProfile=function(){$uibModal.open({templateUrl:"overwrite-confirmation.tpl.html",controller:"ProfileImportCtrl",windowClass:"center-modal"})},$scope.options={types:"(cities)",watchEnter:!0},$scope.changeCity=function(){if(void 0===$scope.options.country&&$scope.changeCountry(),void 0!==$scope.editingProfile.location.city){var c=GoogleLocationService.getCity($scope.editingProfile.location.city);$scope.editingProfile.location.city=c.city}},$scope.changeCountry=function(){$scope.editingProfile.location.city="";var c=$scope.data.countries.filter(function(x){return x.id===$scope.editingProfile.location.country.id})[0];if($scope.options.country=c.code,$scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.selectedTimeZoneId=c.timezones[0].id;else if($scope.data.selectedTimeZoneId){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.selectedTimeZoneId},!1);isIncluded||($scope.data.selectedTimeZoneId=null)}},$scope.changeIndustry=function(){var selectedIndustryId=$scope.editingProfile.industry.id;$scope.editingProfile.industry=$scope.data.industries.filter(function(industry){return industry.id===selectedIndustryId})[0]}}]),ctrls.controller("ProfileImportCtrl",["$scope","$uibModalInstance","LinkedInService","$routeParams",function($scope,$uibModalInstance,LinkedInService,$routeParams){$scope.confirm=function(){$routeParams.jobId&&LinkedInService.setJobId($routeParams.jobId),window.location=LinkedInService.generateAuthorizationUrl("profileImport")},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("AddProfilePhotoCtrl",["$scope","$uibModalInstance","fileReader","ProfileUtils","profile",function($scope,$uibModalInstance,fileReader,ProfileUtils,profile){$scope.profile=profile,$scope.ui={isLoading:!1,showPlaceholder:!0},$scope.croppedPhoto="",$scope.readFile=function(){$scope.ui.isLoading=!0,fileReader.readAsDataUrl($scope.file,$scope).then(function(result){$scope.myImage=result,$scope.ui.isLoading=!1})},$scope.confirm=function(){$scope.ui.isLoading=!0,$scope.photoUrl="";var fileForUpload=fileReader.dataURItoBlob($scope.croppedPhoto);fileForUpload.name=$scope.file.name,ProfileUtils.uploadProfilePhoto($scope.profile,fileForUpload,function(createdFileName){$scope.photoUrl=createdFileName.replace(/"/g,""),$uibModalInstance.close($scope.photoUrl),$scope.ui.isLoading=!1})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("DeleteProfilePhotoCtrl",["$scope","$uibModalInstance","ProfileUtils","profile",function($scope,$uibModalInstance,ProfileUtils,profile){$scope.profile=profile,$scope.confirm=function(){ProfileUtils.deleteProfilePhoto($scope.profile,function(){$scope.profile.photoUrl="",$scope.photoUrl="",$uibModalInstance.close()})},$scope.cancel=function(){$uibModalInstance.close()}}]),ctrls.controller("EmploymentCtrl",["$scope","UtilsService",function($scope,UtilsService){$scope.editEmployment=null,$scope.UtilService=UtilsService,$scope.add=function(){$scope.editEmployment=null,$scope.employment={},$scope.creatingEmployment=!0},$scope.edit=function(employment){$scope.creatingEmployment=!1,$scope.editEmployment=employment.$$hashKey,$scope.employment=employment,$scope.employment.startDate=UtilsService.transformToDateObject($scope.employment.startDate),$scope.employment.endDate=UtilsService.transformToDateObject($scope.employment.endDate),$scope.employment.isCurrent=employment.current,$scope.oldEmployment=angular.copy(employment)},$scope.update=function(form,employment){employment.country||delete employment.country,form.$invalid||($scope.profile.employments||($scope.profile.employments=[]),employment.isCurrent?(employment.current=!0,delete employment.endDate):employment.current=!1,employment.startDate&&(employment.startDate=UtilsService.transformToDateObject(employment.startDate),1===employment.startDate.getDate()&&employment.startDate.setDate(2)),employment.endDate&&(employment.endDate=UtilsService.transformToDateObject(employment.endDate),1===employment.endDate.getDate()&&employment.endDate.setDate(2)),$scope.creatingEmployment?($scope.editProfile=angular.copy($scope.profile),
$scope.editProfile.employments.push(employment),$scope.creatingEmployment=!1,$scope.updateProfile($scope.editProfile)):$scope.updateProfile($scope.profile),form.$setPristine())},$scope.cancel=function(){$scope.creatingEmployment=!1,$scope.profile.employments||($scope.profile.employments=[]);for(var i=0;i<$scope.profile.employments.length;i++)$scope.profile.employments[i].$$hashKey===$scope.editEmployment&&($scope.profile.employments[i]=$scope.oldEmployment);$scope.editEmployment=null},$scope.remove=function(employment){var idx=$scope.profile.employments.indexOf(employment);idx>-1&&($scope.profile.employments.splice(idx,1),$scope.profile.employments||($scope.profile.employments=[]),$scope.updateProfile($scope.profile))}}]),ctrls.controller("SkillsCtrl",["$scope","SkillsService",function($scope,SkillsService){$scope.invalidSkill=!1,$scope.data={skill:null},$scope.add=function(){$scope.data.skill=null,$scope.editingSkills=!0},$scope.cancel=function(){$scope.editingSkills=!1},$scope.getSkills=function(name){return SkillsService.query({name:name}).$promise},$scope.save=function(skill){function addSkill(s){$scope.invalidSkill=!1,$scope.existingSkill=!1,$scope.emptySkill=!1,$scope.profile.skills.push({skill:s,proficiency:0}),$scope.updateProfile($scope.profile),$scope.data.skill=null}$scope.profile.skills||($scope.profile.skills=[]),skill=skill.name||skill,void 0!==skill&&null!==skill?SkillsService.query({name:skill}).$promise.then(function(matchingSkills){if(_.isEmpty(matchingSkills))$scope.invalidSkill=!0;else{var existing=_.find($scope.profile.skills,function(e){var a=e.skill.name||"a",b=skill||"b";return a.toLowerCase()===b.toLowerCase()});existing?$scope.existingSkill=!0:addSkill(_.first(matchingSkills))}}):$scope.emptySkill=!0},$scope.remove=function(skill){var idx=$scope.profile.skills.indexOf(skill);idx>-1&&($scope.profile.skills.splice(idx,1),$scope.updateProfile($scope.profile))}}]),ctrls.controller("LanguageCtrl",["$scope","LanguageService",function($scope,LanguageService){function getLanguage(language){for(var languages=angular.copy($scope.languages),i=0;i<languages.length;i++)if(angular.lowercase(languages[i].name)===angular.lowercase(language))return languages[i]}function update(){_.each($scope.profile.languages,function(l){isNaN(l.proficiency)&&delete l.proficiency}),$scope.updateProfile($scope.profile)}$scope.languages=LanguageService.query(),$scope.invalidLanguage=!1,$scope.data={language:null},$scope.add=function(){$scope.data.language=null,$scope.editingLanguages=!0,$scope.invalidProficiency=!1},$scope.getLanguages=function(){for(var languages=angular.copy($scope.languages),myLanguages=$scope.profile.languages||[],i=0;i<languages.length;i++)for(var j=0;j<myLanguages.length;j++)myLanguages[j].language.name===languages[i].name&&languages.splice(i,1);return languages},$scope.save=function(){var languageName=null;if($scope.profile.languages||($scope.profile.languages=[]),$scope.data.language&&(languageName=$scope.data.language.name||null),angular.isString(languageName)){var lang=getLanguage(languageName);if(!angular.isDefined($scope.data.proficiency))return void($scope.invalidProficiency=!0);if(!lang)return void($scope.invalidLanguage=!0);$scope.data.language=lang,$scope.profile.languages.push($scope.data)}$scope.invalidLanguage=!1,update(),$scope.editingLanguages=!1},$scope.cancel=function(){$scope.editingLanguages=!1},$scope.remove=function(language){var idx=$scope.profile.languages.indexOf(language);idx>-1&&($scope.profile.languages.splice(idx,1),$scope.profile.languages||($scope.profile.languages=[]),update())},$scope.startsWith=function(state,viewValue){return state.substr(0,viewValue.length).toLowerCase()===viewValue.toLowerCase()}}]),ctrls.controller("EducationCtrl",["$scope",function($scope){$scope.currentYear=(new Date).getFullYear(),$scope.editEducation=null,$scope.add=function(){$scope.editEducation=null,$scope.education={},$scope.creatingEducation=!0},$scope.edit=function(education){$scope.creatingEducation=!1,$scope.editEducation=education.$$hashKey,$scope.oldEducation=angular.copy(education),$scope.education=education,$scope.education.startDate&&($scope.education.startDate=new Date($scope.education.startDate).getFullYear()),$scope.education.endDate&&($scope.education.endDate=new Date($scope.education.endDate).getFullYear())},$scope.update=function(form,education){form.$invalid||($scope.education=education,$scope.profile.educations||($scope.profile.educations=[]),$scope.education&&($scope.education.startDate&&($scope.education.startDate=new Date($scope.education.startDate,0)),$scope.education.endDate&&($scope.education.endDate=new Date($scope.education.endDate,0))),$scope.creatingEducation&&($scope.profile.educations.push($scope.education),$scope.creatingEducation=!1),$scope.updateProfile($scope.profile))},$scope.cancel=function(){$scope.creatingEducation=!1,$scope.profile.educations||($scope.profile.educations=[]);for(var i=0;i<$scope.profile.educations.length;i++)$scope.profile.educations[i].$$hashKey===$scope.editEducation&&($scope.profile.educations[i]=$scope.oldEducation);$scope.editEducation=null},$scope.remove=function(education){var idx=$scope.profile.educations.indexOf(education);idx>-1&&($scope.profile.educations.splice(idx,1),$scope.profile.educations||($scope.profile.educations=[]),$scope.updateProfile($scope.profile))}}]),ctrls.controller("CertificationCtrl",["$scope",function($scope){$scope.editCertification=null,$scope.add=function(){$scope.editCertification=null,$scope.certification={},$scope.creatingCertification=!0},$scope.edit=function(certification){$scope.creatingCertification=!1,$scope.editCertification=certification.$$hashKey,$scope.certification=certification,$scope.certification.startDate&&($scope.certification.startDate=new Date($scope.certification.startDate).getFullYear()),$scope.certification.endDate&&($scope.certification.endDate=new Date($scope.certification.endDate).getFullYear()),$scope.oldCertification=angular.copy(certification)},$scope.update=function(){$scope.profile.certifications||($scope.profile.certifications=[]),$scope.certification&&($scope.certification.startDate&&($scope.certification.startDate=new Date($scope.certification.startDate,0)),$scope.certification.endDate&&($scope.certification.endDate=new Date($scope.certification.endDate,0))),$scope.creatingCertification&&($scope.profile.certifications.push($scope.certification),$scope.creatingCertification=!1),$scope.updateProfile($scope.profile)},$scope.cancel=function(){$scope.creatingCertification=!1,$scope.profile.certifications||($scope.profile.certifications=[]);for(var i=0;i<$scope.profile.certifications.length;i++)$scope.profile.certifications[i].$$hashKey===$scope.editCertification&&($scope.profile.certifications[i]=$scope.oldCertification);$scope.editCertification=null},$scope.remove=function(certification){var idx=$scope.profile.certifications.indexOf(certification);idx>-1&&($scope.profile.certifications.splice(idx,1),$scope.profile.certifications||($scope.profile.certifications=[]),$scope.updateProfile($scope.profile))}}]),ctrls.controller("JobCandidatesHireConfirmCtrl",["$scope","$uibModalInstance",function($scope,$uibModalInstance){$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),bandcampApp.directive("candidateProfile",["routePrefix","TechTrialApplicationService","$sce","$uibModal","$filter",function(routePrefix,TechTrialApplicationService,$sce,$uibModal,$filter){function candidateProfileController($scope){$scope.evaluationModal=function(evaluationModalFile){$scope.evaluationModalFile=evaluationModalFile,$scope.evalModal=$uibModal.open({templateUrl:"evaluation-modal.tpl.html",scope:$scope,backdrop:"static",windowClass:"modal-full-width"})},$scope.$watch("application",function(app){app.hackerRankPercentile=$filter("jobApplicationTest")(app,"HACKER_RANK","percentile"),app.rmtPercentile=$filter("jobApplicationTest")(app,"ASSIGNMENT","percentile")}),$scope.getProficiencyLabel=function(num){switch(num){case 0:return"Basic";case 1:return"Conversational";case 2:return"Fluent";case 3:return"Native"}}}var TEMPLATE_PATH="profile/candidate-profile/candidate-profile.tpl.html";return{restrict:"E",scope:{application:"="},replace:!0,controller:candidateProfileController,controllerAs:"vm",templateUrl:routePrefix+TEMPLATE_PATH}}]),ctrls.controller("RecruiterPendingApplicationsCtrl",["$scope","CurrentUser","$location","$uibModal","RecruiterCandidateApprovalService","$upload","baseUrl","JobApplicationService",function($scope,CurrentUser,$location,$uibModal,RecruiterCandidateApprovalService,$upload,baseUrl,JobApplicationService){function loadList(){JobApplicationService.getActivePreMPInterviews(function(res){$scope.data.preMarketList=_.map(res,function(i){return{object:i}}),$scope.UI.isLoading=!1})}CurrentUser.get(function(data){data.avatarTypes.indexOf("RECRUITER")===-1&&$location.path("/home"),$scope.avatarType="RECRUITER"}),loadList(),$scope.UI={isLoading:!0},$scope.data={preMarketList:[],filterText:null,filteredJobs:[]};var loadFullApplication=function(preMM){if(!preMM.application.files&&preMM.application.id&&!angular.isUndefined(preMM.application.id)&&/^\d+$/.test(preMM.application.id))return JobApplicationService.get({id:preMM.application.id,avatarType:$scope.avatarType},function(res){preMM.application=res},function(err){$scope.UI.error=err.data.text}).$promise},confirmRejectionModal=function(task,accept){var modalInstance=$uibModal.open({templateUrl:"reject-confirmation.tpl.html",scope:$scope,controller:confirmModalInstanceCtrl,backdrop:"static"});modalInstance.result.then(function(){callAcceptRejectAPI(task,accept)})};$scope.acceptOrReject=function(task,accept){$scope.UI.isLoading=!0,$scope.UI.error=null,accept?callAcceptRejectAPI(task,accept):confirmRejectionModal(task,accept)};var callAcceptRejectAPI=function(task,accept){RecruiterCandidateApprovalService.acceptReject({id:task.object.id,accept:accept},function(){loadList()},function(e){$scope.UI.error=e.data.text,$scope.UI.isLoading=!1})},confirmModalInstanceCtrl=function($scope,$uibModalInstance){$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss()}};$scope.scheduleCall=function(task){var preMM=task.object,modalInstance=$uibModal.open({templateUrl:"schedule-call.tpl.html",controller:scheduleModalInstanceCtrl,resolve:{preMM:function(){return preMM}},backdrop:"static"});modalInstance.result.then(function(){$scope.UI.error=null,RecruiterCandidateApprovalService.edit(preMM.id,preMM,function(data){task.object=data},function(e){$scope.UI.error=e.data.text})})};var scheduleModalInstanceCtrl=function($scope,$uibModalInstance,preMM){$scope.error=null,$scope.preMM=preMM;var currentStatus=preMM.callStatus,currentCallSchedule=preMM.callSchedule;preMM.callSchedule=moment(preMM.callSchedule).toDate(),$scope.today=new Date,"SCHEDULE_PENDING"===$scope.preMM.callStatus&&(preMM.callSchedule=null),$scope.confirm=function(){"SCHEDULE_PENDING"===$scope.preMM.callStatus&&(preMM.callSchedule=null),"SCHEDULED"!==$scope.preMM.callStatus&&"DONE"!==$scope.preMM.callStatus||$scope.preMM.callSchedule||($scope.error="Please select time & date"),("SCHEDULE_PENDING"===$scope.preMM.callStatus||$scope.preMM.callSchedule)&&$uibModalInstance.close()},$scope.cancel=function(){$scope.preMM.callStatus=currentStatus,$scope.preMM.callSchedule=currentCallSchedule,$uibModalInstance.dismiss("cancel")}};$scope.openCall=function(task){var preMM=task.object,open=function(){var modalInstance=$uibModal.open({templateUrl:"call-form.tpl.html",controller:callModalInstanceCtrl,size:"lg",resolve:{preMM:function(){return preMM}},backdrop:"static"});modalInstance.result.then(function(res){preMM=res,$scope.UI.error=null,RecruiterCandidateApprovalService.edit(preMM.id,preMM,function(data){task.object=data},function(e){$scope.UI.error=e.data.text})})},promise=loadFullApplication(preMM);promise?promise["finally"](function(){open()}):open()};var callModalInstanceCtrl=function($scope,$uibModalInstance,preMM,DownloadService){$scope.error=null,$scope.preMM=angular.copy(preMM);var retrieveResumeUrl=function(){$scope.preMM.application.resumeFile.signedUrl||JobApplicationService.getFileUrl($scope.preMM.application.id,$scope.preMM.application.resumeFile.id).success(function(signedUrl){$scope.preMM.application.resumeFile.signedUrl=signedUrl})};retrieveResumeUrl(),$scope.confirm=function(form){form.$invalid||$uibModalInstance.close($scope.preMM)},$scope.downloadFile=function(url){DownloadService.downloadFile(url)["catch"](function(err){$scope.error=err.text})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}};$scope.openFilesForm=function(task){$uibModal.open({templateUrl:"call-files-form.tpl.html",controller:filesModalInstanceCtrl,resolve:{task:function(){return task}},backdrop:"static"})};var filesModalInstanceCtrl=function($scope,$uibModalInstance,RecruiterCandidateApprovalService,JobApplicationService,DownloadService,task){$scope.error=null,$scope.task=task,$scope.preMM=task.object;var retrieveFileUrl=function(f){f&&!f.signedUrl&&JobApplicationService.getFileUrl($scope.preMM.application.id,f.id).success(function(signedUrl){f.signedUrl=signedUrl})},loadFilesUrl=function(){return retrieveFileUrl($scope.preMM.photoIdFile),retrieveFileUrl($scope.preMM.screenshotFile),retrieveFileUrl($scope.preMM.bandwidthTestFile),$scope.preMM.application.files?void($scope.preMM.application.files||[]).forEach(function(f){retrieveFileUrl(f)}):void JobApplicationService.get({id:$scope.preMM.application.id,avatarType:$scope.avatarType},function(res){$scope.preMM.application=res,($scope.preMM.application.files||[]).forEach(function(f){retrieveFileUrl(f)})},function(err){$scope.error=err.data.text})};loadFilesUrl();var fileLabelModalInstanceCtrl=function($scope,$uibModalInstance,file,filePropHolder){$scope.file=file,$scope.filePropHolder=filePropHolder,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}};$scope.fileChange=function(files){if($scope.error=null,!angular.isDefined(files)||!angular.isArray(files)||0===files.length)return void($scope.isLoading=!1);var filePropHolder={},modalInstance=$uibModal.open({templateUrl:"file-label.tpl.html",controller:fileLabelModalInstanceCtrl,resolve:{file:function(){return files[0]},filePropHolder:function(){return filePropHolder}},backdrop:"static"});modalInstance.result.then(function(){$scope.uploadFile(files,filePropHolder.label,filePropHolder.internal)})},$scope.downloadFile=function(url){DownloadService.downloadFile(url)["catch"](function(err){$scope.error=err.text})},$scope.uploadFile=function(files,label,internal){if($scope.error=null,!angular.isDefined(files)||!angular.isArray(files)||0===files.length)return void($scope.isLoading=!1);$scope.isLoading=!0,$scope.error=null;var config=$upload.prepareUpload({url:baseUrl+"/applications/"+$scope.preMM.id+"/preMarketplaceInterview/file",data:{type:label,internal:internal},file:files});$upload.http(config).success(function(){RecruiterCandidateApprovalService.get({id:$scope.preMM.id},function(data){$scope.task.object=data,$scope.preMM=data,$scope.isLoading=!1},function(err){$scope.error=err.data.text,$scope.isLoading=!1})}).error(function(){$scope.error="Error in file upload",$scope.isLoading=!1})},$scope.removeFile=function(fileId){$scope.error=null,$scope.isLoading=!0,RecruiterCandidateApprovalService.removeFile({id:$scope.preMM.application.id,fileId:fileId},function(){RecruiterCandidateApprovalService.get({id:$scope.preMM.id},function(data){$scope.task.object=data,$scope.preMM=data,$scope.isLoading=!1},function(err){$scope.error=err.data.text,$scope.isLoading=!1})},function(err){$scope.error=err.data.text,$scope.isLoading=!1})},$scope.close=function(){$uibModalInstance.dismiss("cancel")}}}]),ctrls.controller("ApplicantTrackerCtrl",["$scope","JobApplicationService","JobService","DownloadService","$window","$uibModal","CurrentUser","$location","$q","$timeout","$rootScope",function($scope,JobApplicationService,JobService,DownloadService,$window,$uibModal,CurrentUser,$location,$q,$timeout,$rootScope){function showMessage(clazz,msg){$scope.scrollToTop(),$scope.msg={clazz:clazz,show:!0,message:msg}}function hideMessage(){$location.search("result",null),$timeout(function(){$scope.msg.show=!1},9e3)}CurrentUser.get(function(data){$scope.email=data.email,data.avatarTypes.indexOf("ADMIN")>-1?$scope.avatarType="ADMIN":data.avatarTypes.indexOf("ACCOUNT_MANAGER")>-1?$scope.avatarType="ACCOUNT_MANAGER":data.avatarTypes.indexOf("RECRUITER")>-1?$scope.avatarType="RECRUITER":$location.path("/home")}),$scope.data={applications:[],pipelines:[],campaigns:[],tasks:{},selectedJobId:null,selectedJob:null,selectedCompany:null,selectedCampaign:null,selectedTask:null,statusUpdateRange:"",orderBy:"Time_Spent",sortDir:"DESC",selected:[]},$scope.shouldShowSummary=!1,$scope.UI={isLoading:!0};var loadOptionLists=function(){JobService.crud.list({applicationType:"NATIVE"},function(res){res.forEach(function(j){if(j.weightedKeywords){var weights=_.pluck(j.weightedKeywords,"weight"),sum=_.reduce(weights,function(memo,num){return memo+num},0);j.highThreshold=100*j.highThreshold/sum,j.lowThreshold=100*j.lowThreshold/sum}});var jobId=$location.search().jobId;jobId?$scope.data.selectedJobId=Number(jobId):$rootScope.selectedGlobalPipelineId&&($scope.data.selectedJobId=Number($rootScope.selectedGlobalPipelineId));var status=$location.search().status;status&&($scope.data.selectedTask=status);var campaign=$location.search().campaign;campaign&&($scope.data.selectedCampaign=campaign),$scope.data.pipelines=res,$scope.data.selectedJobId&&($scope.data.selectedJob=$scope.getPipelineById($scope.data.selectedJobId),$scope.change()),$scope.UI.isLoading=!1}),JobApplicationService.getCampaigns(function(res){$scope.data.campaigns=res}),$scope.data.tasks=JobApplicationService.getTasksNames()};loadOptionLists(),$scope.getPipelineById=function(id){var pipelineFound=null;return $scope.data.pipelines.forEach(function(pipeline){pipelineFound||pipeline.id!==id||(pipelineFound=pipeline)}),pipelineFound},$scope.toggleCheck=function(id){$scope.data.selected.indexOf(id)===-1?$scope.data.selected.push(id):$scope.data.selected.splice($scope.data.selected.indexOf(id),1)},$scope.selectAll=function(){$scope.data.applications.map(function(application){$scope.toggleCheck(application.id)})},$scope.clearSelection=function(){$scope.data.selected=[]},$scope.rejectModal=function(){$scope.data.rejectionMethod=void 0,$scope.data.rejectionReason=void 0,$scope.UI.modal=$uibModal.open({templateUrl:"rejection-modal.tpl.html",scope:$scope,backdrop:"static"})},$scope.reject=function(){$scope.UI.modal.dismiss(),$scope.UI.isLoading=!0;var promises=[];$scope.data.selected.forEach(function(id){var params={id:id,type:$scope.data.rejectionMethod,reason:$scope.data.rejectionReason};promises.push(JobApplicationService.remove(params).$promise)}),$q.all(promises)["finally"](function(){$scope.data.selected=[],$scope.UI.isLoading=!1,$scope.change(!1)})},$scope.scoreResumes=function(){$scope.UI.isLoading=!0,JobApplicationService.scoreResumes({applicationId:$scope.data.selected}).$promise["finally"](function(){$scope.data.selected=[],$scope.UI.isLoading=!1,$scope.change(!1)})},$scope.orderBy=function(orderBy){_.isEmpty($scope.data.resumeSearchQuery)&&($scope.data.orderBy!==orderBy?($scope.data.orderBy=orderBy,$scope.data.sortDir="ASC"):$scope.data.sortDir="DESC"===$scope.data.sortDir?"ASC":"DESC",$scope.data.currentPage=1,$scope.change())};var addTimeSpent=function(app){var taskDate=moment.tz(moment(app.taskCreationTime),"UTC"),currentDate=moment.tz(moment(),"UTC"),diff=currentDate-taskDate,hoursInMilli=36e5,daysInMilli=24*hoursInMilli,days=Math.floor(diff/daysInMilli);diff%=daysInMilli;var hours=Math.floor(diff/hoursInMilli);app.diff=days+" day "+hours+" hr"},daysAgo=function(days){var now=moment(new Date);return now.subtract(days,"days").format("YYYY-MM-DD")};$scope.change=function(isPageChange,downloadReport){$scope.data.selectedJob?($scope.data.selectedJobId=$scope.data.selectedJob.id,$rootScope.selectedGlobalPipelineId=$scope.data.selectedJobId):$rootScope.selectedGlobalPipelineId=$scope.data.selectedJobId=null,downloadReport?(showMessage("alert-success","This report will take a couple of minutes for us to generate. We will send it to "+$scope.email+" as an attachment."),hideMessage()):($scope.UI.isLoading=!0,$scope.shouldShowSummary=!1),$scope.UI.error=null,$scope.UI.filtered=!1;var params={orderBy:$scope.data.orderBy,avatarType:$scope.avatarType},filter={applicationType:"NATIVE",status:"IN_PROGRESS",showDisabled:!0,resumeSearchQuery:$scope.data.resumeSearchQuery};$scope.data.sortDir&&$scope.data.sortDir.length>0&&(params.sortDir=$scope.data.sortDir),$scope.data.selectedJobId&&(filter.jobId=$scope.data.selectedJobId),$scope.data.selectedCampaign&&(filter.campaign=$scope.data.selectedCampaign),$scope.data.selectedTask&&("Rejected"===$scope.data.selectedTask?filter.applicationStatus="REJECTED":filter.tasks=[$scope.data.selectedTask]),$scope.data.searchWord&&(filter.searchWord=$scope.data.searchWord,$scope.UI.filtered=!0),isPageChange&&(params.page=$scope.data.currentPage-1);var interval=Number($scope.data.statusUpdateRange)||0;if(interval)switch(interval){case 1:filter.lastStatusUpdateFrom=daysAgo(7);break;case 2:filter.lastStatusUpdateFrom=daysAgo(15),filter.lastStatusUpdateTo=daysAgo(7);break;case 3:filter.lastStatusUpdateFrom=daysAgo(30),filter.lastStatusUpdateTo=daysAgo(15);break;case 4:filter.lastStatusUpdateTo=daysAgo(30)}downloadReport&&(params.downloadFormat="CSV"),angular.isDefined($scope.data.selectedJob)&&$scope.data.selectedJob||angular.isDefined($scope.data.searchWord)&&""!==$scope.data.searchWord||""!==$scope.data.selectedCampaign||!_.isEmpty($scope.data.resumeSearchQuery)?(JobApplicationService.getApplications(params,filter,function(data){downloadReport||($scope.data.applications=data.content||[],$scope.data.totalElements=data.totalElements,($scope.data.applications||[]).forEach(function(app){addTimeSpent(app),app.rkScore=_.find(app.testScores,function(ts){return"RESUME_KEYWORD"===ts.test.type}),app.matScore=_.find(app.testScores,function(ts){return"MANDATORY_ATTRIBUTES"===ts.test.type})}),$scope.UI.isLoading=!1)},function(err){$scope.UI.error=err.data.text,$scope.UI.isLoading=!1}),angular.isDefined($scope.data.selectedJob)&&$scope.data.selectedJob&&!$scope.data.selectedCampaign&&!$scope.data.searchWord&&JobService.crud.get({id:$scope.data.selectedJobId},function(data){$scope.data.selectedJob=data,$scope.shouldShowSummary=!0})):($scope.data.applications=[],$scope.UI.isLoading=!1)},$scope.showFile=function(appId,applicationFile){JobApplicationService.openFileInGoogleDocViewer(appId,applicationFile.id)},$scope.openFilesForm=function(appId){appId&&!angular.isUndefined(appId)&&/^\d+$/.test(appId)&&$uibModal.open({templateUrl:"files-form.tpl.html",controller:filesModalInstanceCtrl,resolve:{appId:function(){return appId},avatar:function(){return $scope.avatarType}},backdrop:"static"})};var filesModalInstanceCtrl=function($scope,$uibModalInstance,JobApplicationService,DownloadService,appId,RecruiterCandidateApprovalService,$uibModal,avatar){$scope.appId=appId,$scope.isLoading=!0,JobApplicationService.get({id:appId,avatarType:avatar},function(res){$scope.application=res,$scope.isLoading=!1},function(err){$scope.err=err.data.text,$scope.isLoading=!1}),RecruiterCandidateApprovalService.get({id:appId},function(res){$scope.preMarketplaceForm=res}),$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.showFile=function(appId,applicationFile){var window;navigator.vendor&&navigator.vendor.indexOf("Apple")>-1&&navigator.userAgent&&!navigator.userAgent.match("CriOS")&&(window=$window.open("about:blank","Crossover")),JobApplicationService.getFileUrl(appId,applicationFile.id).success(function(url){DownloadService.downloadFile(url,window)})},$scope.openPreMarketplaceForm=function(){$scope.formModal=$uibModal.open({templateUrl:"pre-marketplace-form.tpl.html",scope:$scope,backdrop:"static",size:"lg"})}}}]),ctrls.controller("LanguageScreeningCtrl",["$scope","JobApplicationService","DownloadService","$uibModal","$window",function($scope,JobApplicationService,DownloadService,$uibModal){$scope.data={},$scope.loading=JobApplicationService.getLanguageReviews(function(res){$scope.data.applications=res}),$scope.gradingModal=function(app){$scope.data.review={},$scope.modal=openModal("language-grading-modal.tpl.html",app)},$scope.openAudioFile=function(app){app.audioFile=_.find(app.files,function(f){return"Spoken English"===f.label}),loadFileUrl(app,app.audioFile).success(function(url){DownloadService.downloadFile(url)})},$scope.openResume=function(app){loadFileUrl(app,app.resumeFile).success(function(url){DownloadService.downloadFile(url)})};var openModal=function(template,app){return $scope.data.selectedApp=app,$uibModal.open({templateUrl:template,backdrop:"static",scope:$scope})},loadFileUrl=function(app,file){$scope.loading=!0;var promise=JobApplicationService.getFileUrl(app.id,file.id);return promise["finally"](function(){$scope.loading=!1}),promise};$scope.submitReview=function(form,result){form.$valid&&($scope.modal.dismiss(),$scope.loading=JobApplicationService.recruiterReviewsSpokenTest({id:$scope.data.selectedApp.id,score:$scope.data.review.score,accepted:result},$scope.data.review.comment||"",function(){$scope.data.applications=$scope.data.applications.filter(function(app){return app.id!==$scope.data.selectedApp.id})}))}}]),ctrls.controller("PipelineTrackingCtrl",["JobService","$uibModal","$scope","$sce","TestsService","APPLICATION_TASKS","$rootScope",function(JobService,$uibModal,$scope,$sce,TestsService,APPLICATION_TASKS,$rootScope){function getPipelineById(id){return _.find(vm.jobs,function(job){return job.id===id})}function init(){vm.jobsLoading=JobService.crud.query({applicationType:"NATIVE"},function(data){vm.jobs=data,vm.jobs.unshift({title:"All - Last 7 Days",flowType:"ALL"}),$rootScope.selectedGlobalPipelineId&&(vm.selectedJob=getPipelineById($rootScope.selectedGlobalPipelineId))}).$promise}function changeJob(){var job=vm.selectedJob;$rootScope.selectedGlobalPipelineId=job.id,$scope.UI.isLoading=!0,void 0!==job.id?(job.statistics={},JobService.crud.get({id:vm.selectedJob.id},function(j){vm.selectedJob.candidateDescription=$sce.trustAsHtml(j.candidateDescription),vm.selectedJob.tests=j.tests,vm.selectedJob.visibleManagers=j.visibleManagers}),vm.statisticsLoading=getStatistics("currentStatus,total,newInLast7Days",job.statistics),getStatistics("conversionIn7Days,conversionIn14Days,medianConversionTime",job.statistics)):(vm.statistics=void 0,JobService.crud.statistics(function(res){vm.statistics=res,_.each(vm.statistics,function(stat){var counts=_.object(_.map(stat.values,_.values));_.each(vm.tasks.ALL,function(t){if(void 0===counts[t.task]){var found=_.find(vm.tasks[stat.job.flowType],function(appTask){return appTask.task.indexOf(t.task)>-1});found?counts[t.task]={count:counts[found.task]||0,task:found.task}:counts[t.task]={count:"NA"}}else counts[t.task]={count:counts[t.task],task:t.task}}),stat.counts=counts})}).$promise["finally"](function(){$scope.UI.isLoading=!1}))}function getStatistics(types,statistics){return JobService.crud.statisticsByJob({id:vm.selectedJob.id,types:types},function(data){var res={};_.each(data,function(stat){res[stat.type]=_.object(_.map(stat.values,_.values)),$scope.UI.isLoading=!1}),angular.extend(statistics,res)}).$promise}function getTest(jobTest){TestsService.get({id:jobTest.test.id},function(test){jobTest.test=test})}function openModal(display){$scope.job=vm.selectedJob,_.each($scope.job.tests,function(t){$scope.job[t.test.type]=t}),$scope.display=display,$scope.modalInstance=$uibModal.open({templateUrl:"description-modal.tpl.html",scope:$scope,size:"lg"})}function getCsvHeader(){var tasks=_.pluck(vm.tasks.ALL,"printableName");return["Job Title"].concat(tasks)}function getCsvContent(){return _.sortBy(_.map(vm.statistics,function(stat){var row={};return row.title=stat.job.title,_.each(vm.tasks.ALL,function(t){angular.isDefined(stat.counts[t.task].count)?row[t.task]=stat.counts[t.task].count:row[t.task]="NA"}),row}),"title")}var vm=this;vm.init=init,vm.changeJob=changeJob,vm.openModal=openModal,vm.getTest=getTest,vm.getCsvHeader=getCsvHeader,vm.getCsvContent=getCsvContent,vm.tasks=APPLICATION_TASKS,$scope.UI={isLoading:!1},vm.init()}]),ctrls.controller("PipelineSourcingCtrl",["JobService","$location","$scope","CurrentUser","$cacheFactory","$timeout","$filter",function(JobService,$location,$scope,CurrentUser,$cacheFactory,$timeout,$filter){function load(){vm.sourcingStatistics||(vm.loading=JobService.crud.sourcing(function(data){vm.sourcingStatistics=data,_.each(data.pipelineStatistics,function(stat){var cb=stat.job.calibration;if(cb&&cb.activatedOn){var now=moment(),activeDays=now.diff(moment(cb.activatedOn),"days");cb.activatedOn=activeDays>0?activeDays:void 0}}),sort(vm.sortBy)}))}function showMessage(type,msg){vm.updateJobMessage={type:type,show:!0,msg:msg}}function updateJob(job){showMessage(null,"Saving..."),updateJobDebounce(job)}function back(){$location.search("jobId",null)}function selectJob(id){$location.search("jobId",id)}function sort(sortBy){vm.sortBy!==sortBy?(vm.sortBy=sortBy,vm.sortDir=!1):vm.sortDir=!vm.sortDir,void 0===$location.search().jobId&&(vm.sortedStatistics=$filter("orderBy")(vm.sourcingStatistics.pipelineStatistics,sortBy,vm.sortDir))}function changeJob(job){vm.selectedJob=job,vm.loading=JobService.crud.getAuthenticated({id:job.id},function(data){_.each(data.tests,function(t){data[t.test.type]=t.test}),vm.selectedJob=data}),vm.loading=JobService.crud.sourcingByJob({id:job.id},function(data){vm.sourcing=data;var campaigns=vm.sourcing.campaignsStatistics;_.isEmpty(campaigns)||(vm.sourcing.maxApp=_.max(campaigns,function(s){return s.total}),vm.sourcing.minApp=_.min(campaigns,function(s){return s.total}),vm.sourcing.maxScore=_.max(campaigns,function(s){return s.avgScore}),vm.sourcing.minScore=_.min(campaigns,function(s){return s.avgScore}),vm.sourcing.total={applications:0,applications1:0,applications7:0,score:0,score1:0,score7:0},_.each(campaigns,function(stat){vm.sourcing.total.applications+=stat.total,vm.sourcing.total.applications1+=stat.total1,vm.sourcing.total.applications7+=stat.total7,vm.sourcing.total.score+=stat.avgScore,vm.sourcing.total.score1+=stat.avgScore1,vm.sourcing.total.score7+=stat.avgScore7}),vm.sourcing.total.score/=campaigns.length,vm.sourcing.total.score1/=campaigns.length,vm.sourcing.total.score7/=campaigns.length)})}function getCsvAllPipelines(){var content=_.map(vm.sourcingStatistics.pipelineStatistics,function(s){var r={};return r.id=s.job.id,r.title=s.job.title,r.priority=s.job.priority,r.activatedOn=s.job.calibration?s.job.calibration.activatedOn:"",r.demand=s.job.demand,r.applicationCount=s.applicationsCount,r.applicationCount1=s.applicationsCountDay,r.applicationCount7=s.applicationsCountWeek,r.qualityCount=s.qualityCount,r.qualityCount1=s.qualityCountDay,r.qualityCount7=s.qualityCountWeek,r.sourcingInstructions=s.job.sourcingInstructions,r.jbpEnabled=s.job.jbpEnabled,r.jbpInstructions=s.job.jbpInstructions,r.outboundEnabled=s.job.outboundEnabled,r.outboundInstructions=s.job.outboundInstructions,r.averageScore=s.avgResumeScore,r.averageScore1=s.avgResumeScoreDay,r.averageScore7=s.avgResumeScoreWeek,r});return content.push({id:"",title:"Total",activatedOn:"",demand:vm.sourcingStatistics.totalDemand,applicationCount:vm.sourcingStatistics.total,applicationCount1:vm.sourcingStatistics.totalDay,applicationCount7:vm.sourcingStatistics.totalWeek}),content}function getCsvOnePipeline(){var content=angular.copy(vm.sourcing.campaignsStatistics);return content.push({campaign:"Total",total:vm.sourcing.total.applications,total1:vm.sourcing.total.applications1,total7:vm.sourcing.total.applications7,avgScore:vm.sourcing.total.score,
avgScore1:vm.sourcing.total.score1,avgScore7:vm.sourcing.total.score7}),content}function isNumber(num){return!!angular.isNumber(num)}var vm=this;vm.selectJob=selectJob,vm.changeJob=changeJob,vm.back=back,vm.sort=sort,vm.getCsvAllPipelines=getCsvAllPipelines,vm.getCsvOnePipeline=getCsvOnePipeline,vm.updateJob=updateJob,vm.updateJobMessage={type:null,show:!1,msg:null},vm.isNumber=isNumber,vm.sortBy="job.demand",vm.sortDir=!0,$scope.$watch(function(){return $location.search().jobId},function(id){void 0!==id?changeJob({id:id}):(vm.selectedJob=void 0,load())}),CurrentUser.get(function(u){vm.cu=u,(vm.cu.avatarTypes.indexOf("ADMIN")>-1||vm.cu.avatarTypes.indexOf("ACCOUNT_MANAGER")>-1)&&(vm.cu.canEdit=!0)});var updateJobDebounce=_.debounce(function(job){var sourcingData={priority:job.priority,sourcingInstructions:job.sourcingInstructions,jbpInstructions:job.jbpInstructions,outboundInstructions:job.outboundInstructions,jbpEnabled:job.jbpEnabled,outboundEnabled:job.outboundEnabled};JobService.crud.updateSourcing({id:job.id},sourcingData).$promise.then(function(){showMessage("success","All changes saved")})["catch"](function(response){showMessage("error",response.data.text)})},400);vm.blur=function($e){_.each($e.target.childNodes,function(child){$(child).blur()})}}]),ctrls.controller("CampaignSourcingCtrl",["$scope","JobService","$location",function($scope,JobService,$location){function load(){$scope.UI.loading=!0,$scope.data.campaignStats=JobService.crud.campaignSourcing(function(data){$scope.data.campaign.stats=data.stats,$scope.data.campaign.totals=data.totalStats,$scope.UI.loading=!1})}$scope.data={campaign:{stats:[],totals:{}},sortBy:"campaign",sortDir:!1},$scope.UI={loading:!1},$scope.sort=function(sortBy){$scope.data.sortBy!==sortBy?($scope.data.sortBy=sortBy,$scope.data.sortDir=!1):$scope.data.sortDir=!$scope.data.sortDir},$scope.goBack=function(){return $location.path("pipelines/sourcing")},load()}]),ctrls.controller("JobRedirectsCtrl",["$scope","$location","$routeParams","$rootScope","CurrentUser","JobService","LinkedInService","$upload","baseUrl","UserService","GlobalDataFactory","$sce","JobApplicationService","CountriesService",function($scope,$location,$routeParams,$rootScope,CurrentUser,JobService,LinkedInService,$upload,baseUrl,UserService,GlobalDataFactory,$sce,JobApplicationService,CountriesService){function errorCallback(err){$scope.data.err=err,$scope.ui.isLoading=!1}function parseFullName(fullName){var firstName=fullName.substr(0,fullName.indexOf(" ")).trim(),lastName=fullName.substr(fullName.indexOf(" ")+1).trim();return[firstName,lastName]}function getCodes(){var query=window.location.search.substring(1),vars=query.split("&"),codes={};return vars.forEach(function(param){var pair=param.split("=");codeNames.indexOf(pair[0])!==-1&&pair[1]&&(codes[pair[0].substring(4)]=pair[1])}),codes}var vm=this;$scope.ui={started:!1,isLoading:!0},$scope.params=$routeParams,$scope.data={id:void 0,source:void 0,err:void 0,visitor:!0},$scope.loggedIn=!1,$scope.resumeName=void 0,$scope.PASSWORD_REGEXP=/^(?=.*[^a-zA-Z])(?=.*[a-zA-Z]).{8,64}$/;var FIRST_LETTER=new RegExp(/[a-z]/i);$scope.hideSubtitleBar(),$scope.update=function(){var processJob=function(job){return angular.isDefined(job)&&angular.isDefined(job.id)?($rootScope.isUserLoggedIn()&&($scope.loggedIn=!0,CurrentUser.get(function(data){$scope.existCandidate=data,$scope.isExistCandidate=data.avatarTypes.indexOf("CANDIDATE")>-1,$scope.isExistCandidate&&JobApplicationService.checkCanApply({jobId:job.id},function(){},function(data){if(angular.isObject(data)){$scope.hasApplication=!0,$scope.cannotApplyError=data.data.text;var title=$scope.job.title;data.data.text.indexOf(title)!==-1&&($scope.duplicateApplication=!0)}})})),job.candidateDescription&&(job.candidateDescription=$sce.trustAsHtml(job.candidateDescription.replace(/weight:\s?bold/g,"weight:500"))),$scope.data.job=job,$scope.job=job,$scope.ui.isLoading=!1,void LinkedInService.setJobApplicationData({jobId:$scope.job.id,url:$location.url()})):($scope.ui.isLoading=!1,void($scope.data.notFound=!0))};if(isNaN($routeParams.id))JobService.crud.getByTitle({title:$routeParams.id.replace(/_/g," ")},processJob,errorCallback);else{var id=parseInt($routeParams.id,10);!isNaN(id)&&id>0?JobService.crud.get({id:id},processJob,errorCallback):($scope.ui.isLoading=!1,$scope.data.notFound=!0)}CountriesService.query(function(res){$scope.countries=res})},$scope.update();var validateNewCandidateData=function(form){if(!form.$valid||$scope.ui.emailExists||$scope.ui.fullNameInvalid)return void($scope.ui.submitted=!0);var names=parseFullName($scope.data.fullName),candidate={email:$scope.data.email,type:"CANDIDATE",firstName:names[0],lastName:names[names.length-1],userSecurity:{rawPassword:$scope.data.password},location:{country:$scope.data.selectedCountry},recaptchaResponse:$scope.data.recaptchaResponse,jobId:$scope.data.job.id};return candidate};$scope.applyForJob=function(form){if($scope.ui.submitted=!1,$scope.ui.resumeError=!1,$scope.ui.captchaError=!1,$scope.ui.resumeSizeError=!1,$scope.ui.resumeFileTypeError=!1,$scope.ui.err=!1,!$scope.resume||0===$scope.resume.length)return void($scope.ui.resumeError=!0);var candidate,apiUrl;if($scope.existCandidate?(candidate=$scope.existCandidate,apiUrl=baseUrl+"/applications"):(candidate=validateNewCandidateData(form),apiUrl=baseUrl+"/public/applications"),candidate){candidate.type="CANDIDATE";var application={candidate:candidate,job:{id:$scope.data.job.id}};angular.extend(application,getCodes());var bb1,bb2;try{bb1=fpGetBlackbox()}catch(e){bb1=null}try{bb2=ioGetBlackbox()}catch(e){bb2=null}var config=$upload.prepareUpload({url:apiUrl,fileFormDataName:"resume",data:{application:application,blackbox:bb1,blackbox2:bb2},file:$scope.resume});$scope.ui.started=!0,$upload.http(config).progress(function(evt){$scope.fileProgress=parseInt(100*evt.loaded/evt.total,10)}).success(function(existCandidateApp){$scope.existCandidate?"NATIVE"===$scope.data.job.applicationType?JobApplicationService.identifyCurrentStep(existCandidateApp,""):$location.path("/candidate/dashboard/applications"):(GlobalDataFactory.setItem("application",{job:$scope.data.job}),$location.path("/redirect/verify").search({email:$scope.data.email}))}).error(function(err){grecaptcha.reset(),$scope.ui.started=!1,$scope.fileProgress=0,"CROS-0017"===err.errorCode?$scope.ui.captchaError=!0:$scope.ui.err=err.text})}},$scope.goToLinkedInAuthorization=function(){window.location=LinkedInService.generateAuthorizationUrl()},vm.checkIfStringEndsWith=function(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1},vm.checkIfFileTypeIsAllowed=function(file){for(var fileTypes=[{ext:"pdf",mime:"application/pdf"},{ext:"md",mime:"text/x-markdown"},{ext:"doc",mime:"application/msword"},{ext:"docx",mime:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"},{ext:"xml",mime:"application/xml"},{ext:"txt",mime:"text/plain"}],i=fileTypes.length;i--;)if(file.type===fileTypes[i].mime||vm.checkIfStringEndsWith(file.name,fileTypes[i].ext))return!0;return!1},$scope.fileChange=function(files){return $scope.ui.resumeError=!1,$scope.ui.resumeSizeError=!1,$scope.ui.resumeFileTypeError=!1,angular.isDefined(files)&&angular.isArray(files)&&0!==files.length?files[0].size>1048576?($scope.ui.resumeSizeError=!0,$scope.resume=void 0,void($scope.resumeName=void 0)):vm.checkIfFileTypeIsAllowed(files[0])?($scope.resume=files,void($scope.resumeName=files[0].name)):($scope.ui.resumeFileTypeError=!0,$scope.resume=void 0,void($scope.resumeName=void 0)):($scope.resume=void 0,void($scope.resumeName=void 0))},$scope.$watch("data.recaptchaResponse",function(){$scope.ui.captchaError=!1}),$scope.isError=function(input){for(var field in input.$error)if(input.$error[field])return!0;return!1},$scope.checkEmailUsage=function(email){email.$invalid||($scope.ui.emailExists=!1,UserService.checkEmailUsed($scope.data.email).then(function(data){$scope.ui.emailExists="true"===data.data}))},$scope.emailFieldActive=function(){return"email"===document.activeElement.id},$scope.$watch("data.fullName",function(newName){if($scope.ui.fullNameInvalid=!1,newName&&0!==newName.length){var fullName=parseFullName(newName),firstName=fullName[0],lastName=fullName[1];firstName&&lastName&&FIRST_LETTER.test(firstName)&&FIRST_LETTER.test(lastName)||($scope.ui.fullNameInvalid=!0)}});var codeNames=["utm_source","utm_medium","utm_campaign"]}]),ctrls.controller("PayoneerRedirectCtlr",["$scope","$location","CurrentUser",function($scope,$location,CurrentUser){CurrentUser.get(function(e){$scope.user=e,"MIGRATED_CANDIDATE"===e.type?$location.path("/migrated/payoneer"):$location.path("/onboard/payoneer")})}]),bandcampApp.directive("locationWarning",["routePrefix","CountriesService",function(routePrefix,CountriesService){var TEMPLATE_PATH="redirect/location-warning/location-warning.tpl.html";return{restrict:"E",scope:{},replace:!0,templateUrl:routePrefix+TEMPLATE_PATH,controller:function(){var vm=this;CountriesService.query(function(res){vm.countries=res})},controllerAs:"vm"}}]),ctrls.controller("RegHiringMgrCtrl",["$scope","CountriesService","TimezonesService","$routeParams","$location","$timeout","$rootScope","baseUrl","ManagerInvitationService","ManagerService","EnumsService","GoogleLocationService","CurrentUser",function($scope,CountriesService,TimezonesService,$routeParams,$location,$timeout,$rootScope,baseUrl,ManagerInvitationService,ManagerService,EnumsService,GoogleLocationService,CurrentUser){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function isFormValid(form){return form.$valid&&$scope.data.user.password===$scope.data.user.confirmedPassword}$scope.data={countries:CountriesService.query(),timezones:TimezonesService.query(),filteredTimezones:[],selectedCountryId:null,selectedTimeZoneId:null,company:null,user:null,questions:[]},$scope.data.timezones.$promise.then(function(data){$scope.data.filteredTimezones=data});var countryCallback=function(){$scope.$watch("data.selectedCountryId",function(newValue,oldValue){oldValue!==newValue&&$scope.clearCity()})};EnumsService.get(function(res){$scope.data.questions=res.securityQuestions}),$scope.ui={isLoading:!0},$scope.patterns={password:/^(?=.*[^a-zA-Z])(?=.*[a-zA-Z]).{8,64}$/,name:/^[a-zA-Z ,.'-]{2,}$/},$scope.options={types:"(cities)",watchEnter:!0},$scope.clearCity=function(){$scope.data.user.location={}},$scope.changeCity=function(){if(void 0!==$scope.data.user.location.city){var c=GoogleLocationService.getCity($scope.data.user.location.city);$scope.data.user.location.city=c.city,$scope.data.user.location.state=c.state}},$scope.changeCountry=function(){var c=$scope.data.countries.filter(function(x){return x.id===$scope.data.selectedCountryId})[0];if($scope.options.country=c.code,$scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.selectedTimeZoneId=c.timezones[0].id;else if($scope.data.selectedTimeZoneId){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.selectedTimeZoneId},!1);isIncluded||($scope.data.selectedTimeZoneId=null)}},$scope.changeTimezone=function(){var tz=$scope.data.timezones.filter(function(x){return x.id===$scope.data.selectedTimeZoneId})[0];1===tz.countries.length&&($scope.data.selectedCountryId=tz.countries[0].id,$scope.options.country=tz.countries[0].code)},$scope.save=function(form){if(isFormValid(form)){var user=angular.copy($scope.data.user);user.avatarTypes||(user.avatarTypes=[]),user.avatarTypes.push("MANAGER"),user.type="MANAGER",user.location=user.location||{},user.location.country={id:$scope.data.selectedCountryId},user.location.timeZone={id:$scope.data.selectedTimeZoneId},user.location.city=$scope.data.user.location.city,user.location.state=$scope.data.user.location.state,void 0!==$scope.details&&(user.location.latLong=$scope.details.geometry.location.lat()+","+$scope.details.geometry.location.lng()),"other"===user.userSecurity.securityQuestion&&user.customQuestion&&(user.userSecurity.securityQuestion=user.customQuestion,delete user.customQuestion),user.userSecurity.rawPassword=user.confirmedPassword,delete user.password,delete user.confirmedPassword,$scope.ui.isLoading=!0,ManagerService.save({invitation:$routeParams.token},user,function(res){$scope.ui.isRegisterButtonDisabled=!0;var msg="Congratulations! Your account is registered. Lets start.";showMessage("alert-success",msg),$rootScope.setAuthToken(res.token),$timeout(function(){$location.path("/manager/dashboard/home")},3e3)}).$promise["catch"](function(err){var msg=err.data.text;"NotFoundException"===err.data.cause&&(msg="It seems you are coming from an incorrect link, please check it."),showMessage("alert-danger",msg)})["finally"](function(){window.scroll(0,0),$scope.ui.isLoading=!1})}},ManagerInvitationService.findByToken({t:$routeParams.token}).$promise.then(function(data){$scope.data.user={firstName:data.firstName,lastName:data.lastName,email:data.email,location:angular.copy(data.company.location)},$scope.data.company=data.company;var setupOptions=function(defaultCountry){$scope.options={types:"(cities)",watchEnter:!0},angular.isDefined(defaultCountry)?$scope.options.country=defaultCountry:($scope.data.selectedCountryId=230,$scope.data.selectedTimeZoneId=299,$scope.data.user.location.city="",$scope.options.country="us")};CurrentUser.getLocation({managerInvitationToken:$routeParams.token},function(geo){if(angular.isDefined(geo)){var location=$scope.data.user.location;location.timeZone=geo.timeZone,location.country=geo.country,location.city=geo.city,location.latLong=geo.latLong,$scope.data.selectedCountryId=geo.country.id,$scope.data.selectedTimeZoneId=geo.timeZone.id,$scope.detectedLocation=geo,setupOptions(geo.country.code)}else setupOptions();countryCallback()},function(){setupOptions(),countryCallback()})})["catch"](function(err){showMessage("alert-danger",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}]),ctrls.controller("InvoicesReportCtrl",["$scope","InvoicesReportService","DownloadService","CurrentUser","$filter","CompaniesService","$q","$routeParams","$location",function($scope,InvoicesReportService,DownloadService,CurrentUser,$filter,CompaniesService,$q,$routeParams,$location){function changeSize(){"All"===invoice.data.size.name&&(invoice.data.size.id=invoice.data.allItems.length),invoice.data.page=1,invoice.data.isFirstPage=!0,invoice.data.totalPages===invoice.data.page&&(invoice.data.isLastPage=!0),invoice.data.table.items=invoice.data.allItems.slice(0,invoice.data.size.id),invoice.data.totalPages=Math.ceil(invoice.data.allItems.length/invoice.data.size.id),getItemRange()}function isFirstPage(){return 1===invoice.data.page?invoice.data.isFirstPage=!0:invoice.data.isFirstPage=!1,!!invoice.data.isFirstPage}function isLastPage(){return invoice.data.totalPages===invoice.data.page?invoice.data.isLastPage=!0:invoice.data.isLastPage=!1,!!invoice.data.isLastPage}function update(pageChange){1===pageChange&&invoice.data.isLastPage||pageChange===-1&&invoice.data.isFirstPage||(invoice.data.page+=pageChange,getItemRange(),showItems())}function showItems(){var showFrom=invoice.data.rangeStart-1;invoice.data.table.items=invoice.data.allItems.slice(showFrom,invoice.data.rangeEnd)}function sortTable(sortType){sortType===invoice.data.table.sortType&&(invoice.data.table.sortReverse=!invoice.data.table.sortReverse),invoice.data.allItems=_.sortBy(invoice.data.allItems,sortType),invoice.data.table.sortReverse&&invoice.data.allItems.reverse(),showItems(),invoice.data.table.sortType=sortType}function fixInvoiceItemsForGrid(items){items=items.map(function(i){var _item=angular.copy(i),mm=i.assignment.selection.marketplaceMember;return _item.contractorName=mm.application.candidate.printableName,_item.paymentHours=i.numberOfHours+i.manualTime-i.disputedTime,_item.rate=i.assignmentHistory.salary,_item.salaryUnit=i.assignmentHistory.salaryUnit,_item.weeklyLimit="HOUR"===i.assignmentHistory.salaryUnit?i.assignmentHistory.weeklyLimit:"-",_item.team=i.assignmentHistory.team.name,_item.hiringManager=i.assignment.selection.manager.printableName,_item.disputedTime=-i.disputedTime,_item.loggedHours=i.numberOfHours,_item.netPayment=i.paymentDue,_item.xoFee=i.xoFee,_item}),invoice.data.allItems=_.sortBy(items,"contractorName"),invoice.data.table.items=invoice.data.allItems.slice(0,invoice.data.size),invoice.data.totalPages=Math.ceil(invoice.data.allItems.length/invoice.data.size),invoice.data.page=1,invoice.data.isFirstPage=!0,invoice.data.totalPages===invoice.data.page&&(invoice.data.isLastPage=!0),invoice.data.size=invoice.data.sizes[0],getItemRange(),invoice.ui.isLoading=!1}function getItemRange(){invoice.data.rangeStart=invoice.data.size.id*(invoice.data.page-1),invoice.data.rangeEnd=invoice.data.rangeStart+invoice.data.size.id,invoice.data.rangeStart+=1,invoice.data.rangeEnd>invoice.data.allItems.length&&(invoice.data.rangeEnd=invoice.data.allItems.length)}function getTime(time){if(!time||"-"===time)return"-";var _time=String(time).split("."),hh=_time[0]+"h",mm="";return _time[1]&&(mm=1===_time[1].length?" "+Math.round(.01*_time[1].substring(0,1)*60)+"m":" "+Math.round(.01*_time[1].substring(0,2)*60)+"m"),hh+mm}function changeCompany(){invoice.data.period="isoweek","MONTHLY"===invoice.data.company.invoiceFrequency&&(invoice.data.period="month"),invoice.data.table.items=[],init(invoice.data.company)}function changeDate(){var selectedDateWeekstart=moment(invoice.data.date).startOf("isoweek").format("YYYY-MM-DD"),_invoice=_.findWhere(invoice.data.invoices,{startDate:selectedDateWeekstart});_invoice&&(invoice.data.invoice=_invoice,loadItemsRecursive(_invoice))}function changeInvoice(i){var index=_.indexOf(invoice.data.invoices,invoice.data.invoice)+i,_invoice=invoice.data.invoices[index];return moment(_invoice.startDate).startOf("isoweek").isSame(moment(invoice.data.weekStart).startOf("isoweek"))?(i>0?i++:i--,invoice.fn.changeInvoice(i)):void(_invoice&&(invoice.data.invoice=_invoice,invoice.data.date=_invoice.startDate,loadItemsRecursive(_invoice)))}function isLastWeek(){if(invoice.data.invoice){var isSame=moment(invoice.data.invoice.startDate).startOf("isoweek").isSame(moment(invoice.data.invoicesEndDate).startOf("isoweek"));return isSame}}function isFirstWeek(){if(invoice.data.invoice){var isSame=moment(invoice.data.invoice.startDate).startOf("isoweek").isSame(moment(invoice.data.invoicesStartDate).startOf("isoweek"));return isSame}}function download(){invoice.ui.isLoading=!0,DownloadService.download("/invoices/"+invoice.data.invoice.id+"/download"),finalCb()}function lastInvoiceWithTotal(invoices){for(var lastInvoice,_invoices=invoices.slice().reverse(),i=0;i<_invoices.length;i++)if(_invoices[i].total>0){lastInvoice=_invoices[i];break}return lastInvoice?lastInvoice:_invoices[0]}function setDate(inv,period){if(inv&&inv.startDate){var start=moment.utc(inv.startDate);invoice.data.weekStart=start.format("MMM DD"),"isoweek"===period?invoice.data.weekEnd=start.add(6,"d").format("MMM DD, YYYY"):invoice.data.weekEnd=start.endOf(period).format("YYYY-MM-DD")}}function init(company){invoice.ui.isLoading=!0,invoice.data.companySelected=!0;var param={};company&&(param.companyId=company.id),InvoicesReportService.query(param,function(res){if(0===res.length)return invoice.data.invoices=[],invoice.data.invoice=null,void(invoice.ui.isLoading=!1);invoice.data.invoices=_.sortBy(res,"startDate");var _invoice=null;if($routeParams.id){var invoiceId=parseInt($routeParams.id,10);_invoice=_.find(invoice.data.invoices,function(x){return x.id===invoiceId}),$location.search("id",null)}var lastInvoice=lastInvoiceWithTotal(invoice.data.invoices);_invoice=_invoice||lastInvoice,setDate(_invoice,invoice.data.period),invoice.data.invoice=_invoice,invoice.data.invoicesStartDate=invoice.data.invoices[0].startDate,invoice.data.invoicesEndDate=invoice.data.date=moment(lastInvoice.startDate).endOf("isoweek").format("YYYY-MM-DD"),invoice.data.invoices.forEach(function(i){var st=moment.parseZone(i.startDate);i.startDate=moment.utc(i.startDate).format("YYYY-MM-DD"),i.period=st.format("MMM DD"),i.period+=" - ","isoweek"===invoice.data.period?i.period+=st.add(6,"d").format("MMM DD"):i.period+=st.endOf(invoice.data.period).format("MMM DD"),i.states={hover:{color:"#369ff3"}}}),_.isEmpty(invoice.data.table.items)?loadItemsRecursive(_invoice):invoice.data.table.items=_invoice.items}).$promise["catch"](errorCb)}function updateChart(){if(invoice.data.invoice){var index=_.indexOf(invoice.data.invoices,invoice.data.invoice),page=Math.floor(index/invoice.ui.chartColumns)+1,chartData=invoice.data.invoices.slice((page-1)*invoice.ui.chartColumns,page*invoice.ui.chartColumns);chartData.forEach(function(i){i.y=i.total,i.id===invoice.data.invoice.id?i.color="#369FF3":i.total>0&&(i.color="#A0D5FF")}),chartData=chartData.map(function(i){if(i.total)return i}).filter(Boolean),invoice.data.chartConfig.series=[{data:chartData,color:"#dee7eb"}]}}function loadItemsRecursive(_invoice,page){page=page||0,_invoice.items=_invoice.items||[],invoice.ui.isLoading=!0;var req={id:_invoice.id,page:page,pageSize:100};InvoicesReportService.get(req).$promise.then(function(res){invoice.data.itemsLoading.push(res.content),res.last?(_invoice.items=_.flatten(invoice.data.itemsLoading),invoice.data.itemsLoading=[],fixInvoiceItemsForGrid(_invoice.items),setDate(_invoice,invoice.data.period),showItems(),updateChart()):loadItemsRecursive(_invoice,++page)})["catch"](errorCb)}function finalCb(){invoice.ui.isLoading=!1}function errorCb(err){finalCb(),invoice.ui.err=angular.isObject(err.data)?err.data.text:err.text}var invoice=this;invoice.data={companySelected:!1,query:"",page:1,totalPages:0,totalItems:0,itemsLoading:[],size:25,sizes:[{id:25,name:25},{id:50,name:50},{id:100,name:100},{id:"All",name:"All"}],rangeStart:1,rangeEnd:25,table:{items:[],sortType:"contractorName",sortReverse:!1,searchQuery:"",headers:[{name:"Contractor Name",id:"contractorName","class":"width140"},{name:"Team",id:"team","class":"width140"},{name:"Hiring Manager",id:"hiringManager","class":"width140"},{name:"Logged Hours",id:"loggedHours","class":"width60"},{name:"Manual",id:"manualTime","class":"width60"},{name:"Disputed",id:"disputedTime","class":"width60"},{name:"Payment Hours",id:"paymentHours","class":"width60"},{name:"Weekly Limit",id:"weeklyLimit","class":"width60"},{name:"Rate",id:"rate","class":"width60"},{name:"Net Payment",id:"netPayment","class":"width80"},{name:"Crossover Fee",id:"xoFee","class":"width80"}]},error:{errorCode:null,httpStatus:null,text:null,type:null},dateOptions:{showWeeks:!1,startingDay:1}},invoice.fn={sortTable:sortTable,update:update,isFirstPage:isFirstPage,isLastPage:isLastPage,changeSize:changeSize,getTime:getTime,changeCompany:changeCompany,changeDate:changeDate,changeInvoice:changeInvoice,download:download,isFirstWeek:isFirstWeek,isLastWeek:isLastWeek},invoice.ui={isLoading:!1,chartColumns:9,pageSize:25,currentPage:1},invoice.data.chartConfig={options:{chart:{type:"column"},legend:{enabled:!1},tooltip:{formatter:function(){return'<div style="padding: 10px;">'+this.point.period+'<hr style="margin: 13px 0;"><span style="color: #a2a3a5;">Grand Total: </span><span style="font-weight: bold;">$'+this.y+"</span></div>"},borderRadius:10,borderColor:"transparent",fontFamily:"Lato",useHTML:!0,backgroundColor:"#ffffff"}},series:[],title:{text:""},xAxis:{type:"category",labels:{style:{fontSize:"11px",fontFamily:"Lato"},formatter:function(){return invoice.data.chartConfig.series[0].data[this.value].period}}},yAxis:{title:{text:""},min:0,labels:{formatter:function(){return"$"+this.value},style:{fontFamily:"Lato",fontSize:"12px"}}}},CurrentUser.get(function(u){invoice.data.cu=u,u.avatarTypes.indexOf("ACCOUNT_MANAGER")>-1?(invoice.ui.isLoading=!0,CompaniesService.query({avatarType:"ACCOUNT_MANAGER"}).$promise.then(function(res){invoice.data.companies=res.content;for(var promises=[],i=1;i<res.totalPages;i++)promises.push(CompaniesService.query({page:i,avatarType:"ACCOUNT_MANAGER"}).$promise);$q.all(promises).then(function(r){angular.forEach(r,function(result){invoice.data.companies=invoice.data.companies.concat(result.content)})})["finally"](finalCb)})):CurrentUser.getAvatar({avatarType:"COMPANY_ADMIN"},function(a){invoice.period="isoweek","MONTHLY"===a.company.invoiceFrequency&&(invoice.period="month"),init(a.company)})})}]),ctrls.controller("ManagmentReportsCtrl",["$scope","CurrentUser","DownloadService","ReportingService","$location","$timeout","InterviewsService",function($scope,CurrentUser,DownloadService,ReportingService,$location,$timeout,InterviewsService){function showMessage(clazz,msg){$scope.scrollToTop(),$scope.msg={clazz:clazz,show:!0,message:msg}}function hideMessage(){$location.search("result",null),$timeout(function(){$scope.msg.show=!1},9e3)}$scope.UI={},$scope.data={},$scope.hideSubtitleBar(),CurrentUser.get(function(data){function avatarCheckAndAssign(avatar,getAvatar){var acceptList="ADMIN, ACCOUNT_MANAGER, RECRUITER, COMPANY_ADMIN, MANAGER",i=avatar.length,listIndex=99;if(!getAvatar){for(;i--;)if(acceptList.search(new RegExp("\\b"+avatar[i]+"\\b"))!==-1)return!0;return!1}for(i=avatar.length;i--;){var idx=acceptList.search(new RegExp("\\b"+avatar[i]+"\\b"));idx!==-1&&idx<listIndex&&(listIndex=idx,$scope.avatarType=avatar[i])}"COMPANY_ADMIN"!==$scope.avatarType&&"MANAGER"!==$scope.avatarType||($scope.data.selectedItem="teamPerformanceReport")}avatarCheckAndAssign(data.avatarTypes)?avatarCheckAndAssign(data.avatarTypes,!0):$location.path("/home")}),$scope.change=function(){"upcommingInterviews"===$scope.data.selectedItem||"pendingInterviews"===$scope.data.selectedItem?$scope.viewInterviews(0):"acceptedOffersCSV"===$scope.data.selectedItem?downloadAssignmentsCSVReport(["CANDIDATE_ACCEPTED","MANAGER_SETUP","PAYMENT_APPROVED"]):"pendingOffersCSV"===$scope.data.selectedItem?downloadAssignmentsCSVReport(["PENDING"]):"contractorsCSV"===$scope.data.selectedItem?downloadAssignmentsCSVReport(["ACTIVE"]):"piplelinesCSV"===$scope.data.selectedItem?downloadPipelineStatesCSVReport():"customPiplelinesCSV"===$scope.data.selectedItem?downloadCustomePipelineDemandCSVReport():"marketplaceMembersCSV"===$scope.data.selectedItem?downloadMMCSVReport():"allMarketplaceCandidatesCSV"===$scope.data.selectedItem?downloadAllMMCandidatesCSVReport():"hiresCountReport"===$scope.data.selectedItem?hiresCountReport():"metricsReport"===$scope.data.selectedItem?metricsReport():"pipelineConversion14CSV"===$scope.data.selectedItem&&pipelinesConversionCSVReport("14")},$scope.viewInterviews=function(page){$scope.UI.isLoading=!0;var interviewStatus=null,today=null;"pendingInterviews"===$scope.data.selectedItem?interviewStatus=["INITIAL"]:"upcommingInterviews"===$scope.data.selectedItem&&(interviewStatus=["CANDIDATE_ACCEPTED"],today=(new Date).toJSON().slice(0,10)),InterviewsService.list({avatarType:$scope.avatarType,status:interviewStatus,selectionStatus:["IN_PROGRESS","REINTERVIEW"],sortBy:"startDateTime",direction:"ASC",startdate:today,page:page},function(res){$scope.data.interviews=res.content,$scope.data.page=page,$scope.data.inteviewListSize=res.length,angular.forEach($scope.data.interviews,function(interview){var dateMoment=null;"pendingInterviews"===$scope.data.selectedItem?dateMoment=moment(interview.createdOn):"upcommingInterviews"===$scope.data.selectedItem&&(dateMoment=moment(interview.startDateTime));var date=moment.tz(dateMoment,"US/Eastern");interview.formatedDate=date.format("MMM DD, YYYY"),interview.formatedTime=date.format("hh:mm a")}),$scope.UI.isLoading=!1},function(err){$scope.UI.error=err.data.text,$scope.UI.isLoading=!1})},$scope.downloadInterviewsCSVReport=function(){$scope.UI.isLoading=!0;var param={downloadFormat:"CSV",avatarType:$scope.avatarType,selectionStatus:["IN_PROGRESS","REINTERVIEW"]};param.avatarType=$scope.avatarType,"pendingInterviews"===$scope.data.selectedItem?param.status=["INITIAL"]:"upcommingInterviews"===$scope.data.selectedItem&&(param.status=["CANDIDATE_ACCEPTED"],param.startdate=(new Date).toJSON().slice(0,10)),DownloadService.download("/interviews",param),$scope.UI.isLoading=!1};var downloadAssignmentsCSVReport=function(status){$scope.UI.isLoading=!0,DownloadService.download("/assignments",{downloadFormat:"CSV",status:status,avatarType:$scope.avatarType}),$scope.UI.isLoading=!1},downloadPipelineStatesCSVReport=function(){ReportingService.runPipelineStatesReport(),showMessage("alert-success","This report will take a couple of minutes for us to generate. We will send it your email on file."),hideMessage()},downloadCustomePipelineDemandCSVReport=function(){$scope.UI.isLoading=!0,DownloadService.download("/public/jobs",{downloadFormat:"CSV",custom:!0}),$scope.UI.isLoading=!1},pipelinesConversionCSVReport=function(conversionPeriod){ReportingService.runConversionReport({conversionPeriod:conversionPeriod}),showMessage("alert-success","This report will take a couple of minutes for us to generate. We will send it your email on file."),hideMessage()},downloadMMCSVReport=function(){$scope.UI.isLoading=!0,DownloadService.download("/marketplaceMembers",{downloadFormat:"CSV"}),$scope.UI.isLoading=!1},downloadAllMMCandidatesCSVReport=function(){$scope.UI.isLoading=!0,DownloadService.download("/reports/allMarketplaceCandidates"),$scope.UI.isLoading=!1},hiresCountReport=function(){ReportingService.runhiresCountReport(),showMessage("alert-success","This report will take a couple of minutes for us to generate. We will send it your email on file."),hideMessage()},metricsReport=function(){ReportingService.runMetricsReport(),showMessage("alert-success","This report will take a couple of minutes for us to generate. We will send it your email on file."),hideMessage()}}]),ctrls.controller("PipelineHealthReportCtrl",["JobService","CompaniesService","$q","CurrentUser",function(JobService,CompaniesService,$q,CurrentUser){function load(){vm.loading=JobService.crud.health(),vm.loading.$promise.then(function(res){vm.jobs=res}),CompaniesService.query({avatarType:vm.avatarType}).$promise.then(function(res){vm.companies=res.content||[],vm.companies.push({id:0,name:"Marketplace"});for(var promises=[],i=1;i<res.totalPages;i++)promises.push(CompaniesService.query({page:i}).$promise);$q.all(promises).then(function(r){angular.forEach(r,function(result){vm.companies=vm.companies.concat(result.content)})})})}function jobFilter(item){var mgr,colorMatch=!0,searchMatch=!0,companyMatch=!0,job=item.job;if(_.isEmpty(vm.color)||(colorMatch=item.color===vm.color),!_.isEmpty(vm.search)){var s=vm.search.toLowerCase();searchMatch=job.title.toLowerCase().indexOf(s)>=0,mgr=_.find(job.visibleManagers,function(mgr){return mgr.printableName.toLowerCase().indexOf(s)>=0}),void 0!==mgr&&(searchMatch=!0)}if(!_.isEmpty(vm.selectedCompanies)){var companyIds=_.map(vm.selectedCompanies,"id");mgr=_.find(job.visibleManagers,function(mgr){return _.contains(companyIds,mgr.company.id)}),companyMatch=void 0!==mgr||_.contains(companyIds,0)&&"GENERIC"===job.type}return colorMatch&&searchMatch&&companyMatch}var vm=this;vm.jobFilter=jobFilter,vm.color="",CurrentUser.get(function(data){data.avatarTypes.indexOf("ADMIN")>-1?vm.avatarType="ADMIN":data.avatarTypes.indexOf("ACCOUNT_MANAGER")>-1?vm.avatarType="ACCOUNT_MANAGER":data.avatarTypes.indexOf("RECRUITER")>-1&&(vm.avatarType="RECRUITER"),load()})}]),bandcampApp.directive("acrossCompanyLevelPerformanceReport",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"reports/performance/company-level-performance-report.tpl.html",controller:"AcrossCompanyLevelPerformanceReportCtrl"}}]),ctrls.controller("AcrossCompanyLevelPerformanceReportCtrl",["$scope","$q","$timeout","CompaniesService","ReportingService",function($scope,$q,$timeout,CompaniesService,ReportingService){var PAST_52_WEEKS=52,DEFAULT_OPTION={id:-1,name:"All Companies"};$scope.Period={WEEKLY:"WEEKLY",MONTHLY:"MONTHLY",QUARTERLY:"QUARTERLY"},$scope.period=$scope.Period.WEEKLY,$scope.generateReport=function(){var params={option:$scope.selectedCompany.name,companyId:$scope.selectedCompany===DEFAULT_OPTION?null:$scope.selectedCompany.id,
period:$scope.period,pastWeeks:PAST_52_WEEKS};ReportingService.runTeamPerformanceReport(params),$scope.hasRunReport=!0,$timeout(function(){$scope.hasRunReport=!1},5e3)};var queryAllCompanies=function(){$scope.isLoading=!1,$scope.selectedCompany=DEFAULT_OPTION;var internalCompanies=[{id:11,name:"Aurea"},{id:12,name:"Crossover"},{id:13,name:"Devfactory"},{id:40,name:"GFI"},{id:14,name:"Ignite"},{id:20,name:"Prologic"},{id:17,name:"Trilogy"},{id:21,name:"Trilogy Automotive"},{id:22,name:"Versata"}];$scope.companies=[DEFAULT_OPTION].concat(_.sortBy(internalCompanies,"name"))};$scope.isLoading=!0,queryAllCompanies()}]),bandcampApp.directive("companyLevelPerformanceReport",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"reports/performance/company-level-performance-report.tpl.html",controller:"CompanyLevelPerformanceReportCtrl"}}]),ctrls.controller("CompanyLevelPerformanceReportCtrl",["$scope","$q","$timeout","CompaniesService","ReportingService",function($scope,$q,$timeout,CompaniesService,ReportingService){var PAST_52_WEEKS=52,DEFAULT_OPTION={id:-1,name:"All Companies"};$scope.Period={WEEKLY:"WEEKLY",MONTHLY:"MONTHLY",QUARTERLY:"QUARTERLY"},$scope.period=$scope.Period.WEEKLY,$scope.generateReport=function(){var params={option:$scope.selectedCompany.name,companyId:$scope.selectedCompany===DEFAULT_OPTION?null:$scope.selectedCompany.id,period:$scope.period,pastWeeks:PAST_52_WEEKS};ReportingService.runTeamPerformanceReport(params),$scope.hasRunReport=!0,$timeout(function(){$scope.hasRunReport=!1},5e3)};var queryAllCompanies=function(){var allRequestDone=$q.defer();return CompaniesService.query().$promise.then(function(res){for(var promises=[],i=0;i<res.totalPages;i++)promises.push(CompaniesService.query({page:i}).$promise);$q.all(promises).then(function(otherPages){var companies=_.chain(otherPages).map("content").flatten().value();allRequestDone.resolve(companies)})}),allRequestDone.promise};$scope.isLoading=!0,queryAllCompanies().then(function(companies){$scope.isLoading=!1,$scope.selectedCompany=DEFAULT_OPTION,$scope.companies=[DEFAULT_OPTION].concat(_.sortBy(companies,"name"))})}]),bandcampApp.directive("teamLevelPerformanceReport",["routePrefix",function(routePrefix){return{restrict:"E",templateUrl:routePrefix+"reports/performance/team-level-performance-report.tpl.html",controller:"TeamLevelPerformanceReportCtrl"}}]),ctrls.controller("TeamLevelPerformanceReportCtrl",["$scope","$q","$timeout","ReportingService","TeamService",function($scope,$q,$timeout,ReportingService,TeamService){var PAST_52_WEEKS=52,DEFAULT_OPTION={id:-1,name:"All Teams"};$scope.Period={WEEKLY:"WEEKLY",MONTHLY:"MONTHLY",QUARTERLY:"QUARTERLY"},$scope.period=$scope.Period.WEEKLY,$scope.generateReport=function(){var params={option:$scope.selectedTeam.name,teamId:$scope.selectedTeam===DEFAULT_OPTION?null:$scope.selectedTeam.id,period:$scope.period,pastWeeks:PAST_52_WEEKS};ReportingService.runTeamPerformanceReport(params),$scope.hasRunReport=!0,$timeout(function(){$scope.hasRunReport=!1},5e3)},$scope.isLoading=!0,TeamService.teamsManagersMap().$promise.then(function(teams){$scope.isLoading=!1,$scope.selectedTeam=DEFAULT_OPTION,$scope.teams=[DEFAULT_OPTION].concat(_.sortBy(teams,"name"))})}]),ctrls.controller("ResourcesCtrl",["$scope","$route","$routeParams","uploadedDocsUrl",function($scope,$route,$routeParams,uploadedDocsUrl){$scope.ui={isLoading:!0},$scope.cName=$routeParams.name;var cName=$routeParams.name,path=uploadedDocsUrl+"/documents/";$scope.documents={bestPractices:path+"best_practices.md",candidate_faq:path+"candidate_faq.md",manager_faq:path+"manager_faq.md"},$scope.faq=$scope.documents[cName+"_faq"],$scope.bestPractices=$scope.documents.bestPractices,$scope.blankConvert=function(){var targets=angular.element(".bestPractices p a");angular.forEach(targets,function(item){item.setAttribute("target",item.getAttribute("title")),item.removeAttribute("title")})},$scope.expandFAQ=function(){$scope.ui.isLoading=!1,angular.element(".faqBlock div > ul > li").append('<i class="cIcon ciArrow">');var targets=angular.element(".faqBlock div > ul > li,.faqBlock div > ul > li > p");targets.bind("click",function(item){if(item.target===this){var target;target="p"===item.target.localName?item.target.offsetParent:this,angular.element(target).toggleClass("expaned").children("ul").slideToggle()}})}}]),ctrls.controller("SettingsCompanyStaffCtrl",["$scope","TeamMembersService","EnumsService","CurrentUser","$routeParams",function($scope,TeamMembersService,EnumsService,CurrentUser,$routeParams){EnumsService.get(function(data){$scope.enums=data}),CurrentUser.get(function(data){$scope.user=data}),$scope.currentTeamId=null,$scope.selected={id:void 0},$scope.refresh=function(){$scope.show=!1,$scope.potentialHiringManagers=null,$scope.selectedHiringManagerId=null,angular.isDefined($routeParams.id)&&($scope.edit=!0,TeamMembersService.getTeamView({teamId:$routeParams.id},function(data){$scope.data=data,$scope.show=!0},function(response){$scope.show=!1,$scope.setMessage("alert-danger",response.data.text)}),TeamMembersService.getPotentialHiringManagers({teamId:$routeParams.id},function(data){$scope.potentialHiringManagers=data},function(response){$scope.setMessage("alert-danger",response.data.text)}))},$scope.refresh(),$scope.messageShow=!1,$scope.setMessage=function(clazz,message){$scope.message=message,$scope.messageShow=!0,$scope.messageClass="alert "+clazz},$scope.revert=function(){$scope.data=$scope.original,$scope.original=angular.copy($scope.original),$scope.show=!1,$scope.setMessage("alert-success","Changes reverted!"),$scope.show=!0},$scope.addSelectedHiringManager=function(){var data={teamId:$routeParams.id,userId:$scope.selectedHiringManagerId};$scope.setMessage("alert-info","Adding hiring manager.."),$scope.show=!1,TeamMembersService.addHiringManager(data,function(){$scope.setMessage("alert-success","Hiring manager added!"),$scope.refresh()},function(response){$scope.show=!0,$scope.setMessage("alert-warning",response.data.text)})},$scope["delete"]=function(teamId,memberId){var data={teamId:teamId,memberId:memberId};$scope.setMessage("alert-info","Deleting member.."),$scope.show=!1,TeamMembersService["delete"](data,function(){$scope.setMessage("alert-success","Member deleted!"),$scope.refresh()},function(response){$scope.show=!0,$scope.setMessage("alert-warning",response.data.text)})},$scope.update=function(team){$scope.show=!1,$scope.setMessage("alert-info","Saving data.."),TeamMembersService.put(team,function(){$scope.setMessage("alert-success","Changes saved!"),$scope.original=angular.copy($scope.data),$scope.show=!0},function(response){$scope.setMessage("alert-warning",response.data.text),$scope.show=!0})}}]),ctrls.controller("SettingsCompanyTeamsEditCtrl",["$scope","TeamService","$routeParams","$upload","baseUrl","$uibModal","Flash","$cacheFactory",function($scope,TeamService,$routeParams,$upload,baseUrl,$uibModal,Flash,$cacheFactory){function doUpload(file){$scope.ui.isUploading=!0,$scope.ui.progress=0,$upload.upload({url:baseUrl+"/teams/"+$scope.data.id+"/agreements",fileFormDataName:"file",file:file}).success(function(savedFileName){$scope.ui.isUploading=!1,$scope.data.agreements=$scope.data.agreements||[],$scope.data.agreements.push({fileName:file.name,url:savedFileName})}).error(function(e){$scope.ui.isUploading=!1,e.data&&e.data.text?$scope.setMessage("alert-danger",e.data.text):$scope.setMessage("alert-danger",e)}).progress(function(e){e.lengthComputable&&($scope.ui.progress=Math.round(e.loaded/e.total*100))})}$scope.edit=!1,$scope.data={},$scope.file=null,$scope.ui={isLoading:!0,isUploading:!1,isWrongFileType:!1,isFileSizeExceeded:!1,progress:0},$scope.messageShow=!1,$scope.messageClass="",$scope.message="",$scope.show=!0,$scope.uploadTip="Save the team before adding agreements.",$scope.setMessage=function(clazz,message){$scope.message=message,$scope.messageShow=!0,$scope.messageClass="alert "+clazz},$scope.upload=function($files){if($files&&1===$files.length){if($scope.ui.isWrongFileType=!1,$scope.ui.isFileSizeExceeded=!1,$scope.file=$files[0],!/^.+\.md$/.test($scope.file.name))return void($scope.ui.isWrongFileType=!0);$scope.ui.isWrongFileType=!1;var SIZE_LIMIT=2097152;return $scope.file.size>SIZE_LIMIT?void($scope.ui.isFileSizeExceeded=!0):void doUpload($scope.file)}},$scope["delete"]=function(agreement){var modalInstance=$uibModal.open({templateUrl:"agreement-delete-confirmation.tpl.html",controller:"DeleteAgreementCtrl",windowClass:"center-modal",resolve:{agreement:function(){return agreement},team:function(){return $scope.data}}});modalInstance.result.then(function(){$scope.photoExists=!1,$scope.profilePhotoUrl="/images/1f34682a.user.png"})},angular.isDefined($routeParams.id)?($scope.edit=!0,$scope.uploadTip="Markdown only. Max 2MB.",TeamService.get({id:$routeParams.id},function(data){$scope.data=data,$scope.ui.isLoading=!1})):$scope.ui.isLoading=!1,$scope.save=function(data){if(data.name){$scope.ui.isLoading=!0;var team=angular.copy(data);team.agreements=(team.agreements||[]).filter(function(x){return!x.isDeleted}),$scope.edit?TeamService.update({id:$routeParams.id},team,function(result){$scope.data=result,$scope.ui.isLoading=!1,Flash.addSuccess("Changes saved!","settings/company/teams"),$cacheFactory.get("$http").removeAll()},function(response){$scope.ui.isLoading=!1,$scope.setMessage("alert-danger",response.data.text)}):TeamService.create({avatarType:"COMPANY_ADMIN"},team,function(result){$scope.data=result,$scope.ui.isLoading=!1,Flash.addSuccess("Team created successfully!","settings/company/teams"),$cacheFactory.get("$http").removeAll()},function(response){$scope.ui.isLoading=!1,$scope.setMessage("alert-danger",response.data.text)})}}}]),ctrls.controller("DeleteAgreementCtrl",["$scope","$uibModalInstance","TeamService","team","agreement",function($scope,$uibModalInstance,TeamService,team,agreement){$scope.team=team,$scope.agreement=agreement,$scope.confirm=function(){TeamService.deleteAgreement({id:$scope.team.id,originalFilename:$scope.agreement.fileName}).$promise.then(function(){$scope.team.agreements=$scope.team.agreements||[];var index=$scope.team.agreements.indexOf(agreement);$scope.team.agreements.splice(index,1),$uibModalInstance.close()})},$scope.cancel=function(){$uibModalInstance.close()}}]),ctrls.controller("SettingsUserPasswordCtrl",["$scope","$rootScope","CurrentUser",function($scope,$rootScope,CurrentUser){$scope.user=CurrentUser.get();var initData={oldPassword:"",newPassword:"",confirmedPassword:""};$scope.data=angular.copy(initData),$scope.ui={isLoading:!1},$scope.PASSWORD_REGEXP=/^(?=.*[^a-zA-Z])(?=.*[a-zA-Z]).{8,64}$/,$scope.messageShow=!1,$scope.messageClass="",$scope.message="";var setMessage=function(clazz,message){$scope.message=message,$scope.messageShow=!0,$scope.messageClass="alert "+clazz};$scope.update=function(form){form.$invalid||$scope.data.newPassword!==$scope.data.confirmedPassword||($scope.ui.isLoading=!0,CurrentUser.updatePassword($scope.data,function(data){$rootScope.setAuthToken(data.token),setMessage("alert-success","Password is updated!"),$scope.data=angular.copy(initData),form.$setPristine(),$scope.ui.isLoading=!1},function(response){setMessage("alert-warning",response.data.text),$scope.ui.isLoading=!1}))}}]),ctrls.controller("ChangeEmailCtrl",["$scope","$uibModalInstance","EmailUpdateService","CurrentUser","currentEmail",function($scope,$uibModalInstance,EmailUpdateService,CurrentUser,currentEmail){$scope.setError=function(clazz,message){$scope.message=message,$scope.messageShow=!0,$scope.messageClass=clazz},$scope.clearError=function(){$scope.messageShow=!1},$scope.currentEmail=currentEmail,$scope.ui={isLoading:!1,emptyEmail:!1},$scope.confirm=function(){return $scope.emailForm.$error.required?void($scope.ui.emptyEmail=!0):void($scope.emailForm.email.$valid&&($scope.ui.isLoading=!0,EmailUpdateService.post({email:$scope.newEmail},function(data){angular.isObject(data)?$uibModalInstance.close():($scope.setError("danger","There was error with email update. "+data.text),$scope.show=!0)},function(response){$scope.setError("danger",response.data.text),$scope.show=!0}).$promise["finally"](function(){CurrentUser.clearCache(),$scope.ui.isLoading=!1})))},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.emailFieldActive=function(){return"newEmail"===document.activeElement.id}}]),ctrls.controller("SettingsUserSecurityCtrl",["$scope","EnumsService","CurrentUser",function($scope,EnumsService,CurrentUser){var setMessage=function(clazz,message){$scope.message=message,$scope.messageShow=!0,$scope.messageClass="alert "+clazz};$scope.messageShow=!1,$scope.messageClass="",$scope.message="",$scope.enums=EnumsService.get(),$scope.user=CurrentUser.get(),$scope.ui={isLoading:!1};var initData={oldAnswer:"",newQuestion:"",newAnswer:"",customQuestion:""};$scope.data=angular.copy(initData),$scope.submit=function(form){if(!form.$invalid){var req=angular.copy($scope.data);"other"===req.newQuestion&&req.customQuestion&&(req.newQuestion=req.customQuestion),$scope.ui.isLoading=!0,CurrentUser.updateSecurityQuestion(req).$promise.then(function(data){$scope.user=data,$scope.data=angular.copy(initData),CurrentUser.clearCache(),CurrentUser.get(),setMessage("alert-success","Security question is updated!")})["catch"](function(err){setMessage("alert-warning",err.data.text)})["finally"](function(){$scope.ui.isLoading=!1})}}}]),ctrls.controller("UserSettingsCtrl",["$scope","CurrentUser","ProfileUtils","fileReader","uploadedDocsUrl","CandidatesService","TimezonesService","CountriesService","PasswordUpdateService","AuthenticationFactory","$rootScope","$timeout","EnumsService","baseUrl","$location","$uibModal","ManagerService","PaymentDestinationsService","GoogleLocationService","googleCalendarIntegrationSettings","AssignmentService",function($scope,CurrentUser,ProfileUtils,fileReader,uploadedDocsUrl,CandidatesService,TimezonesService,CountriesService,PasswordUpdateService,AuthenticationFactory,$rootScope,$timeout,EnumsService,baseUrl,$location,$uibModal,ManagerService,PaymentDestinationsService,GoogleLocationService,googleCalendarIntegrationSettings,AssignmentService){function init(){CurrentUser.clearCache(),CurrentUser.get(function(user){TimezonesService.query(function(timezones){CountriesService.query(function(countries){$scope.data.timezones=timezones,$scope.data.filteredTimezones=timezones,$scope.data.countries=countries,$scope.me=user,$scope.profilePhotoUrl=ProfileUtils.profilePhotoUrl(user),$scope.data.selectedCountryId=user.location.country.id,$scope.data.selectedTimeZoneId=user.location.timeZone.id,$scope.changeCountry(),user.avatarTypes.indexOf("CANDIDATE")>-1?PaymentDestinationsService.query({},function(data){$scope.data.payoneerActive=data.reduce(function(ret,x){return ret||"PAYONEER"===x.kind&&"ACTIVE"===x.status},!1),$scope.data.payoneerActive||($scope.data.trackerAccountCreated=angular.isDefined($scope.me.dfcUserId))}).$promise["finally"](function(){$scope.ui.isLoading=!1}):$scope.ui.isLoading=!1})})}).$promise["catch"](function(err){$scope.ui.isLoading=!1,$scope.isError=!0,$scope.setError("danger",err.data.text)})}function googlePlatformOnLoad(){}function googleClientOnLoad(){gapi=window.gapi,gapi.load("client",function(){gapi.load("auth",function(){gapi.auth.signOut()})})}function loadScript(url,callback){var head=document.getElementsByTagName("head")[0],script=document.createElement("script");script.type="text/javascript",script.src=url,script.onload=callback,head.appendChild(script)}$scope.PASSWORD_REGEXP=/^(?=.*[^a-zA-Z])(?=.*[a-zA-Z]).{8,64}$/,$scope.ui={isLoading:!0},$scope.data={countries:[],timezones:[],filteredTimezones:[],selectedCountryId:null,selectedTimeZoneId:null,payoneerActive:!1},$scope.enums=EnumsService.get(),$scope.setError=function(clazz,message){$scope.message1=message,$scope.message1Show=!0,$scope.message1Class=clazz},init(),$scope.options={types:"(cities)",watchEnter:!0},$scope.$watch("data.selectedCountryId",function(newValue,oldValue){"undefined"!=typeof oldValue&&null!==oldValue&&oldValue!==newValue&&(delete $scope.me.location.city,delete $scope.me.location.state)}),$scope.changeCity=function(){if(void 0!==$scope.me.location.city){var c=GoogleLocationService.getCity($scope.me.location.city);$scope.me.location.city=c.city,$scope.me.location.state=c.state}},$scope.changeCountry=function(){var c=$scope.data.countries.filter(function(x){return x.id===$scope.data.selectedCountryId})[0];if($scope.options.country=c.code,$scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.selectedTimeZoneId=c.timezones[0].id;else if($scope.data.selectedTimeZoneId){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.selectedTimeZoneId},!1);isIncluded||($scope.data.selectedTimeZoneId=null)}},$scope.changeTimezone=function(){var tz=$scope.data.timezones.filter(function(x){return x.id===$scope.data.selectedTimeZoneId})[0];1===tz.countries.length&&($scope.data.selectedCountryId=tz.countries[0].id,$scope.options.country=tz.countries[0].code)},$scope.cancel=function(){init()},$scope.setSuccess=function(clazz,message){$scope.message=message,$scope.messageShow=!0,$scope.messageClass=clazz},$scope.$watch("tab",function(){$scope.isError=$scope.isSuccessful=!1});var setTab=function(){$scope.isError=$scope.isSuccessful=!1;var tab1=$location.search().tab;$scope.tab="GENERAL","general"===tab1?$scope.tab="GENERAL":"advanced"===tab1&&($scope.tab="ADVANCED")};setTab(),$scope.submitUser=function(form){if($scope.messageShow=!1,$scope.message1Show=!1,$scope.$broadcast("show-errors-check-validity"),!form||form.$valid){$scope.ui.isLoading=!0,$scope.details&&($scope.me.location.latLong=$scope.details.geometry.location.lat()+","+$scope.details.geometry.location.lng()),_.isEmpty($scope.me.location.phone)&&($scope.me.location.phone=void 0);var promise;"accountForm"===form.$name?promise=CurrentUser.updateAccountInfo({firstName:$scope.me.firstName,lastName:$scope.me.lastName}).$promise:"locationForm"===form.$name?promise=CurrentUser.updateLocation({phone:$scope.me.location.phone,zip:$scope.me.location.zip,city:$scope.me.location.city,state:$scope.me.location.state,address:$scope.me.location.address,latLong:$scope.me.location.latLong,country:{id:$scope.data.selectedCountryId},timeZone:{id:$scope.data.selectedTimeZoneId||$scope.me.location.timeZone.id}}).$promise:"calendarForm"===form.$name&&(promise=AssignmentService.updateGoogleCalendar({id:$scope.me.id,googleCalendarEmail:$scope.me.googleCalendarEmail,googleCalendarId:$scope.me.googleCalendarId,googleAuthCode:$scope.me.googleAuthCode}).$promise);var errorHandler=function(err){$scope.isError=!0,$scope.setError("danger",err.data.text)};angular.isDefined(promise)&&(promise["catch"](errorHandler),promise.then(function(){$scope.isSuccessful=!0,"calendarForm"===form.$name?$scope.setSuccess("success","Your calendar was successfully linked!"):$scope.setSuccess("success","Your data was successfully changed!")}),promise["finally"](function(){$scope.ui.isLoading=!1,CurrentUser.clearCache()}))}},$scope.readFile=function(){fileReader.readAsDataUrl($scope.file,$scope).then(function(result){$scope.profilePhotoUrl=result}),ProfileUtils.uploadProfilePhoto($scope.me,$scope.file,function(createdFileName){$scope.me.photoUrl=uploadedDocsUrl+"/images/"+createdFileName,$scope.updateProfile($scope.me)})},$scope.updateProfile=function(data){CandidatesService.update({id:$scope.me.id},data).$promise.then(function(){CurrentUser.clearCache()})},$scope.userSecurity={oldAnswer:"",newQuestion:"",newAnswer:"",customQuestion:""},$scope.submitUserAdvanced=function(){$scope.messageShow=!1,$scope.message1Show=!1,"other"===$scope.userSecurity.newQuestion&&$scope.userSecurity.customQuestion&&($scope.userSecurity.newQuestion=$scope.userSecurity.customQuestion),delete $scope.userSecurity.customQuestion;var userPromise=CurrentUser.updateSecurityQuestion($scope.userSecurity).$promise,errorHandler=function(err){$scope.isError=!0,$scope.setError("danger",err.data.text)};userPromise["catch"](errorHandler),userPromise.then(function(){$scope.setSuccess("success","Your data was successfully changed!"),$scope.show=!0,CurrentUser.clearCache()})},$scope.update=function(){$scope.messageShow=!1,$scope.message1Show=!1,$scope.data.newPassword===$scope.data.newPasswordRetype&&($scope.passChangeForm.$valid?($scope.show=!1,$scope.ui.isLoading=!0,PasswordUpdateService.post($scope.data,function(data){if(angular.isObject(data)&&angular.isDefined(data.token)){var authToken=data.token;$rootScope.setAuthToken(authToken),$scope.setSuccess("success","Password was successfully changed!"),$scope.data.oldPassword=$scope.data.newPassword=$scope.data.newPasswordRetype="",$timeout(function(){$scope.passChangeForm.$setPristine(),angular.element(angular.element(document.getElementsByName("passChangeForm"))[0].querySelector(".has-error")).removeClass("has-error")},100)}else $scope.setError("danger","There was an error with password update. "+data.text),$scope.show=!0},function(response){$scope.setError("danger","There was an error with password update. "+response.data.text),$scope.show=!0}).$promise["finally"](function(){CurrentUser.clearCache(),$scope.ui.isLoading=!1})):$scope.passchangeForm["new"].$error.minlength?($scope.setError("danger","The new password must have at least 8 characters!"),$scope.show=!0):($scope.setError("danger","Form contains mistakes!"),$scope.show=!0))},$scope.changeEmail=function(){$uibModal.open({templateUrl:"change-email-modal.tpl.html",controller:"ChangeEmailCtrl",resolve:{currentEmail:function(){return $scope.me.email}}})},$scope.addPhoto=function(profile){var modalInstance=$uibModal.open({templateUrl:"add-photo-modal.tpl.html",controller:"AddProfilePhotoCtrl",size:"lg",resolve:{profile:function(){return profile}}});modalInstance.result.then(function(photoUrl){$scope.profilePhotoUrl=photoUrl,$scope.photoExists=!0,$scope.me.photoUrl=photoUrl})},$scope.data.googleAccount="",$scope.data.googleCalendars=[],$scope.data.selectedCalendar="";var gapi;$scope.authorizeGoogleCalendar=function(){var config={client_id:googleCalendarIntegrationSettings.CLIENT_ID,scope:googleCalendarIntegrationSettings.SCOPES,immediate:googleCalendarIntegrationSettings["false"],hd:googleCalendarIntegrationSettings.DOMAIN,authuser:googleCalendarIntegrationSettings.AUTH_USER,access_type:googleCalendarIntegrationSettings.ACCESS_TYPE,response_type:googleCalendarIntegrationSettings.RESPONSE_TYPE,approval_prompt:googleCalendarIntegrationSettings.APPROVAL_PROMPT};gapi.auth.authorize(config,function(){var tokenObject=gapi.auth.getToken();$scope.me.googleAuthCode=tokenObject.code,gapi.client.load("plus","v1",function(){var request=gapi.client.plus.people.get({userId:"me"});request.execute(function(resp){$scope.data.googleAccount=resp.emails[0].value,$scope.me.googleCalendarEmail=resp.emails[0].value})}),gapi.client.load("calendar","v3",function(){var request=gapi.client.calendar.calendarList.list();request.execute(function(resp){$scope.data.googleCalendars=[],angular.forEach(resp.items,function(calendarItem){$scope.data.googleCalendars.push(calendarItem)})})})})},window.gapi?googleClientOnLoad():(loadScript(googleCalendarIntegrationSettings.PLATFORM_JS,googlePlatformOnLoad),loadScript(googleCalendarIntegrationSettings.CLIENT_ID,googleClientOnLoad)),$scope.unlinkCalendar=function(){var promise=AssignmentService.unlinkGoogleCalendar({id:$scope.me.id}).$promise,errorHandler=function(err){$scope.isError=!0,$scope.setError("danger",err.data.text)};angular.isDefined(promise)&&(promise["catch"](errorHandler),promise.then(function(){$scope.isSuccessful=!0,$scope.setSuccess("success","Your calendar was successfully unlinked!")}),promise["finally"](function(){$scope.ui.isLoading=!1,CurrentUser.clearCache()}))}}]),ctrls.controller("VerifyNewEmailCtrl",["$scope","UserService","$routeParams","$rootScope",function($scope,UserService,$routeParams,$rootScope){function loaded(){$scope.ui.isSuccessed=!0,$scope.ui.isLoading=!1}var vm=this;$scope.data={startUrl:"settings/account-info",email:""},$scope.ui={isLoading:!0,isSuccessed:!1,isBadToken:!1,isTokenExpired:!1,isUnknownError:!1},vm.init=function(){UserService.verifyEmailUpdate({token:$routeParams.token}).$promise.then(function(data){var authToken=data.token;$rootScope.setAuthToken(authToken),loaded()},function(response){switch(response.data.errorCode){case"CROS-0022":$scope.ui.isBadToken=!0;break;case"CROS-0023":$scope.ui.isTokenExpired=!0;break;default:$scope.ui.isUnknownError=!0}$scope.ui.isLoading=!1})},vm.init()}]),ctrls.controller("SignupLocationCtrl",["$scope","$location","CurrentUser","CandidatesService","CountriesService","TimezonesService",function($scope,$location,CurrentUser,CandidatesService,CountriesService,TimezonesService){$scope.ui={isLoading:!0},$scope.data={countries:CountriesService.query(),filteredTimezones:TimezonesService.query(),proceed:!1,location:{}},CurrentUser.getAvatar({avatarType:"CANDIDATE"},function(data){data.location&&data.location.city&&$location.path("/candidate/dashboard/home"),data.location&&($scope.data.selectedCountryId=data.location.country.id,$scope.data.selectedTimeZoneId=data.location.timeZone.id),$scope.data.profile=data,$scope.ui.isLoading=!1}),$scope.options={types:"(cities)",watchEnter:!0},$scope.clearCity=function(){$scope.data.location={}},$scope.$watch("data.selectedCountryId",function(newValue,oldValue){oldValue!==newValue&&$scope.clearCity()}),$scope.changeCity=function(){if(void 0!==$scope.data.location.city){$scope.data.profile.location.state="";var partsOfStr=$scope.data.location.city.split(",");void 0!==partsOfStr[0]&&($scope.data.location.city=partsOfStr[0].trim()),void 0!==partsOfStr[1]&&partsOfStr.length>2&&($scope.data.profile.location.state=partsOfStr[1].trim())}},$scope.changeCountry=function(){var c=$scope.data.countries.filter(function(x){return x.id===$scope.data.selectedCountryId})[0];if($scope.options.country=c.code,$scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.selectedTimeZoneId=c.timezones[0].id;else if($scope.data.selectedTimeZoneId){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.selectedTimeZoneId},!1);isIncluded||($scope.data.selectedTimeZoneId=null)}},$scope.changeTimezone=function(){var tz=$scope.data.filteredTimezones.filter(function(x){return x.id===$scope.data.selectedTimeZoneId})[0];1===tz.countries.length&&($scope.data.selectedCountryId=tz.countries[0].id,$scope.options.country=tz.countries[0].code)},$scope.$on("$locationChangeStart",function(event,url){$scope.proceed||url.indexOf("logout")!==-1||event.preventDefault()}),$scope.next=function(){$scope.contact.$valid&&($scope.data.profile.location.country={id:$scope.data.selectedCountryId},$scope.data.profile.location.timeZone={id:$scope.data.selectedTimeZoneId},void 0!==$scope.details&&($scope.data.profile.location.latLong=$scope.details.geometry.location.lat()+","+$scope.details.geometry.location.lng()),$scope.data.profile.location.city=$scope.data.location.city,$scope.data.profile.location.state=$scope.data.location.state,CandidatesService.update({id:$scope.data.profile.id},$scope.data.profile).$promise.then(function(){$scope.proceed=!0,$location.path("/candidate/dashboard/home")}))}}]),ctrls.controller("SignupSecurityCtrl",["$scope","$location","EnumsService","CurrentUser",function($scope,$location,EnumsService,CurrentUser){$scope.ui={isLoading:!1},$scope.data={updated:!1,userSecurity:{}},$scope.$on("$locationChangeStart",function(event,next){next.indexOf("logout")===-1&&($scope.data.updated||event.preventDefault())}),EnumsService.get(function(res){$scope.data.securityQuestions=res.securityQuestions}),$scope.submit=function(){var d=$scope.data;"other"===d.userSecurity.newQuestion&&d.customQuestion&&(d.userSecurity.newQuestion=d.customQuestion),$scope.ui.isLoading=!0,CurrentUser.updateSecurityQuestion(d.userSecurity,function(){$scope.data.updated=!0,$location.path("/manager/dashboard/home")},function(err){$scope.ui.error=err.data.text,$scope.ui.isLoading=!1})}}]),ctrls.controller("UserVerifyCtrl",["$scope","UserService","GlobalDataFactory","$location",function($scope,UserService,GlobalDataFactory,$location){$scope.ui={isLoading:!1},$scope.user={email:$location.search().email},GlobalDataFactory.setItem("currentStep",1),$scope.resend=function(){angular.isDefined($scope.user)&&($scope.ui.isLoading=!0,UserService.resendActivation({email:$scope.user.email}).$promise["finally"](function(){$scope.ui.isLoading=!1}))}}]),ctrls.controller("VerifyEmailCtrl",["$scope","UserService","$routeParams","$rootScope","CurrentUser","JobApplicationService",function($scope,UserService,$routeParams,$rootScope,CurrentUser,JobApplicationService){function loaded(){$scope.ui.isSuccessed=!0,$scope.ui.isLoading=!1}function redirectApplication(app){"NATIVE"===app.applicationType&&JobApplicationService.get({id:app.id,avatarType:"CANDIDATE"},function(res){JobApplicationService.identifyCurrentStep(res,"verify-email")})}var vm=this;$scope.data={startUrl:"#",email:""},$scope.ui={isLoading:!0,isSuccessed:!1,isBadToken:!1,isTokenExpired:!1,isAlreadyActive:!1,isUnknowError:!1,isResent:!1,invalidEmail:!1},vm.init=function(){UserService.activate({token:$routeParams.token}).$promise.then(function(data){var authToken=data.token;$rootScope.setAuthToken(authToken),CurrentUser.get().$promise.then(function(user){var isCompany=user.profile?!user.profile.band:user.company;if($scope.data.startUrl=isCompany?"manager/dashboard/home":"contractor/home",isCompany)loaded();else{var getAppRequest=JobApplicationService.getApplications({avatarType:"CANDIDATE"}).$promise;getAppRequest.then(function(res){res.content&&res.content.length>0&&redirectApplication(res.content[0])}),getAppRequest["finally"](loaded)}})},function(data){switch(data.data.errorCode){case"CROS-0022":$scope.ui.isBadToken=!0;break;case"CROS-0023":$scope.ui.isTokenExpired=!0;break;case"CROS-0071":$scope.ui.isAlreadyActive=!0;break;case"CROS-7009":case"CROS-7004":$scope.ui.testExists=!0;break;default:$scope.ui.isUnknowError=!0}$scope.ui.isLoading=!1})},vm.init(),$scope.resend=function(){$scope.ui.isLoading=!0;var resendActivationRequest=UserService.resendActivation({email:$scope.data.email}).$promise;resendActivationRequest.then(function(){$scope.ui.isResent=!0,$scope.ui.isTokenExpired=!1},function(err){switch(err.data.cause){case"NotFoundException":$scope.ui.invalidEmail=!0;break;default:$scope.ui.isUnknowError=!0}}),resendActivationRequest["finally"](function(){$scope.ui.isLoading=!1})}}]),ctrls.controller("TeamContractsCtrl",["$scope","AssignmentService",function($scope,AssignmentService){function loadAssignments(page){$scope.ui.isLoading=!0,$scope.ui.page.current=page,AssignmentService.query({page:page-1},function(data){$scope.data.assignments=data.content||[],$scope.ui.page.total=data.totalPages,$scope.ui.page.totalElements=data.totalElements,$scope.ui.isLoading=!1})}$scope.data={assignments:[]},$scope.ui={isLoading:!0,page:{current:1}},$scope.changePage=function(){loadAssignments($scope.ui.page.current)},loadAssignments(1)}]),ctrls.controller("SetupTeamCtrl",["$scope","ManagerInvitationService","ManagerService","baseUrl","$uibModal",function($scope,ManagerInvitationService,ManagerService,baseUrl,$uibModal){function openModal(){var modalInstance=$uibModal.open({templateUrl:"invite-manager.tpl.html",controller:"InviteHiringManagerModalCtrl",backdrop:"static",resolve:{managers:function(){return $scope.managers}}});modalInstance.result.then(function(manager){$scope.setMessage(),ManagerInvitationService.save(manager,function(){$scope.setMessage("Invitation is made successfully to HM.","success")},function(err){$scope.setMessage(err.data.text,"danger")}).$promise["finally"](function(){$scope.init()})})}$scope.msg={},$scope.ui={isLoading:!0},$scope.setMessage=function(text,type){$scope.msg.text=text,$scope.msg.type=type},$scope.init=function(){$scope.ui.isLoading=!0,ManagerService.query(function(res){$scope.managers=res,$scope.managers.forEach(function(manager){
manager.resendDisabled=!0}),ManagerInvitationService.query(function(invitations){invitations.forEach(function(invitation){$scope.managers.push(invitation)})}).$promise["finally"](function(){$scope.ui.isLoading=!1})},function(err){$scope.managers=[],$scope.setMessage(err.data.text,"danger"),$scope.ui.isLoading=!1})},$scope.add=function(){openModal()},$scope.resend=function(invitation){ManagerInvitationService.resend({id:invitation.id},function(){invitation.resendDisabled=!0})},$scope.init()}]),ctrls.controller("InviteHiringManagerModalCtrl",["$scope","$uibModalInstance",function($scope,$uibModalInstance){function isPropertySet(property){return property&&property.length>0}function verifyManager(manager){return isPropertySet(manager.firstName)&&isPropertySet(manager.lastName)&&isPropertySet(manager.email)}$scope.manager={},$scope.submit=function(invitation){invitation=invitation||{},verifyManager(invitation)&&$uibModalInstance.close(invitation)},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),ctrls.controller("MarketplaceAgreementCtrl",["$scope","$rootScope","$location","uploadedDocsUrl","CurrentUser","CandidatesService",function($scope,$rootScope,$location,uploadedDocsUrl,CurrentUser,CandidatesService){$scope.ui={isLoading:!0},$scope.agreed=!1,$scope.agreement=uploadedDocsUrl+"/documents/agreement.md",$scope.$on("$locationChangeStart",function(event){$scope.agreed||event.preventDefault()}),$scope.next=function(){$scope.agreed&&CurrentUser.getAvatar({avatarType:"CANDIDATE"},function(user){CurrentUser.clearCache(),user.agreementAccepted=!0,CandidatesService.update({id:user.id},user).$promise.then(function(){$location.path("/signup/location")})})}}]),ctrls.controller("StaticAgreementCtrl",["$scope","uploadedDocsUrl",function($scope,uploadedDocsUrl){$scope.agreement=uploadedDocsUrl+"/documents/agreement.md"}]),ctrls.controller("CustomPipelinesCtrl",["$scope","CurrentUser","JobService","DownloadService","MarketplaceMembersService","JobApplicationService","$location","$routeParams",function($scope,CurrentUser,JobService,DownloadService,MarketplaceMembersService,JobApplicationService,$location,$routeParams){$scope.data={selectedJob:null,mmStatuses:[{label:"AVAILABLE",value:"AVAILABLE"},{label:"ASSIGNED",value:"ASSIGNED"},{label:"INACTIVE",value:"INACTIVE"}]},$scope.ui={isLoading:!0,pagination:{}},$scope.showFile=function(appId,applicationFile){JobApplicationService.getFileUrl(appId,applicationFile.id).success(function(url){DownloadService.downloadFile(url)})},CurrentUser.get(function(data){data.avatarTypes.indexOf("ACCOUNT_MANAGER")===-1&&$location.path("/home"),JobService.crud.list().$promise.then(function(jobs){if($scope.data.jobs=jobs,$routeParams.jobId){var jobId=Number($routeParams.jobId);angular.forEach(jobs,function(job){job.id===jobId&&($scope.data.selectedJob=job,$scope.jobChanged(job))})}})["finally"](function(){$scope.ui.isLoading=!1})}),$scope.jobChanged=function(job,status){$scope.ui.isLoading=!0;var sval=null;"undefined"!=typeof status&&null!==status&&(sval=status.value),$location.search("jobId",job.id),$location.search("mmStatus",sval),MarketplaceMembersService.all({jobId:job.id,status:sval}).$promise.then(function(marketplaceMembers){$scope.data.marketplaceMembers=marketplaceMembers.content||[],$scope.data.totalElements=marketplaceMembers.totalElements})["finally"](function(){$scope.ui.isLoading=!1})},$scope.changePage=function(){$scope.ui.isLoading=!0;var params={};$scope.data.selectedJob&&(params.jobId=$scope.data.selectedJob.id),params.page=$scope.data.currentPage-1,MarketplaceMembersService.all(params,function(data){$scope.data.marketplaceMembers=data.content||[],$scope.data.totalElements=data.totalElements,$scope.ui.isLoading=!1})}}]),ctrls.controller("AccountManagerApplicationCtrl",["$scope","CountriesService","TimezonesService","ManagerNotesService","JobService","ManagerService","MarketplaceMembersService","$upload","baseUrl","$routeParams","CompaniesService","$q","$location","RecruiterCandidateApprovalService","$uibModal",function($scope,CountriesService,TimezonesService,ManagerNotesService,JobService,ManagerService,MarketplaceMembersService,$upload,baseUrl,$routeParams,CompaniesService,$q,$location,RecruiterCandidateApprovalService,$uibModal){function showMessage(clazz,msg){$scope.msg={clazz:clazz,show:!0,message:msg}}function handleError(err){showMessage("alert-danger",err.text),$scope.ui.isLoading=!1}function loadNotes(id){return ManagerNotesService.query({id:id,avatarType:"ACCOUNT_MANAGER",type:"AM_HM"},function(notes){$scope.data.notes=notes}).$promise}function uploadFiles(appId){angular.forEach($scope.filesForUpload,function(file){var label;file.label?label=file.label:"COVER_LETTER"===file.fileType?label="Cover Letter":"5Qs"===file.fileType&&(label="5Qs");var config=$upload.prepareUpload({url:baseUrl+"/applications/"+appId+"/files?label="+label+"&internal="+!file.visible,fileFormDataName:"file",file:file.file});$upload.http(config)})}function loaded(){$scope.ui.isLoading=!1}var promises=[CountriesService.query().$promise,TimezonesService.query().$promise];$scope.filesForUpload=[],$scope.msg={clazz:"",show:!1,message:""},$scope.ui={isLoading:!0},$scope.changeCountry=function(){var c=$scope.data.countries.filter(function(x){return x.id===$scope.data.marketplaceMember.application.candidate.location.country.id})[0];if($scope.data.filteredTimezones=c.timezones,1===c.timezones.length)$scope.data.marketplaceMember.application.candidate.location.timeZone.id=c.timezones[0].id;else if($scope.data.marketplaceMember.application.candidate.location.timeZone.id){var isIncluded=c.timezones.reduce(function(ret,x){return ret||x.id===$scope.data.marketplaceMember.application.candidate.location.timeZone.id},!1);isIncluded||($scope.data.marketplaceMember.application.candidate.location.timeZone.id=null)}},$q.all(promises).then(function(data){$scope.data={numOfFiles:0,resumeVisible:!0,countries:data[0],timezones:data[1],existingApplication:!1},$scope.ui.isLoading=!0,$routeParams.appId?(MarketplaceMembersService.get({id:$routeParams.appId}).$promise.then(function(res){$scope.data.existingApplication=!0,$scope.data.marketplaceMember=res,JobService.crud.listWithSameTestStrategy({id:$scope.data.marketplaceMember.application.job.id}).$promise.then(function(jobs){$scope.data.jobs=jobs})["finally"](loaded),$scope.data.marketplaceMember.application.candidate.photoUrl?($scope.profilePhotoUrl=$scope.data.marketplaceMember.application.candidate.photoUrl,$scope.photoExists=!0):$scope.profilePhotoUrl="/images/1f34682a.user.png",$scope.changeCountry(),angular.forEach(res.application.files,function(file){file.visible=!file.internal,"Resume"===file.label?($scope.data.resumeId=file.id,file.fileType="RESUME"):"Cover Letter"===file.label?file.fileType="COVER_LETTER":"5Qs"===file.label?file.fileType="5Qs":file.fileType="OTHER"})}),loadNotes($routeParams.appId),CompaniesService.query().$promise.then(function(res){$scope.data.companies=res.content;for(var promises=[],i=1;i<res.totalPages;i++)promises.push(CompaniesService.query({page:i}).$promise);$q.all(promises).then(function(r){angular.forEach(r,function(result){$scope.data.companies=$scope.data.companies.concat(result.content)})})})):$scope.data.marketplaceMember={status:"AVAILABLE",application:{job:{id:Number($routeParams.jobId)},candidate:{type:"CANDIDATE",location:{country:{},timeZone:{}}}}}})["catch"](handleError)["finally"](function(){loaded()}),$scope.loadManagers=function(){if($scope.data.selectedCompany){$scope.ui.isLoading=!0;var promise=ManagerService.get({companyId:$scope.data.selectedCompany.id},function(res){$scope.data.managers=res}).$promise;return promise["finally"](loaded),promise}},$scope.clearNote=function(){$scope.data.note={},$scope.data.selectedCompany=null},$scope.saveNote=function(){if($scope.data.note){var note={content:$scope.data.note.note,receiver:$scope.data.note.manager,type:"AM_HM"};$scope.ui.isLoading=!0,ManagerNotesService.save({id:$routeParams.appId,avatarType:"ACCOUNT_MANAGER"},note,function(){loadNotes($routeParams.appId),$scope.clearNote()}).$promise["finally"](loaded)}},$scope.resumeChange=function(file){$scope.resume=file},$scope.fileAdd=function(file,handle){handle.file=file},$scope.deleteFile=function(file){file.deleteFlag=!0},$scope.incMoreFiles=function(){$scope.filesForUpload[$scope.data.numOfFiles]={visible:!0},$scope.data.numOfFiles++},$scope.deleteNewFile=function(index){$scope.filesForUpload.splice(index,1),$scope.data.numOfFiles--},$scope.cancel=function(){$location.path("/account-manager/custom-pipelines")},$scope.addPhoto=function(profile){var modalInstance=$uibModal.open({templateUrl:"add-photo-modal.tpl.html",controller:"AddProfilePhotoCtrl",size:"lg",resolve:{profile:function(){return profile}}});modalInstance.result.then(function(photoUrl){$scope.profilePhotoUrl=photoUrl,$scope.data.marketplaceMember.application.candidate.photoUrl=photoUrl,$scope.photoExists=!0})},$scope.deletePhoto=function(profile){var modalInstance=$uibModal.open({templateUrl:"photo-delete-confirmation.tpl.html",controller:"DeleteProfilePhotoCtrl",windowClass:"center-modal",resolve:{profile:function(){return profile}}});modalInstance.result.then(function(){$scope.data.marketplaceMember.application.candidate.photoUrl||($scope.photoExists=!1,$scope.profilePhotoUrl="/images/1f34682a.user.png")})},$scope.submit=function(marketplaceMember){if($scope.ui.isLoading=!0,$scope.data.existingApplication){uploadFiles($scope.data.marketplaceMember.application.id),$scope.resume&&RecruiterCandidateApprovalService.removeFile({id:$scope.data.marketplaceMember.application.id,fileId:$scope.data.resumeId}).$promise.then(function(){$upload.prepareUpload({url:baseUrl+"/applications/"+$scope.data.marketplaceMember.application.id+"/files?label=Resume&internal=true",fileFormDataName:"file",file:$scope.resume})})["finally"](function(){$scope.ui.isLoading=!1});var removeFilePromises=[];angular.forEach($scope.data.marketplaceMember.application.files,function(f){f.deleteFlag&&removeFilePromises.push(RecruiterCandidateApprovalService.removeFile({id:$scope.data.marketplaceMember.application.id,fileId:f.id}).$promise)}),$q.all(removeFilePromises).then(function(){$scope.ui.isLoading=!0,MarketplaceMembersService.update({id:$scope.data.marketplaceMember.application.id},$scope.data.marketplaceMember).$promise.then(function(){showMessage("alert-success","Marketplace member was successfully saved."),$scope.ui.isLoading=!1})["catch"](function(err){handleError(err.data)})})["catch"](function(err){handleError(err.data)})["finally"](function(){$scope.ui.isLoading=!1})}else{var config=$upload.prepareUpload({url:baseUrl+"/marketplaceMembers?marketplaceMember="+JSON.stringify(marketplaceMember),fileFormDataName:"resume",file:$scope.resume});$upload.http(config).success(function(res){uploadFiles(res.id),$scope.data.marketplaceMember.application=res.application,$scope.existingApplication=!1,showMessage("alert-success","Marketplace member was successfully saved."),$scope.ui.isLoading=!1}).error(function(err){handleError(err)})}}}]),ctrls.controller("AccountManagerUsersCtrl",["$scope","ManagerService","$rootScope","$location","JobApplicationService","CurrentUser",function($scope,ManagerService,$rootScope,$location,JobApplicationService,CurrentUser){$scope.ui={isLoading:!0,title:"Users list",currentPage:1,pagination:{}},$scope.companyIds=[],CurrentUser.get(function(data){data.avatarTypes.indexOf("ACCOUNT_MANAGER")===-1&&$location.path("/home")}),$scope.impersonate=function(id){$rootScope.runAsId=id,$location.path("/home")},$scope.update=function(){var p=1;if($scope.ui.isLoading=!0,angular.isDefined($scope.ui.currentPage)&&angular.isNumber($scope.ui.currentPage)&&(p=$scope.ui.currentPage),p===$scope.ui.pagination.number&&angular.isDefined($scope.ui.search)&&angular.isDefined($scope.ui.oldSearch)&&$scope.ui.search===$scope.ui.oldSearch)return void($scope.ui.isLoading=!1);var query={page:p-1};ManagerService.get(query,function(users){$scope.data=users,$scope.ui.oldSearch=angular.copy($scope.ui.search),$scope.ui.pagination=users,$scope.ui.isLoading=!1})},$scope.update()}]),ctrls.controller("JobDemandCtrl",["$scope","CurrentUser","JobService","CompaniesService","ManagerService","$location","$q","$uibModal",function($scope,CurrentUser,JobService,CompaniesService,ManagerService,$location,$q,$uibModal){function onLoad(){$scope.ui.isLoading=!1}$scope.data={selectedJob:null},$scope.ui={isLoading:!0},$scope.msg={clazz:"",show:!1,message:""};var editMessage=function(clazz,show,message){$scope.msg={clazz:clazz,show:show,message:message}};CurrentUser.get(function(data){data.avatarTypes.indexOf("ACCOUNT_MANAGER")===-1&&$location.path("/home"),JobService.crud.list().$promise.then(function(jobs){$scope.jobs=jobs})}),CompaniesService.query({avatarType:"ACCOUNT_MANAGER"}).$promise.then(function(res){$scope.companies=res.content;for(var promises=[],i=1;i<res.totalPages;i++)promises.push(CompaniesService.query({page:i,avatarType:"ACCOUNT_MANAGER"}).$promise);$q.all(promises).then(function(r){angular.forEach(r,function(result){$scope.companies=$scope.companies.concat(result.content)})})["finally"](onLoad)}),$scope.companyChanged=function(){$scope.ui.isLoading=!0,$scope.data.selectedManager=void 0,ManagerService.get({companyId:$scope.data.selectedCompany.id},function(mgrs){$scope.data.selectedCompany.hManagers=mgrs}).$promise["finally"](onLoad)},$scope.managerChanged=function(){return editMessage(null,!1,null),$scope.data.selectedManagerDemands=[],$scope.data.selectedManager.demands?void($scope.data.selectedManagerDemands=$scope.data.selectedManager.demands):($scope.ui.isLoading=!0,void ManagerService.listJobDemands({id:$scope.data.selectedManager.id},function(res){$scope.data.selectedManager.demands=res,$scope.data.selectedManagerDemands=$scope.data.selectedManager.demands,$scope.ui.isLoading=!1},function(err){editMessage("alert-danger",!0,err.data.text),$scope.ui.isLoading=!1}))},$scope.addJobDemandForm=function(){editMessage(null,!1,null),$scope.formModal=$uibModal.open({templateUrl:"new-job-demand-form.tpl.html",scope:$scope,backdrop:"static"})},$scope.saveJobDemand=function(job,mgr,demand,formModal,existDemand){editMessage(null,!1,null),$scope.ui.isLoading=!0,JobService.crud.demand({id:job.id,managerId:mgr.id,demand:demand},function(){if(formModal){editMessage("alert-success",!0,"job demand is added!");var addedDemand={job:job,manager:mgr,demand:demand};$scope.data.selectedManager.demands.push(addedDemand),formModal.dismiss()}else editMessage("alert-success",!0,"job demand is updated!"),existDemand.demand=demand;$scope.ui.isLoading=!1},function(err){editMessage("alert-danger",!0,err.data.text),$scope.ui.isLoading=!1})},$scope.isJobHasNoDemand=function(job){var hasNoDemand=!0;return angular.forEach($scope.data.selectedManager.demands,function(demand){if(demand.job.id===job.id)return hasNoDemand=!1,!1}),hasNoDemand}}]),ctrls.controller("ApplicantsEndorsementCtrl",["$scope","JobApplicationService","JobService","DownloadService","ManagerNotesService","$uibModal","CurrentUser","$location","$filter","$sce","RequestQueue","$q","$rootScope","MarketplaceMembersService","routePrefix",function($scope,JobApplicationService,JobService,DownloadService,ManagerNotesService,$uibModal,CurrentUser,$location,$filter,$sce,RequestQueue,$q,$rootScope,MarketplaceMembersService,routePrefix){function getPipelineById(id){return _.find($scope.data.pipelines,function(job){return job.id===id})}function openNoteModal(app,notes){$uibModal.open({templateUrl:"application-notes.tpl.html",resolve:{application:function(){return app},notes:function(){return notes},avatarType:function(){return $scope.data.avatarType}},backdrop:"static",controller:function($scope,application,notes,avatarType,$uibModalInstance,ManagerNotesService){$scope.modal=$uibModalInstance,$scope.application=application,$scope.notes=notes,$scope.avatarType=avatarType,$scope.submit=function(){ManagerNotesService.save({id:$scope.application.id,avatarType:$scope.avatarType},{content:$scope.content,type:"AM_RA"}),$scope.application.lastNoteContent=$scope.content,$scope.modal.close()}}})}var onRouteChangeOff,vm=this;vm.init=function(){$scope.data={pipelines:[],selectedJob:null,applications:[],tasks:{},ranote:"",selected:[],avatarType:null,jobSpecs:{},queue:RequestQueue.queue,scoresArrayOT:[],scoresArrayRR:[],sortDir:"ASC",orderBy:"score",endorseRejectFlag:null},$scope.rootScope=$rootScope,$scope.UI={},CurrentUser.get(function(data){data.avatarTypes.indexOf("ACCOUNT_MANAGER")<0&&data.avatarTypes.indexOf("RECRUITMENT_ANALYST")<0&&$location.path("/home"),data.avatarTypes.indexOf("ACCOUNT_MANAGER")>=0?$scope.data.avatarType="ACCOUNT_MANAGER":$scope.data.avatarType="RECRUITMENT_ANALYST"}),JobService.crud.query(function(res){$scope.data.pipelines=res.filter(function(res){return"ON_HOLD"===res.status||"ACTIVE"===res.status}),$rootScope.selectedGlobalPipelineId&&($scope.data.selectedJob=getPipelineById($rootScope.selectedGlobalPipelineId),vm.changeJob()),$scope.UI.isLoading=!1}),onRouteChangeOff=$scope.$on("$locationChangeStart",routeChange)};var routeChange=function(event,newUrl){0===$scope.data.scoresArrayOT.length&&0===$scope.data.scoresArrayRR.length||($scope.UI.mdl=$uibModal.open({templateUrl:"unsaved-changes.tpl.html",scope:$scope}),$scope.UI.mdl.result.then(function(whatToDo){"save"===whatToDo?vm.updateScores(newUrl):"discard"===whatToDo&&(onRouteChangeOff(),$location.path($location.url(newUrl).hash()))}),event.preventDefault())};vm.init(),vm.resetJobSpecs=function(){$scope.data.jobSpecs={};var job=$scope.data.selectedJob,specs=$scope.data.jobSpecs;job&&(specs.hrTest="HACKERRANK_ASSIGNMENT"===job.flowType||"HACKERRANK_FIVEQ"===job.flowType,specs.asgnTest="HACKERRANK_ASSIGNMENT"===job.flowType,specs.fiveQTest="FIVEQ"===job.flowType||"HACKERRANK_FIVEQ"===job.flowType),job.tests&&(specs.rubricTest=job.tests.find(function(jobTest){return"RESUME_RUBRIC"===jobTest.test.type}),specs.keywordTest=job.tests.find(function(jobTest){return"RESUME_KEYWORD"===jobTest.test.type}),specs.otherTest=job.tests.find(function(jobTest){return"OTHER"===jobTest.test.type}),_.each(job.tests,function(t){job[t.test.type]=t.test}))},vm.changeJob=function(){$rootScope.selectedGlobalPipelineId=$scope.data.selectedJob.id,$scope.filter=void 0,$scope.UI.isLoading=!0,$scope.UI.error=null,$scope.data.applications=[],$scope.data.selected=[],$scope.UI.page=0,$scope.data.searchWord="",JobService.crud.getAuthenticated({id:$scope.data.selectedJob.id}).$promise.then(function(j){angular.extend($scope.data.selectedJob,j),vm.loadApplicationsInProgress(),vm.resetJobSpecs()})},vm.initTestEvaluations=function(app){if(app.rkScore=_.find(app.testScores,function(ts){return"RESUME_KEYWORD"===ts.test.type}),app.matScore=_.find(app.testScores,function(ts){return"MANDATORY_ATTRIBUTES"===ts.test.type}),$scope.data.jobSpecs.rubricTest&&((!angular.isDefined(app.rubricEval)||(app.testsEvaluations||[]).length>0)&&(app.rubricEval=(app.testsEvaluations||[]).find(function(e){return"RESUME_RUBRIC_EVALUATION"===e.type})),app.rubricEval=app.rubricEval||{},app.rubricEval.test=$scope.data.jobSpecs.rubricTest.test,app.rubricEval.type="RESUME_RUBRIC_EVALUATION",app.rubricEval.resumeRubricScores=app.rubricEval.resumeRubricScores||[],app.rubricEvalScore={},$scope.data.jobSpecs.rubricTest.test.resumeRubrics.forEach(function(rr){var matchedScore;app.rubricEval.resumeRubricScores.forEach(function(score){if(score.resumeRubric.id===rr.resumeRubric.id)return matchedScore=score}),void 0===matchedScore&&(matchedScore={resumeRubric:rr.resumeRubric},app.rubricEval.resumeRubricScores.push(matchedScore)),void 0===matchedScore.newScore&&(matchedScore.newScore=matchedScore.score),app.rubricEvalScore[rr.resumeRubric.id]=matchedScore}),app.overAllResumeGrad=$filter("jobApplicationTest")(app,"RESUME_RUBRIC","score")),$scope.data.jobSpecs.otherTest&&(app.otherTestEval=_.find(app.testsEvaluations,function(e){return"OTHER_TEST_EVALUATION"===e.type}),app.otherTestCriterions=[],_.each($scope.data.jobSpecs.otherTest.test.groups,function(group){var otcArr=_.map(group.criteria,function(o){return{testId:$scope.data.jobSpecs.otherTest.test.id,groupId:group.id,otherCriteriaScore:{score:null,newScore:null,criterion:o}}});app.otherTestCriterions=app.otherTestCriterions.concat(otcArr)}),app.otherTestEval&&_.each(app.otherTestCriterions,function(otc){var otherCriteriaScore=_.find(app.otherTestEval.otherCriteriaScores,function(ots){return ots.criterion.id===otc.otherCriteriaScore.criterion.id});otherCriteriaScore&&(otc.otherCriteriaScore=otherCriteriaScore,otc.otherCriteriaScore.newScore=otherCriteriaScore.score)}),app.otherTestEval||(app.otherTestEval={type:"OTHER_TEST_EVALUATION",test:$scope.data.jobSpecs.otherTest.test,otherCriteriaScores:_.map(app.otherTestCriterions,function(otc){return otc.otherCriteriaScore})})),$scope.data.jobSpecs.fiveQTest){app.fiveQResponse=(app.testsEvaluations||[]).find(function(e){return"FIVEQ_ANSWER"===e.type}),app.fiveQScore=$filter("jobApplicationTest")(app,"FIVEQ","score"),app.fiveQResponse=app.fiveQResponse||{};var questions=[];$scope.data.selectedJob.FIVEQ&&(questions=$scope.data.selectedJob.FIVEQ.questions),app.fiveQResponse.answers=app.fiveQResponse.answers||[];for(var i=0;i<questions.length;i++)app.fiveQResponse.answers[i]&&app.fiveQResponse.answers[i].sequenceNumber===questions[i].sequenceNumber||app.fiveQResponse.answers.push({sequenceNumber:questions[i].sequenceNumber,answer:null,score:null});app.fiveQResponse.answers=app.fiveQResponse.answers.sort(function(a,b){return a.sequenceNumber-b.sequenceNumber})}},vm.loadApplicationsInProgress=function(orderBy,sortDir){$scope.UI.isLoading=!0,$scope.data.orderBy=orderBy?orderBy:"score",$scope.data.sortDir=sortDir?sortDir:"ASC";var params={jobId:$scope.data.selectedJob.id,searchWord:$scope.data.searchWord,showDisabled:!0,resumeSearchQuery:$scope.data.resumeSearchQuery};if($scope.filter){var filter=angular.copy($scope.filter);filter.scoreFilters=_.filter(filter.scoreFilters,function(sf){return _.isNumber(sf.scoreMin)||_.isNumber(sf.scoreMax)}),angular.extend(params,filter)}JobApplicationService.getApplications({avatarType:$scope.data.avatarType,page:$scope.UI.page,orderBy:$scope.data.orderBy,sortDir:$scope.data.sortDir,pageSize:50},params,function(data){$scope.UI.showMoreRecords=$scope.data.applications.length<data.totalElements,(data.content||[]).forEach(function(app){($scope.data.jobSpecs.fiveQTest||$scope.data.jobSpecs.otherTests||$scope.data.jobSpecs.rubricTest)&&vm.initTestEvaluations(app),$scope.data.tasks=JobApplicationService.getTasksNames(),app.taskStatus=$scope.data.tasks[app.task],app.hrScore=$filter("jobApplicationTest")(app,"HACKER_RANK","score"),app.fiveQScore=$filter("jobApplicationTest")(app,"FIVEQ","score"),app.ttScore=$filter("jobApplicationTest")(app,"ASSIGNMENT","score")}),$scope.data.applications.push.apply($scope.data.applications,data.content||[]),$scope.UI.isLoading=!1,$scope.UI.busy=!1,$rootScope.showFooter=!1})},vm.toggleCheck=function(id){$scope.data.selected.indexOf(id)===-1?$scope.data.selected.push(id):$scope.data.selected.splice($scope.data.selected.indexOf(id),1)},vm.changeApplicationStatus=function(){$scope.UI.error=null,$scope.UI.isLoading=!1,$scope.data.applications=[],$scope.data.selected=[],$scope.UI.page=0,vm.loadApplicationsInProgress($scope.data.orderBy,$scope.data.sortDir)},vm.openFilterModal=function(){var modal=$uibModal.open({templateUrl:"filter-modal.tpl.html",backdrop:"static",size:"lg",resolve:{job:function(){return $scope.data.selectedJob},filter:function(){return $scope.filter}},controller:function($scope,job,filter,JobApplicationService,APPLICATION_TASKS,$uibModalInstance){function setScoreFilters(){var scoreFilters=[];if(getTest(job,"RESUME_KEYWORD")&&scoreFilters.push({name:"Keyword Score",type:"TEST_SCORE",testType:"RESUME_KEYWORD"}),getTest(job,"RESUME_RUBRIC")){var rubricTest=getTest(job,"RESUME_RUBRIC").test;_.each(rubricTest.resumeRubrics,function(rr){scoreFilters.push({name:rr.resumeRubric.name,type:"RUBRIC_SCORE",rubricId:rr.resumeRubric.id})}),scoreFilters.push({name:"Overall Resume Grade",type:"TEST_SCORE",testType:"RESUME_RUBRIC"})}if(getTest(job,"FIVEQ")){var fiveqTest=getTest(job,"FIVEQ").test;_.each(fiveqTest.questions,function(fq){scoreFilters.push({name:"Q"+fq.sequenceNumber,type:"QUESTION_SCORE",sequenceNumber:fq.sequenceNumber})}),scoreFilters.push({name:"5Q Total",type:"TEST_SCORE",testType:"FIVEQ"})}getTest(job,"HACKER_RANK")&&scoreFilters.push({name:"HR Score",type:"TEST_SCORE",testType:"HACKER_RANK"}),getTest(job,"ASSIGNMENT")&&scoreFilters.push({name:"Assignment Score",type:"TEST_SCORE",testType:"ASSIGNMENT"}),$scope.filter.scoreFilters=scoreFilters}function getTest(job,type){return _.find(job.tests,function(jt){return jt.test.type===type})}$scope.modal=$uibModalInstance,$scope.taskNames=JobApplicationService.getTasksNames(),$scope.applicationTasks=_.pluck(APPLICATION_TASKS[job.flowType],"task"),$scope.filter=filter,$scope.dt={},$scope.reset=function(){$scope.filter={},setScoreFilters()},$scope.set=function(){"ACCEPTED"!==$scope.filter.applicationStatus&&"REJECTED"!==$scope.filter.applicationStatus||delete $scope.filter.tasks;var hasScoreFilters=_.find($scope.filter.scoreFilters,function(f){return _.isNumber(f.scoreMin)||_.isNumber(f.scoreMax)});hasScoreFilters&&!_.isEmpty($scope.filter.scoreFilters)||delete $scope.filter.scoreFilters,_.isEmpty($scope.filter.tasks)&&delete $scope.filter.tasks,_.each($scope.filter,function(val,key){""!==val&&null!==val&&void 0!==val||delete $scope.filter[key]}),$uibModalInstance.close($scope.filter)},$scope.openDatepicker=function($event,datepicker){$event.preventDefault(),$event.stopPropagation(),$scope.dt[datepicker]=!0},$scope.filter?_.isEmpty($scope.filter.scoreFilters)&&setScoreFilters():$scope.reset()}});modal.result.then(function(filter){_.isEmpty(filter)&&(filter=void 0),$scope.filter=filter,vm.changeApplicationStatus()})},vm.addRubricScore=function(appId,rrEval){var scoresArrayRR=$scope.data.scoresArrayRR,rrindex=scoresArrayRR.findIndex(function(item){return item.id===appId}),rrEvalCopy=angular.copy(rrEval),needUpdate=_.filter(rrEvalCopy.resumeRubricScores,function(r){var isNew=void 0===r.score&&void 0!==r.newScore&&null!==r.newScore;return isNew||void 0!==r.score});if(_.isEmpty(needUpdate))return void(rrindex!==-1&&scoresArrayRR.splice(rrindex,1));if(_.each(rrEvalCopy.resumeRubricScores,function(r){r.score=r.newScore,delete r.newScore}),rrindex===-1)scoresArrayRR.push({id:appId,testsEvaluations:[rrEvalCopy]});else{var evindex=scoresArrayRR[rrindex].testsEvaluations.findIndex(function(item){return item.test.id===rrEval.test.id});evindex===-1?scoresArrayRR[rrindex].testsEvaluations.push(rrEvalCopy):scoresArrayRR[rrindex].testsEvaluations[evindex]=rrEvalCopy}},vm.addOtherTestScore=function(appId,ote){for(var scoresArrayOT=$scope.data.scoresArrayOT,otindex=scoresArrayOT.findIndex(function(item){return item.id===appId}),oteCopy=angular.copy(ote),i=0;i<oteCopy.otherCriteriaScores.length;i++)oteCopy.otherCriteriaScores[i].score=ote.otherCriteriaScores[i].newScore,delete oteCopy.otherCriteriaScores[i].newScore;if(otindex===-1)scoresArrayOT.push({id:appId,testsEvaluations:[oteCopy]});else{var evindex=scoresArrayOT[otindex].testsEvaluations.findIndex(function(item){return item.test.id===ote.test.id});evindex===-1?scoresArrayOT[otindex].testsEvaluations.push(oteCopy):scoresArrayOT[otindex].testsEvaluations[evindex]=oteCopy}},vm.updateScores=function(redirectUrl){$scope.UI.error=null,$scope.UI.isLoading=!0,$scope.data.scoresArrayRR.length>0&&RequestQueue.addTask(JobApplicationService.resumeRubricScoreBatch,$scope.data.scoresArrayRR).then(function(){$scope.data.scoresArrayRR=[],0===$scope.data.scoresArrayOT.length&&(redirectUrl&&(onRouteChangeOff(),$location.path($location.url(redirectUrl).hash())),vm.changeApplicationStatus())})["catch"](function(error){$scope.UI.error=error.data.text,$scope.UI.isLoading=!1}),$scope.data.scoresArrayOT.length>0&&RequestQueue.addTask(JobApplicationService.otherTestScoreBatch,$scope.data.scoresArrayOT).then(function(){$scope.data.scoresArrayOT=[],$scope.UI.page=0,vm.changeApplicationStatus(),redirectUrl&&(onRouteChangeOff(),$location.path($location.url(redirectUrl).hash()))})["catch"](function(error){$scope.UI.error=error.data.text,$scope.UI.isLoading=!1})},vm.updateScoreOnKeyUp=function($event,type,appId,scoreObject){return 13===$event.keyCode&&void("OtherTest"===type?vm.addOtherTestScore(appId,scoreObject):vm.addRubricScore(appId,scoreObject))},vm.showFile=function(appId,applicationFile){JobApplicationService.openFileInGoogleDocViewer(appId,applicationFile.id)},vm.jobCloseModal=function(){var tplUrl="account-manager/reject-all-modal.tpl.html",modalInstance=$uibModal.open({templateUrl:routePrefix?routePrefix+tplUrl:tplUrl,backdrop:"static",controller:function($scope,$uibModalInstance){$scope.modal=$uibModalInstance}});modalInstance.result.then(function(){var job=$scope.data.selectedJob;job.status="CLOSED",JobService.crud.update({id:job.id},job)})},vm.endorseRejectSelections=function(endorseRejectFlag){0!==$scope.data.selected.length&&($scope.data.rejectionReason=void 0,$scope.data.endorseRejectFlag=endorseRejectFlag,$scope.UI.modal=$uibModal.open({templateUrl:"endorse-reject-modal.tpl.html",scope:$scope,backdrop:"static"}))};var getAppById=function(id){return $scope.data.applications.find(function(app){return app.id===id})};vm.endorseReject=function(accepted){$scope.UI.modal.dismiss(),$scope.UI.isLoading=!0;var promises=[];$scope.data.selected.forEach(function(id){"ACCEPTED"===$scope.UI.applicationStatus?promises.push(MarketplaceMembersService.disable({id:id}).$promise):"accountManagerEndorsesApplication"===getAppById(id).task||accepted?promises.push(JobApplicationService.endorsementAction({id:id,accepted:accepted},$scope.data.rejectionReason||" ").$promise):promises.push(JobApplicationService.remove({id:id,type:"REJECT",reason:$scope.data.rejectionReason}).$promise)}),$q.all(promises)["finally"](function(){vm.changeApplicationStatus()})},vm.endorse=function(app,accepted,actionComments){(!actionComments.comment||actionComments.comment.length<1)&&(actionComments.comment=" "),"recruiterConductsPreMarketplaceInterview"!==app.task||accepted?JobApplicationService.endorsementAction({id:app.id,accepted:accepted},actionComments.comment,function(){app.actionTaked=!0},function(err){$scope.UI.error=err.data.text}):($scope.UI.isLoading=!0,JobApplicationService.remove({id:app.id,type:"REJECT"},function(){app.actionTaked=!0,$scope.UI.isLoading=!1}))},vm.thereSelectedNotInPreview=function(){var thereSome=!1;return $scope.data.applications.forEach(function(app){if(!app.previewToHiringManager&&$scope.data.selected.indexOf(app.id)>-1)return thereSome=!0}),thereSome},vm.allSelectedInEndorsementPhase=function(){var isSelectedInEndorsement=!0;return $scope.data.applications.forEach(function(app){if("accountManagerEndorsesApplication"!==app.task&&"ACCEPTED"!==app.status&&$scope.data.selected.indexOf(app.id)>-1)return isSelectedInEndorsement=!1}),isSelectedInEndorsement},vm.sendHmPreview=function(){$scope.UI.isLoading=!0,JobApplicationService.sendHmPreview({applicationsIds:$scope.data.selected},function(){$scope.data.applications.forEach(function(app){$scope.data.selected.indexOf(app.id)>-1&&(app.previewToHiringManager=!0)}),$scope.data.selected=[],$scope.UI.isLoading=!1},function(err){$scope.UI.isLoading=!1,$scope.UI.error=err.data.text})},vm.checkSelectedForPassersPreview=function(){for(var i=$scope.data.applications.length;i--;)if($scope.data.selected.indexOf($scope.data.applications[i].id)>-1&&(["HACKERRANK_FIVEQ","FIVEQ"].indexOf($scope.data.applications[i].job.flowType)===-1||$scope.data.applications[i].previewTestPasser||["recruiterConductsPreMarketplaceInterview","accountManagerEndorsesApplication"].indexOf($scope.data.applications[i].task)===-1))return!1;return!0},vm.sendPassersPreview=function(){$scope.UI.isLoading=!0,JobApplicationService.sendPassersPreview({applicationsIds:$scope.data.selected
},function(){$scope.data.applications.forEach(function(app){$scope.data.selected.indexOf(app.id)>-1&&(app.previewTestPasser=!0)}),$scope.data.selected=[],$scope.UI.isLoading=!1},function(err){$scope.UI.isLoading=!1,$scope.UI.error=err.data.text})},vm.unPreview=function(app){app.id&&($scope.UI.isLoading=!0,JobApplicationService.unPreview({applicationsIds:app.id},function(){app.previewToHiringManager=!1,app.previewTestPasser=!1,$scope.UI.isLoading=!1},function(err){$scope.UI.isLoading=!1,$scope.UI.error=err.data.text}))};var ConfirmModalInstanceCtrl=function($scope,$uibModalInstance,selectedApp,accepted,actionComments){$scope.selectedApp=selectedApp,$scope.accepted=accepted,$scope.actionComments=actionComments,$scope.confirm=function(){$uibModalInstance.close()},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}};vm.endorsementActionModal=function(app,accepted){var actionComments={},modalInstance=$uibModal.open({templateUrl:"app-action-modal.tpl.html",controller:ConfirmModalInstanceCtrl,scope:$scope,resolve:{selectedApp:function(){return app},accepted:function(){return accepted},actionComments:function(){return actionComments}},backdrop:"static"});modalInstance.result.then(function(){vm.endorse(app,accepted,actionComments)})},vm.addNoteModal=function(app){$scope.UI.isLoading=!0,ManagerNotesService.query({id:app.id,type:"AM_RA",avatarType:$scope.data.avatarType}).$promise.then(function(notes){openNoteModal(app,notes)})["finally"](function(){$scope.UI.isLoading=!1})},vm.fvQModal=function(app){app.fvQUrl?vm.show5QModal(app):vm.load5QFile(app,!0)},vm.load5QFile=function(app,show5Q){if(!app.fvQUrl){var fvQFile=_.find(app.files,function(f){return"5Qs"===f.label});fvQFile&&JobApplicationService.getFileUrl(app.id,fvQFile.id).success(function(url){DownloadService.download5QFile(url).success(function(data){show5Q&&vm.show5QModal((new TextDecoder).decode(new DataView(data)))})})}},vm.show5QModal=function(data){data&&($scope.safeHtml=$sce.trustAsHtml(data),$scope.UI.mdl=$uibModal.open({templateUrl:"fvQ-modal.tpl.html",scope:$scope,backdrop:"static",windowClass:"modal-full-width"}))},vm.rubricDescriptionModal=function(rr){$scope.currentClikcedRubric=rr,$scope.UI.mdl=$uibModal.open({templateUrl:"rubric-desc-modal.tpl.html",scope:$scope,backdrop:"static"})},vm.changeSortOrder=function(orderBy,sortDir){$scope.data.orderBy=orderBy,$scope.data.sortDir=sortDir,vm.changeApplicationStatus()},vm.showMoreRecords=function(){$scope.UI.busy||$scope.UI.showMoreRecords!==!1&&($scope.UI.busy=!0,$scope.UI.page+=1,$scope.UI.isLoading=!0,$scope.UI.error=null,vm.loadApplicationsInProgress($scope.data.orderBy,$scope.data.sortDir))},vm.blur=function($event){var target=$event.target;target&&target.blur()},vm.isDefined=function(o){return void 0!==o&&null!==o}}]),ctrls.controller("CalibrationsCtrl",["$scope","JobService","$rootScope","$timeout","$cacheFactory","CurrentUser","baseUrl",function($scope,JobService,$rootScope,$timeout,$cacheFactory,CurrentUser,baseUrl){function getPipelineById(id){return _.find(vm.jobs,function(job){return job.id===id})}function addCalibrationItemsIfMissing(job){return job.calibration&&job.calibration.items&&0!==job.calibration.items.length||(job.calibration||(job.calibration={}),job.calibration.items=[{name:"Initial Resumes"},{name:"Initial Passers"},{name:"Initial Interview"}]),"APPROVED"===job.calibration.descriptionApprovalStatus?vm.bypass.jdApproval=!0:vm.bypass.jdApproval=!1,"APPROVED"===job.calibration.testApprovalStatus?vm.bypass.testApproval=!0:vm.bypass.testApproval=!1,job}var vm=this;vm.format="MMMM d, yyyy",vm.dt={},vm.bypass={jdApproval:!1,testApproval:!1},vm.UI={error:null},vm.init=function(){vm.load=JobService.crud.list({custom:!0},function(res){vm.jobs=res,$rootScope.selectedGlobalPipelineId&&(vm.selectedJob=getPipelineById($rootScope.selectedGlobalPipelineId),vm.changeJob())}),CurrentUser.getAvatar({avatarType:"ACCOUNT_MANAGER"},function(res){vm.accountManager=res})},vm.changeJob=function(){vm.message="",$rootScope.selectedGlobalPipelineId=vm.selectedJob.id,$cacheFactory.get("jobCache").remove(baseUrl+"/jobs/"+vm.selectedJob.id),vm.load=JobService.crud.getAuthenticated({id:vm.selectedJob.id},function(data){var job=data;job.calibration&&job.calibration.items||(job.calibration={items:[{name:"Initial Resumes"},{name:"Initial Passers"},{name:"Initial Interview"}]}),"APPROVED"===job.calibration.descriptionApprovalStatus?vm.bypass.jdApproval=!0:vm.bypass.jdApproval=!1,vm.selectedJob=addCalibrationItemsIfMissing(data)})},vm.openDatepicker=function($event,datePicker){$event.preventDefault(),$event.stopPropagation(),vm.dt[datePicker]=!0},vm.requestApproval=function(type){vm.UI.error=null;var params={id:vm.selectedJob.id,type:type};vm.message="",vm.load=JobService.crud.requestApprovalAM(params,function(res){vm.selectedJob=addCalibrationItemsIfMissing(res),"description"===type?vm.message="JD":"test"===type&&(vm.message="Testing"),vm.message+=" Approval requested successfully!",$scope.scrollToTop()},function(err){vm.UI.error=err.data.text})},vm.save=function(){vm.message="",vm.bypass.jdApproval&&"APPROVED"!==vm.selectedJob.calibration.descriptionApprovalStatus&&(vm.selectedJob.calibration.descriptionApprovalStatus="APPROVED",vm.selectedJob.calibration.descriptionApprovalRequestedBy=vm.accountManager),vm.bypass.testApproval&&"APPROVED"!==vm.selectedJob.calibration.testApprovalStatus&&(vm.selectedJob.calibration.testApprovalStatus="APPROVED",vm.selectedJob.calibration.testApprovalRequestedBy=vm.accountManager),vm.load=JobService.crud.update(vm.selectedJob,function(res){vm.selectedJob=addCalibrationItemsIfMissing(res),vm.message="Changes are saved!",vm.UI.error=null,$scope.scrollToTop(),$cacheFactory.get("jobCache").remove(baseUrl+"/jobs/"+vm.selectedJob.id)})},vm.init(),vm.focusOnApprovalDate=function(propertyName){vm.bypass[propertyName]&&$timeout(function(){angular.element(document.querySelector("#"+propertyName+"Date")).focus()})}}]),ctrls.controller("ApplicationNotesCtrl",["JobApplicationService","JobService","ManagerNotesService","$routeParams","CurrentUser","$location",function(JobApplicationService,JobService,ManagerNotesService,$routeParams,CurrentUser,$location){function init(){CurrentUser.restoreImpersonation(),CurrentUser.get(function(u){vm.cu=u,u.avatarTypes.indexOf("ACCOUNT_MANAGER")<0&&u.avatarTypes.indexOf("RECRUITMENT_ANALYST")<0&&$location.path("/home"),u.avatarTypes.indexOf("ACCOUNT_MANAGER")>=0?vm.avatarType="ACCOUNT_MANAGER":vm.avatarType="RECRUITMENT_ANALYST",loadNotes()}),JobApplicationService.get({id:$routeParams.id,avatarType:"ACCOUNT_MANAGER"},function(app){vm.app=app,JobService.crud.getAuthenticated({id:app.job.id},function(job){vm.job=job})})}function loadNotes(){ManagerNotesService.query({id:$routeParams.id,avatarType:vm.avatarType,type:"AM_HM"},function(notes){vm.notes=notes})}function sendNote(){ManagerNotesService.save({id:$routeParams.id,avatarType:vm.avatarType},{content:vm.note,type:"AM_HM",recipient:vm.selectedManager},function(){vm.note="",loadNotes()})}var vm=this;vm.sendNote=sendNote,init()}]),ctrls.controller("JobNotesCtrl",["JobService","$routeParams","CurrentUser","$location","$filter",function(JobService,$routeParams,CurrentUser,$location,$filter){function init(){CurrentUser.get(function(u){vm.cu=u,(u.avatarTypes.indexOf("ACCOUNT_MANAGER")<0||["description","test"].indexOf($routeParams.type)<0)&&$location.path("/home"),JobService.crud.getAuthenticated({id:$routeParams.id},function(job){vm.job=job,getNotesType()})})}function getNotesType(){"description"===$routeParams.type?(vm.notesTypeText="JD Approval",vm.notesType="DESCRIPTION"):"test"===$routeParams.type&&(vm.notesTypeText="Test Approval",vm.notesType="TEST"),loadNotes(vm.notesType)}function loadNotes(type){JobService.crud.getNotes({id:$routeParams.id,type:type},function(data){vm.notes=data,vm.selectedManager=getManagerOfLastNote()})}function getManagerOfLastNote(){var sortedNotes=$filter("orderBy")(vm.notes,"createdOn",!0),selectedNote=_.find(sortedNotes,function(note){return"MANAGER"===note.sender.type});return angular.isDefined(selectedNote.sender.id)?_.find(vm.job.visibleManagers,function(mgr){return mgr.id===selectedNote.sender.id}):null}function saveNote(){if(vm.note&&vm.selectedManager){var note={content:vm.note,type:vm.notesType,recipient:vm.selectedManager};vm.loading=JobService.crud.saveNote({id:vm.job.id,avatarType:"ACCOUNT_MANAGER"},note,function(res){vm.notes=res,vm.note=null})}}var vm=this;vm.saveNote=saveNote,init()}]);